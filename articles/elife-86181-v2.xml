<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE article PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD with MathML3 v1.3 20210610//EN"  "JATS-archivearticle1-3-mathml3.dtd"><article xmlns:ali="http://www.niso.org/schemas/ali/1.0/" xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" article-type="research-article" dtd-version="1.3"><front><journal-meta><journal-id journal-id-type="nlm-ta">elife</journal-id><journal-id journal-id-type="publisher-id">eLife</journal-id><journal-title-group><journal-title>eLife</journal-title></journal-title-group><issn publication-format="electronic" pub-type="epub">2050-084X</issn><publisher><publisher-name>eLife Sciences Publications, Ltd</publisher-name></publisher></journal-meta><article-meta><article-id pub-id-type="publisher-id">86181</article-id><article-id pub-id-type="doi">10.7554/eLife.86181</article-id><article-version article-version-type="publication-state">version of record</article-version><article-categories><subj-group subj-group-type="display-channel"><subject>Tools and Resources</subject></subj-group><subj-group subj-group-type="heading"><subject>Computational and Systems Biology</subject></subj-group><subj-group subj-group-type="heading"><subject>Physics of Living Systems</subject></subj-group></article-categories><title-group><article-title>Combining mutation and recombination statistics to infer clonal families in antibody repertoires</article-title></title-group><contrib-group><contrib contrib-type="author"><name><surname>Spisak</surname><given-names>Natanael</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0000-0002-6332-047X</contrib-id><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="other" rid="fund1"/><xref ref-type="other" rid="fund2"/><xref ref-type="other" rid="fund3"/><xref ref-type="fn" rid="con1"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author"><name><surname>Athènes</surname><given-names>Gabriel</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0009-0007-4668-884X</contrib-id><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="other" rid="fund3"/><xref ref-type="fn" rid="con2"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author"><name><surname>Dupic</surname><given-names>Thomas</given-names></name><xref ref-type="aff" rid="aff3">3</xref><xref ref-type="other" rid="fund1"/><xref ref-type="other" rid="fund2"/><xref ref-type="other" rid="fund3"/><xref ref-type="fn" rid="con3"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" corresp="yes"><name><surname>Mora</surname><given-names>Thierry</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0000-0002-5456-9361</contrib-id><email>thierry.mora@gmail.com</email><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="other" rid="fund1"/><xref ref-type="other" rid="fund2"/><xref ref-type="other" rid="fund3"/><xref ref-type="fn" rid="con4"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" corresp="yes"><name><surname>Walczak</surname><given-names>Aleksandra M</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0000-0002-2686-5702</contrib-id><email>aleksandra.walczak@phys.ens.fr</email><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="other" rid="fund1"/><xref ref-type="other" rid="fund2"/><xref ref-type="other" rid="fund3"/><xref ref-type="fn" rid="con5"/><xref ref-type="fn" rid="conf2"/></contrib><aff id="aff1"><label>1</label><institution-wrap><institution-id institution-id-type="ror">https://ror.org/013cjyk83</institution-id><institution>Laboratoire de physique de l’École normale supérieure, CNRS, PSL University, Sorbonne Université and Université de Paris</institution></institution-wrap><addr-line><named-content content-type="city">Paris</named-content></addr-line><country>France</country></aff><aff id="aff2"><label>2</label><institution-wrap><institution-id institution-id-type="ror">https://ror.org/050gn5214</institution-id><institution>Saber Bio SAS, Institut du Cerveau, iPEPS The Healthtech Hub</institution></institution-wrap><addr-line><named-content content-type="city">Paris</named-content></addr-line><country>France</country></aff><aff id="aff3"><label>3</label><institution-wrap><institution-id institution-id-type="ror">https://ror.org/03vek6s52</institution-id><institution>Department of Organismic and Evolutionary Biology, Harvard University</institution></institution-wrap><addr-line><named-content content-type="city">Cambridge</named-content></addr-line><country>United States</country></aff></contrib-group><contrib-group content-type="section"><contrib contrib-type="editor"><name><surname>Cowell</surname><given-names>Lindsay</given-names></name><role>Reviewing Editor</role><aff><institution-wrap><institution-id institution-id-type="ror">https://ror.org/05byvp690</institution-id><institution>The University of Texas Southwestern Medical Center</institution></institution-wrap><country>United States</country></aff></contrib><contrib contrib-type="senior_editor"><name><surname>Davenport</surname><given-names>Miles P</given-names></name><role>Senior Editor</role><aff><institution-wrap><institution-id institution-id-type="ror">https://ror.org/03r8z3t63</institution-id><institution>University of New South Wales</institution></institution-wrap><country>Australia</country></aff></contrib></contrib-group><pub-date publication-format="electronic" date-type="publication"><day>09</day><month>08</month><year>2024</year></pub-date><volume>13</volume><elocation-id>e86181</elocation-id><history><date date-type="received" iso-8601-date="2023-01-14"><day>14</day><month>01</month><year>2023</year></date><date date-type="accepted" iso-8601-date="2024-07-22"><day>22</day><month>07</month><year>2024</year></date></history><pub-history><event><event-desc>This manuscript was published as a preprint at .</event-desc><date date-type="preprint" iso-8601-date="2022-12-22"><day>22</day><month>12</month><year>2022</year></date><self-uri content-type="preprint" xlink:href="https://doi.org/10.1101/2022.12.22.521661"/></event></pub-history><permissions><copyright-statement>© 2024, Spisak et al</copyright-statement><copyright-year>2024</copyright-year><copyright-holder>Spisak et al</copyright-holder><ali:free_to_read/><license xlink:href="http://creativecommons.org/licenses/by/4.0/"><ali:license_ref>http://creativecommons.org/licenses/by/4.0/</ali:license_ref><license-p>This article is distributed under the terms of the <ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution License</ext-link>, which permits unrestricted use and redistribution provided that the original author and source are credited.</license-p></license></permissions><self-uri content-type="pdf" xlink:href="elife-86181-v2.pdf"/><self-uri content-type="figures-pdf" xlink:href="elife-86181-figures-v2.pdf"/><abstract><p>B-cell repertoires are characterized by a diverse set of receptors of distinct specificities generated through two processes of somatic diversification: V(D)J recombination and somatic hypermutations. B-cell clonal families stem from the same V(D)J recombination event, but differ in their hypermutations. Clonal families identification is key to understanding B-cell repertoire function, evolution, and dynamics. We present HILARy (high-precision inference of lineages in antibody repertoires), an efficient, fast, and precise method to identify clonal families from single- or paired-chain repertoire sequencing datasets. HILARy combines probabilistic models that capture the receptor generation and selection statistics with adapted clustering methods to achieve consistently high inference accuracy. It automatically leverages the phylogenetic signal of shared mutations in difficult repertoire subsets. Exploiting the high sensitivity of the method, we find the statistics of evolutionary properties such as the site frequency spectrum and <italic>d</italic><sub><italic>N</italic></sub>/<italic>d<sub>S</sub></italic> ratio do not depend on the junction length. We also identify a broad range of selection pressures spanning two orders of magnitude.</p></abstract><kwd-group kwd-group-type="author-keywords"><kwd>antibodies</kwd><kwd>immune repertoires</kwd><kwd>lineage tracing</kwd><kwd>statistical methods</kwd></kwd-group><kwd-group kwd-group-type="research-organism"><title>Research organism</title><kwd>Human</kwd></kwd-group><funding-group><award-group id="fund1"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100000781</institution-id><institution>European Research Council</institution></institution-wrap></funding-source><award-id>COG 724208</award-id><principal-award-recipient><name><surname>Spisak</surname><given-names>Natanael</given-names></name><name><surname>Dupic</surname><given-names>Thomas</given-names></name><name><surname>Mora</surname><given-names>Thierry</given-names></name><name><surname>Walczak</surname><given-names>Aleksandra M</given-names></name></principal-award-recipient></award-group><award-group id="fund2"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100001665</institution-id><institution>Agence Nationale de la Recherche</institution></institution-wrap></funding-source><award-id>ANR-19-CE45-0018 `RESP- REP'</award-id><principal-award-recipient><name><surname>Spisak</surname><given-names>Natanael</given-names></name><name><surname>Dupic</surname><given-names>Thomas</given-names></name><name><surname>Mora</surname><given-names>Thierry</given-names></name><name><surname>Walczak</surname><given-names>Aleksandra M</given-names></name></principal-award-recipient></award-group><award-group id="fund3"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100001659</institution-id><institution>Deutsche Forschungsgemeinschaft</institution></institution-wrap></funding-source><award-id>CRC 1310 `Predictability in Evolution'.</award-id><principal-award-recipient><name><surname>Spisak</surname><given-names>Natanael</given-names></name><name><surname>Athènes</surname><given-names>Gabriel</given-names></name><name><surname>Dupic</surname><given-names>Thomas</given-names></name><name><surname>Mora</surname><given-names>Thierry</given-names></name><name><surname>Walczak</surname><given-names>Aleksandra M</given-names></name></principal-award-recipient></award-group><funding-statement>The funders had no role in study design, data collection and interpretation, or the decision to submit the work for publication.</funding-statement></funding-group><custom-meta-group><custom-meta specific-use="meta-only"><meta-name>Author impact statement</meta-name><meta-value>HILARy is a new algorithm for grouping B-cell receptor sequences into distinct lineages, a crucial task to analyze immune response and memory through repertoire sequencing.</meta-value></custom-meta></custom-meta-group></article-meta></front><body><sec id="s1" sec-type="intro"><title>Introduction</title><p>B cells play a key role in the adaptive immune response through their diverse repertoire of immunoglobulins (Ig). These proteins recognize foreign pathogens in their membrane-bound form (called B-cell receptor [BCR]), and battle them in their soluble form (antibody). Each B cell expresses a unique BCR that can bind their antigenic targets with high affinity. The set of distinct BCR harbored by the organism is highly diverse (<xref ref-type="bibr" rid="bib6">Briney et al., 2019</xref>), thanks to two processes of diversification: V(D)J recombination and somatic hypermutation. These stochastic processes ensure that repertoires can match a variety of potential threats, including proteins of bacterial and viral origin that have never been encountered before.</p><p>V(D)J recombination takes place during B-cell differentiation (<xref ref-type="bibr" rid="bib16">Hozumi and Tonegawa, 1976</xref>; <xref ref-type="bibr" rid="bib37">Schatz and Swanson, 2011</xref>). For each Ig chain, V, D, and J gene segments for the heavy chain, and V and J gene segments for the light chain, are randomly chosen and joined with random non-templated deletions and insertions at the junction, creating a long, hypervariable region, called the complementarity determining region 3 (CDR3) (<xref ref-type="fig" rid="fig1">Figure 1A</xref>). Cells are subsequently selected for the binding properties of their receptors and against autoreactivity. At this stage, the repertoire already covers a wide range of specificities. In response to antigenic stimuli, B cells with the relevant specificities are recruited to germinal centers, where they proliferate and their Ig-coding genes undergo somatic hypermutation (<xref ref-type="bibr" rid="bib44">Victora and Nussenzweig, 2022</xref>) in the process of affinity maturation. Somatic hypermutation consists primarily of point substitutions, as well as insertions and deletions, restricted to Ig-coding genes (<xref ref-type="bibr" rid="bib12">Feng et al., 2020</xref>). The mutants are selected for high affinity to the particular antigenic target, and the best binders further differentiate into plasma cells and produce high-affinity antibodies. A more diverse pool of variants forms the memory repertoire, leaving an imprint of the immune response that can be recalled upon repeated stimulation.</p><fig id="fig1" position="float"><label>Figure 1.</label><caption><title>Clonal families and <inline-formula><mml:math id="inf1"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> classes.</title><p>(<bold>A</bold>) Variable region of the immunoglobulin heavy chain (IgH)-coding gene. (<bold>B</bold>) A clonal family is a lineage of related B cells stemming from the same VDJ recombination event. The partition of the B-cell receptor (BCR) repertoire into clonal families is a refinement of the partition into <inline-formula><mml:math id="inf2"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> classes, defined by sequences with the same V and J usage and the same complementarity determining region 3 (CDR3) length <inline-formula><mml:math id="inf3"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula>. (<bold>C–D</bold>) Properties of <inline-formula><mml:math id="inf4"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> classes in donor 326651 from <xref ref-type="bibr" rid="bib6">Briney et al., 2019</xref>. (<bold>C</bold>) Distribution of <inline-formula><mml:math id="inf5"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class sizes exhibits power-law scaling. The total number of pairwise comparisons in the largest <inline-formula><mml:math id="inf6"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> classes is <inline-formula><mml:math id="inf7"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo>∼</mml:mo><mml:msup><mml:mrow class="MJX-TeXAtom-ORD"><mml:msup><mml:mn>10</mml:mn><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>5</mml:mn></mml:mrow></mml:msup></mml:mrow><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:msup><mml:mn>10</mml:mn><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>10</mml:mn></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula>. (<bold>D</bold>) Distribution of the CDR3 length <inline-formula><mml:math id="inf8"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula>. The distribution is in yellow for in-frame CDR3 sequences (<inline-formula><mml:math id="inf9"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula> multiple of 3), and in gray for out-of-frame sequences.</p></caption><graphic mimetype="image" mime-subtype="tiff" xlink:href="elife-86181-fig1-v2.tif"/></fig><p>A clonal family is defined as a collection of cells that stem from a unique V(D)J rearrangement, and has diversified as a result of hypermutation, forming a lineage (<xref ref-type="fig" rid="fig1">Figure 1B</xref>). These families are the main building blocks of the repertoire. Since members of the same family usually share their specificities (<xref ref-type="bibr" rid="bib8">De Boer et al., 2001</xref>), affinity maturation first competes families against each other for antigen binding in the early stages of the reaction, and then selects out the best binders within families in the later stages (<xref ref-type="bibr" rid="bib40">Tas et al., 2016</xref>; <xref ref-type="bibr" rid="bib26">Mesin et al., 2016</xref>).</p><p>High-throughput sequencing of single receptor chains offers unprecedented insight into the diversity and dynamics of the repertoire. Recent experiments have sampled the repertoires of the immunoglobulin heavy chain (IgH) of healthy individuals at great depth to reveal their structure (<xref ref-type="bibr" rid="bib6">Briney et al., 2019</xref>). Disease-specific cohorts are now routinely subject to repertoire sequencing studies, which help to quantify and understand the dynamics of the B-cell response (<xref ref-type="bibr" rid="bib20">Kreer et al., 2020</xref>; <xref ref-type="bibr" rid="bib29">Nielsen et al., 2020</xref>).</p><p>Partitioning BCR repertoire sequence datasets into clonal families is a critical step in understanding the architecture of each sample and interpreting the results. Identifying these lineages allows for quantifying selection (<xref ref-type="bibr" rid="bib45">Yaari and Uduman, 2012</xref>; <xref ref-type="bibr" rid="bib46">Yaari and Kleinstein, 2015</xref>; <xref ref-type="bibr" rid="bib35">Ruiz Ortega et al., 2023</xref>) and for detecting changes in longitudinal measurements (<xref ref-type="bibr" rid="bib29">Nielsen et al., 2020</xref>; <xref ref-type="bibr" rid="bib41">Turner et al., 2020</xref>). In recent years, many strategies have been developed that take advantage of CDR3 hypervariability (<xref ref-type="bibr" rid="bib1">Abdollahi et al., 2020</xref>): it is generally unlikely that the same or a similar CDR3 sequence be generated independently multiple times (<xref ref-type="bibr" rid="bib11">Elhanati et al., 2015</xref>; <xref ref-type="bibr" rid="bib35">Ruiz Ortega et al., 2023</xref>). Other approaches make use of the information encoded in the intra-lineage patterns of divergence due to mutations (<xref ref-type="bibr" rid="bib5">Briney et al., 2016</xref>; <xref ref-type="bibr" rid="bib31">Nouri and Kleinstein, 2020</xref>). All inference techniques need to balance accuracy and speed. Simpler methods are fast but have low precision (also called positive predictive value) while more complex algorithms have long computation times that do not scale well with the number of sequences. This prohibits the analysis of recent large-scale data such as <xref ref-type="bibr" rid="bib6">Briney et al., 2019</xref>.</p><p>In this work, we propose a new method for inferring clonal families from high-throughput sequencing data that is both fast and accurate. We use probabilistic models of junctional diversity to estimate the level of clonality in repertoire subsets, allowing us to tune the sensitivity threshold a priori to achieve a desired accuracy. We have developed two complementary algorithms. The first one (HILARy-CDR3) uses a very fast CDR3-based approach that avoids pairwise comparisons, while the second one (HILARy-full) additionally exploits information encoded in the phylogenetic signal outside of the junction. We compare our method with state-of-the-art approaches in a benchmark with realistic synthetic data.</p></sec><sec id="s2" sec-type="results"><title>Results</title><sec id="s2-1"><title>Analysis of pairwise distances within <inline-formula><mml:math id="inf10"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> classes</title><p>A common strategy for partitioning a BCR repertoire dataset into clonal families is to go through all pairs of sequences and identify pairs of clonally related sequences. In the following, we call such related pairs <italic>positive</italic>, and pairs of sequences belonging to different families <italic>negative</italic>. Then, the partition is built by single-linkage clustering, which consists of recursively grouping all positive pairs. Two characteristics of the repertoire complicate the search for this partition: large total number of pairs and low proportion of positive pairs. In this section we analyze and model the statistics of pairs of sequences in natural repertoires to inform our choice of the clustering method and parameters. In the next section we will leverage that analysis to design an optimized clustering procedure. To help following notations, a summary of their definitions is provided in <xref ref-type="table" rid="table1">Table 1</xref>.</p><table-wrap id="table1" position="float"><label>Table 1.</label><caption><title>Summary of notations used throughout the paper.</title><p>Hats ˆ denote estimates from the fit of the mixture model. Stars ∗ denote estimates after imposing 99% precision. The ‘post’ subscript denotes quantities after applying single-linkage clustering to obtain a partition from positive pairs.</p></caption><table frame="hsides" rules="groups"><thead><tr><th align="left" valign="bottom"/><th align="left" valign="bottom">Definition</th></tr></thead><tbody><tr><td align="left" valign="bottom"><inline-formula><mml:math id="inf11"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>ρ</mml:mi></mml:mstyle></mml:math></inline-formula></td><td align="left" valign="bottom">Prevalence/fraction of positive pairs</td></tr><tr><td align="left" valign="bottom"><inline-formula><mml:math id="inf12"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>π</mml:mi></mml:mstyle></mml:math></inline-formula></td><td align="left" valign="bottom">Precision = TP/(TP+FP)</td></tr><tr><td align="left" valign="bottom"><inline-formula><mml:math id="inf13"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>s</mml:mi></mml:mstyle></mml:math></inline-formula></td><td align="left" valign="bottom">Sensitivity = TP/(TP+FN)</td></tr><tr><td align="left" valign="bottom"><inline-formula><mml:math id="inf14"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>p</mml:mi></mml:mstyle></mml:math></inline-formula></td><td align="left" valign="bottom">Fallout = FP/(FP+TN)</td></tr><tr><td align="left" valign="bottom"><inline-formula><mml:math id="inf15"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>t</mml:mi></mml:mstyle></mml:math></inline-formula></td><td align="left" valign="bottom">Threshold on CDR3 distance</td></tr><tr><td align="left" valign="bottom"><inline-formula><mml:math id="inf16"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula></td><td align="left" valign="bottom">CDR3 length</td></tr><tr><td align="left" valign="bottom"><inline-formula><mml:math id="inf17"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>n</mml:mi></mml:mstyle></mml:math></inline-formula></td><td align="left" valign="bottom">CDR3 Hamming distance of a pair</td></tr><tr><td align="left" valign="bottom"><inline-formula><mml:math id="inf18"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>x</mml:mi></mml:mstyle></mml:math></inline-formula></td><td align="left" valign="bottom">Normalized CDR3 Hamming distance<inline-formula><mml:math id="inf19"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:mi mathvariant="italic">l</mml:mi><mml:mrow><mml:mo mathvariant="italic">/</mml:mo></mml:mrow><mml:mi mathvariant="italic">n</mml:mi></mml:mrow></mml:mrow></mml:mstyle></mml:math></inline-formula></td></tr><tr><td align="left" valign="bottom"><inline-formula><mml:math id="inf20"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>x</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula></td><td align="left" valign="bottom">CDR3 Hamming distance, centered and scaled</td></tr><tr><td align="left" valign="bottom"><inline-formula><mml:math id="inf21"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>y</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula></td><td align="left" valign="bottom">Shared mutations on V segment, centered and scaled</td></tr><tr><td align="left" valign="bottom"><inline-formula><mml:math id="inf22"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>μ</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula></td><td align="left" valign="bottom">Mean <inline-formula><mml:math id="inf23"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>x</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> between positive pairs</td></tr><tr><td align="left" valign="bottom"><inline-formula><mml:math id="inf24"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula></td><td align="left" valign="bottom">Model distribution for positive pairs</td></tr><tr><td align="left" valign="bottom"><inline-formula><mml:math id="inf25"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">F</mml:mi></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula></td><td align="left" valign="bottom">Model distribution for negative pairs</td></tr></tbody></table></table-wrap><p>A pair of related sequences is expected to share the same V and J genes, as well as the same CDR3 length <inline-formula><mml:math id="inf26"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula>, as determined by alignment to the templates (<xref ref-type="fig" rid="fig1">Figure 1A</xref>). The methods developed here begin by partitioning the data into <inline-formula><mml:math id="inf27"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> classes, defined as subsets of sequences with the same V and J gene usage, and CDR3 length <inline-formula><mml:math id="inf28"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula> (<xref ref-type="fig" rid="fig1">Figure 1B</xref>). For a description of the data preprocessing and alignment to the V and J gene templates, see Methods. Clustering will then be performed within each <inline-formula><mml:math id="inf29"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class independently. While this first step severely limits the number of unnecessary comparisons, some <inline-formula><mml:math id="inf30"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> classes still exceed 10<sup>5</sup> sequences in large datasets, leading to the order of 10<sup>10</sup> pairs (see <xref ref-type="fig" rid="fig1">Figure 1C</xref> for the distribution of the <inline-formula><mml:math id="inf31"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class sizes <inline-formula><mml:math id="inf32"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>N</mml:mi></mml:mstyle></mml:math></inline-formula> for donor 326651 of <xref ref-type="bibr" rid="bib6">Briney et al., 2019</xref>).</p><p>The CDR3 plays an important role in encoding the signature of the VDJ rearrangement. As we will see, the CDR3 length <inline-formula><mml:math id="inf33"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula> has a strong impact on the difficulty of clonal family reconstruction. The distribution of CDR3 lengths <inline-formula><mml:math id="inf34"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula> observed in the data is shown in <xref ref-type="fig" rid="fig1">Figure 1D</xref>. In what follows we restrict our analysis to sequences with CDR3 lengths a multiple of 3 and between 15 and 105, relying on the common approximation that sequences with no frameshift in the CDR3 come from a productive naive ancestor. The number of sequences with length larger than 105 is too small to reach meaningful conclusions, and sequences of length smaller than 15 are likely nonfunctional (as evidenced by the similar number of in-frame and out-of-frame sequences in <xref ref-type="fig" rid="fig1">Figure 1D</xref>).</p><p>In each <inline-formula><mml:math id="inf35"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class, we call <italic>prevalence</italic> and denote by <inline-formula><mml:math id="inf36"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>ρ</mml:mi></mml:mstyle></mml:math></inline-formula> the proportion of positive pairs, i.e., the number of positive pairs divided by the total number of pairs. This quantity is unknown in the absence of the ground-truth partition. However, we can estimate it from the statistics of pairwise distances. We compute the Hamming distance <inline-formula><mml:math id="inf37"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>n</mml:mi></mml:mstyle></mml:math></inline-formula> of each pair of CDR3s, defined as the number of positions at which the two nucleotide sequences differ. The distribution of these distances normalized by the CDR3 length, denoted by <inline-formula><mml:math id="inf38"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>x</mml:mi></mml:mstyle></mml:math></inline-formula>, shows a clear bimodal structure in data (donor 326651 of <xref ref-type="bibr" rid="bib6">Briney et al., 2019</xref>), with two identifiable components (<xref ref-type="fig" rid="fig2">Figure 2A</xref>): the contribution of positive pairs (of proportion <inline-formula><mml:math id="inf39"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>ρ</mml:mi></mml:mstyle></mml:math></inline-formula>) peaks near <inline-formula><mml:math id="inf40"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>x</mml:mi><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mstyle></mml:math></inline-formula> and decays quickly, whereas the bell-shaped contribution of negative pairs (of proportion <inline-formula><mml:math id="inf41"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:mi>ρ</mml:mi></mml:mstyle></mml:math></inline-formula>) peaks around <inline-formula><mml:math id="inf42"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>x</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>/</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:mstyle></mml:math></inline-formula>.</p><fig-group><fig id="fig2" position="float"><label>Figure 2.</label><caption><title>Complementarity determining region 3 (CDR3)-based inference method (HILARy-CDR3).</title><p>(<bold>A</bold>) Example distribution of normalized Hamming distances, <inline-formula><mml:math id="inf43"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>x</mml:mi><mml:mo>=</mml:mo><mml:mi>n</mml:mi><mml:mrow><mml:mo>/</mml:mo></mml:mrow><mml:mi>l</mml:mi></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula>, for one <inline-formula><mml:math id="inf44"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class with CDR3 length <inline-formula><mml:math id="inf45"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi><mml:mo>=</mml:mo><mml:mn>21</mml:mn></mml:mstyle></mml:math></inline-formula>, V gene IGHV3-9 and J gene IGHJ4 (black). We fit the distribution by a mixture of positive pairs (belonging to the same family, in blue) and negative pairs (belonging to different families, in red). See <xref ref-type="fig" rid="fig2s5">Figure 2—figure supplement 5</xref> for example fit results across different CDR3 lengths. Inset: the prevalence is defined as a fraction of positive pairs and was estimated to <inline-formula><mml:math id="inf46"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>ρ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo>=</mml:mo><mml:mn>3.1</mml:mn><mml:mi mathvariant="normal">%</mml:mi></mml:mstyle></mml:math></inline-formula>. Data from donor 326651 of <xref ref-type="bibr" rid="bib6">Briney et al., 2019</xref>. (<bold>B</bold>) Distribution of the maximum likelihood estimates of prevalence <inline-formula><mml:math id="inf47"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>ρ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:math></inline-formula> across <inline-formula><mml:math id="inf48"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> classes in donor 326651. (<bold>C–F</bold>) The choice of threshold <inline-formula><mml:math id="inf49"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>t</mml:mi></mml:mstyle></mml:math></inline-formula> on the normalized Hamming distance <inline-formula><mml:math id="inf50"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>x</mml:mi></mml:mstyle></mml:math></inline-formula> translates to the following a priori characteristics of inference (illustrated here for arbitrarily chosen <inline-formula><mml:math id="inf51"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>ρ</mml:mi></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf52"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>μ</mml:mi></mml:mstyle></mml:math></inline-formula>). (<bold>C</bold>) Fallout rate <inline-formula><mml:math id="inf53"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mover><mml:mi>p</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mrow><mml:mrow><mml:mover><mml:mrow><mml:mi mathvariant="normal">F</mml:mi><mml:mi mathvariant="normal">P</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mrow><mml:mo>/</mml:mo></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mrow><mml:mover><mml:mrow><mml:mi mathvariant="normal">F</mml:mi><mml:mi mathvariant="normal">P</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo>+</mml:mo><mml:mrow><mml:mover><mml:mrow><mml:mi mathvariant="normal">T</mml:mi><mml:mi mathvariant="normal">N</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula>. The null distribution of all negatives (N=FP + TN) is estimated using the soNNia sequence generation software. (<bold>D</bold>) Sensitivity <inline-formula><mml:math id="inf54"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mover><mml:mi>s</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mrow><mml:mrow><mml:mover><mml:mrow><mml:mi mathvariant="normal">T</mml:mi><mml:mi mathvariant="normal">P</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mrow><mml:mo>/</mml:mo></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mrow><mml:mover><mml:mrow><mml:mi mathvariant="normal">T</mml:mi><mml:mi mathvariant="normal">P</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mo>+</mml:mo><mml:mrow><mml:mrow><mml:mover><mml:mrow><mml:mi mathvariant="normal">F</mml:mi><mml:mi mathvariant="normal">N</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula>. (<bold>E–F</bold>) Precision <inline-formula><mml:math id="inf55"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mover><mml:mi>π</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:mover><mml:mrow><mml:mi mathvariant="normal">T</mml:mi><mml:mi mathvariant="normal">P</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mo>/</mml:mo></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mover><mml:mrow><mml:mi mathvariant="normal">T</mml:mi><mml:mi mathvariant="normal">P</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo>+</mml:mo><mml:mrow><mml:mover><mml:mrow><mml:mi mathvariant="normal">F</mml:mi><mml:mi mathvariant="normal">P</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula>. For the same choice of threshold <inline-formula><mml:math id="inf56"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>t</mml:mi></mml:mstyle></mml:math></inline-formula>, a low prevalence of <inline-formula><mml:math id="inf57"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>ρ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo>=</mml:mo><mml:msup><mml:mn>10</mml:mn><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>−</mml:mo><mml:mn>3</mml:mn></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula> (<bold>E</bold>) leads to lower precision than high prevalence of <inline-formula><mml:math id="inf58"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>ρ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo>=</mml:mo><mml:msup><mml:mn>10</mml:mn><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula> (<bold>F</bold>). (<bold>G</bold>) Model distribution <inline-formula><mml:math id="inf59"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mi>μ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula> of distances between unrelated sequences, for <inline-formula><mml:math id="inf60"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi><mml:mo>=</mml:mo><mml:mn>15</mml:mn><mml:mo>,</mml:mo><mml:mn>30</mml:mn><mml:mo>,</mml:mo><mml:mn>45</mml:mn><mml:mo>,</mml:mo><mml:mn>60</mml:mn></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula>, computed by the soNNia software. (<bold>H</bold>) Precision <inline-formula><mml:math id="inf61"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>π</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:math></inline-formula>, computed a priori (i.e. before doing the inference) from the model with <inline-formula><mml:math id="inf62"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>μ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo>=</mml:mo><mml:mn>0.04</mml:mn></mml:mstyle></mml:math></inline-formula>, <inline-formula><mml:math id="inf63"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>ρ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo>=</mml:mo><mml:mn>0.1</mml:mn></mml:mstyle></mml:math></inline-formula>, and <inline-formula><mml:math id="inf64"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi><mml:mo>=</mml:mo><mml:mn>15</mml:mn><mml:mo>,</mml:mo><mml:mo>.</mml:mo><mml:mo>.</mml:mo><mml:mo>.</mml:mo><mml:mo>,</mml:mo><mml:mn>81</mml:mn></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula> (colors as in G), as a function of the threshold <inline-formula><mml:math id="inf65"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>t</mml:mi></mml:mstyle></mml:math></inline-formula>. For each <inline-formula><mml:math id="inf66"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class and its own inferred <inline-formula><mml:math id="inf67"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>ρ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf68"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>μ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:math></inline-formula>, the threshold <inline-formula><mml:math id="inf69"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>t</mml:mi></mml:mstyle></mml:math></inline-formula> is chosen to achieve a desired <inline-formula><mml:math id="inf70"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>π</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula>. (<bold>I</bold>) High-precision threshold <inline-formula><mml:math id="inf71"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>t</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula> ensuring <inline-formula><mml:math id="inf72"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>π</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mi>t</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:msup><mml:mi>π</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:mn>99</mml:mn><mml:mi mathvariant="normal">%</mml:mi></mml:mstyle></mml:math></inline-formula> a priori, as a function of CDR3 length <inline-formula><mml:math id="inf73"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula> for different values of the prevalence <inline-formula><mml:math id="inf74"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>ρ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:math></inline-formula>, and <inline-formula><mml:math id="inf75"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>μ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo>=</mml:mo><mml:mn>0.04</mml:mn></mml:mstyle></mml:math></inline-formula>, as predicted by the model. (<bold>J</bold>) Sensitivity <inline-formula><mml:math id="inf76"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>s</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mi>t</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula> at the high-precision threshold <inline-formula><mml:math id="inf77"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>t</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula>, as a function of CDR3 length <inline-formula><mml:math id="inf78"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula> for different values of the prevalence <inline-formula><mml:math id="inf79"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>ρ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:math></inline-formula> (colors as in I). Solid lines denote a priori prediction for intermediate mean distance <inline-formula><mml:math id="inf80"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>μ</mml:mi><mml:mo>=</mml:mo><mml:mn>4</mml:mn><mml:mi mathvariant="normal">%</mml:mi></mml:mstyle></mml:math></inline-formula>, dashed lines denote actual performance of HILARy-CDR3 in a synthetic dataset.</p></caption><graphic mimetype="image" mime-subtype="tiff" xlink:href="elife-86181-fig2-v2.tif"/></fig><fig id="fig2s1" position="float" specific-use="child-fig"><label>Figure 2—figure supplement 1.</label><caption><title>Mean intra-family distances.</title><p>Distribution of the maximum likelihood estimates of mean intra-family distance <inline-formula><mml:math id="inf81"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>μ</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> across <inline-formula><mml:math id="inf82"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> classes.</p></caption><graphic mimetype="image" mime-subtype="tiff" xlink:href="elife-86181-fig2-figsupp1-v2.tif"/></fig><fig id="fig2s2" position="float" specific-use="child-fig"><label>Figure 2—figure supplement 2.</label><caption><title>Null distribution <inline-formula><mml:math id="inf83"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">N</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mi>l</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula> of CDR3 distances between unrelated sequences for <inline-formula><mml:math id="inf84"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi><mml:mo>∈</mml:mo><mml:mo stretchy="false">[</mml:mo><mml:mn>15</mml:mn><mml:mo>,</mml:mo><mml:mspace width="thinmathspace"/><mml:mn>81</mml:mn><mml:mo stretchy="false">]</mml:mo></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula>, computed by soNNia software.</title><p>White line denotes a growing threshold ensuring a fallout rate <inline-formula><mml:math id="inf85"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>p</mml:mi><mml:mo>&lt;</mml:mo><mml:msup><mml:mn>10</mml:mn><mml:mrow><mml:mo>−</mml:mo><mml:mn>4</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mstyle></mml:math></inline-formula> as determined by this distribution.</p></caption><graphic mimetype="image" mime-subtype="tiff" xlink:href="elife-86181-fig2-figsupp2-v2.tif"/></fig><fig id="fig2s3" position="float" specific-use="child-fig"><label>Figure 2—figure supplement 3.</label><caption><title>Distribution of normalized Hamming distances.</title><p><inline-formula><mml:math id="inf86"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>x</mml:mi><mml:mo>=</mml:mo><mml:mi>n</mml:mi><mml:mrow><mml:mo>/</mml:mo></mml:mrow><mml:mi>l</mml:mi></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula>, for largest <inline-formula><mml:math id="inf87"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class for each CDR3 length <inline-formula><mml:math id="inf88"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi><mml:mo>=</mml:mo><mml:mn>81</mml:mn></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula> (black). We fit the distribution by a mixture of positive pairs (<inline-formula><mml:math id="inf89"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mi>μ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula> in blue), and negative pairs (<inline-formula><mml:math id="inf90"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi mathvariant="normal">P</mml:mi><mml:mi mathvariant="normal">N</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="normal">x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula>, in red). For <inline-formula><mml:math id="inf91"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi><mml:mo>=</mml:mo><mml:mn>18</mml:mn></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula> the estimate <inline-formula><mml:math id="inf92"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mover><mml:mi>μ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mrow></mml:mstyle></mml:math></inline-formula> is too large results in large fitting error and for sensitivity computation we used global <inline-formula><mml:math id="inf93"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>μ</mml:mi><mml:mo>=</mml:mo><mml:mn>4</mml:mn><mml:mi mathvariant="normal">%</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> (in green).</p></caption><graphic mimetype="image" mime-subtype="tiff" xlink:href="elife-86181-fig2-figsupp3-v2.tif"/></fig><fig id="fig2s4" position="float" specific-use="child-fig"><label>Figure 2—figure supplement 4.</label><caption><title>Distribution of post-selection probabilities.</title><p>P<sub>post</sub> of CDR3 nucleotide sequences computed using soNNia across CDR3 lengths. Short junctions are on average more likely to be generated in VDJ recombination and pass subsequent selection (<xref ref-type="bibr" rid="bib17">Isacchini et al., 2021</xref>). This makes inference in low-l classes more difficult, a feature reflected by synthetic dataset constructed by sampling unmutated lineage progenitors from the soNNia model.</p></caption><graphic mimetype="image" mime-subtype="tiff" xlink:href="elife-86181-fig2-figsupp4-v2.tif"/></fig><fig id="fig2s5" position="float" specific-use="child-fig"><label>Figure 2—figure supplement 5.</label><caption><title>Site frequency spectra estimated for families identifed using high-precision CDR3-based inference method (HILARy-CDR3) in the subset of the data where this approach is highly reliable (large-﻿<inline-formula><mml:math id="inf94"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> and large-<inline-formula><mml:math id="inf95"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mover><mml:mi>ρ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mrow></mml:mstyle></mml:math></inline-formula> regime).</title><p>The distributions are shown for families of varying family size, <inline-formula><mml:math id="inf96"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>z</mml:mi><mml:mspace width="thinmathspace"/><mml:mo>∈</mml:mo><mml:mo stretchy="false">[</mml:mo><mml:mn>10</mml:mn><mml:mo>,</mml:mo><mml:mspace width="thinmathspace"/><mml:mn>100</mml:mn><mml:mo stretchy="false">]</mml:mo></mml:mrow></mml:mstyle></mml:math></inline-formula> and averaged over all families of a given size. Together with the exact configuration of sequences carrying a given substitution, synthetic datasets of the sames ignatures of mutations and clonal expansions can be generated.</p></caption><graphic mimetype="image" mime-subtype="tiff" xlink:href="elife-86181-fig2-figsupp5-v2.tif"/></fig><fig id="fig2s6" position="float" specific-use="child-fig"><label>Figure 2—figure supplement 6.</label><caption><title>Distribution of normalized Hamming distances <inline-formula><mml:math id="inf97"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>x</mml:mi><mml:mo>=</mml:mo><mml:mi>n</mml:mi><mml:mrow><mml:mo>/</mml:mo></mml:mrow><mml:mi>l</mml:mi></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula>, for <inline-formula><mml:math id="inf98"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> classes, averaging over all <inline-formula><mml:math id="inf99"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> classes.</title><p>We fit the distribution by a mixture of positive pairs using a geometric distribution (<inline-formula><mml:math id="inf100"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mi>μ</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula> in blue), and negative pairs (<inline-formula><mml:math id="inf101"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi mathvariant="normal">P</mml:mi><mml:mi mathvariant="normal">N</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="normal">x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mstyle></mml:math></inline-formula>, in red). The corresponding prevalence estimates <inline-formula><mml:math id="inf102"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mover><mml:mi>p</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mrow></mml:mstyle></mml:math></inline-formula> are used for small <inline-formula><mml:math id="inf103"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> classes for which this parameter cannot be reliably estimated independently.</p></caption><graphic mimetype="image" mime-subtype="tiff" xlink:href="elife-86181-fig2-figsupp6-v2.tif"/></fig><fig id="fig2s7" position="float" specific-use="child-fig"><label>Figure 2—figure supplement 7.</label><caption><title>Prevalence and <inline-formula><mml:math id="inf104"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class size.</title><p>Dependence of prevalence estimates on <inline-formula><mml:math id="inf105"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class size N for largest classes in donor 326651 from <xref ref-type="bibr" rid="bib6">Briney et al., 2019</xref>. 28% of variation in prevalence estimates can be explained by variation in <inline-formula><mml:math id="inf106"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class sizes.</p></caption><graphic mimetype="image" mime-subtype="tiff" xlink:href="elife-86181-fig2-figsupp7-v2.tif"/></fig></fig-group><p>The prevalence <inline-formula><mml:math id="inf107"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>ρ</mml:mi></mml:mstyle></mml:math></inline-formula> can be formally written as <inline-formula><mml:math id="inf108"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo stretchy="false">[</mml:mo><mml:msub><mml:mi mathvariant="normal">Σ</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>z</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>z</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">)</mml:mo><mml:mrow><mml:mo>/</mml:mo></mml:mrow><mml:mn>2</mml:mn><mml:mo stretchy="false">]</mml:mo><mml:mrow><mml:mo>/</mml:mo></mml:mrow><mml:mo stretchy="false">[</mml:mo><mml:mi>N</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>N</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">)</mml:mo><mml:mrow><mml:mo>/</mml:mo></mml:mrow><mml:mn>2</mml:mn><mml:mo stretchy="false">]</mml:mo></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula>, where <inline-formula><mml:math id="inf109"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>z</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> denote the sizes of the clonal families in the <inline-formula><mml:math id="inf110"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class, but we do not know these sizes before the partition into families is found. To overcome this issue, we developed a method to estimate <inline-formula><mml:math id="inf111"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>ρ</mml:mi></mml:mstyle></mml:math></inline-formula> a priori, without knowing the family structure (Methods). We do this by fitting the empirical distribution of <inline-formula><mml:math id="inf112"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>x</mml:mi></mml:mstyle></mml:math></inline-formula> as a mixture model, <inline-formula><mml:math id="inf113"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>P</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>ρ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>+</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>ρ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">)</mml:mo><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">F</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula>, where <inline-formula><mml:math id="inf114"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf115"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">F</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula> are the distributions of distances between positive (T as true) and negative (F as false) pairs (<xref ref-type="fig" rid="fig2">Figure 2C and D</xref>), estimated as follows. <inline-formula><mml:math id="inf116"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">F</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">F</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mi>l</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula> is computed for each length <inline-formula><mml:math id="inf117"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula> by generating a large number of unrelated, same-length sequences with the soNNia model of recombination and selection (<xref ref-type="bibr" rid="bib17">Isacchini et al., 2021</xref>), and calculating the distribution of their pairwise distances (Methods). <inline-formula><mml:math id="inf118"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula> is approximated by a Poisson distribution, <inline-formula><mml:math id="inf119"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mi>μ</mml:mi><mml:mi>l</mml:mi><mml:msup><mml:mo stretchy="false">)</mml:mo><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>x</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msup><mml:msup><mml:mi>e</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>−</mml:mo><mml:mi>μ</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msup><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>/</mml:mo></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mi>l</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>!</mml:mo></mml:mstyle></mml:math></inline-formula>, with adjustable parameter <inline-formula><mml:math id="inf120"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>μ</mml:mi></mml:mstyle></mml:math></inline-formula>, which is proportional to the average hypermutation rate within the clone. The fit of <inline-formula><mml:math id="inf121"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>P</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula> by the mixture model is performed for each <inline-formula><mml:math id="inf122"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class with an expectation-maximization algorithm which finds maximum likelihood estimates of the prevalence <inline-formula><mml:math id="inf123"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>ρ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:math></inline-formula> and mean intra-family distance <inline-formula><mml:math id="inf124"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>μ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:math></inline-formula>, the only free parameters of the mixture model.</p><p>The results of the fit to real data (donor 326651 of <xref ref-type="bibr" rid="bib6">Briney et al., 2019</xref>) show that <inline-formula><mml:math id="inf125"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>μ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:math></inline-formula> varies little between <inline-formula><mml:math id="inf126"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> classes, around <inline-formula><mml:math id="inf127"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>μ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo>≃</mml:mo><mml:mn>4</mml:mn><mml:mi mathvariant="normal">%</mml:mi></mml:mstyle></mml:math></inline-formula> (<xref ref-type="fig" rid="fig2s1">Figure 2—figure supplement 1</xref>). In contrast, the prevalence <inline-formula><mml:math id="inf128"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>ρ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:math></inline-formula> varies widely across classes, spanning three orders of magnitude (<xref ref-type="fig" rid="fig2">Figure 2B</xref>). In addition, when we examine the <inline-formula><mml:math id="inf129"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> classes with increasing CDR3 length <inline-formula><mml:math id="inf130"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula>, we find that the part of the model distribution corresponding to positive pairs, <inline-formula><mml:math id="inf131"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula>, varies little, whereas the model distribution over negative pairs <inline-formula><mml:math id="inf132"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">F</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula> becomes more and more peaked around 1/2 (<xref ref-type="fig" rid="fig2">Figure 2</xref> and <xref ref-type="fig" rid="fig2s2">Figure 2—figure supplement 2</xref>), making the two categories more easily separable.</p></sec><sec id="s2-2"><title>CDR3-based inference method with adaptive threshold</title><p>We want to build a classifier between positive and negative pairs using the normalized distance <inline-formula><mml:math id="inf133"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>x</mml:mi></mml:mstyle></mml:math></inline-formula> alone, by setting a threshold <inline-formula><mml:math id="inf134"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>t</mml:mi></mml:mstyle></mml:math></inline-formula> so that pairs are called positive if <inline-formula><mml:math id="inf135"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>x</mml:mi><mml:mo>≤</mml:mo><mml:mi>t</mml:mi></mml:mstyle></mml:math></inline-formula>, and negative otherwise. Using our model for <inline-formula><mml:math id="inf136"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>P</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula>, for any given <inline-formula><mml:math id="inf137"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>t</mml:mi></mml:mstyle></mml:math></inline-formula> we can evaluate the number of true positives (<inline-formula><mml:math id="inf138"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mover><mml:mrow><mml:mi mathvariant="normal">T</mml:mi><mml:mi mathvariant="normal">P</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula>) and false negatives (<inline-formula><mml:math id="inf139"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mover><mml:mrow><mml:mi mathvariant="normal">F</mml:mi><mml:mi mathvariant="normal">N</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula>) among all positive pairs (<inline-formula><mml:math id="inf140"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mover><mml:mtext>P</mml:mtext><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:mover><mml:mrow><mml:mi mathvariant="normal">T</mml:mi><mml:mi mathvariant="normal">P</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo>+</mml:mo><mml:mrow><mml:mover><mml:mrow><mml:mi mathvariant="normal">F</mml:mi><mml:mi mathvariant="normal">N</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula>), as well as true negatives (<inline-formula><mml:math id="inf141"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mover><mml:mrow><mml:mi mathvariant="normal">T</mml:mi><mml:mi mathvariant="normal">N</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula>) and false positives (<inline-formula><mml:math id="inf142"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mover><mml:mrow><mml:mi mathvariant="normal">F</mml:mi><mml:mi mathvariant="normal">P</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula>) among the negative pairs (<inline-formula><mml:math id="inf143"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mover><mml:mtext>N</mml:mtext><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:mover><mml:mrow><mml:mi mathvariant="normal">T</mml:mi><mml:mi mathvariant="normal">N</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo>+</mml:mo><mml:mrow><mml:mover><mml:mrow><mml:mi mathvariant="normal">F</mml:mi><mml:mi mathvariant="normal">P</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula>), as schematized in <xref ref-type="fig" rid="fig2s2">Figure 2—figure supplement 2C and D</xref>.</p><p>Our goal is to set a threshold <inline-formula><mml:math id="inf144"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>t</mml:mi></mml:mstyle></mml:math></inline-formula> that ensures a high precision, <inline-formula><mml:math id="inf145"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>π</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula>, defined as a proportion of true positives among all pairs classified as positive (<xref ref-type="fig" rid="fig2">Figure 2E</xref>). In a single-linkage clustering approach, we will join two clusters with at least one pair of positive sequences between them. Therefore, it is critical to limit the number of false positives, which can cause the erroneous merger of large clusters. We can write:<disp-formula id="equ1"><label>(1)</label><mml:math id="m1"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mover><mml:mi>π</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>≡</mml:mo><mml:mfrac><mml:mrow><mml:mover><mml:mrow><mml:mi mathvariant="normal">T</mml:mi><mml:mi mathvariant="normal">P</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mrow><mml:mover><mml:mrow><mml:mi mathvariant="normal">T</mml:mi><mml:mi mathvariant="normal">P</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo>+</mml:mo><mml:mrow><mml:mover><mml:mrow><mml:mi mathvariant="normal">F</mml:mi><mml:mi mathvariant="normal">P</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mrow></mml:mfrac><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mrow><mml:mover><mml:mi>ρ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mover><mml:mi>s</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:mrow><mml:mover><mml:mi>ρ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mover><mml:mi>s</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>+</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:mrow><mml:mover><mml:mi>ρ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">)</mml:mo><mml:mrow><mml:mover><mml:mi>p</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfrac><mml:mo>,</mml:mo></mml:mstyle></mml:mrow></mml:math></disp-formula><disp-formula id="equ2"> <label>(2)</label><mml:math id="m2"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mover><mml:mi>p</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>≡</mml:mo><mml:mfrac><mml:mrow><mml:mover><mml:mtext>FP</mml:mtext><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mover><mml:mtext>N</mml:mtext><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mfrac><mml:mo>=</mml:mo><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>≤</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:munder><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi mathvariant="normal">F</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p>and <inline-formula><mml:math id="inf146"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>s</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula> is the estimated sensitivity (<xref ref-type="fig" rid="fig2">Figure 2D</xref>), evaluated from the Poisson fit to <inline-formula><mml:math id="inf147"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> (Methods):<disp-formula id="equ3"> <label>(3)</label><mml:math id="m3"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mover><mml:mi>s</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>≡</mml:mo><mml:mfrac><mml:mrow><mml:mover><mml:mtext>TP</mml:mtext><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mover><mml:mtext>P</mml:mtext><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mfrac><mml:mo>=</mml:mo><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mo>≤</mml:mo><mml:mi>t</mml:mi></mml:mrow></mml:munder><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p>Finally, the estimated prevalence <inline-formula><mml:math id="inf148"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mover><mml:mi>ρ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo>≡</mml:mo><mml:mrow><mml:mrow><mml:mover><mml:mrow><mml:mi mathvariant="normal">P</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mrow><mml:mo>/</mml:mo></mml:mrow><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mrow><mml:mover><mml:mrow><mml:mi mathvariant="normal">P</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo>+</mml:mo><mml:mrow><mml:mover><mml:mrow><mml:mi mathvariant="normal">N</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula> is inferred from the <inline-formula><mml:math id="inf149"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>P</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula> distribution as explained above.</p><p><xref ref-type="fig" rid="fig2">Figure 2H</xref> shows <inline-formula><mml:math id="inf150"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>π</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula> as a function of <inline-formula><mml:math id="inf151"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>t</mml:mi></mml:mstyle></mml:math></inline-formula> for different CDR3 lengths and a fixed value of <inline-formula><mml:math id="inf152"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>ρ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:math></inline-formula>. For each <inline-formula><mml:math id="inf153"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class, we define the threshold <inline-formula><mml:math id="inf154"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:msup><mml:mi>t</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula> that reaches 99% precision, <inline-formula><mml:math id="inf155"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>π</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mi>t</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:msup><mml:mi>π</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:mn>99</mml:mn><mml:mi mathvariant="normal">%</mml:mi></mml:mstyle></mml:math></inline-formula>, by inverting <xref ref-type="disp-formula" rid="equ1">Equation 1</xref>. This adaptive threshold depends on the <inline-formula><mml:math id="inf156"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>V</mml:mi><mml:mi>J</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class through the CDR3 length <inline-formula><mml:math id="inf157"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula> and the prevalence <inline-formula><mml:math id="inf158"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>ρ</mml:mi></mml:mstyle></mml:math></inline-formula>, and it increases with both (<xref ref-type="fig" rid="fig2">Figure 2I</xref>): low clonality (small <inline-formula><mml:math id="inf159"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>ρ</mml:mi></mml:mstyle></mml:math></inline-formula>) means few positive pairs and a smaller adaptive threshold, while short CDR3 means less information and a stricter inclusion criterion.</p><p>The predicted sensitivity, <inline-formula><mml:math id="inf160"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>s</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mi>t</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula>, which tells us how much of the positives we are capturing, is shown in <xref ref-type="fig" rid="fig2">Figure 2J</xref>. We conclude that for a wide range of parameters, the method is predicted to achieve both high precision and high sensitivity. However, it is expected to fail when the prevalence and the CDR3 length are both low. At the extreme, for small values <inline-formula><mml:math id="inf161"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>ρ</mml:mi></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf162"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula>, even joining together identical CDR3s (<inline-formula><mml:math id="inf163"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mstyle></mml:math></inline-formula>) results in poor precision because of convergent recombination (reflected by <inline-formula><mml:math id="inf164"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>t</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup><mml:mo>&lt;</mml:mo><mml:mn>0</mml:mn></mml:mstyle></mml:math></inline-formula>).</p><p>The resulting procedure, which we call HILARy-CDR3, can be applied to Ig repertoire data through the following steps: (1) group sequences by <inline-formula><mml:math id="inf165"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class; (2) in each class, fit the mixture model to the distribution of pairwise distance to infer <inline-formula><mml:math id="inf166"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>ρ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf167"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>μ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:math></inline-formula>; (3) invert <xref ref-type="disp-formula" rid="equ1 equ2 equ3">Equations 1–3</xref> to find the high-precision threshold <inline-formula><mml:math id="inf168"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>t</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula>; (4) classify positive and negative pairs according to that threshold; (5) complete the partition by applying single-linkage clustering to positive pairs.</p></sec><sec id="s2-3"><title>Tests on synthetic datasets</title><p>So far we have presented a method to set a high-precision threshold with predictable sensitivity, based on estimates from the distribution of distances <inline-formula><mml:math id="inf169"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>P</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula> only. To verify that these performance predictions hold in a realistic inference task, we designed a method to generate realistic synthetic datasets where the clonal family structure is known. This generative method will also be used in the next sections to create a benchmark for comparing different clustering algorithms.</p><p>We first estimated the distribution of clonal family sizes from the data of <xref ref-type="bibr" rid="bib6">Briney et al., 2019</xref>, by applying HILARy-CDR3 with adaptive threshold as described above to <inline-formula><mml:math id="inf170"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> classes for which the inference was highly reliable, i.e. for which the predicted sensitivity was <inline-formula><mml:math id="inf171"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>z</mml:mi><mml:mspace width="thinmathspace"/><mml:mo>∈</mml:mo><mml:mo stretchy="false">[</mml:mo><mml:mn>10</mml:mn><mml:mo>,</mml:mo><mml:mspace width="thinmathspace"/><mml:mn>100</mml:mn><mml:mo stretchy="false">]</mml:mo></mml:mrow></mml:mstyle></mml:math></inline-formula>. In that limit, clusters are clearly separated and the partition should depend only weakly on the choice of clustering method. The resulting distribution of clone sizes follows a power-law with exponent –2.3.</p><p>To create a synthetic lineage, we first draw a random progenitor using the soNNia model for IgH generation (<xref ref-type="fig" rid="fig2s4">Figure 2—figure supplement 4</xref>). We then draw the size of the lineage at random, using the power-law distribution above. Mutations are then randomly drawn on each sequence of the lineage in a way that preserves the mutation sharing patterns observed in families of comparable size from the partitioned data (<xref ref-type="fig" rid="fig2s5">Figure 2—figure supplement 5</xref>). We thus generated 10<sup>4</sup> lineages and 2.5 · 10<sup>4</sup> sequences. Note that, while that procedure is partially based on real data, in particular the distribution of lineage sizes and mutational co-occurence structure in the lineages, it uses completely random sequences and mutations. In addition, these empirical observables were inferred from <inline-formula><mml:math id="inf172"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> classes that were easy to cluster, ensuring that they are not biased by our inference method, and therefore should not give it an unfair advantage. More details about the procedure are given in the Methods.</p><p>We applied the HILARy-CDR3 method to this synthetic dataset. The sensitivity achieved at <inline-formula><mml:math id="inf173"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>t</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula> roughly follows and sometimes even outperforms the predicted one <inline-formula><mml:math id="inf174"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>s</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mi>t</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula> across different values of <inline-formula><mml:math id="inf175"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>ρ</mml:mi></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf176"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula> (<xref ref-type="fig" rid="fig2">Figure 2J</xref>, dashed line), validating the approach and the choice of the adaptive high-precision threshold <inline-formula><mml:math id="inf177"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>t</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula> (the discrepancy is due to the fact that <inline-formula><mml:math id="inf178"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>μ</mml:mi></mml:mstyle></mml:math></inline-formula> is assumed to be constant in the prediction, while it varies in the dataset). These results also confirm the poor performance of the method at low prevalences and short CDR3s.</p></sec><sec id="s2-4"><title>Incorporating phylogenetic signal</title><p>To improve the performance of HILARy-CDR3, we set out to include the phylogenetic signal encoded in the mutation spectrum of the templated regions of the sequences. Two sequences belonging to the same lineage are expected to share some part of the mutational histories, and therefore sequences with shared mutations are more likely to be in the same lineage.</p><p>We focus on the template-aligned region of the sequence outside of the CDR3, where we can reliably identify substitutions with respect to the germline. We denote the length of this alignment by <inline-formula><mml:math id="inf179"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>L</mml:mi></mml:mstyle></mml:math></inline-formula>, so that the total length of the sequence is <inline-formula><mml:math id="inf180"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi><mml:mo>+</mml:mo><mml:mi>L</mml:mi></mml:mstyle></mml:math></inline-formula>. For each pair of sequences, we define <inline-formula><mml:math id="inf181"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>2</mml:mn></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> as the number of mutations along the templated alignment in the two sequences, <inline-formula><mml:math id="inf182"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>0</mml:mn></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> the number of mutations shared by the two, and <inline-formula><mml:math id="inf183"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>L</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:mn>2</mml:mn><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>0</mml:mn></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> the number of non-shared mutations. Under the hypothesis of shared ancestry, the <inline-formula><mml:math id="inf184"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>0</mml:mn></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> shared mutations fall on the shared part of the phylogeny, and are expected to be more numerous than under the null hypothesis of independent sequences, where they are a result of random co-occurrence (<xref ref-type="fig" rid="fig3">Figure 3A</xref>).</p><fig-group><fig id="fig3" position="float"><label>Figure 3.</label><caption><title>Full inference method with mutational information.</title><p>(<bold>A</bold>) For a pair of sequences, <inline-formula><mml:math id="inf185"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>2</mml:mn></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> denote the numbers of mutations along the templated region (V and J), and <inline-formula><mml:math id="inf186"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>0</mml:mn></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> is the number of shared mutations. For related sequences, <inline-formula><mml:math id="inf187"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>0</mml:mn></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> corresponds to mutations on the initial branch of the tree, and is expected to be larger than for unrelated sequences, where <inline-formula><mml:math id="inf188"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>0</mml:mn></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> corresponds to coincidental mutations. (<bold>B</bold>) Positive and negative pairs are called mutated if both sequences have mutations <inline-formula><mml:math id="inf189"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mo>&gt;</mml:mo><mml:mn>0</mml:mn></mml:mstyle></mml:math></inline-formula>. Among positive pairs in the synthetic datasets, more than 99% are mutated. (<bold>C, D</bold>) Distributions of the rescaled variables <inline-formula><mml:math id="inf190"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>x</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf191"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>y</mml:mi></mml:mstyle></mml:math></inline-formula> (<xref ref-type="disp-formula" rid="equ4">Equation 4</xref>), for pairs of synthetic sequences belonging to the same lineage (positive pairs) and sequences belonging to different lineages (negative pairs). The separatrix <inline-formula><mml:math id="inf192"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>x</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup><mml:mo>−</mml:mo><mml:mi>y</mml:mi><mml:mo>=</mml:mo><mml:msup><mml:mi>t</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula> marks a high-precision (99%) threshold choice. (<bold>E</bold>) To limit the number of pairwise comparisons we make use of high-precision and high-sensitivity complementarity determining region 3 (CDR3)-based partitions. High precision corresponds to the choice <inline-formula><mml:math id="inf193"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:msup><mml:mi>t</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula>. High sensitivity corresponds to a coarser partition where <inline-formula><mml:math id="inf194"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>t</mml:mi></mml:mstyle></mml:math></inline-formula> is set to achieve 90% sensitivity. When the two partitions disagree, mutational information can be used to break the coarse, high-sensitivity partition into smaller clonal families. (<bold>F, G</bold>) Mutations-based methods achieve high sensitivity across all CDR3 lengths <inline-formula><mml:math id="inf195"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula> in the synthetic dataset (<bold>G</bold>), extending the range of applicability with respect to the CDR3-based method (<bold>F</bold>).</p></caption><graphic mimetype="image" mime-subtype="tiff" xlink:href="elife-86181-fig3-v2.tif"/></fig><fig id="fig3s1" position="float" specific-use="child-fig"><label>Figure 3—figure supplement 1.</label><caption><title>Merging partitions.</title><p>Red circles represent clusters from the coarse (high-sensitivity) partition, while green clusters represent the fine (high-precision) partition. When the two partitions differ, HILARy-full merges precise clusters inside each sensitive cluster whenever there exists of pair of positive sequences linking them.</p></caption><graphic mimetype="image" mime-subtype="tiff" xlink:href="elife-86181-fig3-figsupp1-v2.tif"/></fig><fig id="fig3s2" position="float" specific-use="child-fig"><label>Figure 3—figure supplement 2.</label><caption><title>Error vs <inline-formula><mml:math id="inf196"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class size.</title><p>We plot the fitting error of <italic>P(x)</italic> by the mixture model, for each <inline-formula><mml:math id="inf197"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class in the synthetic dataset, as a function of their sizes. The error is computed as the squared difference between the model and data distributions of distances.</p></caption><graphic mimetype="image" mime-subtype="tiff" xlink:href="elife-86181-fig3-figsupp2-v2.tif"/></fig></fig-group><p>To balance the tradeoff between the information encoded in the templated part of the sequence and the recombination junction, we can compute characteristic scales for the two variables of interest: the number of shared mutations and the CDR3 distance <italic>n</italic>. Intuitively, in highly mutated sequences, we can expect substantial divergence in the CDR3. At the same time, the number of mutations in the templated regions would increase, possibly leading to more shared mutations. Conversely, sequences with few or no mutations carry no information in the templated region, but we also expect their CDR3 sequences to be nearly identical. To adapt a clustering threshold to the two variables, we compute their expectations under the two assumptions, and define the rescaled variables<disp-formula id="equ4"> <label>(4)</label><mml:math id="m4"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>x</mml:mi><mml:mo>′</mml:mo></mml:msup><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi>n</mml:mi><mml:mo>−</mml:mo><mml:mo fence="false" stretchy="false">⟨</mml:mo><mml:mi>n</mml:mi><mml:msub><mml:mo fence="false" stretchy="false">⟩</mml:mo><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mi>σ</mml:mi><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>n</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfrac><mml:mo>,</mml:mo><mml:mspace width="1em"/><mml:mi>y</mml:mi><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:mo fence="false" stretchy="false">⟨</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:msub><mml:mo fence="false" stretchy="false">⟩</mml:mo><mml:mrow><mml:mi mathvariant="normal">F</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mi>σ</mml:mi><mml:mrow><mml:mi mathvariant="normal">F</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfrac><mml:mo>,</mml:mo></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p>where <inline-formula><mml:math id="inf198"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo fence="false" stretchy="false">⟨</mml:mo><mml:mi>n</mml:mi><mml:msub><mml:mo fence="false" stretchy="false">⟩</mml:mo><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi>l</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>L</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">)</mml:mo><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>/</mml:mo></mml:mrow><mml:mi>L</mml:mi></mml:mstyle></mml:math></inline-formula> is the expected value of <inline-formula><mml:math id="inf199"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>n</mml:mi></mml:mstyle></mml:math></inline-formula> under the hypothesis that sequences belong to the same lineage (see Methods), and <inline-formula><mml:math id="inf200"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo fence="false" stretchy="false">⟨</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:msub><mml:mo fence="false" stretchy="false">⟩</mml:mo><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">F</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>/</mml:mo></mml:mrow><mml:mi>L</mml:mi></mml:mstyle></mml:math></inline-formula> is the expected value of <inline-formula><mml:math id="inf201"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>0</mml:mn></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> under the hypothesis that they do not. The standard deviations are likewise defined as <inline-formula><mml:math id="inf202"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>σ</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>n</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:msqrt><mml:mo fence="false" stretchy="false">⟨</mml:mo><mml:msup><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:msub><mml:mo fence="false" stretchy="false">⟩</mml:mo><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:mo fence="false" stretchy="false">⟨</mml:mo><mml:mi>n</mml:mi><mml:msubsup><mml:mo fence="false" stretchy="false">⟩</mml:mo><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">T</mml:mi></mml:mrow><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:msqrt><mml:mo>=</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>/</mml:mo></mml:mrow><mml:mi>L</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:msqrt><mml:mi>l</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>l</mml:mi><mml:mo>+</mml:mo><mml:mi>L</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>L</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">)</mml:mo></mml:msqrt></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf203"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>σ</mml:mi><mml:mrow><mml:mi mathvariant="normal">F</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:msqrt><mml:mo fence="false" stretchy="false">⟨</mml:mo><mml:msubsup><mml:mi>n</mml:mi><mml:mrow><mml:mn>0</mml:mn></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup><mml:msub><mml:mo fence="false" stretchy="false">⟩</mml:mo><mml:mrow><mml:mi mathvariant="normal">F</mml:mi></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:mo fence="false" stretchy="false">⟨</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:msubsup><mml:mo fence="false" stretchy="false">⟩</mml:mo><mml:mrow><mml:mi mathvariant="normal">F</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msubsup></mml:msqrt><mml:mo>=</mml:mo><mml:msqrt><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:msub><mml:mi>n</mml:mi><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mrow><mml:mo>/</mml:mo></mml:mrow><mml:mi>L</mml:mi></mml:msqrt></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula> (Methods).</p><p>For more than 99% of positive pairs, both sequences are mutated, i.e., <inline-formula><mml:math id="inf204"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mo>&gt;</mml:mo><mml:mn>0</mml:mn></mml:mstyle></mml:math></inline-formula> (<xref ref-type="fig" rid="fig3">Figure 3B</xref>). Without loss of sensitivity, we focus on the mutated part of the dataset, since we cannot use <inline-formula><mml:math id="inf205"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>y</mml:mi></mml:mstyle></mml:math></inline-formula> for non-mutated sequences. The distributions of <inline-formula><mml:math id="inf206"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>x</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf207"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>y</mml:mi></mml:mstyle></mml:math></inline-formula> for positive and negative pairs (<xref ref-type="fig" rid="fig3">Figure 3C and D</xref>) are well separated, with positive pairs characterized by an overrepresentation of shared mutations. By adding the phylogenetic signal <inline-formula><mml:math id="inf208"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>y</mml:mi></mml:mstyle></mml:math></inline-formula> we can identify positive pairs of sequences that have significantly diverged in their CDR3 (<inline-formula><mml:math id="inf209"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>x</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup><mml:mo>&gt;</mml:mo><mml:mn>0</mml:mn></mml:mstyle></mml:math></inline-formula>) but share significantly more mutations than expected (large <inline-formula><mml:math id="inf210"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>y</mml:mi></mml:mstyle></mml:math></inline-formula>).</p><p>Computing <inline-formula><mml:math id="inf211"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>y</mml:mi></mml:mstyle></mml:math></inline-formula> for each pair of sequences is computationally expensive. To avoid examining all pairs, we first perform two different nested clusterings of each <inline-formula><mml:math id="inf212"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class using the CDR3-based method: the previously described HILARy-CDR3 ‘fine’ partition with threshold <inline-formula><mml:math id="inf213"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>t</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula> that ensures high precision <inline-formula><mml:math id="inf214"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>π</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo>=</mml:mo><mml:mn>99</mml:mn><mml:mi mathvariant="normal">%</mml:mi></mml:mstyle></mml:math></inline-formula>; and a ‘coarser’ clustering with a high threshold <inline-formula><mml:math id="inf215"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>t</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mi>t</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">s</mml:mi><mml:mi mathvariant="normal">e</mml:mi><mml:mi mathvariant="normal">n</mml:mi><mml:mi mathvariant="normal">s</mml:mi></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> that ensures high estimated sensitivity <inline-formula><mml:math id="inf216"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>s</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo>=</mml:mo><mml:mn>90</mml:mn><mml:mi mathvariant="normal">%</mml:mi></mml:mstyle></mml:math></inline-formula> (Methods and <xref ref-type="fig" rid="fig3">Figure 3E</xref>). When lineages are easily separable (e.g. for sufficiently large prevalence <inline-formula><mml:math id="inf217"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>ρ</mml:mi></mml:mstyle></mml:math></inline-formula> and CDR3 length <inline-formula><mml:math id="inf218"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula>), these two partitions coincide, and we do not need to compute <inline-formula><mml:math id="inf219"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>y</mml:mi></mml:mstyle></mml:math></inline-formula> at all. When they do not coincide, we can use the phylogenetic signal <inline-formula><mml:math id="inf220"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>y</mml:mi></mml:mstyle></mml:math></inline-formula> to refine the coarse high-sensitivity partition. We only need to compute <inline-formula><mml:math id="inf221"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>y</mml:mi></mml:mstyle></mml:math></inline-formula> for pairs that belong to the same coarse cluster, but not to the same fine cluster: the phylogenetic signal <inline-formula><mml:math id="inf222"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>y</mml:mi></mml:mstyle></mml:math></inline-formula> is used to merge the fine-partition clusters into clonal families (Methods and <xref ref-type="fig" rid="fig3s1">Figure 3—figure supplement 1</xref>). This allows us to considerably reduce the number of pairwise comparisons that we need to make between the templated regions of the sequences.</p><p>Using <inline-formula><mml:math id="inf223"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>x</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf224"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>y</mml:mi></mml:mstyle></mml:math></inline-formula>, we classify pairs of sequences as positive (i.e. belonging to the same family) if <inline-formula><mml:math id="inf225"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>y</mml:mi><mml:mo>≥</mml:mo><mml:msup><mml:mi>x</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup><mml:mo>−</mml:mo><mml:msup><mml:mi>t</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula>, and as negative otherwise. We can compute the expected sensitivity on the synthetic data, and find that it reaches values ≥90% across the whole range of prevalence <inline-formula><mml:math id="inf226"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>ρ</mml:mi></mml:mstyle></mml:math></inline-formula> and CDR3 lengths <inline-formula><mml:math id="inf227"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula>, outperforming HILARy-CDR3 in the low-<inline-formula><mml:math id="inf228"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>ρ</mml:mi></mml:mstyle></mml:math></inline-formula>, low-<inline-formula><mml:math id="inf229"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula> region (<xref ref-type="fig" rid="fig3">Figure 3F and G</xref>). This proves that using the phylogenetic signal significantly improves performance over HILARy-CDR3.</p><p>The procedure outlined above, which we call HILARy-full, may be summarized as follows: (1) group sequences by <inline-formula><mml:math id="inf230"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class; (2) apply HILARy-CDR3 twice, once with the high-precision threshold as before to get a fine partition, and once with a high-sensitivity threshold to get a coarse partition, thus obtaining two nested partitions; (3) compute <inline-formula><mml:math id="inf231"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>x</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf232"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>y</mml:mi></mml:mstyle></mml:math></inline-formula> using <xref ref-type="disp-formula" rid="equ4">Equation 4</xref> only for pairs that belong to the same coarse cluster but to different fine clusters; (4) merge all fine clusters with at least one pair with <inline-formula><mml:math id="inf233"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>y</mml:mi><mml:mo>≥</mml:mo><mml:msup><mml:mi>x</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup><mml:mo>−</mml:mo><mml:msup><mml:mi>t</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula>.</p></sec><sec id="s2-5"><title>Benchmark of the methods on heavy-chain datasets</title><p>We compare our approach to state-of-the-art methods. In addition to our two algorithms—HILARy-CDR3 and HILARy-full—our benchmark includes the alignment-free method of <xref ref-type="bibr" rid="bib21">Lindenbaum et al., 2021</xref>, partis (<xref ref-type="bibr" rid="bib33">Ralph and Matsen, 2016</xref>), and the spectral clustering method of SCOPer (<xref ref-type="bibr" rid="bib30">Nouri and Kleinstein, 2018</xref>). The SCOPer method using V and J gene mutations (<xref ref-type="bibr" rid="bib31">Nouri and Kleinstein, 2020</xref>) was also tested, but gave worse results (<xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1</xref>). Details about the used versions and parameters are referenced in the data availability section. We tested all algorithms on two synthetic datasets: a dataset simulated by the partis package and used in <xref ref-type="bibr" rid="bib34">Ralph and Matsen, 2022</xref>, to benchmark partis against increasing levels of somatic hypermutations, and the synthetic data described above. That dataset is more realistic in the sense that it represents well the statistics of mutation patterns and, perhaps more importantly, the long-tail distribution of clone sizes observed in the data, with its large impact on the diversity of prevalences, which play an important role in the inference. The partis dataset is generated from a population genetics model. It provides a more independent test since it is not based on data used to develop the method and allows to study performance across different mutation rates.</p><p>First, we measure the inference time of each algorithm on our synthetic dataset. We find that the inference time is primarily affected by the size of the largest <inline-formula><mml:math id="inf234"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>V</mml:mi><mml:mi>J</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class. Therefore, we measure the inference time using the largest class found in donor 326651 of <xref ref-type="bibr" rid="bib6">Briney et al., 2019</xref>, with the size of <inline-formula><mml:math id="inf235"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>N</mml:mi><mml:mo>=</mml:mo><mml:mn>1.2</mml:mn><mml:mo>×</mml:mo><mml:msup><mml:mn>10</mml:mn><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>5</mml:mn></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula> unique sequences. We then apply the methods to a series of subsamples of this class to get the computational time as a function of the subsample size (<xref ref-type="fig" rid="fig4">Figure 4A</xref>). We only allowed for runtimes below 1 hr. We find that only three methods achieve satisfactory performance (under an hour): the two methods introduced here, and the alignment-free method. The other two methods, SCOPer and partis, are limited to <inline-formula><mml:math id="inf236"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> classes of small size (<inline-formula><mml:math id="inf237"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo>&lt;</mml:mo><mml:msup><mml:mn>10</mml:mn><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>4</mml:mn></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf238"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo>&lt;</mml:mo><mml:msup><mml:mn>10</mml:mn><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>3</mml:mn></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula>, respectively).</p><fig-group><fig id="fig4" position="float"><label>Figure 4.</label><caption><title>Benchmark of the alternative methods on synthetic heavy-chain repertoires.</title><p>(<bold>A</bold>) Comparison of inference time using subsamples from the largest <inline-formula><mml:math id="inf239"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class found in donor 326651 from <xref ref-type="bibr" rid="bib6">Briney et al., 2019</xref>. Comparisons were done on a computer with 14 double-threaded 2.60 GHz CPUs (28 threads in total) and 62.7 Gb of RAM. (<bold>B</bold>) Clustering precision <inline-formula><mml:math id="inf240"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>π</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mtext>post</mml:mtext></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> (post single-linkage clustering of positive pairs), (<bold>C</bold>) sensitivity <inline-formula><mml:math id="inf241"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>s</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mtext>post</mml:mtext></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula>, and (<bold>D</bold>) variation of information <inline-formula><mml:math id="inf242"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>v</mml:mi></mml:mstyle></mml:math></inline-formula> as a function of complementarity determining region 3 (CDR3) length <inline-formula><mml:math id="inf243"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula> in the realistic synthetic dataset generated for this study. Solid lines represent the mean value averaged over five synthetic datasets. (<bold>E–G</bold>) Same as (<bold>B–D</bold>) but for the synthetic dataset from <xref ref-type="bibr" rid="bib34">Ralph and Matsen, 2022</xref>, designed for the development and testing of the partis software. The solid lines represent the mean over the three datasets.</p></caption><graphic mimetype="image" mime-subtype="tiff" xlink:href="elife-86181-fig4-v2.tif"/></fig><fig id="fig4s1" position="float" specific-use="child-fig"><label>Figure 4—figure supplement 1.</label><caption><title>Performance of spectral SCOPer using V gene mutations.</title><p>(<bold>A</bold>) Comparison of inference time using subsamples from the largest <inline-formula><mml:math id="inf244"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class found in donor 326651 from <xref ref-type="bibr" rid="bib6">Briney et al., 2019</xref>. Comparisons were done on a computer with 14 double-threaded 2.60GHz CPUs (28 threads in total) and 62.7Gb of RAM. (<bold>B</bold>) Clustering precision <inline-formula><mml:math id="inf245"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>π</mml:mi><mml:mrow><mml:mtext>post</mml:mtext></mml:mrow></mml:msub></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula> (post single linkage clustering of positive pairs), (<bold>C</bold>) Sensitivity <inline-formula><mml:math id="inf246"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>s</mml:mi><mml:mrow><mml:mtext>post</mml:mtext></mml:mrow></mml:msub></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula>, and (<bold>D</bold>) variation of information υ vs CDR3 length <inline-formula><mml:math id="inf247"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> in the realistic synthetic dataset generated for this study. Solid lines represent the mean value averaged over 5 synthetic datasets.</p></caption><graphic mimetype="image" mime-subtype="tiff" xlink:href="elife-86181-fig4-figsupp1-v2.tif"/></fig><fig id="fig4s2" position="float" specific-use="child-fig"><label>Figure 4—figure supplement 2.</label><caption><title>Performance of single-linkage clustering with fixed threshold.</title><p>We call this method VJCDR3-sim, where sim is the threshold on the normalized similarity between two CDR3s, equal to <inline-formula><mml:math id="inf248"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:mi>x</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula>, where <inline-formula><mml:math id="inf249"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>x</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> is our normalized Hamming distance. (<bold>A</bold>) Clustering precision <inline-formula><mml:math id="inf250"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>π</mml:mi><mml:mrow><mml:mtext>post</mml:mtext></mml:mrow></mml:msub></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula> (post single linkage clustering of positive pairs), (<bold>B</bold>) sensitivity <inline-formula><mml:math id="inf251"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>s</mml:mi><mml:mrow><mml:mtext>post</mml:mtext></mml:mrow></mml:msub></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula>, and (<bold>C</bold>) variation of information υ as a function of CDR3 length <inline-formula><mml:math id="inf252"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> in the realistic synthetic dataset generated for this study. Solid lines represent the mean value averaged over 5 synthetic datasets. (<bold>D-F</bold>): Same than (<bold>A-C</bold>) using the synthetic data from <xref ref-type="bibr" rid="bib34">Ralph and Matsen, 2022</xref> and across mutation rates.</p></caption><graphic mimetype="image" mime-subtype="tiff" xlink:href="elife-86181-fig4-figsupp2-v2.tif"/></fig></fig-group><p>To compare the five algorithms in finite time, we test the accuracy of the methods using synthetic datasets with different CDR3 lengths, and with fixed mutation rate of 10% for the partis dataset (the mutation rate is not adjustable in our synthetic dataset as it mimics that of the data). We focus on short CDR3s, <inline-formula><mml:math id="inf253"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi><mml:mo>∈</mml:mo><mml:mo stretchy="false">[</mml:mo><mml:mn>15</mml:mn><mml:mo>,</mml:mo><mml:mn>45</mml:mn><mml:mo stretchy="false">]</mml:mo></mml:mstyle></mml:math></inline-formula>, which are the most challenging for lineage inference. Clonal families with longer CDR3s are easy to reconstruct, and simple methods such as single-linkage clustering with a threshold on mutational distance already work very well (<xref ref-type="fig" rid="fig4s2">Figure 4—figure supplement 2A–C</xref>). Each dataset contains 10<sup>4</sup> unique sequences, so that the dominant <inline-formula><mml:math id="inf254"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class is typically of size ∼10<sup>3</sup> and can be handled by all five algorithms. We measure performance using three metrics applied to the resulting partition: pairwise sensitivity <inline-formula><mml:math id="inf255"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>s</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mtext>post</mml:mtext></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> (<xref ref-type="fig" rid="fig4">Figure 4B and E</xref>), pairwise precision <inline-formula><mml:math id="inf256"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>π</mml:mi><mml:mrow><mml:mtext>post</mml:mtext></mml:mrow></mml:msub></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula> (<xref ref-type="fig" rid="fig4">Figure 4C and F</xref>), and the variation of information <inline-formula><mml:math id="inf257"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>v</mml:mi></mml:mstyle></mml:math></inline-formula> (<xref ref-type="fig" rid="fig4">Figure 4D and G</xref>). Performance measures as a function of mutation rate in the partis dataset are presented in <xref ref-type="fig" rid="fig5">Figure 5</xref>. Pairwise sensitivity <inline-formula><mml:math id="inf258"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>s</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mtext>post</mml:mtext></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> and precision <inline-formula><mml:math id="inf259"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>π</mml:mi><mml:mrow><mml:mtext>post</mml:mtext></mml:mrow></mml:msub></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula> are a posteriori analogs of the a priori estimates defined before in <xref ref-type="disp-formula" rid="equ1 equ3">Equations 1 and 3</xref>, now computed after propagating links through the transitivity rule of single-linkage clustering. Their value reflects not only the accuracy of the adaptive threshold but is also affected by the propagation of errors in single-flinkage clustering. Variation of information is a global metric of clustering performance which measures the loss of information from the true partition to the inferred one, and is equal to zero for perfect inference and positive otherwise (Methods).</p><fig id="fig5" position="float"><label>Figure 5.</label><caption><title>Performance of HILARy as a function of mutation rate for heavy chains, on synthetic data from <xref ref-type="bibr" rid="bib34">Ralph and Matsen, 2022</xref>, designed for the development and testing of the partis software.</title><p>(<bold>A</bold>) Clustering precision <inline-formula><mml:math id="inf260"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>π</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mtext>post</mml:mtext></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> (post single-linkage clustering of positive pairs), (<bold>B</bold>) sensitivity <inline-formula><mml:math id="inf261"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>s</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mtext>post</mml:mtext></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula>, and (<bold>C</bold>) variation of information <inline-formula><mml:math id="inf262"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>v</mml:mi></mml:mstyle></mml:math></inline-formula> as a function of mutation rate, using the heavy chain only. Solid lines represent the mean value averaged over the three datasets.</p></caption><graphic mimetype="image" mime-subtype="tiff" xlink:href="elife-86181-fig5-v2.tif"/></fig><p>Out of the five tested methods, only HILARy-full achieved both high sensitivity and high precision across all CDR3 lengths and for both synthetic datasets. HILARy-full is the only method reaching both high precision and sensitivity for CDR3s shorter than or equal to 30 nucleotides (<xref ref-type="fig" rid="fig4">Figure 4B</xref>), which corresponds to ∼10% of a typical repertoire of productive IgGs (Figure 7A, inset).</p><p>The HILARy-CDR3 method achieves high precision everywhere by construction, but only reached good sensitivity for CDR3 lengths 24 and above. The alignment-free method also achieves high precision everywhere, but with low sensitivity, meaning that it erroneously breaks up clonal families into smaller subsets. These three methods achieve good precision, thanks to the use of a null model for the negative pairs. On the contrary, SCOPer has excellent sensitivity everywhere but only achieves high precision for large lengths (<inline-formula><mml:math id="inf263"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi><mml:mo>&gt;</mml:mo><mml:mn>30</mml:mn></mml:mstyle></mml:math></inline-formula>), suggesting that it erroneously merges short-CDR3 clonal families. Likewise, partis has high sensitivity but loses precision for short CDR3 on our realistic dataset, meaning that many clonal families are erroneously merged again. Note that our definition of precision and sensitivity differs from those used in <xref ref-type="bibr" rid="bib34">Ralph and Matsen, 2022</xref>, which explains the differences between the performance measures reported here and in <xref ref-type="bibr" rid="bib34">Ralph and Matsen, 2022</xref>. On the synthetic datasets from <xref ref-type="bibr" rid="bib34">Ralph and Matsen, 2022</xref>, HILARy-full is the only method achieving high precision and sensitivity across mutation rates (<xref ref-type="fig" rid="fig5">Figure 5</xref>).</p><p>The variation of information offers a useful summary of the performance (<xref ref-type="fig" rid="fig4">Figure 4D and G</xref> and <xref ref-type="fig" rid="fig5">Figure 5C</xref>). According to that measure, only HILARy-full performs well across CDR3 lengths, mutation rates, and datasets. In particular, HILARy presents a clear advantage for challenging regions of the parameter space, such as CDR3 lengths below 30 nucleotides, and mutation rates of 20% and more.</p><p>For a typical repertoire, performance can be summarized into a global score by averaging over all CDR3 lengths in proportion of their abundance (assuming inference is perfect for CDR3 lengths larger than 45 regardless of the method). In this task, HILARy-full achieved 99.9% precision and 98.5% sensitivity; partis 93% and 96.9%; and SCOPer 96.6% and 99.1%. These scores are high because only a minority of lineages are difficult to infer. Nonetheless, HILARy-full provides a substantial gain in precision, while SCOPer presents a slight advantage in sensitivity.</p><p>We conclude that HILARy-CDR3 should be chosen for its consistently high sensitivity, specificity, and speed. In the case of the largest datasets, the faster HILARy-CDR3 is a useful alternative for long enough CDR3s in realistic repertoires.</p></sec><sec id="s2-6"><title>Extension to heavy- and light-chain paired data</title><p>We added an extension of HILARy to infer lineages from paired-chain repertoires, i.e., with paired light- and heavy-chain sequences. To extend HILARy-CDR3, we generalize the <inline-formula><mml:math id="inf264"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class to a  <inline-formula><mml:math id="inf265"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>V</mml:mi><mml:mi>H</mml:mi></mml:msub><mml:mspace width="thinmathspace"/><mml:msub><mml:mi>J</mml:mi><mml:mi>H</mml:mi></mml:msub><mml:mspace width="thinmathspace"/><mml:msub><mml:mi>V</mml:mi><mml:mi>L</mml:mi></mml:msub><mml:mspace width="thinmathspace"/><mml:msub><mml:mi>J</mml:mi><mml:mi>L</mml:mi></mml:msub><mml:mspace width="thinmathspace"/><mml:msub><mml:mi>l</mml:mi><mml:mrow><mml:mi>H</mml:mi><mml:mo>+</mml:mo><mml:mi>L</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mstyle></mml:math></inline-formula> class, using the V and J genes from both the heavy and light chains, and the sum of their CDR3 lengths <inline-formula><mml:math id="inf266"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>l</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>H</mml:mi><mml:mo>+</mml:mo><mml:mi>L</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mi>l</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>H</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mi>l</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>L</mml:mi></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula>. We then apply HILARy-CDR3 using the sum of the Hamming distances between the heavy- and light-chain CDR3s, normalized by <inline-formula><mml:math id="inf267"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>l</mml:mi><mml:mrow><mml:mi>H</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>l</mml:mi><mml:mrow><mml:mi>L</mml:mi></mml:mrow></mml:msub></mml:mstyle></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula>, as our new paired-chain <inline-formula><mml:math id="inf268"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>x</mml:mi></mml:mstyle></mml:math></inline-formula>. The null distribution used is computed with soNNia using a default generation model for paired heavy and light chains. We incorporate the phylogenetic signal of both chains by concatenating their respective template genes, to obtain the total mutation counts <inline-formula><mml:math id="inf269"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mi>H</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>0</mml:mn><mml:mo>,</mml:mo><mml:mi>L</mml:mi></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula>, and using <inline-formula><mml:math id="inf270"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>L</mml:mi></mml:mstyle></mml:math></inline-formula> as the sum of the lengths of the <inline-formula><mml:math id="inf271"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mi>V</mml:mi><mml:mi>H</mml:mi></mml:msub></mml:mrow></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf272"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mrow><mml:mi>V</mml:mi></mml:mrow><mml:mrow><mml:mi>L</mml:mi></mml:mrow></mml:msub></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula> genes.</p><p>In <xref ref-type="fig" rid="fig6">Figure 6A–C</xref> we compare our method to SCOPer and partis on the synthetic dataset from <xref ref-type="bibr" rid="bib34">Ralph and Matsen, 2022</xref>, as a function of CDR3 length, as our method for generating synthetic sequences could not be easily extended to add random light chains. Performance comparison as a function of mutation rate is presented in <xref ref-type="fig" rid="fig6">Figure 6D–F</xref>. HILARy performs better than SCOPer and comparably to partis, which was designed and tested against this dataset.</p><fig id="fig6" position="float"><label>Figure 6.</label><caption><title>Benchmark of HILARy with paired light and heavy chains.</title><p>(<bold>A</bold>) Clustering precision <inline-formula><mml:math id="inf273"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>π</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mtext>post</mml:mtext></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> (post single-linkage clustering of positive pairs), (<bold>B</bold>) sensitivity <inline-formula><mml:math id="inf274"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>s</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mtext>post</mml:mtext></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula>, and (<bold>C</bold>) variation of information <inline-formula><mml:math id="inf275"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>v</mml:mi></mml:mstyle></mml:math></inline-formula> as a function of complementarity determining region 3 (CDR3) length <inline-formula><mml:math id="inf276"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula>, on the synthetic datasets from <xref ref-type="bibr" rid="bib34">Ralph and Matsen, 2022</xref>, designed for the development and testing of the partis software. (<bold>D–F</bold>): Same as (<bold>A–C</bold>) but as a function of mutation rate.</p></caption><graphic mimetype="image" mime-subtype="tiff" xlink:href="elife-86181-fig6-v2.tif"/></fig></sec><sec id="s2-7"><title>Inference of clonal families in a healthy repertoire</title><p>We next use our method to infer the clonal families of the heavy-chain IgG repertoires of healthy donors from <xref ref-type="bibr" rid="bib6">Briney et al., 2019</xref>. <xref ref-type="fig" rid="fig7">Figure 7</xref> summarizes key properties of the inferred clonal families of donor 326651. We take advantage of the consistency of our method across CDR3 lengths, as evidenced by the benchmark, to study how the lineage structure changes with the CDR3 length. To this end, we divide the dataset into nine quantiles, each containing ∼10% of the total number of sequences (<xref ref-type="fig" rid="fig7">Figure 7A</xref>, inset).</p><fig id="fig7" position="float"><label>Figure 7.</label><caption><title>Inference results across complementarity determining region 3 (CDR3) lengths.</title><p>Inference results for donor 326651 of <xref ref-type="bibr" rid="bib6">Briney et al., 2019</xref>, are presented for nine quantiles of the CDR3 distribution, each containing between 8% and 12% of the total number of sequences (corresponding to nine colors in the inset of A). (<bold>A</bold>) Distributions of family size <inline-formula><mml:math id="inf277"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>z</mml:mi></mml:mstyle></mml:math></inline-formula>. All CDR3 length quantiles exhibit universal power-law scaling with exponent −2.3. (<bold>B</bold>) Site frequency spectra estimated for families of sizes <inline-formula><mml:math id="inf278"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>z</mml:mi><mml:mo>=</mml:mo><mml:mn>100</mml:mn></mml:mstyle></mml:math></inline-formula>. Families of larger sizes were subsampled to <inline-formula><mml:math id="inf279"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>z</mml:mi><mml:mo>=</mml:mo><mml:mn>100</mml:mn></mml:mstyle></mml:math></inline-formula> to subtract the influence of varying family sizes. (<bold>C</bold>) Distribution of lineage <inline-formula><mml:math id="inf280"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>d</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>N</mml:mi></mml:mrow></mml:msub><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>/</mml:mo></mml:mrow><mml:msub><mml:mi>d</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>S</mml:mi></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> ratios computed for polymorphisms in CDR3 regions over all lineages within each nine quantile.</p></caption><graphic mimetype="image" mime-subtype="tiff" xlink:href="elife-86181-fig7-v2.tif"/></fig><p>We find that across the nine subsets of the data, the statistics of the lineage structure inferred with the mutations-based method are largely universal. The distribution of the clonal family sizes <inline-formula><mml:math id="inf281"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>z</mml:mi></mml:mstyle></mml:math></inline-formula> (<xref ref-type="fig" rid="fig7">Figure 7A</xref>) follows a power law across all CDR3 lengths under study, with no significant differences between different lengths. This results generalizes an earlier observation used above for generating synthetic datasets, but which was restricted to high-<inline-formula><mml:math id="inf282"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>ρ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:math></inline-formula>, high-<inline-formula><mml:math id="inf283"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula> <inline-formula><mml:math id="inf284"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> classes, and justifies a posteriori the use of a universal power law in the generative model.</p><p>For the largest families, of size <inline-formula><mml:math id="inf285"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>z</mml:mi><mml:mo>≥</mml:mo><mml:mn>100</mml:mn></mml:mstyle></mml:math></inline-formula>, we compute two intra-lineage summary statistics: the site frequency spectrum, which gives the distribution of frequencies of point mutations within lineages, and the distribution of <inline-formula><mml:math id="inf286"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>d</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>N</mml:mi></mml:mrow></mml:msub><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>/</mml:mo></mml:mrow><mml:msub><mml:mi>d</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>S</mml:mi></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> ratios between non-synonymous and synonymous CDR3 polymorphisms within clonal families (estimated by counting). To avoid the bias of the varying family sizes, we subsampled all families to size <inline-formula><mml:math id="inf287"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>z</mml:mi><mml:mo>=</mml:mo><mml:mn>100</mml:mn></mml:mstyle></mml:math></inline-formula>.</p><p>Under models of neutral evolution with fixed population size, the distribution of point-mutation frequencies <inline-formula><mml:math id="inf288"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>ν</mml:mi></mml:mstyle></mml:math></inline-formula> goes as <inline-formula><mml:math id="inf289"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>ν</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula>. Here, we observe a non-neutral profile of the spectrum, with an upturn at large allele frequencies <inline-formula><mml:math id="inf290"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>ν</mml:mi><mml:mo>&gt;</mml:mo><mml:mn>0.5</mml:mn></mml:mstyle></mml:math></inline-formula> (<xref ref-type="fig" rid="fig7">Figure 7B</xref>). It is a known signature of selection or of rapid clonal expansion (<xref ref-type="bibr" rid="bib15">Horns et al., 2019</xref>; <xref ref-type="bibr" rid="bib32">Nourmohammad et al., 2019</xref>). We find that site frequency spectra are universal for all CDR3 lengths, suggesting that the dynamics that give rise to the structure of lineages and the subsequent dynamics that influence the sampling of family members do not depend on the CDR3 length.</p><p>The lineage <inline-formula><mml:math id="inf291"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>d</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>N</mml:mi></mml:mrow></mml:msub><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>/</mml:mo></mml:mrow><mml:msub><mml:mi>d</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>S</mml:mi></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> ratio is also largely consistent across CDR3 lengths (<xref ref-type="fig" rid="fig7">Figure 7C</xref>), while spanning two orders of magnitude, suggesting a wide gamut of selection forces. We could have expected longer loops to be under stronger purifying selection (lower <inline-formula><mml:math id="inf292"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>d</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>N</mml:mi></mml:mrow></mml:msub><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>/</mml:mo></mml:mrow><mml:msub><mml:mi>d</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>S</mml:mi></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula>) to maintain their specificity and folding. Instead, we observe that short CDR3s have more lineages with low <inline-formula><mml:math id="inf293"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>d</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>N</mml:mi></mml:mrow></mml:msub><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>/</mml:mo></mml:mrow><mml:msub><mml:mi>d</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>S</mml:mi></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula>. This may be due to different sequence context and codon composition in short versus long CDR3s. Short junctions are largely templated, whereas long junctions have long, non-templated insertions, and it was shown that templated regions have evolved their codons to minimize the possibility of non-synonymous mutations (<xref ref-type="bibr" rid="bib36">Saini and Hershberg, 2015</xref>), which would lead to a lower <inline-formula><mml:math id="inf294"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>d</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>N</mml:mi></mml:mrow></mml:msub><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>/</mml:mo></mml:mrow><mml:msub><mml:mi>d</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>S</mml:mi></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula>, regardless of selection.</p></sec></sec><sec id="s3" sec-type="discussion"><title>Discussion</title><p>Clonal families are the building blocks of memory repertoire shaped by VDJ recombination and subsequent somatic hypermutations and selection. Repertoire sequencing datasets enable new approaches to understand these processes. They allow us to model the different sources of diversity and measure the selection pressures involved. To take full advantage of this opportunity, we need to reliably identify independent lineages.</p><p>Here, we introduced a general framework for studying the methods for partitioning high-throughput sequencing of BCR repertoire datasets into clonal families. We have identified the main factors that influence the difficulty of this inference task: low clonality levels and short recombination junctions. We quantified the clonality level using the definition of pairwise prevalence <inline-formula><mml:math id="inf295"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>ρ</mml:mi></mml:mstyle></mml:math></inline-formula> and introduced a method to estimate it a priori, without knowing the partition. We found the prevalence levels across <inline-formula><mml:math id="inf296"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>V</mml:mi><mml:mi>J</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> classes to span three orders of magnitude (<xref ref-type="fig" rid="fig2">Figure 2B</xref>), unraveling the varying degree of complexity.</p><p>We leveraged the soNNia model of VDJ recombination to quantify the CDR3 diversity and constructed a null expectation for the divergence of independent recombination products. This null model enabled the design of a CDR3-based clustering method with an adaptive threshold, HILARy-CDR3, that allows us to keep the precision of inference high across prevalences and CDR3 lengths. Owing to the prefix tree representation of the CDR3 sequences, this method is characterized by very short inference times, thanks to avoiding all pairwise comparisons in single-linkage clustering. As expected, we found that the adaptive threshold choice limits the sensitivity of inference in the regime of short junctions and low prevalence (<xref ref-type="fig" rid="fig3">Figure 3F</xref>, below the black line).</p><p>To remedy the limitations of the CDR3-based approach, we developed a mutation-based method (HILARy-full). We found that including the phylogenetic signal of shared mutations in highly mutated sequences allows us to properly classify them into lineages despite significant CDR3 divergence. We studied the performance of the method using synthetic data and found significant improvement with respect to HILARy-CDR3: we extended the range of high-precision and high-sensitivity performance to cover all values of prevalence and CDR3 lengths observed in productive data (<xref ref-type="fig" rid="fig3">Figure 3G</xref>).</p><p>We have compared the two methods developed here with state-of-the-art approaches: the partis (<xref ref-type="bibr" rid="bib33">Ralph and Matsen, 2016</xref>) and SCOPer (<xref ref-type="bibr" rid="bib30">Nouri and Kleinstein, 2018</xref>) algorithms, and the alignment-free method (<xref ref-type="bibr" rid="bib21">Lindenbaum et al., 2021</xref>). Compared to these methods, HILARy relies on a probabilistic model of VDJ recombination and selection, which allows it to explicitly control for precision. This is not possible in partis, which relies on likelihood ratio test to merge candidate clusters together to form families. SCOPer also chooses a clustering threshold based on the pairwise distribution of distances, but without a null model. Another innovation of HILARy-full is to use a null expectation for the number of shared mutations. This feature makes the method robust to varying levels of mutation rates across sequences. HILARy achieves optimal efficiency by combining CDR3-based and mutation-based information. Typically, a large part of the dataset doesn’t require the use of the full method, allowing for greatly reduced inference times. HILARy relies on the soNNia model, which is based on a neural network, and benefits from its expressivity to quantify the purifying selection that modifies the VDJ recombination statistics. We found the performance of this model satisfactory when applied to healthy memory repertoires, in agreement with previous findings (<xref ref-type="bibr" rid="bib17">Isacchini et al., 2021</xref>; <xref ref-type="bibr" rid="bib35">Ruiz Ortega et al., 2023</xref>). For subsets of the repertoire with less challenging characteristics, such as low mutation rates, long CDR3s, or high pairwise prevalence <inline-formula><mml:math id="inf297"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>ρ</mml:mi></mml:mstyle></mml:math></inline-formula>, simpler methods can effectively reconstruct clonal families with high precision and sensitivity. As demonstrated in <xref ref-type="bibr" rid="bib3">Balashova et al., 2024</xref>, single-linkage clustering outperforms state-of-the-art approaches for simulated samples based on real datasets with mutation rates ranging between 1.3% and 5.5%. As part of our clonal inference package, we provide our own implementation of single-linkage clustering based on mutational distance, which leverages a prefix tree representation method to speed up inference. We found this approach to be comparable to HILARy for long CDRs and low mutation rates (<xref ref-type="fig" rid="fig4s2">Figure 4—figure supplement 2</xref>).</p><p>Purifying selection is expected to be more pronounced in datasets of disease-specific cohorts and a default soNNia model may overestimate the diversity (<xref ref-type="bibr" rid="bib24">Mayer and Callan, 2022</xref>) and lead to underestimation of the fallout rate. The inference framework introduced here could still be applied with more sophisticated models of selection, and take advantage of higher levels of clonality that characterize many disease-specific datasets (<xref ref-type="bibr" rid="bib29">Nielsen et al., 2020</xref>; <xref ref-type="bibr" rid="bib41">Turner et al., 2020</xref>).</p><p>We applied the mutations-based method to infer lineages in a repertoire of a healthy donor, sequenced at great depth (<xref ref-type="bibr" rid="bib6">Briney et al., 2019</xref>). We took advantage of the consistency our method exhibits across CDR3 lengths to find that the statistics of lineages, including a heavy-tail distribution of family sizes as well as signatures of selection, are universal and independent of the CDR3 length. This result implies that the dynamics of expansion, mutation, and selection are independent of the CDR3 and suggests they are dictated by the rules of affinity maturation and memory formation rather than BCR specificity. It advocates for the use of RNA sequencing data to quantify these general principles (<xref ref-type="bibr" rid="bib24">Mayer and Callan, 2022</xref>; <xref ref-type="bibr" rid="bib14">Hoehn et al., 2019</xref>). Identifying clonal families with high accuracy is paramount in such approaches as it avoids the potential biases of different family sizes and varying levels of clonality.</p><p>The algorithm for clonal family identification presented here is a robust inference method that enables a reliable partition of a memory B-cell repertoire into independent lineages. Using synthetic datasets we demonstrated it is distinguished by consistently high precision and high sensitivity across different junction lengths and levels of clonality, while very fast compared to previous methods. It is therefore a useful tool to explore the diversity of the repertoires and improves our ability to interpret repertoire sequencing datasets.</p></sec><sec id="s4" sec-type="methods"><title>Methods</title><sec id="s4-1"><title>Data preprocessing and alignment</title><p>We focus the analysis high-throughput RNA sequencing data of IgH-coding genes (<xref ref-type="bibr" rid="bib6">Briney et al., 2019</xref>). The sequences were barcoded with unique molecular identifiers (UMIs) to correct for the PCR amplification bias and correct sequencing errors. We aligned raw sequences using presto of the Immcantation pipeline (<xref ref-type="bibr" rid="bib43">Vander Heiden et al., 2014</xref>) with tools allowing for correcting errors in UMIs and deal with insufficient UMI diversity. Reads were filtered for quality and paired using default presto parameters. We selected only sequences aligned with the IgG primer and therefore the lineage analysis is limited to the IgG subset of the repertoire. Preprocessed data was then aligned to V, D, and J templates from IMGT (<xref ref-type="bibr" rid="bib13">Giudicelli et al., 2006</xref>) database using IgBlast (<xref ref-type="bibr" rid="bib47">Ye et al., 2013</xref>). After processing, all UMI count information is discarded and only unique nucleotide sequences are kept for further analysis.</p><p>Pairs of sequences stemming from the same VDJ recombination are expected to have the same CDR3 length <inline-formula><mml:math id="inf298"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula> and align to the same V and J templates. An exception could be caused by a insertion or deletion within the CDR3 that would alter its length as a result of the somatic hypermutation process. Such indel events are rare and generally selected against (<xref ref-type="bibr" rid="bib22">Lupo et al., 2022</xref>), therefore in what follows we shall assume the effect of these events is negligible. The inference could also be affected by the misalignment of either V or J templates but we previously found the effect of alignment errors to be insignificant for identifying VJ classes (<xref ref-type="bibr" rid="bib39">Spisak et al., 2020</xref>) (the alignment of the D template is error-prone and unreliable, hence not used in the inference procedure). Importantly, the two simplifications described here would result in decreased sensitivity of inference but are not expected to affect its precision.</p></sec><sec id="s4-2"><title>Modeling junctional diversity</title><p>The extraordinary diversity of VDJ rearrangements can be efficiently described and quantified using probabilistic models of the recombination process as well as subsequent purifying selection. Sequence-based models can assign to each receptor sequence <inline-formula><mml:math id="inf299"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>s</mml:mi></mml:mstyle></mml:math></inline-formula>, its total probability of generation, <inline-formula><mml:math id="inf300"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mtext>gen</mml:mtext></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>s</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula> (<xref ref-type="bibr" rid="bib27">Murugan et al., 2012</xref>; <xref ref-type="bibr" rid="bib11">Elhanati et al., 2015</xref>; <xref ref-type="bibr" rid="bib23">Marcou et al., 2018</xref>) as well as a selection factor <inline-formula><mml:math id="inf301"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>Q</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>s</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula>, inferred so as to match frequencies <inline-formula><mml:math id="inf302"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mtext>data</mml:mtext></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>s</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula> of the sequences with a model-based distribution (<xref ref-type="bibr" rid="bib10">Elhanati et al., 2014</xref>; <xref ref-type="bibr" rid="bib38">Sethna et al., 2020</xref>; <xref ref-type="bibr" rid="bib17">Isacchini et al., 2021</xref>)<disp-formula id="equ5"> <label>(5)</label><mml:math id="m5"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi mathvariant="normal">P</mml:mi><mml:mrow><mml:mi mathvariant="normal">p</mml:mi><mml:mi mathvariant="normal">o</mml:mi><mml:mi mathvariant="normal">s</mml:mi><mml:mi mathvariant="normal">t</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="normal">s</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mi mathvariant="normal">Q</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="normal">s</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:msub><mml:mi mathvariant="normal">P</mml:mi><mml:mrow><mml:mi mathvariant="normal">g</mml:mi><mml:mi mathvariant="normal">e</mml:mi><mml:mi mathvariant="normal">n</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi mathvariant="normal">s</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>.</mml:mo></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p>The <inline-formula><mml:math id="inf303"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mtext>gen</mml:mtext></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> model was inferred using unmutated out-of-frame sequences from <xref ref-type="bibr" rid="bib6">Briney et al., 2019</xref>, using the IGoR software (<xref ref-type="bibr" rid="bib23">Marcou et al., 2018</xref>). The selection function <inline-formula><mml:math id="inf304"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>Q</mml:mi></mml:mstyle></mml:math></inline-formula> model was learned using unmutated productive IgM sequences from <xref ref-type="bibr" rid="bib6">Briney et al., 2019</xref>, using the soNNia software (<xref ref-type="bibr" rid="bib17">Isacchini et al., 2021</xref>).</p><p>The post-selection distribution <inline-formula><mml:math id="inf305"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mtext>post</mml:mtext></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> describes the diversity of the CDR3 regions and in doing so provides an expectation of pairwise distances between unrelated, independently generated sequences of same length <inline-formula><mml:math id="inf306"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula> (<xref ref-type="bibr" rid="bib17">Isacchini et al., 2021</xref>). As the soNNia software does not include somatic hypermutations, the underlying assumption is that additional diversity on the CDR3 caused by hypermutations doesn’t affect the distribution of pairwise distances. This assumption is justified by the quality of the fit. We can define<disp-formula id="equ6"> <label>(6)</label><mml:math id="m6"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi mathvariant="normal">F</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>n</mml:mi><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mi>l</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>⟨</mml:mo><mml:msub><mml:mi>δ</mml:mi><mml:mrow><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mn>2</mml:mn></mml:msub></mml:mrow><mml:mo>|</mml:mo></mml:mrow><mml:mo>,</mml:mo><mml:mspace width="thickmathspace"/><mml:mi>n</mml:mi></mml:mrow></mml:msub><mml:mo>⟩</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mspace width="thinmathspace"/><mml:mo>∼</mml:mo><mml:mrow><mml:msub><mml:mi mathvariant="normal">P</mml:mi><mml:mrow><mml:mi mathvariant="normal">p</mml:mi><mml:mi mathvariant="normal">o</mml:mi><mml:mi mathvariant="normal">s</mml:mi><mml:mi mathvariant="normal">t</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mo>⋅</mml:mo><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mi>l</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:msub><mml:mo>,</mml:mo></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p>where <inline-formula><mml:math id="inf307"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mo>|</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mo>|</mml:mo></mml:mrow></mml:mstyle></mml:math></inline-formula> stands for (Hamming) distance between sequences <inline-formula><mml:math id="inf308"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>s</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf309"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>s</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>2</mml:mn></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula>. This definition of the null distribution is a straightforward recipe for its estimation using (Monte Carlo) samples from <inline-formula><mml:math id="inf310"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mtext>post</mml:mtext></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula>.</p><p>Should <inline-formula><mml:math id="inf311"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mtext>post</mml:mtext></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> differ significantly from the empirical frequencies <inline-formula><mml:math id="inf312"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mtext>data</mml:mtext></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> one can resolve to the following alternative<disp-formula id="equ7"> <label>(7)</label><mml:math id="m7"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msubsup><mml:mi>P</mml:mi><mml:mrow><mml:mi mathvariant="normal">F</mml:mi></mml:mrow><mml:mo>′</mml:mo></mml:msubsup><mml:mo stretchy="false">(</mml:mo><mml:mi>n</mml:mi><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mi>l</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:msub><mml:mrow><mml:mo>⟨</mml:mo><mml:msub><mml:mi>δ</mml:mi><mml:mrow><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mi>s</mml:mi><mml:mn>2</mml:mn></mml:msub></mml:mrow><mml:mo>|</mml:mo></mml:mrow><mml:mo>,</mml:mo><mml:mspace width="thickmathspace"/><mml:mi>n</mml:mi></mml:mrow></mml:msub><mml:mo>⟩</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mi>s</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>∼</mml:mo><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi>p</mml:mi><mml:mi>o</mml:mi><mml:mi>s</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mo>⋅</mml:mo><mml:mo>,</mml:mo><mml:mi>l</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo><mml:mspace width="thinmathspace"/><mml:msub><mml:mi>s</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo>∼</mml:mo><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi>d</mml:mi><mml:mi>a</mml:mi><mml:mi>t</mml:mi><mml:mi>a</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mo>⋅</mml:mo><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mi>l</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:msub><mml:mo>,</mml:mo></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p>the equivalent of the negation distribution as defined in <xref ref-type="bibr" rid="bib21">Lindenbaum et al., 2021</xref>, and used in our evaluation of the alignment-free method (<xref ref-type="bibr" rid="bib21">Lindenbaum et al., 2021</xref>) in the method benchmark analysis.</p></sec><sec id="s4-3"><title>Estimation of pairwise prevalence</title><p>Pairwise prevalence is defined as the ratio of pairs of related sequences to the total number of pairs of sequences in a given set. Related sequences share an ancestor and have diverged by independent somatic mutations, post-recombination. Low prevalence can be a major difficulty for any inference procedure as any misassignment (or fallout) will result in a drastic loss of sensitivity or precision. It is instrumental to have an a priori estimate of pairwise prevalence before the families are identified.</p><p>To estimate the prevalence from the distribution of distances <inline-formula><mml:math id="inf313"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>P</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>n</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula> for a given set of sequences (typically a <inline-formula><mml:math id="inf314"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class or <inline-formula><mml:math id="inf315"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula> class), we propose the following expectation-maximization procedure. We stipulate the distribution in question is a mixture distribution of two components, <inline-formula><mml:math id="inf316"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">F</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>n</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula>, the expectation for unrelated sequences defined as above, and <inline-formula><mml:math id="inf317"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>n</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula>, describing related sequences, modeled using a Poisson distribution<disp-formula id="equ8"> <label>(8)</label><mml:math id="m8"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>n</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>μ</mml:mi><mml:mi>l</mml:mi><mml:msup><mml:mo stretchy="false">)</mml:mo><mml:mi>n</mml:mi></mml:msup></mml:mrow><mml:mrow><mml:mi>n</mml:mi><mml:mo>!</mml:mo></mml:mrow></mml:mfrac><mml:msup><mml:mi>e</mml:mi><mml:mrow><mml:mo>−</mml:mo><mml:mi>μ</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msup><mml:mo>,</mml:mo></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p>where <italic>μ</italic> is the mean divergence per base pair. If a particular CDR3 length <inline-formula><mml:math id="inf318"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula> is represented by unusually large number of <inline-formula><mml:math id="inf319"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> classes, the resultant shape of the positive distribution is often closer to a geometric profile, and is then modeled using <inline-formula><mml:math id="inf320"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>n</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:mi>M</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:msup><mml:mi>M</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>n</mml:mi></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula>, where <inline-formula><mml:math id="inf321"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>M</mml:mi><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mi>μ</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:mfrac></mml:mstyle></mml:math></inline-formula>. In sum<disp-formula id="equ9"> <label>(9)</label><mml:math id="m9"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>P</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>n</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mi>ρ</mml:mi><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>n</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>+</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:mi>ρ</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi mathvariant="normal">F</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>n</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>.</mml:mo></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p>In a standard fashion, we proceed iteratively by calculating the expected value of the log-likelihood (pairs of sequences indexed by <italic>i</italic>)<disp-formula id="equ10"> <label>(10)</label><mml:math id="m10"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>Q</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo>,</mml:mo><mml:mi>μ</mml:mi><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mi>ρ</mml:mi><mml:mi>t</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>μ</mml:mi><mml:mi>t</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:munder><mml:mo>∑</mml:mo><mml:mi>i</mml:mi></mml:munder><mml:msub><mml:mi>P</mml:mi><mml:mi>t</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow><mml:mo stretchy="false">)</mml:mo><mml:mi>log</mml:mi><mml:mo>⁡</mml:mo><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mi>μ</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>+</mml:mo><mml:msub><mml:mi>P</mml:mi><mml:mi>t</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:mrow><mml:mi mathvariant="normal">F</mml:mi></mml:mrow><mml:mo stretchy="false">)</mml:mo><mml:mi>log</mml:mi><mml:mo>⁡</mml:mo><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi mathvariant="normal">F</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p>where the membership probabilities are defined as<disp-formula id="equ11"> <label>(11)</label><mml:math id="m11"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mtable columnalign="right left right left right left right left right left right left" rowspacing="3pt" columnspacing="0em 2em 0em 2em 0em 2em 0em 2em 0em 2em 0em" displaystyle="true"><mml:mtr><mml:mtd><mml:msub><mml:mi>P</mml:mi><mml:mi>t</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mtd><mml:mtd><mml:mi/><mml:mo>=</mml:mo><mml:mi>P</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>μ</mml:mi><mml:mi>t</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>ρ</mml:mi><mml:mi>t</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mtd></mml:mtr></mml:mtable></mml:mstyle></mml:mrow></mml:math></disp-formula><disp-formula id="equ12"><label>(12)</label><mml:math id="m12"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mtable columnalign="right left right left right left right left right left right left" rowspacing="3pt" columnspacing="0em 2em 0em 2em 0em 2em 0em 2em 0em 2em 0em" displaystyle="true"><mml:mtr><mml:mtd/></mml:mtr><mml:mtr><mml:mtd/><mml:mtd><mml:mi/><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>ρ</mml:mi><mml:mi>t</mml:mi></mml:msub><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mi>μ</mml:mi><mml:mi>t</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mi>ρ</mml:mi><mml:mi>t</mml:mi></mml:msub><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mi>μ</mml:mi><mml:mi>t</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>+</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msub><mml:mi>ρ</mml:mi><mml:mi>t</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi mathvariant="normal">F</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>x</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfrac></mml:mtd></mml:mtr></mml:mtable></mml:mstyle></mml:mrow></mml:math></disp-formula><disp-formula id="equ13"><label>(13)</label><mml:math id="m13"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mtable columnalign="right left right left right left right left right left right left" rowspacing="3pt" columnspacing="0em 2em 0em 2em 0em 2em 0em 2em 0em 2em 0em" displaystyle="true"><mml:mtr><mml:mtd><mml:mtext> </mml:mtext><mml:msub><mml:mi>P</mml:mi><mml:mi>t</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:mrow><mml:mi mathvariant="normal">F</mml:mi></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mtd><mml:mtd><mml:mi/><mml:mo>=</mml:mo><mml:mi>P</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:mrow><mml:mi mathvariant="normal">F</mml:mi></mml:mrow><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>μ</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>ρ</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msub><mml:mi>P</mml:mi><mml:mi>t</mml:mi></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow><mml:mo stretchy="false">)</mml:mo><mml:mo>.</mml:mo></mml:mtd></mml:mtr></mml:mtable></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p>We then find the maximum<disp-formula id="equ14"> <label>(14)</label><mml:math id="m14"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>μ</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mo>+</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>ρ</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mo>+</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mtext>argmax</mml:mtext><mml:mspace width="thickmathspace"/><mml:mi>Q</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>ρ</mml:mi><mml:mo>,</mml:mo><mml:mi>μ</mml:mi><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mi>ρ</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>μ</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p>and iterate the expectation and maximization steps until convergence, <inline-formula><mml:math id="inf322"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mo>|</mml:mo><mml:msub><mml:mi>ρ</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>t</mml:mi><mml:mo>+</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mi>ρ</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mo>|</mml:mo></mml:mrow><mml:mo>&lt;</mml:mo><mml:mi>ϵ</mml:mi></mml:mstyle></mml:math></inline-formula>, to obtain <inline-formula><mml:math id="inf323"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>ρ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>ρ</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>t</mml:mi><mml:mo>+</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula>.</p><p>Results for largest <inline-formula><mml:math id="inf324"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> class within each <inline-formula><mml:math id="inf325"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula> class can be found in <xref ref-type="fig" rid="fig2s3">Figure 2—figure supplement 3</xref> and results for <inline-formula><mml:math id="inf326"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula> classes using a geometric distribution can be found in <xref ref-type="fig" rid="fig2s6">Figure 2—figure supplement 6</xref>. Dependence of maximum likelihood prevalence estimates <inline-formula><mml:math id="inf327"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>ρ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:math></inline-formula> on class size <inline-formula><mml:math id="inf328"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>N</mml:mi></mml:mstyle></mml:math></inline-formula> is plotted in <xref ref-type="fig" rid="fig2s7">Figure 2—figure supplement 7</xref>.</p></sec><sec id="s4-4"><title>HILARy-CDR3</title><p>The standard method for CDR3-based inference of lineages proceeds through single-linkage clustering with a fixed threshold on normalized Hamming distance divergence (fraction of differing nucleotides) (<xref ref-type="bibr" rid="bib18">Kepler, 2013</xref>; <xref ref-type="bibr" rid="bib42">Uduman et al., 2014</xref>; <xref ref-type="bibr" rid="bib46">Yaari and Kleinstein, 2015</xref>; <xref ref-type="bibr" rid="bib32">Nourmohammad et al., 2019</xref>). This crude method suffers from inaccuracy as it loses precision in the case of highly mutated sequences and junctions of short length (see <xref ref-type="fig" rid="fig4s2">Figure 4—figure supplement 2</xref>). If junctions are stored in a prefix tree data structure (<xref ref-type="bibr" rid="bib19">Knuth, 2013</xref>) single-linkage clustering can be performed without comparing all pairs and hence is typically orders of magnitude faster than alternatives. The prefix tree is a search tree constructed such that all children of a given node have a common prefix, the root of the tree corresponding to an empty string, and leaves corresponding to unique sequences to be clustered. To find neighbors of a given sequence it suffices to traverse the prefix tree from the corresponding leaf upward and compute the Hamming distance at branchings. This method limits the number of unnecessary comparisons and greatly improves the speed of Hamming distance-based clustering (<xref ref-type="bibr" rid="bib4">Boytsov, 2011</xref>). We implement the prefix tree structure to accommodate CDR3 sequences. Briefly, all the CDR3 sequences of identical length are stored in the leaves of a prefix tree (<xref ref-type="bibr" rid="bib28">Navarro, 2001</xref>; <xref ref-type="bibr" rid="bib4">Boytsov, 2011</xref>), implemented as a quaternary tree where each edge is labeled by a nucleobase (A, T, C, or G). The neighbors of a specific sequence are found by traversing the tree from top to bottom, exploring only the branches that are under a given Hamming distance from the sequence. Clusters are obtained by iterating this procedure and removing all the neighbors from the prefix tree until no sequences remain. The package is coded in C++ with a Python interface and is available independently. The time performance of this method for high-sensitivity and high-specificity partitions is studied as a part of the method benchmark analysis.</p><p>We take advantage of the speed of a prefix tree-based clustering to perform single-linkage clustering. Besides the algorithmic speed-up afforded by the prefix tree, the difference with previous methods is that we use an adaptive threshold. For any dataset, we define two CDR3-based partitions, high-sensitivity and high-precision clustering, corresponding to two choices of threshold.</p><p>The high-precision partition is obtained by setting the threshold <inline-formula><mml:math id="inf329"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>t</mml:mi></mml:mstyle></mml:math></inline-formula> to <inline-formula><mml:math id="inf330"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msubsup><mml:mi>t</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">p</mml:mi><mml:mi mathvariant="normal">r</mml:mi><mml:mi mathvariant="normal">e</mml:mi><mml:mi mathvariant="normal">c</mml:mi></mml:mrow><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msubsup></mml:mstyle></mml:math></inline-formula> as the largest <inline-formula><mml:math id="inf331"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>t</mml:mi></mml:mstyle></mml:math></inline-formula> such <inline-formula><mml:math id="inf332"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>π</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>≤</mml:mo><mml:msup><mml:mi>π</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula>, with <inline-formula><mml:math id="inf333"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>π</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:mn>0.99</mml:mn></mml:mstyle></mml:math></inline-formula> (99% precision), where <inline-formula><mml:math id="inf334"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>π</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula> is given by <xref ref-type="disp-formula" rid="equ1 equ2 equ3">Equation 1–3</xref>. To get the high-sensitivity partition, we set the threshold to <inline-formula><mml:math id="inf335"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msubsup><mml:mi>t</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">s</mml:mi><mml:mi mathvariant="normal">e</mml:mi><mml:mi mathvariant="normal">n</mml:mi><mml:mi mathvariant="normal">s</mml:mi></mml:mrow><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msubsup></mml:mstyle></mml:math></inline-formula>, the smallest <inline-formula><mml:math id="inf336"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>t</mml:mi></mml:mstyle></mml:math></inline-formula> such that <inline-formula><mml:math id="inf337"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>s</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>≥</mml:mo><mml:msup><mml:mi>s</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula>, where <inline-formula><mml:math id="inf338"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>s</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:mn>0.9</mml:mn></mml:mstyle></mml:math></inline-formula> (90% sensitivity), where <inline-formula><mml:math id="inf339"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>s</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:mi>t</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula> is given by <xref ref-type="disp-formula" rid="equ3">Equation 3</xref>.</p><p>We apply these thresholds to the single-linkage clustering described above to generate the precise and sensitive partitions, which are then used by the mutations-based method to find an optimal partition that merges the fine clusters within the coarse clusters (Methods and <xref ref-type="fig" rid="fig3s1">Figure 3—figure supplement 1</xref>). We refer to the high-precision partition from the CDR3 alone as HILARy-CDR3, and the mutation-based method as HILARy-full.</p><p>Finally, the structure of families leads to propagation of errors that lowers the precision with respect to the a priori estimate <inline-formula><mml:math id="inf340"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>π</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:math></inline-formula>. Denoting family size as <inline-formula><mml:math id="inf341"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>z</mml:mi></mml:mstyle></mml:math></inline-formula>, one error accounted for in <inline-formula><mml:math id="inf342"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mover><mml:mrow><mml:mi mathvariant="normal">F</mml:mi><mml:mi mathvariant="normal">P</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula> causes, on average, <inline-formula><mml:math id="inf343"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo fence="false" stretchy="false">⟨</mml:mo><mml:mi>z</mml:mi><mml:msup><mml:mo fence="false" stretchy="false">⟩</mml:mo><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mstyle></mml:math></inline-formula> extra errors by merging two families. If the a priori precision <inline-formula><mml:math id="inf344"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>π</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:math></inline-formula> is high, we can neglect the second order effect of these two families simultaneously affected by other <inline-formula><mml:math id="inf345"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mover><mml:mrow><mml:mi mathvariant="normal">F</mml:mi><mml:mi mathvariant="normal">P</mml:mi></mml:mrow><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:mrow></mml:mstyle></mml:math></inline-formula> pairs. Therefore the expected precision (<xref ref-type="disp-formula" rid="equ1">Equation 1</xref>) of the resulting partition reads<disp-formula id="equ15"> <label>(15)</label><mml:math id="m15"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo fence="false" stretchy="false">⟨</mml:mo><mml:msub><mml:mi>π</mml:mi><mml:mrow><mml:mtext>post</mml:mtext></mml:mrow></mml:msub><mml:mo fence="false" stretchy="false">⟩</mml:mo><mml:mo>≃</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mrow><mml:mn>1</mml:mn><mml:mo>+</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mo fence="false" stretchy="false">⟨</mml:mo><mml:mi>z</mml:mi><mml:msup><mml:mo fence="false" stretchy="false">⟩</mml:mo><mml:mn>2</mml:mn></mml:msup><mml:mo>−</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:mrow><mml:mover><mml:mi>π</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfrac></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p>where we assumed <inline-formula><mml:math id="inf346"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>s</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo>≃</mml:mo><mml:mn>1</mml:mn></mml:mstyle></mml:math></inline-formula>. For <inline-formula><mml:math id="inf347"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>π</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo>=</mml:mo><mml:mn>99</mml:mn><mml:mi mathvariant="normal">%</mml:mi></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf348"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo fence="false" stretchy="false">⟨</mml:mo><mml:mi>z</mml:mi><mml:mo fence="false" stretchy="false">⟩</mml:mo><mml:mo>≃</mml:mo><mml:mn>2</mml:mn></mml:mstyle></mml:math></inline-formula> this formula gives <inline-formula><mml:math id="inf349"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo fence="false" stretchy="false">⟨</mml:mo><mml:msub><mml:mi>π</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mtext>post</mml:mtext></mml:mrow></mml:msub><mml:mo fence="false" stretchy="false">⟩</mml:mo><mml:mo>≃</mml:mo><mml:mn>97</mml:mn><mml:mi mathvariant="normal">%</mml:mi></mml:mstyle></mml:math></inline-formula>.</p></sec><sec id="s4-5"><title>Synthetic data generation</title><p>To generate synthetic data we make use of the statistics of tree topologies of the lineages identified in the high-sensitivity and high-precision regime of CDR3-based inference from the data (yellow region above the black line in <xref ref-type="fig" rid="fig3">Figure 3F</xref>). We denote the set of these lineages by <inline-formula><mml:math id="inf350"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-tex-caligraphic" mathvariant="script">L</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula>. We assume that to good approximation the mutational process and the selection forces that shaped the mutational landscape in these lineages do not depend on the CDR3 length.</p><p>To test the performance of different inference methods across CDR3 lengths, we build synthetic datasets of fixed length.</p><p>In the first step, we choose the number of families <inline-formula><mml:math id="inf351"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>N</mml:mi></mml:mstyle></mml:math></inline-formula>. We then draw <inline-formula><mml:math id="inf352"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>N</mml:mi></mml:mstyle></mml:math></inline-formula> independent family sizes from the family size distribution of the form observed in healthy datasets<disp-formula id="equ16"> <label>(16)</label><mml:math id="m16"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>p</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>z</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mfrac><mml:msup><mml:mi>z</mml:mi><mml:mrow><mml:mo>−</mml:mo><mml:mi>α</mml:mi></mml:mrow></mml:msup><mml:msub><mml:mi>Z</mml:mi><mml:mrow><mml:mi>α</mml:mi></mml:mrow></mml:msub></mml:mfrac><mml:mo>,</mml:mo></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p>where <inline-formula><mml:math id="inf353"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>Z</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>α</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:munder><mml:mo>∑</mml:mo><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>z</mml:mi><mml:mo>≥</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:munder><mml:msup><mml:mi>z</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>−</mml:mo><mml:mi>α</mml:mi></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:mi>ζ</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>α</mml:mi><mml:mo>,</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula>. In the next step, we assign a naive progenitor to each lineage by sampling from the <inline-formula><mml:math id="inf354"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mtext>post</mml:mtext></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> distribution, selecting sequences with a prescribed length <inline-formula><mml:math id="inf355"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>l</mml:mi></mml:mstyle></mml:math></inline-formula> (<xref ref-type="fig" rid="fig2s4">Figure 2—figure supplement 4</xref>). We then choose a lineage in the set of reconstructed lineages <inline-formula><mml:math id="inf356"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-tex-caligraphic" mathvariant="script">L</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> at random among lineages of size <inline-formula><mml:math id="inf357"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>z</mml:mi></mml:mstyle></mml:math></inline-formula> (or, for large sizes, the lineage of the closest size smaller than <inline-formula><mml:math id="inf358"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>z</mml:mi></mml:mstyle></mml:math></inline-formula>). To create a lineage with the same mutation patterns as the real data, we then identify all unique mutations in the lineage from <inline-formula><mml:math id="inf359"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-tex-caligraphic" mathvariant="script">L</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> using standard alignment and tree recontruction methods described in <xref ref-type="bibr" rid="bib39">Spisak et al., 2020</xref>, and for each mutation denote the labels of members of the lineage that carry it. For each mutation, this defines a configuration of labels, one of <inline-formula><mml:math id="inf360"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mn>2</mml:mn><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>z</mml:mi></mml:mrow></mml:msup><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mstyle></mml:math></inline-formula> possible. We subsequently loop through observed configurations and choose new positions for all mutations to apply them to the synthetic progenitors of the ancestor, using the position- and context-dependent model of <xref ref-type="bibr" rid="bib39">Spisak et al., 2020</xref>. The number of mutations assigned to a given configuration is rescaled by a factor <inline-formula><mml:math id="inf361"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mfrac><mml:mrow><mml:mi>L</mml:mi><mml:mo>+</mml:mo><mml:mi>l</mml:mi></mml:mrow><mml:msub><mml:mi>L</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>0</mml:mn></mml:mrow></mml:msub></mml:mfrac></mml:mstyle></mml:math></inline-formula> where <inline-formula><mml:math id="inf362"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>L</mml:mi></mml:mstyle></mml:math></inline-formula> is the templated length of the synthetic ancestral sequence and <inline-formula><mml:math id="inf363"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>L</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>0</mml:mn></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> is the templated length of the model lineage from <inline-formula><mml:math id="inf364"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-tex-caligraphic" mathvariant="script">L</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula>.</p><p>This way a synthetic lineage preserves all properties of the lineages of long CDR3s found in the data, particularly the mutational spectra (<xref ref-type="fig" rid="fig2s5">Figure 2—figure supplement 5</xref>) except for the ancestral sequences and the identity of mutations.</p></sec><sec id="s4-6"><title>HILARy-full</title><p>We compute the expected distributions of the CDR3 Hamming distance <inline-formula><mml:math id="inf365"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>n</mml:mi></mml:mstyle></mml:math></inline-formula>, and the number of shared mutations <inline-formula><mml:math id="inf366"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>0</mml:mn></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula>, under a uniform mutation rate assumption. In other words, we assume that the probability that a given position was mutated, given a mutation happened somewhere in a sequence of length <inline-formula><mml:math id="inf367"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>L</mml:mi></mml:mstyle></mml:math></inline-formula>, equals <inline-formula><mml:math id="inf368"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>L</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula> (we know this not to be true, see, e.g., <xref ref-type="bibr" rid="bib39">Spisak et al., 2020</xref>, but it allows for simple computations). It follows that the probability that a given position has not mutated once in a series of <inline-formula><mml:math id="inf369"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>n</mml:mi></mml:mstyle></mml:math></inline-formula> mutations is <inline-formula><mml:math id="inf370"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msup><mml:mi>L</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:msup><mml:mo stretchy="false">)</mml:mo><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>n</mml:mi></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula>.</p><sec id="s4-6-1"><title>Expectation of <inline-formula><mml:math id="inf371"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>0</mml:mn></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> under the null hypothesis</title><p>For <inline-formula><mml:math id="inf372"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>0</mml:mn></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> shared mutations, under the null hypothesis (we operate under the null hypothesis here since otherwise to estimate <inline-formula><mml:math id="inf373"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>0</mml:mn></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> we would need to make assumptions about the law that governs B-cell phylogeny topologies), the likelihood reads<disp-formula id="equ17"> <label>(17)</label><mml:math id="m17"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi mathvariant="normal">F</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:mi>L</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mrow><mml:mrow><mml:mrow><mml:mo maxsize="2.047em" minsize="2.047em">(</mml:mo></mml:mrow><mml:mfrac linethickness="0"><mml:mi>L</mml:mi><mml:msub><mml:mi>n</mml:mi><mml:mn>0</mml:mn></mml:msub></mml:mfrac><mml:mrow><mml:mo maxsize="2.047em" minsize="2.047em">)</mml:mo></mml:mrow></mml:mrow></mml:mrow><mml:msup><mml:mrow><mml:mi mathvariant="normal">p</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mn>0</mml:mn></mml:msub></mml:mrow></mml:msup><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:mrow><mml:mi mathvariant="normal">p</mml:mi></mml:mrow><mml:msup><mml:mo stretchy="false">)</mml:mo><mml:mrow><mml:mi>L</mml:mi><mml:mo>−</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mn>0</mml:mn></mml:msub></mml:mrow></mml:msup><mml:mo>,</mml:mo></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p>where the probability that the same position independently mutated in series of <inline-formula><mml:math id="inf374"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf375"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>2</mml:mn></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> mutations is<disp-formula id="equ18"><label>(18)</label><mml:math id="m18"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi mathvariant="normal">p</mml:mi></mml:mrow><mml:mo>=</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msup><mml:mi>L</mml:mi><mml:mrow><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:msup><mml:mo stretchy="false">)</mml:mo><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mn>1</mml:mn></mml:msub></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msup><mml:mi>L</mml:mi><mml:mrow><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:msup><mml:mo stretchy="false">)</mml:mo><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mn>2</mml:mn></mml:msub></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>.</mml:mo></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p>In the limit of large <inline-formula><mml:math id="inf376"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>L</mml:mi></mml:mstyle></mml:math></inline-formula>, we have at leading order<disp-formula id="equ19"> <label>(19)</label><mml:math id="m19"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">p</mml:mi></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:msub><mml:mi>n</mml:mi><mml:mn>2</mml:mn></mml:msub></mml:mrow><mml:msup><mml:mi>L</mml:mi><mml:mn>2</mml:mn></mml:msup></mml:mfrac><mml:mo>,</mml:mo></mml:mrow></mml:math></disp-formula><disp-formula id="equ20"><label>(20)</label><mml:math id="m20"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mtable columnalign="right left right left right left right left right left right left" rowspacing="3pt" columnspacing="0em 2em 0em 2em 0em 2em 0em 2em 0em 2em 0em" displaystyle="true"><mml:mtr><mml:mtd><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi mathvariant="normal">F</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mn>2</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:mi>L</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mtd><mml:mtd><mml:mi/><mml:mo>≃</mml:mo><mml:mrow><mml:mrow><mml:mrow><mml:mo maxsize="2.047em" minsize="2.047em">(</mml:mo></mml:mrow><mml:mfrac linethickness="0"><mml:mi>L</mml:mi><mml:msub><mml:mi>n</mml:mi><mml:mn>0</mml:mn></mml:msub></mml:mfrac><mml:mrow><mml:mo maxsize="2.047em" minsize="2.047em">)</mml:mo></mml:mrow></mml:mrow></mml:mrow><mml:msup><mml:mrow><mml:mo>(</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:msub><mml:mi>n</mml:mi><mml:mn>2</mml:mn></mml:msub></mml:mrow><mml:msup><mml:mi>L</mml:mi><mml:mn>2</mml:mn></mml:msup></mml:mfrac><mml:mo>)</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mn>0</mml:mn></mml:msub></mml:mrow></mml:msup><mml:msup><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:msub><mml:mi>n</mml:mi><mml:mn>2</mml:mn></mml:msub></mml:mrow><mml:msup><mml:mi>L</mml:mi><mml:mn>2</mml:mn></mml:msup></mml:mfrac></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mrow><mml:mi>L</mml:mi><mml:mo>−</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mn>0</mml:mn></mml:msub></mml:mrow></mml:msup></mml:mtd></mml:mtr><mml:mtr><mml:mtd/><mml:mtd><mml:mi/><mml:mo>≃</mml:mo><mml:mfrac><mml:msup><mml:mrow><mml:mo>(</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:msub><mml:mi>n</mml:mi><mml:mn>2</mml:mn></mml:msub></mml:mrow><mml:mi>L</mml:mi></mml:mfrac><mml:mo>)</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mn>0</mml:mn></mml:msub></mml:mrow></mml:msup><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo>!</mml:mo></mml:mrow></mml:mfrac><mml:msup><mml:mi>e</mml:mi><mml:mrow><mml:mo>−</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:msub><mml:mi>n</mml:mi><mml:mn>2</mml:mn></mml:msub></mml:mrow><mml:mi>L</mml:mi></mml:mfrac></mml:mrow></mml:msup><mml:mo>,</mml:mo></mml:mtd></mml:mtr></mml:mtable></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p>where the last approximation assumes <inline-formula><mml:math id="inf377"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mo>≪</mml:mo><mml:msup><mml:mi>L</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula>, which holds when mutation rates are small. Therefore, <inline-formula><mml:math id="inf378"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi mathvariant="normal">F</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mi>L</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula> may be approximated by a Poisson distribution of parameter <inline-formula><mml:math id="inf379"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mfrac><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>2</mml:mn></mml:mrow></mml:msub></mml:mrow><mml:mi>L</mml:mi></mml:mfrac></mml:mstyle></mml:math></inline-formula>, yielding:<disp-formula id="equ21"> <label>(21)</label><mml:math id="m21"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo fence="false" stretchy="false">⟨</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:msub><mml:mo fence="false" stretchy="false">⟩</mml:mo><mml:mrow><mml:mi mathvariant="normal">F</mml:mi></mml:mrow></mml:msub><mml:mo>≃</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:msub><mml:mi>n</mml:mi><mml:mn>2</mml:mn></mml:msub></mml:mrow><mml:mi>L</mml:mi></mml:mfrac><mml:mo>,</mml:mo><mml:mspace width="thickmathspace"/><mml:mspace width="thickmathspace"/><mml:mspace width="thickmathspace"/><mml:msub><mml:mi>σ</mml:mi><mml:mrow><mml:mi mathvariant="normal">F</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>≃</mml:mo><mml:msqrt><mml:mfrac><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:msub><mml:mi>n</mml:mi><mml:mn>2</mml:mn></mml:msub></mml:mrow><mml:mi>L</mml:mi></mml:mfrac></mml:msqrt><mml:mo>.</mml:mo></mml:mstyle></mml:mrow></mml:math></disp-formula></p></sec><sec id="s4-6-2"><title>Expectation of <inline-formula><mml:math id="inf380"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>n</mml:mi></mml:mstyle></mml:math></inline-formula> under the hypothesis of related sequences</title><p>The <inline-formula><mml:math id="inf381"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>n</mml:mi></mml:mstyle></mml:math></inline-formula> divergence of two CDR3s is interpreted as divergent mutations under the hypothesis that <inline-formula><mml:math id="inf382"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>s</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>1</mml:mn></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf383"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>s</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>2</mml:mn></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> are related. These mutations were harbored in parallel with <inline-formula><mml:math id="inf384"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>L</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:mn>2</mml:mn><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>0</mml:mn></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> mutations that occurred in the templated regions (<inline-formula><mml:math id="inf385"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>0</mml:mn></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> mutations arrived before the divergence of the two sequences began).</p><p>Under the assumption of a uniform mutation rate, the <inline-formula><mml:math id="inf386"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>L</mml:mi></mml:mrow></mml:msub></mml:mstyle></mml:math></inline-formula> mutations inform the prediction of the number of mutations expected in the CDR3. Indeed, they are related through a hidden variable, the expected number of mutations per base pair, denoted <inline-formula><mml:math id="inf387"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>μ</mml:mi></mml:mstyle></mml:math></inline-formula>. Integrating over this quantity we obtain<disp-formula id="equ22"> <label>(22)</label><mml:math id="m22"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>n</mml:mi><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mi>L</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mi>l</mml:mi><mml:mo>,</mml:mo><mml:mi>L</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:msubsup><mml:mo>∫</mml:mo><mml:mn>0</mml:mn><mml:mi mathvariant="normal">∞</mml:mi></mml:msubsup><mml:mspace width="thinmathspace"/><mml:mi>d</mml:mi><mml:mi>μ</mml:mi><mml:mspace width="thinmathspace"/><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>n</mml:mi><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mi>μ</mml:mi><mml:mo>,</mml:mo><mml:mi>l</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>μ</mml:mi><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mi>L</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mi>L</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>,</mml:mo></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p>where we convolute the positive distribution (<xref ref-type="disp-formula" rid="equ8">Equation 8</xref>),<disp-formula id="equ23"> <label>(23)</label><mml:math id="m23"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>n</mml:mi><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mi>μ</mml:mi><mml:mo>,</mml:mo><mml:mi>l</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mfrac><mml:msup><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>μ</mml:mi><mml:mi>l</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:msup><mml:mrow><mml:mi>n</mml:mi><mml:mo>!</mml:mo></mml:mrow></mml:mfrac><mml:msup><mml:mi>e</mml:mi><mml:mrow><mml:mi>μ</mml:mi><mml:mi>l</mml:mi></mml:mrow></mml:msup></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p>and, using the Bayes rule under uniform prior over <inline-formula><mml:math id="inf388"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>μ</mml:mi></mml:mstyle></mml:math></inline-formula>,<disp-formula id="equ24"> <label>(24)</label><mml:math id="m24"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>μ</mml:mi><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mi>L</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mi>L</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:msup><mml:mi>L</mml:mi><mml:mrow><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mi>L</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mi>μ</mml:mi><mml:mo>,</mml:mo><mml:mi>L</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mfrac><mml:msup><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>μ</mml:mi><mml:mi>L</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mi>L</mml:mi></mml:msub></mml:mrow></mml:msup><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mi>L</mml:mi></mml:msub><mml:mo>!</mml:mo><mml:mi>L</mml:mi></mml:mrow></mml:mfrac><mml:msup><mml:mi>e</mml:mi><mml:mrow><mml:mi>μ</mml:mi><mml:mi>L</mml:mi></mml:mrow></mml:msup><mml:mo>.</mml:mo></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p>The result is a negative binomial distribution,<disp-formula id="equ25"> <label>(25)</label><mml:math id="m25"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>n</mml:mi><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mi>L</mml:mi></mml:msub><mml:mo>,</mml:mo><mml:mi>l</mml:mi><mml:mo>,</mml:mo><mml:mi>L</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:msup><mml:mrow><mml:mo>(</mml:mo><mml:mfrac><mml:mi>L</mml:mi><mml:mrow><mml:mi>l</mml:mi><mml:mo>+</mml:mo><mml:mi>L</mml:mi></mml:mrow></mml:mfrac><mml:mo>)</mml:mo></mml:mrow><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mi>L</mml:mi></mml:msub><mml:mo>+</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:msup><mml:mrow><mml:mo>(</mml:mo><mml:mfrac><mml:mi>l</mml:mi><mml:mrow><mml:mi>l</mml:mi><mml:mo>+</mml:mo><mml:mi>L</mml:mi></mml:mrow></mml:mfrac><mml:mo>)</mml:mo></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:msup><mml:mrow><mml:mrow><mml:mrow><mml:mo maxsize="2.047em" minsize="2.047em">(</mml:mo></mml:mrow><mml:mfrac linethickness="0"><mml:mrow><mml:mi>n</mml:mi><mml:mo>+</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mi>L</mml:mi></mml:msub></mml:mrow><mml:mi>n</mml:mi></mml:mfrac><mml:mrow><mml:mo maxsize="2.047em" minsize="2.047em">)</mml:mo></mml:mrow></mml:mrow></mml:mrow><mml:mo>,</mml:mo></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p>with<disp-formula id="equ26"> <label>(26)</label><mml:math id="m26"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo fence="false" stretchy="false">⟨</mml:mo><mml:mi>n</mml:mi><mml:msub><mml:mo fence="false" stretchy="false">⟩</mml:mo><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mfrac><mml:mi>l</mml:mi><mml:mi>L</mml:mi></mml:mfrac><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mi>L</mml:mi></mml:msub><mml:mo>+</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>,</mml:mo><mml:mspace width="thickmathspace"/><mml:mspace width="thickmathspace"/><mml:mspace width="thickmathspace"/><mml:msub><mml:mi>σ</mml:mi><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>n</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mi>L</mml:mi></mml:mfrac><mml:msqrt><mml:mi>l</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>l</mml:mi><mml:mo>+</mml:mo><mml:mi>L</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mi>L</mml:mi></mml:msub><mml:mo>+</mml:mo><mml:mn>1</mml:mn><mml:mo stretchy="false">)</mml:mo></mml:msqrt><mml:mo>.</mml:mo></mml:mstyle></mml:mrow></mml:math></disp-formula></p></sec><sec id="s4-6-3"><title>Merging fine-partition clusters</title><p>HILARy-full relies on the results (<xref ref-type="disp-formula" rid="equ1"><xref ref-type="disp-formula" rid="equ26">Equation 26</xref></xref>) and (<xref ref-type="disp-formula" rid="equ21">Equation 21</xref>) to define the rescaled variables (<xref ref-type="disp-formula" rid="equ1"><xref ref-type="disp-formula" rid="equ4">Equation 4</xref></xref>)<disp-formula id="equ27"> <label>(27)</label><mml:math id="m27"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>x</mml:mi><mml:mo>′</mml:mo></mml:msup><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi>n</mml:mi><mml:mo>−</mml:mo><mml:mo fence="false" stretchy="false">⟨</mml:mo><mml:mi>n</mml:mi><mml:msub><mml:mo fence="false" stretchy="false">⟩</mml:mo><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mi>σ</mml:mi><mml:mrow><mml:mi mathvariant="normal">T</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>n</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfrac><mml:mo>,</mml:mo><mml:mspace width="1em"/><mml:mi>y</mml:mi><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo>−</mml:mo><mml:mo fence="false" stretchy="false">⟨</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:msub><mml:mo fence="false" stretchy="false">⟩</mml:mo><mml:mrow><mml:mi mathvariant="normal">F</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mi>σ</mml:mi><mml:mrow><mml:mi mathvariant="normal">F</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mn>0</mml:mn></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mrow></mml:mfrac><mml:mo>.</mml:mo></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p>We expect <inline-formula><mml:math id="inf389"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>y</mml:mi><mml:mo>≈</mml:mo><mml:mn>0</mml:mn></mml:mstyle></mml:math></inline-formula>, <inline-formula><mml:math id="inf390"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>x</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup><mml:mo>&gt;</mml:mo><mml:mn>0</mml:mn></mml:mstyle></mml:math></inline-formula> for unrelated sequences, and <inline-formula><mml:math id="inf391"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>x</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup><mml:mo>≈</mml:mo><mml:mn>0</mml:mn></mml:mstyle></mml:math></inline-formula>, <inline-formula><mml:math id="inf392"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>y</mml:mi><mml:mo>&gt;</mml:mo><mml:mn>0</mml:mn></mml:mstyle></mml:math></inline-formula> for related sequences. So we expect <inline-formula><mml:math id="inf393"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>x</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup><mml:mo>−</mml:mo><mml:mi>y</mml:mi><mml:mo>&gt;</mml:mo><mml:mn>0</mml:mn></mml:mstyle></mml:math></inline-formula> for unrelated sequences, and <inline-formula><mml:math id="inf394"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>x</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup><mml:mo>−</mml:mo><mml:mi>y</mml:mi><mml:mo>&lt;</mml:mo><mml:mn>0</mml:mn></mml:mstyle></mml:math></inline-formula> for related sequences. We use <inline-formula><mml:math id="inf395"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>x</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup><mml:mo>−</mml:mo><mml:mi>y</mml:mi></mml:mstyle></mml:math></inline-formula> as a distance for single-linkage clustering, with adaptive threshold to control performance. The threshold <inline-formula><mml:math id="inf396"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>t</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula> is chosen to achieve a desired precision of <inline-formula><mml:math id="inf397"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>π</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:mn>0.99</mml:mn></mml:mstyle></mml:math></inline-formula> as in HILARy-CDR3. To this end we use soNNia-based estimate of null distribution <inline-formula><mml:math id="inf398"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>F</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mi>l</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula> (<xref ref-type="disp-formula" rid="equ6">Equation 6</xref>), the data-derived distribution of the number of mutations, <inline-formula><mml:math id="inf399"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>P</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula>, and further assume <inline-formula><mml:math id="inf400"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>0</mml:mn></mml:mrow></mml:msub><mml:mo>∼</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:msub><mml:mi>n</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>2</mml:mn></mml:mrow></mml:msub></mml:mrow><mml:mi>L</mml:mi></mml:mfrac></mml:mstyle></mml:math></inline-formula> to compute the null distribution <inline-formula><mml:math id="inf401"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msub><mml:mi>P</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi>F</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mi>x</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup><mml:mo>−</mml:mo><mml:mi>y</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mi>l</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula>. We can now choose a target <inline-formula><mml:math id="inf402"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>π</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula> and compute <inline-formula><mml:math id="inf403"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>t</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula> such that <inline-formula><mml:math id="inf404"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>π</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mi>t</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:msup><mml:mi>π</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:mn>0.99</mml:mn></mml:mstyle></mml:math></inline-formula> using <xref ref-type="disp-formula" rid="equ1 equ2 equ3">Equations 1–3</xref>, the prevalence <inline-formula><mml:math id="inf405"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>ρ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:math></inline-formula> inferred as explained earlier in the CDR3-based method, and assuming <inline-formula><mml:math id="inf406"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>s</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow><mml:mo>≃</mml:mo><mml:mn>1</mml:mn></mml:mstyle></mml:math></inline-formula>. As the computation of <inline-formula><mml:math id="inf407"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>t</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula> depends on the inferred prevalence, we use this procedure only for <inline-formula><mml:math id="inf408"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi mathvariant="normal">V</mml:mi><mml:mi mathvariant="normal">J</mml:mi></mml:mrow><mml:mi>l</mml:mi></mml:mrow></mml:mstyle></mml:math></inline-formula> classes with enough sequences for a reliable <inline-formula><mml:math id="inf409"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow class="MJX-TeXAtom-ORD"><mml:mover><mml:mi>ρ</mml:mi><mml:mo stretchy="false">^</mml:mo></mml:mover></mml:mrow></mml:mstyle></mml:math></inline-formula> (<xref ref-type="fig" rid="fig3s2">Figure 3—figure supplement 2</xref>), namely for sizes larger than 100. For smaller sizes the threshold was set to the default value of 0.</p><p>To reduce the number of pairwise computations, we do not apply single-linkage clustering directly, but instead merge fine-partition clusters within coarse-partition clusters, where the fine and coarse partitions were previously obtained using the CDR3-based method (see section HILARy-CDR3). Specifically, we compute <inline-formula><mml:math id="inf410"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>x</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup><mml:mo>−</mml:mo><mml:mi>y</mml:mi></mml:mstyle></mml:math></inline-formula> for all pairs of sequences that belong to the same coarse cluster, but to different fine clusters. Two fine-partition clusters are then merged if there exist any two sequences belonging to each of the two clusters for which <inline-formula><mml:math id="inf411"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>x</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup><mml:mo>−</mml:mo><mml:mi>y</mml:mi><mml:mo>&lt;</mml:mo><mml:msup><mml:mi>t</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula>. Note that this is equivalent to performing single-linkage clustering on all sequences using the distance <inline-formula><mml:math id="inf412"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mo>−</mml:mo><mml:mi mathvariant="normal">∞</mml:mi></mml:mstyle></mml:math></inline-formula> for pairs inside a precise cluster and <inline-formula><mml:math id="inf413"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>x</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mi class="MJX-variant" mathvariant="normal">′</mml:mi></mml:mrow></mml:msup><mml:mo>−</mml:mo><mml:mi>y</mml:mi></mml:mstyle></mml:math></inline-formula> otherwise.</p></sec></sec><sec id="s4-7"><title>Evaluation methods</title><p>In this section, we introduce the variation of information <inline-formula><mml:math id="inf414"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>v</mml:mi></mml:mstyle></mml:math></inline-formula>, used for evaluating alternative methods for clonal family inference in the benchmark analysis. It is a useful summary statistic to quantify the performance of inference as it is affected by its precision as well as sensitivity (<xref ref-type="bibr" rid="bib7">Brown et al., 2007</xref>). Variation of information <inline-formula><mml:math id="inf415"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>v</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mi>r</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula> measures the information loss from the true partition <inline-formula><mml:math id="inf416"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>r</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula> to the inference result <inline-formula><mml:math id="inf417"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>r</mml:mi></mml:mstyle></mml:math></inline-formula> (<xref ref-type="bibr" rid="bib48">Zurek, 1989</xref>; <xref ref-type="bibr" rid="bib25">Meilă, 2003</xref>). To define the variation of information we first introduce the entropy <inline-formula><mml:math id="inf418"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>S</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula> of a partition <inline-formula><mml:math id="inf419"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>r</mml:mi></mml:mstyle></mml:math></inline-formula> of <inline-formula><mml:math id="inf420"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>N</mml:mi></mml:mstyle></mml:math></inline-formula> sequences into clusters <inline-formula><mml:math id="inf421"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>c</mml:mi></mml:mstyle></mml:math></inline-formula> as<disp-formula id="equ28"> <label>(28)</label><mml:math id="m28"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>S</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mo>−</mml:mo><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>c</mml:mi><mml:mo>∈</mml:mo><mml:mi>r</mml:mi></mml:mrow></mml:munder><mml:mfrac><mml:mrow><mml:mi>n</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>c</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi>N</mml:mi></mml:mfrac><mml:mi>log</mml:mi><mml:mo>⁡</mml:mo><mml:mrow><mml:mfrac><mml:mrow><mml:mi>n</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>c</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi>N</mml:mi></mml:mfrac></mml:mrow><mml:mo>,</mml:mo></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p>where <inline-formula><mml:math id="inf422"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>n</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>c</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula> denotes the number of sequences in cluster <inline-formula><mml:math id="inf423"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>c</mml:mi></mml:mstyle></mml:math></inline-formula>. The mutual information between two partitions <inline-formula><mml:math id="inf424"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>r</mml:mi></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf425"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>r</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula> can then be computed as<disp-formula id="equ29"> <label>(29)</label><mml:math id="m29"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>I</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mi>r</mml:mi><mml:mo>∗</mml:mo></mml:msup><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>c</mml:mi><mml:mo>∈</mml:mo><mml:mi>r</mml:mi></mml:mrow></mml:munder><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:msup><mml:mi>c</mml:mi><mml:mo>∗</mml:mo></mml:msup><mml:mo>∈</mml:mo><mml:msup><mml:mi>r</mml:mi><mml:mo>∗</mml:mo></mml:msup></mml:mrow></mml:munder><mml:mfrac><mml:mrow><mml:mi>n</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>c</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mi>c</mml:mi><mml:mo>∗</mml:mo></mml:msup><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi>N</mml:mi></mml:mfrac><mml:mi>log</mml:mi><mml:mo>⁡</mml:mo><mml:mrow><mml:mfrac><mml:mrow><mml:mi>n</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>c</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mi>c</mml:mi><mml:mo>∗</mml:mo></mml:msup><mml:mo stretchy="false">)</mml:mo></mml:mrow><mml:mi>N</mml:mi></mml:mfrac></mml:mrow><mml:mo>,</mml:mo></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p>where <inline-formula><mml:math id="inf426"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>n</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>c</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mi>c</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula> denotes the number of overlapping elements between cluster <inline-formula><mml:math id="inf427"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>c</mml:mi></mml:mstyle></mml:math></inline-formula> in partition <inline-formula><mml:math id="inf428"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>r</mml:mi></mml:mstyle></mml:math></inline-formula> and cluster <inline-formula><mml:math id="inf429"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>c</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula> in partition <inline-formula><mml:math id="inf430"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:msup><mml:mi>r</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup></mml:mstyle></mml:math></inline-formula>. Finally, variation of information is given by<disp-formula id="equ30"> <label>(30)</label><mml:math id="m30"><mml:mrow><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>v</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mi>r</mml:mi><mml:mo>∗</mml:mo></mml:msup><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mi>S</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo><mml:mo>+</mml:mo><mml:mi>S</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mi>r</mml:mi><mml:mo>∗</mml:mo></mml:msup><mml:mo stretchy="false">)</mml:mo><mml:mo>−</mml:mo><mml:mn>2</mml:mn><mml:mi>I</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mi>r</mml:mi><mml:mo>∗</mml:mo></mml:msup><mml:mo stretchy="false">)</mml:mo><mml:mo>.</mml:mo></mml:mstyle></mml:mrow></mml:math></disp-formula></p><p>Variation of information is a metric in the space of possible partitions since it is non-negative, <inline-formula><mml:math id="inf431"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>v</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mi>r</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup><mml:mo stretchy="false">)</mml:mo><mml:mo>≥</mml:mo><mml:mn>0</mml:mn></mml:mstyle></mml:math></inline-formula>, symmetric, <inline-formula><mml:math id="inf432"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>v</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:mi>r</mml:mi><mml:mo>,</mml:mo><mml:msup><mml:mi>r</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup><mml:mo stretchy="false">)</mml:mo><mml:mo>=</mml:mo><mml:mi>v</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mi>r</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mo>∗</mml:mo></mml:mrow></mml:msup><mml:mo>,</mml:mo><mml:mi>r</mml:mi><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula>, and obeys the triangle inequality, <inline-formula><mml:math id="inf433"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mi>v</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>r</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>r</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>3</mml:mn></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>≤</mml:mo><mml:mi>v</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>r</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>r</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mo>+</mml:mo><mml:mi>v</mml:mi><mml:mo stretchy="false">(</mml:mo><mml:msub><mml:mi>r</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:msub><mml:mi>r</mml:mi><mml:mrow class="MJX-TeXAtom-ORD"><mml:mn>3</mml:mn></mml:mrow></mml:msub><mml:mo stretchy="false">)</mml:mo></mml:mstyle></mml:math></inline-formula> for any three partitions (<xref ref-type="bibr" rid="bib48">Zurek, 1989</xref>).</p></sec><sec id="s4-8"><title>Code and data availability</title><p>We used version 1.2.0 for spectral SCOPer, 1.3.0 for SCOper using the V and J mutation presented in <xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1</xref>, version 1.2.0 for HILARy, version 0.16.0 for partis, and the code from this repository <ext-link ext-link-type="uri" xlink:href="https://bitbucket.org/kleinstein/projects/src/master/Lindenbaum2020/Example.ipynb">https://bitbucket.org/kleinstein/projects/src/master/Lindenbaum2020/Example.ipynb</ext-link> for the alignment-free method. The HILARy tool with Python implementations of the CDR3 and mutation-based methods introduced above can be found at <ext-link ext-link-type="uri" xlink:href="https://github.com/statbiophys/HILARy">https://github.com/statbiophys/HILARy</ext-link> (copy archived at <xref ref-type="bibr" rid="bib2">Athènes, 2024</xref>). The standalone prefix tree implementation can be found at <ext-link ext-link-type="uri" xlink:href="https://github.com/statbiophys/ATrieGC">https://github.com/statbiophys/ATrieGC</ext-link> (copy archived at <xref ref-type="bibr" rid="bib9">Dupic, 2024</xref>). A complete guide to our benchmark procedure can be found in the README of the folder <ext-link ext-link-type="uri" xlink:href="https://github.com/statbiophys/HILARy/tree/main/data_with_scripts">https://github.com/statbiophys/HILARy/tree/main/data_with_scripts</ext-link> where we make available scripts to infer lineages and reproduce the benchmark figures of this article. We also upload this folder with all input and output data at <ext-link ext-link-type="uri" xlink:href="https://zenodo.org/records/10676371">https://zenodo.org/records/10676371</ext-link>.</p></sec></sec></body><back><sec sec-type="additional-information" id="s5"><title>Additional information</title><fn-group content-type="competing-interest"><title>Competing interests</title><fn fn-type="COI-statement" id="conf1"><p>No competing interests declared</p></fn><fn fn-type="COI-statement" id="conf2"><p>Senior editor, eLife</p></fn></fn-group><fn-group content-type="author-contribution"><title>Author contributions</title><fn fn-type="con" id="con1"><p>Conceptualization, Resources, Data curation, Software, Formal analysis, Validation, Investigation, Visualization, Methodology, Writing – original draft, Writing – review and editing</p></fn><fn fn-type="con" id="con2"><p>Resources, Data curation, Software, Validation, Investigation, Visualization, Methodology, Writing – review and editing</p></fn><fn fn-type="con" id="con3"><p>Resources, Software, Methodology</p></fn><fn fn-type="con" id="con4"><p>Conceptualization, Resources, Formal analysis, Supervision, Funding acquisition, Investigation, Methodology, Writing – original draft, Project administration, Writing – review and editing</p></fn><fn fn-type="con" id="con5"><p>Conceptualization, Resources, Formal analysis, Supervision, Funding acquisition, Investigation, Methodology, Writing – original draft, Project administration, Writing – review and editing</p></fn></fn-group></sec><sec sec-type="supplementary-material" id="s6"><title>Additional files</title><supplementary-material id="mdar"><label>MDAR checklist</label><media xlink:href="elife-86181-mdarchecklist1-v2.pdf" mimetype="application" mime-subtype="pdf"/></supplementary-material></sec><sec sec-type="data-availability" id="s7"><title>Data availability</title><p>The current manuscript is a computational study, so no data have been generated for this manuscript. All data used is publicly available. The HILARy tool with Python implementations of the CDR3 and mutations-based methods introduced above can be found at <ext-link ext-link-type="uri" xlink:href="https://github.com/statbiophys/HILARy">https://github.com/statbiophys/HILARy</ext-link> (copy archived at <xref ref-type="bibr" rid="bib2">Athènes, 2024</xref>). The standalone prefix tree implementation can be found at <ext-link ext-link-type="uri" xlink:href="https://github.com/statbiophys/ATrieGC">https://github.com/statbiophys/ATrieGC</ext-link> (copy archived at <xref ref-type="bibr" rid="bib9">Dupic, 2024</xref>). A complete guide to our benchmark procedure can be found in the README of the folder <ext-link ext-link-type="uri" xlink:href="https://github.com/statbiophys/HILARy/tree/main/data_with_scripts">https://github.com/statbiophys/HILARy/tree/main/data_with_scripts</ext-link> where we make available scripts to infer lineages and reproduce the benchmark figures of this article. We also upload this folder with all input and output data at <ext-link ext-link-type="uri" xlink:href="https://zenodo.org/records/10676371">https://zenodo.org/records/10676371</ext-link>.</p><p>The following dataset was generated:</p><p><element-citation publication-type="data" specific-use="isSupplementedBy" id="dataset1"><person-group person-group-type="author"><name><surname>Spisak</surname><given-names>N</given-names></name><name><surname>Athènes</surname><given-names>G</given-names></name><name><surname>Athènes</surname><given-names>G</given-names></name><name><surname>Dupic</surname><given-names>T</given-names></name><name><surname>Mora</surname><given-names>T</given-names></name><name><surname>Walczak</surname><given-names>A</given-names></name></person-group><year iso-8601-date="2024">2024</year><data-title>Combining mutation and recombination statistics to infer clonal families in antibody repertoires</data-title><source>Zenodo</source><pub-id pub-id-type="doi">10.5281/zenodo.10676370</pub-id></element-citation></p><p>The following previously published dataset was used:</p><p><element-citation publication-type="data" specific-use="references" id="dataset2"><person-group person-group-type="author"><name><surname>Briney</surname><given-names>B</given-names></name><name><surname>Inderbitzin</surname><given-names>A</given-names></name><name><surname>Joyce</surname><given-names>C</given-names></name><name><surname>Burton</surname><given-names>DR</given-names></name></person-group><year iso-8601-date="2019">2019</year><data-title>Uniqueness, commonality and exceptional diversity in the baseline human antibody repertoire</data-title><source>NCBI BioProject</source><pub-id pub-id-type="accession" xlink:href="https://www.ncbi.nlm.nih.gov/bioproject/?term=PRJNA406949">PRJNA406949</pub-id></element-citation></p></sec><ack id="ack"><title>Acknowledgements</title><p>The study was supported by European Research Council COG 724208 and ANR-19-CE45-0018 ‘RESP- REP’ from the Agence Nationale de la Recherche grants and DFG grant CRC 1310 ‘Predictability in Evolution’.</p></ack><ref-list><title>References</title><ref id="bib1"><element-citation publication-type="preprint"><person-group person-group-type="author"><name><surname>Abdollahi</surname><given-names>N</given-names></name><name><surname>de Septenville</surname><given-names>A</given-names></name><name><surname>Davi</surname><given-names>F</given-names></name><name><surname>Bernardes</surname><given-names>JS</given-names></name></person-group><year iso-8601-date="2020">2020</year><article-title>Automatic generation of ground truth data for the evaluation of clonal grouping methods in B-cell populations</article-title><source>bioRxiv</source><pub-id pub-id-type="doi">10.1101/2020.11.30.404046</pub-id></element-citation></ref><ref id="bib2"><element-citation publication-type="software"><person-group person-group-type="author"><name><surname>Athènes</surname><given-names>G</given-names></name></person-group><year iso-8601-date="2024">2024</year><data-title>HILARy</data-title><version designator="swh:1:rev:00bc5282cfca42487a4437ac0e4a9e61fbb277e1">swh:1:rev:00bc5282cfca42487a4437ac0e4a9e61fbb277e1</version><source>Software Heritage</source><ext-link ext-link-type="uri" xlink:href="https://archive.softwareheritage.org/swh:1:dir:241d2ff5aee70669015a4db931d7ef1c2e151df0;origin=https://github.com/statbiophys/HILARy;visit=swh:1:snp:66c307e638a967155c2cea77ce97719928d292bf;anchor=swh:1:rev:00bc5282cfca42487a4437ac0e4a9e61fbb277e1">https://archive.softwareheritage.org/swh:1:dir:241d2ff5aee70669015a4db931d7ef1c2e151df0;origin=https://github.com/statbiophys/HILARy;visit=swh:1:snp:66c307e638a967155c2cea77ce97719928d292bf;anchor=swh:1:rev:00bc5282cfca42487a4437ac0e4a9e61fbb277e1</ext-link></element-citation></ref><ref id="bib3"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Balashova</surname><given-names>D</given-names></name><name><surname>van Schaik</surname><given-names>BDC</given-names></name><name><surname>Stratigopoulou</surname><given-names>M</given-names></name><name><surname>Guikema</surname><given-names>JEJ</given-names></name><name><surname>Caniels</surname><given-names>TG</given-names></name><name><surname>Claireaux</surname><given-names>M</given-names></name><name><surname>van Gils</surname><given-names>MJ</given-names></name><name><surname>Musters</surname><given-names>A</given-names></name><name><surname>Anang</surname><given-names>DC</given-names></name><name><surname>de Vries</surname><given-names>N</given-names></name><name><surname>Greiff</surname><given-names>V</given-names></name><name><surname>van Kampen</surname><given-names>AHC</given-names></name></person-group><year iso-8601-date="2024">2024</year><article-title>Systematic evaluation of B-cell clonal family inference approaches</article-title><source>BMC Immunology</source><volume>25</volume><elocation-id>00600-8</elocation-id><pub-id pub-id-type="doi">10.1186/s12865-024-00600-8</pub-id></element-citation></ref><ref id="bib4"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Boytsov</surname><given-names>L</given-names></name></person-group><year iso-8601-date="2011">2011</year><article-title>Indexing methods for approximate dictionary searching</article-title><source>ACM Journal of Experimental Algorithmics</source><volume>16</volume><elocation-id>1963191</elocation-id><pub-id pub-id-type="doi">10.1145/1963190.1963191</pub-id></element-citation></ref><ref id="bib5"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Briney</surname><given-names>B</given-names></name><name><surname>Le</surname><given-names>K</given-names></name><name><surname>Zhu</surname><given-names>J</given-names></name><name><surname>Burton</surname><given-names>DR</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Clonify: unseeded antibody lineage assignment from next-generation sequencing data</article-title><source>Scientific Reports</source><volume>6</volume><elocation-id>23901</elocation-id><pub-id pub-id-type="doi">10.1038/srep23901</pub-id><pub-id pub-id-type="pmid">27102563</pub-id></element-citation></ref><ref id="bib6"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Briney</surname><given-names>B</given-names></name><name><surname>Inderbitzin</surname><given-names>A</given-names></name><name><surname>Joyce</surname><given-names>C</given-names></name><name><surname>Burton</surname><given-names>DR</given-names></name></person-group><year iso-8601-date="2019">2019</year><article-title>Commonality despite exceptional diversity in the baseline human antibody repertoire</article-title><source>Nature</source><volume>566</volume><fpage>393</fpage><lpage>397</lpage><pub-id pub-id-type="doi">10.1038/s41586-019-0879-y</pub-id><pub-id pub-id-type="pmid">30664748</pub-id></element-citation></ref><ref id="bib7"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Brown</surname><given-names>DP</given-names></name><name><surname>Krishnamurthy</surname><given-names>N</given-names></name><name><surname>Sjölander</surname><given-names>K</given-names></name></person-group><year iso-8601-date="2007">2007</year><article-title>Automated protein subfamily identification and classification</article-title><source>PLOS Computational Biology</source><volume>3</volume><elocation-id>e160</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pcbi.0030160</pub-id></element-citation></ref><ref id="bib8"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>De Boer</surname><given-names>RJ</given-names></name><name><surname>Freitas</surname><given-names>AA</given-names></name><name><surname>Perelson</surname><given-names>AS</given-names></name></person-group><year iso-8601-date="2001">2001</year><article-title>Resource competition determines selection of B cell repertoires</article-title><source>Journal of Theoretical Biology</source><volume>212</volume><fpage>333</fpage><lpage>343</lpage><pub-id pub-id-type="doi">10.1006/jtbi.2001.2379</pub-id><pub-id pub-id-type="pmid">11829354</pub-id></element-citation></ref><ref id="bib9"><element-citation publication-type="software"><person-group person-group-type="author"><name><surname>Dupic</surname><given-names>T</given-names></name></person-group><year iso-8601-date="2024">2024</year><data-title>ATrieGC</data-title><version designator="swh:1:rev:2eea34f2c97ac8e11e4d238ece120f56f4cefc60">swh:1:rev:2eea34f2c97ac8e11e4d238ece120f56f4cefc60</version><source>Software Heritage</source><ext-link ext-link-type="uri" xlink:href="https://archive.softwareheritage.org/swh:1:dir:3a11acec19948c2ab8255323e97543d99f8d37ea;origin=https://github.com/statbiophys/ATrieGC;visit=swh:1:snp:677684507448c7d854f1bdd77c89701eca52811b;anchor=swh:1:rev:2eea34f2c97ac8e11e4d238ece120f56f4cefc60">https://archive.softwareheritage.org/swh:1:dir:3a11acec19948c2ab8255323e97543d99f8d37ea;origin=https://github.com/statbiophys/ATrieGC;visit=swh:1:snp:677684507448c7d854f1bdd77c89701eca52811b;anchor=swh:1:rev:2eea34f2c97ac8e11e4d238ece120f56f4cefc60</ext-link></element-citation></ref><ref id="bib10"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Elhanati</surname><given-names>Y</given-names></name><name><surname>Murugan</surname><given-names>A</given-names></name><name><surname>Callan</surname><given-names>CG</given-names></name><name><surname>Mora</surname><given-names>T</given-names></name><name><surname>Walczak</surname><given-names>AM</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Quantifying selection in immune receptor repertoires</article-title><source>PNAS</source><volume>111</volume><fpage>9875</fpage><lpage>9880</lpage><pub-id pub-id-type="doi">10.1073/pnas.1409572111</pub-id></element-citation></ref><ref id="bib11"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Elhanati</surname><given-names>Y</given-names></name><name><surname>Sethna</surname><given-names>Z</given-names></name><name><surname>Marcou</surname><given-names>Q</given-names></name><name><surname>Callan</surname><given-names>CG</given-names></name><name><surname>Mora</surname><given-names>T</given-names></name><name><surname>Walczak</surname><given-names>AM</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Inferring processes underlying B-cell repertoire diversity</article-title><source>Philosophical Transactions of the Royal Society of London. Series B, Biological Sciences</source><volume>370</volume><elocation-id>20140243</elocation-id><pub-id pub-id-type="doi">10.1098/rstb.2014.0243</pub-id><pub-id pub-id-type="pmid">26194757</pub-id></element-citation></ref><ref id="bib12"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Feng</surname><given-names>Y</given-names></name><name><surname>Seija</surname><given-names>N</given-names></name><name><surname>Di Noia</surname><given-names>JM</given-names></name><name><surname>Martin</surname><given-names>A</given-names></name></person-group><year iso-8601-date="2020">2020</year><article-title>AID in antibody diversification: there and back again</article-title><source>Trends in Immunology</source><volume>41</volume><fpage>586</fpage><lpage>600</lpage><pub-id pub-id-type="doi">10.1016/j.it.2020.04.009</pub-id></element-citation></ref><ref id="bib13"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Giudicelli</surname><given-names>V</given-names></name><name><surname>Duroux</surname><given-names>P</given-names></name><name><surname>Ginestoux</surname><given-names>C</given-names></name><name><surname>Folch</surname><given-names>G</given-names></name><name><surname>Jabado-Michaloud</surname><given-names>J</given-names></name><name><surname>Chaume</surname><given-names>D</given-names></name><name><surname>Lefranc</surname><given-names>M-P</given-names></name></person-group><year iso-8601-date="2006">2006</year><article-title>IMGT/LIGM-DB, the IMGT comprehensive database of immunoglobulin and T cell receptor nucleotide sequences</article-title><source>Nucleic Acids Research</source><volume>34</volume><fpage>D781</fpage><lpage>D784</lpage><pub-id pub-id-type="doi">10.1093/nar/gkj088</pub-id><pub-id pub-id-type="pmid">16381979</pub-id></element-citation></ref><ref id="bib14"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hoehn</surname><given-names>KB</given-names></name><name><surname>Vander Heiden</surname><given-names>JA</given-names></name><name><surname>Zhou</surname><given-names>JQ</given-names></name><name><surname>Lunter</surname><given-names>G</given-names></name><name><surname>Pybus</surname><given-names>OG</given-names></name><name><surname>Kleinstein</surname><given-names>SH</given-names></name></person-group><year iso-8601-date="2019">2019</year><article-title>Repertoire-wide phylogenetic models of B cell molecular evolution reveal evolutionary signatures of aging and vaccination</article-title><source>PNAS</source><volume>116</volume><fpage>22664</fpage><lpage>22672</lpage><pub-id pub-id-type="doi">10.1073/pnas.1906020116</pub-id><pub-id pub-id-type="pmid">31636219</pub-id></element-citation></ref><ref id="bib15"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Horns</surname><given-names>F</given-names></name><name><surname>Vollmers</surname><given-names>C</given-names></name><name><surname>Dekker</surname><given-names>CL</given-names></name><name><surname>Quake</surname><given-names>SR</given-names></name></person-group><year iso-8601-date="2019">2019</year><article-title>Signatures of selection in the human antibody repertoire: Selective sweeps, competing subclones, and neutral drift</article-title><source>PNAS</source><volume>116</volume><fpage>1261</fpage><lpage>1266</lpage><pub-id pub-id-type="doi">10.1073/pnas.1814213116</pub-id><pub-id pub-id-type="pmid">30622180</pub-id></element-citation></ref><ref id="bib16"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hozumi</surname><given-names>N</given-names></name><name><surname>Tonegawa</surname><given-names>S</given-names></name></person-group><year iso-8601-date="1976">1976</year><article-title>Evidence for somatic rearrangement of immunoglobulin genes coding for variable and constant regions</article-title><source>PNAS</source><volume>73</volume><fpage>3628</fpage><lpage>3632</lpage><pub-id pub-id-type="doi">10.1073/pnas.73.10.3628</pub-id><pub-id pub-id-type="pmid">824647</pub-id></element-citation></ref><ref id="bib17"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Isacchini</surname><given-names>G</given-names></name><name><surname>Walczak</surname><given-names>AM</given-names></name><name><surname>Mora</surname><given-names>T</given-names></name><name><surname>Nourmohammad</surname><given-names>A</given-names></name></person-group><year iso-8601-date="2021">2021</year><article-title>Deep generative selection models of T and B cell receptor repertoires with soNNia</article-title><source>PNAS</source><volume>118</volume><elocation-id>e2023141118</elocation-id><pub-id pub-id-type="doi">10.1073/pnas.2023141118</pub-id><pub-id pub-id-type="pmid">33795515</pub-id></element-citation></ref><ref id="bib18"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kepler</surname><given-names>TB</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>Reconstructing a B-cell clonal lineage. I. Statistical inference of unobserved ancestors</article-title><source>F1000Research</source><volume>2</volume><elocation-id>103</elocation-id><pub-id pub-id-type="doi">10.12688/f1000research.2-103.v1</pub-id><pub-id pub-id-type="pmid">24555054</pub-id></element-citation></ref><ref id="bib19"><element-citation publication-type="book"><person-group person-group-type="author"><name><surname>Knuth</surname><given-names>DE</given-names></name></person-group><year iso-8601-date="2013">2013</year><chapter-title>The: generating all trees–history of combina torial generation</chapter-title><person-group person-group-type="editor"><name><surname>Knuth</surname><given-names>DE</given-names></name></person-group><source>Art of Computer Programming</source><publisher-name>Addison-Wesley Professional</publisher-name><fpage>1</fpage><lpage>272</lpage></element-citation></ref><ref id="bib20"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kreer</surname><given-names>C</given-names></name><name><surname>Zehner</surname><given-names>M</given-names></name><name><surname>Weber</surname><given-names>T</given-names></name><name><surname>Ercanoglu</surname><given-names>MS</given-names></name><name><surname>Gieselmann</surname><given-names>L</given-names></name><name><surname>Rohde</surname><given-names>C</given-names></name><name><surname>Halwe</surname><given-names>S</given-names></name><name><surname>Korenkov</surname><given-names>M</given-names></name><name><surname>Schommers</surname><given-names>P</given-names></name><name><surname>Vanshylla</surname><given-names>K</given-names></name><name><surname>Di Cristanziano</surname><given-names>V</given-names></name><name><surname>Janicki</surname><given-names>H</given-names></name><name><surname>Brinker</surname><given-names>R</given-names></name><name><surname>Ashurov</surname><given-names>A</given-names></name><name><surname>Krähling</surname><given-names>V</given-names></name><name><surname>Kupke</surname><given-names>A</given-names></name><name><surname>Cohen-Dvashi</surname><given-names>H</given-names></name><name><surname>Koch</surname><given-names>M</given-names></name><name><surname>Eckert</surname><given-names>JM</given-names></name><name><surname>Lederer</surname><given-names>S</given-names></name><name><surname>Pfeifer</surname><given-names>N</given-names></name><name><surname>Wolf</surname><given-names>T</given-names></name><name><surname>Vehreschild</surname><given-names>M</given-names></name><name><surname>Wendtner</surname><given-names>C</given-names></name><name><surname>Diskin</surname><given-names>R</given-names></name><name><surname>Gruell</surname><given-names>H</given-names></name><name><surname>Becker</surname><given-names>S</given-names></name><name><surname>Klein</surname><given-names>F</given-names></name></person-group><year iso-8601-date="2020">2020</year><article-title>Longitudinal isolation of potent near-germline SARS-CoV-2-neutralizing antibodies from COVID-19 patients</article-title><source>Cell</source><volume>182</volume><fpage>843</fpage><lpage>854</lpage><pub-id pub-id-type="doi">10.1016/j.cell.2020.06.044</pub-id><pub-id pub-id-type="pmid">32673567</pub-id></element-citation></ref><ref id="bib21"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lindenbaum</surname><given-names>O</given-names></name><name><surname>Nouri</surname><given-names>N</given-names></name><name><surname>Kluger</surname><given-names>Y</given-names></name><name><surname>Kleinstein</surname><given-names>SH</given-names></name></person-group><year iso-8601-date="2021">2021</year><article-title>Alignment free identification of clones in B cell receptor repertoires</article-title><source>Nucleic Acids Research</source><volume>49</volume><elocation-id>e21</elocation-id><pub-id pub-id-type="doi">10.1093/nar/gkaa1160</pub-id><pub-id pub-id-type="pmid">33330933</pub-id></element-citation></ref><ref id="bib22"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lupo</surname><given-names>C</given-names></name><name><surname>Spisak</surname><given-names>N</given-names></name><name><surname>Walczak</surname><given-names>AM</given-names></name><name><surname>Mora</surname><given-names>T</given-names></name></person-group><year iso-8601-date="2022">2022</year><article-title>Learning the statistics and landscape of somatic mutation-induced insertions and deletions in antibodies</article-title><source>PLOS Computational Biology</source><volume>18</volume><elocation-id>e1010167</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pcbi.1010167</pub-id><pub-id pub-id-type="pmid">35653375</pub-id></element-citation></ref><ref id="bib23"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Marcou</surname><given-names>Q</given-names></name><name><surname>Mora</surname><given-names>T</given-names></name><name><surname>Walczak</surname><given-names>AM</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>High-throughput immune repertoire analysis with IGoR</article-title><source>Nature Communications</source><volume>9</volume><elocation-id>561</elocation-id><pub-id pub-id-type="doi">10.1038/s41467-018-02832-w</pub-id><pub-id pub-id-type="pmid">29422654</pub-id></element-citation></ref><ref id="bib24"><element-citation publication-type="preprint"><person-group person-group-type="author"><name><surname>Mayer</surname><given-names>A</given-names></name><name><surname>Callan</surname><given-names>CG</given-names></name></person-group><year iso-8601-date="2022">2022</year><article-title>Measures of epitope binding degeneracy from T cell receptor repertoires</article-title><source>bioRxiv</source><pub-id pub-id-type="doi">10.1101/2022.07.25.501373</pub-id></element-citation></ref><ref id="bib25"><element-citation publication-type="book"><person-group person-group-type="author"><name><surname>Meilă</surname><given-names>M</given-names></name></person-group><year iso-8601-date="2003">2003</year><source>Comparing Clusterings by the Variation of Information</source><publisher-name>Springer</publisher-name><pub-id pub-id-type="doi">10.1007/978-3-540-45167-9_14</pub-id></element-citation></ref><ref id="bib26"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Mesin</surname><given-names>L</given-names></name><name><surname>Ersching</surname><given-names>J</given-names></name><name><surname>Victora</surname><given-names>GD</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Germinal center B cell dynamics</article-title><source>Immunity</source><volume>45</volume><fpage>471</fpage><lpage>482</lpage><pub-id pub-id-type="doi">10.1016/j.immuni.2016.09.001</pub-id><pub-id pub-id-type="pmid">27653600</pub-id></element-citation></ref><ref id="bib27"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Murugan</surname><given-names>A</given-names></name><name><surname>Mora</surname><given-names>T</given-names></name><name><surname>Walczak</surname><given-names>AM</given-names></name><name><surname>Callan</surname><given-names>CG</given-names><suffix>Jr</suffix></name></person-group><year iso-8601-date="2012">2012</year><article-title>Statistical inference of the generation probability of T-cell receptors from sequence repertoires</article-title><source>PNAS</source><volume>109</volume><fpage>16161</fpage><lpage>16166</lpage><pub-id pub-id-type="doi">10.1073/pnas.1212755109</pub-id><pub-id pub-id-type="pmid">22988065</pub-id></element-citation></ref><ref id="bib28"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Navarro</surname><given-names>G</given-names></name></person-group><year iso-8601-date="2001">2001</year><article-title>A guided tour to approximate string matching</article-title><source>ACM Computing Surveys</source><volume>33</volume><fpage>31</fpage><lpage>88</lpage><pub-id pub-id-type="doi">10.1145/375360.375365</pub-id></element-citation></ref><ref id="bib29"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Nielsen</surname><given-names>SCA</given-names></name><name><surname>Yang</surname><given-names>F</given-names></name><name><surname>Jackson</surname><given-names>KJL</given-names></name><name><surname>Hoh</surname><given-names>RA</given-names></name><name><surname>Röltgen</surname><given-names>K</given-names></name><name><surname>Jean</surname><given-names>GH</given-names></name><name><surname>Stevens</surname><given-names>BA</given-names></name><name><surname>Lee</surname><given-names>JY</given-names></name><name><surname>Rustagi</surname><given-names>A</given-names></name><name><surname>Rogers</surname><given-names>AJ</given-names></name><name><surname>Powell</surname><given-names>AE</given-names></name><name><surname>Hunter</surname><given-names>M</given-names></name><name><surname>Najeeb</surname><given-names>J</given-names></name><name><surname>Otrelo-Cardoso</surname><given-names>AR</given-names></name><name><surname>Yost</surname><given-names>KE</given-names></name><name><surname>Daniel</surname><given-names>B</given-names></name><name><surname>Nadeau</surname><given-names>KC</given-names></name><name><surname>Chang</surname><given-names>HY</given-names></name><name><surname>Satpathy</surname><given-names>AT</given-names></name><name><surname>Jardetzky</surname><given-names>TS</given-names></name><name><surname>Kim</surname><given-names>PS</given-names></name><name><surname>Wang</surname><given-names>TT</given-names></name><name><surname>Pinsky</surname><given-names>BA</given-names></name><name><surname>Blish</surname><given-names>CA</given-names></name><name><surname>Boyd</surname><given-names>SD</given-names></name></person-group><year iso-8601-date="2020">2020</year><article-title>Human B cell clonal expansion and convergent antibody responses to SARS-CoV-2</article-title><source>Cell Host &amp; Microbe</source><volume>28</volume><fpage>516</fpage><lpage>525</lpage><pub-id pub-id-type="doi">10.1016/j.chom.2020.09.002</pub-id><pub-id pub-id-type="pmid">32941787</pub-id></element-citation></ref><ref id="bib30"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Nouri</surname><given-names>N</given-names></name><name><surname>Kleinstein</surname><given-names>SH</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>A spectral clustering-based method for identifying clones from high-throughput B cell repertoire sequencing data</article-title><source>Bioinformatics</source><volume>34</volume><fpage>i341</fpage><lpage>i349</lpage><pub-id pub-id-type="doi">10.1093/bioinformatics/bty235</pub-id><pub-id pub-id-type="pmid">29949968</pub-id></element-citation></ref><ref id="bib31"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Nouri</surname><given-names>N</given-names></name><name><surname>Kleinstein</surname><given-names>SH</given-names></name></person-group><year iso-8601-date="2020">2020</year><article-title>Somatic hypermutation analysis for improved identification of B cell clonal families from next-generation sequencing data</article-title><source>PLOS Computational Biology</source><volume>16</volume><elocation-id>e1007977</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pcbi.1007977</pub-id><pub-id pub-id-type="pmid">32574157</pub-id></element-citation></ref><ref id="bib32"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Nourmohammad</surname><given-names>A</given-names></name><name><surname>Otwinowski</surname><given-names>J</given-names></name><name><surname>Łuksza</surname><given-names>M</given-names></name><name><surname>Mora</surname><given-names>T</given-names></name><name><surname>Walczak</surname><given-names>AM</given-names></name></person-group><year iso-8601-date="2019">2019</year><article-title>Fierce selection and interference in B-cell repertoire response to chronic HIV-1</article-title><source>Molecular Biology and Evolution</source><volume>36</volume><fpage>2184</fpage><lpage>2194</lpage><pub-id pub-id-type="doi">10.1093/molbev/msz143</pub-id><pub-id pub-id-type="pmid">31209469</pub-id></element-citation></ref><ref id="bib33"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ralph</surname><given-names>DK</given-names></name><name><surname>Matsen</surname><given-names>FA</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Likelihood-based inference of B cell clonal families</article-title><source>PLOS Computational Biology</source><volume>12</volume><elocation-id>e1005086</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pcbi.1005086</pub-id></element-citation></ref><ref id="bib34"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ralph</surname><given-names>DK</given-names></name><name><surname>Matsen</surname><given-names>FA</given-names></name></person-group><year iso-8601-date="2022">2022</year><article-title>Inference of B cell clonal families using heavy/light chain pairing information</article-title><source>PLOS Computational Biology</source><volume>18</volume><elocation-id>e1010723</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pcbi.1010723</pub-id><pub-id pub-id-type="pmid">36441808</pub-id></element-citation></ref><ref id="bib35"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ruiz Ortega</surname><given-names>M</given-names></name><name><surname>Spisak</surname><given-names>N</given-names></name><name><surname>Mora</surname><given-names>T</given-names></name><name><surname>Walczak</surname><given-names>AM</given-names></name></person-group><year iso-8601-date="2023">2023</year><article-title>Modeling and predicting the overlap of B- and T-cell receptor repertoires in healthy and SARS-CoV-2 infected individuals</article-title><source>PLOS Genetics</source><volume>19</volume><elocation-id>e1010652</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pgen.1010652</pub-id><pub-id pub-id-type="pmid">36827454</pub-id></element-citation></ref><ref id="bib36"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Saini</surname><given-names>J</given-names></name><name><surname>Hershberg</surname><given-names>U</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>B cell Variable genes have evolved their codon usage to focus the targeted patterns of somatic mutation on the complementarity determining regions</article-title><source>Molecular Immunology</source><volume>65</volume><fpage>157</fpage><lpage>167</lpage><pub-id pub-id-type="doi">10.1016/j.molimm.2015.01.001</pub-id></element-citation></ref><ref id="bib37"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Schatz</surname><given-names>DG</given-names></name><name><surname>Swanson</surname><given-names>PC</given-names></name></person-group><year iso-8601-date="2011">2011</year><article-title>V(D)J recombination: mechanisms of initiation</article-title><source>Annual Review of Genetics</source><volume>45</volume><fpage>167</fpage><lpage>202</lpage><pub-id pub-id-type="doi">10.1146/annurev-genet-110410-132552</pub-id><pub-id pub-id-type="pmid">21854230</pub-id></element-citation></ref><ref id="bib38"><element-citation publication-type="preprint"><person-group person-group-type="author"><name><surname>Sethna</surname><given-names>Z</given-names></name><name><surname>Isacchini</surname><given-names>G</given-names></name><name><surname>Dupic</surname><given-names>T</given-names></name><name><surname>Mora</surname><given-names>T</given-names></name><name><surname>Walczak</surname><given-names>AM</given-names></name><name><surname>Elhanati</surname><given-names>Y</given-names></name></person-group><year iso-8601-date="2020">2020</year><article-title>Population variability in the generation and thymic selection of T-cell repertoires</article-title><source>bioRxiv</source><pub-id pub-id-type="doi">10.1101/2020.01.08.899682</pub-id></element-citation></ref><ref id="bib39"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Spisak</surname><given-names>N</given-names></name><name><surname>Walczak</surname><given-names>AM</given-names></name><name><surname>Mora</surname><given-names>T</given-names></name></person-group><year iso-8601-date="2020">2020</year><article-title>Learning the heterogeneous hypermutation landscape of immunoglobulins from high-throughput repertoire data</article-title><source>Nucleic Acids Research</source><volume>48</volume><fpage>10702</fpage><lpage>10712</lpage><pub-id pub-id-type="doi">10.1093/nar/gkaa825</pub-id><pub-id pub-id-type="pmid">33035336</pub-id></element-citation></ref><ref id="bib40"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Tas</surname><given-names>JMJ</given-names></name><name><surname>Mesin</surname><given-names>L</given-names></name><name><surname>Pasqual</surname><given-names>G</given-names></name><name><surname>Targ</surname><given-names>S</given-names></name><name><surname>Jacobsen</surname><given-names>JT</given-names></name><name><surname>Mano</surname><given-names>YM</given-names></name><name><surname>Chen</surname><given-names>CS</given-names></name><name><surname>Weill</surname><given-names>J-C</given-names></name><name><surname>Reynaud</surname><given-names>C-A</given-names></name><name><surname>Browne</surname><given-names>EP</given-names></name><name><surname>Meyer-Hermann</surname><given-names>M</given-names></name><name><surname>Victora</surname><given-names>GD</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Visualizing antibody affinity maturation in germinal centers</article-title><source>Science</source><volume>351</volume><fpage>1048</fpage><lpage>1054</lpage><pub-id pub-id-type="doi">10.1126/science.aad3439</pub-id><pub-id pub-id-type="pmid">26912368</pub-id></element-citation></ref><ref id="bib41"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Turner</surname><given-names>JS</given-names></name><name><surname>Zhou</surname><given-names>JQ</given-names></name><name><surname>Han</surname><given-names>J</given-names></name><name><surname>Schmitz</surname><given-names>AJ</given-names></name><name><surname>Rizk</surname><given-names>AA</given-names></name><name><surname>Alsoussi</surname><given-names>WB</given-names></name><name><surname>Lei</surname><given-names>T</given-names></name><name><surname>Amor</surname><given-names>M</given-names></name><name><surname>McIntire</surname><given-names>KM</given-names></name><name><surname>Meade</surname><given-names>P</given-names></name><name><surname>Strohmeier</surname><given-names>S</given-names></name><name><surname>Brent</surname><given-names>RI</given-names></name><name><surname>Richey</surname><given-names>ST</given-names></name><name><surname>Haile</surname><given-names>A</given-names></name><name><surname>Yang</surname><given-names>YR</given-names></name><name><surname>Klebert</surname><given-names>MK</given-names></name><name><surname>Suessen</surname><given-names>T</given-names></name><name><surname>Teefey</surname><given-names>S</given-names></name><name><surname>Presti</surname><given-names>RM</given-names></name><name><surname>Krammer</surname><given-names>F</given-names></name><name><surname>Kleinstein</surname><given-names>SH</given-names></name><name><surname>Ward</surname><given-names>AB</given-names></name><name><surname>Ellebedy</surname><given-names>AH</given-names></name></person-group><year iso-8601-date="2020">2020</year><article-title>Human germinal centres engage memory and naive B cells after influenza vaccination</article-title><source>Nature</source><volume>586</volume><fpage>127</fpage><lpage>132</lpage><pub-id pub-id-type="doi">10.1038/s41586-020-2711-0</pub-id><pub-id pub-id-type="pmid">32866963</pub-id></element-citation></ref><ref id="bib42"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Uduman</surname><given-names>M</given-names></name><name><surname>Shlomchik</surname><given-names>MJ</given-names></name><name><surname>Vigneault</surname><given-names>F</given-names></name><name><surname>Church</surname><given-names>GM</given-names></name><name><surname>Kleinstein</surname><given-names>SH</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Integrating B cell lineage information into statistical tests for detecting selection in Ig sequences</article-title><source>Journal of Immunology</source><volume>192</volume><fpage>867</fpage><lpage>874</lpage><pub-id pub-id-type="doi">10.4049/jimmunol.1301551</pub-id><pub-id pub-id-type="pmid">24376267</pub-id></element-citation></ref><ref id="bib43"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Vander Heiden</surname><given-names>JA</given-names></name><name><surname>Yaari</surname><given-names>G</given-names></name><name><surname>Uduman</surname><given-names>M</given-names></name><name><surname>Stern</surname><given-names>JNH</given-names></name><name><surname>O’Connor</surname><given-names>KC</given-names></name><name><surname>Hafler</surname><given-names>DA</given-names></name><name><surname>Vigneault</surname><given-names>F</given-names></name><name><surname>Kleinstein</surname><given-names>SH</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>pRESTO: A toolkit for processing high-throughput sequencing raw reads of lymphocyte receptor repertoires</article-title><source>Bioinformatics</source><volume>30</volume><fpage>1930</fpage><lpage>1932</lpage><pub-id pub-id-type="doi">10.1093/bioinformatics/btu138</pub-id><pub-id pub-id-type="pmid">24618469</pub-id></element-citation></ref><ref id="bib44"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Victora</surname><given-names>GD</given-names></name><name><surname>Nussenzweig</surname><given-names>MC</given-names></name></person-group><year iso-8601-date="2022">2022</year><article-title>Germinal centers</article-title><source>Annual Review of Immunology</source><volume>40</volume><fpage>413</fpage><lpage>442</lpage><pub-id pub-id-type="doi">10.1146/annurev-immunol-120419-022408</pub-id></element-citation></ref><ref id="bib45"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Yaari</surname><given-names>G</given-names></name><name><surname>Uduman</surname><given-names>M</given-names></name></person-group><year iso-8601-date="2012">2012</year><article-title>Quantifying selection in high-throughput immunoglobulin sequencing data sets</article-title><source>Nucleic Acids Research</source><volume>40</volume><elocation-id>e134</elocation-id><pub-id pub-id-type="doi">10.1093/nar/gkn000</pub-id></element-citation></ref><ref id="bib46"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Yaari</surname><given-names>G</given-names></name><name><surname>Kleinstein</surname><given-names>SH</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Practical guidelines for B-cell receptor repertoire sequencing analysis</article-title><source>Genome Medicine</source><volume>7</volume><elocation-id>121</elocation-id><pub-id pub-id-type="doi">10.1186/s13073-015-0243-2</pub-id><pub-id pub-id-type="pmid">26589402</pub-id></element-citation></ref><ref id="bib47"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ye</surname><given-names>J</given-names></name><name><surname>Ma</surname><given-names>N</given-names></name><name><surname>Madden</surname><given-names>TL</given-names></name><name><surname>Ostell</surname><given-names>JM</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>IgBLAST: an immunoglobulin variable domain sequence analysis tool</article-title><source>Nucleic Acids Research</source><volume>41</volume><fpage>W34</fpage><lpage>W40</lpage><pub-id pub-id-type="doi">10.1093/nar/gkt382</pub-id><pub-id pub-id-type="pmid">23671333</pub-id></element-citation></ref><ref id="bib48"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zurek</surname><given-names>WH</given-names></name></person-group><year iso-8601-date="1989">1989</year><article-title>Thermodynamic cost of computation, algorithmic complexity and the information metric</article-title><source>Nature</source><volume>341</volume><fpage>119</fpage><lpage>124</lpage><pub-id pub-id-type="doi">10.1038/341119a0</pub-id></element-citation></ref></ref-list></back><sub-article article-type="editor-report" id="sa0"><front-stub><article-id pub-id-type="doi">10.7554/eLife.86181.sa0</article-id><title-group><article-title>Editor's evaluation</article-title></title-group><contrib-group><contrib contrib-type="author"><name><surname>Cowell</surname><given-names>Lindsay</given-names></name><role specific-use="editor">Reviewing Editor</role><aff><institution-wrap><institution-id institution-id-type="ror">https://ror.org/05byvp690</institution-id><institution>The University of Texas Southwestern Medical Center</institution></institution-wrap><country>United States</country></aff></contrib></contrib-group><related-object id="sa0ro1" object-id-type="id" object-id="10.1101/2022.12.22.521661" link-type="continued-by" xlink:href="https://sciety.org/articles/activity/10.1101/2022.12.22.521661"/></front-stub><body><p>This fundamental study provides a new, high-performance algorithm for B-cell clonal family inference. The new algorithm is highly innovative and based on a rigorous probabilistic analysis of the relevant biological processes and their imprint on the resulting sequences. The strength of evidence regarding the algorithm's performance is convincing, as the algorithm has been benchmarked against two state-of-the-art methods for clonal family inference on two synthetic data sets generated with two independent, state-of-the-art methods for B cell repertoire simulation. This work will be fundamental to immunologists and important to any researcher or clinician utilizing B cell receptor repertoires in their field.</p></body></sub-article><sub-article article-type="decision-letter" id="sa1"><front-stub><article-id pub-id-type="doi">10.7554/eLife.86181.sa1</article-id><title-group><article-title>Decision letter</article-title></title-group><contrib-group content-type="section"><contrib contrib-type="editor"><name><surname>Cowell</surname><given-names>Lindsay</given-names></name><role>Reviewing Editor</role><aff><institution-wrap><institution-id institution-id-type="ror">https://ror.org/05byvp690</institution-id><institution>The University of Texas Southwestern Medical Center</institution></institution-wrap><country>United States</country></aff></contrib></contrib-group><contrib-group><contrib contrib-type="reviewer"><name><surname>Matsen</surname><given-names>Frederick A</given-names></name><role>Reviewer</role><aff><institution>Fred Hutchinson Cancer Research Center</institution><country>United States</country></aff></contrib><contrib contrib-type="reviewer"><name><surname>Hoehn</surname><given-names>Kenneth</given-names></name><role>Reviewer</role><aff><institution-wrap><institution-id institution-id-type="ror">https://ror.org/049s0rh22</institution-id><institution>Dartmouth College</institution></institution-wrap><country>United States</country></aff></contrib></contrib-group></front-stub><body><boxed-text id="sa2-box1"><p>Our editorial process produces two outputs: i) <ext-link ext-link-type="uri" xlink:href="https://sciety.org/articles/activity/10.1101/2022.12.22.521661">public reviews</ext-link> designed to be posted alongside <ext-link ext-link-type="uri" xlink:href="https://www.biorxiv.org/content/10.1101/2022.12.22.521661v1">the preprint</ext-link> for the benefit of readers; ii) feedback on the manuscript for the authors, including requests for revisions, shown below. We also include an acceptance summary that explains what the editors found interesting or important about the work.</p></boxed-text><p><bold>Decision letter after peer review:</bold></p><p>Thank you for submitting your article &quot;Combining mutation and recombination statistics to infer clonal families in antibody repertoires&quot; for consideration by <italic>eLife</italic>. Your article has been reviewed by 3 peer reviewers, one of whom is a member of our Board of Reviewing Editors, and the evaluation has been overseen by Miles Davenport as the Senior Editor. The following individuals involved in the review of your submission have agreed to reveal their identity: Frederick A Matsen (Reviewer #2); Kenneth B Hoehn (Reviewer #3).</p><p>The reviewers have discussed their reviews with one another, and the Reviewing Editor has drafted this to help you prepare a revised submission.</p><p>Essential revisions:</p><p>1) Provide clarification regarding how different data sets (synthetic versus real) were used for different steps during algorithm development and validation, perhaps by including a flow chart of inputs/outputs/dependencies.</p><p>2) Conduct an evaluation that is not circular, such as using additional simulated data sets beyond the one based on the same data used to develop the method.</p><p>3) Provide details about the versions and settings of the competitor programs included in the benchmarking, as well as other general information such as: what type of machine was used? Was the use of multiple threads enabled for all programs? When multiple methods are available within a single program (e.g., scoper), indicate which were used and justify the choice. Etc.</p><p>4) Make the synthetic data publicly available as well as the scripts used for the benchmarking analysis.</p><p>5) Define &quot;precision&quot; prominently and use it in that sense consistently throughout the manuscript.</p><p><italic>Reviewer #1 (Recommendations for the authors):</italic></p><p>Regarding point 1 in the public review, examples of more specific questions along these lines are included below. A flow chart figure showing the steps, data inputs, and parameter outputs would clarify the presentation and may in turn resolve any concerns about the strength of evidence.</p><p>Additional Major Comments/Questions</p><p>1) The data in reference [1] derive from RNA-seq. The authors mention the use of UMIs to correct PCR amplification, but how do they deconvolute clonal expansion from transcript abundance? This is a major issue when using RNA-seq data for which cells were not barcoded.</p><p>2) It is not clear what data is being used for which procedures. When is real data being used versus when is synthetic data being used?</p><p>a) Page 3: &quot;Fitting is performed with an expectation-maximization algorithm which finds maximum-likelihood estimates of the prevalence ˆρ and mean intrafamily distance ˆµ for each VJl class.&quot; Was the fit with synthetic data generated using soNNia, as indicated for P0(x)? Or real data from [1], as indicated in Figure 1A?</p><p>b) Page 3: What data were used for Figures 1B-1I? Data from reference [1] are used in A, and the dashed lines in J are from synthetic data. What about the rest? All from [1]?</p><p>c) Similar questions persist throughout.</p><p>3) The authors need to be clear when they are drawing conclusions from real data versus from synthetic data. And in general, real data should be used as much as possible, since synthetic data is limited due to the generation process being based only on what we think we already know. On the other hand, I understand that for real data, we don't ever have gold standard labels, so a careful balance of the two is needed.</p><p>a) Page 3: &quot;P0(x) = P0(x|l) is computed for each length l by generating a large number of unrelated, same-length sequences with the soNNia model of recombination and selection [19], and calculating the distribution of their pairwise distances.&quot; How does this compare to using real data? What if you, e.g., take all singletons in a real dataset? Wouldn't that also approximate P0(x)? Figure 2G shows the peak of the distribution of x at 0.5, half of all nucleotide positions differ; assuming this is from simulated data, is this what you would get with real data? Or vice versa.</p><p>b) Page 3: &quot;The results of the fit show that ˆµ varies little between VJl classes, around ˆµ ∼ 4%.&quot; Is this based on real or synthetic data? If synthetic data, does this just depend on how you wrote the generation process? This may be related to the questions below regarding how mutations were identified and characterized and then applied in the data generation process.</p><p>c) Page 3: &quot;In contrast, the prevalence ˆρ varies widely across classes&quot;. Again, real or synthetic data? If synthetic, doesn't this depend on the generation process? If real data, is there any association with l?</p><p>d) Similar questions persist throughout.</p><p>4) Page 4: &quot;it is expected to fail when the prevalence and the CDR3 length are both low.&quot; A single value rho can encompass a large number of small clones or a small number of large clones, but rho seems to be treated in the model as a repertoire level rho, the proportion of all pairs that are related. How does this impact the interpretation/expectation of the approach's performance across different tissue types or B cell subsets that may be expected to have very different clonal distributions that are averaged out to a single rho in the model?</p><p>5) Page 4: &quot;We first estimated the distribution of clonal family sizes from the data of [1] by applying the CDR3-based clustering method with adaptive threshold.… to VJl classes for which.… the predicted sensitivity was &gt;90%.&quot; Does this mean VJl classes with e.g., l&gt;30? (inferring from Figure 2I) Or what does this mean? Could focusing only on these clusters bias the estimated distribution of clone sizes?</p><p>6) Page 4: &quot;For each lineage we draw a random progenitor using soNNia&quot;. I assume these are lineages for the synthetic data, but it isn't clear from the text that you aren't sampling from the lineages created for [1]. Similarly, on page 10: &quot;To generate synthetic data we make use of the lineages identified in the high-sensitivity and high-precision regime of CDR3-based inference (Figure 3F), we denote the set of these lineages by L.&quot; That means you use the lineages identified in the data from [1]? And should the figure reference be 3E?</p><p>7) Page 4: &quot;Mutations are then randomly drawn on each sequence of the lineage in a way that preserves the mutation sharing patterns observed in families of comparable size from the partitioned data&quot;. What partitioned data? Data from reference [1]? And how were the mutation patterns characterized so they could be replicated? From page 10: &quot;We then identify all unique mutations in the true lineage and for each mutation denote the labels of members of the lineage that carry it.&quot; How are &quot;all unique mutations in the true lineage&quot; identified at scale? And how is the &quot;true lineage&quot; identified? Using the approach being developed, I think, so this all seems a bit circular.…</p><p>8) Page 11: &quot;We compute the expected distributions of the CDR3 Hamming distance n, and the number of shared mutations n0, under a uniform mutation rate assumption. In other words, we assume that the probability that a given position was mutated, given a mutation happened somewhere in a sequence of length L, equals L^{-1}.&quot; I think it is well-known that this is not the case. What are the implications for the evaluation of model performance?</p><p><italic>Reviewer #2 (Recommendations for the authors):</italic></p><p>Please add line numbers: they make reviewing much easier.</p><p>Overall it would be helpful to understand how &quot;precision&quot; is used. &quot;High-precision&quot; comes up a lot, including in the HILARy acronym, and it seems that sometimes it's used as a synonym for accuracy. Or is it literally &quot;precision&quot; in the technical sense, i.e. contrasted to recall/sensitivity?</p><p>The mathematical exposition is nicely laid out. However, the choices of symbols can make it difficult to follow, and the reader has to keep a lot of arbitrarily-chosen notation in their head to follow and read figures. A notation table would help, as would more self-explanatory naming choices for key variables like x, y, n, and n_0. For example, it would make things easier to read to use something like P_F rather than P_0, and P_T rather than P_1. 0 and 1 subscripts are used in a different context when used as a subscript in equation (4), which makes this equation difficult to parse: sometimes 1 means the number of mutations in sequence 1, and sometimes it means the same-lineage assumption.</p><p>Results</p><p>A</p><p>- &quot;which consists in&quot; suggest &quot;which consists of&quot;</p><p>- prevalence is a key definition, and right now it's tacked onto the end of a sentence. Suggest making it a stand-alone definition for clarity.</p><p>- &quot;share the same V and J gene usage&quot; suggest &quot;share the same V and J genes&quot;</p><p>- &quot;The signature of the VDJ rearrangement is largely encoded by the CDR3 alone&quot; this statement seems over-strong-- the parts of V genes within the CDR3 are frequently identical.</p><p>- Productive sequences are often defined as not only cdr3 length divisible by 3, but also V and J in frame (indels could change that).</p><p>- &quot;same-length sequences with the soNNia model&quot;: do these include mutation?</p><p>- If I understand correctly the Poisson distribution models the distribution of distances within a clonal family, and so mu is a function of the distribution of the number of somatic hypermutations. If this is correct, it would be helpful to include this interpretation.</p><p>- &quot;μ varies little between VJl classes, around ˆμ ∼ 4%&quot;: suggest using $\simeq$ for approximate as done below</p><p>- &quot;that the positive mode P1(x) of the distribution varies little,&quot; suggest &quot;… the mode of the positive distribution P_1(x)&quot;</p><p>B</p><p>- Suggest mentioning that the results here depend on the level of SHM.</p><p>C</p><p>- &quot;verify that these performance predictions hold in real inference tasks&quot;: I would recommend &quot;realistic&quot; rather than &quot;real&quot;, the latter of which sounds like you mean real data.</p><p>D</p><p>- Below (4), _1 should be _1.</p><p>- Suggest using more precise language to define n rather than &quot;divergence&quot;, describing that this is about pairs of sequences.</p><p>- &quot;computationally expansive&quot; should be &quot;computationally expensive&quot;</p><p>Figure 3</p><p>- What causes the three bent stripes in C?</p><p>- It would be really interesting to know how this plot changes with SHM: in C, higher SHM will result in more divergence among positive CDR3s (more density at higher x).</p><p>Perhaps this will be offset by more shared mutation (i.e. maybe new high-SHM points will stay above your straight line x'-y=t'), but it would be really great to find out.</p><p>- I don't think it's clear either here or in the text what is actually done with the high-precision and high-sensitivity partitions.</p><p>The bottom right of p5 (in Results) partially explains a use for the high-sensitivity one (but not high-precision), and the D section of Methods describes how to calculate them (but not what is done with them).</p><p>F</p><p>- How was dN/dS calculated? Traditionally this has been done in a maximum-likelihood setting to calculate rates, but is this more of a counting approach?</p><p>Methods</p><p>A</p><p>- &quot;remplates&quot; – &quot;templates&quot;</p><p>- I can't seem to find in reference [32] any measurement of how incorrect V and J assignments affect initial VJl partitioning, could you clarify which figure this is from?</p><p>C</p><p>- &quot;In case of l class&quot;: is there a typo here? I'm not sure what this means.</p><p>- two equal signs in (10)</p><p>D</p><p>- The sentences following &quot;This crude method suffers from inaccuracy as it loses precision in the case of highly-mutated sequences and junctions of short length&quot; describe how your prefix tree implementation speeds up this crude approach, but not how it improves on the accuracy.</p><p>- &quot;standard methods [use a] fixed threshold on Hamming distance divergence&quot;</p><p>The standard methods use a threshold on the fraction of differing CDR3 bases, i.e. the threshold on divergence depends on (is proportional to) CDR3 length.</p><p>- Could you make more explicit how the increased speed allows for an &quot;adaptive threshold&quot;?</p><p>The text after equation (17) seems to suggest that several reruns are involved, but it could be made more clear.</p><p>- I don't understand the purpose of constructing these various partitions.</p><p>Ostensibly they seem to be to help calculate a threshold, but the section seems to finish having just constructed the partitions, without telling me either how they've helped you arrive at a threshold, or why that threshold is so much better than what other methods have used.</p><p>F</p><p>(24) I think there should also be an approximate equals sign in the first line in this equation because we are substituting in the approximate value of p</p><p>(25) Suggest pointing out that this follows because we are approximating the distribution as Poisson</p><p>- suggest &quot;analogously&quot; rather than &quot;analogically&quot; https://english.stackexchange.com/questions/112149/analogous-vs-analogical</p><p>- &quot;is chosen based on the prevalence, analogically to adaptive threshold&quot;</p><p>I think you're missing a prime after the t in the inequality in this sentence</p><p>- &quot;and further assume n0 ∼ n1n2 L to compute the new null distribution&quot;</p><p>I think that this tilde means &quot;is distributed as&quot; because n_1 and n_2 are random variables. A little clarification would help here.</p><p><italic>Reviewer #3 (Recommendations for the authors):</italic></p><p>In addition to the recommendations in the public review, we had the following more questions and recommendations:</p><p>P. 2 &quot;Low prevalence is usually due to a high frequency of singletons&quot; Can the authors demonstrate this, or provide a citation?</p><p>P. 2 &quot;In addition, we restrict our analysis to CDR3 lengths between 15 and 105: shorter or longer junctions have comparable frequencies to nonproductive junctions, suggesting that they are nonfunctional.&quot; This should be shown somewhere or given a citation.</p><p>P. 3 It is not clear how mu can vary so little but rho can vary so much</p><p>P. 3 use of rho_hat and p_hat is confusing</p><p>It would be helpful to see more descriptive statistics of the simulated data, such as the level of somatic hypermutation.</p><p>Figure 1 B. From the coloring of the tree/cluster, it looks like two sequences are left out of the tree.</p><p>P. 9 Throughout the paper, does &quot;distance&quot; always refer to Hamming distance?</p><p>P. 11 Uniform mutation probabilities across BCRs is not biologically realistic, given SHM hotspots as well as CDR and FWR regions. We understand this was a simplifying assumption, but it should be discussed.</p><p>P. 11 Potential typo: x' – y &lt;= t. Should this be x' – y &lt;= t'?</p><p>[Editors' note: further revisions were suggested prior to acceptance, as described below.]</p><p>Thank you for resubmitting your work entitled &quot;Combining mutation and recombination statistics to infer clonal families in antibody repertoires&quot; for further consideration by <italic>eLife</italic>. Your revised article has been evaluated by Miles Davenport (Senior Editor) and a Reviewing Editor.</p><p>The manuscript has been improved but there are some remaining issues that need to be addressed, as outlined below:</p><p><italic>Reviewer 2</italic></p><p>We thank the authors for their careful consideration of our comments, and for the many changes that they have implemented. Our main concerns have been addressed, although we have several minor comments.</p><p>The authors have made a huge improvement to the documentation and useability. A minor point, however, is that the result file seems to mostly be in AIRR format, except that the AIRR-standard 'clone_id' column for clonal family information seems to be either absent or copied from the input file, while an undocumented 'family' column appears to hold the inferred family information. This is confusing.</p><p>It would be wonderful if the authors chose to go for AIRR software certification as described in https://docs.airr-community.org/en/latest/swtools/airr_swtools_standard.html</p><p>We agree that HILARy makes a very real performance improvement in distinguishing similar, but unrelated, families, which is a substantial advance. However, in digging through things a bit more, the paper doesn't seem to clearly communicate how frequently settings arise in which HILARy is substantially different than existing software.</p><p>First, the performance plots in Figure 4 only show performance for half of CDR3 lengths (15-45, compared to 15-80 shown in the CDR3 distribution in Figure 6a).</p><p>Furthermore, the CDR3 lengths at which other methods perform significantly worse than HILARy (lengths 15-24) constitute less than one percent of a typical repertoire (see for instance Figure 6a). While it's true that it can make sense to emphasize challenging regions of parameter space, it would seem reasonable to clarify that this is what is being presented, as well as showing performance on typical repertoires in order to show the relevant context.</p><p>The simulation samples also seem to use a restricted set of J genes: 80% of sequences are from a single J allele, whereas repertoires more typically use around four J alleles with prevalences of perhaps 10% to 50%. This also has the effect of inflating the number of very similar but unrelated families. This is an example of the risks of focusing on a single data sample for validation.</p><p>We also have one small clarification in response to:</p><p>&quot;We agree that testing the method on a differently generated dataset is a useful check. We should point out, however, that our synthetic dataset is not as biased as it may seem. In particular, it is based on trees from VJl classes that we predicted are very easy to cluster, which means that they are truly faithful to the data, and not dependent on the particular algorithm used to infer them. The big advantage over this synthetic dataset over others is that it recapitulates the power law statistics of clone size distribution, as well as the diversity of mutation rates. To us, it still represents a more useful benchmark than synthetic datasets generated by population genetics models, which miss most of this very broad variability.&quot;</p><p>We just want to clarify that our concern was not that the synthetic sample was biased, but rather that it is risky to rely on any single sample, whether data or simulation, to form the basis of a robust inference method. Any single sample represents only a single set of possible parameter values, whereas we generally want methods to work well on real data samples that exist at a huge variety of different parameter values.</p><p>Also, while deciding when to use synthetic vs real data is a challenging problem, and we don't in general find fault with the authors' choices about this, we do want to point out that the authors' suggestion here that simulation methods cannot mimic data-like clone size distributions or mutation variability (i.e. tree shape) is incorrect. There exist simulation methods that let the user configure these parameters arbitrarily (including using direct inference from data).</p><p><italic>Reviewer 3</italic></p><p>The authors have addressed the major points I brought up in my review, and the revision is definitely improved. With respect to their new benchmarking on single linkage hierarchical clustering (Figure 4, supplement 2), it's not clear to me why they used their own implementation rather than one of the existing tools, or why the thresholds of 0.76, 0.82, and 0.88 were chosen. However, I think these issues could be addressed with text edits. Personally, I'm trying to reconcile the results of this study with a recent and more comprehensive clonal benchmarking study which showed that single linkage clustering worked quite well: https://bmcimmunol.biomedcentral.com/articles/10.1186/s12865-024-00600-8. May be worth adding some discussion about.</p><p>I agree with Reviewer 2 above points about consistency with AIRR format and that (1) the method seems to perform well in a CDR3 space which represents a small fraction of typical repertoire space, so it's not terribly clear how much it improves overall performance, and (2) it's risky to rely on effectively a single dataset to base these conclusions on.</p></body></sub-article><sub-article article-type="reply" id="sa2"><front-stub><article-id pub-id-type="doi">10.7554/eLife.86181.sa2</article-id><title-group><article-title>Author response</article-title></title-group></front-stub><body><disp-quote content-type="editor-comment"><p>Essential revisions:</p><p>1) Provide clarification regarding how different data sets (synthetic versus real) were used for different steps during algorithm development and validation, perhaps by including a flow chart of inputs/outputs/dependencies.</p></disp-quote><p>We have added clarifications throughout, in the main text as well as in the caption of Figure 2, to clarify what is data and what is model. We did not include a flow chart, because it’s hard to think of ways to visualize how data is being used, since it comes in two steps: in the first step, the algorithm devises what thresholds to use using statistics from the data; in the second step, it actually performs the clustering on the data. However, we have heavily edited the text to better explain the procedure. We now summarize the workflows in a series of steps for both methods (HILARy-CDR3 and -full) at the end of their respective sections. We have also added a table of notations to make it easier to follow the steps of the approach.</p><disp-quote content-type="editor-comment"><p>2) Conduct an evaluation that is not circular, such as using additional simulated data sets beyond the one based on the same data used to develop the method.</p></disp-quote><p>We have added a new row of benchmark results to Figure 4 to show the results of the benchmark on an independent, model-generated synthetic dataset from the group that designed the partis method. Our method still performs competitively, on par with partis—which was developed and tested on that dataset—and better than other methods.</p><p>In addition, we have used that dataset to benchmark a new version of HILARy that also uses the light chain. We compare its performance to other methods on the same synthetic dataset from the partis team in new Figure 5 (in the same fashion as Figure 4), and in Figure 4—figure supplement 1 to show the dependence as a function of mutation rate.</p><disp-quote content-type="editor-comment"><p>3) Provide details about the versions and settings of the competitor programs included in the benchmarking, as well as other general information such as: what type of machine was used? Was the use of multiple threads enabled for all programs? When multiple methods are available within a single program (e.g., scoper), indicate which were used and justify the choice. Etc.</p></disp-quote><p>We have added all these details in the Methods section, as well as in the github, where the scripts used are also shared.</p><disp-quote content-type="editor-comment"><p>4) Make the synthetic data publicly available as well as the scripts used for the benchmarking analysis.</p></disp-quote><p>We have made the synthetic data publicly available on zenodo (https://zenodo.org/ records/10676371) and added the scripts used for benchmarking to HILARy’s github.</p><disp-quote content-type="editor-comment"><p>5) Define &quot;precision&quot; prominently and use it in that sense consistently throughout the manuscript.</p></disp-quote><p>By “precision&quot; we mean the statistical measure also called positive predictive value. We added this clarification the first time the word is used in the introduction. This comes in addition to its formal definition in the main text: “precision pi(t), defined as a proportion of true positives among all pairs classified as positive (Figure 2E)”, and illustration by Figure 2E. We have also added a table of notations where precision is clearly defined (second definition).</p><disp-quote content-type="editor-comment"><p>Reviewer #1 (Recommendations for the authors):</p><p>Regarding point 1 in the public review, examples of more specific questions along these lines are included below. A flow chart figure showing the steps, data inputs, and parameter outputs would clarify the presentation and may in turn resolve any concerns about the strength of evidence.</p><p>Additional Major Comments/Questions</p><p>1) The data in reference [1] derive from RNA-seq. The authors mention the use of UMIs to correct PCR amplification, but how do they deconvolute clonal expansion from transcript abundance? This is a major issue when using RNA-seq data for which cells were not barcoded.</p></disp-quote><p>We consider unique sequences and therefore transcript abundance does not influence our downstream analysis. The sizes of clonal families inferred from data [1] are reported in terms of the number of unique sequences.</p><p>We have clarified this point in the methods.</p><disp-quote content-type="editor-comment"><p>2) It is not clear what data is being used for which procedures. When is real data being used versus when is synthetic data being used?</p></disp-quote><p>We have tried to clarify when real data, models, and synthetic data were used. The discussion is subtle, because the null models used to estimate the threshold are themselves fit to data.</p><disp-quote content-type="editor-comment"><p>a) Page 3: &quot;Fitting is performed with an expectation-maximization algorithm which finds maximum-likelihood estimates of the prevalence ˆρ and mean intrafamily distance ˆµ for each VJl class.&quot; Was the fit with synthetic data generated using soNNia, as indicated for P0(x)? Or real data from [1], as indicated in Figure 1A?</p></disp-quote><p>The fit is of the data distribution from [1]. The model-generated P0 (now called P_F) is part of the mixture model along with and P1 (now called P_T).</p><p>We have clarified the fitting procedure and what’s data and model.</p><disp-quote content-type="editor-comment"><p>b) Page 3: What data were used for Figures 1B-1I? Data from reference [1] are used in A, and the dashed lines in J are from synthetic data. What about the rest? All from [1]?</p></disp-quote><p>It is not easy to answer this question because some figures are model prediction, but still based on adjustable parameters that were fit to each VJl class from the data.</p><p>We have tried to clarify the source of the plotted data both in the main text and in the caption. We have added a ref to the donor for Figure 2B, and explained that Figure 2C-F are just illustrative. We have replaced “null” by “model” in Figure 2G. We have explained that Figure 2H-J are estimated a priori from the model for chosen values of mu and rho, which we now say explicitly</p><disp-quote content-type="editor-comment"><p>c) Similar questions persist throughout.</p></disp-quote><p>We hope that the clarifications above will dissipate further ambiguities.</p><disp-quote content-type="editor-comment"><p>3) The authors need to be clear when they are drawing conclusions from real data versus from synthetic data. And in general, real data should be used as much as possible, since synthetic data is limited due to the generation process being based only on what we think we already know. On the other hand, I understand that for real data, we don't ever have gold standard labels, so a careful balance of the two is needed.</p></disp-quote><p>We prioritized simplicity and robustness. The null models were chosen to be simple and/or independently inferred from large datasets (soNNia model). The adjustable (data-driven) part of the model is reduced to the two parameters mu and rho, which are re-learned for each VJl class.</p><p>We have made it clearer what is fitted and with what parameters, and have also added a summary of the flow at the end of the 2nd and 4th sections of the Results.</p><disp-quote content-type="editor-comment"><p>a) Page 3: &quot;P0(x) = P0(x|l) is computed for each length l by generating a large number of unrelated, same-length sequences with the soNNia model of recombination and selection [19], and calculating the distribution of their pairwise distances.&quot; How does this compare to using real data? What if you, e.g., take all singletons in a real dataset? Wouldn't that also approximate P0(x)? Figure 2G shows the peak of the distribution of x at 0.5, half of all nucleotide positions differ; assuming this is from simulated data, is this what you would get with real data? Or vice versa.</p></disp-quote><p>We used soNNia because we found that it was very good at estimating the distribution of sequences (as demonstrated in Ref. 19). Singletons could be biased relative to other sequences. In the method we explore the possibility of computing the distance of sequences belonging to the real data and generated by soNNia as an alternative null model called P’_F. Further tests of the model against real data are beyond the scope of this paper, where the adequacy of our approximations is ultimately measured in terms of performance.</p><disp-quote content-type="editor-comment"><p>b) Page 3: &quot;The results of the fit show that ˆµ varies little between VJl classes, around ˆµ ∼ 4%.&quot; Is this based on real or synthetic data? If synthetic data, does this just depend on how you wrote the generation process? This may be related to the questions below regarding how mutations were identified and characterized and then applied in the data generation process.</p></disp-quote><p>These are real data estimates, or rather from the fit to the data.</p><p>We have now given the data source and given explanations of the fit, to make it clearer that this number is inferred from data.</p><disp-quote content-type="editor-comment"><p>c) Page 3: &quot;In contrast, the prevalence ˆρ varies widely across classes&quot;. Again, real or synthetic data? If synthetic, doesn't this depend on the generation process? If real data, is there any association with l?</p></disp-quote><p>See above. We did not see any association of rho with length.</p><disp-quote content-type="editor-comment"><p>d) Similar questions persist throughout.</p></disp-quote><p>We hope that the clarifications above will dissipate further ambiguities.</p><disp-quote content-type="editor-comment"><p>4) Page 4: &quot;it is expected to fail when the prevalence and the CDR3 length are both low.&quot; A single value rho can encompass a large number of small clones or a small number of large clones, but rho seems to be treated in the model as a repertoire level rho, the proportion of all pairs that are related. How does this impact the interpretation/expectation of the approach's performance across different tissue types or B cell subsets that may be expected to have very different clonal distributions that are averaged out to a single rho in the model?</p></disp-quote><p>rho is inferred for each VLl class, so is not a repertoire-wide property. We have clarified that rho was inferred for each VJl class.</p><p>Repertoire heterogeneity is an interesting question but this (or other) inference procedure does not use subset or tissue information, as that information is often not available. Using phenotypic information to inform clonal inference procedure is a nice idea and could be the object of future work. The fact that most dataset are mixtures of phenotypes, specificities, and immune histories, each with their own clone size distribution and possibly sequence biases, is an inherent difficulty that all lineage clustering algorithms face.</p><disp-quote content-type="editor-comment"><p>5) Page 4: &quot;We first estimated the distribution of clonal family sizes from the data of [1] by applying the CDR3-based clustering method with adaptive threshold.… to VJl classes for which.… the predicted sensitivity was &gt;90%.&quot; Does this mean VJl classes with e.g., l&gt;30? (inferring from Figure 2I) Or what does this mean? Could focusing only on these clusters bias the estimated distribution of clone sizes?</p></disp-quote><p>Operationally, what this means is strictly defined by a predicted sensitivity of &gt;90%, as written in the text. As the reviewer correctly intuits, this correlates with large l, but it also depends on the prevalence inferred for that class (which is fixed in Figure 2I).</p><p>We hope that the earlier clarification about how figure 2 is exactly plotted will have dissipated this confusion.</p><disp-quote content-type="editor-comment"><p>6) Page 4: &quot;For each lineage we draw a random progenitor using soNNia&quot;. I assume these are lineages for the synthetic data, but it isn't clear from the text that you aren't sampling from the lineages created for [1]. Similarly, on page 10: &quot;To generate synthetic data we make use of the lineages identified in the high-sensitivity and high-precision regime of CDR3-based inference (Figure 3F), we denote the set of these lineages by L.&quot; That means you use the lineages identified in the data from [1]? And should the figure reference be 3E?</p></disp-quote><p>We apologize if this procedure was not clearly explained. The only part of the data we used to generate our synthetic data is the lineage size distribution, and the statistics of tree topologies. 3F is the correct reference, as it shows in yellow the sets of prevalences and VJl classes for which sensitivity is high enough for our inclusion criterion.</p><p>We have re-written the explanation in the main text, and have clarified in the Methods that we only use the statistics of tree topologies. We have also clarified that Figure 3F referred to the region above the black line.</p><disp-quote content-type="editor-comment"><p>7) Page 4: &quot;Mutations are then randomly drawn on each sequence of the lineage in a way that preserves the mutation sharing patterns observed in families of comparable size from the partitioned data&quot;. What partitioned data? Data from reference [1]?</p></disp-quote><p>We have clarified that the lineages <inline-formula><mml:math id="sa2m1"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mi class="mathcal" mathvariant="script">L</mml:mi></mml:mrow></mml:mrow></mml:mstyle></mml:math></inline-formula> \mathcal{L} were inferred from data.</p><disp-quote content-type="editor-comment"><p>And how were the mutation patterns characterized so they could be replicated?</p></disp-quote><p>This is explained in the part about the labels of lineage nodes that carry a particular mutation.</p><p>We have added “To create a lineage with the same mutation patterns as the real data…” to explain that this is what it is about.</p><disp-quote content-type="editor-comment"><p>From page 10: &quot;We then identify all unique mutations in the true lineage and for each mutation denote the labels of members of the lineage that carry it.&quot; How are &quot;all unique mutations in the true lineage&quot; identified at scale?</p></disp-quote><p>They are identified using sequence alignment and tree reconstruction methods already described in Spisak et al. (Ref. 33).</p><p>We have rephrased the sentence and added the reference.</p><disp-quote content-type="editor-comment"><p>And how is the &quot;true lineage&quot; identified? Using the approach being developed, I think, so this all seems a bit circular.…</p></disp-quote><p>The true lineages were identified using the “lineages identified in the high- sensitivity and high- precision regime of CDR3-based in- ference from the data (yellow region above the black line in Figure 3F)”, as now better explained in the text.</p><p>The argument is not really circular, because those lineages are for VJl classes for which the inference was highly reliable, because of the high discriminability of positive and negative pairs. Besides, to create the synthetic data the sequences are actually “erased” from the trees, and replaced by entirely new sequences and mutations but respecting the tree topology (or said differently genealogical structure of mutations), including some with much more difficult VJl class.</p><p>We have added an explanation in the main text of why the re-use of real data lineages inferred by HILARy doesn’t bias the procedure, since it’s done on a subset of lineages within VJl classes that are easy to infer.</p><disp-quote content-type="editor-comment"><p>8) Page 11: &quot;We compute the expected distributions of the CDR3 Hamming distance n, and the number of shared mutations n0, under a uniform mutation rate assumption. In other words, we assume that the probability that a given position was mutated, given a mutation happened somewhere in a sequence of length L, equals L^{-1}.&quot; I think it is well-known that this is not the case. What are the implications for the evaluation of model performance?</p></disp-quote><p>This is a simplifying assumption that makes the computation easier. Accounting for the mutatability heterogeneity could only improve the performance of the method.</p><p>We have clarified that this assumption is not meant to be realistic, but computational practical.</p><disp-quote content-type="editor-comment"><p>Reviewer #2 (Recommendations for the authors):</p><p>Please add line numbers: they make reviewing much easier.</p></disp-quote><p>We have added line numbers.</p><disp-quote content-type="editor-comment"><p>Overall it would be helpful to understand how &quot;precision&quot; is used. &quot;High-precision&quot; comes up a lot, including in the HILARy acronym, and it seems that sometimes it's used as a synonym for accuracy. Or is it literally &quot;precision&quot; in the technical sense, i.e. contrasted to recall/sensitivity?</p></disp-quote><p>Precision always refers to the total of true positives over the total of positives TP/(TP+FP), as defined the first time the word appears in the results: “defined as a proportion of true positives among all pairs classified as positive”, and illustrated by Figure 2E.</p><p>We noticed the word precision is also used in the introduction. We added the equivalent term “positive predicted value” there to make clear from the beginning that we refer to a statistical quantity with a standard definition. We have also added a table of definitions of notations where precision is defined again.</p><disp-quote content-type="editor-comment"><p>The mathematical exposition is nicely laid out. However, the choices of symbols can make it difficult to follow, and the reader has to keep a lot of arbitrarily-chosen notation in their head to follow and read figures. A notation table would help, as would more self-explanatory naming choices for key variables like x, y, n, and n_0. For example, it would make things easier to read to use something like P_F rather than P_0, and P_T rather than P_1. 0 and 1 subscripts are used in a different context when used as a subscript in equation (4), which makes this equation difficult to parse: sometimes 1 means the number of mutations in sequence 1, and sometimes it means the same-lineage assumption.</p></disp-quote><p>We have changed P_1 and P_0 to P_F and P_T.</p><p>We have added a table (Table I) with a summary of notations.</p><p>Results</p><p>A</p><disp-quote content-type="editor-comment"><p>- &quot;which consists in&quot; suggest &quot;which consists of&quot;</p><p>Corrected.</p><p>prevalence is a key definition, and right now it's tacked onto the end of a sentence. Suggest making it a stand-alone definition for clarity.</p></disp-quote><p>We have now highlighted that definition of prevalence in its own sentence.</p><disp-quote content-type="editor-comment"><p>Corrected.</p><p>&quot;The signature of the VDJ rearrangement is largely encoded by the CDR3 alone&quot; this statement seems over-strong-- the parts of V genes within the CDR3 are frequently identical.</p></disp-quote><p>We have modified the sentence.</p><p>The statement is that the CDR3 is often enough to distinguish distinct recombination events, and does not imply that the entire CDR3 is variable.</p><disp-quote content-type="editor-comment"><p>- Productive sequences are often defined as not only cdr3 length divisible by 3, but also V and J in frame (indels could change that).</p></disp-quote><p>The reviewer is correct but these sequences, since they entered affinity maturation to receive an indel, were initially productive, and thus belong to what we define as productive lineages, even if they are themselves non productive.</p><p>We have clarified the text that the criterion of productivity is really about the whole lineage, and thus about the ancestral (naive) sequence (which cannot have indels since it’s not mutated yet).</p><disp-quote content-type="editor-comment"><p>- &quot;same-length sequences with the soNNia model&quot;: do these include mutation?</p></disp-quote><p>They do not. However junctional diversity is hard to distinguish for further mutational diversification, and in practice soNNIa is a good model.</p><p>We have clarified this point in the methods.</p><disp-quote content-type="editor-comment"><p>- If I understand correctly the Poisson distribution models the distribution of distances within a clonal family, and so mu is a function of the distribution of the number of somatic hypermutations. If this is correct, it would be helpful to include this interpretation.</p></disp-quote><p>We have added an explanation.</p><disp-quote content-type="editor-comment"><p>- &quot;μ varies little between VJl classes, around ˆμ ∼ 4%&quot;: suggest using $\simeq$ for approximate as done below</p></disp-quote><p>Corrected.</p><disp-quote content-type="editor-comment"><p>- &quot;that the positive mode P1(x) of the distribution varies little,&quot; suggest &quot;… the mode of the positive distribution P_1(x)&quot;</p></disp-quote><p>We have rephrased this sentence after realizing that “mode” is ambiguous, as it may refer to the value of the peak, or the peak itself.</p><disp-quote content-type="editor-comment"><p>B</p><p>- Suggest mentioning that the results here depend on the level of SHM.</p></disp-quote><p>We know interpret mu as a proxy for the SHM. We believe the text clearly explains that all inferences depend on mu, however mu is fairly constant across VJl classes, so that the results actually do not depend much on it.</p><p>At the same time, the reviewer is right that performance may in general depend on mu, which here is fixed in the dataset. We have added a benchmark that allows us to study this dependence. The results are reported in new the Figure 4—figure supplement 1.</p><disp-quote content-type="editor-comment"><p>C</p><p>- &quot;verify that these performance predictions hold in real inference tasks&quot;: I would recommend &quot;realistic&quot; rather than &quot;real&quot;, the latter of which sounds like you mean real data.</p></disp-quote><p>Corrected.</p><disp-quote content-type="editor-comment"><p>D</p><p>- Below (4), _1 should be _1.</p></disp-quote><p>Corrected.</p><disp-quote content-type="editor-comment"><p>- Suggest using more precise language to define n rather than &quot;divergence&quot;, describing that this is about pairs of sequences.</p></disp-quote><p>We replaced it with “distance”.</p><disp-quote content-type="editor-comment"><p>Figure 3</p><p>What causes the three bent stripes in C?</p></disp-quote><p>They correspond to different (discrete) values of the denominator in y, depending on n_0 (n_0=1,2,3,…).</p><disp-quote content-type="editor-comment"><p>- It would be really interesting to know how this plot changes with SHM: in C, higher SHM will result in more divergence among positive CDR3s (more density at higher x).</p><p>Perhaps this will be offset by more shared mutation (i.e. maybe new high-SHM points will stay above your straight line x'-y=t'), but it would be really great to find out.</p></disp-quote><p>We have added new Figure 4—figure supplement 1 to study just that, based on the dataset from Ralph et al. 2022 (used to test partis) where the mutation rate is controllable.</p><disp-quote content-type="editor-comment"><p>- I don't think it's clear either here or in the text what is actually done with the high-precision and high-sensitivity partitions.</p><p>The bottom right of p5 (in Results) partially explains a use for the high-sensitivity one (but not high-precision), and the D section of Methods describes how to calculate them (but not what is done with them).</p></disp-quote><p>The general idea is to reduce computations, in particular of pairwise comparisons, which scale with the square of the number of sequences. The high-sensitivity and high-precision partitions are nested partitions. One is too coarse, and the other is too fine. The full HILARy method is then used to merge fine clusters within the coarse ones.</p><p>We have changed the text in the main text as well as in the methods to explain this better.</p><disp-quote content-type="editor-comment"><p>F</p><p>- How was dN/dS calculated? Traditionally this has been done in a maximum-likelihood setting to calculate rates, but is this more of a counting approach?</p></disp-quote><p>The reviewer is correct. We used the simplest approach, since we were not after estimating the quantity and interpreting its absolute value but only after assessing variability of the distribution over families with a given CDR3 length.</p><p>Methods</p><p>A</p><disp-quote content-type="editor-comment"><p>- &quot;remplates&quot; – &quot;templates&quot;Corrected. - I can't seem to find in reference [32] any measurement of how incorrect V and J assignments affect initial VJl partitioning, could you clarify which figure this is from?</p></disp-quote><p>The statement is not directly whether they affect partitioning but that these events are rare. We have clarified “such indel events”.</p><disp-quote content-type="editor-comment"><p>C</p><p>- &quot;In case of l class&quot;: is there a typo here? I'm not sure what this means.</p></disp-quote><p>We have rephrased the sentence.</p><disp-quote content-type="editor-comment"><p>- two equal signs in (10)</p></disp-quote><p>Corrected.</p><disp-quote content-type="editor-comment"><p>D</p><p>- The sentences following &quot;This crude method suffers from inaccuracy as it loses precision in the case of highly-mutated sequences and junctions of short length&quot; describe how your prefix tree implementation speeds up this crude approach, but not how it improves on the accuracy.</p></disp-quote><p>You’re right that these are separate points. We have removed the “However”.</p><disp-quote content-type="editor-comment"><p>- &quot;standard methods [use a] fixed threshold on Hamming distance divergence&quot;</p><p>The standard methods use a threshold on the fraction of differing CDR3 bases, i.e. the threshold on divergence depends on (is proportional to) CDR3 length.</p></disp-quote><p>Corrected.</p><disp-quote content-type="editor-comment"><p>- Could you make more explicit how the increased speed allows for an &quot;adaptive threshold&quot;?</p><p>The text after equation (17) seems to suggest that several reruns are involved, but it could be made more clear.</p></disp-quote><p>Apologies for the confusion but the adaptive threshold and prefix trees are separate innovations. The prefix tree improves speed, the adaptive threshold improves accuracy.</p><p>We have clarified.</p><p>We have rewritten the part following eq. 17.</p><p>The clustering is run only twice to obtain the coarse (high sensitivity) and fine (high precision) partitions.</p><disp-quote content-type="editor-comment"><p>- I don't understand the purpose of constructing these various partitions.</p><p>Ostensibly they seem to be to help calculate a threshold, but the section seems to finish having just constructed the partitions, without telling me either how they've helped you arrive at a threshold, or why that threshold is so much better than what other methods have used.</p></disp-quote><p>This is just the first step before applying the mutation-based method, and its purpose is to reduce computations.</p><p>We now explain this, and added a paragraph in the Methods F and a supplementary figure to explain this better. This is also now better explained in the main text in section D.</p><disp-quote content-type="editor-comment"><p>F</p><p>(24) I think there should also be an approximate equals sign in the first line in this equation because we are substituting in the approximate value of p</p></disp-quote><p>Corrected</p><disp-quote content-type="editor-comment"><p>(25) Suggest pointing out that this follows because we are approximating the distribution as Poisson</p></disp-quote><p>It actually follows from the fact that n1 and n2 are small relative to L. The consequence is that it becomes a Poisson.</p><p>We have clarified.</p><disp-quote content-type="editor-comment"><p>- suggest &quot;analogously&quot; rather than &quot;analogically&quot; <ext-link ext-link-type="uri" xlink:href="https://english.stackexchange.com/questions/112149/analogous-vs-analogical">https://english.stackexchange.com/questions/112149/analogous-vs-analogical</ext-link></p></disp-quote><p>This paragraph has been edited and that word doesn’t appear anymore.</p><disp-quote content-type="editor-comment"><p>- &quot;is chosen based on the prevalence, analogically to adaptive threshold&quot;</p><p>I think you're missing a prime after the t in the inequality in this sentence</p></disp-quote><p>Solved. This paragraph was re-written.</p><disp-quote content-type="editor-comment"><p>- &quot;and further assume n0 ∼ n1n2 L to compute the new null distribution&quot;</p><p>I think that this tilde means &quot;is distributed as&quot; because n_1 and n_2 are random variables. A little clarification would help here.</p></disp-quote><p>Solved. This paragraph was re-written.</p><disp-quote content-type="editor-comment"><p>Reviewer #3 (Recommendations for the authors):</p><p>In addition to the recommendations in the public review, we had the following more questions and recommendations:</p><p>P. 2 &quot;Low prevalence is usually due to a high frequency of singletons&quot; Can the authors demonstrate this, or provide a citation?</p></disp-quote><p>We removed that sentence.</p><disp-quote content-type="editor-comment"><p>P. 2 &quot;In addition, we restrict our analysis to CDR3 lengths between 15 and 105: shorter or longer junctions have comparable frequencies to nonproductive junctions, suggesting that they are nonfunctional.&quot; This should be shown somewhere or given a citation.</p></disp-quote><p>We have rewritten this part to better motivate this choice.</p><disp-quote content-type="editor-comment"><p>P. 3 It is not clear how mu can vary so little but rho can vary so much</p></disp-quote><p>It is not completely clear why that is the case, but this is an empirical observation. An interpretation is that since mu is linked to mean mutation rate, this result suggests that it is stable across classes. rho is linked to the clone size distribution, and is very sensitive to the exponent of its power law. This could explain why it is very variable. The method does not make assumption about this variability infers it for each class on each dataset.</p><disp-quote content-type="editor-comment"><p>P. 3 use of rho_hat and p_hat is confusing</p><p>It would be helpful to see more descriptive statistics of the simulated data, such as the level of somatic hypermutation.</p></disp-quote><p>The level of hypermutation in our synthetic data is the same as in the actual data, since it mimics its mutational structure, with around mu=4% divergence between related sequences.</p><p>We now give this mean divergence in the main text.</p><p>The second synthetic dataset (from the partis paper) on which we benchmark the methods allows us to control the SHM rate. We have added a Figure 4—figure supplement 1 to show the dependence of performance on that mutation rate.</p><disp-quote content-type="editor-comment"><p>Figure 1 B. From the coloring of the tree/cluster, it looks like two sequences are left out of the tree.</p></disp-quote><p>We have changed the figure to make it more consistent. The root of the tree is unobserved and represented in white.</p><disp-quote content-type="editor-comment"><p>P. 9 Throughout the paper, does &quot;distance&quot; always refer to Hamming distance?</p></disp-quote><p>Yes, distance is always the Hamming distance n. We have added a table with notations, in which we clearly n as the Hamming distance and x=n/l as its normalized version.</p><disp-quote content-type="editor-comment"><p>P. 11 Uniform mutation probabilities across BCRs is not biologically realistic, given SHM hotspots as well as CDR and FWR regions. We understand this was a simplifying assumption, but it should be discussed.</p></disp-quote><p>We have added a discussion of this approximation in the methods, with a reference.</p><disp-quote content-type="editor-comment"><p>P. 11 Potential typo: x' – y &lt;= t. Should this be x' – y &lt;= t'?</p></disp-quote><p>Yes. We have changed that paragraph and the problem is now solved.</p><p>[Editors' note: further revisions were suggested prior to acceptance, as described below.]</p><disp-quote content-type="editor-comment"><p>The manuscript has been improved but there are some remaining issues that need to be addressed, as outlined below:</p><p>Reviewer 2</p><p>We thank the authors for their careful consideration of our comments, and for the many changes that they have implemented. Our main concerns have been addressed, although we have several minor comments.</p><p>The authors have made a huge improvement to the documentation and useability. A minor point, however, is that the result file seems to mostly be in AIRR format, except that the AIRR-standard 'clone_id' column for clonal family information seems to be either absent or copied from the input file, while an undocumented 'family' column appears to hold the inferred family information. This is confusing.</p><p>It would be wonderful if the authors chose to go for AIRR software certification as described in https://docs.airr-community.org/en/latest/swtools/airr_swtools_standard.html</p></disp-quote><p>We have changed the ‘family’ column label to ‘clone_id’.</p><disp-quote content-type="editor-comment"><p>We agree that HILARy makes a very real performance improvement in distinguishing similar, but unrelated, families, which is a substantial advance. However, in digging through things a bit more, the paper doesn't seem to clearly communicate how frequently settings arise in which HILARy is substantially different than existing software.</p><p>First, the performance plots in Figure 4 only show performance for half of CDR3 lengths (15-45, compared to 15-80 shown in the CDR3 distribution in Figure 6a).</p></disp-quote><p>We agree that we should have clearly stated the range of parameters for which HILARy distinguishes itself from other software.</p><p>We have now clarified that HILARy is substantially different when the CDR3 is short or the hypermutation rate is high. We have also retitled the corresponding result section ‘Benchmark of the methods on heavy chain datasets’ and included the performance relative to mutation rates for heavy chains in the main text (see new Figure 5).</p><p>Additionally, we would like to highlight that (1) HILARy is the only software that scales with the number of sequences in the largest VJl class (see Figure 4A), and (2) when using paired heavy and light chains, HILARy demonstrates a high degree of comparability to Partis software across all mutation rates, as evidenced by tests conducted on a simulated dataset specifically created for benchmarking Partis (see Figure 6).</p><disp-quote content-type="editor-comment"><p>Furthermore, the CDR3 lengths at which other methods perform significantly worse than HILARy (lengths 15-24) constitute less than one percent of a typical repertoire (see for instance Figure 6a). While it's true that it can make sense to emphasize challenging regions of parameter space, it would seem reasonable to clarify that this is what is being presented, as well as showing performance on typical repertoires in order to show the relevant context.</p></disp-quote><p>We do not focus on CDR lengths greater than 45 because in this range reconstructing clonal families is expected to be easier, and indeed all methods tested here performed well.</p><p>We have added a clarification in the benchmark section and extended the range of CDR3 lengths to 15-60 on our synthetic data in our benchmark against hierarchical clustering in the supplementary information (Figure S10) to provide evidence that longer CDRs do not affect HILARy’s performance.</p><p>In addition, we should emphasize that, for many analysis, it is crucial to guarantee consistent sensitivity and precision. Conversely, using the same threshold for all CDR3 lengths could confound analysis of clonal selection and dynamics. For example, in a study by <ext-link ext-link-type="uri" xlink:href="https://www.pnas.org/doi/abs/10.1073/pnas.1814213116">Horns et al. 2019,</ext-link> the lineages detected as &quot;persistent&quot; and &quot;vaccine-responsive&quot; have very different CDR3 lengths (see <xref ref-type="fig" rid="sa2fig1">Author response image 1</xref> where we used the lineage assignment and labeling directly from Horns et al.; the original paper didn't show it). The persistent lineages, which are of biological interest, include short CDR3 and although they do not make up a significant portion of the repertoire, identifying them correctly is important for the biological conclusions.</p><fig id="sa2fig1" position="float"><label>Author response image 1.</label><graphic mimetype="image" mime-subtype="tiff" xlink:href="elife-86181-sa2-fig1-v2.tif"/></fig><p>We have reported performance on a typical repertoire in the Results and added a paragraph in the Discussion section to clarify that simpler methods can be used depending on the repertoire’s statistics.</p><disp-quote content-type="editor-comment"><p>The simulation samples also seem to use a restricted set of J genes: 80% of sequences are from a single J allele, whereas repertoires more typically use around four J alleles with prevalences of perhaps 10% to 50%. This also has the effect of inflating the number of very similar but unrelated families. This is an example of the risks of focusing on a single data sample for validation.</p></disp-quote><p>It is true that the IGJH4 gene is largely represented in the simulation sample, but this is due to the fact that it is also largely represented in the data of [1]. Looking at the frequency of this gene across CDR3 lengths, we find our simulation sample to be comparable to the real data. See <xref ref-type="fig" rid="sa2fig2">Author response image 2</xref>.</p><p>[1]Briney B, Inderbitzin A, Joyce C, Burton DR (2019) Commonality despite exceptional diversity in the baseline human antibody repertoire. Nature 566:393–397.</p><fig id="sa2fig2" position="float"><label>Author response image 2.</label><graphic mimetype="image" mime-subtype="tiff" xlink:href="elife-86181-sa2-fig2-v2.tif"/></fig><disp-quote content-type="editor-comment"><p>We also have one small clarification in response to:</p><p>&quot;We agree that testing the method on a differently generated dataset is a useful check. We should point out, however, that our synthetic dataset is not as biased as it may seem. In particular, it is based on trees from VJl classes that we predicted are very easy to cluster, which means that they are truly faithful to the data, and not dependent on the particular algorithm used to infer them. The big advantage over this synthetic dataset over others is that it recapitulates the power law statistics of clone size distribution, as well as the diversity of mutation rates. To us, it still represents a more useful benchmark than synthetic datasets generated by population genetics models, which miss most of this very broad variability.&quot;</p><p>We just want to clarify that our concern was not that the synthetic sample was biased, but rather that it is risky to rely on any single sample, whether data or simulation, to form the basis of a robust inference method. Any single sample represents only a single set of possible parameter values, whereas we generally want methods to work well on real data samples that exist at a huge variety of different parameter values.</p><p>Also, while deciding when to use synthetic vs real data is a challenging problem, and we don't in general find fault with the authors' choices about this, we do want to point out that the authors' suggestion here that simulation methods cannot mimic data-like clone size distributions or mutation variability (i.e. tree shape) is incorrect. There exist simulation methods that let the user configure these parameters arbitrarily (including using direct inference from data).</p></disp-quote><p>We acknowledge that relying on a single dataset to test our method can be risky. Therefore, we use two differently generated datasets, each addressing challenging regions of the parameter space: short CDR3 lengths for our synthetic dataset and high mutation rates for the dataset from [2]. While it is true that other methods also enable repertoire simulation across a broad range of parameters, our primary argument is that our synthetic dataset is more realistic in terms of mutation rate and clone size distributions compared to the dataset used to test the Partis software [2].</p><p>[2] Ralph DK, Matsen IV FA (2022) Inference of B cell clonal families using heavy/light chain pairing information. PLOS Computational Biology 18:e1010723.</p><p>We have moved the SI figure showing HILARy’s performance across mutation rates on this dataset to the main text (new Figure 5 and Figure 6D-F).</p><disp-quote content-type="editor-comment"><p>Reviewer 3</p><p>The authors have addressed the major points I brought up in my review, and the revision is definitely improved. With respect to their new benchmarking on single linkage hierarchical clustering (Figure 4, supplement 2), it's not clear to me why they used their own implementation rather than one of the existing tools, or why the thresholds of 0.76, 0.82, and 0.88 were chosen. However, I think these issues could be addressed with text edits.</p></disp-quote><p>We use our implementation as it leverages the prefix tree search method described in the methods section to speed up the single linkage clustering. Given that single linkage clustering relies on a parameter that must be arbitrarily selected based on the repertoire, we conducted a scan for values within the commonly used range. This also highlights the trade-off between precision and sensitivity. Higher thresholds achieve high precision across all mutation rates but sensitivity is degraded for high mutation rates, whereas lower thresholds achieve sensitivity across all mutation rates but precision is degraded for lower mutation rates.</p><p>We have added a discussion in the Discussion section.</p><disp-quote content-type="editor-comment"><p>Personally, I'm trying to reconcile the results of this study with a recent and more comprehensive clonal benchmarking study which showed that single linkage clustering worked quite well: https://bmcimmunol.biomedcentral.com/articles/10.1186/s12865-024-00600-8. May be worth adding some discussion about.</p></disp-quote><p>While this study demonstrates that hierarchical clustering yields good results on simulations based on three real datasets, its performance on short CDR3 lengths and high mutation rates remains uncertain, as the mutation loads range from 1.3% to 5.5%.</p><p>In Figure S10 A, we illustrate that when using heavy chains only, all hierarchical clustering methods fail to reconstruct clonal families at high precision on short CDR3 lengths in our synthetic dataset and at high sensitivity for high somatic mutation rates in the data from [2]. Furthermore, we have extended the range of CDR3 lengths from 15-45 to 15-60 to show that all methods perform well for large lengths</p><p>We have added a discussion of the performance of single-linkage clustering and the above-mentioned paper in the Discussion section.</p><disp-quote content-type="editor-comment"><p>I agree with Reviewer 2 above points about consistency with AIRR format and that (1) the method seems to perform well in a CDR3 space which represents a small fraction of typical repertoire space, so it's not terribly clear how much it improves overall performance, and (2) it's risky to rely on effectively a single dataset to base these conclusions on.</p></disp-quote><p>We address this comment in our reply to reviewer 2 and have added a discussion of these points.</p></body></sub-article></article>