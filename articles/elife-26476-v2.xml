<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE article PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD v1.1 20151215//EN"  "JATS-archivearticle1.dtd"><article article-type="research-article" dtd-version="1.1" xmlns:ali="http://www.niso.org/schemas/ali/1.0/" xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink"><front><journal-meta><journal-id journal-id-type="nlm-ta">elife</journal-id><journal-id journal-id-type="publisher-id">eLife</journal-id><journal-title-group><journal-title>eLife</journal-title></journal-title-group><issn pub-type="epub" publication-format="electronic">2050-084X</issn><publisher><publisher-name>eLife Sciences Publications, Ltd</publisher-name></publisher></journal-meta><article-meta><article-id pub-id-type="publisher-id">26476</article-id><article-id pub-id-type="doi">10.7554/eLife.26476</article-id><article-categories><subj-group subj-group-type="display-channel"><subject>Tools and Resources</subject></subj-group><subj-group subj-group-type="heading"><subject>Cancer Biology</subject></subj-group><subj-group subj-group-type="heading"><subject>Computational and Systems Biology</subject></subj-group></article-categories><title-group><article-title>Simultaneous enumeration of cancer and immune cell types from bulk tumor gene expression data</article-title></title-group><contrib-group><contrib contrib-type="author" id="author-82824"><name><surname>Racle</surname><given-names>Julien</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">http://orcid.org/0000-0002-0100-0323</contrib-id><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="other" rid="fund1"/><xref ref-type="other" rid="fund2"/><xref ref-type="fn" rid="con1"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-101148"><name><surname>de Jonge</surname><given-names>Kaat</given-names></name><email>Kaat.DeJonge@unil.ch</email><xref ref-type="aff" rid="aff3">3</xref><xref ref-type="fn" rid="con2"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-83869"><name><surname>Baumgaertner</surname><given-names>Petra</given-names></name><email>Petra.Baumgartner@hospvd.ch</email><xref ref-type="aff" rid="aff3">3</xref><xref ref-type="fn" rid="con3"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" id="author-83870"><name><surname>Speiser</surname><given-names>Daniel E</given-names></name><email>d.e.speiser@gmail.com</email><xref ref-type="aff" rid="aff3">3</xref><xref ref-type="fn" rid="con4"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" corresp="yes" id="author-82826"><name><surname>Gfeller</surname><given-names>David</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">http://orcid.org/0000-0002-3952-0930</contrib-id><email>david.gfeller@unil.ch</email><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="other" rid="fund1"/><xref ref-type="other" rid="fund2"/><xref ref-type="fn" rid="con5"/><xref ref-type="fn" rid="conf1"/></contrib><aff id="aff1"><label>1</label><institution content-type="dept">Ludwig Centre for Cancer Research, Department of Fundamental Oncology</institution><institution>University of Lausanne</institution><addr-line><named-content content-type="city">Epalinges</named-content></addr-line><country>Switzerland</country></aff><aff id="aff2"><label>2</label><institution>Swiss Institute of Bioinformatics</institution><addr-line><named-content content-type="city">Lausanne</named-content></addr-line><country>Switzerland</country></aff><aff id="aff3"><label>3</label><institution content-type="dept">Department of Fundamental Oncology</institution><institution>Lausanne University Hospital (CHUV)</institution><addr-line><named-content content-type="city">Epalinges</named-content></addr-line><country>Switzerland</country></aff></contrib-group><contrib-group content-type="section"><contrib contrib-type="editor" id="author-7284"><name><surname>Valencia</surname><given-names>Alfonso</given-names></name><role>Reviewing Editor</role><aff><institution>Barcelona Supercomputing Center - BSC</institution><country>Spain</country></aff></contrib></contrib-group><pub-date date-type="publication" publication-format="electronic"><day>13</day><month>11</month><year>2017</year></pub-date><pub-date pub-type="collection"><year>2017</year></pub-date><volume>6</volume><elocation-id>e26476</elocation-id><history><date date-type="received" iso-8601-date="2017-03-02"><day>02</day><month>03</month><year>2017</year></date><date date-type="accepted" iso-8601-date="2017-11-10"><day>10</day><month>11</month><year>2017</year></date></history><permissions><copyright-statement>© 2017, Racle et al</copyright-statement><copyright-year>2017</copyright-year><copyright-holder>Racle et al</copyright-holder><ali:free_to_read/><license xlink:href="http://creativecommons.org/licenses/by/4.0/"><ali:license_ref>http://creativecommons.org/licenses/by/4.0/</ali:license_ref><license-p>This article is distributed under the terms of the <ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution License</ext-link>, which permits unrestricted use and redistribution provided that the original author and source are credited.</license-p></license></permissions><self-uri content-type="pdf" xlink:href="elife-26476-v2.pdf"/><abstract><object-id pub-id-type="doi">10.7554/eLife.26476.001</object-id><p>Immune cells infiltrating tumors can have important impact on tumor progression and response to therapy. We present an efficient algorithm to simultaneously estimate the fraction of cancer and immune cell types from bulk tumor gene expression data. Our method integrates novel gene expression profiles from each major non-malignant cell type found in tumors, renormalization based on cell-type-specific mRNA content, and the ability to consider uncharacterized and possibly highly variable cell types. Feasibility is demonstrated by validation with flow cytometry, immunohistochemistry and single-cell RNA-Seq analyses of human melanoma and colorectal tumor specimens. Altogether, our work not only improves accuracy but also broadens the scope of absolute cell fraction predictions from tumor gene expression data, and provides a unique novel experimental benchmark for immunogenomics analyses in cancer research (<ext-link ext-link-type="uri" xlink:href="http://epic.gfellerlab.org">http://epic.gfellerlab.org</ext-link>).</p></abstract><abstract abstract-type="executive-summary"><object-id pub-id-type="doi">10.7554/eLife.26476.002</object-id><title>eLife digest</title><p>Malignant tumors do not only contain cancer cells. Normal cells from the body also infiltrate tumors. These often include a variety of immune cells that can help detect and kill cancer cells. Many evidences suggest that the proportion of different immune cell types in a tumor can affect tumor growth and which treatments are effective.</p><p>Researchers often study tumors by measuring the expression of genes, i.e., which genes are active in tumors. However, the proportion of different cell types in the tumor is often not measured for tumors studied at the gene expression level.</p><p>Racle et al. have now demonstrated that a new computer-based tool can accurately detect all the main cell types in a tumor directly from the expression of genes in this tumor. The tool is called “Estimating the Proportion of Immune and Cancer cells” – or EPIC for short. It compares the level of expression of genes in a tumor with a library of the gene expression profiles from specific cell types that can be found in tumors and uses this information to predict how many of each type of cell are present. Experimental measurements of several human tumors confirmed that EPIC’s predictions are accurate.</p><p>EPIC is freely available online. Since the active genes in tumors from many patients have already been documented together with clinical data, researchers could use EPIC to investigate whether the cell types in a tumor affect how harmful it is or how well a particular treatment works on it. In the future, this information could help to identify the best treatment for a particular patient and may reveal new genes that cause malignant tumors to develop and grow.</p></abstract><kwd-group kwd-group-type="author-keywords"><kwd>tumor immune microenvironment</kwd><kwd>gene expression</kwd><kwd>cell fraction predictions</kwd><kwd>computational biology</kwd></kwd-group><kwd-group kwd-group-type="research-organism"><title>Research organism</title><kwd>Human</kwd></kwd-group><funding-group><award-group id="fund1"><funding-source><institution-wrap><institution>Center for Advanced Modelling Science</institution></institution-wrap></funding-source><principal-award-recipient><name><surname>Racle</surname><given-names>Julien</given-names></name><name><surname>Gfeller</surname><given-names>David</given-names></name></principal-award-recipient></award-group><award-group id="fund2"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100001711</institution-id><institution>Schweizerischer Nationalfonds zur Förderung der Wissenschaftlichen Forschung</institution></institution-wrap></funding-source><award-id>Project grant 31003A_173156</award-id><principal-award-recipient><name><surname>Racle</surname><given-names>Julien</given-names></name><name><surname>Gfeller</surname><given-names>David</given-names></name></principal-award-recipient></award-group><funding-statement>The funders had no role in study design, data collection and interpretation, or the decision to submit the work for publication.</funding-statement></funding-group><custom-meta-group><custom-meta specific-use="meta-only"><meta-name>Author impact statement</meta-name><meta-value>A novel method predicts cancer and immune cell types from bulk tumor gene expression data with the ability to consider uncharacterized and possibly highly variable cell types, which is validated in human genome.</meta-value></custom-meta></custom-meta-group></article-meta></front><body><sec id="s1" sec-type="intro"><title>Introduction</title><p>Tumors form complex microenvironments composed of various cell types such as cancer, immune, stromal and endothelial cells (<xref ref-type="bibr" rid="bib24">Hanahan and Weinberg, 2011</xref>; <xref ref-type="bibr" rid="bib28">Joyce and Fearon, 2015</xref>). Immune cells infiltrating the tumor microenvironment play a major role in shaping tumor progression, response to (immuno-)therapy and patient survival (<xref ref-type="bibr" rid="bib15">Fridman et al., 2012</xref>). Today, gene expression analysis is widely used to characterize tumors at the molecular level. As a consequence, tumor gene expression profiles from tens of thousands of patients are available across all major tumor types in databases such as Gene Expression Omnibus (GEO [<xref ref-type="bibr" rid="bib12">Edgar et al., 2002</xref>]) or The Cancer Genome Atlas (TCGA [<xref ref-type="bibr" rid="bib25">Hoadley et al., 2014</xref>]). Unfortunately, flow cytometry or immunohistochemistry (IHC) measurements to quantify the number of both malignant and tumor-infiltrating immune cells are rarely performed for samples analyzed at the gene expression level. Therefore, to correctly interpret these data in particular from an immuno-oncology point of view (<xref ref-type="bibr" rid="bib2">Angelova et al., 2015</xref>; <xref ref-type="bibr" rid="bib20">Gentles et al., 2015</xref>; <xref ref-type="bibr" rid="bib23">Hackl et al., 2016</xref>; <xref ref-type="bibr" rid="bib33">Li et al., 2016</xref>; <xref ref-type="bibr" rid="bib35">Linsley et al., 2015</xref>; <xref ref-type="bibr" rid="bib43">Rooney et al., 2015</xref>; <xref ref-type="bibr" rid="bib58">Şenbabaoğlu et al., 2016</xref>; <xref ref-type="bibr" rid="bib55">Zheng et al., 2017</xref>), reliable and carefully validated bioinformatics tools are required to infer the fraction of cancer and immune cell types from bulk tumor gene expression data.</p><p>To this end, diverse bioinformatics methods have been developed. Some aim at estimating tumor purity based on copy number variation (<xref ref-type="bibr" rid="bib8">Carter et al., 2012</xref>; <xref ref-type="bibr" rid="bib32">Li and Li, 2014</xref>), or expression data (<xref ref-type="bibr" rid="bib1">Ahn et al., 2013</xref>; <xref ref-type="bibr" rid="bib10">Clarke et al., 2010</xref>; <xref ref-type="bibr" rid="bib41">Quon et al., 2013</xref>; <xref ref-type="bibr" rid="bib54">Yoshihara et al., 2013</xref>), but do not provide information about the different immune cell types. Others focus on predicting the relative proportions of cell types by fitting reference gene expression profiles from sorted cells (<xref ref-type="bibr" rid="bib21">Gong and Szustakowski, 2013</xref>; <xref ref-type="bibr" rid="bib33">Li et al., 2016</xref>; <xref ref-type="bibr" rid="bib37">Newman et al., 2015</xref>; <xref ref-type="bibr" rid="bib40">Qiao et al., 2012</xref>) or with the help of gene signatures (<xref ref-type="bibr" rid="bib6">Becht et al., 2016</xref>; <xref ref-type="bibr" rid="bib56">Zhong et al., 2013</xref>). These approaches have been recently applied to cancer genomics data to investigate the influence of immune infiltrates on survival or response to therapy (<xref ref-type="bibr" rid="bib9">Charoentong et al., 2017</xref>; <xref ref-type="bibr" rid="bib20">Gentles et al., 2015</xref>; <xref ref-type="bibr" rid="bib58">Şenbabaoğlu et al., 2016</xref>) or predict potential targets for cancer immunotherapy (<xref ref-type="bibr" rid="bib2">Angelova et al., 2015</xref>; <xref ref-type="bibr" rid="bib33">Li et al., 2016</xref>). However, none of these methods provides quantitative information about both cancer and non-malignant cell type proportions directly from tumor gene expression profiles. In addition, reference gene expression profiles used in previous studies have been mainly obtained from circulating immune cells sorted from peripheral blood and were generally based on microarrays technology. Finally, several of these approaches have not been experimentally validated in solid tumors from human patients.</p><p>Here, we developed a robust approach to simultaneously Estimate the Proportion of Immune and Cancer cells (EPIC) from bulk tumor gene expression data. EPIC is based on a unique collection of RNA-Seq reference gene expression profiles from either circulating immune cells or tumor- infiltrating non-malignant cell types (i.e., immune, stromal and endothelial cells). To account for the high variability of cancer cells across patients and tissue of origin, we implemented in our algorithm the ability to consider uncharacterized, possibly highly variable, cell types. To validate our predictions in human solid tumors, we first analyzed melanoma samples with both flow cytometry and RNA-Seq. We then collected publicly available IHC and single-cell RNA-Seq data of colorectal and melanoma tumors. All three validation datasets showed that very accurate predictions of both cancer and non-malignant cell type proportions could be obtained even in the absence of <italic>a priori</italic> information about cancer cells.</p></sec><sec id="s2" sec-type="results"><title>Results</title><sec id="s2-1"><title>Reference gene expression profiles from circulating and tumor-infiltrating cells</title><p>EPIC incorporates reference gene expression profiles from each major immune and other non-malignant cell type to model bulk RNA-Seq data as a superposition of these reference profiles (<xref ref-type="fig" rid="fig1">Figure 1A,B</xref>). To tailor our predictions to recent gene expression studies, we first collected and curated RNA-Seq profiles of various human innate and adaptive circulating immune cell types (<xref ref-type="bibr" rid="bib26">Hoek et al., 2015</xref>; <xref ref-type="bibr" rid="bib34">Linsley et al., 2014</xref>; <xref ref-type="bibr" rid="bib38">Pabst et al., 2016</xref>) (CD4 T cells, CD8 T cells, B cells, NK cells, Monocytes and Neutrophils) from a diverse set of patients analyzed in different centers (see Materials and methods). Principal component analysis (PCA) of these data (<xref ref-type="fig" rid="fig1">Figure 1C</xref>) showed that samples clustered first according to cell type and not according to experiment of origin, patient age, disease status or other factors, suggesting that they could be used as <italic>bona fide</italic> reference expression profiles across different patients. Reference gene expression profiles for each major immune cell type were built from these RNA-Seq samples based on the median normalized counts per gene and cell type. The variability in expression for each gene was also considered when predicting the various cell proportions based on these reference profiles (see Materials and methods and <xref ref-type="supplementary-material" rid="supp1">Supplementary file 1</xref>).</p><fig-group><fig id="fig1" position="float"><object-id pub-id-type="doi">10.7554/eLife.26476.003</object-id><label>Figure 1.</label><caption><title>Estimating the proportion of immune and cancer cells.</title><p>(<bold>A</bold>) Schematic description of our method. (<bold>B</bold>) Matrix formulation of our algorithm, including the uncharacterized cell types (red box) with no or very low expression of signature genes (green box). (<bold>C</bold>) Low dimensionality representation (PCA based on the 1000 most variable genes) of the samples used to build the reference gene expression profiles from circulating immune cells (study 1 [<xref ref-type="bibr" rid="bib26">Hoek et al., 2015</xref>], study 2 [<xref ref-type="bibr" rid="bib34">Linsley et al., 2014</xref>], study 3 [<xref ref-type="bibr" rid="bib38">Pabst et al., 2016</xref>]). (<bold>D</bold>) Low dimensionality representation (PCA based on the 1000 most variable genes) of the tumor- infiltrating cell gene expression profiles from different patients. Each point corresponds to cell-type average per patient of the single-cell RNA-Seq data of <xref ref-type="bibr" rid="bib51">Tirosh et al. (2016)</xref> (requiring at least 3 cells of a given cell type per patient). Only samples from primary tumors and non-lymphoid tissue metastases were considered. Projection of the original single-cell RNA-Seq data can be found in <xref ref-type="fig" rid="fig1s1">Figure 1—figure supplement 1</xref>.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-26476-fig1-v2"/></fig><fig id="fig1s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.26476.004</object-id><label>Figure 1—figure supplement 1.</label><caption><title>Low dimensionality representation of the tumor-infiltrating cell samples.</title><p>Principal component analysis of the samples used to build the reference gene expression profiles from tumor-infiltrating immune cells, based on the data from <xref ref-type="bibr" rid="bib51">Tirosh et al. (2016)</xref>, considering only the primary tumor and non-lymphoid tissue metastasis samples.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-26476-fig1-figsupp1-v2"/></fig><fig id="fig1s2" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.26476.005</object-id><label>Figure 1—figure supplement 2.</label><caption><title>Cell type mRNA content.</title><p>(<bold>A</bold>) mRNA content per cell type obtained for cell types sorted from blood. Values for B, NK, T cells and monocytes were obtained as described in Materials and methods. Values for Neutrophils are from <xref ref-type="bibr" rid="bib50">Subrahmanyam et al. (2001)</xref>. (<bold>B</bold>) Width of the forward scatter values for the different immune and cancer cells from flow cytometry data of melanoma metastatic lymph nodes. Data were first normalized by the mean FSC-W for each donor. Error bars represent the standard deviation from data of 4 patients.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-26476-fig1-figsupp2-v2"/></fig></fig-group><p>Immune cells differ in their gene expression profiles depending on their state and site of origin (e.g., blood or tumors) (<xref ref-type="bibr" rid="bib18">Ganesan et al., 2017</xref>; <xref ref-type="bibr" rid="bib48">Speiser et al., 2016</xref>; <xref ref-type="bibr" rid="bib55">Zheng et al., 2017</xref>). To study the potential effect of these differences on our predictions, we established reference gene expression profiles of each major tumor-infiltrating immune cell type (i.e., CD4 T, CD8 T, B, NK, macrophages). We further derived reference profiles for stromal cells (i.e. cancer-associated fibroblasts (CAFs)) and endothelial cells. These reference gene expression profiles were obtained as cell type averages from the single-cell RNA-Seq data of melanoma patients from Tirosh and colleagues (<xref ref-type="bibr" rid="bib51">Tirosh et al., 2016</xref>), considering only samples from primary tumor and non-lymphoid tissue metastasis (see Materials and methods and <xref ref-type="supplementary-material" rid="supp2">Supplementary file 2</xref>). As for circulating immune cell data, principal component analysis of the tumor-infiltrating cells’ gene expression profiles showed that samples clustered first according to cell type (<xref ref-type="fig" rid="fig1">Figure 1D</xref> and <xref ref-type="fig" rid="fig1s1">Figure 1—figure supplement 1</xref>, see also results in [<xref ref-type="bibr" rid="bib51">Tirosh et al., 2016</xref>]).</p></sec><sec id="s2-2"><title>Cancer and non-malignant cell fraction predictions</title><p>Reference gene expression profiles from each of the immune and other non-malignant (i.e., stromal and endothelial) cell types were then used to model bulk gene expression data as a linear combination of <italic>m</italic> different cell types (<xref ref-type="fig" rid="fig1">Figure 1B</xref>). To include cell types like cancer cells that show high variability across patients and tissues of origin, we further implemented in our algorithm the ability to consider an uncharacterized cell population. Mathematically this was done by taking advantage of the presence of gene markers of non-malignant cells that are not expressed in cancer cells. Importantly, we do not require our signature genes to be expressed in exactly one cell type, but only to show very low expression in cancer cells. The mRNA proportion of each immune and other non-malignant cell type was inferred using least-square regression, solving first our system of equations for the marker genes (green box in <xref ref-type="fig" rid="fig1">Figure 1B</xref>, see Materials and methods). The fraction of cancer cells was then determined as one minus the fraction of all non-malignant cell types. Cell markers used in this work were determined by differential expression analysis based on our reference cell gene expression profiles as well as gene expression data from non-hematopoietic tissues (see Materials and methods and <xref ref-type="table" rid="app1table1">Appendix 1—table 1</xref>). Finally, to account for different amounts of mRNA in different cell types and enable meaningful comparison with flow cytometry and IHC data, we measured the mRNA content of all major immune cell types as well as of cancer cells (<xref ref-type="fig" rid="fig1s2">Figure 1—figure supplement 2</xref>) and used these values to renormalize our predicted mRNA proportions (see Materials and methods).</p></sec><sec id="s2-3"><title>Validation in blood</title><p>We first tested our algorithm using three datasets comprising bulk RNA-Seq data from PBMC (<xref ref-type="bibr" rid="bib26">Hoek et al., 2015</xref>; <xref ref-type="bibr" rid="bib57">Zimmermann et al., 2016</xref>) or whole blood (<xref ref-type="bibr" rid="bib34">Linsley et al., 2014</xref>), as well as the corresponding proportions of immune cell types determined by flow cytometry (<xref ref-type="fig" rid="fig2">Figure 2A</xref>). These data were collected from various cancer-free human donors (see Materials and methods). Overall, very accurate predictions were obtained by fitting reference profiles from circulating immune cells, considering either all cell types together (<xref ref-type="fig" rid="fig2">Figure 2A</xref>) or each cell type separately (<xref ref-type="fig" rid="fig2s1">Figure 2—figure supplement 1</xref>). When comparing with other widely used cell fraction prediction methods (<xref ref-type="bibr" rid="bib6">Becht et al., 2016</xref>; <xref ref-type="bibr" rid="bib21">Gong and Szustakowski, 2013</xref>; <xref ref-type="bibr" rid="bib33">Li et al., 2016</xref>; <xref ref-type="bibr" rid="bib37">Newman et al., 2015</xref>; <xref ref-type="bibr" rid="bib41">Quon et al., 2013</xref>; <xref ref-type="bibr" rid="bib56">Zhong et al., 2013</xref>), we observed a clear improvement (<xref ref-type="fig" rid="fig2">Figure 2B</xref> and <xref ref-type="fig" rid="fig2s1">Figure 2—figure supplement 1</xref>). Of note, the very high correlation values can partly result from the broad range of different cell fractions in our data (<xref ref-type="fig" rid="fig2">Figure 2A</xref>) and we emphasize that these correlation values should only be used to compare methods tested on the same datasets (<xref ref-type="fig" rid="fig2">Figure 2B</xref>). The root mean squared error (RMSE), which is less dependent on such ‘outlier data points’, shows also improved accuracy for EPIC compared to other methods (<xref ref-type="fig" rid="fig2s1">Figure 2—figure supplement 1B</xref>).</p><fig-group><fig id="fig2" position="float"><object-id pub-id-type="doi">10.7554/eLife.26476.006</object-id><label>Figure 2.</label><caption><title>Predicting cell fractions in blood samples.</title><p>(<bold>A</bold>) Predicted vs. measured immune cell proportions in PBMC (dataset 1 (<xref ref-type="bibr" rid="bib57">Zimmermann et al., 2016</xref>), dataset 2 (<xref ref-type="bibr" rid="bib26">Hoek et al., 2015</xref>)) and whole blood (dataset 3 (<xref ref-type="bibr" rid="bib34">Linsley et al., 2014</xref>)); predictions are based on the reference profiles from circulating immune cells. (<bold>B</bold>) Performance comparison with other methods. Significant correlations are indicated above each bar (*p&lt;0.05; **p&lt;0.01; ***p&lt;0.001). (<bold>C</bold>) Predicted immune cells' mRNA proportions (i.e., without mRNA renormalization step) vs. measured values in the same datasets. Correlations are based on Pearson correlation; RMSE: root mean squared error. Proportions of cells observed experimentally are given in <xref ref-type="supplementary-material" rid="supp3">Supplementary file 3B-D</xref>.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-26476-fig2-v2"/></fig><fig id="fig2s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.26476.007</object-id><label>Figure 2—figure supplement 1.</label><caption><title>Comparison of multiple cell fraction prediction methods in blood datasets.</title><p>Heatmaps show (<bold>A</bold>) the Pearson R correlation and (<bold>B</bold>) the root mean squared error, between the cell fractions predicted by each method and the experimentally measured fractions (dataset 1 [<xref ref-type="bibr" rid="bib57">Zimmermann et al., 2016</xref>], dataset 2 [<xref ref-type="bibr" rid="bib26">Hoek et al., 2015</xref>], dataset 3 [<xref ref-type="bibr" rid="bib34">Linsley et al., 2014</xref>]). Results are based either on all cell types together (noted as ‘All cells’) or for each individual cell type measured experimentally. <italic>NA's</italic> indicate cases where the cell type could not be predicted by a method. The ‘All cells’ boxes are hatched for TIMER as it does not predict the proportions from all the cell types so that the values computed there correspond to less cell types than for the other methods. For the dataset 2, as there are only two donors data, the results are only presented with all cells together (includes eight data points). In (<bold>A</bold>) the significance of the Pearson correlation is indicated by stars: *p&lt;0.05, **p&lt;0.01, ***p&lt;0.001, while results with p-values above 0.1 are inside parentheses.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-26476-fig2-figsupp1-v2"/></fig><fig id="fig2s2" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.26476.008</object-id><label>Figure 2—figure supplement 2.</label><caption><title>Effect of including an mRNA renormalization step for multiple cell fraction prediction methods.</title><p>Pearson R correlations are shown as in <xref ref-type="fig" rid="fig2s1">Figure 2—figure supplement 1A</xref>, showing here for each method its original result and the result if the predicted proportions are then renormalized by the mRNA per cell values as is done in EPIC.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-26476-fig2-figsupp2-v2"/></fig><fig id="fig2s3" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.26476.009</object-id><label>Figure 2—figure supplement 3.</label><caption><title>Effect of the various steps in EPIC on the prediction accuracy.</title><p>Comparison of the predictions as done in <xref ref-type="fig" rid="fig2s1">Figure 2—figure supplement 1A</xref>, for different variations from EPIC: (1) full EPIC method; (2) EPIC if the gene expression reference profiles are scaled <italic>a priori</italic> by the mRNA per cell values instead of doing the mRNA normalization step <italic>a posteriori</italic>; (3) EPIC results without the mRNA normalization step at all; (4) EPIC results when the optimization does not include any weights based on the gene expression variability from the reference profiles.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-26476-fig2-figsupp3-v2"/></fig><fig id="fig2s4" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.26476.010</object-id><label>Figure 2—figure supplement 4.</label><caption><title>Results with or without known reference profiles for T cells for the cell fraction predictions from various methods.</title><p>Results are shown similarly than in <xref ref-type="fig" rid="fig2s1">Figure 2—figure supplement 1A</xref>. Here, we present for various cell fraction prediction methods the results considering all the immune cell types in the gene expression reference profiles followed by the results obtained when removing all references to T cell (and their subsets) from these reference profiles. Only the results of the predictions from the other immune cells than T cells are shown. The effect of removing T cells from MCPcounter and TIMER could not be tested because one cannot select the cell reference profiles or cell types to use in the input of the R codes for these methods.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-26476-fig2-figsupp4-v2"/></fig></fig-group><p>The renormalization by mRNA content, which had not been considered in previous approaches, appeared to be important for predicting actual cell fractions (<xref ref-type="fig" rid="fig2">Figure 2C</xref>). Moreover, we observed that most other methods could also benefit from such a renormalization step, be it for the global prediction of all cell types together or for the predictions of each cell type (<xref ref-type="fig" rid="fig2s2">Figure 2—figure supplement 2</xref>). A conceptually related approach was developed by <xref ref-type="bibr" rid="bib5">Baron et al. (2016)</xref>, but the rescaling was done on the gene expression reference profiles (in their case of pancreatic cells) based on the total number of transcripts per cell type and the prediction of the proportion of pancreatic cells from a bulk sample was carried out with CIBERSORT (<xref ref-type="bibr" rid="bib37">Newman et al., 2015</xref>). For comparison purpose, we implemented such an <italic>a priori</italic> renormalization step in EPIC as well, and observed similar results than with the <italic>a posteriori</italic> renormalization (<xref ref-type="fig" rid="fig2s3">Figure 2—figure supplement 3</xref>).</p><p>With respect to the other methods, EPIC has two other main distinctive features: (i) it allows for a cell type without a known reference gene expression profile (such a feature is also part of ISOpure [<xref ref-type="bibr" rid="bib41">Quon et al., 2013</xref>]) and (ii) it integrates information about the variability in each signature gene from the reference gene expression profiles. The latter point slightly improves the prediction accuracy but to a lesser extent than the renormalization by mRNA (<xref ref-type="fig" rid="fig2s3">Figure 2—figure supplement 3</xref>). The former point cannot be tested directly in the blood samples as only cell types with known reference gene expression profiles are composing these samples. Therefore, to test the effect of including a cell type without a known reference profile, we removed all the T cell subsets from the reference gene expression profiles and predicted the proportion of the other cell types in the bulk samples, allowing for one uncharacterized cell type in EPIC. As expected, the results from EPIC including or not the T cell reference profiles remained nearly unchanged, while the other methods suffered from this, except for DSA (<xref ref-type="bibr" rid="bib56">Zhong et al., 2013</xref>) which is based only on signature genes and not reference profiles (<xref ref-type="fig" rid="fig2s4">Figure 2—figure supplement 4</xref>). Such an advantage of EPIC is especially useful in the context of tumor samples where in general no reference gene expression profile is available for the cancer cells.</p></sec><sec id="s2-4"><title>Validation in solid tumors</title><p>To validate our predictions in tumors, we collected single cell suspensions from lymph nodes of four metastatic melanoma patients (see Materials and methods). A fraction of the cell suspension was used to measure the different cell type proportions with flow cytometry (CD4 T, CD8 T, B, NK, melanoma and other cells comprising mostly stromal and endothelial cells; <xref ref-type="supplementary-material" rid="supp3">Supplementary file 3A</xref>), and the other fraction was used for bulk RNA sequencing (<xref ref-type="fig" rid="fig3s1">Figure 3—figure supplement 1</xref>). EPIC was first run with reference profiles from circulating immune cells. We observed a remarkable agreement between our predictions and experimentally determined cell fractions (<xref ref-type="fig" rid="fig3">Figure 3A</xref>). The high correlation value is possibly driven by the two samples containing about 80% of melanoma cells, but we stress that all predicted cell proportions fall nearly on the ‘y = x’ line. This clearly indicates that the absolute cell fractions were correctly predicted for all cell types, as confirmed by a low RMSE. Of note, the proportion of melanoma cells could be very accurately predicted even in the absence of <italic>a priori</italic> information about their gene expression.</p><fig-group><fig id="fig3" position="float"><object-id pub-id-type="doi">10.7554/eLife.26476.011</object-id><label>Figure 3.</label><caption><title>Predicting cell fractions in solid tumors with reference profiles from circulating cells.</title><p>(<bold>A</bold>) Comparison of EPIC predictions with our flow cytometry data of lymph nodes from metastatic melanoma patients. (<bold>B</bold>) Comparison with immunohistochemistry data from colon cancer primary tumors (<xref ref-type="bibr" rid="bib6">Becht et al., 2016</xref>). (<bold>C</bold>) Comparison with single-cell RNA-Seq data (<xref ref-type="bibr" rid="bib51">Tirosh et al., 2016</xref>) from melanoma samples either from lymphoid tissues or primary and non-lymphoid metastatic tumors. Correlations are based on Pearson correlation. Proportions of cells observed experimentally are given in <xref ref-type="supplementary-material" rid="supp3">Supplementary file 3A,E</xref>.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-26476-fig3-v2"/></fig><fig id="fig3s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.26476.012</object-id><label>Figure 3—figure supplement 1.</label><caption><title>Sketch of the experiment designed to validate EPIC predictions starting from in vivo tumor samples.</title></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-26476-fig3-figsupp1-v2"/></fig></fig-group><p>As a second validation, we compared EPIC predictions with IHC data from colon cancer (<xref ref-type="bibr" rid="bib6">Becht et al., 2016</xref>) (see Materials and methods). Although a limited number of immune cell types had been assayed in this study, we observed a significant correlation between cell proportions measured by IHC and our predictions, except for the CD8 T cells (<xref ref-type="fig" rid="fig3">Figure 3B</xref>).</p><p>As a third validation, we used recent single-cell RNA-Seq data from 19 melanoma samples (<xref ref-type="bibr" rid="bib51">Tirosh et al., 2016</xref>). We applied EPIC on the average expression profile over all single cells for each patient and compared the results with the actual cell fractions (see Materials and methods). Here again, our predictions were consistent with the observed cell fractions, even for melanoma cells for which we did not assume any reference gene expression profile (<xref ref-type="fig" rid="fig3">Figure 3C</xref>). Notably, the predicted cell fractions from melanoma cells as well as from all other immune cell types fall nearly on the y = x line, showing that not only the relative cell type proportions could be predicted but also the absolute proportions for all cell types.</p><p>We next compared these predictions to those obtained with reference profiles from tumor- infiltrating cells, including also CAFs and endothelial cells (<xref ref-type="fig" rid="fig4">Figure 4</xref>). For the single-cell RNA-Seq data (<xref ref-type="fig" rid="fig4">Figure 4C</xref>), we applied a leave-one-out procedure, to avoid using the same samples both to build the reference profiles and the bulk RNA-Seq data used as input for the predictions (see Materials and methods). Overall, predictions did not change much compared to those based on circulating immune cell reference gene expression profiles (<xref ref-type="fig" rid="fig4">Figure 4</xref>), except for the IHC data where the predictions for CD8 T cells and macrophages clearly improved (<xref ref-type="fig" rid="fig4">Figure 4B</xref>). Moreover, we could observe some differences between the results obtained from circulating immune cell reference gene expression profiles and those from tumor-infiltrating cell reference gene expression profiles, when considering the proportions from each cell type independently (<xref ref-type="fig" rid="fig3">Figures 3</xref>–<xref ref-type="fig" rid="fig4">4</xref> and <xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1</xref>): (i) predictions for CD8 T cells and macrophages improved in the datasets of primary tumors and non-lymph node metastases but not in the datasets from lymph node metastases; (ii) predictions for B and NK cells displayed similar accuracy based on the circulating cells or tumor-infiltrating cells profiles for all datasets; and (iii) CAFs and endothelial cells were not available for the blood-based reference profiles but the proportion of these cells could be well predicted based on the reference profiles constructed from tumor-infiltrating cells (<xref ref-type="fig" rid="fig4">Figure 4</xref> and <xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1</xref>).</p><fig-group><fig id="fig4" position="float"><object-id pub-id-type="doi">10.7554/eLife.26476.013</object-id><label>Figure 4.</label><caption><title>Predictions with reference profiles from tumor-infiltrating cells.</title><p>Same as <xref ref-type="fig" rid="fig3">Figure 3</xref> but based on reference profiles built from the single-cell RNA-Seq data of primary tumor and non-lymphoid metastatic melanoma samples from <xref ref-type="bibr" rid="bib51">Tirosh et al. (2016)</xref>. (<bold>A</bold>) Comparison with flow cytometry data of lymph nodes from metastatic melanoma patients. (<bold>B</bold>) Comparison with IHC from colon cancer primary tumors (<xref ref-type="bibr" rid="bib6">Becht et al., 2016</xref>). (<bold>C</bold>) Comparison with single-cell RNA-Seq data (<xref ref-type="bibr" rid="bib51">Tirosh et al., 2016</xref>). For primary tumor and non-lymphoid metastasis samples, a leave-one-out procedure was used (see Materials and methods). Proportions of cells observed experimentally are given in <xref ref-type="supplementary-material" rid="supp3">Supplementary file 3A,E</xref>.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-26476-fig4-v2"/></fig><fig id="fig4s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.26476.014</object-id><label>Figure 4—figure supplement 1.</label><caption><title>Comparison of EPIC results per cell type for gene expression reference profiles from circulating or tumor-infiltrating immune cells.</title><p>(<bold>A</bold>) Pearson R correlation and (<bold>B</bold>) RMSE between the cell fractions predicted and the experimentally measured fractions (from flow cytometry of lymph nodes from metastatic melanoma patients (this study), colorectal cancer IHC from primary tumors (<xref ref-type="bibr" rid="bib6">Becht et al., 2016</xref>) and single-cell RNA-Seq data from melanoma (<xref ref-type="bibr" rid="bib51">Tirosh et al., 2016</xref>). <italic>NA’s</italic> indicate cases where the cell type could not be predicted by a method. <italic>#:</italic> No predictions for endothelial cells were done in the primary tumors from single-cell RNA-seq data as only one patient had such cells and no profiles could be built through the leave-1-out procedure used for this dataset. The ‘<italic>Cancer +other cells</italic>’ correspond to cancer cells and other stromal and endothelial cells. No RMSE value can be computed for the IHC data in (<bold>B</bold>) as the measured values are not for all cells and do not reflect cell proportions. In (<bold>A</bold>) the significance of the Pearson correlation is indicated by stars: * p.value &lt; 0.05, ** p.value &lt; 0.01, *** p.value &lt; 0.001, while results with p-values above 0.1 are inside parentheses.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-26476-fig4-figsupp1-v2"/></fig></fig-group></sec><sec id="s2-5"><title>Benchmarking of other methods</title><p>We took advantage of our unique collection of independent validation datasets to benchmark other methods for predictions of immune cell type fractions in human tumors. We first compared the results of EPIC and ISOpure (<xref ref-type="bibr" rid="bib41">Quon et al., 2013</xref>), which is the only other method that can consider uncharacterized cell types and therefore predict the fraction of cancer and immune cell types based only on RNA-seq data. EPIC displayed improved accuracy in all three datasets (<xref ref-type="fig" rid="fig5">Figure 5A</xref>, and <xref ref-type="fig" rid="fig5s1">Figure 5—figure supplements 1</xref>–<xref ref-type="fig" rid="fig5s4">4</xref>). To benchmark other methods, we then restricted our analysis to the predictions of the different immune cell types (<xref ref-type="fig" rid="fig5">Figure 5B</xref> and <xref ref-type="fig" rid="fig5s1">Figure 5—figure supplements 1</xref>–<xref ref-type="fig" rid="fig5s4">4</xref>). Predictions from EPIC were in general more accurate, especially when considering all cell types together. Nevertheless, when restricting the comparisons to relative cell type proportions, some methods like MCPcounter (<xref ref-type="bibr" rid="bib6">Becht et al., 2016</xref>) and TIMER (<xref ref-type="bibr" rid="bib33">Li et al., 2016</xref>) were quite consistent in their predictions across the various datasets and showed similar accuracy as EPIC for the cell types considered in these methods (<xref ref-type="fig" rid="fig5s1">Figure 5—figure supplements 1</xref>–<xref ref-type="fig" rid="fig5s4">4</xref>). Of note, MCPcounter could not be included in the global prediction comparison as this method returns scores that are not comparable between different cell types. Predictions from DSA (<xref ref-type="bibr" rid="bib56">Zhong et al., 2013</xref>) were also quite accurate when available, but in multiple cases some cell type proportions returned by the method were simply equal to 0 in all samples (<xref ref-type="fig" rid="fig5s1">Figure 5—figure supplements 1</xref>–<xref ref-type="fig" rid="fig5s4">4</xref> – correlation values were replaced by <italic>NA</italic> in these cases).</p><fig-group><fig id="fig5" position="float"><object-id pub-id-type="doi">10.7554/eLife.26476.015</object-id><label>Figure 5.</label><caption><title>Performance comparison with other methods in tumor samples.</title><p>(<bold>A</bold>) Pearson correlation R-values between the cell proportions predicted by EPIC and ISOpure and the observed proportions measured by flow cytometry or single-cell RNA-Seq (<xref ref-type="bibr" rid="bib51">Tirosh et al., 2016</xref>), considering all cell types together (i.e., B, CAFs, CD4 T, CD8 T, endothelial, NK, macrophages and cancer cells). (<bold>B</bold>) Same analysis as in <xref ref-type="fig" rid="fig5">Figure 5A</xref> but considering only immune cell types (i.e., B, CD4 T, CD8 T, NK and macrophages) in order to include more methods in the comparison. (<bold>C</bold>) Analysis of ESTIMATE predictions in the single-cell RNA-Seq dataset for the sum of all immune cells, the proportion of stromal cells (cancer-associated fibroblasts) and the proportion of cancer cells (cells identified as melanoma cells in Tirosh et al.). (<bold>D</bold>) Same as <xref ref-type="fig" rid="fig5">Figure 5C</xref> but for EPIC predictions of immune, stromal and cancer cells. Significant correlations in (<bold>A–B</bold>) are indicated above each bar (*p&lt;0.05; **p&lt;0.01; ***p&lt;0.001).</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-26476-fig5-v2"/></fig><fig id="fig5s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.26476.016</object-id><label>Figure 5—figure supplement 1.</label><caption><title>Comparison of multiple cell fraction prediction methods in tumor datasets.</title><p>(<bold>A</bold>) Pearson R correlation and (<bold>B</bold>) root mean squared error between the cell fractions predicted by each method and the experimentally measured fractions (from flow cytometry (this study), colorectal cancer immunohistochemistry (<xref ref-type="bibr" rid="bib6">Becht et al., 2016</xref>) and single-cell RNA-Seq data (<xref ref-type="bibr" rid="bib51">Tirosh et al., 2016</xref>). Results are based either on cell types grouped together (noted as ‘All cells’, including the immune, endothelial, stromal and cancer cells, or ‘All immune cells’, including only the immune cell types) or for each individual cell type that had been measured experimentally. <italic>NA’s</italic> indicate cases where the cell type could not be predicted by a method. <italic>#:</italic> No predictions for endothelial cells were done with EPIC in the primary tumors from single-cell RNA-seq data as only one patient had such cells and no profiles could be built through the leave-1-out procedure used for this dataset. The ‘<italic>Cancer + other cells</italic>’ correspond to cancer cells and other stromal and endothelial cells. In (<bold>A</bold>) the significance of the Pearson correlation is indicated by stars: *p&lt;0.05, **p&lt;0.01, ***p&lt;0.001, while results with p-values above 0.1 are inside parentheses.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-26476-fig5-figsupp1-v2"/></fig><fig id="fig5s2" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.26476.017</object-id><label>Figure 5—figure supplement 2.</label><caption><title>Comparison of cell fraction prediction methods with flow cytometry data of melanoma tumors.</title><p>(<bold>A</bold>) Comparison directly of all cell types together. When a cell type could not be predicted by a given method, this cell type is absent from the subfigure. (<bold>B</bold>) Comparison per cell type for MCP-counter as the predictions are not comparable across different cell types. CD4 T cells and melanoma cell proportions are not predicted by MCP counter. Correlation and RMSE values are available in <xref ref-type="fig" rid="fig5s1">Figure 5—figure supplement 1</xref>.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-26476-fig5-figsupp2-v2"/></fig><fig id="fig5s3" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.26476.018</object-id><label>Figure 5—figure supplement 3.</label><caption><title>Comparison of cell fraction prediction methods with immunohistochemistry data in colon cancer data (<xref ref-type="bibr" rid="bib6">Becht et al., 2016</xref>) for T cell, CD8 T cell and macrophage infiltration values.</title><p>Observed values are in number of cells/mm<sup>2</sup>. Correlation values are available in <xref ref-type="fig" rid="fig5s1">Figure 5—figure supplement 1</xref>.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-26476-fig5-figsupp3-v2"/></fig><fig id="fig5s4" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.26476.019</object-id><label>Figure 5—figure supplement 4.</label><caption><title>Comparison of cell fraction prediction methods with single-cell RNA-Seq data from melanoma tumors (<xref ref-type="bibr" rid="bib51">Tirosh et al., 2016</xref>).</title><p>(<bold>A</bold>) Comparison directly of all cell types together. When a cell type could not be predicted by a given method, this cell type is absent from the subfigure. (<bold>B</bold>) Results for MCP-counter, splitting the different cell types as the predictions are not comparable across different cell types. CD4 T cells and melanoma cell proportions are not predicted by MCP counter. Correlation and RMSE values are available in <xref ref-type="fig" rid="fig5s1">Figure 5—figure supplement 1</xref>.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-26476-fig5-figsupp4-v2"/></fig><fig id="fig5s5" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.26476.020</object-id><label>Figure 5—figure supplement 5.</label><caption><title>Comparison between ESTIMATE scores (<bold>A</bold>) and EPIC predictions (<bold>B</bold>) in our new flow cytometry dataset.</title><p>The predictions are compared to the observed cell proportions. ESTIMATE returns a score of global immune infiltration and thus the sum of all observed immune cells has been taken for the comparison. The observed cancer cells correspond to the melan-A + cells. Correlations between observed fractions and predictions are based on Spearman correlations.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-26476-fig5-figsupp5-v2"/></fig><fig id="fig5s6" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.26476.021</object-id><label>Figure 5—figure supplement 6.</label><caption><title>Predicting Thelper and Treg cell fractions in tumors.</title><p>The proportions of Thelper and Treg cells predicted by EPIC and CIBERSORT are compared to the proportions observed in the bulk samples reconstructed from the single-cell RNA-seq data from melanoma tumors (<xref ref-type="bibr" rid="bib51">Tirosh et al., 2016</xref>). Pearson correlations and RMSE are indicated on the figures.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-26476-fig5-figsupp6-v2"/></fig></fig-group><p>Immune, stromal and tumor purity scores (<xref ref-type="bibr" rid="bib54">Yoshihara et al., 2013</xref>) based on gene set enrichment analysis were also correlated with the total fraction of immune cells, stromal cells and the fraction of cancer cells (correlation was not significant for the tumor purity score – <xref ref-type="fig" rid="fig5">Figure 5C</xref> and <xref ref-type="fig" rid="fig5s5">Figure 5—figure supplement 5</xref>). However, these correlations were considerably lower than those obtained with our approach (<xref ref-type="fig" rid="fig5">Figure 5D</xref> and <xref ref-type="fig" rid="fig5s5">Figure 5—figure supplement 5</xref>). Moreover, such scores are less quantitative and are thus more difficult to interpret with respect to actual cell type proportions.</p><p>Next, we performed some explorative analysis to test if such cell fraction prediction methods could go further into the details of the T cell subsets. Based on the single-cell RNA-seq data from Tirosh and colleagues (<xref ref-type="bibr" rid="bib51">Tirosh et al., 2016</xref>), we identified CD4+ Treg and Thelper cells (see Materials and methods), and built reference gene expression profiles for these cell types as we had done for the other cell types. As before, a leave-1-out procedure at the patient level was used to predict the proportions for these cell types based on the bulk samples constructed from this single-cell RNA-seq data. We observed significant correlations, but the R-values are lower than before (<xref ref-type="fig" rid="fig5s6">Figure 5—figure supplement 6</xref>), suggesting that we may be reaching the limits of cell fraction prediction methods for cell types that show lower abundance and substantial transcriptional similarity. Of note, CIBERSORT using either the LM22 signature or our newly derived signature did not perform better than EPIC.</p></sec></sec><sec id="s3" sec-type="discussion"><title>Discussion</title><p>By combining RNA-Seq profiles of all major immune and other non-malignant cell types established from both circulating and tumor-infiltrating cells together with information about cell morphology (i.e., mRNA content) and algorithmic developments to consider uncharacterized and possibly highly variable cell types, EPIC overcomes several limitations of previous approaches to predict the fraction of both cancer and immune or other non-malignant cell types from bulk tumor gene expression data. From an algorithmic point of view, EPIC takes advantage of the fact that cancer cells, in general, express no or only low levels of immune and stromal markers. Therefore the method can be broadly applied to most solid tumors, as confirmed by our validation in melanoma and colorectal samples, but it will not be suitable for hematological malignancies like leukemia or lymphoma.</p><p>The accuracy of the predictions for some cell types might be sensitive to the origin or condition of the immune cells used for establishing reference profiles. For instance, we observed that CD8 T cells and macrophages from primary tumors and non-lymph node metastases samples were best predicted using the reference profiles from tumor-infiltrating cells. This may be explained by the fact that the reference profiles from circulating cells corresponded to resting CD8 T cells and monocytes as only few activated C8 T cells and no macrophages are circulating in blood.</p><p>Overall, our results suggest that for primary tumors or non-lymphoid tissue metastases reference gene expression profiles from tumor-infiltrating immune cells are more appropriate, while for lymph node metastases, profiles from either circulating or tumor-infiltrating immune cells could be used.</p><p>One known limitation of cell fraction predictions arises when some cell types are present at very low frequency (<xref ref-type="bibr" rid="bib46">Shen-Orr and Gaujoux, 2013</xref>). Our results suggest that predictions of cell proportions are reliable within an absolute error of about 8%, as estimated by the root mean squared error (<xref ref-type="fig" rid="fig3">Figure 3</xref> and <xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1B</xref>). These estimates are consistent with the lower detection limit proposed by other groups (<xref ref-type="bibr" rid="bib6">Becht et al., 2016</xref>; <xref ref-type="bibr" rid="bib56">Zhong et al., 2013</xref>) and may explain why the relative proportions of NK cells, which are present at lower frequency in melanoma tumors (<xref ref-type="bibr" rid="bib4">Balch et al., 1990</xref>; <xref ref-type="bibr" rid="bib45">Sconocchia et al., 2012</xref>), could not be predicted with accuracy comparable to other cell types (<xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1</xref>). While this may prevent applications of cell fraction predictions in some tumor types that are poorly infiltrated, many other tumors, like melanoma or colorectal cancer, display high level of infiltrating immune cells and the role of immune infiltrations on tumor progression and survival appears to be especially important in these tumors (<xref ref-type="bibr" rid="bib11">Clemente et al., 1996</xref>; <xref ref-type="bibr" rid="bib15">Fridman et al., 2012</xref>; <xref ref-type="bibr" rid="bib17">Galon et al., 2006</xref>).</p><p>Another limitation of cell fraction predictions arises when considering cell types that show high transcriptional similarity. For instance, Treg in <xref ref-type="fig" rid="fig5s6">Figure 5—figure supplement 6</xref> could not be well predicted neither by EPIC nor CIBERSORT. This can be understood because the gene expression profiles of Thelper and Treg are highly similar with only a few genes expressed differently between the two, making it harder for cell fraction prediction methods to work accurately. In addition, Treg were present at a proportion lower than 10% in all samples (<xref ref-type="supplementary-material" rid="supp3">Supplementary file 3E</xref>). For such cases, gene set enrichment approaches, although less quantitative, may be more convenient, possibly combining them with the predictions obtained by EPIC for the main immune cell types.</p><p>Our predictions for the fraction of uncharacterized cells may include non-malignant cells, such as epithelial cells from neighboring tissues in addition to cancer cells. Compared to recent algorithms that first predict tumor purity based on exome sequencing data, and later infer the relative fraction of immune cell types (<xref ref-type="bibr" rid="bib33">Li et al., 2016</xref>), the predictions of EPIC for immune and stromal cells are likely more quantitative because they can implicitly consider the presence of not only cancer cells but also other non-malignant cells for which reference profiles are not available. Moreover, EPIC does not require both exome and RNA-Seq data from the same tumor samples, thereby reducing the cost and amount of experimental work for prospective studies, and broadening the scope of retrospective analyses of cancer genomics data to studies that only include gene expression data.</p><p>Recent technical developments in single-cell RNA-Seq technology enable researchers to directly access information about both the proportion of all cell types together with their gene expression characteristics (<xref ref-type="bibr" rid="bib7">Carmona et al., 2017</xref>; <xref ref-type="bibr" rid="bib13">Efroni et al., 2015</xref>; <xref ref-type="bibr" rid="bib27">Jaitin et al., 2014</xref>; <xref ref-type="bibr" rid="bib47">Singer et al., 2016</xref>; <xref ref-type="bibr" rid="bib49">Stegle et al., 2015</xref>; <xref ref-type="bibr" rid="bib51">Tirosh et al., 2016</xref>). Such data are much richer than anything that can be obtained with computational deconvolution of bulk gene expression profiles and this technology may eventually replace standard gene expression analysis of bulk tumors. Nevertheless, it is important to realize that, even when disregarding the financial aspects, single-cell RNA-Seq of human tumors is still logistically and technically very challenging due to high level of cell death upon sample manipulation (especially freezing and thawing) and high transcript dropout rates (<xref ref-type="bibr" rid="bib14">Finak et al., 2015</xref>; <xref ref-type="bibr" rid="bib44">Saliba et al., 2014</xref>; <xref ref-type="bibr" rid="bib49">Stegle et al., 2015</xref>). Moreover, one cannot exclude that some cells may better survive the processing with microfluidics devices used in some single-cell RNA-Seq platforms, thereby biasing the estimates of cell type proportions. It is therefore likely that bulk tumor gene expression analysis will remain widely used for several years. Our work shows how we can exploit recent single-cell RNA-Seq data of tumors obtained from a few patients to refine cell fraction predictions in other patients that could not be analyzed with this technology, thereby overcoming some limitations of previous computational approaches that relied only on reference gene expression profiles from circulating immune cells.</p><p>In this work, we provide a detailed and biologically relevant validation of our predictions using actual tumor samples from human patients analyzed with flow cytometry, IHC and single-cell RNA-Seq. We note that the slightly lower agreement between our predictions and IHC data may be partly explained by the fact that the exact same samples could not be used for both gene expression and IHC analyses because of the incompatibility between the two techniques. Nevertheless, the overall high accuracy of our predictions indicates that infiltrations of major immune cell types can be quantitatively studied directly from bulk tumor gene expression data using computational approaches such as EPIC.</p><p>EPIC can be downloaded as a standalone R package (<ext-link ext-link-type="uri" xlink:href="https://github.com/GfellerLab/EPIC/releases/tag/v1.1">https://github.com/GfellerLab/EPIC/releases/tag/v1.1</ext-link>) (<xref ref-type="bibr" rid="bib42">Racle, 2017</xref>) and can be used with reference gene expression profiles pre-compiled from circulating or tumor-infiltrating cells, or provided by the user. EPIC is also available as a web application (<ext-link ext-link-type="uri" xlink:href="http://epic.gfellerlab.org">http://epic.gfellerlab.org</ext-link>) where users can upload bulk samples gene expression data and perform the full analysis.</p></sec><sec id="s4" sec-type="materials|methods"><title>Materials and methods</title><sec id="s4-1"><title>Code availability</title><p>EPIC has been written as an R package. It is freely available on GitHub (<ext-link ext-link-type="uri" xlink:href="https://github.com/GfellerLab/EPIC">https://github.com/GfellerLab/EPIC</ext-link>; copy archived on <ext-link ext-link-type="uri" xlink:href="https://github.com/elifesciences-publications/EPIC">https://github.com/elifesciences-publications/EPIC</ext-link>) for academic non-commercial research purposes. Version v1.1 of the package was used for our analyses.</p><p>In addition to the R package, EPIC is available as a web application at the address: <ext-link ext-link-type="uri" xlink:href="http://epic.gfellerlab.org">http://epic.gfellerlab.org</ext-link>.</p></sec><sec id="s4-2"><title>Prediction of cancer and immune cell type proportions</title><p>In EPIC, the gene expression of a bulk sample is modeled as the sum of the gene expression profiles from the pure cell types composing this sample (<xref ref-type="fig" rid="fig1">Figure 1A,B</xref>). This can be written as (<xref ref-type="bibr" rid="bib53">Venet et al., 2001</xref>):<disp-formula id="equ1"><label>(1)</label><mml:math id="m1"><mml:mi>b</mml:mi><mml:mo>=</mml:mo><mml:mi>C</mml:mi> <mml:mi/><mml:mo>×</mml:mo> <mml:mi/><mml:mi>p</mml:mi></mml:math></disp-formula></p><p>Where <italic>b</italic> is the vector of all <italic>n</italic> genes expressed from the bulk sample to deconvolve; <italic>C</italic> is a matrix (<italic>n</italic> x <italic>m</italic>) of the <italic>m</italic> gene expression profiles from the different cell types; and <italic>p</italic> is a vector of the proportions from the <italic>m cell types</italic> in the given sample (<xref ref-type="fig" rid="fig1">Figure 1B</xref>).</p><p>Matrix <italic>C</italic> consists of <italic>m-1</italic> columns corresponding to various reference non-malignant cell types whose gene expression profiles are known, and a last column corresponding to uncharacterized cells (i.e. mostly cancer cells, but possibly also other non-malignant cell types not included in the reference profiles). EPIC assumes the reference gene expression profiles from the non-malignant cell types are well conserved between patients. Such a hypothesis is supported by the analysis in <xref ref-type="fig" rid="fig1">Figure 1C,D</xref>. The uncharacterized cells can be more heterogeneous between patients and EPIC makes no assumption on them.</p><p>EPIC works with RNA-seq data, which is implicitly normalized. We use data normalized into transcripts per million (TPM) because it has some properties needed for the full cell proportion prediction to work, as will be shown in the next paragraphs. Therefore, instead of the raw data from <xref ref-type="disp-formula" rid="equ1">Equation (1)</xref>, we are working with TPM-normalized data, which correspond to the following:<disp-formula id="equ2"><label>(2)</label><mml:math id="m2"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mtable columnspacing="1em" rowspacing="4pt"><mml:mtr><mml:mtd><mml:mrow><mml:mover><mml:msub><mml:mi>b</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:msup><mml:mn>10</mml:mn><mml:mrow><mml:mn>6</mml:mn></mml:mrow></mml:msup><mml:mrow><mml:munderover><mml:mo movablelimits="false">∑</mml:mo><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:munderover><mml:mfrac><mml:msub><mml:mi>b</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>l</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mfrac></mml:mrow></mml:mfrac><mml:mo>⋅</mml:mo><mml:mfrac><mml:msub><mml:mi>b</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>l</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mfrac></mml:mtd></mml:mtr><mml:mtr><mml:mtd/></mml:mtr><mml:mtr><mml:mtd><mml:mrow><mml:mover><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:msup><mml:mn>10</mml:mn><mml:mrow><mml:mn>6</mml:mn></mml:mrow></mml:msup><mml:mrow><mml:munderover><mml:mo movablelimits="false">∑</mml:mo><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:munderover><mml:mfrac><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mi>k</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>l</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mfrac></mml:mrow></mml:mfrac><mml:mo>⋅</mml:mo><mml:mfrac><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>l</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mfrac></mml:mtd></mml:mtr></mml:mtable></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>Where <inline-formula><mml:math id="inf1"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mover><mml:mi>b</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow></mml:mrow></mml:mstyle></mml:math></inline-formula> and <inline-formula><mml:math id="inf2"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mover><mml:mi>C</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow></mml:mrow></mml:mstyle></mml:math></inline-formula> are the TPM-normalized bulk sample and reference cell gene expression profiles respectively and <italic>l<sub>i</sub></italic> is the length of gene <italic>i</italic>.</p><p>Using these, <xref ref-type="disp-formula" rid="equ1">Equation (1)</xref> is rewritten to:<disp-formula id="equ3"><label>(3)</label><mml:math id="m3"><mml:mover accent="false"><mml:mrow><mml:mi>b</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover><mml:mo>=</mml:mo><mml:mover accent="false"><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover><mml:mo>×</mml:mo><mml:mover accent="false"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover></mml:math></disp-formula></p><p>where<disp-formula id="equ4"><label>(4)</label><mml:math id="m4"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mover><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:munderover><mml:mfrac><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mi>k</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>l</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mfrac></mml:mrow><mml:mrow><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:munderover><mml:mfrac><mml:msub><mml:mi>b</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>l</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mfrac></mml:mrow></mml:mfrac><mml:mo>⋅</mml:mo><mml:msub><mml:mi>p</mml:mi><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>This normalization guarantees the sum of the new proportions, <inline-formula><mml:math id="inf3"><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mo>-</mml:mo></mml:mover></mml:math></inline-formula>, is equal to 1:<disp-formula id="equ5"><mml:math id="m5"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:munderover><mml:mo movablelimits="false">∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:munderover><mml:msub><mml:mrow><mml:mover><mml:mi>b</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mover><mml:mo>=</mml:mo><mml:mrow><mml:mrow><mml:mi mathvariant="normal">f</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">r</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">o</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">m</mml:mi></mml:mrow><mml:mrow><mml:mtext> </mml:mtext></mml:mrow><mml:mrow><mml:mi mathvariant="normal">e</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">q</mml:mi></mml:mrow><mml:mo>.</mml:mo><mml:mrow><mml:mtext> </mml:mtext></mml:mrow><mml:mtext>2</mml:mtext></mml:mrow></mml:mover><mml:mtext> </mml:mtext><mml:mrow><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:munder></mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mfrac><mml:msup><mml:mn>10</mml:mn><mml:mrow><mml:mn>6</mml:mn></mml:mrow></mml:msup><mml:mrow><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:munder><mml:mfrac><mml:msub><mml:mi>b</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>l</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mfrac></mml:mrow></mml:mfrac><mml:mo>⋅</mml:mo><mml:mfrac><mml:msub><mml:mi>b</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>l</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mfrac></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msup><mml:mn>10</mml:mn><mml:mrow><mml:mn>6</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>and<disp-formula id="equ6"><mml:math id="m6"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:munderover><mml:mo movablelimits="false">∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:munderover><mml:msub><mml:mrow><mml:mover><mml:mi>b</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mover><mml:mo>=</mml:mo><mml:mrow><mml:mrow><mml:mi mathvariant="normal">f</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">r</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">o</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">m</mml:mi></mml:mrow><mml:mrow><mml:mtext> </mml:mtext></mml:mrow><mml:mrow><mml:mi mathvariant="normal">e</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">q</mml:mi></mml:mrow><mml:mo>.</mml:mo><mml:mrow><mml:mtext> </mml:mtext></mml:mrow><mml:mtext>3</mml:mtext></mml:mrow></mml:mover><mml:mtext> </mml:mtext><mml:mrow><mml:munder><mml:mo>∑</mml:mo><mml:mi>i</mml:mi></mml:munder></mml:mrow><mml:msub><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mrow><mml:mover><mml:mi>C</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow><mml:mo>×</mml:mo><mml:mrow><mml:mover><mml:mi>p</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:munderover><mml:mo movablelimits="false">∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:munderover><mml:munderover><mml:mo movablelimits="false">∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>m</mml:mi></mml:mrow></mml:munderover><mml:mover><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo accent="false">¯</mml:mo></mml:mover><mml:mo>⋅</mml:mo><mml:msub><mml:mover><mml:mi>p</mml:mi><mml:mo accent="false">¯</mml:mo></mml:mover><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mover><mml:mo>=</mml:mo><mml:mrow><mml:mrow><mml:mi mathvariant="normal">f</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">r</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">o</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">m</mml:mi></mml:mrow><mml:mrow><mml:mtext> </mml:mtext></mml:mrow><mml:mrow><mml:mi mathvariant="normal">e</mml:mi></mml:mrow><mml:mrow><mml:mi mathvariant="normal">q</mml:mi></mml:mrow><mml:mo>.</mml:mo><mml:mrow><mml:mtext> </mml:mtext></mml:mrow><mml:mtext>2</mml:mtext></mml:mrow></mml:mover><mml:mrow><mml:munder><mml:mo>∑</mml:mo><mml:mi>j</mml:mi></mml:munder></mml:mrow><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mfrac><mml:msup><mml:mn>10</mml:mn><mml:mrow><mml:mn>6</mml:mn></mml:mrow></mml:msup><mml:mrow><mml:munder><mml:mo>∑</mml:mo><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:munder><mml:mfrac><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mi>k</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>l</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mfrac></mml:mrow></mml:mfrac><mml:mo>⋅</mml:mo><mml:mrow><mml:munder><mml:mo>∑</mml:mo><mml:mi>i</mml:mi></mml:munder></mml:mrow><mml:mfrac><mml:msub><mml:mi>C</mml:mi><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mi>l</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mfrac></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>⋅</mml:mo><mml:msub><mml:mrow><mml:mover><mml:mi>p</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>]</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msup><mml:mn>10</mml:mn><mml:mrow><mml:mn>6</mml:mn></mml:mrow></mml:msup><mml:mo>⋅</mml:mo><mml:mrow><mml:munder><mml:mo>∑</mml:mo><mml:mi>j</mml:mi></mml:munder></mml:mrow><mml:msub><mml:mrow><mml:mover><mml:mi>p</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mstyle></mml:math></disp-formula><disp-formula id="equ7"><label>(5)</label><mml:math id="m7"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mo stretchy="false">⇒</mml:mo><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>m</mml:mi></mml:munderover><mml:mrow><mml:mover><mml:msub><mml:mi>p</mml:mi><mml:mi>j</mml:mi></mml:msub><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>In addition to <inline-formula><mml:math id="inf4"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mover><mml:mi>p</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow><mml:mtext> </mml:mtext><mml:mrow><mml:mi mathvariant="normal">a</mml:mi><mml:mi mathvariant="normal">n</mml:mi><mml:mi mathvariant="normal">d</mml:mi><mml:mtext> </mml:mtext></mml:mrow><mml:mrow><mml:mover><mml:mi>C</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow></mml:mrow></mml:mstyle></mml:math></inline-formula> we also define <inline-formula><mml:math id="inf5"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msup><mml:mrow><mml:mover><mml:mi>p</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mo>∗</mml:mo></mml:mrow></mml:msup><mml:mtext> </mml:mtext><mml:mrow><mml:mi mathvariant="normal">a</mml:mi><mml:mi mathvariant="normal">n</mml:mi><mml:mi mathvariant="normal">d</mml:mi></mml:mrow><mml:mtext> </mml:mtext><mml:msup><mml:mrow><mml:mover><mml:mi>C</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mo>∗</mml:mo></mml:mrow></mml:msup></mml:mrow></mml:mstyle></mml:math></inline-formula>, which are the same except that they include the normalized proportions and profiles from the reference cell types only (i.e. they have one less element and one less column than <inline-formula><mml:math id="inf6"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mover><mml:mi>p</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow><mml:mtext> </mml:mtext><mml:mrow><mml:mi mathvariant="normal">a</mml:mi><mml:mi mathvariant="normal">n</mml:mi><mml:mi mathvariant="normal">d</mml:mi></mml:mrow><mml:mtext> </mml:mtext><mml:mrow><mml:mover><mml:mi>C</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow></mml:mrow></mml:mstyle></mml:math></inline-formula> respectively).</p><p>Using these normalized quantities, EPIC then solves <xref ref-type="disp-formula" rid="equ3">Equation (3)</xref> for a subset of <italic>n<sub>s</sub></italic> equations corresponding to the <italic>n<sub>s</sub></italic> signature genes (<italic>S</italic>) that are expressed by one or more of the reference cell types but only expressed at a negligible level in the uncharacterized cells (<xref ref-type="fig" rid="fig1">Figure 1B</xref>). Previous computational work (<xref ref-type="bibr" rid="bib10">Clarke et al., 2010</xref>; <xref ref-type="bibr" rid="bib22">Gosink et al., 2007</xref>) showed that the proportion from uncharacterized cells in bulk samples could indeed be inferred with help of genes not expressed by the uncharacterized cells. Importantly, cell-specific signature genes are well established and widely used in flow cytometry to sort immune cells. Thus, EPIC solves the following system of equations:<disp-formula id="equ8"><label>(6)</label><mml:math id="m8"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mover><mml:msub><mml:mi>b</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow><mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:mi>S</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mover><mml:mi>C</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow><mml:mo>∗</mml:mo></mml:msup><mml:mo>×</mml:mo><mml:msup><mml:mrow><mml:mover><mml:mi>p</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow><mml:mo>∗</mml:mo></mml:msup><mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mi>i</mml:mi></mml:msub><mml:mo>+</mml:mo><mml:msub><mml:mrow><mml:mover><mml:mi>C</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>m</mml:mi></mml:mrow></mml:msub><mml:mo>⋅</mml:mo><mml:msub><mml:mrow><mml:mover><mml:mi>p</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow><mml:mi>m</mml:mi></mml:msub><mml:mo stretchy="false">)</mml:mo><mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:mi>S</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mo stretchy="false">(</mml:mo><mml:msup><mml:mrow><mml:mover><mml:mi>C</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow><mml:mo>∗</mml:mo></mml:msup><mml:mo>×</mml:mo><mml:msup><mml:mrow><mml:mover><mml:mi>p</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow><mml:mo>∗</mml:mo></mml:msup><mml:msub><mml:mo stretchy="false">)</mml:mo><mml:mi>i</mml:mi></mml:msub><mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:mi>S</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>where the term corresponding to the uncharacterized cells (<italic>m</italic>) vanished thanks to the definition of the signature genes (<inline-formula><mml:math id="inf7"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mrow><mml:mover><mml:mi>C</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>m</mml:mi></mml:mrow></mml:msub><mml:msub><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:mi>S</mml:mi></mml:mrow></mml:msub><mml:mo>≅</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:mstyle></mml:math></inline-formula>).</p><p>The solution to <xref ref-type="disp-formula" rid="equ8">Equation (6)</xref> can be estimated by a constrained least square optimization. EPIC takes advantage of the known variability for each gene in the reference profile, to give weights in the function to minimize:<disp-formula id="equ9"><label>(7)</label><mml:math id="m9"><mml:mi>f</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:msup><mml:mrow><mml:mover accent="false"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>*</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:mfenced><mml:mo>=</mml:mo><mml:mrow><mml:msub><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>∈</mml:mo><mml:mi>S</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:msub><mml:mrow><mml:mi>w</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:msup><mml:mrow><mml:mfenced close="]" open="[" separators="|"><mml:mrow><mml:msub><mml:mrow><mml:mover accent="false"><mml:mrow><mml:mi>b</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>-</mml:mo><mml:msub><mml:mrow><mml:mfenced separators="|"><mml:mrow><mml:msup><mml:mrow><mml:mover accent="false"><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>*</mml:mi></mml:mrow></mml:msup><mml:mo>×</mml:mo><mml:msup><mml:mrow><mml:mover accent="false"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>*</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:mrow></mml:mrow></mml:math></disp-formula></p><p>with constraints<disp-formula id="equ10"><mml:math id="m10"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mo>{</mml:mo><mml:mtable columnalign="left left" columnspacing="1em" rowspacing="4pt"><mml:mtr><mml:mtd/><mml:mtd><mml:msubsup><mml:mrow><mml:mover><mml:mi>p</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mo>∗</mml:mo></mml:mrow></mml:msubsup><mml:mo>≥</mml:mo><mml:mn>0</mml:mn></mml:mtd></mml:mtr><mml:mtr><mml:mtd><mml:munderover><mml:mo movablelimits="false">∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:munderover></mml:mtd><mml:mtd><mml:msubsup><mml:mrow><mml:mover><mml:mi>p</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mo>∗</mml:mo></mml:mrow></mml:msubsup><mml:mo>≤</mml:mo><mml:mn>1</mml:mn></mml:mtd></mml:mtr></mml:mtable><mml:mo fence="true" stretchy="true" symmetric="true"/></mml:mrow></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>Here, the weights, <italic>w<sub>i</sub></italic>, give more importance to the signature genes with low variability in the reference gene expression profiles. In EPIC, these weights are given by:<disp-formula id="equ11"><mml:math id="m11"><mml:msub><mml:mrow><mml:mi>w</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:mrow><mml:mi mathvariant="normal">min</mml:mi></mml:mrow><mml:mo>⁡</mml:mo><mml:mrow><mml:mfenced separators="|"><mml:mrow><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo> <mml:mi/><mml:mn>100</mml:mn><mml:mo>∙</mml:mo><mml:mi mathvariant="normal">m</mml:mi><mml:mi mathvariant="normal">e</mml:mi><mml:mi mathvariant="normal">d</mml:mi><mml:mi mathvariant="normal">i</mml:mi><mml:mi mathvariant="normal">a</mml:mi><mml:mi mathvariant="normal">n</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:mrow></mml:mfenced></mml:mrow></mml:mrow></mml:math></disp-formula></p><p>where<disp-formula id="equ12"><mml:math id="m12"><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mrow><mml:munderover><mml:mo movablelimits="false">∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mo>-</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:munderover><mml:mrow><mml:mfrac><mml:mrow><mml:msubsup><mml:mrow><mml:mover accent="false"><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow><mml:mrow><mml:mi>*</mml:mi></mml:mrow></mml:msubsup></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mover accent="false"><mml:mrow><mml:mi>V</mml:mi></mml:mrow><mml:mo>¯</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>i</mml:mi><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>+</mml:mo><mml:mi>ε</mml:mi></mml:mrow></mml:mfrac></mml:mrow></mml:mrow></mml:math></disp-formula></p><p><inline-formula><mml:math id="inf8"><mml:mover accent="true"><mml:mrow><mml:mi>V</mml:mi></mml:mrow><mml:mo>-</mml:mo></mml:mover></mml:math></inline-formula> is the matrix of the TPM-based variability of each gene for each of the reference cells (<xref ref-type="supplementary-material" rid="supp1">Supplementary files 1</xref>–<xref ref-type="supplementary-material" rid="supp2">2</xref>), <italic>ε</italic> is a small number to avoid division by 0, and the term '<inline-formula><mml:math id="inf9"><mml:mn>100</mml:mn><mml:mo>∙</mml:mo><mml:mi mathvariant="normal">m</mml:mi><mml:mi mathvariant="normal">e</mml:mi><mml:mi mathvariant="normal">d</mml:mi><mml:mi mathvariant="normal">i</mml:mi><mml:mi mathvariant="normal">a</mml:mi><mml:mi mathvariant="normal">n</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:msub><mml:mrow><mml:mi>u</mml:mi></mml:mrow><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfenced></mml:math></inline-formula>' is used to avoid giving too much weight to few of the genes.</p><p>Finally, thanks to <xref ref-type="disp-formula" rid="equ7">Equation (5)</xref>, the proportion for the uncharacterized cells can be obtained by:<disp-formula id="equ13"><label>(8)</label><mml:math id="m13"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:msub><mml:mrow><mml:mover><mml:mi>p</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow><mml:mi>m</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>j</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:munderover><mml:msub><mml:mrow><mml:mover><mml:mi>p</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow><mml:mi>j</mml:mi></mml:msub></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>Since we used normalized gene expression data, values of <inline-formula><mml:math id="inf10"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mrow><mml:mover><mml:mi>p</mml:mi><mml:mo stretchy="false">¯</mml:mo></mml:mover></mml:mrow></mml:mrow></mml:mstyle></mml:math></inline-formula> correspond actually to the fraction of mRNA coming from each cell type, rather than the cell proportions. As the mRNA content per cell type can vary significantly (<xref ref-type="fig" rid="fig1s2">Figure 1—figure supplement 2</xref>), the actual proportions of each cell type can be estimated as:<disp-formula id="equ14"><label>(9)</label><mml:math id="m14"><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub><mml:mo>=</mml:mo><mml:mi>α</mml:mi><mml:mo>∙</mml:mo><mml:mfrac><mml:mrow><mml:msub><mml:mrow><mml:mover accent="true"><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mo>-</mml:mo></mml:mover></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>r</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mfrac></mml:math></disp-formula></p><p>where <italic>r<sub>j</sub></italic> is the amount of RNA nucleotides in cell type <italic>j</italic> (or equivalently the total weight of RNA in each cell type) and α is a normalization constant to have <inline-formula><mml:math id="inf11"><mml:mrow><mml:mo>∑</mml:mo><mml:mrow><mml:msub><mml:mrow><mml:mi>p</mml:mi></mml:mrow><mml:mrow><mml:mi>j</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:math></inline-formula>.</p><p>Another method, DeMix (<xref ref-type="bibr" rid="bib1">Ahn et al., 2013</xref>), starts from <xref ref-type="disp-formula" rid="equ1">Equation (1)</xref> to estimate the proportion and gene expression profile from cancer cells in mixed samples. In this method the mixed sample is assumed to be composed only by two cell types: cancer cells (without any <italic>a priori</italic> known gene expression profile) and normal cells (with known gene expression data, which can either come from tumor-matched or unmatched samples). This method was developed for microarray data and shows that it was important to use the raw data as input assuming it follows a log-normal distribution as is the case for microarray, instead of working with log-transformed data like most other methods did. DeMix estimates the variance of the gene expression in the normal samples and uses this in the maximum likelihood estimation to predict the cancer cell gene expression and proportions, using thus implicitly a gene-specific weight for each gene. EPIC was derived for RNA-seq data and is directly using linear (non-log) data. Notably, when solving the linear regression from <xref ref-type="disp-formula" rid="equ9">Equation (7)</xref> in EPIC, we are not assuming any specific distribution for the gene expression and the weights we give to each gene are simply based on their interquartile range in the reference samples. Other measures of gene variability could however be given as input into EPIC's <italic>R-package</italic>. Contrary to DeMix, another important assumption performed in EPIC is that our signature genes are not expressed by the cancer cells, so that we can easily estimate the proportion of multiple non-malignant cell types composing the bulk samples.</p></sec><sec id="s4-3"><title>Flow cytometry and gene expression analysis of melanoma samples</title><p>Patients agreed to donate metastatic tissues upon informed consent, based on dedicated clinical investigation protocols established according to the relevant regulatory standards. The protocols were approved by the local IRB, that is, the 'Commission cantonale d’éthique de la recherche sur l’être humain du Canton de Vaud'. Lymph nodes (LN) were obtained from stage III melanoma patients, by lymph node dissection that took place before systemic treatment. The LN from one patient was from the right axilla and the LNs from the other three patients were from the iliac and ilio-obturator regions (<xref ref-type="table" rid="app2table1">Appendix 2—table 1</xref>). Single cell suspensions were obtained by mechanical disruption and immediately cryopreserved in RPMI 1640 supplemented with 40% FCS and 10% DMSO. Single cell suspensions from four lymph nodes were thawed and used in parallel experiments of flow cytometry and RNA extraction. In order to limit the number of dead cells after thawing, we removed those cells using a dead cell removal kit (Miltenyi Biotech). Proportions of CD4 T (CD45<sup>+</sup>/CD3<sup>+</sup>/CD4<sup>+</sup>/Melan-A<sup>-</sup>), CD8 T (CD45<sup>+</sup>/CD3<sup>+</sup>/CD8<sup>+</sup>/Melan-A<sup>−</sup>), NK (CD45<sup>+</sup>/CD56<sup>+</sup>/CD3<sup>−</sup>/CD33<sup>−</sup>/Melan-A<sup>−</sup>), B (CD45<sup>+</sup>/CD19<sup>+</sup>/CD3<sup>−</sup>/CD33<sup>−</sup>/Melan-A<sup>−</sup>) and Melan-A expressing tumor cells (<xref ref-type="supplementary-material" rid="supp3">Supplementary file 3A</xref>) were acquired via flow cytometry using the following antibodies: anti-CD3 BV711 (RRID:<ext-link ext-link-type="uri" xlink:href="https://scicrunch.org/resolver/AB_2566035">AB_2566035</ext-link>), anti-CD4 BUV737 (RRID:<ext-link ext-link-type="uri" xlink:href="https://scicrunch.org/resolver/AB_2713927">AB_2713927</ext-link>), anti-CD8 PE-Cy5 (RRID:<ext-link ext-link-type="uri" xlink:href="https://scicrunch.org/resolver/AB_2713928">AB_2713928</ext-link>), anti-CD56 BV421 (RRID:<ext-link ext-link-type="uri" xlink:href="https://scicrunch.org/resolver/AB_11218798">AB_11218798</ext-link>), anti-CD19 APCH7 (RRID:<ext-link ext-link-type="uri" xlink:href="https://scicrunch.org/resolver/AB_1645728">AB_1645728</ext-link>), anti-CD33 PE-Cy7 (RRID:<ext-link ext-link-type="uri" xlink:href="https://scicrunch.org/resolver/AB_2713932">AB_2713932</ext-link>), anti-CD45 APC (RRID:<ext-link ext-link-type="uri" xlink:href="https://scicrunch.org/resolver/AB_314400">AB_314400</ext-link>), anti-Melan-A FITC (RRID:<ext-link ext-link-type="uri" xlink:href="https://scicrunch.org/resolver/AB_2713930">AB_2713930</ext-link>) and Fixable Viability Dye eFluor 455UV (eBioscience). Data was acquired on a BD LSR II SORP flow cytometry machine (BD Bioscience). Analysis was performed using FlowJo (Tree Star). Cell proportions were based on viable cells only. In parallel total RNA was extracted using the RNAeasy Plus mini kit (Qiagen) following the manufactures’ protocol. Starting material always contained minimum 0.2 × 10<sup>6</sup> cells. RNA was quantified and integrity was analyzed using a Fragment Analyser (Advanced Analytical). Total RNA from all samples used for sequencing had an RQN ≥7. Libraries were obtained using the Truseq stranded RNA kit (Illumina). Single read (100 bp) was performed using an Illumina HiSeq 2500 sequencer (Illumina).</p><p>Post processing of the sequencing was done using Illumina pipeline Casava 1.82. FastQC (version 0.10.1) was used for quality control. RNA-seq reads alignment to the human genome, <italic>hg19</italic>, and TPM quantification were performed with <italic>RSEM</italic> (<xref ref-type="bibr" rid="bib31">Li and Dewey, 2011</xref>) version 1.2.19, using <italic>Bowtie2</italic> (<xref ref-type="bibr" rid="bib29">Langmead and Salzberg, 2012</xref>) version 2.2.4 and <italic>Samtools</italic> (<xref ref-type="bibr" rid="bib30">Li et al., 2009</xref>) version 1.2.</p><p>RNA-Seq data from this experiment have been deposited in NCBI's Gene Expression Omnibus (<xref ref-type="bibr" rid="bib12">Edgar et al., 2002</xref>) and are accessible through GEO Series accession number GSE93722 (<ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE93722">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE93722</ext-link>).</p></sec><sec id="s4-4"><title>Amount of mRNA per cell type</title><p>Healthy donor peripheral blood was obtained through the blood transfusion center in Lausanne. PBMCs were purified by density gradient using Lymphoprep (Axis-Shieldy). Mononuclear cells were stained in order to sort monocytes, B, T and NK cells using the following antibodies: CD14 FITC (RRID:<ext-link ext-link-type="uri" xlink:href="https://scicrunch.org/resolver/AB_130992">AB_130992</ext-link>), CD19 PE (RRID:<ext-link ext-link-type="uri" xlink:href="https://scicrunch.org/resolver/AB_2716572">AB_2716572</ext-link>), CD3 APC (RRID:<ext-link ext-link-type="uri" xlink:href="https://scicrunch.org/resolver/AB_130788">AB_130788</ext-link>), CD56 BV421 (RRID:<ext-link ext-link-type="uri" xlink:href="https://scicrunch.org/resolver/AB_11218798">AB_11218798</ext-link>) and fixable live/dead near IR stain (ThermoFisher Scientific). 1 × 10<sup>6</sup> live cells from each cell type were sorted using the BD FACS ARIA III (BD Biosciences). Total RNA was extracted using the RNAeasy Plus mini kit (Qiagen) following the manufactures’ protocol and quantified using a Fragment Analyser (Advanced Analytical). Values obtained are given in <xref ref-type="fig" rid="fig1s2">Figure 1—figure supplement 2A</xref>.</p><p>The mRNA content for the cancer cells was estimated from the flow cytometry data described in the previous section from the four patients with melanoma. For this we used the forward scatter width, which is a good proxy of cell size and mRNA content (<xref ref-type="bibr" rid="bib39">Padovan-Merhar et al., 2015</xref>; <xref ref-type="bibr" rid="bib52">Tzur et al., 2011</xref>), and observed that cancer cells had similar amount of mRNA than B, NK and T cells (<xref ref-type="fig" rid="fig1s2">Figure 1—figure supplement 2B</xref>). We thus used a value of 0.4 pg of mRNA per cancer cell.</p></sec><sec id="s4-5"><title>Public external datasets used in this study</title><list list-type="bullet"><list-item><p>Dataset 1 was obtained from Zimmermann and colleagues (<xref ref-type="bibr" rid="bib57">Zimmermann et al., 2016</xref>), through ImmPort (<ext-link ext-link-type="uri" xlink:href="http://www.immport.org">http://www.immport.org</ext-link>), accession SDY67. It includes RNA-Seq samples from PBMC of healthy donors before and after influenza vaccination. In addition, the original flow cytometry results files were available, containing multiple immune cell markers. As an independent validation of EPIC, we used the data from 12 pre-vaccination samples of healthy donors and we computed the corresponding immune cell proportions from the flow cytometry files merging the results from their <italic>innate</italic> and <italic>Treg panels</italic> (obtaining B, CD4 T, CD8 T, NK cells and monocytes, <xref ref-type="supplementary-material" rid="supp3">Supplementary file 3B</xref>; <xref ref-type="fig" rid="fig2">Figure 2A</xref>)</p></list-item><list-item><p>Dataset 2 was obtained from Hoek and colleagues (<xref ref-type="bibr" rid="bib26">Hoek et al., 2015</xref>), GEO accession GSE64655. This corresponds to RNA-Seq samples from two different donors. Samples have been taken before an influenza vaccination and also 1, 3 and 7 days after the vaccination (56 samples in total). In their experiment, the authors measured RNA-Seq from bulk PBMC samples and also from sorted immune cells (B, NK, T cells, myeloid dendritic cells, monocytes and neutrophils). In addition, flow cytometry was performed to measure the proportion of these cell types in PBMC before the influenza vaccination (personally communicated by the authors; <xref ref-type="supplementary-material" rid="supp3">Supplementary file 3C</xref>).</p></list-item><list-item><p>Dataset 3 was obtained from Linsley and colleagues (<xref ref-type="bibr" rid="bib34">Linsley et al., 2014</xref>), GEO accession GSE60424. This dataset includes 20 donors (healthy donors and other donors with amyotrophic lateral sclerosis, multiple sclerosis, type one diabetes or sepsis), for a total of 134 samples. RNA-Seq from these donors has been extracted from whole blood and sorted immune cells (B, NK cells, monocytes, neutrophils, CD4 T and CD8 T cells). In addition to RNA-Seq data, complete blood counts data were available for 5 of these donors (personally communicated by the authors; <xref ref-type="supplementary-material" rid="supp3">Supplementary file 3D</xref>).</p></list-item><list-item><p>Dataset 4 was obtained from Pabst and colleagues (<xref ref-type="bibr" rid="bib38">Pabst et al., 2016</xref>), GEO accession GSE51984. This includes RNA-Seq from five healthy donors. Samples are from total white blood cells and sorted immune cells (B cells, granulocytes, monocytes and T cells).</p></list-item><list-item><p>Colon cancer dataset was obtained from Becht and colleagues (<xref ref-type="bibr" rid="bib6">Becht et al., 2016</xref>), GEO accession GSE39582. This corresponds to microarrays of primary colon cancer tumors. In addition to gene expression data, immunohistochemistry data of CD3, CD8 and CD68 was available for 33 patients (personally communicated by the authors).</p></list-item><list-item><p>Single-cell RNA-Seq data from tumor-infiltrating cells were obtained from Tirosh and colleagues (<xref ref-type="bibr" rid="bib51">Tirosh et al., 2016</xref>), GEO accession GSE72056. This corresponds to 19 donors and comprises primary tumors, lymph node metastasis or other lesions. It includes 4645 cells. Cell type identity was taken from <xref ref-type="bibr" rid="bib51">Tirosh et al. (2016)</xref> (B, NK, T cell, macrophage, CAFs, endothelial cell, cancer cell as well as cells not assigned a specific cell type). Among the T cells, we then defined subsets based on their gene expression: CD4 T cells (expressing CD4 but not CD8A nor CD8B) and CD8 T cells (expressing CD8A or CD8B but not CD4). The other T cells not corresponding to one of these two groups were removed from further analyses. We further defined among the CD4 T cells: Treg (expressing either FOXP3 or CD25 above the median among CD4 T cells) and Thelper (those CD4 T cells not belonging to Treg group). In silico reconstructed bulk samples from each donor were obtained as the average per gene from all samples of the given donor. The corresponding cell fractions from these bulk samples were obtained as the number of cells from each cell type divided by the total number of cells (<xref ref-type="supplementary-material" rid="supp3">Supplementary file 3E</xref>). In the results, we split this dataset in two depending on the origin of the biopsies: lymphoid tissues for samples obtained from lymph node and spleen metastases, vs. the rest of samples, which were obtained from primary tumor and other metastases.</p></list-item></list><p>For the above datasets 2 and 3, we obtained raw <italic>fastq</italic> files. RNA-seq reads alignment to the human genome, <italic>hg19</italic>, and TPM quantification were performed with <italic>RSEM</italic> (<xref ref-type="bibr" rid="bib31">Li and Dewey, 2011</xref>) version 1.2.19, using <italic>Bowtie2</italic> (<xref ref-type="bibr" rid="bib29">Langmead and Salzberg, 2012</xref>) version 2.2.4 and <italic>Samtools</italic> (<xref ref-type="bibr" rid="bib30">Li et al., 2009</xref>) version 1.2.</p><p>For the other datasets, we directly obtained the summary counts data from the respective studies without mapping the reads by ourselves, and we transformed these counts to TPM wherever necessary.</p></sec><sec id="s4-6"><title>Reference gene expression profiles from circulating cells</title><p>Reference gene expression profiles of sorted immune cells from peripheral blood were built from the datasets 2, 3 and 4 described in previous section. We verified no experimental biases were present in these data through unsupervised clustering of the samples, with help of a principal component analysis based on the normalized expression from the 1000 most variable genes (<xref ref-type="fig" rid="fig1">Figure 1C</xref>).</p><p>The median value of TPM counts was computed per cell type and per gene. Similarly, the interquartile range of the TPM counts was computed per cell type and gene, as a measure of the variability of each gene expression in each cell type. Values of these reference profiles are given in <xref ref-type="supplementary-material" rid="supp1">Supplementary file 1</xref>). Granulocytes from dataset 4 and neutrophils from datasets 2 and 3 were combined to build the reference profile for neutrophils (neutrophils constitute more than 90% of granulocytes). No reference profile was built for the myeloid dendritic cells as only few samples of these sorted cells existed and they were all from the same experiment. Monocytes are not found in tumors but instead there are macrophages, mostly from monocytic lineage, that are infiltrating tumors and that are not found in blood. For this reason, we also used the monocyte reference gene expression profile as a proxy for macrophages when applying EPIC to tumor samples. Such an assumption gave coherent results as observed in the results.</p></sec><sec id="s4-7"><title>Reference profiles from tumor-infiltrating cells</title><p>We also built gene expression reference profiles from tumor-infiltrating cells. These are based on the single-cell RNA-Seq data from Tirosh and colleagues (<xref ref-type="bibr" rid="bib51">Tirosh et al., 2016</xref>) described above. We only used the non-lymphoid tissue samples to build these tumor-infiltrating cell’s profiles, avoiding in this way potential ‘normal immune cells’ present in the lymph nodes and spleen. These reference profiles (<xref ref-type="supplementary-material" rid="supp2">Supplementary file 2</xref>) were built in the same way as described above for the reference profiles of circulating immune cells, but based on the mean and standard deviation instead of median and interquartile range respectively, due to the nature of single-cell RNA-Seq data and gene dropout present with such technique.</p><p>When testing EPIC with these profiles for the single-cell RNA-Seq datasets, for the samples of primary tumor and other non-lymph node metastases, a leave-one-out procedure was applied: for each donor we built reference cell profiles based only on the data coming from the other donors.</p></sec><sec id="s4-8"><title>Cell marker gene identification</title><p>EPIC relies on signature genes that are expressed by the reference cells but not by the uncharacterized cells (e.g., cancer cells). For each reference cell type, we thus built a list of signature genes through the following steps:</p><list list-type="order"><list-item><p>The samples (from the peripheral blood datasets) from each immune cell type were tested for overexpression against:</p><list list-type="alpha-lower"><list-item><p>the samples from each other immune cell of peripheral blood datasets (1 cell type vs. 1 other cell type at a time);</p></list-item><list-item><p>the samples of the Illumina Human Body Map 2.0 Project (ArrayExpress ID: E-MTAB-513) considering all non-immune related tissues;</p></list-item><list-item><p>the samples from GTEx (<xref ref-type="bibr" rid="bib16">GTEx Consortium, 2015</xref>) from each of the following tissues (one tissue at a time): adipose subcutaneous; bladder; colon-transverse; ovary; pancreas; testis (data version V6p).</p></list-item></list></list-item><list-item><p>Only genes overexpressed in the given cell type with an adjusted p-value&lt;0.01 for all these tests were kept. Conditions 1b) and 1c) are there to ensure signature genes are expressed in the immune cells and no other tissues.</p></list-item><list-item><p>The genes that passed 2) were then ranked by the fold change from the overexpression tests to preselect the genes showing the biggest difference between the various cell types.</p></list-item><list-item><p>The list of genes was then manually curated, comparing the expression of the genes per cell type in the peripheral blood datasets and the tumor-infiltrating cells dataset: only genes expressed at similar levels between the blood and tumor-infiltrating cells were kept (to avoid differences due to exhaustion phenotype for example). Genes expressed at much higher levels than the other genes were also removed from the signature as these could have biased the least-square optimization towards good predictions for these genes only.</p></list-item><list-item><p>In addition to CD4 and CD8 T cells signatures, we built a signature list of general T cell genes in the same way as described above, and it contains genes expressed at similar levels in the two T cell subtypes. This general T cell signature is also part of EPIC, even when predicting the proportions of the T cell subsets.</p></list-item><list-item><p>For the tumor-infiltrating cell reference profiles, signature genes from CAFs, endothelial cells and macrophages were also needed. These were built in a similar way than above, considering the overexpression from each of these cell types against each other cell type from the tumor-infiltrating cells data.</p></list-item></list><p>All the differential expression tests were performed with <italic>DESeq2</italic> (<xref ref-type="bibr" rid="bib36">Love et al., 2014</xref>).</p><p><xref ref-type="table" rid="app1table1">Appendix 1—table 1</xref> summarizes the full list of signature genes per cell type.</p></sec><sec id="s4-9"><title>Prediction of cell proportions in bulk samples with other tools</title><p>We compared EPIC's predictions with those from various cell fraction prediction methods. These other methods were run with the following packages (using the default options when possible):</p><list list-type="bullet"><list-item><p>CIBERSORT (<xref ref-type="bibr" rid="bib37">Newman et al., 2015</xref>) (R package version 1.03) was run based on two different gene expression reference profiles:</p><list list-type="bullet"><list-item><p>based on the <italic>LM22</italic> reference profiles derived in (<xref ref-type="bibr" rid="bib37">Newman et al., 2015</xref>). For comparison with the experimentally measured cell proportions, we summed together the sub-types predictions of CIBERSORT within each major immune cell type.</p></list-item><list-item><p>based on the reference profiles and signature genes we derived here for EPIC.</p></list-item></list></list-item><list-item><p>DeconRNASeq (v1.16) (<xref ref-type="bibr" rid="bib21">Gong and Szustakowski, 2013</xref>) does not contain immune cell reference profiles and we used the reference profiles we derived here as well as the corresponding signature genes. We present the results with ‘use.scale’ parameter set to FALSE, which usually gave better results.</p></list-item><list-item><p>DSA (<xref ref-type="bibr" rid="bib56">Zhong et al., 2013</xref>) only needs a gene signature per cell type to estimate the proportion of cells in multiple bulk samples together. We used the implementation of DSA found in CellMix (<xref ref-type="bibr" rid="bib19">Gaujoux and Seoighe, 2013</xref>) R package (version 1.6.2). As DSA needs many samples to estimate simultaneously the proportions of cells in these samples, we considered all the PBMC samples from Hoek et al. data when fitting this dataset (eight samples) and all whole blood samples from Linsley et al. data when fitting this other dataset (20 samples), even though the cell proportions have been measured experimentally only for 2 and 5 samples respectively. For the gene signature, we used the same genes as those used for EPIC (<xref ref-type="table" rid="app1table1">Appendix 1—table 1</xref>; markers of B cells, CD4 T cells, CD8 T cells, monocytes, neutrophils and NK cells for the predictions in the blood datasets; markers of B cells, CAFs, CD4 T cells, CD8 T cells, endothelial cells, macrophages, and NK cells for the predictions in solid tumors).</p></list-item><list-item><p>ISOpure (<xref ref-type="bibr" rid="bib41">Quon et al., 2013</xref>) estimates the profile and proportion of cancer cells by comparing many bulk samples containing cancer cells and many healthy bulk samples of the same tissue. Although the primary goal is not to compute the proportions of the different cell types composing a sample, cell fractions can still be obtained with this method. In particular, one output of ISOpure is how much each of the healthy reference samples is contributing to a given bulk sample. Instead of using bulk healthy samples, we used our cell reference profiles, so that each ‘reference sample’ corresponded to a different cell type. These reference samples and the bulk samples were then subsetted by the same signature genes that we derived for EPIC. ISOpure was then run based on these data. The contribution of each cell type was taken as the relative contribution outputted by ISOpure from each of the reference cell sample. The R implementation ISOpureR (<xref ref-type="bibr" rid="bib3">Anghel et al., 2015</xref>) version 1.0.21 was used.</p></list-item><list-item><p>MCP-counter (<xref ref-type="bibr" rid="bib6">Becht et al., 2016</xref>) (R package version 1.1.0) was run with the ‘<italic>HUGO_symbols</italic>’ chosen as features or with ‘affy133P2_probesets’ for the microarray-based IHC dataset.</p></list-item><list-item><p>TIMER (<xref ref-type="bibr" rid="bib33">Li et al., 2016</xref>) predictions were obtained by slightly adapting the available source code. The reference profiles available in TIMER were used directly. In addition to bulk gene expression, tumor purity estimates based on DNA copy number variation are needed in TIMER to refine the gene signature. As this information is not available in our benchmarking datasets, we kept all the original immune gene signatures for the predictions in blood. For the tumor datasets, we used the gene signatures obtained from the TCGA data for melanoma or colorectal cancer depending on the origin of cancer.</p></list-item><list-item><p>ESTIMATE (<xref ref-type="bibr" rid="bib54">Yoshihara et al., 2013</xref>) was run with their R package version 1.0.11.</p></list-item></list><p>For CIBERSORT, DeconRNASeq and ISOpure, when run based on our gene expression reference profiles, we used the reference profiles from peripheral blood immune cells for the predictions in blood and the reference profiles from tumor-infiltrating cells for the predictions in solid tumors.</p></sec><sec id="s4-10"><title>List of abbreviations</title><p>CAFs: cancer-associated fibroblasts; EPIC: acronym for our method to ‘Estimate the Proportion of Immune and Cancer cells’; GEO: Gene Expression Omnibus; IHC: immunohistochemistry; PCA: principal component analysis; RMSE: root mean squared error; TCGA: The Cancer Genome Atlas; TPM: transcripts per million.</p></sec></sec></body><back><ack id="ack"><title>Acknowledgements</title><p>We are grateful to Hélène Maby-El Hajjami for compiling the clinical data. We thank Kristen L. Hoek, Andrew Link and their colleagues (<xref ref-type="bibr" rid="bib26">Hoek et al., 2015</xref>), Cate Speak, Scott Presnell and their colleagues (<xref ref-type="bibr" rid="bib34">Linsley et al., 2014</xref>), Aurélien De Reynies, Etienne Becht and their colleagues (<xref ref-type="bibr" rid="bib6">Becht et al., 2016</xref>), for providing us with additional data relating to their published studies. Computations were performed at the Vital-IT (<ext-link ext-link-type="uri" xlink:href="http://www.vital-it.ch">http://www.vital-it.ch</ext-link>) Center for high-performance computing of the Swiss Institute of Bioinformatics.</p></ack><sec id="s5" sec-type="additional-information"><title>Additional information</title><fn-group content-type="competing-interest"><title>Competing interests</title><fn fn-type="COI-statement" id="conf1"><p>No competing interests declared</p></fn></fn-group><fn-group content-type="author-contribution"><title>Author contributions</title><fn fn-type="con" id="con1"><p>Conceptualization, Data curation, Software, Formal analysis, Validation, Investigation, Visualization, Methodology, Writing—original draft, Writing—review and editing</p></fn><fn fn-type="con" id="con2"><p>Investigation, Methodology, Writing—review and editing</p></fn><fn fn-type="con" id="con3"><p>Resources, Supervision, Investigation, Methodology</p></fn><fn fn-type="con" id="con4"><p>Resources, Supervision, Methodology, Writing—review and editing</p></fn><fn fn-type="con" id="con5"><p>Conceptualization, Resources, Supervision, Funding acquisition, Validation, Methodology, Writing—original draft, Project administration, Writing—review and editing</p></fn></fn-group><fn-group content-type="ethics-information"><title>Ethics</title><fn fn-type="other"><p>Human subjects: Patients involved in this study agreed to donate metastatic tissues upon informed consent, based on dedicated clinical investigation protocols established according to the relevant regulatory standards. The protocols were approved by the local IRB, i.e. the Commission cantonale d'éthique de la recherche sur l'être humain du Canton de Vaud.</p></fn></fn-group></sec><sec id="s6" sec-type="supplementary-material"><title>Additional files</title><supplementary-material id="supp1"><object-id pub-id-type="doi">10.7554/eLife.26476.022</object-id><label>Supplementary file 1.</label><caption><title>Gene expression reference profiles, built from TPM (transcripts per million) normalized RNA-Seq data of immune cells sorted from blood as described in the Materials and methods: ‘<italic>Reference gene expression profiles from circulating cells</italic>’.</title><p>The file includes two sheets: (A) the reference gene expression values; (B) the gene variability relating to the reference profile. Columns indicate the reference cell types; rows indicate the gene names.</p></caption><media mime-subtype="xlsx" mimetype="application" xlink:href="elife-26476-supp1-v2.xlsx"/></supplementary-material><supplementary-material id="supp2"><object-id pub-id-type="doi">10.7554/eLife.26476.023</object-id><label>Supplementary file 2.</label><caption><title>Gene expression reference profiles built from tumor-infiltrating cells obtained from TPM normalized single-cell RNA-Seq data as described in the Materials and methods: ‘<italic>Reference profiles from tumor-infiltrating cells</italic>’.</title><p>The file includes two sheets: (A) the reference gene expression values; (B) the gene variability relating to the reference profile. Columns indicate the reference cell types; rows indicate the gene names.</p></caption><media mime-subtype="xlsx" mimetype="application" xlink:href="elife-26476-supp2-v2.xlsx"/></supplementary-material><supplementary-material id="supp3"><object-id pub-id-type="doi">10.7554/eLife.26476.024</object-id><label>Supplementary file 3.</label><caption><title>Proportion of cells measured in the different datasets: (A) this study; (B) dataset 1 (<xref ref-type="bibr" rid="bib57">Zimmermann et al., 2016</xref>); (C) dataset 2 (<xref ref-type="bibr" rid="bib26">Hoek et al., 2015</xref>); (D) dataset 3 (<xref ref-type="bibr" rid="bib34">Linsley et al., 2014</xref>); and (E) single-cell RNA-Seq dataset (<xref ref-type="bibr" rid="bib51">Tirosh et al., 2016</xref>).</title><p>The ‘Other cells’ type corresponds always to the rest of the cells that were not assigned to one of the given cell types from the tables.</p></caption><media mime-subtype="xlsx" mimetype="application" xlink:href="elife-26476-supp3-v2.xlsx"/></supplementary-material><supplementary-material id="transrepform"><object-id pub-id-type="doi">10.7554/eLife.26476.025</object-id><label>Transparent reporting form</label><media mime-subtype="docx" mimetype="application" xlink:href="elife-26476-transrepform-v2.docx"/></supplementary-material><sec id="s9" sec-type="datasets"><title>Major datasets</title><p>The following dataset was generated:</p><p><related-object content-type="generated-dataset" id="dataset1" source-id="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE93722" source-id-type="uri"><collab collab-type="author">Racle J</collab><collab collab-type="author">de Jonge K</collab><collab collab-type="author">Baumgaertner P</collab><collab collab-type="author">Speiser DE</collab><collab collab-type="author">Gfeller D</collab><year>2017</year><source>Simultaneous enumeration of cancer and immune cell types from tumor gene expression data</source><ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE93722">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE93722</ext-link><comment>Publicly available at the NCBI Gene Expression Omnibus (accession no: GSE93722)</comment></related-object></p><p>The following previously published datasets were used:</p><p><related-object content-type="generated-dataset" id="dataset2" source-id="http://www.immport.org/immport-open/public/study/study/displayStudyDetail/SDY67" source-id-type="uri"><collab collab-type="author">Poland G</collab><year>2015</year><source>Bioinformatics Approach to 2010-2011 TIV Influenza A/H1N1 Vaccine Immune Profiling</source><ext-link ext-link-type="uri" xlink:href="http://www.immport.org/immport-open/public/study/study/displayStudyDetail/SDY67">http://www.immport.org/immport-open/public/study/study/displayStudyDetail/SDY67</ext-link><comment>Available at ImmPort (accession no: SDY67)</comment></related-object></p><p><related-object content-type="generated-dataset" id="dataset3" source-id="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE64655" source-id-type="uri"><collab collab-type="author">Hoek KL</collab><collab collab-type="author">Link AJ</collab><year>2015</year><source>A Cell-based Systems Biology Assessment of Human Blood to Monitor Immune Responses After Influenza Vaccination</source><ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE64655">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE64655</ext-link><comment>Publicly available at the NCBI Gene Expression Omnibus (accession no: GSE64655)</comment></related-object></p><p><related-object content-type="generated-dataset" id="dataset4" source-id="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE60424" source-id-type="uri"><collab collab-type="author">Speake C</collab><collab collab-type="author">Linsley PS</collab><collab collab-type="author">Whalen E</collab><collab collab-type="author">Chaussabel D</collab><collab collab-type="author">Presnell SR</collab><collab collab-type="author">Mason MJ</collab><collab collab-type="author">Gersuk VH</collab><collab collab-type="author">O'Brien KK</collab><collab collab-type="author">Nguyen Q</collab><collab collab-type="author">Greenbaum CJ</collab><collab collab-type="author">Buckner JH</collab><collab collab-type="author">Malhotra U</collab><year>2015</year><source>Next generation sequencing of human immune cell subsets across diseases</source><ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE60424">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE60424</ext-link><comment>Publicly available at the NCBI Gene Expression Omnibus (accession no: GSE60424)</comment></related-object></p><p><related-object content-type="generated-dataset" id="dataset5" source-id="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE51984" source-id-type="uri"><collab collab-type="author">Sauvageau G</collab><collab collab-type="author">Pabst C</collab><collab collab-type="author">Yeh J</collab><year>2016</year><source>RNA-Seq analysis of human adult peripheral blood populations</source><ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE51984">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE51984</ext-link><comment>Publicly available at the NCBI Gene Expression Omnibus (accession no: GSE51984)</comment></related-object></p><p><related-object content-type="generated-dataset" id="dataset6" source-id="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE39582" source-id-type="uri"><collab collab-type="author">Marisa L</collab><collab collab-type="author">de Reyniès A</collab><collab collab-type="author">Duval A</collab><collab collab-type="author">Selves J</collab><collab collab-type="author">Gaub M</collab><collab collab-type="author">Vescovo L</collab><collab collab-type="author">Etienne-Grimaldi M</collab><collab collab-type="author">Schiappa R</collab><collab collab-type="author">Guenot D</collab><collab collab-type="author">Ayadi M</collab><collab collab-type="author">Kirzin S</collab><collab collab-type="author">Chazal M</collab><collab collab-type="author">Fléjou J</collab><collab collab-type="author">Benchimol D</collab><collab collab-type="author">Pencreach E</collab><collab collab-type="author">Lagarde A</collab><collab collab-type="author">Piard F</collab><collab collab-type="author">Elias D</collab><collab collab-type="author">Olschwang S</collab><collab collab-type="author">Milano G</collab><collab collab-type="author">Laurent-Puig P</collab><collab collab-type="author">Boige V</collab><year>2013</year><source>Gene expression Classification of Colon Cancer defines six molecular subtypes with distinct clinical, molecular and survival characteristics [Expression]</source><ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE39582">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE39582</ext-link><comment>Publicly available at the NCBI Gene Expression Omnibus (accession no: GSE39582)</comment></related-object></p><p><related-object content-type="generated-dataset" id="dataset7" source-id="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE72056" source-id-type="uri"><collab collab-type="author">Tirosh I</collab><collab collab-type="author">Izar B</collab><year>2016</year><source>Single cell RNA-seq analysis of melanoma</source><ext-link ext-link-type="uri" xlink:href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE72056">https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE72056</ext-link><comment>Publicly available at the NCBI Gene Expression Omnibus (accession no: GSE72056)</comment></related-object></p></sec></sec><ref-list><title>References</title><ref id="bib1"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ahn</surname> <given-names>J</given-names></name><name><surname>Yuan</surname> <given-names>Y</given-names></name><name><surname>Parmigiani</surname> <given-names>G</given-names></name><name><surname>Suraokar</surname> <given-names>MB</given-names></name><name><surname>Diao</surname> <given-names>L</given-names></name><name><surname>Wistuba</surname> <given-names>II</given-names></name><name><surname>Wang</surname> <given-names>W</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>DeMix: deconvolution for mixed cancer transcriptomes using raw measured data</article-title><source>Bioinformatics</source><volume>29</volume><fpage>1865</fpage><lpage>1871</lpage><pub-id pub-id-type="doi">10.1093/bioinformatics/btt301</pub-id><pub-id pub-id-type="pmid">23712657</pub-id></element-citation></ref><ref id="bib2"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Angelova</surname> <given-names>M</given-names></name><name><surname>Charoentong</surname> <given-names>P</given-names></name><name><surname>Hackl</surname> <given-names>H</given-names></name><name><surname>Fischer</surname> <given-names>ML</given-names></name><name><surname>Snajder</surname> <given-names>R</given-names></name><name><surname>Krogsdam</surname> <given-names>AM</given-names></name><name><surname>Waldner</surname> <given-names>MJ</given-names></name><name><surname>Bindea</surname> <given-names>G</given-names></name><name><surname>Mlecnik</surname> <given-names>B</given-names></name><name><surname>Galon</surname> <given-names>J</given-names></name><name><surname>Trajanoski</surname> <given-names>Z</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Characterization of the immunophenotypes and antigenomes of colorectal cancers reveals distinct tumor escape mechanisms and novel targets for immunotherapy</article-title><source>Genome Biology</source><volume>16</volume><elocation-id>64</elocation-id><pub-id pub-id-type="doi">10.1186/s13059-015-0620-6</pub-id><pub-id pub-id-type="pmid">25853550</pub-id></element-citation></ref><ref id="bib3"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Anghel</surname> <given-names>CV</given-names></name><name><surname>Quon</surname> <given-names>G</given-names></name><name><surname>Haider</surname> <given-names>S</given-names></name><name><surname>Nguyen</surname> <given-names>F</given-names></name><name><surname>Deshwar</surname> <given-names>AG</given-names></name><name><surname>Morris</surname> <given-names>QD</given-names></name><name><surname>Boutros</surname> <given-names>PC</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>ISOpureR: an R implementation of a computational purification algorithm of mixed tumour profiles</article-title><source>BMC Bioinformatics</source><volume>16</volume><elocation-id>156</elocation-id><pub-id pub-id-type="doi">10.1186/s12859-015-0597-x</pub-id><pub-id pub-id-type="pmid">25972088</pub-id></element-citation></ref><ref id="bib4"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Balch</surname> <given-names>CM</given-names></name><name><surname>Riley</surname> <given-names>LB</given-names></name><name><surname>Bae</surname> <given-names>YJ</given-names></name><name><surname>Salmeron</surname> <given-names>MA</given-names></name><name><surname>Platsoucas</surname> <given-names>CD</given-names></name><name><surname>von Eschenbach</surname> <given-names>A</given-names></name><name><surname>Itoh</surname> <given-names>K</given-names></name></person-group><year iso-8601-date="1990">1990</year><article-title>Patterns of human tumor-infiltrating lymphocytes in 120 human cancers</article-title><source>Archives of Surgery</source><volume>125</volume><fpage>200</fpage><lpage>205</lpage><pub-id pub-id-type="doi">10.1001/archsurg.1990.01410140078012</pub-id><pub-id pub-id-type="pmid">1689143</pub-id></element-citation></ref><ref id="bib5"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Baron</surname> <given-names>M</given-names></name><name><surname>Veres</surname> <given-names>A</given-names></name><name><surname>Wolock</surname> <given-names>SL</given-names></name><name><surname>Faust</surname> <given-names>AL</given-names></name><name><surname>Gaujoux</surname> <given-names>R</given-names></name><name><surname>Vetere</surname> <given-names>A</given-names></name><name><surname>Ryu</surname> <given-names>JH</given-names></name><name><surname>Wagner</surname> <given-names>BK</given-names></name><name><surname>Shen-Orr</surname> <given-names>SS</given-names></name><name><surname>Klein</surname> <given-names>AM</given-names></name><name><surname>Melton</surname> <given-names>DA</given-names></name><name><surname>Yanai</surname></name></person-group><year iso-8601-date="2016">2016</year><article-title>A single-cell transcriptomic map of the human and mouse pancreas reveals inter- and intra-cell population structure</article-title><source>Cell Systems</source><volume>3</volume><fpage>346</fpage><lpage>360</lpage><pub-id pub-id-type="doi">10.1016/j.cels.2016.08.011</pub-id><pub-id pub-id-type="pmid">27667365</pub-id></element-citation></ref><ref id="bib6"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Becht</surname> <given-names>E</given-names></name><name><surname>Giraldo</surname> <given-names>NA</given-names></name><name><surname>Lacroix</surname> <given-names>L</given-names></name><name><surname>Buttard</surname> <given-names>B</given-names></name><name><surname>Elarouci</surname> <given-names>N</given-names></name><name><surname>Petitprez</surname> <given-names>F</given-names></name><name><surname>Selves</surname> <given-names>J</given-names></name><name><surname>Laurent-Puig</surname> <given-names>P</given-names></name><name><surname>Sautès-Fridman</surname> <given-names>C</given-names></name><name><surname>Fridman</surname> <given-names>WH</given-names></name><name><surname>de Reyniès</surname> <given-names>A</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Estimating the population abundance of tissue-infiltrating immune and stromal cell populations using gene expression</article-title><source>Genome Biology</source><volume>17</volume><elocation-id>218</elocation-id><pub-id pub-id-type="doi">10.1186/s13059-016-1070-5</pub-id><pub-id pub-id-type="pmid">27765066</pub-id></element-citation></ref><ref id="bib7"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Carmona</surname> <given-names>SJ</given-names></name><name><surname>Teichmann</surname> <given-names>SA</given-names></name><name><surname>Ferreira</surname> <given-names>L</given-names></name><name><surname>Macaulay</surname> <given-names>IC</given-names></name><name><surname>Stubbington</surname> <given-names>MJ</given-names></name><name><surname>Cvejic</surname> <given-names>A</given-names></name><name><surname>Gfeller</surname> <given-names>D</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Single-cell transcriptome analysis of fish immune cells provides insight into the evolution of vertebrate immune cell types</article-title><source>Genome Research</source><volume>27</volume><fpage>451</fpage><lpage>461</lpage><pub-id pub-id-type="doi">10.1101/gr.207704.116</pub-id><pub-id pub-id-type="pmid">28087841</pub-id></element-citation></ref><ref id="bib8"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Carter</surname> <given-names>SL</given-names></name><name><surname>Cibulskis</surname> <given-names>K</given-names></name><name><surname>Helman</surname> <given-names>E</given-names></name><name><surname>McKenna</surname> <given-names>A</given-names></name><name><surname>Shen</surname> <given-names>H</given-names></name><name><surname>Zack</surname> <given-names>T</given-names></name><name><surname>Laird</surname> <given-names>PW</given-names></name><name><surname>Onofrio</surname> <given-names>RC</given-names></name><name><surname>Winckler</surname> <given-names>W</given-names></name><name><surname>Weir</surname> <given-names>BA</given-names></name><name><surname>Beroukhim</surname> <given-names>R</given-names></name><name><surname>Pellman</surname> <given-names>D</given-names></name><name><surname>Levine</surname> <given-names>DA</given-names></name><name><surname>Lander</surname> <given-names>ES</given-names></name><name><surname>Meyerson</surname> <given-names>M</given-names></name><name><surname>Getz</surname> <given-names>G</given-names></name></person-group><year iso-8601-date="2012">2012</year><article-title>Absolute quantification of somatic DNA alterations in human cancer</article-title><source>Nature Biotechnology</source><volume>30</volume><fpage>413</fpage><lpage>421</lpage><pub-id pub-id-type="doi">10.1038/nbt.2203</pub-id><pub-id pub-id-type="pmid">22544022</pub-id></element-citation></ref><ref id="bib9"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Charoentong</surname> <given-names>P</given-names></name><name><surname>Finotello</surname> <given-names>F</given-names></name><name><surname>Angelova</surname> <given-names>M</given-names></name><name><surname>Mayer</surname> <given-names>C</given-names></name><name><surname>Efremova</surname> <given-names>M</given-names></name><name><surname>Rieder</surname> <given-names>D</given-names></name><name><surname>Hackl</surname> <given-names>H</given-names></name><name><surname>Trajanoski</surname> <given-names>Z</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Pan-cancer immunogenomic analyses reveal genotype-immunophenotype relationships and predictors of response to checkpoint blockade</article-title><source>Cell Reports</source><volume>18</volume><fpage>248</fpage><lpage>262</lpage><pub-id pub-id-type="doi">10.1016/j.celrep.2016.12.019</pub-id><pub-id pub-id-type="pmid">28052254</pub-id></element-citation></ref><ref id="bib10"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Clarke</surname> <given-names>J</given-names></name><name><surname>Seo</surname> <given-names>P</given-names></name><name><surname>Clarke</surname> <given-names>B</given-names></name></person-group><year iso-8601-date="2010">2010</year><article-title>Statistical expression deconvolution from mixed tissue samples</article-title><source>Bioinformatics</source><volume>26</volume><fpage>1043</fpage><lpage>1049</lpage><pub-id pub-id-type="doi">10.1093/bioinformatics/btq097</pub-id><pub-id pub-id-type="pmid">20202973</pub-id></element-citation></ref><ref id="bib11"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Clemente</surname> <given-names>CG</given-names></name><name><surname>Mihm</surname> <given-names>MC</given-names></name><name><surname>Bufalino</surname> <given-names>R</given-names></name><name><surname>Zurrida</surname> <given-names>S</given-names></name><name><surname>Collini</surname> <given-names>P</given-names></name><name><surname>Cascinelli</surname> <given-names>N</given-names></name></person-group><year iso-8601-date="1996">1996</year><article-title>Prognostic value of tumor infiltrating lymphocytes in the vertical growth phase of primary cutaneous melanoma</article-title><source>Cancer</source><volume>77</volume><fpage>1303</fpage><lpage>1310</lpage><pub-id pub-id-type="doi">10.1002/(SICI)1097-0142(19960401)77:7&lt;1303::AID-CNCR12&gt;3.0.CO;2-5</pub-id><pub-id pub-id-type="pmid">8608507</pub-id></element-citation></ref><ref id="bib12"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Edgar</surname> <given-names>R</given-names></name><name><surname>Domrachev</surname> <given-names>M</given-names></name><name><surname>Lash</surname> <given-names>AE</given-names></name></person-group><year iso-8601-date="2002">2002</year><article-title>Gene Expression Omnibus: NCBI gene expression and hybridization array data repository</article-title><source>Nucleic Acids Research</source><volume>30</volume><fpage>207</fpage><lpage>210</lpage><pub-id pub-id-type="doi">10.1093/nar/30.1.207</pub-id><pub-id pub-id-type="pmid">11752295</pub-id></element-citation></ref><ref id="bib13"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Efroni</surname> <given-names>I</given-names></name><name><surname>Ip</surname> <given-names>PL</given-names></name><name><surname>Nawy</surname> <given-names>T</given-names></name><name><surname>Mello</surname> <given-names>A</given-names></name><name><surname>Birnbaum</surname> <given-names>KD</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Quantification of cell identity from single-cell gene expression profiles</article-title><source>Genome Biology</source><volume>16</volume><elocation-id>9</elocation-id><pub-id pub-id-type="doi">10.1186/s13059-015-0580-x</pub-id><pub-id pub-id-type="pmid">25608970</pub-id></element-citation></ref><ref id="bib14"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Finak</surname> <given-names>G</given-names></name><name><surname>McDavid</surname> <given-names>A</given-names></name><name><surname>Yajima</surname> <given-names>M</given-names></name><name><surname>Deng</surname> <given-names>J</given-names></name><name><surname>Gersuk</surname> <given-names>V</given-names></name><name><surname>Shalek</surname> <given-names>AK</given-names></name><name><surname>Slichter</surname> <given-names>CK</given-names></name><name><surname>Miller</surname> <given-names>HW</given-names></name><name><surname>McElrath</surname> <given-names>MJ</given-names></name><name><surname>Prlic</surname> <given-names>M</given-names></name><name><surname>Linsley</surname> <given-names>PS</given-names></name><name><surname>Gottardo</surname> <given-names>R</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>MAST: a flexible statistical framework for assessing transcriptional changes and characterizing heterogeneity in single-cell RNA sequencing data</article-title><source>Genome Biology</source><volume>16</volume><elocation-id>278</elocation-id><pub-id pub-id-type="doi">10.1186/s13059-015-0844-5</pub-id><pub-id pub-id-type="pmid">26653891</pub-id></element-citation></ref><ref id="bib15"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Fridman</surname> <given-names>WH</given-names></name><name><surname>Pagès</surname> <given-names>F</given-names></name><name><surname>Sautès-Fridman</surname> <given-names>C</given-names></name><name><surname>Galon</surname> <given-names>J</given-names></name></person-group><year iso-8601-date="2012">2012</year><article-title>The immune contexture in human tumours: impact on clinical outcome</article-title><source>Nature Reviews Cancer</source><volume>12</volume><fpage>298</fpage><lpage>306</lpage><pub-id pub-id-type="doi">10.1038/nrc3245</pub-id><pub-id pub-id-type="pmid">22419253</pub-id></element-citation></ref><ref id="bib16"><element-citation publication-type="journal"><person-group person-group-type="author"><collab>GTEx Consortium</collab></person-group><year iso-8601-date="2015">2015</year><article-title>Human genomics. The Genotype-Tissue Expression (GTEx) pilot analysis: multitissue gene regulation in humans</article-title><source>Science</source><volume>348</volume><fpage>648</fpage><lpage>660</lpage><pub-id pub-id-type="doi">10.1126/science.1262110</pub-id><pub-id pub-id-type="pmid">25954001</pub-id></element-citation></ref><ref id="bib17"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Galon</surname> <given-names>J</given-names></name><name><surname>Costes</surname> <given-names>A</given-names></name><name><surname>Sanchez-Cabo</surname> <given-names>F</given-names></name><name><surname>Kirilovsky</surname> <given-names>A</given-names></name><name><surname>Mlecnik</surname> <given-names>B</given-names></name><name><surname>Lagorce-Pagès</surname> <given-names>C</given-names></name><name><surname>Tosolini</surname> <given-names>M</given-names></name><name><surname>Camus</surname> <given-names>M</given-names></name><name><surname>Berger</surname> <given-names>A</given-names></name><name><surname>Wind</surname> <given-names>P</given-names></name><name><surname>Zinzindohoué</surname> <given-names>F</given-names></name><name><surname>Bruneval</surname> <given-names>P</given-names></name><name><surname>Cugnenc</surname> <given-names>PH</given-names></name><name><surname>Trajanoski</surname> <given-names>Z</given-names></name><name><surname>Fridman</surname> <given-names>WH</given-names></name><name><surname>Pagès</surname> <given-names>F</given-names></name></person-group><year iso-8601-date="2006">2006</year><article-title>Type, density, and location of immune cells within human colorectal tumors predict clinical outcome</article-title><source>Science</source><volume>313</volume><fpage>1960</fpage><lpage>1964</lpage><pub-id pub-id-type="doi">10.1126/science.1129139</pub-id><pub-id pub-id-type="pmid">17008531</pub-id></element-citation></ref><ref id="bib18"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ganesan</surname> <given-names>AP</given-names></name><name><surname>Clarke</surname> <given-names>J</given-names></name><name><surname>Wood</surname> <given-names>O</given-names></name><name><surname>Garrido-Martin</surname> <given-names>EM</given-names></name><name><surname>Chee</surname> <given-names>SJ</given-names></name><name><surname>Mellows</surname> <given-names>T</given-names></name><name><surname>Samaniego-Castruita</surname> <given-names>D</given-names></name><name><surname>Singh</surname> <given-names>D</given-names></name><name><surname>Seumois</surname> <given-names>G</given-names></name><name><surname>Alzetani</surname> <given-names>A</given-names></name><name><surname>Woo</surname> <given-names>E</given-names></name><name><surname>Friedmann</surname> <given-names>PS</given-names></name><name><surname>King</surname> <given-names>EV</given-names></name><name><surname>Thomas</surname> <given-names>GJ</given-names></name><name><surname>Sanchez-Elsner</surname> <given-names>T</given-names></name><name><surname>Vijayanand</surname> <given-names>P</given-names></name><name><surname>Ottensmeier</surname> <given-names>CH</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Tissue-resident memory features are linked to the magnitude of cytotoxic T cell responses in human lung cancer</article-title><source>Nature Immunology</source><volume>18</volume><fpage>940</fpage><lpage>950</lpage><pub-id pub-id-type="doi">10.1038/ni.3775</pub-id><pub-id pub-id-type="pmid">28628092</pub-id></element-citation></ref><ref id="bib19"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Gaujoux</surname> <given-names>R</given-names></name><name><surname>Seoighe</surname> <given-names>C</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>CellMix: a comprehensive toolbox for gene expression deconvolution</article-title><source>Bioinformatics</source><volume>29</volume><fpage>2211</fpage><lpage>2212</lpage><pub-id pub-id-type="doi">10.1093/bioinformatics/btt351</pub-id><pub-id pub-id-type="pmid">23825367</pub-id></element-citation></ref><ref id="bib20"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Gentles</surname> <given-names>AJ</given-names></name><name><surname>Newman</surname> <given-names>AM</given-names></name><name><surname>Liu</surname> <given-names>CL</given-names></name><name><surname>Bratman</surname> <given-names>SV</given-names></name><name><surname>Feng</surname> <given-names>W</given-names></name><name><surname>Kim</surname> <given-names>D</given-names></name><name><surname>Nair</surname> <given-names>VS</given-names></name><name><surname>Xu</surname> <given-names>Y</given-names></name><name><surname>Khuong</surname> <given-names>A</given-names></name><name><surname>Hoang</surname> <given-names>CD</given-names></name><name><surname>Diehn</surname> <given-names>M</given-names></name><name><surname>West</surname> <given-names>RB</given-names></name><name><surname>Plevritis</surname> <given-names>SK</given-names></name><name><surname>Alizadeh</surname> <given-names>AA</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>The prognostic landscape of genes and infiltrating immune cells across human cancers</article-title><source>Nature Medicine</source><volume>21</volume><fpage>938</fpage><lpage>945</lpage><pub-id pub-id-type="doi">10.1038/nm.3909</pub-id><pub-id pub-id-type="pmid">26193342</pub-id></element-citation></ref><ref id="bib21"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Gong</surname> <given-names>T</given-names></name><name><surname>Szustakowski</surname> <given-names>JD</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>DeconRNASeq: a statistical framework for deconvolution of heterogeneous tissue samples based on mRNA-Seq data</article-title><source>Bioinformatics</source><volume>29</volume><fpage>1083</fpage><lpage>1085</lpage><pub-id pub-id-type="doi">10.1093/bioinformatics/btt090</pub-id><pub-id pub-id-type="pmid">23428642</pub-id></element-citation></ref><ref id="bib22"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Gosink</surname> <given-names>MM</given-names></name><name><surname>Petrie</surname> <given-names>HT</given-names></name><name><surname>Tsinoremas</surname> <given-names>NF</given-names></name></person-group><year iso-8601-date="2007">2007</year><article-title>Electronically subtracting expression patterns from a mixed cell population</article-title><source>Bioinformatics</source><volume>23</volume><fpage>3328</fpage><lpage>3334</lpage><pub-id pub-id-type="doi">10.1093/bioinformatics/btm508</pub-id><pub-id pub-id-type="pmid">17956877</pub-id></element-citation></ref><ref id="bib23"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hackl</surname> <given-names>H</given-names></name><name><surname>Charoentong</surname> <given-names>P</given-names></name><name><surname>Finotello</surname> <given-names>F</given-names></name><name><surname>Trajanoski</surname> <given-names>Z</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Computational genomics tools for dissecting tumour-immune cell interactions</article-title><source>Nature Reviews Genetics</source><volume>17</volume><fpage>441</fpage><lpage>458</lpage><pub-id pub-id-type="doi">10.1038/nrg.2016.67</pub-id><pub-id pub-id-type="pmid">27376489</pub-id></element-citation></ref><ref id="bib24"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hanahan</surname> <given-names>D</given-names></name><name><surname>Weinberg</surname> <given-names>RA</given-names></name></person-group><year iso-8601-date="2011">2011</year><article-title>Hallmarks of cancer: the next generation</article-title><source>Cell</source><volume>144</volume><fpage>646</fpage><lpage>674</lpage><pub-id pub-id-type="doi">10.1016/j.cell.2011.02.013</pub-id><pub-id pub-id-type="pmid">21376230</pub-id></element-citation></ref><ref id="bib25"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hoadley</surname> <given-names>KA</given-names></name><name><surname>Yau</surname> <given-names>C</given-names></name><name><surname>Wolf</surname> <given-names>DM</given-names></name><name><surname>Cherniack</surname> <given-names>AD</given-names></name><name><surname>Tamborero</surname> <given-names>D</given-names></name><name><surname>Ng</surname> <given-names>S</given-names></name><name><surname>Leiserson</surname> <given-names>MDM</given-names></name><name><surname>Niu</surname> <given-names>B</given-names></name><name><surname>McLellan</surname> <given-names>MD</given-names></name><name><surname>Uzunangelov</surname> <given-names>V</given-names></name><name><surname>Zhang</surname> <given-names>J</given-names></name><name><surname>Kandoth</surname> <given-names>C</given-names></name><name><surname>Akbani</surname> <given-names>R</given-names></name><name><surname>Shen</surname> <given-names>H</given-names></name><name><surname>Omberg</surname> <given-names>L</given-names></name><name><surname>Chu</surname> <given-names>A</given-names></name><name><surname>Margolin</surname> <given-names>AA</given-names></name><name><surname>Van't Veer</surname> <given-names>LJ</given-names></name><name><surname>Lopez-Bigas</surname> <given-names>N</given-names></name><name><surname>Laird</surname> <given-names>PW</given-names></name><name><surname>Raphael</surname> <given-names>BJ</given-names></name><name><surname>Ding</surname> <given-names>L</given-names></name><name><surname>Robertson</surname> <given-names>AG</given-names></name><name><surname>Byers</surname> <given-names>LA</given-names></name><name><surname>Mills</surname> <given-names>GB</given-names></name><name><surname>Weinstein</surname> <given-names>JN</given-names></name><name><surname>Van Waes</surname> <given-names>C</given-names></name><name><surname>Chen</surname> <given-names>Z</given-names></name><name><surname>Collisson</surname> <given-names>EA</given-names></name><name><surname>Benz</surname> <given-names>CC</given-names></name><name><surname>Perou</surname> <given-names>CM</given-names></name><name><surname>Stuart</surname> <given-names>JM</given-names></name><collab>Cancer Genome Atlas Research Network</collab></person-group><year iso-8601-date="2014">2014</year><article-title>Multiplatform analysis of 12 cancer types reveals molecular classification within and across tissues of origin</article-title><source>Cell</source><volume>158</volume><fpage>929</fpage><lpage>944</lpage><pub-id pub-id-type="doi">10.1016/j.cell.2014.06.049</pub-id><pub-id pub-id-type="pmid">25109877</pub-id></element-citation></ref><ref id="bib26"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hoek</surname> <given-names>KL</given-names></name><name><surname>Samir</surname> <given-names>P</given-names></name><name><surname>Howard</surname> <given-names>LM</given-names></name><name><surname>Niu</surname> <given-names>X</given-names></name><name><surname>Prasad</surname> <given-names>N</given-names></name><name><surname>Galassie</surname> <given-names>A</given-names></name><name><surname>Liu</surname> <given-names>Q</given-names></name><name><surname>Allos</surname> <given-names>TM</given-names></name><name><surname>Floyd</surname> <given-names>KA</given-names></name><name><surname>Guo</surname> <given-names>Y</given-names></name><name><surname>Shyr</surname> <given-names>Y</given-names></name><name><surname>Levy</surname> <given-names>SE</given-names></name><name><surname>Joyce</surname> <given-names>S</given-names></name><name><surname>Edwards</surname> <given-names>KM</given-names></name><name><surname>Link</surname> <given-names>AJ</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>A cell-based systems biology assessment of human blood to monitor immune responses after influenza vaccination</article-title><source>PLoS One</source><volume>10</volume><elocation-id>e0118528</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pone.0118528</pub-id><pub-id pub-id-type="pmid">25706537</pub-id></element-citation></ref><ref id="bib27"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Jaitin</surname> <given-names>DA</given-names></name><name><surname>Kenigsberg</surname> <given-names>E</given-names></name><name><surname>Keren-Shaul</surname> <given-names>H</given-names></name><name><surname>Elefant</surname> <given-names>N</given-names></name><name><surname>Paul</surname> <given-names>F</given-names></name><name><surname>Zaretsky</surname> <given-names>I</given-names></name><name><surname>Mildner</surname> <given-names>A</given-names></name><name><surname>Cohen</surname> <given-names>N</given-names></name><name><surname>Jung</surname> <given-names>S</given-names></name><name><surname>Tanay</surname> <given-names>A</given-names></name><name><surname>Amit</surname> <given-names>I</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Massively parallel single-cell RNA-seq for marker-free decomposition of tissues into cell types</article-title><source>Science</source><volume>343</volume><fpage>776</fpage><lpage>779</lpage><pub-id pub-id-type="doi">10.1126/science.1247651</pub-id><pub-id pub-id-type="pmid">24531970</pub-id></element-citation></ref><ref id="bib28"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Joyce</surname> <given-names>JA</given-names></name><name><surname>Fearon</surname> <given-names>DT</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>T cell exclusion, immune privilege, and the tumor microenvironment</article-title><source>Science</source><volume>348</volume><fpage>74</fpage><lpage>80</lpage><pub-id pub-id-type="doi">10.1126/science.aaa6204</pub-id><pub-id pub-id-type="pmid">25838376</pub-id></element-citation></ref><ref id="bib29"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Langmead</surname> <given-names>B</given-names></name><name><surname>Salzberg</surname> <given-names>SL</given-names></name></person-group><year iso-8601-date="2012">2012</year><article-title>Fast gapped-read alignment with Bowtie 2</article-title><source>Nature Methods</source><volume>9</volume><fpage>357</fpage><lpage>359</lpage><pub-id pub-id-type="doi">10.1038/nmeth.1923</pub-id><pub-id pub-id-type="pmid">22388286</pub-id></element-citation></ref><ref id="bib30"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Li</surname> <given-names>H</given-names></name><name><surname>Handsaker</surname> <given-names>B</given-names></name><name><surname>Wysoker</surname> <given-names>A</given-names></name><name><surname>Fennell</surname> <given-names>T</given-names></name><name><surname>Ruan</surname> <given-names>J</given-names></name><name><surname>Homer</surname> <given-names>N</given-names></name><name><surname>Marth</surname> <given-names>G</given-names></name><name><surname>Abecasis</surname> <given-names>G</given-names></name><name><surname>Durbin</surname> <given-names>R</given-names></name><collab>1000 Genome Project Data Processing Subgroup</collab></person-group><year iso-8601-date="2009">2009</year><article-title>The Sequence Alignment/Map format and SAMtools</article-title><source>Bioinformatics</source><volume>25</volume><fpage>2078</fpage><lpage>2079</lpage><pub-id pub-id-type="doi">10.1093/bioinformatics/btp352</pub-id><pub-id pub-id-type="pmid">19505943</pub-id></element-citation></ref><ref id="bib31"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Li</surname> <given-names>B</given-names></name><name><surname>Dewey</surname> <given-names>CN</given-names></name></person-group><year iso-8601-date="2011">2011</year><article-title>RSEM: accurate transcript quantification from RNA-Seq data with or without a reference genome</article-title><source>BMC Bioinformatics</source><volume>12</volume><elocation-id>323</elocation-id><pub-id pub-id-type="doi">10.1186/1471-2105-12-323</pub-id><pub-id pub-id-type="pmid">21816040</pub-id></element-citation></ref><ref id="bib32"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Li</surname> <given-names>B</given-names></name><name><surname>Li</surname> <given-names>JZ</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>A general framework for analyzing tumor subclonality using SNP array and DNA sequencing data</article-title><source>Genome Biology</source><volume>15</volume><elocation-id>473</elocation-id><pub-id pub-id-type="doi">10.1186/s13059-014-0473-4</pub-id><pub-id pub-id-type="pmid">25253082</pub-id></element-citation></ref><ref id="bib33"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Li</surname> <given-names>B</given-names></name><name><surname>Severson</surname> <given-names>E</given-names></name><name><surname>Pignon</surname> <given-names>JC</given-names></name><name><surname>Zhao</surname> <given-names>H</given-names></name><name><surname>Li</surname> <given-names>T</given-names></name><name><surname>Novak</surname> <given-names>J</given-names></name><name><surname>Jiang</surname> <given-names>P</given-names></name><name><surname>Shen</surname> <given-names>H</given-names></name><name><surname>Aster</surname> <given-names>JC</given-names></name><name><surname>Rodig</surname> <given-names>S</given-names></name><name><surname>Signoretti</surname> <given-names>S</given-names></name><name><surname>Liu</surname> <given-names>JS</given-names></name><name><surname>Liu</surname> <given-names>XS</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Comprehensive analyses of tumor immunity: implications for cancer immunotherapy</article-title><source>Genome Biology</source><volume>17</volume><elocation-id>174</elocation-id><pub-id pub-id-type="doi">10.1186/s13059-016-1028-7</pub-id><pub-id pub-id-type="pmid">27549193</pub-id></element-citation></ref><ref id="bib34"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Linsley</surname> <given-names>PS</given-names></name><name><surname>Speake</surname> <given-names>C</given-names></name><name><surname>Whalen</surname> <given-names>E</given-names></name><name><surname>Chaussabel</surname> <given-names>D</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Copy number loss of the interferon gene cluster in melanomas is linked to reduced T cell infiltrate and poor patient prognosis</article-title><source>PLoS One</source><volume>9</volume><elocation-id>e109760</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pone.0109760</pub-id><pub-id pub-id-type="pmid">25314013</pub-id></element-citation></ref><ref id="bib35"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Linsley</surname> <given-names>PS</given-names></name><name><surname>Chaussabel</surname> <given-names>D</given-names></name><name><surname>Speake</surname> <given-names>C</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>The relationship of immune cell signatures to patient survival varies within and between tumor types</article-title><source>PLoS One</source><volume>10</volume><elocation-id>e0138726</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pone.0138726</pub-id><pub-id pub-id-type="pmid">26398410</pub-id></element-citation></ref><ref id="bib36"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Love</surname> <given-names>MI</given-names></name><name><surname>Huber</surname> <given-names>W</given-names></name><name><surname>Anders</surname> <given-names>S</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Moderated estimation of fold change and dispersion for RNA-seq data with DESeq2</article-title><source>Genome Biology</source><volume>15</volume><elocation-id>550</elocation-id><pub-id pub-id-type="doi">10.1186/s13059-014-0550-8</pub-id><pub-id pub-id-type="pmid">25516281</pub-id></element-citation></ref><ref id="bib37"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Newman</surname> <given-names>AM</given-names></name><name><surname>Liu</surname> <given-names>CL</given-names></name><name><surname>Green</surname> <given-names>MR</given-names></name><name><surname>Gentles</surname> <given-names>AJ</given-names></name><name><surname>Feng</surname> <given-names>W</given-names></name><name><surname>Xu</surname> <given-names>Y</given-names></name><name><surname>Hoang</surname> <given-names>CD</given-names></name><name><surname>Diehn</surname> <given-names>M</given-names></name><name><surname>Alizadeh</surname> <given-names>AA</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Robust enumeration of cell subsets from tissue expression profiles</article-title><source>Nature Methods</source><volume>12</volume><fpage>453</fpage><lpage>457</lpage><pub-id pub-id-type="doi">10.1038/nmeth.3337</pub-id><pub-id pub-id-type="pmid">25822800</pub-id></element-citation></ref><ref id="bib38"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Pabst</surname> <given-names>C</given-names></name><name><surname>Bergeron</surname> <given-names>A</given-names></name><name><surname>Lavallée</surname> <given-names>VP</given-names></name><name><surname>Yeh</surname> <given-names>J</given-names></name><name><surname>Gendron</surname> <given-names>P</given-names></name><name><surname>Norddahl</surname> <given-names>GL</given-names></name><name><surname>Krosl</surname> <given-names>J</given-names></name><name><surname>Boivin</surname> <given-names>I</given-names></name><name><surname>Deneault</surname> <given-names>E</given-names></name><name><surname>Simard</surname> <given-names>J</given-names></name><name><surname>Imren</surname> <given-names>S</given-names></name><name><surname>Boucher</surname> <given-names>G</given-names></name><name><surname>Eppert</surname> <given-names>K</given-names></name><name><surname>Herold</surname> <given-names>T</given-names></name><name><surname>Bohlander</surname> <given-names>SK</given-names></name><name><surname>Humphries</surname> <given-names>K</given-names></name><name><surname>Lemieux</surname> <given-names>S</given-names></name><name><surname>Hébert</surname> <given-names>J</given-names></name><name><surname>Sauvageau</surname> <given-names>G</given-names></name><name><surname>Barabé</surname> <given-names>F</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>GPR56 identifies primary human acute myeloid leukemia cells with high repopulating potential in vivo</article-title><source>Blood</source><volume>127</volume><fpage>2018</fpage><lpage>2027</lpage><pub-id pub-id-type="doi">10.1182/blood-2015-11-683649</pub-id><pub-id pub-id-type="pmid">26834243</pub-id></element-citation></ref><ref id="bib39"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Padovan-Merhar</surname> <given-names>O</given-names></name><name><surname>Nair</surname> <given-names>GP</given-names></name><name><surname>Biaesch</surname> <given-names>AG</given-names></name><name><surname>Mayer</surname> <given-names>A</given-names></name><name><surname>Scarfone</surname> <given-names>S</given-names></name><name><surname>Foley</surname> <given-names>SW</given-names></name><name><surname>Wu</surname> <given-names>AR</given-names></name><name><surname>Churchman</surname> <given-names>LS</given-names></name><name><surname>Singh</surname> <given-names>A</given-names></name><name><surname>Raj</surname> <given-names>A</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Single mammalian cells compensate for differences in cellular volume and DNA copy number through independent global transcriptional mechanisms</article-title><source>Molecular Cell</source><volume>58</volume><fpage>339</fpage><lpage>352</lpage><pub-id pub-id-type="doi">10.1016/j.molcel.2015.03.005</pub-id><pub-id pub-id-type="pmid">25866248</pub-id></element-citation></ref><ref id="bib40"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Qiao</surname> <given-names>W</given-names></name><name><surname>Quon</surname> <given-names>G</given-names></name><name><surname>Csaszar</surname> <given-names>E</given-names></name><name><surname>Yu</surname> <given-names>M</given-names></name><name><surname>Morris</surname> <given-names>Q</given-names></name><name><surname>Zandstra</surname> <given-names>PW</given-names></name></person-group><year iso-8601-date="2012">2012</year><article-title>PERT: a method for expression deconvolution of human blood samples from varied microenvironmental and developmental conditions</article-title><source>PLoS Computational Biology</source><volume>8</volume><elocation-id>e1002838</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pcbi.1002838</pub-id><pub-id pub-id-type="pmid">23284283</pub-id></element-citation></ref><ref id="bib41"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Quon</surname> <given-names>G</given-names></name><name><surname>Haider</surname> <given-names>S</given-names></name><name><surname>Deshwar</surname> <given-names>AG</given-names></name><name><surname>Cui</surname> <given-names>A</given-names></name><name><surname>Boutros</surname> <given-names>PC</given-names></name><name><surname>Morris</surname> <given-names>Q</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>Computational purification of individual tumor gene expression profiles leads to significant improvements in prognostic prediction</article-title><source>Genome Medicine</source><volume>5</volume><elocation-id>29</elocation-id><pub-id pub-id-type="doi">10.1186/gm433</pub-id><pub-id pub-id-type="pmid">23537167</pub-id></element-citation></ref><ref id="bib42"><element-citation publication-type="software"><person-group person-group-type="author"><name><surname>Racle</surname> <given-names>J</given-names></name></person-group><year iso-8601-date="2017">2017</year><data-title><italic>EPIC</italic></data-title><source>GitHub</source><version designator="66dba00">66dba00</version><ext-link ext-link-type="uri" xlink:href="https://github.com/GfellerLab/EPIC">https://github.com/GfellerLab/EPIC</ext-link></element-citation></ref><ref id="bib43"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rooney</surname> <given-names>MS</given-names></name><name><surname>Shukla</surname> <given-names>SA</given-names></name><name><surname>Wu</surname> <given-names>CJ</given-names></name><name><surname>Getz</surname> <given-names>G</given-names></name><name><surname>Hacohen</surname> <given-names>N</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Molecular and genetic properties of tumors associated with local immune cytolytic activity</article-title><source>Cell</source><volume>160</volume><fpage>48</fpage><lpage>61</lpage><pub-id pub-id-type="doi">10.1016/j.cell.2014.12.033</pub-id><pub-id pub-id-type="pmid">25594174</pub-id></element-citation></ref><ref id="bib44"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Saliba</surname> <given-names>AE</given-names></name><name><surname>Westermann</surname> <given-names>AJ</given-names></name><name><surname>Gorski</surname> <given-names>SA</given-names></name><name><surname>Vogel</surname> <given-names>J</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Single-cell RNA-seq: advances and future challenges</article-title><source>Nucleic Acids Research</source><volume>42</volume><fpage>8845</fpage><lpage>8860</lpage><pub-id pub-id-type="doi">10.1093/nar/gku555</pub-id><pub-id pub-id-type="pmid">25053837</pub-id></element-citation></ref><ref id="bib45"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Sconocchia</surname> <given-names>G</given-names></name><name><surname>Arriga</surname> <given-names>R</given-names></name><name><surname>Tornillo</surname> <given-names>L</given-names></name><name><surname>Terracciano</surname> <given-names>L</given-names></name><name><surname>Ferrone</surname> <given-names>S</given-names></name><name><surname>Spagnoli</surname> <given-names>GC</given-names></name></person-group><year iso-8601-date="2012">2012</year><article-title>Melanoma cells inhibit NK cell functions</article-title><source>Cancer Research</source><volume>72</volume><fpage>5428</fpage><lpage>5429</lpage><pub-id pub-id-type="doi">10.1158/0008-5472.CAN-12-1181</pub-id><pub-id pub-id-type="pmid">23047870</pub-id></element-citation></ref><ref id="bib46"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Shen-Orr</surname> <given-names>SS</given-names></name><name><surname>Gaujoux</surname> <given-names>R</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>Computational deconvolution: extracting cell type-specific information from heterogeneous samples</article-title><source>Current Opinion in Immunology</source><volume>25</volume><fpage>571</fpage><lpage>578</lpage><pub-id pub-id-type="doi">10.1016/j.coi.2013.09.015</pub-id><pub-id pub-id-type="pmid">24148234</pub-id></element-citation></ref><ref id="bib47"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Singer</surname> <given-names>M</given-names></name><name><surname>Wang</surname> <given-names>C</given-names></name><name><surname>Cong</surname> <given-names>L</given-names></name><name><surname>Marjanovic</surname> <given-names>ND</given-names></name><name><surname>Kowalczyk</surname> <given-names>MS</given-names></name><name><surname>Zhang</surname> <given-names>H</given-names></name><name><surname>Nyman</surname> <given-names>J</given-names></name><name><surname>Sakuishi</surname> <given-names>K</given-names></name><name><surname>Kurtulus</surname> <given-names>S</given-names></name><name><surname>Gennert</surname> <given-names>D</given-names></name><name><surname>Xia</surname> <given-names>J</given-names></name><name><surname>Kwon</surname> <given-names>JYH</given-names></name><name><surname>Nevin</surname> <given-names>J</given-names></name><name><surname>Herbst</surname> <given-names>RH</given-names></name><name><surname>Yanai</surname> <given-names>I</given-names></name><name><surname>Rozenblatt-Rosen</surname> <given-names>O</given-names></name><name><surname>Kuchroo</surname> <given-names>VK</given-names></name><name><surname>Regev</surname> <given-names>A</given-names></name><name><surname>Anderson</surname> <given-names>AC</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>A distinct gene module for dysfunction uncoupled from activation in tumor-infiltrating T cells</article-title><source>Cell</source><volume>166</volume><fpage>1500</fpage><lpage>1511</lpage><pub-id pub-id-type="doi">10.1016/j.cell.2016.08.052</pub-id><pub-id pub-id-type="pmid">27610572</pub-id></element-citation></ref><ref id="bib48"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Speiser</surname> <given-names>DE</given-names></name><name><surname>Ho</surname> <given-names>PC</given-names></name><name><surname>Verdeil</surname> <given-names>G</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Regulatory circuits of T cell function in cancer</article-title><source>Nature Reviews Immunology</source><volume>16</volume><fpage>599</fpage><lpage>611</lpage><pub-id pub-id-type="doi">10.1038/nri.2016.80</pub-id><pub-id pub-id-type="pmid">27526640</pub-id></element-citation></ref><ref id="bib49"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Stegle</surname> <given-names>O</given-names></name><name><surname>Teichmann</surname> <given-names>SA</given-names></name><name><surname>Marioni</surname> <given-names>JC</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Computational and analytical challenges in single-cell transcriptomics</article-title><source>Nature Reviews Genetics</source><volume>16</volume><fpage>133</fpage><lpage>145</lpage><pub-id pub-id-type="doi">10.1038/nrg3833</pub-id><pub-id pub-id-type="pmid">25628217</pub-id></element-citation></ref><ref id="bib50"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Subrahmanyam</surname> <given-names>YV</given-names></name><name><surname>Yamaga</surname> <given-names>S</given-names></name><name><surname>Prashar</surname> <given-names>Y</given-names></name><name><surname>Lee</surname> <given-names>HH</given-names></name><name><surname>Hoe</surname> <given-names>NP</given-names></name><name><surname>Kluger</surname> <given-names>Y</given-names></name><name><surname>Gerstein</surname> <given-names>M</given-names></name><name><surname>Goguen</surname> <given-names>JD</given-names></name><name><surname>Newburger</surname> <given-names>PE</given-names></name><name><surname>Weissman</surname> <given-names>SM</given-names></name></person-group><year iso-8601-date="2001">2001</year><article-title>RNA expression patterns change dramatically in human neutrophils exposed to bacteria</article-title><source>Blood</source><volume>97</volume><fpage>2457</fpage><lpage>2468</lpage><pub-id pub-id-type="doi">10.1182/blood.V97.8.2457</pub-id><pub-id pub-id-type="pmid">11290611</pub-id></element-citation></ref><ref id="bib51"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Tirosh</surname> <given-names>I</given-names></name><name><surname>Izar</surname> <given-names>B</given-names></name><name><surname>Prakadan</surname> <given-names>SM</given-names></name><name><surname>Wadsworth</surname> <given-names>MH</given-names></name><name><surname>Treacy</surname> <given-names>D</given-names></name><name><surname>Trombetta</surname> <given-names>JJ</given-names></name><name><surname>Rotem</surname> <given-names>A</given-names></name><name><surname>Rodman</surname> <given-names>C</given-names></name><name><surname>Lian</surname> <given-names>C</given-names></name><name><surname>Murphy</surname> <given-names>G</given-names></name><name><surname>Fallahi-Sichani</surname> <given-names>M</given-names></name><name><surname>Dutton-Regester</surname> <given-names>K</given-names></name><name><surname>Lin</surname> <given-names>JR</given-names></name><name><surname>Cohen</surname> <given-names>O</given-names></name><name><surname>Shah</surname> <given-names>P</given-names></name><name><surname>Lu</surname> <given-names>D</given-names></name><name><surname>Genshaft</surname> <given-names>AS</given-names></name><name><surname>Hughes</surname> <given-names>TK</given-names></name><name><surname>Ziegler</surname> <given-names>CG</given-names></name><name><surname>Kazer</surname> <given-names>SW</given-names></name><name><surname>Gaillard</surname> <given-names>A</given-names></name><name><surname>Kolb</surname> <given-names>KE</given-names></name><name><surname>Villani</surname> <given-names>AC</given-names></name><name><surname>Johannessen</surname> <given-names>CM</given-names></name><name><surname>Andreev</surname> <given-names>AY</given-names></name><name><surname>Van Allen</surname> <given-names>EM</given-names></name><name><surname>Bertagnolli</surname> <given-names>M</given-names></name><name><surname>Sorger</surname> <given-names>PK</given-names></name><name><surname>Sullivan</surname> <given-names>RJ</given-names></name><name><surname>Flaherty</surname> <given-names>KT</given-names></name><name><surname>Frederick</surname> <given-names>DT</given-names></name><name><surname>Jané-Valbuena</surname> <given-names>J</given-names></name><name><surname>Yoon</surname> <given-names>CH</given-names></name><name><surname>Rozenblatt-Rosen</surname> <given-names>O</given-names></name><name><surname>Shalek</surname> <given-names>AK</given-names></name><name><surname>Regev</surname> <given-names>A</given-names></name><name><surname>Garraway</surname> <given-names>LA</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Dissecting the multicellular ecosystem of metastatic melanoma by single-cell RNA-seq</article-title><source>Science</source><volume>352</volume><fpage>189</fpage><lpage>196</lpage><pub-id pub-id-type="doi">10.1126/science.aad0501</pub-id><pub-id pub-id-type="pmid">27124452</pub-id></element-citation></ref><ref id="bib52"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Tzur</surname> <given-names>A</given-names></name><name><surname>Moore</surname> <given-names>JK</given-names></name><name><surname>Jorgensen</surname> <given-names>P</given-names></name><name><surname>Shapiro</surname> <given-names>HM</given-names></name><name><surname>Kirschner</surname> <given-names>MW</given-names></name></person-group><year iso-8601-date="2011">2011</year><article-title>Optimizing optical flow cytometry for cell volume-based sorting and analysis</article-title><source>PLoS One</source><volume>6</volume><elocation-id>e16053</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pone.0016053</pub-id><pub-id pub-id-type="pmid">21283800</pub-id></element-citation></ref><ref id="bib53"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Venet</surname> <given-names>D</given-names></name><name><surname>Pecasse</surname> <given-names>F</given-names></name><name><surname>Maenhaut</surname> <given-names>C</given-names></name><name><surname>Bersini</surname> <given-names>H</given-names></name></person-group><year iso-8601-date="2001">2001</year><article-title>Separation of samples into their constituents using gene expression data</article-title><source>Bioinformatics</source><volume>17 Suppl 1</volume><fpage>S279</fpage><lpage>S287</lpage><pub-id pub-id-type="doi">10.1093/bioinformatics/17.suppl_1.S279</pub-id><pub-id pub-id-type="pmid">11473019</pub-id></element-citation></ref><ref id="bib54"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Yoshihara</surname> <given-names>K</given-names></name><name><surname>Shahmoradgoli</surname> <given-names>M</given-names></name><name><surname>Martínez</surname> <given-names>E</given-names></name><name><surname>Vegesna</surname> <given-names>R</given-names></name><name><surname>Kim</surname> <given-names>H</given-names></name><name><surname>Torres-Garcia</surname> <given-names>W</given-names></name><name><surname>Treviño</surname> <given-names>V</given-names></name><name><surname>Shen</surname> <given-names>H</given-names></name><name><surname>Laird</surname> <given-names>PW</given-names></name><name><surname>Levine</surname> <given-names>DA</given-names></name><name><surname>Carter</surname> <given-names>SL</given-names></name><name><surname>Getz</surname> <given-names>G</given-names></name><name><surname>Stemke-Hale</surname> <given-names>K</given-names></name><name><surname>Mills</surname> <given-names>GB</given-names></name><name><surname>Verhaak</surname> <given-names>RG</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>Inferring tumour purity and stromal and immune cell admixture from expression data</article-title><source>Nature Communications</source><volume>4</volume><elocation-id>2612</elocation-id><pub-id pub-id-type="doi">10.1038/ncomms3612</pub-id><pub-id pub-id-type="pmid">24113773</pub-id></element-citation></ref><ref id="bib55"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zheng</surname> <given-names>X</given-names></name><name><surname>Zhang</surname> <given-names>N</given-names></name><name><surname>Wu</surname> <given-names>HJ</given-names></name><name><surname>Wu</surname> <given-names>H</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Estimating and accounting for tumor purity in the analysis of DNA methylation data from cancer studies</article-title><source>Genome Biology</source><volume>18</volume><elocation-id>17</elocation-id><pub-id pub-id-type="doi">10.1186/s13059-016-1143-5</pub-id><pub-id pub-id-type="pmid">28122605</pub-id></element-citation></ref><ref id="bib56"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zhong</surname> <given-names>Y</given-names></name><name><surname>Wan</surname> <given-names>YW</given-names></name><name><surname>Pang</surname> <given-names>K</given-names></name><name><surname>Chow</surname> <given-names>LM</given-names></name><name><surname>Liu</surname> <given-names>Z</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>Digital sorting of complex tissues for cell type-specific gene expression profiles</article-title><source>BMC Bioinformatics</source><volume>14</volume><fpage>89</fpage><pub-id pub-id-type="doi">10.1186/1471-2105-14-89</pub-id><pub-id pub-id-type="pmid">23497278</pub-id></element-citation></ref><ref id="bib57"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zimmermann</surname> <given-names>MT</given-names></name><name><surname>Oberg</surname> <given-names>AL</given-names></name><name><surname>Grill</surname> <given-names>DE</given-names></name><name><surname>Ovsyannikova</surname> <given-names>IG</given-names></name><name><surname>Haralambieva</surname> <given-names>IH</given-names></name><name><surname>Kennedy</surname> <given-names>RB</given-names></name><name><surname>Poland</surname> <given-names>GA</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>System-wide associations between DNA-methylation, gene expression, and humoral immune response to influenza vaccination</article-title><source>PLoS One</source><volume>11</volume><elocation-id>e0152034</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pone.0152034</pub-id><pub-id pub-id-type="pmid">27031986</pub-id></element-citation></ref><ref id="bib58"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Şenbabaoğlu</surname> <given-names>Y</given-names></name><name><surname>Gejman</surname> <given-names>RS</given-names></name><name><surname>Winer</surname> <given-names>AG</given-names></name><name><surname>Liu</surname> <given-names>M</given-names></name><name><surname>Van Allen</surname> <given-names>EM</given-names></name><name><surname>de Velasco</surname> <given-names>G</given-names></name><name><surname>Miao</surname> <given-names>D</given-names></name><name><surname>Ostrovnaya</surname> <given-names>I</given-names></name><name><surname>Drill</surname> <given-names>E</given-names></name><name><surname>Luna</surname> <given-names>A</given-names></name><name><surname>Weinhold</surname> <given-names>N</given-names></name><name><surname>Lee</surname> <given-names>W</given-names></name><name><surname>Manley</surname> <given-names>BJ</given-names></name><name><surname>Khalil</surname> <given-names>DN</given-names></name><name><surname>Kaffenberger</surname> <given-names>SD</given-names></name><name><surname>Chen</surname> <given-names>Y</given-names></name><name><surname>Danilova</surname> <given-names>L</given-names></name><name><surname>Voss</surname> <given-names>MH</given-names></name><name><surname>Coleman</surname> <given-names>JA</given-names></name><name><surname>Russo</surname> <given-names>P</given-names></name><name><surname>Reuter</surname> <given-names>VE</given-names></name><name><surname>Chan</surname> <given-names>TA</given-names></name><name><surname>Cheng</surname> <given-names>EH</given-names></name><name><surname>Scheinberg</surname> <given-names>DA</given-names></name><name><surname>Li</surname> <given-names>MO</given-names></name><name><surname>Choueiri</surname> <given-names>TK</given-names></name><name><surname>Hsieh</surname> <given-names>JJ</given-names></name><name><surname>Sander</surname> <given-names>C</given-names></name><name><surname>Hakimi</surname> <given-names>AA</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Tumor immune microenvironment characterization in clear cell renal cell carcinoma identifies prognostic and immunotherapeutically relevant messenger RNA signatures</article-title><source>Genome Biology</source><volume>17</volume><elocation-id>231</elocation-id><pub-id pub-id-type="doi">10.1186/s13059-016-1092-z</pub-id><pub-id pub-id-type="pmid">27855702</pub-id></element-citation></ref></ref-list><app-group><app id="appendix-1"><title>Appendix 1</title><boxed-text><object-id pub-id-type="doi">10.7554/eLife.26476.026</object-id><table-wrap id="app1table1" position="float"><object-id pub-id-type="doi">10.7554/eLife.26476.027</object-id><label>Appendix 1—table 1.</label><caption><title>Gene markers used per cell type.</title><p>Only markers of cell types present in the respective reference gene expression profiles are used.</p></caption><table frame="hsides" rules="groups"><thead><tr><th>Cell type</th><th>Genes markers</th></tr></thead><tbody><tr><td>B cells</td><td>BANK1, CD79A, CD79B, FCER2, FCRL2, FCRL5, MS4A1, PAX5, POU2AF1, STAP1, TCL1A</td></tr><tr><td>CAFs</td><td>ADAM33, CLDN11, COL1A1, COL3A1, COL14A1, CRISPLD2, CXCL14, DPT, F3, FBLN1, ISLR, LUM, MEG3, MFAP5, PRELP, PTGIS, SFRP2, SFRP4, SYNPO2, TMEM119</td></tr><tr><td>CD4 T cells</td><td>ANKRD55, DGKA, FOXP3, GCNT4, IL2RA, MDS2, RCAN3, TBC1D4, TRAT1</td></tr><tr><td>CD8 T cells</td><td>CD8B, HAUS3, JAKMIP1, NAA16, TSPYL1</td></tr><tr><td>Endothelial cells</td><td>CDH5, CLDN5, CLEC14A, CXorf36, ECSCR, F2RL3, FLT1, FLT4, GPR4, GPR182, KDR, MMRN1, MMRN2, MYCT1, PTPRB, RHOJ, SLCO2A1, SOX18, STAB2, VWF</td></tr><tr><td>Macrophages</td><td>APOC1, C1QC, CD14, CD163, CD300C, CD300E, CSF1R, F13A1, FPR3, HAMP, IL1B, LILRB4, MS4A6A, MSR1, SIGLEC1, VSIG4</td></tr><tr><td>Monocytes</td><td>CD33, CD300C, CD300E, CECR1, CLEC6A, CPVL, EGR2, EREG, MS4A6A, NAGA, SLC37A2</td></tr><tr><td>Neutrophils</td><td>CEACAM3, CNTNAP3, CXCR1, CYP4F3, FFAR2, HIST1H2BC, HIST1H3D, KY, MMP25, PGLYRP1, SLC12A1, TAS2R40</td></tr><tr><td>NK cells</td><td>CD160, CLIC3, FGFBP2, GNLY, GNPTAB, KLRF1, NCR1, NMUR1, S1PR5, SH2D1B</td></tr><tr><td>T cells</td><td>BCL11B, CD5, CD28, IL7R, ITK, THEMIS, UBASH3A</td></tr></tbody></table></table-wrap></boxed-text></app><app id="appendix-2"><title>Appendix 2</title><boxed-text><object-id pub-id-type="doi">10.7554/eLife.26476.028</object-id><table-wrap id="app2table1" position="float"><object-id pub-id-type="doi">10.7554/eLife.26476.029</object-id><label>Appendix 2—table 1.</label><caption><title>Characteristics of the patients with metastatic melanoma and corresponding lymph node samples.</title></caption><table frame="hsides" rules="groups"><thead><tr><th>Patient</th><th>Age (years)</th><th>Gender</th><th>Tissue</th></tr></thead><tbody><tr><td valign="top">LAU125</td><td valign="top">59</td><td valign="top">male</td><td valign="top">iliac lymph node</td></tr><tr><td valign="top">LAU355</td><td valign="top">70</td><td valign="top">female</td><td valign="top">iliac-obturator lymph node</td></tr><tr><td valign="top">LAU1255</td><td valign="top">87</td><td valign="top">male</td><td valign="top">axillary lymph node</td></tr><tr><td valign="top">LAU1314</td><td valign="top">81</td><td valign="top">male</td><td valign="top">iliac-obturator lymph node</td></tr></tbody></table></table-wrap></boxed-text></app></app-group></back><sub-article article-type="decision-letter" id="SA1"><front-stub><article-id pub-id-type="doi">10.7554/eLife.26476.048</article-id><title-group><article-title>Decision letter</article-title></title-group><contrib-group><contrib contrib-type="editor"><name><surname>Valencia</surname><given-names>Alfonso</given-names></name><role>Reviewing Editor</role><aff><institution>Barcelona Supercomputing Center - BSC</institution><country>Spain</country></aff></contrib></contrib-group></front-stub><body><boxed-text><p>In the interests of transparency, eLife includes the editorial decision letter and accompanying author responses. A lightly edited version of the letter sent to the authors after peer review is shown, indicating the most substantive concerns; minor comments are not usually included.</p></boxed-text><p>Thank you for submitting your article &quot;Simultaneous enumeration of cancer and immune cell types from bulk tumor gene expression data&quot; for consideration by <italic>eLife</italic>. Your article has been favorably evaluated by Naama Barkai (Senior Editor) and three reviewers, one of whom is a member of our Board of Reviewing Editors. The reviewers have opted to remain anonymous.</p><p>The reviewers have discussed the reviews with one another and the Reviewing Editor has drafted these comments to understand if it will be possible for you to provide what the reviewers consider essential to the publication of this work. At this point we ask you to provide a detailed response with an action plan and timetable for the completion of the essential tasks noted below. We will have the Board and reviewer consider your responses and issue a binding recommendation as soon as possible.</p><p>Summary:</p><p>This manuscript describes the EPIC method to estimate the proportion of cancerous cells and immune cells of various types within a bulk gene expression profile of a tumor sample or PBMC. The work fits within the recent renewed interest in the area of expression deconvolution in tumor-infiltrating lymphocytes.</p><p>The method is based on the extrapolation of the proportion of RNA in standard cell types to determine the proportion of cell types in mixtures. The main features of the method are: it takes into account the estimated proportion of RNA in the samples, weights highly the contribution of less variable genes in the reference set, it does not make assumptions about the heterogeneity of the non-normal cells in the samples, and, it uses the expression of maker genes that are not expressed in cancer cells to normalize the proportion of tumor/non tumor cells in the samples. The data presented correspond mainly to metastatic melanoma samples with some additional colon cancer cases.</p><p>Essential revisions:</p><p>1) The works requires a clear demonstration of the capacity of the method to do well estimating cell subsets at higher resolution, as this seems to be the main advantage of the method.</p><p>2) A better analysis and clarification of what are the key steps of the procedure that improve the results.</p><p>3) Clarify the dependency of the results of outliers and in general revise the significance criteria.</p><p>4) Make the system accessible via a web interface.</p><p>Other concerns:</p><p>1) – The authors should consider to extend the reference gene expression profiles to additional cell types such as stromal and endothelial cells which are known to have a role in tumor microenvironment as well as deepen the separation between cytotoxic T cells (CD8 cells) and CD4 T cells gene expression profiles, which currently is low and at a level less than what has been shown to be important correlates for immune-tumor interactions/therapeutic response.</p><p>2) Consider rephrasing, the estimation of the tumor in 3D – it is not too surprising given that the melanoma forms the bulk of the tumor in most of these samples and is quite distinct – this is akin to getting neutrophil estimates correct in whole blood.</p><p>3) With respect to the second validation (comparing EPIC to IHC data), the authors claimed they observed &quot;a good agreement between cell proportions measured by IHC and our predictions&quot;, however there is a weak non-significant correlation (r=0.3, p=0.09) between these factors in macrophages that should be mentioned in the text. This may be due to the maker used in IHC being expressed in other cell subsets or due to protein/mRNA differences – the former being relatively easy to distinguish.</p><p>4) The first test and comparison with other methods is carried out with normal blood samples and (<xref ref-type="fig" rid="fig2">Figure 2B</xref>). The EPIC method performs better (pearson R) than other methods. Notice that in whole blood (dataset 3 (Linsley et al., 2014)) the differences with CIBERSORT and DSA are minimal. It will be important to clarify if the additional information is provided by the inclusion of the estimated mRNA content in the calculations (<xref ref-type="fig" rid="fig2">Figure 2A</xref> versus 2C).</p><p>5) Reconsider the following claim &quot;We observed a remarkable agreement between our predictions and experimentally determined cell fractions (<xref ref-type="fig" rid="fig3">Figure 3A</xref>). Of note, the proportion of melanoma cells could be very accurately predicted even in the absence of a priori information about their gene expression.&quot; in light of the small size of the data sets (4 donors of which two of them dominate the correlation).</p><p>6) Comment of the significance of the results in <xref ref-type="fig" rid="fig3">Figure 3B</xref> and <xref ref-type="fig" rid="fig3">Figure 3C</xref> where the differences are based on single outliers.</p><p>7) It will be good to check if in the information in <xref ref-type="fig" rid="fig5">Figure 5A</xref> (and supplementary figures) can be better interpreted comparing the method only in normal tissue samples (equivalent to <xref ref-type="fig" rid="fig5">Figure 5</xref> supplementary figures).</p><p>8) Assess the significance of the results in <xref ref-type="fig" rid="fig5">Figure 5B</xref>.</p><p>9) Benchmarking other methods, such as Cibersort by summing high-resolution cell subsets may be incorrect – a better approach would be to replace LM22 with the matrix derived by the authors – if not, I would suggest saying that this comparison is less than ideal.</p><p>10) It is not clear from the manuscript whether or not the advance over CIBERSORT is due to a better marker gene set and reference panel or due to the other methodological innovations that they made. This point should be clarified.</p><p>11) The reference to the use of &quot;zeros&quot; in the gene expression profile of cancerous tissue as informative to be leveraged in deconvolution in Gosink 2007 and Clarke 2010 should be included.</p><p>12) Respect to ISOpure, it is not clear from the description whether ISOpure was run just with signature genes or with the whole gene expression profile.</p><p>13) The ideas implicit in DeMix where the ratio of the variances provides an implicit importance weight (Ahn 2013) should be discussed.</p><p>Other points:</p><p>1) The authors should change the scale and marking of the statistical significance from (*p&lt;0.1; **p&lt;0.05; ***p&lt;0.01) to (*p&lt;0.05; **p&lt;0.01; ***p&lt;0.001) as p&gt;0.05 is not considered significant.</p><p>2) The authors claimed that &quot;Immune cells differ in their gene expression profiles depending on their state and site of origin (e.g., blood or tumors)&quot; – a reference should be added.</p><p>3) There is a lack in specifying &quot;Supplementary file 4&quot; in the relevant places.</p><p>4) Figures and supplementary figures are not numbered in the manuscript, what makes difficult to know what the supplementary figures correspond to what text.</p><p>5) The use of a different scale for each method does not help to the interpretation of the figures.</p><p>6) Subsection “Validation in blood”: Renormalization by mRNA content is used in (Qiao 2012) to improve the estimates of cell-type proportions.</p><p>7) &quot;Prediction of cancer and immune cell type proportions&quot;: I found this explanation somewhat confusing because Equation 1 is never actually used in the deconvolution – only Equations 6 and 7. Because Equation 1 is introduced, I expected EPIC to try to solve it at some point.</p><p>Regarding references:</p><p>1) The authors claim that this is the first deconvolution methodology to take into account total RNA differences between cell subsets is incorrect, to the best of this reviewers knowledge, Baron et al. (Cell Systems 2016) propose a method, Bseq-SC which uses total RNA to improve deconvolution estimates. Of relevance here, their estimates for total RNA levels come from the single cell expression data, information which could be incorporated into EPIC too to increase its resolution.</p><p>Other pertinent references include:</p><p>Clarke J, Seo P, Clarke B: Statistical expression deconvolution from mixed tissue samples. Bioinformatics. 2010, 26: 1043-1049</p><p>Gosink MM, Petrie HT, Tsinoremas NF: Electronically subtracting expression patterns from a mixed cell population. Bioinformatics. 2007, 23: 3328-3334.</p><p>Ahn J, Yuan Y, Parmigiani G, Suraokar MB, Diao L, Wistuba II, Wang W. DeMix: deconvolution for mixed cancer transcriptomes using raw measured data. Bioinformatics. 2013 Aug 1;29(15):1865-71.</p><p>Qiao W, Quon G, Csaszar E, Yu M, Morris Q, Zandstra PW. PERT: a method for expression deconvolution of human blood samples from varied microenvironmental and developmental conditions. PLoS Comput Biol. 2012</p><p>[Editors' note: further revisions were requested prior to acceptance, as described below.]</p><p>Thank you for resubmitting your work entitled &quot;Simultaneous enumeration of cancer and immune cell types from bulk tumor gene expression data&quot; for further consideration at <italic>eLife</italic>. Your revised article has been favorably evaluated by Naama Barkai (Senior Editor) and three reviewers, one of whom is a member of our Board of Reviewing Editors.</p><p>The manuscript has been improved but there are some remaining issues that need to be addressed before acceptance, as outlined below:</p><p>Essential revisions:</p><p>The claim that &quot;ISOpure is specifically designed to run genome-wide&quot; does not appear anywhere in the ISOpure manuscript, is not consistent with the uses of ISOpure, and there is nothing obvious in the ISOpure algorithm that makes it specifically designed to be applied genome-wide (such a claim is made for PERT, and one could argue that PERT contains a gene-specific weighting mechanism, like EPIC, which makes it suitable for genome-wide use, but no such claim is made for ISOpure).</p><p>Indeed, an ISOpure-like method applied genome-wide in the PERT manuscript does quite badly at recovering the mixture proportions of the various cell types. Therefore, the new version in the revised version regarding ISOpure needs to be revised and inaccurate statements removed.</p><p>In conclusion, in the new version EPIC should be compared with ISOpure using the same inputs as CIBERSORT and EPIC.</p></body></sub-article><sub-article article-type="reply" id="SA2"><front-stub><article-id pub-id-type="doi">10.7554/eLife.26476.049</article-id><title-group><article-title>Author response</article-title></title-group></front-stub><body><disp-quote content-type="editor-comment"><p>Essential revisions:</p><p>1) The works requires a clear demonstration of the capacity of the method to do well estimating cell subsets at higher resolution, as this seems to be the main advantage of the method.</p></disp-quote><p>We agree that it is important to estimate cell subsets at a higher resolution. For this reason, we have now constructed gene expression reference profiles for CD4 T cells and CD8 T cells from the peripheral blood datasets. In addition, we also took advantage of the single-cell RNA-seq data from Tirosh et al., 2016, in order to define these CD4 and CD8 T cells for tumor infiltrating cells. Finally, we have built reference gene expression profiles from stromal cells (cancer associated fibroblasts) and endothelial cells, also from the single-cell RNA-Seq data. As before, we defined signature genes for these new cell types.</p><p>Going back to the FACS data from the study of Zimmermann et al., 2016, we could estimate the proportion of CD4 T cells and CD8 T cells that were present in these blood samples, and used this data as a first validation of EPIC in blood data, including these new cell subsets, as shown in <xref ref-type="fig" rid="respfig1">Author response image 1</xref>.</p><fig id="respfig1"><object-id pub-id-type="doi">10.7554/eLife.26476.031</object-id><label>Author response image 1.</label><caption><title>Comparison between EPIC predictions and measured cell fractions in PBMC dataset from Zimmermann et al. 2016.</title></caption><graphic mime-subtype="jpeg" mimetype="image" xlink:href="elife-26476-resp-fig1-v2"/></fig><p>Concerning the validation in tumor samples:</p><p>1) We expanded our flow cytometry analysis of the four melanoma samples, including CD4 T cells and CD8 T cells to test the predictions there.</p><p>2) We could also validate EPIC predictions for the CD8 T cells in the immunohistochemistry data from Becht et al., 2016.</p><p>3) Predictions from all cell types, including stromal and endothelial cells, could also be validated based on the data from Tirosh et al., 2016.</p><p>We performed a detailed comparison of the predictions from EPIC and the other methods, including these additional cell types. Some of the results are given in <xref ref-type="fig" rid="respfig2">Author response image 2</xref>, showing the correlation between the predictions from EPIC and the experimentally observed proportions for the various cell types in different datasets.</p><fig id="respfig2"><object-id pub-id-type="doi">10.7554/eLife.26476.032</object-id><label>Author response image 2.</label><caption><title>Comparison between the experimentally measured cell fractions and EPIC predictions, including additional cell types in: (<bold>A</bold>) our expanded flow cytometry analysis of melanoma; (<bold>B</bold>) lymph node metastasis and primary tumor melanoma data from Tirosh et al., 2016.</title></caption><graphic mime-subtype="jpeg" mimetype="image" xlink:href="elife-26476-resp-fig2-v2"/></fig><p>Pushing the limits of the cell type fraction predictions to even lower subsets, we also defined Thelper and Treg cell subsets, based on the data from Tirosh et al., 2016. We note that in such cases, the accuracy of the predictions starts to suffer because of the substantial similarity of these cell types at the transcriptional level. The results based on EPIC are nevertheless still as good or even better than those obtained from CIBERSORT (<xref ref-type="fig" rid="fig5s6">Figure 5—figure supplement 6</xref>). Our results suggest that quantitative predictions for such less abundant and more redundant cell types are still challenging and may reach the limits of the signal to noise ratio in gene expression data.</p><p>We still note that, in our view, estimating cell subsets at higher resolution, albeit very promising, may not be the main advantage of EPIC compared to other methods. Rather, we believe that inclusion of more relevant reference profiles (tumor infiltrating vs. blood), the ability to consider uncharacterized cell types and the renormalization by mRNA content are more important for the improvement in predictions.</p><disp-quote content-type="editor-comment"><p>2) A better analysis and clarification of what are the key steps of the procedure that improve the results.</p></disp-quote><p>We are sorry we did not satisfactorily detail the improvements brought by each of the steps from EPIC.</p><p>We have therefore complemented our analyses, clarifying the key steps of the procedure improving the results. The two most important steps are:</p><p>1) Renormalization by mRNA content (<xref ref-type="fig" rid="fig2">Figure 2A</xref> vs. <xref ref-type="fig" rid="fig2">Figure 2C</xref>; <xref ref-type="fig" rid="fig2s2">Figure 2—figure supplement 2</xref>. <xref ref-type="fig" rid="fig2s3">Figure 2—figure supplement 3</xref>).</p><p>2) Ability to consider uncharacterized (and possibly highly variable) cell types in the cell fraction prediction (<xref ref-type="fig" rid="fig2s4">Figure 2—figure supplement 4</xref>; and the comparisons in <xref ref-type="fig" rid="fig5s1">Figure 5—figure supplements 1</xref>–<xref ref-type="fig" rid="fig5s5">5</xref>).</p><p>Other steps, like the use of the variability in the gene expression reference profiles (<xref ref-type="fig" rid="fig2s3">Figure 2—figure supplement 3</xref>) and the use of more biologically relevant reference gene expression profiles (<xref ref-type="fig" rid="fig3">Figure 3</xref> vs. <xref ref-type="fig" rid="fig4">Figure 4</xref>, <xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1</xref>) further add some improvements to the results, as discussed in the manuscript.</p><disp-quote content-type="editor-comment"><p>3) Clarify the dependency of the results of outliers and in general revise the significance criteria.</p></disp-quote><p>We agree that outliers could have some influence on the results. For this reason, we decided to remove the analysis performed about the melanoma immunohistochemistry data from Jönsson et al., 2010. Indeed this dataset was only qualitative, grouping the B and T cells infiltration into absent, low or high, and within the high groups, only four samples were present, two of which were very highly infiltrated such that results were highly biased by these. If removing these two outlier samples, then not enough samples remained in the high infiltration to be conclusive.</p><p>Considering the other results, we revised our significance criteria, lowering the p-values needed for results to be considered as significant.</p><p>We also discussed in the updated manuscript that datasets with a large range of data points (i.e. large variability in cell fractions across samples) could present some very high correlations due to few points driving the correlation. We then emphasized that it is important to consider the correlation values only to compare the different methods on the same dataset as the range of values there will be the same.</p><p>In addition to the correlation values, we also underline in the revised manuscript that the root mean squared values provide another good indicator of the quality of the predictions. Notably, the RMSE is not influenced by outlier data points that can drive the high correlation values.</p><p>Based on all these comparisons, we still believe that EPIC performed very well and often significantly better than other methods.</p><disp-quote content-type="editor-comment"><p>4) Make the system accessible via a web interface.</p></disp-quote><p>We have now implemented such a web interface and made it available at the address: <ext-link ext-link-type="uri" xlink:href="http://epic.gfellerlab.org">http://epic.gfellerlab.org</ext-link>.</p><p>Users can upload their own dataset for which they want to estimate the proportion of cells. They could then choose to use our implemented gene expression reference profiles or to upload some reference profiles of their own, and define various other parameters.</p><p>Results are then outputted as a web-table with the various cell type proportions (this table can also easily be downloaded), and different figures complement the results, giving an overview of the various cell type proportions.</p><disp-quote content-type="editor-comment"><p>Other concerns:</p><p>1) The authors should consider to extend the reference gene expression profiles to additional cell types such as stromal and endothelial cells which are known to have a role in tumor microenvironment as well as deepen the separation between cytotoxic T cells (CD8 cells) and CD4 T cells gene expression profiles, which currently is low and at a level less than what has been shown to be important correlates for immune-tumor interactions/therapeutic response.</p></disp-quote><p>We have now extended our reference gene expression profiles to also include also CD4<sup>+</sup> T cells, CD8<sup>+</sup> T cells, stromal (cancer-associated fibroblasts) and endothelial cells, showing good accuracy of the predictions for these cell types as well, as described above in point 1.</p><disp-quote content-type="editor-comment"><p>2) Consider rephrasing, the estimation of the tumor in 3D – it is not too surprising given that the melanoma forms the bulk of the tumor in most of these samples and is quite distinct – this is akin to getting neutrophil estimates correct in whole blood.</p></disp-quote><p>We have updated our discussion of these results in the subsection “Validation in blood” to clarify why these predictions can really be considered as good and are not just an artifact of the cancer cell gene expression being totally different from the other cell types.</p><p>We emphasize here that it is not only the correlation that is good in our predictions but also the root mean squared error, showing that our predictions are able to predict accurately the true absolute proportions of the melanoma cells (e.g. in <xref ref-type="fig" rid="fig3">Figure 3C</xref> (previous 3D), the predicted proportion of cells fall nearly perfectly on the gray dashed line, which corresponds to the y = x line (i.e. line of &quot;predicted value&quot; = &quot;observed value&quot;).</p><p>In addition to having good predictions for the melanoma cell fractions, these results also show that the predictions were also accurate for the various immune cell types, which have much more similar reference profiles (<xref ref-type="fig" rid="fig4s1">Figure 4—figure supplement 1</xref>), and thus the results we present there are not just as simple as if we would only be predicting the neutrophils proportions from a whole blood sample.</p><disp-quote content-type="editor-comment"><p>3) With respect to the second validation (comparing EPIC to IHC data), the authors claimed they observed &quot;a good agreement between cell proportions measured by IHC and our predictions&quot;, however there is a weak non-significant correlation (r=0.3, p=0.09) between these factors in macrophages that should be mentioned in the text. This may be due to the maker used in IHC being expressed in other cell subsets or due to protein/mRNA differences – the former being relatively easy to distinguish.</p></disp-quote><p>In our revised predictions, the correlation between the macrophages predicted by EPIC and observed IHC values is better, even with the reference profiles from peripheral blood (new correlation is r=0.52, p=0.002). This improvement can be explained by our use of a refined list of signature genes and the use of TPM-normalized reference profiles.</p><p>However the results are not significant in this analysis for the predictions of the CD8 T cells that did not exist in the previous version of the manuscript. We made therefore a comment in the revision about this correlation that is not significant.</p><p>Importantly however, the correlations for both macrophages and CD8 T cells improve in this immunohistochemistry dataset when using the reference profiles from tumor infiltrating cells (r=0.66, p&lt;10<sup>-4</sup> and r=0.53, p=0.001 respectively). We anticipate that this improvement is due to the use of reference gene expression profiles corresponding better to the phenotype of CD8 T cells and macrophages present in primary tumors.</p><p>We expanded the discussion about this point in the Discussion section.</p><disp-quote content-type="editor-comment"><p>4) The first test and comparison with other methods is carried out with normal blood samples and (<xref ref-type="fig" rid="fig2">Figure 2B</xref>). The EPIC method performs better (pearson R) than other methods. Notice that in whole blood (dataset 3 (Linsley et al., 2014)) the differences with CIBERSORT and DSA are minimal. It will be important to clarify if the additional information is provided by the inclusion of the estimated mRNA content in the calculations (<xref ref-type="fig" rid="fig2">Figure 2A</xref> versus 2C).</p></disp-quote><p>Our new comparisons show that indeed other methods like CIBERSORT and DSA could also benefit from the renormalization by mRNA (<xref ref-type="fig" rid="fig2s2">Figure 2—figure supplement 2</xref>).</p><p>Importantly however, EPIC is especially designed to predict the proportion of cells in tumor samples and the ability of EPIC to consider a cell type without any reference gene expression profiles is another particularly important improvement in this context (<xref ref-type="fig" rid="fig2s4">Figure 2—-figure supplement 4</xref>).</p><disp-quote content-type="editor-comment"><p>5) Reconsider the following claim &quot;We observed a remarkable agreement between our predictions and experimentally determined cell fractions (<xref ref-type="fig" rid="fig3">Figure 3A</xref>). Of note, the proportion of melanoma cells could be very accurately predicted even in the absence of a priori information about their gene expression.&quot; in light of the small size of the data sets (4 donors of which two of them dominate the correlation).</p></disp-quote><p>We have complemented the discussion of these results, underlining this possible artifact. We still point out that, despite this small sample size and some data points that might be driving high correlation values, the predictions fall nearly on the y=x line, indicating that all cell types could indeed be predicted accurately, as also reflected by the low RMSE.</p><p>In addition, we emphasized in the revised manuscript that the correlation values should only be compared for methods tested on the same datasets, and in our comparison with the other methods these correlations were lower for the other methods, despite the presence of the same data possibly dominated by two donors.</p><disp-quote content-type="editor-comment"><p>6) Comment of the significance of the results in <xref ref-type="fig" rid="fig3">Figure 3B</xref> and <xref ref-type="fig" rid="fig3">Figure 3C</xref> where the differences are based on single outliers.</p></disp-quote><p>We agree that outliers in <xref ref-type="fig" rid="fig3">Figure 3C</xref> have some influence on the results. For this reason, as detailed in the response to major comment 3), we decided to remove the analysis performed about this data. But we do not think that outliers in <xref ref-type="fig" rid="fig3">Figure 3B</xref> are biasing the results from this other analysis.</p><disp-quote content-type="editor-comment"><p>7) It will be good to check if in the information in <xref ref-type="fig" rid="fig5">Figure 5A</xref> (and supplementary figures) can be better interpreted comparing the method only in normal tissue samples (equivalent to <xref ref-type="fig" rid="fig5">Figure 5</xref> supplementary figures).</p></disp-quote><p>We believe this concern has already been answered. Indeed in <xref ref-type="fig" rid="fig5">Figure 5B</xref> we do a comparison of all the methods if considering only the normal immune cell types. And in <xref ref-type="fig" rid="fig2">Figure 2B</xref> (and <xref ref-type="fig" rid="fig2s1">Figure 2—figure supplements 1</xref>–<xref ref-type="fig" rid="fig2s2">2</xref>) we performed a detailed comparison of all methods based on healthy blood samples.</p><disp-quote content-type="editor-comment"><p>8) Assess the significance of the results in <xref ref-type="fig" rid="fig5">Figure 5B</xref>.</p></disp-quote><p>We have now indicated with some stars the p-values for each correlation given on <xref ref-type="fig" rid="fig5">Figure 5B</xref> as well as on <xref ref-type="fig" rid="fig5">Figure 5A</xref> and <xref ref-type="fig" rid="fig2">Figure 2B</xref>.</p><disp-quote content-type="editor-comment"><p>9) Benchmarking other methods, such as Cibersort by summing high-resolution cell subsets may be incorrect – a better approach would be to replace LM22 with the matrix derived by the authors – if not, I would suggest saying that this comparison is less than ideal.</p><p>10) It is not clear from the manuscript whether or not the advance over CIBERSORT is due to a better marker gene set and reference panel or due to the other methodological innovations that they made. This point should be clarified.</p></disp-quote><p>These two comments are highly related in will thus be answered together.</p><p>First, we have now included in our analyses the results from CIBERSORT based on LM22 reference profiles as well as based on the reference profiles and signatures we derived in our study. We can note that the results from CIBERSORT based on either of the reference profiles are similar; in some cases results are better based on LM22 signature and in other cases it is better with our signature (e.g. <xref ref-type="fig" rid="fig2">Figure 2B</xref>, <xref ref-type="fig" rid="fig2s1">Figure 2—figure supplement 1</xref>, <xref ref-type="fig" rid="fig5">Figure 5B</xref>).</p><p>We also showed in the new <xref ref-type="fig" rid="fig2s1">Figure 2—figure supplements 1</xref>-4 that the methodological innovations we implemented in EPIC are important for accurate predictions, which is then verified in the context of tumor samples as exemplified by the results from <xref ref-type="fig" rid="fig5">Figure 5A-B</xref> and <xref ref-type="fig" rid="fig5s1">Figure 5—figure supplement 1</xref>.</p><disp-quote content-type="editor-comment"><p>11) The reference to the use of &quot;zeros&quot; in the gene expression profile of cancerous tissue as informative to be leveraged in deconvolution in Gosink 2007 and Clarke 2010 should be included.</p></disp-quote><p>We thank the reviewer for pointing out these papers and we have included references to these in the revised manuscript, discussing their idea of using genes not expressed by a given cell to estimate its proportion.</p><disp-quote content-type="editor-comment"><p>12) Respect to ISOpure, it is not clear from the description whether ISOpure was run just with signature genes or with the whole gene expression profile.</p></disp-quote><p>We apologize if the explanation on how ISOpure was run was not clear. Indeed, we used here the whole gene expression profiles and not only the signature genes, as ISOpure has been specifically designed to account for the gene expression of all the genes from a sample. This point has been clarified in the text.</p><disp-quote content-type="editor-comment"><p>13) The ideas implicit in DeMix where the ratio of the variances provides an implicit importance weight (Ahn 2013) should be discussed.</p></disp-quote><p>We thank the reviewer for this reference and we added it in the text. This is also some interesting framework to estimate the proportion of cell types from a mixed sample in the presence of one uncharacterized cell type. This framework works in a similar way than ISOpure that we have tested in our manuscript.</p><p>The weights given to each gene in EPIC (based on their variability in the reference profiles) is included in the constrained least square optimization we perform. In contrary, DeMix method does not perform such regression based on signature genes, but it considers the distribution of each gene in each pure normal tissue sample and in each tumor sample. Based on these distributions, assumed to be log-normal distributed in the normal tissue, DeMix estimates the gene distribution inside the tumor cells and proportion of tumor cells that would best match the observed distribution of genes in the mixed tumor samples. We agree that when doing such predictions, the genes that had a narrower distribution both in the normal and tumor samples will be implicitly more important and should have a bigger impact on the predicted tumor cell fractions. However, no real weights will be given to these genes in solving the problem with DeMix.</p><p>Also, this method assumes that the normal tissue is composed of a single type of “normal” cells or at least that the normal cell types have a constant proportion inside normal tissue. Such a framework would thus not be appropriate to study the proportions of various immune cell types infiltrating a tumor, as it has been observed that the proportion of the different normal cells (various immune cell types, stromal and endothelial cells) vary from one patient to another.</p><disp-quote content-type="editor-comment"><p>Other points:</p><p>1) The authors should change the scale and marking of the statistical significance from (*p&lt;0.1; **p&lt;0.05; ***p&lt;0.01) to (*p&lt;0.05; **p&lt;0.01; ***p&lt;0.001) as p&gt;0.05 is not considered significant.</p></disp-quote><p>As suggested by the reviewer, we modified the scale of statistical significance to (*p&lt;0.05; **p&lt;0.01; ***p&lt;0.001) on the figures where the exact p-value was not directly given.</p><disp-quote content-type="editor-comment"><p>2) The authors claimed that &quot;Immune cells differ in their gene expression profiles depending on their state and site of origin (e.g., blood or tumors)&quot; – a reference should be added.</p></disp-quote><p>We added various references that discuss the fact that tumor infiltrating immune cells present an altered phenotype compared to circulating immune cells (e.g. describing the exhaustion phenotype of T cells).</p><disp-quote content-type="editor-comment"><p>3) There is a lack in specifying &quot;Supplementary file 4&quot; in the relevant places.</p></disp-quote><p>We have added references to this file (now named <xref ref-type="supplementary-material" rid="supp3">Supplementary file 3</xref>) in the legend of the respective figures. References to this file were already present in various places in the main text.</p><disp-quote content-type="editor-comment"><p>4) Figures and supplementary figures are not numbered in the manuscript, what makes difficult to know what the supplementary figures correspond to what text.</p></disp-quote><p>We are sorry that the numbers did not appear in the figure. This has now been corrected and all figures are numbered.</p><disp-quote content-type="editor-comment"><p>5) The use of a different scale for each method does not help to the interpretation of the figures.</p></disp-quote><p>The scale of the different figures are now the same for each method except for MCPcounter. Indeed MCPcounter outputs do not correspond to cell fractions so that its exact values are not comparable to the other methods. Then, the scales are not necessarily the same between various datasets due to different ranges in the data present in each dataset. Also for the immunohistochemistry data from Becht et al., 2016 (<xref ref-type="fig" rid="fig5s3">Figure 5—figure supplement 3</xref>), the ranges in the predicted proportions from the various methods is broad and we thus use different scales for each method to better see the results, as the true cell proportions are not known (only the intensity of some cell-specific protein markers are known from the immunohistochemistry).</p><disp-quote content-type="editor-comment"><p>6) Subsection “Validation in blood”: Renormalization by mRNA content is used in (Qiao 2012) to improve the estimates of cell-type proportions.</p></disp-quote><p>We included a reference to the method presented in this paper, PERT, which is similar to the method ISOpure we have tested here. To our understanding, ISOpure is some further improvement over PERT, developed in the same group, in order to allow for the estimation of an uncharacterized cell type in addition to the known cell types.</p><p>Also, to our understanding, PERT is allowing the gene expression value from each gene to be multiplied by some factor (different for each gene), in order to account for differences in expression in the reference cells studied in isolation and the same cells present in a mixed sample. However, it seems to us that PERT is not considering any renormalization by mRNA content at the cell level.</p><disp-quote content-type="editor-comment"><p>7) &quot;Prediction of cancer and immune cell type proportions&quot;: I found this explanation somewhat confusing because Equation 1 is never actually used in the deconvolution – only Equations 6 and 7. Because Equation 1 is introduced, I expected EPIC to try to solve it at some point.</p></disp-quote><p>We are sorry if the description of the equation was not very clear, but we think that this equation (1) is actually very important, as this is the equation this is at the root of EPIC method (see e.g. <xref ref-type="fig" rid="fig1">Figure 1C</xref>). In particular, equations (6) and (7) are directly resulting from equation (1). These two equations are obtained from equation (1) after normalizing the data into TPM as described in equation (2) and restraining the resolution to a subset of signature genes that are not expressed by the cancer cells, which simplify the system to solve. In order to make the explanation more easily understandable, we have decided to use the standard TPM normalization instead of our previous normalization of the counts. We have also extended equation (6) to detail how it is finally obtained.</p><disp-quote content-type="editor-comment"><p>Regarding references:</p><p>1) The authors claim that this is the first deconvolution methodology to take into account total RNA differences between cell subsets is incorrect, to the best of this reviewers knowledge, Baron et al. (Cell Systems 2016) propose a method, Bseq-SC which uses total RNA to improve deconvolution estimates. Of relevance here, their estimates for total RNA levels come from the single cell expression data, information which could be incorporated into EPIC too to increase its resolution.</p></disp-quote><p>We thank the reviewer for pointing out this reference and apologize for not citing this paper, which we had overlooked.</p><p>In this paper, the authors study normal pancreas at the single-cell level, having sequenced a very large amount of human and mice cells. In their analysis, they also developed a method, BSeq-SC to estimate the proportion of the various type of pancreatic cells from a bulk sample. This method integrates reference profiles the authors built from their single-cell RNA-seq data and then use CIBERSORT for the cell fraction predictions. The authors indeed observed that the different types of cells (mostly pancreatic but also very few immune cells) contained a different number of total transcripts. They used this information when building the reference profiles from pancreatic cells.</p><p>Contrary to EPIC, this renormalization by mRNA content is thus performed a priori on the reference gene expression profiles, instead of doing it a posteriori on the predicted mRNA proportions. For completeness in our analyses, we thus also modified EPIC in order to perform such a priori renormalization and observed the results were similar to those based on the a posteriorinormalization developed for EPIC (<xref ref-type="fig" rid="fig2s3">Figure 2—figure supplement 3</xref>).</p><p>[Editors' note: further revisions were requested prior to acceptance, as described below.]</p><disp-quote content-type="editor-comment"><p>Essential revisions:</p><p>The claim that &quot;ISOpure is specifically designed to run genome-wide&quot; does not appear anywhere in the ISOpure manuscript, is not consistent with the uses of ISOpure, and there is nothing obvious in the ISOpure algorithm that makes it specifically designed to be applied genome-wide (such a claim is made for PERT, and one could argue that PERT contains a gene-specific weighting mechanism, like EPIC, which makes it suitable for genome-wide use, but no such claim is made for ISOpure).</p><p>Indeed, an ISOpure-like method applied genome-wide in the PERT manuscript does quite badly at recovering the mixture proportions of the various cell types. Therefore, the new version in the revised version regarding ISOpure needs to be revised and inaccurate statements removed.</p><p>In conclusion, in the new version EPIC should be compared with ISOpure using the same inputs as CIBERSORT and EPIC.</p></disp-quote><p>We thank the reviewer for this insightful comment about how to best use ISOpure method and apologize for the confusion between PERT and ISOpure. We have now re-run this method based on the same subset of signature genes than what we had derived for EPIC. Of note, these signature genes (in addition to the reference profiles) are a new list of signature genes that we have derived in this manuscript for EPIC but they can be used in other contexts as well, like here for ISOpure.</p><p>We observe some improvement for ISOpure based on such subset of genes compared to previous whole-genome results (see e.g. the figures in <xref ref-type="fig" rid="respfig3">Author response image 3</xref> comparing the previous results and updated ones). For this reason, we included the revised gene-signature based results for ISOpure in our manuscript.</p><fig id="respfig3"><object-id pub-id-type="doi">10.7554/eLife.26476.033</object-id><label>Author response image 3.</label><caption><title>Comparison of the prediction accuracies for EPIC, ISOpure based on all genes and ISOpure based on the subset of signature genes we derived for EPIC.</title><p>(<bold>A</bold>) For all immune cell types in the blood datasets (dataset 1: Zimmermann et al. 2016; dataset2: Hoek et al. 2015; dataset 3: Linsley et al. 2014). (<bold>B</bold>) and (<bold>C</bold>) in the tumor datasets, based on all cell types, including immune, stromal and cancer cells (<bold>B</bold>), or based only on all the immune cell types (<bold>C</bold>) (flow cytometry: our new experiment; single-cell RNA-seq: data from Tirosh et al. 2016). The stars above each bar indicate if the Pearson correlation was significant (* p &lt; 0.05; ** p &lt; 0.01; *** p &lt; 0.001). These figures are the same than in our manuscript <xref ref-type="fig" rid="fig2">Figures 2B</xref> and <xref ref-type="fig" rid="fig5">5A-B</xref> but comparing different ISOpure results and EPIC ones.</p></caption><graphic mime-subtype="jpeg" mimetype="image" xlink:href="elife-26476-resp-fig3-v2"/></fig><p>We can note that despite this improvement for ISOpure, EPIC is still performing better. It is important to underline that the main goal of ISOpure is to estimate the proportion of the cancer cells present in the bulk samples and to estimate the gene expression profiles from the unknown cancer cells from these bulk samples, as we have also written in the manuscript. This can be a reason why ISOpure performs less good than EPIC to predict the proportion of all cell types present in the bulk as this is not the main focus of ISOpure contrary to EPIC.</p><p>Finally, please note that the reason why we had originally used ISOpure based on all genes is that the method description of ISOpure's manuscript (Quon et al. 2013) states that the tumor and healthy profiles are composed of the measured gene expression level of <italic>G</italic> transcripts, where &quot;<italic>G</italic> is typically on the order of 10,000&quot;. It seemed to us that a whole genome data would better reflect these numbers than a subset of about hundred signature genes, and we had thought that ISOpure would therefore perform better based on all genes, which we have now seen was not really the case here.</p></body></sub-article></article>