<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE article PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD with MathML3 v1.2 20190208//EN"  "JATS-archivearticle1-mathml3.dtd"><article article-type="research-article" dtd-version="1.2" xmlns:ali="http://www.niso.org/schemas/ali/1.0/" xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink"><front><journal-meta><journal-id journal-id-type="nlm-ta">elife</journal-id><journal-id journal-id-type="publisher-id">eLife</journal-id><journal-title-group><journal-title>eLife</journal-title></journal-title-group><issn pub-type="epub" publication-format="electronic">2050-084X</issn><publisher><publisher-name>eLife Sciences Publications, Ltd</publisher-name></publisher></journal-meta><article-meta><article-id pub-id-type="publisher-id">70092</article-id><article-id pub-id-type="doi">10.7554/eLife.70092</article-id><article-categories><subj-group subj-group-type="display-channel"><subject>Tools and Resources</subject></subj-group><subj-group subj-group-type="heading"><subject>Neuroscience</subject></subj-group></article-categories><title-group><article-title>An open-source, high-performance tool for automated sleep staging</article-title></title-group><contrib-group><contrib contrib-type="author" corresp="yes" id="author-235340"><name><surname>Vallat</surname><given-names>Raphael</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0000-0003-1779-7653</contrib-id><email>raphaelvallat@berkeley.edu</email><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="fn" rid="con1"/><xref ref-type="fn" rid="conf1"/></contrib><contrib contrib-type="author" corresp="yes" id="author-39597"><name><surname>Walker</surname><given-names>Matthew P</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">https://orcid.org/0000-0002-7839-6389</contrib-id><email>mpwalker@berkeley.edu</email><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="fn" rid="con2"/><xref ref-type="fn" rid="conf1"/></contrib><aff id="aff1"><label>1</label><institution>Center for Human Sleep Science, Department of Psychology, University of California, Berkeley</institution><addr-line><named-content content-type="city">Berkeley</named-content></addr-line><country>United States</country></aff></contrib-group><contrib-group content-type="section"><contrib contrib-type="editor"><name><surname>Peyrache</surname><given-names>Adrien</given-names></name><role>Reviewing Editor</role><aff><institution>McGill University</institution><country>Canada</country></aff></contrib><contrib contrib-type="senior_editor"><name><surname>Büchel</surname><given-names>Christian</given-names></name><role>Senior Editor</role><aff><institution>University Medical Center Hamburg-Eppendorf</institution><country>Germany</country></aff></contrib></contrib-group><pub-date date-type="publication" publication-format="electronic"><day>14</day><month>10</month><year>2021</year></pub-date><pub-date pub-type="collection"><year>2021</year></pub-date><volume>10</volume><elocation-id>e70092</elocation-id><history><date date-type="received" iso-8601-date="2021-05-06"><day>06</day><month>05</month><year>2021</year></date><date date-type="accepted" iso-8601-date="2021-09-29"><day>29</day><month>09</month><year>2021</year></date></history><pub-history><event><event-desc>This manuscript was published as a preprint at bioRxiv.</event-desc><date date-type="preprint" iso-8601-date="2021-05-28"><day>28</day><month>05</month><year>2021</year></date><self-uri content-type="preprint" xlink:href="https://doi.org/10.1101/2021.05.28.446165"/></event></pub-history><permissions><copyright-statement>© 2021, Vallat and Walker</copyright-statement><copyright-year>2021</copyright-year><copyright-holder>Vallat and Walker</copyright-holder><ali:free_to_read/><license xlink:href="http://creativecommons.org/licenses/by/4.0/"><ali:license_ref>http://creativecommons.org/licenses/by/4.0/</ali:license_ref><license-p>This article is distributed under the terms of the <ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution License</ext-link>, which permits unrestricted use and redistribution provided that the original author and source are credited.</license-p></license></permissions><self-uri content-type="pdf" xlink:href="elife-70092-v1.pdf"/><self-uri content-type="figures-pdf" xlink:href="elife-70092-figures-v1.pdf"/><abstract><p>The clinical and societal measurement of human sleep has increased exponentially in recent years. However, unlike other fields of medical analysis that have become highly automated, basic and clinical sleep research still relies on human visual scoring. Such human-based evaluations are time-consuming, tedious, and can be prone to subjective bias. Here, we describe a novel algorithm trained and validated on +30,000 hr of polysomnographic sleep recordings across heterogeneous populations around the world. This tool offers high sleep-staging accuracy that matches human scoring accuracy and interscorer agreement no matter the population kind. The software is designed to be especially easy to use, computationally low-demanding, open source, and free. Our hope is that this software facilitates the broad adoption of an industry-standard automated sleep staging software package.</p></abstract><kwd-group kwd-group-type="author-keywords"><kwd>automated sleep staging</kwd><kwd>machine-learning</kwd><kwd>sleep scoring</kwd><kwd>algorithm</kwd><kwd>YASA</kwd><kwd>NREM sleep</kwd><kwd>REM sleep</kwd><kwd>slow wave</kwd><kwd>sleep spindle</kwd><kwd>sleep apnea</kwd></kwd-group><kwd-group kwd-group-type="research-organism"><title>Research organism</title><kwd>Other</kwd><kwd>Human</kwd></kwd-group><funding-group><funding-statement>No external funding was received for this work.</funding-statement></funding-group><custom-meta-group><custom-meta specific-use="meta-only"><meta-name>Author impact statement</meta-name><meta-value>A robust automatic sleep-staging algorithm offers a high level of accuracy matching that of typical human interscorer agreement.</meta-value></custom-meta></custom-meta-group></article-meta></front><body><sec id="s1" sec-type="intro"><title>Introduction</title><p>Sleep is fundamental to human health. Adequate sleep supports a panoply of physiological body functions, including immune, metabolic, and cardiovascular systems (<xref ref-type="bibr" rid="bib5">Besedovsky et al., 2019</xref>; <xref ref-type="bibr" rid="bib8">Cappuccio and Miller, 2017</xref>; <xref ref-type="bibr" rid="bib18">Harding et al., 2020</xref>). Within the brain, sufficient sleep facilitates optimal learning, memory, attention, mood, and decision-making processes (<xref ref-type="bibr" rid="bib3">Ben Simon et al., 2020</xref>; <xref ref-type="bibr" rid="bib49">Walker, 2009</xref>). Improving sleep health has therefore emerged as a preventive strategy to reduce the risk of cardiovascular and metabolic disease, all-cause mortality risk, and more recently, the accumulation of Alzheimer’s disease pathology within the brain (<xref ref-type="bibr" rid="bib7">Cappuccio et al., 2010</xref>; <xref ref-type="bibr" rid="bib28">Leary et al., 2020</xref><xref ref-type="bibr" rid="bib8">Cappuccio and Miller, 2017</xref>; <xref ref-type="bibr" rid="bib23">Ju et al., 2014</xref>; <xref ref-type="bibr" rid="bib52">Winer et al., 2020</xref>). Considering this impact, the demand for quantifying human sleep at a research-, clinical-, and consumer-based level has increased expeditiously over the past decade (<xref ref-type="bibr" rid="bib15">Fleming et al., 2015</xref>; <xref ref-type="bibr" rid="bib42">Shelgikar et al., 2016</xref>).</p><p>Polysomnography (PSG) – the simultaneous measurement of brainwaves, eye movements, muscle activity, heart rate, and respiration – is the gold standard for objective physiological quantification of human sleep. The classification of sleep stages across the night provides information on the overall architecture of sleep across the night, as well as the duration and proportion of the sleep stages, all of which inform the diagnosis of sleep disorders and specific diseases states.</p><p>Currently, such sleep scoring is typically performed by humans, accomplished by first dividing the night of PSG recording into 30 s segments (called ‘epochs’). Each epoch is then assigned a sleep stage based on standard rules defined by the American Academy of Sleep Medicine (AASM, <xref ref-type="bibr" rid="bib4">Berry et al., 2012</xref>; <xref ref-type="bibr" rid="bib22">Iber et al., 2007</xref>).</p><p>Every night, thousands of hours of sleep are recorded in research, clinical, and commercial ventures across the globe. However, since sleep staging is performed visually by human experts, it represents a pragmatic bottleneck. It is a non-trivial, time-intensive process, with visual scoring of a single night of human sleep requiring up to 2 hr to complete by a well-trained individual. As if not more critical, this human-scored approach suffers from issues of lower than desirable <italic>inter</italic>scorer consistency of agreement (~83% agreement, <xref ref-type="bibr" rid="bib41">Rosenberg and Van Hout, 2013</xref>). Moreover, the same scoring individual typically experiences low <italic>intra</italic>scorer agreement of the same sleep recording (~90%, <xref ref-type="bibr" rid="bib14">Fiorillo et al., 2019</xref>). That is, different human sleep-scoring experts presented with the same recording will likely end up with somewhat dissimilar sleep-staging evaluations, and even the same expert presented with the same recording assessed at two different time points will arrive at differing results.</p><p>Advances in machine learning have motivated efforts to try and classify sleep using automated systems. Several such automatic sleep-staging algorithms have emerged in recent years. While an exhaustive review of such sleep-staging algorithms is beyond the scope of this article, we offer an overview of some of the most relevant algorithms within the last 5 years. For a more in-depth review, we refer the reader to <xref ref-type="bibr" rid="bib14">Fiorillo et al., 2019</xref>.</p><p><xref ref-type="bibr" rid="bib46">Sun et al., 2017</xref> reported an algorithm that was trained and evaluated on 2000 PSG recordings from a single-sleep clinic. The overall Cohen’s kappa on the testing set was 0.68 (n = 1000 PSG nights). Thereafter, and algorithm termed ‘Z3Score’ (<xref ref-type="bibr" rid="bib36">Patanaik et al., 2018</xref>) was published, trained and evaluated on ~1700 PSG recordings from four datasets. Here, the overall accuracy ranged from 89.8% in healthy adults/adolescents to 72.1% in patients with Parkinson’s disease. The freely available ‘Stanford-stage’ algorithm (<xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref>) was trained and evaluated on 10 clinical cohorts (~3000 recordings), and presented with an accuracy of 87% against consensus human sleep stage scoring. A year later, the ‘SeqSleepNet’ algorithm (<xref ref-type="bibr" rid="bib40">Phan et al., 2019</xref>) was published, which represented a method trained and tested using a 20-fold cross-validation of 200 nights of PSG data, with an overall accuracy of 87.1%. Finally, the recent U-Sleep algorithm (<xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref>) was established using PSG recordings from 15,660 participants of 16 clinical studies. The overall accuracy was not reported, though the mean F1-score—a measure reflecting the quality of the prediction against the consensus scoring of five human experts—was 0.79 for healthy adults and 0.76 for patients with sleep apnea.</p><p>Despite this growing number of automated tools, accurate automated sleep staging has yet to become a de facto standard in the field. There are likely several reasons for this. First, some algorithms are not free, sitting behind paywalls and/or not publicly available. Second, other algorithms require paid software to run the nonetheless free algorithm on, such as MATLAB. Third, some algorithms have been trained on a sample size too small for robustness and/or data from a single-sleep center or population. As a result, their ability to generalize to other recording systems and/or populations, including patients with sleep disorders or across broad age ranges, has been a concern. Fourth, setting up and running these algorithms is often too complicated for most typical individuals as they require moderate- to high-level programing experience, creating a barrier of entry to adoption and broad use. A final common limitation to all these algorithms is that they were evaluated on different testing datasets and using different metrics, which prevents a direct comparison of the performance of these algorithms and had lead to understandable confusion among some sleep researchers and clinicians.</p><p>Seeking to address all such issues, here, we describe a free, flexible, and easy-to-use automated sleep-staging software that has been trained and evaluated on more than 30,000 hr of PSG-staged sleep from numerous independent and heterogeneous datasets with a wide range of age, ethnicities, and health status levels. Furthermore, we test our algorithm against two recent sleep-staging algorithms (<xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref>; <xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref>) on a previously unseen consensus-scored sleep dataset of healthy adults and patients with obstructive sleep apnea (OSA).</p></sec><sec id="s2" sec-type="results"><title>Results</title><sec id="s2-1"><title>Descriptive statistics</title><p>The <italic>training set</italic> consisted of more than 31,000 hr of PSG data across 3163 unique full-night PSG recordings from seven different datasets (Cleveland Children’s Sleep and Health Study [CCSHS], n = 414; Cleveland Family Study [CFS], n = 586; Childhood Adenotonsillectomy Trial [CHAT], n = 351; Home Positive Airway Pressure [HomePAP], n = 82; Multi-Ethnic Study of Atherosclerosis [MESA], n = 575; Osteoporotic Fractures in Men Study [MrOS], n = 565; Sleep Heart Health Study [SHHS], n = 590). All these datasets are publicly available from the National Sleep Research Resource (NSRR) website (<ext-link ext-link-type="uri" xlink:href="http://sleepdata.org">http://sleepdata.org</ext-link>). In total, these 3163 training nights represent almost 4 million unique 30 s epochs. Demographics and health data of the training set are shown in <xref ref-type="table" rid="table1">Table 1</xref>. The average apnea-hypopnea index (AHI) was 12.9 ± 16.35 (median = 6.95, range = 0–125). The AHI was ≥15 (= moderate sleep apnea) for 29% of the nights. The MESA dataset had the highest average AHI (19.2 ± 18.1), while the CCSHS had the lowest AHI (1.5 ± 5.2).</p><table-wrap id="table1" position="float"><label>Table 1.</label><caption><title>Demographics of the training set and testing set 1.</title><p>Age, body mass index (BMI), and apnea-hypopnea index (AHI) are expressed in mean ± standard deviation. The p-value for these three variables was calculated using a Welch’s two-sided t-test, and the effect size refers to the Hedges g. All the other categorical variables are expressed in percentage. Significance was assessed using a chi-square test of independence, and effect size refers to the Cramer’s V. The apnea severity was classified as follows: none = AHI &lt; 5 per hour, mild = AHI ≥ 5 but &lt; 15, moderate = AHI ≥ 15 but &lt; 30, and severe = AHI ≥ 30. p-Values were not adjusted for multiple comparisons.</p></caption><table frame="hsides" rules="groups"><thead><tr><th align="left" valign="bottom"/><th align="left" valign="bottom">Training</th><th align="left" valign="bottom">Testing set 1</th><th align="left" valign="bottom">p-Value</th><th align="left" valign="bottom">Effect size</th></tr></thead><tbody><tr><td align="left" valign="bottom">No. nights</td><td align="left" valign="bottom">561</td><td align="left" valign="bottom">3163</td><td align="left" valign="bottom">-</td><td align="left" valign="bottom">-</td></tr><tr><td align="left" valign="bottom">Age</td><td align="left" valign="bottom">49.79 ± 26.38</td><td align="left" valign="bottom">45.25 ± 28.18</td><td align="left" valign="bottom"><bold>&lt;0.001</bold></td><td align="left" valign="bottom">0.170</td></tr><tr><td align="left" valign="bottom">BMI</td><td align="left" valign="bottom">27.65 ± 7.40</td><td align="left" valign="bottom">26.83 ± 7.30</td><td align="left" valign="bottom"><bold>0.013</bold></td><td align="left" valign="bottom">0.111</td></tr><tr><td align="left" valign="bottom">Sex (% male)</td><td align="left" valign="bottom">56.56</td><td align="left" valign="bottom">55.385</td><td align="left" valign="bottom">0.630</td><td align="left" valign="bottom">0.008</td></tr><tr><td align="left" valign="bottom"><italic>Race (%)</italic></td><td align="left" valign="bottom">-</td><td align="left" valign="bottom">-</td><td align="left" valign="bottom">0.985</td><td align="left" valign="bottom">0.006</td></tr><tr><td align="left" valign="bottom">Black</td><td align="left" valign="bottom">29.47</td><td align="left" valign="bottom">29.23</td><td align="left" valign="bottom">-</td><td align="left" valign="bottom">-</td></tr><tr><td align="left" valign="bottom">White</td><td align="left" valign="bottom">57.92</td><td align="left" valign="bottom">58.46</td><td align="left" valign="bottom">-</td><td align="left" valign="bottom">-</td></tr><tr><td align="left" valign="bottom">Hispanic</td><td align="left" valign="bottom">7.24</td><td align="left" valign="bottom">6.84</td><td align="left" valign="bottom">-</td><td align="left" valign="bottom">-</td></tr><tr><td align="left" valign="bottom">Asian or Pacific Islander</td><td align="left" valign="bottom">5.375</td><td align="left" valign="bottom">5.47</td><td align="left" valign="bottom">-</td><td align="left" valign="bottom">-</td></tr><tr><td align="left" valign="bottom">AHI (events/hour)</td><td align="left" valign="bottom">12.94 ± 16.35</td><td align="left" valign="bottom">11.99 ± 14.99</td><td align="left" valign="bottom">0.166</td><td align="left" valign="bottom">0.059</td></tr><tr><td align="left" valign="bottom"><italic>Apnea severity</italic></td><td align="left" valign="bottom">-</td><td align="left" valign="bottom">-</td><td align="left" valign="bottom">0.820</td><td align="left" valign="bottom">0.016</td></tr><tr><td align="left" valign="bottom">None</td><td align="left" valign="bottom">42.78</td><td align="left" valign="bottom">43.76</td><td align="left" valign="bottom">-</td><td align="left" valign="bottom">-</td></tr><tr><td align="left" valign="bottom">Mild</td><td align="left" valign="bottom">27.79</td><td align="left" valign="bottom">27.18</td><td align="left" valign="bottom">-</td><td align="left" valign="bottom">-</td></tr><tr><td align="left" valign="bottom">Moderate</td><td align="left" valign="bottom">17.325</td><td align="left" valign="bottom">18.12</td><td align="left" valign="bottom">-</td><td align="left" valign="bottom">-</td></tr><tr><td align="left" valign="bottom">Severe</td><td align="left" valign="bottom">12.11</td><td align="left" valign="bottom">10.94</td><td align="left" valign="bottom">-</td><td align="left" valign="bottom">-</td></tr><tr><td align="left" valign="bottom">Insomnia (%)</td><td align="left" valign="bottom">6.95</td><td align="left" valign="bottom">4.50</td><td align="left" valign="bottom">0.255</td><td align="left" valign="bottom">0.019</td></tr><tr><td align="left" valign="bottom">Depression (%)</td><td align="left" valign="bottom">15.83</td><td align="left" valign="bottom">13.158</td><td align="left" valign="bottom">0.407</td><td align="left" valign="bottom">0.014</td></tr><tr><td align="left" valign="bottom">Diabetes (%)</td><td align="left" valign="bottom">15.82</td><td align="left" valign="bottom">17.99</td><td align="left" valign="bottom">0.260</td><td align="left" valign="bottom">0.018</td></tr><tr><td align="left" valign="bottom">Hypertension (%)</td><td align="left" valign="bottom">38.83</td><td align="left" valign="bottom">35.27</td><td align="left" valign="bottom">0.152</td><td align="left" valign="bottom">0.023</td></tr></tbody></table></table-wrap><p>The <italic>testing set 1</italic> consisted of 585 unique full-night PSG recordings from six different datasets (CCSHS, n = 100; CFS, n = 99; CHAT, n = 100; MESA, n = 97; MrOS, n = 90; SHHS, n = 99). The testing nights were randomly selected from a subset of nights that were not included in the training set (see Materials and methods). We did not include any nights from the HomePAP dataset because the latter only consisted of 82 nights after preprocessing, all of which were used for training. In total, these 585 testing nights represent 716,367 unique 30 s epochs, or roughly 6000 hr of PSG data. Demographics and health data of the testing set one are shown in <xref ref-type="table" rid="table1">Table 1</xref>. Importantly, there was no significant difference in the sex ratio, race distribution, or in the proportion of individuals diagnosed with insomnia, depression, or diabetes. Furthermore, there was no difference in AHI and the proportion of individuals with minimal, mild, moderate, or severe sleep apnea. Although participants were randomly assigned in the training/testing sets, there were some significant differences between these two sets. Specifically, age and body mass index (BMI) were lower in the testing set compared to the original training set (p’s&lt;0.05), although the effect sizes of these differences were all below 0.17 (considered small or negligible).</p><p>The <italic>testing set 2</italic> consisted of 80 full-night PSG recordings from the publicly available Dreem Open Dataset (DOD) dataset (<xref ref-type="bibr" rid="bib17">Guillot et al., 2020</xref>). The DOD consists of 25 nights from healthy adults (DOD-Healthy: age = 35.3 ± 7.51 years, 76% male, BMI = 23.8 ± 3.4) and 55 nights from patients with OSA (DOD-Obstructive: age = 45.6 ± 16.5 years, 64% male, BMI = 29.6 ± 6.4, AHI = 18.5 ± 16.2). Individual-level demographics and medical history were not provided for the DOD datasets; group averages for age, BMI, and AHI are reported from <xref ref-type="bibr" rid="bib17">Guillot et al., 2020</xref>. Five nights were excluded because the duration of the PSG data and the duration of the hypnogram differed by more than 1 min, leading to a final sample of 75 nights (~607 hr of data). Each night of the testing set 2 was scored by five registered sleep technicians, thus allowing to test the algorithm against a consensus of human scorers (see Materials and methods). Unlike the NSRR datasets, which were split into training and testing subsets, the two DOD datasets (healthy and patients) were only used for performance evaluation. This provides a more robust estimation of the algorithm’s performance on real-world data from a new sleep clinic or laboratory.</p></sec><sec id="s2-2"><title>Validation results</title><sec id="s2-2-1"><title>Testing set 1: NSRR holdout</title><p>Overall performance of the algorithm on the testing set 1 is described in <xref ref-type="fig" rid="fig1">Figure 1A</xref>. Median accuracy, calculated across all 585 testing nights, was 87.46%. The median Cohen’s kappa was 0.819, indicating excellent agreement, and similarly, the median Matthews correlation coefficient was 0.821. The CCSHS database testing set had the highest overall accuracy (median = 90.44%), while the MESA database had the lowest accuracy (median = 83.99%). In addition to traditional sleep staging, the algorithm is able to quantify the probability of each sleep stage at each 30 s epoch, which can then be used to derive a confidence score at each epoch. The median confidence of the algorithm across all the testing nights was 85.79%. Nights with a higher average confidence had significantly higher accuracy (<xref ref-type="fig" rid="fig1">Figure 1B</xref>, <italic>r</italic> = 0.76, p&lt;0.001).</p><fig-group><fig id="fig1" position="float"><label>Figure 1.</label><caption><title>Performance of the algorithm on the testing set 1 (n = 585 nights).</title><p>(<bold>A</bold>) Accuracy of all the testing nights, stratified by dataset. The median accuracy across all testing nights was 87.5%. (<bold>B</bold>) Correlation between accuracy and average confidence levels (in %) of the algorithm. The overall confidence was calculated for each night by averaging the confidence levels across all epochs. (<bold>C</bold>) Confusion matrix. The diagonal elements represent the percentage of epochs that were correctly classified by the algorithm (also known as sensitivity or recall), whereas the off-diagonal elements show the percentage of epochs that were mislabeled by the algorithm. (<bold>D</bold>) Duration of each stage in the human (red) and automatic scoring (green), calculated for each unique testing night and expressed as a proportion of the total duration of the polysomnography (PSG) recording.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-70092-fig1-v1.tif"/></fig><fig id="fig1s1" position="float" specific-use="child-fig"><label>Figure 1—figure supplement 1.</label><caption><title>Confusion matrices of the testing set 1, stratified by dataset.</title><p>The diagonal elements of the confusion matrices represent the percentage of epochs that were correctly classified by the algorithm (also known as sensitivity or recall), whereas the off-diagonal elements show the percentage of epochs that were mislabeled by the algorithm.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-70092-fig1-figsupp1-v1.tif"/></fig><fig id="fig1s2" position="float" specific-use="child-fig"><label>Figure 1—figure supplement 2.</label><caption><title>Distribution of confidence scores across sleep stages in the testing set 1.</title><p>The percent of epochs that were flagged as high-confidence (≥ 80%) by the algorithm was 86.3% for wakefulness (out of a total of 253,471 epochs), 17.5% for N1 (n = 32,783), 62.4% for N2 sleep (n = 249,055), 72.1% for N3 sleep (n = 91,712), and 66.9% for rapid eye movement (REM) sleep (n = 89,346).</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-70092-fig1-figsupp2-v1.tif"/></fig><fig id="fig1s3" position="float" specific-use="child-fig"><label>Figure 1—figure supplement 3.</label><caption><title>Performance of the YASA, <xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref>, and <xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref> algorithms on the DOD-Healthy testing set (n = 25 healthy adults).</title><p><italic>Top</italic>, F1-scores. <italic>Bottom</italic>, confusion matrices. The diagonal elements represent the percentage of epochs that were correctly classified by the algorithm (also known as sensitivity or recall), whereas the off-diagonal elements show the percentage of epochs that were mislabeled by the algorithm.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-70092-fig1-figsupp3-v1.tif"/></fig><fig id="fig1s4" position="float" specific-use="child-fig"><label>Figure 1—figure supplement 4.</label><caption><title>Confusion matrices of each individual human scorer on the DOD-Healthy testing set (n = 25 healthy adults).</title><p>Ground truth was defined as the unbiased consensus scoring, that is, excluding the current scorer (see Materials and methods). The diagonal elements of the confusion matrices represent the percentage of epochs that were correctly classified by the human scorer (also known as sensitivity or recall), whereas the off-diagonal elements show the percentage of epochs that were mislabeled by the human scorer.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-70092-fig1-figsupp4-v1.tif"/></fig><fig id="fig1s5" position="float" specific-use="child-fig"><label>Figure 1—figure supplement 5.</label><caption><title>Performance of the YASA, <xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref>, and <xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref> algorithms on the DOD-Obstructive testing set (n = 50 patients with obstructive sleep apnea).</title><p><italic>Top</italic>, F1-scores. <italic>Bottom</italic>, confusion matrices. The diagonal elements represent the percentage of epochs that were correctly classified by the algorithm (also known as sensitivity or recall), whereas the off-diagonal elements show the percentage of epochs that were mislabeled by the algorithm.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-70092-fig1-figsupp5-v1.tif"/></fig><fig id="fig1s6" position="float" specific-use="child-fig"><label>Figure 1—figure supplement 6.</label><caption><title>Confusion matrices of each individual human scorer on the DOD-Obstructive testing set (n = 50 patients with sleep apnea).</title><p>Ground truth was defined as the unbiased consensus scoring, that is, excluding the current scorer (see Materials and methods). The diagonal elements of the confusion matrices represent the percentage of epochs that were correctly classified by the human scorer (also known as sensitivity or recall), whereas the off-diagonal elements show the percentage of epochs that were mislabeled by the human scorer.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-70092-fig1-figsupp6-v1.tif"/></fig><fig id="fig1s7" position="float" specific-use="child-fig"><label>Figure 1—figure supplement 7.</label><caption><title>Top 20 most important features of the classifier.</title><p>The algorithm uses three different versions of all time-domain and frequency-domain features: (1) the raw feature, expressed in the original unit of data and calculated for each 30-sec epoch, (2) a smoothed and normalized version of that feature using a 7.5 min triangular-weighted rolling average, and (3) a smoothed and normalized version of that feature using a past 2 min rolling average. Importance was measured on the full training set during model training using Shapley values (SHAP).</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-70092-fig1-figsupp7-v1.tif"/></fig></fig-group><p>Next, we tested the classification performance of individual sleep stages (<xref ref-type="fig" rid="fig1">Figure 1C</xref>). The overall sensitivity (i.e., the percent of epochs that were correctly classified, see Materials and methods) of N3 sleep was 83.2%, leading to a median F1-score across all testing nights of 0.835. Rapid eye movement (REM) sleep, N2 sleep, and wakefulness all showed sensitivities above 85% (all median F1-scores ≥ 0.86). N1 sleep showed the lowest agreement, with an overall sensitivity of 45.4% and a median F1-score of 0.432 – a finding consistent with this sleep stage often showing very low agreement across human sleep scorers (&lt;45%, <xref ref-type="bibr" rid="bib31">Malhotra et al., 2013</xref>). These algorithm performance results were consistent when examined separately for each database (<xref ref-type="fig" rid="fig1s1">Figure 1—figure supplement 1</xref>).</p><p>Further examination of the confusion matrix showed that the two most common inaccuracies of the algorithm were (1) mislabeling N1 sleep as N2 sleep (27.5% of all true N1 sleep epochs) and (2) mislabeling N3 sleep as N2 sleep (16.1% of all true N3 sleep epochs). Importantly, the algorithm made few blatant errors, such as mislabeling N3 sleep as REM sleep (0.2%) or mislabeling REM sleep as N3 sleep (0.03%). In addition, when the algorithm misclassified an epoch, the second highest probability stage predicted by the algorithm was the correct one in 76.3% ± 12.6% of the time.</p><p>Additional analyses indicated that the algorithm was more prone to inaccuracies around sleep-stage transitions than during stable epochs (<xref ref-type="fig" rid="fig2">Figure 2F</xref>; mean accuracy around a stage transition: 69.15% ± 7.23%, during stable periods: 94.08% ± 5.61%, p&lt;0.001). Similarly, and as expected, accuracy was significantly greater for epochs flagged by the algorithm as high confidence (≥80% confidence) than in epochs with a confidence below 80% (95.90% ± 3.70% and 62.91% ± 6.6%, respectively, p&lt;0.001). The distribution of confidence levels across sleep stages is shown in <xref ref-type="fig" rid="fig1s2">Figure 1—figure supplement 2</xref>. The algorithm was most confident in epochs scored as wakefulness by the human scorer (mean confidence across all epochs = 92.7%) and least confident in epochs scored as N1 sleep (mean = 63.2%).</p><fig id="fig2" position="float"><label>Figure 2.</label><caption><title>Moderator analyses.</title><p>Accuracy of the testing nights as a function of age (<bold>A</bold>), body mass index (BMI) (<bold>B</bold>), sex (<bold>C</bold>), race (<bold>D</bold>), apnea-hypopnea index (AHI) (<bold>E</bold>), and whether or not the epoch is around a stage transition (<bold>F</bold>). An epoch is considered around a transition if a stage transition, as defined by the human scoring, is present within the 3 min around the epoch (1.5 min before, 1.5 min after).</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-70092-fig2-v1.tif"/></fig><p>We further tested for any systematic bias of the algorithm towards one or more sleep stages. The overall proportion of each sleep stage in the testing nights was similar between the human and automatic staging (all Cohen’s d &lt; 0.11; <xref ref-type="fig" rid="fig1">Figure 1D</xref>), indicating a negligible bias. Similarly, the percentage of stage transitions across the night was consistent in the human and automatic scoring (mean ± STD: 11.12% ± 5.19% and 11.46% ± 4.11%, respectively, Cohen’s d = 0.07).</p></sec><sec id="s2-2-2"><title>Testing set 2: Consensus scoring on the DOD-Healthy and DOD-Obstructive datasets</title><p>Next, we examined the performance of YASA on the testing set 2, a previously unseen dataset of healthy and sleep-disordered breathing patients that was scored by five registered experts (<xref ref-type="bibr" rid="bib17">Guillot et al., 2020</xref>; <xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref>). Performance of the algorithm is reported in <xref ref-type="table" rid="table2">Table 2</xref> for healthy adults (n = 25) and <xref ref-type="table" rid="table3">Table 3</xref> for individuals with sleep disorders.</p><table-wrap id="table2" position="float"><label>Table 2.</label><caption><title>Comparison of YASA against two existing algorithms and individual human scorers on the DOD-Healthy dataset (healthy adults, n = 25).</title><p>Values represent median ± interquartile range across all n = 25 nights. The YASA column shows the performance of the current algorithm against the consensus scoring of the five human experts (see Materials and methods). The <xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref> and <xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref> columns show the performance of two recent deep-learning-based sleep-staging algorithms (<xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref>; <xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref>). The H1–H5 columns show the performance of each individual human scorer against an unbiased consensus (see Materials and methods). Asterisks indicate significant differences with YASA. p-Values were adjusted for multiple comparisons row-wise using the Holm method. Accuracy is defined as the overall agreement between the predicted and ground-truth sleep stages. F1 is the F1-score, calculated separately for each sleep stage. F1-macro is the average of the F1-scores of all sleep stages.</p></caption><table frame="hsides" rules="groups"><thead><tr><th align="left" valign="bottom"/><th align="left" valign="bottom">YASA</th><th align="left" valign="bottom"><xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref></th><th align="left" valign="bottom"><xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref></th><th align="left" valign="bottom">H1</th><th align="left" valign="bottom">H2</th><th align="left" valign="bottom">H3</th><th align="left" valign="bottom">H4</th><th align="left" valign="bottom">H5</th></tr></thead><tbody><tr><td align="left" valign="bottom">Accuracy</td><td align="char" char="plusmn" valign="bottom">86.6 ± 6.2</td><td align="char" char="plusmn" valign="bottom">86.4 ± 5.5</td><td align="char" char="plusmn" valign="bottom">89.0 ± 4.8</td><td align="char" char="plusmn" valign="bottom">86.5 ± 7.9</td><td align="char" char="plusmn" valign="bottom">86.3 ± 5.9</td><td align="char" char="plusmn" valign="bottom">86.6 ± 5.9</td><td align="char" char="plusmn" valign="bottom">78.8 ± 9.2*</td><td align="char" char="plusmn" valign="bottom">86.3 ± 7.2</td></tr><tr><td align="left" valign="bottom">F1 N1</td><td align="char" char="plusmn" valign="bottom">52.0 ± 21.6</td><td align="char" char="plusmn" valign="bottom">50.0 ± 19.9</td><td align="char" char="plusmn" valign="bottom">61.8 ± 18.0*</td><td align="char" char="plusmn" valign="bottom">50.0 ± 12.2</td><td align="char" char="plusmn" valign="bottom">53.7 ± 18.1</td><td align="char" char="plusmn" valign="bottom">53.2 ± 19.8</td><td align="char" char="plusmn" valign="bottom">38.7 ± 22.1*</td><td align="char" char="plusmn" valign="bottom">51.7 ± 19.2</td></tr><tr><td align="left" valign="bottom">F1 N2</td><td align="char" char="plusmn" valign="bottom">88.5 ± 5.3</td><td align="char" char="plusmn" valign="bottom">89.5 ± 6.0</td><td align="char" char="plusmn" valign="bottom">89.1 ± 5.7</td><td align="char" char="plusmn" valign="bottom">89.1 ± 5.6</td><td align="char" char="plusmn" valign="bottom">88.4 ± 6.0</td><td align="char" char="plusmn" valign="bottom">88.1 ± 6.6</td><td align="char" char="plusmn" valign="bottom">83.3 ± 5.2*</td><td align="char" char="plusmn" valign="bottom">88.3 ± 6.2</td></tr><tr><td align="left" valign="bottom">F1 N3</td><td align="char" char="plusmn" valign="bottom">87.0 ± 9.7</td><td align="char" char="plusmn" valign="bottom">81.1 ± 22.5</td><td align="char" char="plusmn" valign="bottom">84.6 ± 14.6</td><td align="char" char="plusmn" valign="bottom">86.9 ± 17.2</td><td align="char" char="plusmn" valign="bottom">81.4 ± 18.2</td><td align="char" char="plusmn" valign="bottom">82.1 ± 20.6</td><td align="char" char="plusmn" valign="bottom">82.5 ± 20.3</td><td align="char" char="plusmn" valign="bottom">84.0 ± 11.7</td></tr><tr><td align="left" valign="bottom">F1 REM</td><td align="char" char="plusmn" valign="bottom">92.6 ± 9.7</td><td align="char" char="plusmn" valign="bottom">91.9 ± 5.6</td><td align="char" char="plusmn" valign="bottom">94.4 ± 5.1*</td><td align="char" char="plusmn" valign="bottom">88.0 ± 13.3</td><td align="char" char="plusmn" valign="bottom">90.6 ± 5.5</td><td align="char" char="plusmn" valign="bottom">92.7 ± 7.0*</td><td align="char" char="plusmn" valign="bottom">90.0 ± 9.2</td><td align="char" char="plusmn" valign="bottom">92.7 ± 8.1</td></tr><tr><td align="left" valign="bottom">F1 WAKE</td><td align="char" char="plusmn" valign="bottom">83.9 ± 10.3</td><td align="char" char="plusmn" valign="bottom">87.0 ± 12.2</td><td align="char" char="plusmn" valign="bottom">90.5 ± 9.5*</td><td align="char" char="plusmn" valign="bottom">83.7 ± 9.5</td><td align="char" char="plusmn" valign="bottom">87.4 ± 12.0</td><td align="char" char="plusmn" valign="bottom">85.7 ± 9.2</td><td align="char" char="plusmn" valign="bottom">78.1 ± 28.9</td><td align="char" char="plusmn" valign="bottom">84.4 ± 16.8</td></tr><tr><td align="left" valign="bottom">F1 macro</td><td align="char" char="plusmn" valign="bottom">78.5 ± 9.4</td><td align="char" char="plusmn" valign="bottom">79.0 ± 8.5</td><td align="char" char="plusmn" valign="bottom">82.7 ± 7.7*</td><td align="char" char="plusmn" valign="bottom">78.0 ± 9.0</td><td align="char" char="plusmn" valign="bottom">80.0 ± 9.1</td><td align="char" char="plusmn" valign="bottom">79.5 ± 7.6</td><td align="char" char="plusmn" valign="bottom">73.0 ± 9.0*</td><td align="char" char="plusmn" valign="bottom">79.5 ± 11.9</td></tr></tbody></table></table-wrap><table-wrap id="table3" position="float"><label>Table 3.</label><caption><title>Comparison of YASA against two existing algorithms and individual human scorers on the DOD-Obstructive dataset (patients with obstructive sleep apnea, n = 50).</title><p>Values represent median ± interquartile range across all n = 50 nights. The YASA column shows the performance of the current algorithm against the consensus scoring of the five human experts (see Materials and methods). The <xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref> and <xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref> columns show the performance of two recent deep-learning-based sleep-staging algorithms (<xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref>; <xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref>). The H1–H5 columns show the performance of each individual human scorer against an unbiased consensus (see Materials and methods). Asterisks indicate significant differences with YASA. p-Values were adjusted for multiple comparisons row-wise using the Holm method. Accuracy is defined as the overall agreement between the predicted and ground-truth sleep stages. F1 is the F1-score, calculated separately for each sleep stage. F1-macro is the average of the F1-scores of all sleep stages.</p></caption><table frame="hsides" rules="groups"><thead><tr><th align="left" valign="bottom"/><th align="left" valign="bottom">YASA</th><th align="left" valign="bottom"><xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref></th><th align="left" valign="bottom"><xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref></th><th align="left" valign="bottom">H1</th><th align="left" valign="bottom">H2</th><th align="left" valign="bottom">H3</th><th align="left" valign="bottom">H4</th><th align="left" valign="bottom">H5</th></tr></thead><tbody><tr><td align="left" valign="bottom">Accuracy</td><td align="char" char="plusmn" valign="bottom">84.30 ± 7.85</td><td align="char" char="plusmn" valign="bottom">84.97 ± 9.48</td><td align="char" char="plusmn" valign="bottom">86.69 ± 8.69*</td><td align="char" char="plusmn" valign="bottom">83.94 ± 12.72</td><td align="char" char="plusmn" valign="bottom">82.51 ± 9.49*</td><td align="char" char="plusmn" valign="bottom">80.38 ± 11.99</td><td align="char" char="plusmn" valign="bottom">82.18 ± 9.26</td><td align="char" char="plusmn" valign="bottom">84.50 ± 9.78</td></tr><tr><td align="left" valign="bottom">F1 N1</td><td align="char" char="plusmn" valign="bottom">39.17 ± 18.17</td><td align="char" char="plusmn" valign="bottom">41.48 ± 17.05</td><td align="char" char="plusmn" valign="bottom">50.17 ± 21.17*</td><td align="char" char="plusmn" valign="bottom">34.44 ± 19.93</td><td align="char" char="plusmn" valign="bottom">40.53 ± 29.96</td><td align="char" char="plusmn" valign="bottom">39.01 ± 19.78</td><td align="char" char="plusmn" valign="bottom">41.54 ± 21.04</td><td align="char" char="plusmn" valign="bottom">46.19 ± 20.07*</td></tr><tr><td align="left" valign="bottom">F1 N2</td><td align="char" char="plusmn" valign="bottom">87.10 ± 6.55</td><td align="char" char="plusmn" valign="bottom">88.36 ± 9.39</td><td align="char" char="plusmn" valign="bottom">87.26 ± 8.77</td><td align="char" char="plusmn" valign="bottom">86.80 ± 15.96*</td><td align="char" char="plusmn" valign="bottom">83.07 ± 7.19*</td><td align="char" char="plusmn" valign="bottom">83.39 ± 11.34</td><td align="char" char="plusmn" valign="bottom">84.63 ± 7.57</td><td align="char" char="plusmn" valign="bottom">87.29 ± 8.45</td></tr><tr><td align="left" valign="bottom">F1 N3</td><td align="char" char="plusmn" valign="bottom">77.88 ± 31.12</td><td align="char" char="plusmn" valign="bottom">57.16 ± 82.16*</td><td align="char" char="plusmn" valign="bottom">79.51 ± 31.28</td><td align="char" char="plusmn" valign="bottom">71.51 ± 56.26*</td><td align="char" char="plusmn" valign="bottom">65.53 ± 45.41*</td><td align="char" char="plusmn" valign="bottom">49.97 ± 63.95*</td><td align="char" char="plusmn" valign="bottom">62.69 ± 61.22*</td><td align="char" char="plusmn" valign="bottom">74.74 ± 41.19</td></tr><tr><td align="left" valign="bottom">F1 REM</td><td align="char" char="plusmn" valign="bottom">88.87 ± 10.79</td><td align="char" char="plusmn" valign="bottom">92.50 ± 7.81</td><td align="char" char="plusmn" valign="bottom">93.90 ± 5.40*</td><td align="char" char="plusmn" valign="bottom">89.86 ± 19.43</td><td align="char" char="plusmn" valign="bottom">92.48 ± 9.91</td><td align="char" char="plusmn" valign="bottom">91.26 ± 12.21</td><td align="char" char="plusmn" valign="bottom">89.26 ± 9.83</td><td align="char" char="plusmn" valign="bottom">91.77 ± 11.28</td></tr><tr><td align="left" valign="bottom">F1 WAKE</td><td align="char" char="plusmn" valign="bottom">86.90 ± 8.47</td><td align="char" char="plusmn" valign="bottom">87.95 ± 9.04</td><td align="char" char="plusmn" valign="bottom">91.04 ± 8.31*</td><td align="char" char="plusmn" valign="bottom">90.80 ± 10.00</td><td align="char" char="plusmn" valign="bottom">88.48 ± 12.60</td><td align="char" char="plusmn" valign="bottom">88.80 ± 11.62</td><td align="char" char="plusmn" valign="bottom">90.13 ± 8.90</td><td align="char" char="plusmn" valign="bottom">91.06 ± 9.59*</td></tr><tr><td align="left" valign="bottom">F1 macro</td><td align="char" char="plusmn" valign="bottom">73.96 ± 10.79</td><td align="char" char="plusmn" valign="bottom">70.11 ± 15.54</td><td align="char" char="plusmn" valign="bottom">78.70 ± 10.90*</td><td align="char" char="plusmn" valign="bottom">70.91 ± 19.29</td><td align="char" char="plusmn" valign="bottom">72.99 ± 15.65</td><td align="char" char="plusmn" valign="bottom">68.25 ± 16.22*</td><td align="char" char="plusmn" valign="bottom">70.43 ± 18.02</td><td align="char" char="plusmn" valign="bottom">76.20 ± 16.36</td></tr></tbody></table></table-wrap><p>In healthy adults, the median accuracy of YASA against the consensus scoring of the five experts was 86.6%. The median kappa across all nights was 80.1%, indicating excellent agreement. Median and interquartile range of F1-scores for each sleep stage across all nights are reported in <xref ref-type="table" rid="table2">Table 2</xref>. We then compared the performance of YASA against each of the five individual human scorers, as well as against two recently published sleep-staging algorithms (see Materials and methods, <xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref>; <xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref>). Pairwise t-tests adjusted for multiple comparisons using the Holm method revealed that the accuracy of YASA on this healthy validation dataset was not significantly different from the two other deep-learning-based sleep-staging algorithms or any of the individual scorers (except scorer 4, see below or <xref ref-type="table" rid="table2">Table 2</xref>). The F1-scores for each sleep stage were not significantly different between YASA, the <xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref> algorithm, and the human scorers 1, 2, 3, and 5. Scorer 4 had a significantly lower F1-score for N1 (p=0.034) and N2 (p&lt;0.001), resulting in a lower overall accuracy (p=0.001). The <xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref> algorithm had significantly higher F1-scores than YASA for N1, REM sleep and wakefulness (p=0.006, p&lt;0.001, and p=0.042, respectively). F1-scores for N2 and N3 were not statistically different between YASA and the <xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref> algorithm. Hypnograms of the consensus scoring and the three automated algorithms for each night of the DOD-Healthy dataset can be found in <xref ref-type="supplementary-material" rid="supp1">Supplementary file 1</xref>, with nights ranked in descending order of agreement between YASA and the consensus scoring. Confusion matrices for each scorer (human and algorithm) can be found in <xref ref-type="fig" rid="fig1s3">Figure 1—figure supplements 3</xref> and <xref ref-type="fig" rid="fig1s4">4</xref>.</p><p>The same analysis was performed in 55 patients with OSA (DOD-Obstructive). The median accuracy of YASA against the consensus scoring of the five experts was 84.3%, with a median kappa of 76.5%. Median and interquartile range of F1-scores for each sleep stage across all nights are reported in <xref ref-type="table" rid="table3">Table 3</xref>. Pairwise comparisons of accuracy showed that YASA was not significantly different from the <xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref> algorithm or human scorers 1, 3, 4, and 5. Human scorer 2 had a significantly lower accuracy (p=0.004), while the Perslev algorithm had a significantly higher accuracy (p=0.009). Pairwise comparisons of F1-scores showed that YASA outperformed the <xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref> algorithm and four out of five scorers for N3 sleep (all p’s&lt;0.01). However, the <xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref> algorithm had significantly higher scores than YASA for N1, REM and wakefulness (all p’s&lt;0.011). Hypnograms of the consensus scoring and the three automated algorithms, ranked in descending order of agreement between YASA and the consensus scoring, can be found in <xref ref-type="supplementary-material" rid="supp2">Supplementary file 2</xref>. Confusion matrices are reported in <xref ref-type="fig" rid="fig1s5">Figure 1—figure supplements 5</xref> and <xref ref-type="fig" rid="fig1s6">6</xref>.</p><p>Additional analyses on the combined dataset (n = 75 nights, healthy and patients combined) revealed that, first, the accuracy of YASA against the consensus scoring was significantly higher during stable epochs compared to transition epochs (mean ± STD: 91.2 ± 7.8 vs. 68.95 ± 7.7, p&lt;0.001), or in epochs that were marked as high confidence by the algorithm (93.9 ± 6.0 vs. 64.1 ± 7.0 for low-confidence epochs, p&lt;0.001). Second, epochs with unanimous consensus from the five human experts were four times more likely to occur during stable epochs than transition epochs (46.2% ± 12.1% of all epochs vs. 11.5% ± 4.9%, p&lt;0.001) and also four times more likely to occur during epochs marked as high confidence (≥80%) by the algorithm (46.4% ± 12.9% of all epochs vs. 11.3% ± 5.7%, p&lt;0.001). Third, there was a significant correlation between the percentage of epochs marked as high confidence by YASA and the percent of epochs with unanimous consensus (<italic>r</italic> = 0.561, p&lt;0.001), meaning that YASA was overall more confident in recordings with higher human interrater agreement.</p></sec></sec><sec id="s2-3"><title>Moderator analyses</title><p>Having tested the performance of the algorithm on both healthy adults and patients with sleep apnea, we turned our attention to the impact of different moderators on the sleep-staging accuracy. Subsequent analyses are based on the testing set 1 (NSRR), for which – unlike the testing set 2 (DOD) – extensive individual-level demographic and health data was available. As with human sleep scoring, analyses focused on the first factor of age revealed a small but significant negative correlation with accuracy (<italic>r</italic> = −0.128, p=0.002, <xref ref-type="fig" rid="fig2">Figure 2A</xref>), suggesting a moderate linear decrease of accuracy with age. Second, body composition was not significantly correlated with accuracy (<italic>r</italic> = −0.001, p=0.97, <xref ref-type="fig" rid="fig2">Figure 2B</xref>). Third, sex was not a significant determinant of accuracy either (Welch’s T = −1.635, p=0.103, <xref ref-type="fig" rid="fig2">Figure 2C</xref>). Fourth, sleep apnea, and specifically the AHI, was negatively correlated with accuracy (<italic>r</italic> = −0.29, p&lt;0.001, <xref ref-type="fig" rid="fig2">Figure 2E</xref>) as well as the overall confidence level of the algorithm (calculated by averaging the epoch-by-epoch confidence across the entire night, <italic>r</italic> = −0.339, p&lt;0.001). This would indicate that, to a modest degree, the performance and confidence of the algorithm can lessen in those with severe sleep apnea indices, possibly mediated by an increased number of stage transitions in patients with sleep apnea (see above stage transition findings). Consistent with the latter, the percentage of (human-defined) stage transitions was significantly correlated with the AHI (<italic>r</italic> = 0.427, p&lt;0.001). Finally, race was a significant predictor of accuracy (ANOVA, F(3, 581) = 3.281, p=0.021, <xref ref-type="fig" rid="fig2">Figure 2D</xref>). Pairwise post hoc tests adjusted for multiple comparisons with Tukey’s method revealed that accuracy was lower in Hispanic than in non-Hispanic White individuals (p=0.032). However, this effect may be driven by the imbalance in sample size between these two categories (n = 40 vs. n = 342, respectively). No other pairwise comparison between race categories was significant.</p><p>To better understand how these moderators influence accuracy variability, we analyzed the relative contribution of the moderators using a random forest analysis. Specifically, we included all the aforementioned demographics variables in the model, together with medical diagnosis of depression, diabetes, hypertension, and insomnia, and features extracted from the ground-truth sleep scoring such as the percentage of each sleep stage, the duration of the recording, and the percentage of stage transitions in the hypnograms. The outcome variable of the model was the accuracy score of YASA against ground-truth sleep staging, calculated separately for each night. All the nights in the testing set 1 were included, leading to a sample size of 585 unique nights. Results are presented in <xref ref-type="supplementary-material" rid="supp3">Supplementary file 3b</xref>. The percentage of N1 sleep and percentage of stage transitions – both markers of sleep fragmentation – were the two top predictors of accuracy, accounting for 40% of the total relative importance. By contrast, the combined contribution of age, sex, race, and medical diagnosis of insomnia, hypertension, diabetes, and depression accounted for roughly 10% of the total importance.</p></sec><sec id="s2-4"><title>Features importance</title><p>The 20 most important features of the model are shown in <xref ref-type="fig" rid="fig1s7">Figure 1—figure supplement 7</xref>. 11 out of these top 20 features are derived from the electroencephalogram (EEG) signal, 7 from the electrooculogram (EOG), and 1 from the electromyogram (EMG). This indicates that EEG is the most important signal for accurate sleep staging, followed by EOG and to a lesser extent EMG. Time elapsed from the beginning of the recording was also present in the top 20 features, a result consistent with the well-known asymmetry of sleep stages across the night (i.e., more N3 sleep in the first half of the night and more REM sleep in the second half). Consistent with these findings, the algorithm retained high levels of accuracy when using only a single-channel EEG (median accuracy across the 585 nights of the testing set 1 = 85.12%, median kappa = 0.782) or a combination of one EEG and one EOG (median accuracy = 86.92%, median kappa = 0.809). In other words, using only one EEG and one EOG led to an ~0.5% decrease in median accuracy compared to a full model including one EEG, one EOG, one EMG, as well as age and sex.</p><p>The single most important feature of the classifier was the absolute power of the EOG power spectrum, followed by the fractal dimension, absolute power, and beta power of the EEG signal. It is relevant that several of these top features are relatively uncommon, nonlinear features (i.e., fractal dimension and permutation entropy). These novel features may capture unique electrophysiological properties of each sleep stage that are missed by traditional linear and/or spectral features. Similarly, 9 out of the 20 most important features include some form of temporal smoothing/normalization (e.g., centered 7.5 min triangular-weighted rolling average). This highlights the importance of taking into account the neighboring epochs – both past and future – for accurate sleep staging (see also <xref ref-type="supplementary-material" rid="supp3">Supplementary file 3a</xref>).</p></sec><sec id="s2-5"><title>Software implementation</title><p>Implementation of the algorithm is completely open-source and freely available. Our sleep algorithm, colloquially termed YASA (<xref ref-type="bibr" rid="bib47">Vallet, 2018</xref>) (<ext-link ext-link-type="uri" xlink:href="https://github.com/raphaelvallat/yasa">https://github.com/raphaelvallat/yasa</ext-link>), is part of a broader sleep analysis package (or ‘library’), written in Python. In addition to the automatic sleep-staging module we describe here, YASA also includes several additional functions such as automatic detection of sleep spindles and slow-waves, automatic artifact rejection, calculation of sleep statistics from a hypnogram, spectral power estimation (e.g., <xref ref-type="fig" rid="fig3">Figure 3B</xref>), and phase-amplitude coupling. However, use of the basic sleep-staging module is not at all contingent on a desire to quantify any of these metrics. Simply that they are on offer as additional tools in the software suit, should the user wish.</p><fig-group><fig id="fig3" position="float"><label>Figure 3.</label><caption><title>Example of data and sleep stages prediction in one subject.</title><p>(<bold>A</bold>) Predicted and ground-truth ( = human-scored) hypnogram in a healthy young female (CFS dataset, 24 years old, Black, apnea-hypopnea index [AHI] &lt; 1). The agreement between the two scoring is 94.3%. (<bold>B</bold>) Corresponding full-night spectrogram of the central electroencephalogram (EEG) channel. Warmer colors indicate higher power in these frequencies. This type of plot can be used to easily identify the overall sleep architecture. For example, periods with high power in frequencies below 5 Hz most likely indicate deep non-rapid eye movement (NREM) sleep. (<bold>C</bold>) Algorithm’s predicted cumulative probabilities of each sleep stage at each 30 s epoch. The black line indicates the confidence level of the algorithm. Note that all the plots in this figure can be very easily plotted in the software.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-70092-fig3-v1.tif"/></fig><fig id="fig3s1" position="float" specific-use="child-fig"><label>Figure 3—figure supplement 1.</label><caption><title>Code snippet illustrating the simplest usage of the algorithm.</title><p>Here, automatic sleep staging is applied on an European Data Format (EDF) file, previously loaded using the MNE package. The sleep stages predictions are made using one electroencephalogram (EEG), one electrooculogram (EOG), and one electromyogram (EMG), as well as the age and sex of the participant. The full hypnogram is then exported into a CSV file, together with the epoch number.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-70092-fig3-figsupp1-v1.tif"/></fig><fig id="fig3s2" position="float" specific-use="child-fig"><label>Figure 3—figure supplement 2.</label><caption><title>Code snippet illustrating the usage of the algorithm on multiple European Data Format (EDF) files.</title><p>Automatic sleep staging is applied on a batch of EDF files that are present in the same folder. The sleep stages predictions are made using one electroencephalogram (EEG), one electrooculogram (EOG), and one electromyogram (EMG), which are assumed to be consistent across all the polysomnography recordings. The full predicted hypnogram of each recording is then exported into a CSV file with the same filename as the corresponding EDF file.</p></caption><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-70092-fig3-figsupp2-v1.tif"/></fig></fig-group><p>YASA comes with extensive documentation and is released under a BSD-3 Clause license, part of the Open Source Initiative, and can be directly installed with one simple line of code from the Python Package Index repository (in a terminal: pip install yasa). The source code of YASA is freely and publicly hosted on GitHub, and follows standard release cycles with a version-tracking of all the changes made to the code and/or pretrained classifiers. That is, users can choose to ignore the most recent versions and keep a specific version of the code and staging algorithm, which is useful, for example, in longitudinal studies where the preprocessing and analysis steps should stay consistent across time.</p><p>The general workflow to perform the automatic sleep staging is described below. In addition, we provide code snippets showing the simplest usage of the algorithm on a single European Data Format (EDF) file (<xref ref-type="fig" rid="fig3s1">Figure 3—figure supplement 1</xref>) or on a folder with multiple EDF files (<xref ref-type="fig" rid="fig3s2">Figure 3—figure supplement 2</xref>). First, the user loads the PSG data into Python. Assuming that the PSG data are stored in the gold-standard EDF, this can be done in one line of code using the MNE package (<xref ref-type="bibr" rid="bib16">Gramfort et al., 2014</xref>), which has a dedicated function to load EDF files (<ext-link ext-link-type="uri" xlink:href="https://mne.tools/stable/generated/mne.io.read_raw_edf.html">https://mne.tools/stable/generated/mne.io.read_raw_edf.html</ext-link>). Second, the automatic sleep staging is performed using the algorithm’s sleep-staging module (<ext-link ext-link-type="uri" xlink:href="https://raphaelvallat.com/yasa/build/html/generated/yasa.SleepStaging.html">https://raphaelvallat.com/yasa/build/html/generated/yasa.SleepStaging.html</ext-link>). The only requirement is that the user specify the name of the EEG channel they want to apply the detection (preferentially a central derivation such as C4-M1). The algorithm is now ready to stage the data. Should the user wish, there is the option of naming EOG and EMG channels (preferentially a chin EMG). The user can also include ancillary if desired, such as age and sex, which can aid in improving the accuracy of the algorithm, though this is not at all necessary for high accuracy (as described earlier).</p><p>Regarding the processing steps of the algorithm, sleep staging is performed with the `predict` function. This function automatically identifies and loads the pretrained classifier corresponding to the combination of sensors/metadata provided by the user. While pretrained classifiers are natively included in the algorithm, a user can define custom pretrained classifiers if they wish, which can be tailored to their specific use cases. Once again, however, this is just for flexibility of use and is not at all required for the algorithm to perform with high accuracy. Parenthetically, this flexibility can also be leveraged for a variety of use cases, for example, scoring rodent sleep data instead of human sleep data.</p><p>In addition to stage scoring, implementation of the `predict_proba` function provides the ability for a user to quantify the probability certainty of each stage at each epoch. This probability certainty can then be used to derive a confidence score, should that be desired, although again this is not necessary for standard sleep staging by a user (<xref ref-type="fig" rid="fig3">Figure 3C</xref>). Finally, the predicted hypnogram and stage probabilities can easily be exported into a text or CSV file using standard Python functions, should the user wish, though once again this is not required.</p><p>One limitation of automated data analysis methods is that they are computationally demanding (<xref ref-type="bibr" rid="bib14">Fiorillo et al., 2019</xref>), often requiring specific higher-end computer systems that are costly. To avoid this limitation, the current algorithm is designed to be fast and highly memory-effective by leveraging high-performance tools in Python (e.g., Numpy’s vectorization and Numba compiling). As a consequence, a full-night PSG recording sampled at 100 Hz is typically processed in less than 5 s on a rudimentary, basic consumer-level laptop.</p></sec></sec><sec id="s3" sec-type="discussion"><title>Discussion</title><p>We sought to develop a sleep-staging algorithm that (1) matches human-scorer accuracy, (2) has been trained on a large and heterogeneous data set, (3) is easy to implement by most individuals, (4) is computational low-demanding and can therefore be run on a basic laptop, and (5) is entirely free, and thus easily adopted by researchers, clinicians, and commercial ventures.</p><sec id="s3-1"><title>Performance</title><p>The algorithm displayed high levels of accuracy, matching those observed across human interrater agreement (<xref ref-type="bibr" rid="bib14">Fiorillo et al., 2019</xref>). First, the median agreement between the algorithm and human scoring across 585 testing nights from the NSRR database was 87.5% – and was superior to 90% when only considering epochs that occurred during a stable period of sleep, that is, not around a stage transition. Second, the performance of YASA was tested on a previously unseen dataset of 25 healthy adults and 50 patients with OSA. Each night of this dataset was scored by five registered experts. The median accuracy of the algorithm against the consensus of the five experts was 86.6% for healthy adults and 84.3% in patients. In both samples, the accuracy of YASA was not significantly different from any of the individual human scorers. Furthermore, comparison against two recent deep-learning algorithms (<xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref>; <xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref>) showed that the accuracy of YASA against consensus scoring was on par (i.e., not statistically different) with the two existing algorithms for healthy adults. However, YASA performed worse than the <xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref> algorithm in patients with OSA by 2.4% (as discussed in the ‘Limitations and future directions’ section).</p><p>Regarding individual sleep stages, the algorithm showed excellent classification performance for N2 sleep, N3 sleep, REM sleep and wakefulness, and moderate agreement for N1 sleep. These results are consistent with human interrater agreement, which has been found to be consistently lower in N1 sleep compared to the other sleep stages (<xref ref-type="bibr" rid="bib31">Malhotra et al., 2013</xref>; <xref ref-type="bibr" rid="bib34">Norman et al., 2000</xref>; <xref ref-type="bibr" rid="bib41">Rosenberg and Van Hout, 2013</xref>). Furthermore, the algorithm was successful in preserving the overall distribution of sleep stages across the night, such that it is neither over- or underestimating a specific sleep stage.</p><p>Beyond a basic sleep-stage classification, an advantage of the algorithm is its ability to provide probability (i.e., likelihood) value for each individual epoch of each stage (<xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref>). These probabilities inform the users about the confidence level of the algorithm. As such, the algorithm provides a unique feature addition for sleep scoring that extends beyond sleep-staging quantification and layers atop sleep-staging qualitative assessment. Proving the validity of this measure, the accuracy of the algorithm was statistically superior in epochs that were flagged as high-confidence, reaching ~95% agreement with human scoring. In addition, recordings with a higher average confidence had significantly higher accuracy. Among many other advantages, such an ability could be used in a semi-supervised scoring approach if desired, wherein a human scorer can focus expressly on the selection of low-confidence epochs and/or recordings for attention, thus limiting time investment.</p></sec><sec id="s3-2"><title>Generalizability</title><p>The power and utility of an algorithm is not just determined by its accuracy, but also by the characteristics of the underlying dataset that was used for training and validation (<xref ref-type="bibr" rid="bib14">Fiorillo et al., 2019</xref>). For example, an algorithm showing excellent performance but that was trained on a very small and homogeneous sample size (e.g., 10–20 healthy young adults from the same demographic group and recorded using the same device) will typically have low utility for other use cases, such as scoring data from another PSG device, or data from patients with sleep disorders. The generalizability of such algorithms can therefore be compromised, with the high performance most likely indicating overfitting to the small training dataset.</p><p>Seeking to avoid this issue, our algorithm was trained and evaluated on more than 30,000 hr of PSG human sleep recordings across almost 4000 nights, from numerous independent and heterogeneous datasets. These datasets included participants from a wide age range, different geographical locations, racial groups, sex, body composition, health status, and sleep disorders. Importantly, these independent studies involved different recording devices and settings (e.g., montage, sampling rate). Such a high heterogeneity is paramount to ensure a high reliability and generalizability of the algorithm.</p><p>Moderator analyses showed that the performance of the algorithm was unaffected by sex and body composition. Consistent with human scoring (<xref ref-type="bibr" rid="bib33">Muehlroth and Werkle-Bergner, 2020</xref>; <xref ref-type="bibr" rid="bib34">Norman et al., 2000</xref>), the performance of the algorithm was sensitive to advancing age and increasing severity of sleep apnea, although accuracy remained high in patients with sleep apnea (~84% in the DOD-Obstructive validation dataset). The latter two circumstances can be explained by the increase in the number of stage transitions and the increase in the proportion of N1 sleep typically seen in aging and sleep apnea (<xref ref-type="bibr" rid="bib34">Norman et al., 2000</xref>; <xref ref-type="bibr" rid="bib35">Ohayon et al., 2004</xref>). Indeed, the majority of such scoring errors were located around stage transitions and/or in N1 sleep, which is consistent with findings of human interrater error of these same circumstances (<xref ref-type="bibr" rid="bib34">Norman et al., 2000</xref>).</p><p>Another problematic challenge in the field of automated sleep staging is the fact that each algorithm is usually tested on a different (often nonpublicly available) dataset, which renders the comparison of algorithms nearly impossible. Adding to this, prior approaches are also heterogeneous in the performance evaluation metrics used to validate the algorithm, as well as in the PSG channel(s) on which the algorithm is applied – with some algorithms using only a single EEG channel and others a multichannel approach (<xref ref-type="bibr" rid="bib14">Fiorillo et al., 2019</xref>). Addressing these issues, the current algorithm was trained and tested on publicly available datasets, using standard classification metrics (e.g., accuracy, F1-scores, confusion matrix) and following recent guidelines for performance evaluation (<xref ref-type="bibr" rid="bib32">Menghini et al., 2021</xref>). Furthermore, the built-in flexibility of the algorithm allows for different combinations of channels to be used, should a user wish. For all these reasons, we hope that the algorithm is not only of broad utility, but will facilitate replication of our work and comparison to existing and future works.</p></sec><sec id="s3-3"><title>Ease-of-use and computationally low demand</title><p>To facilitate wide adoption by the sleep community, it is of utmost importance that any algorithm can be used and understood by all parties concerned (e.g., students, researchers, clinicians, technicians), no matter the level of technical expertise. To ensure this, the software has been built with a particular focus on ease-of-use, documentation, and transparency.</p><p>First, the end-to-end sleep-staging pipeline can be written in less than 10 lines of Python code, and the software comes with pretrained classifiers that are automatically selected based on the combination of channels used, thus limiting the risk of any error. Second, the software has extensive documentation and includes numerous example datasets, allowing any users to get familiarized with the algorithm before applying it to their own datasets, if they wish (though it is not necessary). Third, the algorithm uses a traditional features-based approach to classify sleep stages instead of a black-box algorithm. These features are described in detail in the documentation and source code of the algorithm, and can be explained to any researchers or clinicians in lay terms. Finally, the sleep staging is done locally on the user’s computer, and the data is never uploaded to the cloud or any external servers, thus limiting security and privacy risks (<xref ref-type="bibr" rid="bib14">Fiorillo et al., 2019</xref>), and the need for any connectivity when using the software.</p></sec><sec id="s3-4"><title>Free, open source, and community-driven</title><p>Another potential reason that automated sleep staging has yet to become a de facto standard is that some algorithms are sitting behind a paywall (e.g., <xref ref-type="bibr" rid="bib31">Malhotra et al., 2013</xref>; <xref ref-type="bibr" rid="bib36">Patanaik et al., 2018</xref>). By contrast, the current algorithm is free and released under a nonrestrictive BSD-3 open-source license. The software, which also includes other sleep analysis tools (e.g., sleep spindle detection, spectral estimation, automatic artifact rejection, phase-amplitude coupling), is hosted on GitHub and has already been downloaded several thousand times at the date of writing (<ext-link ext-link-type="uri" xlink:href="https://static.pepy.tech/badge/yasa">https://static.pepy.tech/badge/yasa</ext-link>). The software can therefore be used by for- or non-profit outlets for free, without constraint.</p></sec><sec id="s3-5"><title>Limitations and future directions</title><p>Despite its numerous advantages, there are limitations to the algorithm that must be considered. These are discussed below, together with ideas for future improvements of the algorithm. First, while the accuracy of YASA against consensus scoring was not significantly different from the <xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref> and <xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref> algorithms on healthy adults, it was significantly lower than the latter algorithm on patients with OSA. The <xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref> algorithm used all available EEGs and two (bilateral) EOGs, whereas YASA’s scoring was based on one central EEG, one EOG, and one EMG. This suggests that one way to improve performance on this population could be the inclusion of more EEG channels and/or bilateral EOGs. For instance, using the negative product of bilateral EOGs may increase sensitivity to rapid eye movements in REM sleep or slow eye movements in N1 sleep (<xref ref-type="bibr" rid="bib1">Agarwal et al., 2005</xref>; <xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref>). Interestingly, the <xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref> algorithm does not use an EMG channel, which is consistent with our observation of a negligible benefit on accuracy when adding EMG to the model. This may also indicate that while the current set of features implemented in the algorithm performs well for EEG and EOG channels, it does not fully capture the meaningful dynamic information nested within muscle activity during sleep.</p><p>Second, an obstacle to the wide adoption of the current algorithm is the absence of a graphical user interface (GUI). Designing and maintaining an open-source cross-platform GUI is in itself a herculean task that requires dedicated funding and software engineers. Rather, significant efforts have been made to facilitate the integration of YASA’s outputs to existing sleep GUIs. Specifically, the documentation of the algorithm includes examples on how to load and edit the sleep scores in several free GUIs, such as EDFBrowser, Visbrain, and SleepTrip.</p><p>Third, the algorithm was exclusively tested and evaluated on full-night PSG recordings. As such, its performance on shorter recordings, such as daytime naps, is unknown. Further testing of the algorithm is therefore required to validate the algorithm on naps. While YASA can process input data of arbitrary length, performance may be reduced on data that are shorter than the longest smoothing windows used by the algorithm (i.e., shorter than 7.5 min).</p><p>Fourth, unlike other deep-learning-based algorithms (e.g., <xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref>; <xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref>), the algorithm does not currently have the ability to score in shorter resolution. We think however that this is not a significant limitation of our work. First, without exception, all of the datasets used either in the training or testing the current algorithm were visually scored by experts using a 30 s resolution. Therefore, even if our algorithm was able to generate sleep scores in a shorter resolution, comparison against the ground-truth would require downsampling the predictions to a 30 s resolution and thus losing the benefit of the shorter resolution. A proper implementation of a shorter resolution scoring requires to train and validate the model on ground-truth sleep scores of the same temporal resolution. Second, the use of 30 s epochs remains the gold standard (as defined in the most recent version of the AASM manual), and as such, the vast majority of sleep centers across the world still rely on 30 s staging. Provided that datasets with sleep scoring at shorter resolution (e.g., 5, 10, 15 s) becomes common, the current algorithm could be modified and retrained to yield such higher-resolution predictions. In that case, the minimum viable resolution would be 5 s, which is the length of the Fast Fourier Transform used to calculate the spectral powers. That said, we firmly believe that a more temporally fine-grained sleep staging will be of benefit to the sleep community in the future. Indeed, such ‘high-frequency’ staging may improve classification accuracy in error-prone ambiguous epochs (e.g., transition epochs with multiple stages), and has further been shown to better discriminate between healthy and sleep-disordered patients than traditional 30 s-based staging (<xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref>).</p><p>Fifth, the algorithm is not currently able to identify markers of common sleep disorders (such as sleep apnea, leg movements), and as such may not be suited for clinical purposes. It should be noted however that our software does include several other functions to quantify phasic events during sleep (slow-waves, spindles, REMs, artifacts), as well as sleep fragmentation of the hypnogram. Rather than replacing the crucial expertise of clinicians, YASA may thus provide a helpful starting point to accelerate clinical scoring of PSG recordings. Furthermore, future developments of the software should prioritize automated scoring of clinical disorders, particularly apnea-hypopnea events. On the latter, YASA could implement some of the algorithms that have been developed over the last few years to detect apnea-hypopnea events from the ECG or respiratory channels (e.g., <xref ref-type="bibr" rid="bib25">Koley and Dey, 2013</xref>; <xref ref-type="bibr" rid="bib48">Varon et al., 2015</xref>).</p><p>A final limitation is that the algorithm is tailored to human scalp data. As such, individuals who may want to use YASA to score intracranial human data, animal data, or even human data from a very specific population will need to adjust the algorithm for their own needs. There are two levels at which the algorithm can be modified. First, an individual may want to retrain the classifier on a specific population without modifying the underlying features. Such flexibility is natively supported by the algorithm and no modifications to the original source code of YASA will be required. However, in some cases, the features may need to be modified as well to capture different aspects and dynamics of the input data (e.g., rodents or human intracranial data). In that case, the users will need to make modifications to the source code of the algorithm, and thus have some knowledge of Python and Git – both of which are now extensively taught in high schools and universities (<ext-link ext-link-type="uri" xlink:href="https://wiki.python.org/moin/SchoolsUsingPython">https://wiki.python.org/moin/SchoolsUsingPython</ext-link>, <ext-link ext-link-type="uri" xlink:href="https://education.github.com/schools">https://education.github.com/schools</ext-link>). Of note, the entire feature extraction pipeline takes about 100 lines of code and is based on standard scientific Python libraries such as NumPy, SciPy, and Pandas.</p></sec><sec id="s3-6"><title>Advantages of YASA against existing tools</title><p>Although recent advances in artificial intelligence have made it possible to automate tedious tasks in numerous fields of medicine, the sleep research field still relies on human visual scoring, which is time-consuming and can be prone to subjective bias. It is our opinion that one roadblock that has prevented the wide adoption of automatic sleep staging is the sheer number of algorithms that are published each year, most of which are virtually incomparable to others because they use different testing datasets and/or different evaluation strategies. Here, in an effort of transparency, we have benchmarked our algorithm against two of the most significant algorithms that have been published in recent years (<xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref>; <xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref>), using exactly the same publicly available dataset. As expected, all three algorithms had high levels of accuracy against consensus scoring, that is, on par with typical human interrater agreement. In addition with its high accuracy, there are unique advantages of YASA that should be considered by potential users, which we describe below.</p><p>First, and unlike the vast majority of existing algorithms, YASA was not designed for the sole purpose of staging sleep, but rather as an extensive toolbox encompassing the large majority of all analyses used by sleep researchers and clinicians. This includes, among others, (1) the calculation of sleep statistics from the hypnogram, (2) the automatic detection of phasic events during sleep (such as spindles, slow-waves, REMs, and body movements), (3) spectral analysis, as well as (4) more complex and novel analysis methods that we and others have developed, including event-locked cross-frequency coupling (<xref ref-type="bibr" rid="bib19">Helfrich et al., 2018</xref>; <xref ref-type="bibr" rid="bib44">Staresina et al., 2015</xref>) and decomposition of the sleep power spectrum into aperiodic and oscillatory components (<xref ref-type="bibr" rid="bib29">Lendner et al., 2020</xref>; <xref ref-type="bibr" rid="bib51">Wen and Liu, 2016</xref>). As such, our software provides an open-source end-to-end framework for the analysis of PSG sleep data, with sleep staging being a (optional) first step in the analysis pipeline.</p><p>A second advantage of YASA compared to existing algorithms is processing speed. Indeed, YASA is orders of magnitude faster than the <xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref> algorithm (~10–20 s vs. 10–20 min, including data loading). Noteworthy, while the <xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref> algorithm is computationally fast, uploading the EDF file to the web server can be slow – in addition to being not adequate for sensitive clinical data. While these differences in processing times may not be problematic for small studies, they can scale dramatically when working with hundreds of recordings.</p><p>Third, there are only a limited number of people who have the technical skills and/or required hardware to modify and retrain complex deep-learning neural network architectures, such as the ones implemented in the <xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref> and <xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref> algorithms. In other words, making changes to these algorithms or adapting them to specific needs is practically unfeasible for the average or even advanced user. By contrast, the core YASA algorithm can be easily modified by someone with such rudimentary knowledge of Python, and the full model can be trained on any basic laptop in no more than a couple of hours. Anecdotally, there are a number of ongoing efforts by other research teams to adapt the algorithm to various needs, such as animal data or human intracranial data. It is therefore our hope that such a simple and easily modifiable architecture may foster collaborative development.</p></sec><sec id="s3-7"><title>Conclusion</title><p>The interest in quantifying and tracking of human sleep has increased exponentially in the past decade (<xref ref-type="bibr" rid="bib15">Fleming et al., 2015</xref>; <xref ref-type="bibr" rid="bib42">Shelgikar et al., 2016</xref>), and demand for a highly automated, accurate, high-speed, and easy-to-implement algorithm for the scoring of human sleep has scaled similarly. Here, we offer an algorithm that seeks to accomplish this need. It is our hope that this free tool has the potential for broad adoption across all outlets (research, clinical, commercial) and use cases. With further validation and feedback from the sleep community, we hope it can become an industry standard method, one that can be built upon, expanded, and refined through cross-collaborative open-source community development.</p></sec></sec><sec id="s4" sec-type="materials|methods"><title>Materials and methods</title><sec id="s4-1"><title>Datasets</title><p>The algorithm was trained on a collection of large-scale independent datasets from the NSRR ( <ext-link ext-link-type="uri" xlink:href="https://sleepdata.org/">https://sleepdata.org/</ext-link>; <xref ref-type="bibr" rid="bib12">Dean et al., 2016</xref>; <xref ref-type="bibr" rid="bib53">Zhang et al., 2018</xref>) – a web portal funded by the National Heart, Lung and Blood Institute (NHLBI). This database offers access to large collections of deidentified physiological signals and clinical data collected in research cohorts and clinical trials. All data were collected as part of research protocols that were approved by the local institutional review board at each institution, with written and informed consent obtained from each individual before participation. All PSG recordings were scored by trained technicians using standard AASM guidelines (<xref ref-type="bibr" rid="bib22">Iber et al., 2007</xref>; <xref ref-type="bibr" rid="bib43">Silber et al., 2007</xref>). A full description of the datasets can be found on <ext-link ext-link-type="uri" xlink:href="https://sleepdataorg/">https://sleepdataorg/</ext-link>. The following datasets were used.</p></sec><sec id="s4-2"><title>MESA</title><p>The MESA is a multicenter longitudinal investigation of factors associated with the development of subclinical cardiovascular disease and the progression of subclinical to clinical cardiovascular disease in 6814 Black, White, Hispanic, and Chinese-American men and women initially aged 45–84 at baseline in 2000–2002. Full overnight PSG recordings were collected during the last follow-up visit in 2010–2012 and included 2237 participants (age range = 54–95 years). In-home PSG was conducted using the Compumedics Somte System (Compumedics Ltd., Abbotsford, Australia). The recording montage consisted of three cortical EEG (central C4-M1, occipital Oz-Cz, and frontal Fz-Cz leads), bilateral EOG, chin EMG, as well as several other sensors to measure heart rate, respiration, and leg movements. PSG data were sampled at 256 Hz, and a hardware low-pass filter with a cutoff frequency at 100 Hz was applied during recording.</p></sec><sec id="s4-3"><title>CFS</title><p>The CFS is a family-based study of sleep apnea, consisting of 2284 individuals (46% African-American) from 361 families studied on up to four occasions over a period of 16 years. We used the full overnight PSG recordings from the last exam (visit 5, n = 735, age range = 6–88 years). In-lab PSG was performed using the Compumedics E-Series System. The recording montage included two cortical EEG (C3-Fpz, C4-Fpz), bilateral EOG, and chin EMG. EEG and EOG channels were sampled at 128 Hz, and EMG was sampled at 256 Hz. A hardware bandpass filter with cutoff frequencies at 0.016 Hz and 105 Hz was applied during recording.</p></sec><sec id="s4-4"><title>CCSHS</title><p>The CCSHS is a population-based pediatric study with objective sleep evaluation, characterized by a large minority representation. We used the most recent visit, which took place between 2006 and 2010 and included in-lab PSG (n = 517, age range = 16–19 years). The PSG recording (Compumedics E-series, Compumedics) included two cortical EEG (C3-Fpz and C4-Fpz), bilateral EOG, and chin EMG. All channels were sampled at 128 Hz, and a hardware high-pass filter with cutoff frequency at 0.15 Hz was applied during recording.</p></sec><sec id="s4-5"><title>SHHS</title><p>The SHHS is a multicenter cohort study to determine the cardiovascular and other consequences of sleep-disordered breathing. We only included the first visit, which took place between 1995 and 1998 and included full, in-lab PSG from 5,804 participants (age range = 40–89 years). The PSG recording (Compumedics P-Series, Compumedics) included two cortical EEG (C3-M2 and C4-M1), bilateral EOG, and chin EMG. All channels were sampled at 125 Hz, and a hardware high-pass filter with cutoff frequency at 0.15 Hz was applied during recording.</p></sec><sec id="s4-6"><title>MrOS</title><p>The MrOS is a multicenter observational study of 5994 men, of which the sleep study is a follow-up ancillary study. Overnight PSG recordings were collected for 2907 participants (age range = 65–89 years), which represents about half of the participants included in the parent study. The PSG recordings (Compumedics P-Series, Compumedics) included two cortical EEG (C3-Fpz and C4-Fpz), bilateral EOG, and chin EMG. All channels were sampled at 256 Hz, and a hardware high-pass filter with cutoff frequency at 0.15 Hz was applied during recording.</p></sec><sec id="s4-7"><title>CHAT</title><p>The CHAT is a multicenter, single-blind, randomized-controlled trial designed to test whether after a 7-month observation period children, ages 5–9.9 years, with mild to moderate OSA randomized to early adenotonsillectomy will show greater levels of neurocognitive functioning. Overnight PSG recordings were collected between 2007 and 2012 and included 1447 participants (age range = 5–9.9 years), of which 464 were randomized to treatment. The PSG recording consisted of eight cortical EEG (including C3-Fpz and C4-Fpz), bilateral EOG, and chin EMG. All channels were sampled at 200 Hz.</p></sec><sec id="s4-8"><title>HomePAP</title><p>The HomePAP is a multisite, randomized-controlled trial that enrolled 373 patients (age range = 20–80 years), with a high pretest probability of moderate to severe OSA. We used the in-lab PSG recording, which included six cortical EEG (including C3-Fpz and C4-Fpz), bilateral EOG, and chin EMG. All channels were sampled at 200 Hz.</p><p>Each dataset was randomly split into training (up to 600 nights) and testing (up to 100 nights) sets. PSG nights included in the training set were used for model building and training, while PSG nights included in the testing set were used for performance evaluation. Importantly, the training and testing sets were completely separate (i.e., no overlap). The code used to generate the training and testing sets can be found <ext-link ext-link-type="uri" xlink:href="https://github.com/raphaelvallat/yasa_classifier/blob/master/00_randomize_train_test.ipynb">here</ext-link>. Demographics and health data such as the age, sex, race/ethnicity, BMI, AHI (3% desaturation), as well as medical diagnosis of insomnia, depression, diabetes, and hypertension were also provided for each dataset.</p><p>To provide an unbiased evaluation of the model on a completely new dataset, we further tested the performance of the algorithm on the DOD (<xref ref-type="bibr" rid="bib17">Guillot et al., 2020</xref>), a publicly available dataset including healthy individuals (DOD-Healthy) and patients with OSA (DOD-Obstructive).</p></sec><sec id="s4-9"><title>DOD-Healthy</title><p>The <italic>DOD</italic>-<italic>Healthy</italic> consists of 25 healthy volunteers that were enrolled at the French Armed Forces Biomedical Research Institute’s Fatigue and Vigilance Unit in France. Participants were without sleep complaints, aged 18–65, and recruited without regard to gender or ethnicity. PSG recordings were conducted with a Siesta PSG device (Compumedics) and included 12 EEG derivations (C3/M2, F4/M1, F3/F4, F3/M2, F4/O2, F3/O1,FP1/F3, FP1/M2, FP1/O1, FP2/F4, FP2/M1, FP2/O2), 1 EMG and bilateral EOGs, all sampled at 250 Hz.</p></sec><sec id="s4-10"><title>DOD-Obstructive</title><p>The <italic>DOD-Obstructive</italic> includes 55 patients with clinical suspicion for sleep-related breathing disorder. PSG was conducted at the Stanford Sleep Medicine Center in the US (clinical trial NCT03657329). Individuals clinically diagnosed with sleep disorders other than OSA, suffering from morbid obesity, taking sleep medications, or with certain cardiopulmonary or neurological comorbidities were excluded from the study. PSG recordings were conducted with a Siesta PSG device (Compumedics) and included eight EEG derivations (C3/M2, C4/M1, F3/F4, F3/M2, F4/O2, F3/O1, O1/M2,O2/M1), one EMG and bilateral EOGs, all sampled at 250 Hz.</p><p>Individual-level demographics and medical history were not provided for the DOD datasets; group averages for age, BMI, and AHI are reported from <xref ref-type="bibr" rid="bib17">Guillot et al., 2020</xref>. Importantly, no nights from the DOD were used for model training. Each night of the DOD was scored by five clinical experts, thus allowing to compare the performance of the algorithm against a consensus of human scorers (see ‘Consensus scoring’ section).</p></sec><sec id="s4-11"><title>Preprocessing and features extraction</title><p>For each PSG night, we extracted a single central EEG, left EOG, and chin EMG. We chose a central EEG (e.g., C4-M1 or C4-Fpz depending on the dataset) since the American Academy of Sleep Medicine (AASM) recommends that a central EEG should be included in all PSG recordings, and it is therefore more likely to be present in a variety of PSG recordings. These signals were then downsampled to 100 Hz to speed up computation time, and bandpass-filtered between 0.40 Hz and 30 Hz. No artifact removal was applied to the PSG data before running the sleep-staging algorithm.</p><p>The classification algorithm is based on a machine-learning approach in which a set of ‘features’ is extracted from the EEG signal, and optionally though non-necessarily, from the EOG and EMG signals as well. Consistent with human sleep staging, features are calculated for each 30 s epoch of raw data. An overview of the features implemented in the algorithm is provided below, focusing on the EEG features (although the EOG and EMG features are virtually identical). All codes used to compute these features are made open-source and freely available to all (see ’Data and code availability’ section). The complete list of features included in the final model can be found in <xref ref-type="supplementary-material" rid="supp4">Supplementary file 4</xref>.</p><p>These features were selected based on prior work in features-based classification algorithms for automatic sleep staging (<xref ref-type="bibr" rid="bib26">Krakovská and Mezeiová, 2011</xref>; <xref ref-type="bibr" rid="bib27">Lajnef et al., 2015</xref>; <xref ref-type="bibr" rid="bib46">Sun et al., 2017</xref>). For example, it was previously reported that the permutation entropy of the EOG/EMG and the EEG spectral powers in the traditional frequency bands are the most important features for accurate sleep staging (<xref ref-type="bibr" rid="bib27">Lajnef et al., 2015</xref>), thus warranting their inclusion in the current algorithm. Several other features are derived from the authors’ previous works with entropy/fractal dimension metrics (<xref ref-type="bibr" rid="bib47">Vallet, 2018</xref>) (<ext-link ext-link-type="uri" xlink:href="https://github.com/raphaelvallat/antropy">https://github.com/raphaelvallat/antropy</ext-link>). Importantly, the features included in the current algorithm were chosen to be robust to different recording montages. As such, we did not include features that are dependent on the phase of the signal and/or that require specific events detection (e.g., slow-waves, REMs). However, the time-domain features (see below) are dependent upon the amplitude of the signal, and the algorithm may fail if the input data is not expressed in standard units (µV) or has been z-scored prior to applying the automatic sleep staging.</p></sec><sec id="s4-12"><title>Time-domain features</title><p>The implemented time-domain features comprise standard descriptive statistics, that is, the standard deviation, interquartile range, skewness, and kurtosis of the signal. In addition, several nonlinear features are calculated, including the number of zero-crossings, the Hjorth parameters of mobility and complexity (<xref ref-type="bibr" rid="bib21">Hjorth, 1970</xref>), the permutation entropy (<xref ref-type="bibr" rid="bib2">Bandt and Pompe, 2002</xref>; <xref ref-type="bibr" rid="bib27">Lajnef et al., 2015</xref>), and the fractal dimension (<xref ref-type="bibr" rid="bib13">Esteller et al., 2001</xref>; <xref ref-type="bibr" rid="bib20">Higuchi, 1988</xref>; <xref ref-type="bibr" rid="bib39">Petrosian, 1995</xref>) of the signal.</p></sec><sec id="s4-13"><title>Frequency-domain features</title><p>Frequency-domains features were calculated from the periodogram of the signal, calculated for each 30 s epoch using Welch’s method (<xref ref-type="bibr" rid="bib50">Welch, 1967</xref>) (Hamming window of 5 s with a 50% overlap [ = 0.20 Hz resolution], median-averaging to limit the influence of artifacts). Features included the relative spectral power in specific bands (slow = 0.4–1 Hz, delta = 1–4 Hz, theta = 4–8 Hz, alpha = 8–12 Hz, sigma = 12–16 Hz, beta = 16–30 Hz), the absolute power of the broadband signal, as well as power ratios (delta/theta, delta/sigma, delta/beta, alpha/theta).</p></sec><sec id="s4-14"><title>Smoothing and normalization</title><p>When scoring sleep, human experts frequently rely on contextual information, such as prior and future epochs around the current epoch being scored (i.e., what was the predominant sleep stage in the last few minutes, what stage is the next epoch). By contrast, feature-based algorithms commonly process one epoch at a time, independently of the past and future epochs, overlooking such contextual temporal information. To overcome this limitation, the current algorithm implemented a smoothing approach across all the aforementioned features. In particular, the features were first duplicated and then smoothed using two different rolling windows: (1) a 7.5 min centered, triangular-weighted rolling average (i.e., 15 epochs centered around the current epoch with the following weights: [0.125, 0.25, 0.375, 0.5, 0.625, 0.75, 0.875, 1., 0.875, 0.75, 0.625, 0.5, 0.375, 0.25, 0.125]), and (2) a rolling average of the last 2 min prior to the current epoch. The optimal time length of these two rolling windows was found using a cross-validation approach (<xref ref-type="supplementary-material" rid="supp3">Supplementary file 3a</xref>).</p><p>Critically, there is marked natural interindividual variability in EEG brainwave activity (<xref ref-type="bibr" rid="bib6">Buckelmüller et al., 2006</xref>; <xref ref-type="bibr" rid="bib11">De Gennaro et al., 2008</xref>), meaning that each individual has a unique EEG fingerprint. To take this into account, all the smoothed features were then z-scored across each night, that is, expressed as a deviation from the night’s average. The inclusion of such normalized features aids in accommodating the error-potential impact of interindividual variability upon the algorithm, and thus improves final accuracy. The final model includes the 30 s-based features in original units (no smoothing or scaling), as well as the smoothed and normalized version of these raw features. The raw features were included to increase the temporal specificity and keep absolute values that can be compared across individuals regardless of interindividual variability.</p><p>Finally, the features set includes time elapsed from the beginning of the night, normalized from 0 to 1. This importantly accounts for the known asymmetry of sleep stages across the night, that is, the predominance of deep NREM sleep in the first half of the night, and conversely, a preponderance of REM and lighter NREM sleep in the second half of the night.</p><p>If desired, the user can also add information about the participant’s characteristics, such as the age and sex that are known to influence sleep stages (see ‘Results’; <xref ref-type="bibr" rid="bib9">Carrier et al., 2001</xref>; <xref ref-type="bibr" rid="bib35">Ohayon et al., 2004</xref>), which the classifier then takes into account during the staging process.</p></sec><sec id="s4-15"><title>Machine-learning classification</title><p>The full training dataset was then fitted with a LightGBM classifier (<xref ref-type="bibr" rid="bib24">Ke et al., 2017</xref>) – a tree-based gradient-boosting classifier using the following hyper-parameters: 500 estimators, maximum tree depth of 5, maximum number of leaves per tree of 90, and a fraction of 60% of all features selected at random when building each tree. These parameters were chosen to prevent overfitting of the classifier while still maximizing accuracy. Specifically, we performed an automated search of the best hyper-parameters using a threefold cross-validation on the entire training set. A total of 96 possible combinations of hyper-parameters were tested on the following hyper-parameters: number of estimators, number of leaves, maximum tree depth and feature fraction (which are the most important parameters for controlling overfitting, see the documentation of LightGBM). Importantly, the loss function was defined as<disp-formula id="equ1"><mml:math id="m1"><mml:mrow><mml:mrow><mml:mo>|</mml:mo><mml:mrow><mml:mi>a</mml:mi><mml:mi>c</mml:mi><mml:msub><mml:mi>c</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mi>r</mml:mi><mml:mi>a</mml:mi><mml:mi>i</mml:mi><mml:mi>n</mml:mi></mml:mrow></mml:msub><mml:mo>−</mml:mo><mml:mi>a</mml:mi><mml:mi>c</mml:mi><mml:msub><mml:mi>c</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mi>e</mml:mi><mml:mi>s</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>|</mml:mo></mml:mrow><mml:mo>+</mml:mo><mml:mn>4</mml:mn><mml:mo>∗</mml:mo><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:mi>a</mml:mi><mml:mi>c</mml:mi><mml:msub><mml:mi>c</mml:mi><mml:mrow><mml:mi>t</mml:mi><mml:mi>e</mml:mi><mml:mi>s</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:math></disp-formula></p><p>where <inline-formula><mml:math id="inf1"><mml:msub><mml:mrow><mml:mi>a</mml:mi><mml:mi>c</mml:mi><mml:mi>c</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi><mml:mi>e</mml:mi><mml:mi>s</mml:mi><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and <inline-formula><mml:math id="inf2"><mml:msub><mml:mrow><mml:mi>a</mml:mi><mml:mi>c</mml:mi><mml:mi>c</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi><mml:mi>r</mml:mi><mml:mi>a</mml:mi><mml:mi>i</mml:mi><mml:mi>n</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> are the average cross-validated test/train accuracy, respectively. In other words, the best set of hyper-parameters must maximize the cross-validated accuracy but also minimize the difference in accuracy between the train and test set. To retain optimal performance, the latter was, however, down-weighted by a factor of 4 relative to the former.</p><p>In addition, custom sleep-stage weights were passed to the classifier to limit the imbalance in the proportion of sleep stages across the night. Without such weighting, a classifier would favor the most represented sleep stage (N2, ~50% of a typical night), and conversely, would seldom choose the least-represented sleep stage (N1, ~5%). The best weights were found by running a cross-validated parameter search on the full training set, with the average of the accuracy and F1-scores as the optimization metric. A total of 324 possible combinations of class weights were tested. The parameter space was defined as the Cartesian product of N1: [1.6, 1.8, 2, 2.2], N2: [0.8, 0.9, 1], N3/REM/Wake: [1, 1.2, 1.4]. The best weights were 2.2 for N1, 1 for N2 and Wake, and 1.2 for N3 and 1.4 for REM. Python code for the grid search of the best class weights can be found <ext-link ext-link-type="uri" xlink:href="https://github.com/raphaelvallat/yasa_classifier/blob/master/gridsearch_weights.py">here</ext-link>. The pretrained classifier was then exported as a compressed file (~2 MB) and used to predict (1) a full hypnogram for each night of the testing set and (2) the associated probabilities of each sleep stage for each 30 s epoch.</p></sec><sec id="s4-16"><title>Performance evaluation</title><p>Performance of the algorithm was evaluated using established standardized guidelines (<xref ref-type="bibr" rid="bib32">Menghini et al., 2021</xref>). First, for each testing night separately, we evaluated the epoch-by-epoch agreement between the human-scoring (considered as the ground-truth) and the algorithm’s predictions. Agreement was measured with widely used metrics that included accuracy (i.e., percent of correctly classified epochs), Cohen’s kappa (a more robust score that takes into account the possibility of the agreement occurring by chance), and the Matthews correlation coefficient. The latter is thought to be the most robust and informative score for classification as it naturally takes into account imbalance between sleep stages (<xref ref-type="bibr" rid="bib10">Chicco and Jurman, 2020</xref>). For all of the above metrics, higher values indicate higher accuracy agreement. Unless specified, we report the performance of the full model that includes one EEG, one EOG, one EMG, as well as the age and sex of the participant.</p><p>In addition, to measure stage-specific performance, we report confusion matrices and F1-scores for each stage separately. The F1-score is defined as the harmonic mean of precision and sensitivity. Put simply, precision is a measure of the <italic>quality</italic> of the prediction (e.g., the proportion of all the epochs classified as REM sleep by the algorithm that were actually labeled as REM sleep in the human scoring), while sensitivity is a measure of the <italic>quantity</italic> of the prediction (e.g., the proportion of all the epochs labeled as REM sleep in the human scoring that were correctly classified as REM sleep by the algorithm). Being the average of both precision and sensitivity, the F1-score is therefore an optimal measure of the algorithm’s performance that can be calculated independently for each sleep stage. Higher values indicate superior performance.</p><p>Additionally, we conducted discrepancy analysis to test for any systematic bias of the algorithm to over- or underestimate a specific sleep stage. Lastly, we performed moderator analyses to test whether the algorithm maintained a high level of performance across participants of different ages, gender, and health status.</p></sec><sec id="s4-17"><title>Consensus scoring</title><p>Each night of the DOD was scored by five independent experts. By taking the most voted stage for each epoch, it is therefore possible to build a consensus hypnogram and thus reduce bias caused by low interscorer agreement (<xref ref-type="bibr" rid="bib17">Guillot et al., 2020</xref>; <xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref>; <xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref>). When a tie occurs on a specific epoch, the sleep scoring of the most reliable scorer is used as the reference. The most reliable scorer is the scorer with the highest average agreement with all the other scorers for the given night. We also compared each human scorer against an unbiased consensus, which was based on the <italic>N-1</italic> remaining scorers (i.e., excluding the current scorer, <xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref>). Here again, the most reliable of the <italic>N-1</italic> scorers was used in case of ties.</p></sec><sec id="s4-18"><title>Comparison against existing algorithms</title><p>We further tested the performance of the current algorithm (YASA) against two recently developed sleep-staging algorithms, namely the <xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref> and <xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref> algorithms. Both algorithms are based on a deep-learning approach and are publicly available on GitHub. The two algorithms were applied on all the nights of the DOD dataset using the same raw data used to test the current algorithm.</p><p>Similar to YASA, the <xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref> and <xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref> algorithms did not include any nights of the DOD in their training set, thus ensuring an unbiased comparison. The only difference between the algorithms was in the choice of channels used by the algorithms to predict the sleep stages. While YASA only uses a single EEG (central), one EOG, and one EMG, both the <xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref> and <xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref> algorithms were tested using two EOGs (LOC and ROC) as well as several EEG channels. Specifically, the <xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref> algorithm was tested using one chin EMG, two EOGs, and four EEGs (two central and two occipital channels). The <xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref> algorithm does not require an EMG channel, but uses by default all available EEG channels. For the <xref ref-type="bibr" rid="bib38">Perslev et al., 2021</xref> algorithm, the web portal (<ext-link ext-link-type="uri" xlink:href="https://sleep.ai.ku.dk/">https://sleep.ai.ku.dk/</ext-link>) was used to upload each EDF file and download the resulting sleep scores (version: U-Sleep 1.0). For the <xref ref-type="bibr" rid="bib45">Stephansen et al., 2018</xref> algorithm, sleep scores were obtained using the pretrained algorithm on the master branch of the GitHub repository (<xref ref-type="bibr" rid="bib47">Vallet, 2018</xref>) (<ext-link ext-link-type="uri" xlink:href="https://github.com/Stanford-STAGES/stanford-stages">https://github.com/Stanford-STAGES/stanford-stages</ext-link>; as of July 20, 2021).</p><p>For all three algorithms, the ground truth was the consensus scoring of all five human experts. Results were evaluated separately for the healthy individuals (DOD-Healthy) and patients with oOSA (DOD-Obstructive). Statistical comparisons were performed using two-sided paired pairwise t-tests corrected for multiple comparisons using the Holm method.</p></sec><sec id="s4-19"><title>Features importance</title><p>Features importance was measured on the full training set using the Shapley Additive Explanation algorithm (SHAP; <xref ref-type="bibr" rid="bib30">Lundberg et al., 2020</xref>). Shapley values, which originate from game theory, have several desirable properties that make them optimal for evaluating features contribution in machine learning. Formally, a Shapley value is the average marginal contribution of a feature value across all possible combinations of features. The SHAP contribution of a given feature was computed by first summing the absolute Shapley values on all epochs and then averaging across all sleep stages, thus leading to a single importance score for each feature.</p></sec><sec id="s4-20"><title>Data and code availability</title><p>All PSG data can be requested from the NSRR website (<ext-link ext-link-type="uri" xlink:href="http://sleepdata.org">http://sleepdata.org</ext-link>). The Dreem Open Dataset can be found at <ext-link ext-link-type="uri" xlink:href="https://github.com/Dreem-Organization/dreem-learning-open">https://github.com/Dreem-Organization/dreem-learning-open</ext-link>. The source code and documentation of the algorithm are available at <ext-link ext-link-type="uri" xlink:href="https://github.com/raphaelvallat/yasa">https://github.com/raphaelvallat/yasa</ext-link>. The Python code to reproduce all the results and figures of this paper can be found at <ext-link ext-link-type="uri" xlink:href="https://github.com/raphaelvallat/yasa_classifier">https://github.com/raphaelvallat/yasa_classifier</ext-link>. All analyses were conducted in Python 3.8 using scikit-learn 0.24.2 (<xref ref-type="bibr" rid="bib37">Pedregosa et al., 2011</xref>) and lightgbm 3.2.1 (<xref ref-type="bibr" rid="bib24">Ke et al., 2017</xref>).</p></sec></sec></body><back><sec id="s5" sec-type="additional-information"><title>Additional information</title><fn-group content-type="competing-interest"><title>Competing interests</title><fn fn-type="COI-statement" id="conf1"><p>No competing interests declared</p></fn></fn-group><fn-group content-type="author-contribution"><title>Author contributions</title><fn fn-type="con" id="con1"><p>Conceptualization, Formal analysis, Methodology, Software, Writing - original draft, Writing - review and editing</p></fn><fn fn-type="con" id="con2"><p>Conceptualization, Formal analysis, Methodology, Writing - original draft, Writing - review and editing</p></fn></fn-group></sec><sec id="s6" sec-type="supplementary-material"><title>Additional files</title><supplementary-material id="supp1"><label>Supplementary file 1.</label><caption><title>Predictions of the automated algorithms for each night of the DOD-Healthy validation dataset.</title><p>Accuracy refers to the percentage of agreement of the algorithm against the human consensus scoring. Nights are ranked in descending order of agreement between YASA and the consensus scoring.</p></caption><media mime-subtype="pdf" mimetype="application" xlink:href="elife-70092-supp1-v1.pdf"/></supplementary-material><supplementary-material id="supp2"><label>Supplementary file 2.</label><caption><title>Predictions of the automated algorithms for each night of the DOD-Obstructive validation dataset.</title><p>Accuracy refers to the percentage of agreement of the algorithm against the human consensus scoring. Nights are ranked in descending order of agreement between YASA and the consensus scoring.</p></caption><media mime-subtype="pdf" mimetype="application" xlink:href="elife-70092-supp2-v1.pdf"/></supplementary-material><supplementary-material id="supp3"><label>Supplementary file 3.</label><caption><title>(A) Cross-validation of the best time length for the temporal smoothing of the features.</title><p>A total of 49 combinations of past and centered rolling windows were tested, defined as the Cartesian product of the following time lengths for the past rolling average: [none, 1 min, 2 min, 3 min, 5 min, 7 min, 9 min] and the centered rolling weighted average: [none, 1.5 min, 2.5 min, 3.5 min, 5.5 min, 7.5 min, 9.5 min], where none indicates that no rolling window was applied. Cross-validation was performed using a threefold validation on the full training set, stratified by nights, such that a polysomnography (PSG) night was either present in the training and validation set, but never in both at the same time. For speed, only 50 trees were used in the classification algorithm. The ‘Mean’ column is the average of the accuracy and the five F1-scores. Note that the second best-ranked combination (9.5 min centered) has a slightly higher mean score; however, we chose to use a 7.5 min centered window (rank 1) in our final model because it had higher F1-scores for N2, N3, and rapid eye movement (REM) sleep. (<bold>B</bold>) Contributors of variability in accuracy. Relative importance (%) was estimated with a random forest on n = 585 nights from the testing set 1. The outcome variable of the model was the accuracy score of YASA against ground-truth sleep staging, calculated separately for each night.</p></caption><media mime-subtype="docx" mimetype="application" xlink:href="elife-70092-supp3-v1.docx"/></supplementary-material><supplementary-material id="supp4"><label>Supplementary file 4.</label><caption><title>All the features are calculated for each consecutive 30 s epoch across the night, starting from the first sample of the polysomnography recording.</title><p>Importantly, the algorithm uses three different versions of all time-domain and frequency-domain features: (1) the raw feature, expressed in the original unit of data (e.g., µV for the standard deviation and interquartile range), (2) a smoothed and normalized version of that feature using a 7.5 min triangular-weighted rolling average, and (3) a smoothed and normalized version of that feature using a past 2 min rolling average. Normalization is done after smoothing on a per-night basis with a robust method based on the 5–95% percentiles. Frequency-domain features are based on a Welch’s periodogram with a 5 s window (= 0.2 Hz resolution).</p></caption><media mime-subtype="docx" mimetype="application" xlink:href="elife-70092-supp4-v1.docx"/></supplementary-material><supplementary-material id="transrepform"><label>Transparent reporting form</label><media mime-subtype="docx" mimetype="application" xlink:href="elife-70092-transrepform1-v1.docx"/></supplementary-material></sec><sec id="s7" sec-type="data-availability"><title>Data availability</title><p>All polysomnography data can be requested from the NSRR website (<ext-link ext-link-type="uri" xlink:href="http://sleepdata.org">http://sleepdata.org</ext-link>). The Dreem Open Dataset can be found at <ext-link ext-link-type="uri" xlink:href="https://github.com/Dreem-Organization/dreem-learning-open">https://github.com/Dreem-Organization/dreem-learning-open</ext-link>. The source code and documentation of the algorithm is available at <ext-link ext-link-type="uri" xlink:href="https://github.com/raphaelvallat/yasa">https://github.com/raphaelvallat/yasa</ext-link>. The Python code to reproduce all the results and figures of this paper can be found at <ext-link ext-link-type="uri" xlink:href="https://github.com/raphaelvallat/yasa_classifier">https://github.com/raphaelvallat/yasa_classifier</ext-link>. All analyses were conducted in Python 3.8 using scikit-learn 0.24.2 and lightgbm 3.2.1.</p></sec><ref-list><title>References</title><ref id="bib1"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Agarwal</surname><given-names>R</given-names></name><name><surname>Takeuchi</surname><given-names>T</given-names></name><name><surname>Laroche</surname><given-names>S</given-names></name><name><surname>Gotman</surname><given-names>J</given-names></name></person-group><year iso-8601-date="2005">2005</year><article-title>Detection of rapid-eye movements in sleep studies</article-title><source>IEEE Transactions on Bio-Medical Engineering</source><volume>52</volume><fpage>1390</fpage><lpage>1396</lpage><pub-id pub-id-type="doi">10.1109/TBME.2005.851512</pub-id><pub-id pub-id-type="pmid">16119234</pub-id></element-citation></ref><ref id="bib2"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Bandt</surname><given-names>C</given-names></name><name><surname>Pompe</surname><given-names>B</given-names></name></person-group><year iso-8601-date="2002">2002</year><article-title>Permutation entropy: A natural complexity measure for time series</article-title><source>Physical Review Letters</source><volume>88</volume><elocation-id>174102</elocation-id><pub-id pub-id-type="doi">10.1103/PhysRevLett.88.174102</pub-id><pub-id pub-id-type="pmid">12005759</pub-id></element-citation></ref><ref id="bib3"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ben Simon</surname><given-names>E</given-names></name><name><surname>Vallat</surname><given-names>R</given-names></name><name><surname>Barnes</surname><given-names>CM</given-names></name><name><surname>Walker</surname><given-names>MP</given-names></name></person-group><year iso-8601-date="2020">2020</year><article-title>Sleep loss and the socio-emotional brain</article-title><source>Trends in Cognitive Sciences</source><volume>24</volume><fpage>435</fpage><lpage>450</lpage><pub-id pub-id-type="doi">10.1016/j.tics.2020.02.003</pub-id><pub-id pub-id-type="pmid">32299657</pub-id></element-citation></ref><ref id="bib4"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Berry</surname><given-names>RB</given-names></name><name><surname>Budhiraja</surname><given-names>R</given-names></name><name><surname>Gottlieb</surname><given-names>DJ</given-names></name><name><surname>Gozal</surname><given-names>D</given-names></name><name><surname>Iber</surname><given-names>C</given-names></name><name><surname>Kapur</surname><given-names>VK</given-names></name><name><surname>Marcus</surname><given-names>CL</given-names></name><name><surname>Mehra</surname><given-names>R</given-names></name><name><surname>Parthasarathy</surname><given-names>S</given-names></name><name><surname>Quan</surname><given-names>SF</given-names></name><name><surname>Redline</surname><given-names>S</given-names></name><name><surname>Strohl</surname><given-names>KP</given-names></name><name><surname>Davidson Ward</surname><given-names>SL</given-names></name><name><surname>Tangredi</surname><given-names>MM</given-names></name><collab>American Academy of Sleep Medicine</collab></person-group><year iso-8601-date="2012">2012</year><article-title>Rules for scoring respiratory events in sleep: update of the 2007 AASM Manual for the Scoring of Sleep and Associated Events Deliberations of the Sleep Apnea Definitions Task Force of the American Academy of Sleep Medicine</article-title><source>Journal of Clinical Sleep Medicine</source><volume>8</volume><fpage>597</fpage><lpage>619</lpage><pub-id pub-id-type="doi">10.5664/jcsm.2172</pub-id><pub-id pub-id-type="pmid">23066376</pub-id></element-citation></ref><ref id="bib5"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Besedovsky</surname><given-names>L</given-names></name><name><surname>Lange</surname><given-names>T</given-names></name><name><surname>Haack</surname><given-names>M</given-names></name></person-group><year iso-8601-date="2019">2019</year><article-title>The sleep-immune crosstalk in health and disease</article-title><source>Physiological Reviews</source><volume>99</volume><fpage>1325</fpage><lpage>1380</lpage><pub-id pub-id-type="doi">10.1152/physrev.00010.2018</pub-id><pub-id pub-id-type="pmid">30920354</pub-id></element-citation></ref><ref id="bib6"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Buckelmüller</surname><given-names>J</given-names></name><name><surname>Landolt</surname><given-names>HP</given-names></name><name><surname>Stassen</surname><given-names>HH</given-names></name><name><surname>Achermann</surname><given-names>P</given-names></name></person-group><year iso-8601-date="2006">2006</year><article-title>Trait-like individual differences in the human sleep electroencephalogram</article-title><source>Neuroscience</source><volume>138</volume><fpage>351</fpage><lpage>356</lpage><pub-id pub-id-type="doi">10.1016/j.neuroscience.2005.11.005</pub-id><pub-id pub-id-type="pmid">16388912</pub-id></element-citation></ref><ref id="bib7"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Cappuccio</surname><given-names>FP</given-names></name><name><surname>D’Elia</surname><given-names>L</given-names></name><name><surname>Strazzullo</surname><given-names>P</given-names></name><name><surname>Miller</surname><given-names>MA</given-names></name></person-group><year iso-8601-date="2010">2010</year><article-title>Sleep duration and all-cause mortality: A systematic review and meta-analysis of prospective studies</article-title><source>Sleep</source><volume>33</volume><fpage>585</fpage><lpage>592</lpage><pub-id pub-id-type="doi">10.1093/sleep/33.5.585</pub-id><pub-id pub-id-type="pmid">20469800</pub-id></element-citation></ref><ref id="bib8"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Cappuccio</surname><given-names>FP</given-names></name><name><surname>Miller</surname><given-names>MA</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Sleep and cardio-metabolic disease</article-title><source>Current Cardiology Reports</source><volume>19</volume><elocation-id>110</elocation-id><pub-id pub-id-type="doi">10.1007/s11886-017-0916-0</pub-id><pub-id pub-id-type="pmid">28929340</pub-id></element-citation></ref><ref id="bib9"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Carrier</surname><given-names>J</given-names></name><name><surname>Land</surname><given-names>S</given-names></name><name><surname>Buysse</surname><given-names>DJ</given-names></name><name><surname>Kupfer</surname><given-names>DJ</given-names></name><name><surname>Monk</surname><given-names>TH</given-names></name></person-group><year iso-8601-date="2001">2001</year><article-title>The effects of age and gender on sleep EEG power spectral density in the middle years of life (ages 20-60 years old</article-title><source>Psychophysiology</source><volume>38</volume><fpage>232</fpage><lpage>242</lpage><pub-id pub-id-type="doi">10.1111/1469-8986.3820232</pub-id><pub-id pub-id-type="pmid">11347869</pub-id></element-citation></ref><ref id="bib10"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Chicco</surname><given-names>D</given-names></name><name><surname>Jurman</surname><given-names>G</given-names></name></person-group><year iso-8601-date="2020">2020</year><article-title>The advantages of the Matthews correlation coefficient (MCC) over f1 score and accuracy in binary classification evaluation</article-title><source>BMC Genomics</source><volume>21</volume><elocation-id>6</elocation-id><pub-id pub-id-type="doi">10.1186/s12864-019-6413-7</pub-id><pub-id pub-id-type="pmid">31898477</pub-id></element-citation></ref><ref id="bib11"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>De Gennaro</surname><given-names>L</given-names></name><name><surname>Marzano</surname><given-names>C</given-names></name><name><surname>Fratello</surname><given-names>F</given-names></name><name><surname>Moroni</surname><given-names>F</given-names></name><name><surname>Pellicciari</surname><given-names>MC</given-names></name><name><surname>Ferlazzo</surname><given-names>F</given-names></name><name><surname>Costa</surname><given-names>S</given-names></name><name><surname>Couyoumdjian</surname><given-names>A</given-names></name><name><surname>Curcio</surname><given-names>G</given-names></name><name><surname>Sforza</surname><given-names>E</given-names></name><name><surname>Malafosse</surname><given-names>A</given-names></name><name><surname>Finelli</surname><given-names>LA</given-names></name><name><surname>Pasqualetti</surname><given-names>P</given-names></name><name><surname>Ferrara</surname><given-names>M</given-names></name><name><surname>Bertini</surname><given-names>M</given-names></name><name><surname>Rossini</surname><given-names>PM</given-names></name></person-group><year iso-8601-date="2008">2008</year><article-title>The electroencephalographic fingerprint of sleep is genetically determined: A twin study</article-title><source>Annals of Neurology</source><volume>64</volume><fpage>455</fpage><lpage>460</lpage><pub-id pub-id-type="doi">10.1002/ana.21434</pub-id><pub-id pub-id-type="pmid">18688819</pub-id></element-citation></ref><ref id="bib12"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Dean</surname><given-names>DA</given-names></name><name><surname>Goldberger</surname><given-names>AL</given-names></name><name><surname>Mueller</surname><given-names>R</given-names></name><name><surname>Kim</surname><given-names>M</given-names></name><name><surname>Rueschman</surname><given-names>M</given-names></name><name><surname>Mobley</surname><given-names>D</given-names></name><name><surname>Sahoo</surname><given-names>SS</given-names></name><name><surname>Jayapandian</surname><given-names>CP</given-names></name><name><surname>Cui</surname><given-names>L</given-names></name><name><surname>Morrical</surname><given-names>MG</given-names></name><name><surname>Surovec</surname><given-names>S</given-names></name><name><surname>Zhang</surname><given-names>GQ</given-names></name><name><surname>Redline</surname><given-names>S</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Scaling up scientific discovery in sleep medicine: The National Sleep Research Resource</article-title><source>Sleep</source><volume>39</volume><fpage>1151</fpage><lpage>1164</lpage><pub-id pub-id-type="doi">10.5665/sleep.5774</pub-id><pub-id pub-id-type="pmid">27070134</pub-id></element-citation></ref><ref id="bib13"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Esteller</surname><given-names>R</given-names></name><name><surname>Vachtsevanos</surname><given-names>G</given-names></name><name><surname>Echauz</surname><given-names>J</given-names></name><name><surname>Litt</surname><given-names>B</given-names></name></person-group><year iso-8601-date="2001">2001</year><article-title>A comparison of waveform fractal dimension algorithms</article-title><source>IEEE Transactions on Circuits and Systems I</source><volume>48</volume><fpage>177</fpage><lpage>183</lpage><pub-id pub-id-type="doi">10.1109/81.904882</pub-id></element-citation></ref><ref id="bib14"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Fiorillo</surname><given-names>L</given-names></name><name><surname>Puiatti</surname><given-names>A</given-names></name><name><surname>Papandrea</surname><given-names>M</given-names></name><name><surname>Ratti</surname><given-names>PL</given-names></name><name><surname>Favaro</surname><given-names>P</given-names></name><name><surname>Roth</surname><given-names>C</given-names></name><name><surname>Bargiotas</surname><given-names>P</given-names></name><name><surname>Bassetti</surname><given-names>CL</given-names></name><name><surname>Faraci</surname><given-names>FD</given-names></name></person-group><year iso-8601-date="2019">2019</year><article-title>Automated sleep scoring: A review of the latest approaches</article-title><source>Sleep Medicine Reviews</source><volume>48</volume><elocation-id>7</elocation-id><pub-id pub-id-type="doi">10.1016/j.smrv.2019.07.007</pub-id><pub-id pub-id-type="pmid">31491655</pub-id></element-citation></ref><ref id="bib15"><element-citation publication-type="book"><person-group person-group-type="author"><name><surname>Fleming</surname><given-names>G</given-names></name><name><surname>Reitsma</surname><given-names>R</given-names></name><name><surname>Pappafotopoulos</surname><given-names>T</given-names></name><name><surname>Duan</surname><given-names>X</given-names></name><name><surname>Birrel</surname><given-names>R</given-names></name></person-group><year iso-8601-date="2015">2015</year><source>The State of Consumers and Technology Benchmark 2015, Us</source><publisher-loc>Cambridge, MA</publisher-loc><publisher-name>Forrester</publisher-name></element-citation></ref><ref id="bib16"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Gramfort</surname><given-names>A</given-names></name><name><surname>Luessi</surname><given-names>M</given-names></name><name><surname>Larson</surname><given-names>E</given-names></name><name><surname>Engemann</surname><given-names>DA</given-names></name><name><surname>Strohmeier</surname><given-names>D</given-names></name><name><surname>Brodbeck</surname><given-names>C</given-names></name><name><surname>Parkkonen</surname><given-names>L</given-names></name><name><surname>Hämäläinen</surname><given-names>MS</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>MNE software for processing MEG and EEG data</article-title><source>NeuroImage</source><volume>86</volume><fpage>446</fpage><lpage>460</lpage><pub-id pub-id-type="doi">10.1016/j.neuroimage.2013.10.027</pub-id><pub-id pub-id-type="pmid">24161808</pub-id></element-citation></ref><ref id="bib17"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Guillot</surname><given-names>A</given-names></name><name><surname>Sauvet</surname><given-names>F</given-names></name><name><surname>During</surname><given-names>EH</given-names></name><name><surname>Thorey</surname><given-names>V</given-names></name></person-group><year iso-8601-date="2020">2020</year><article-title>Dreem open datasets: Multi-scored sleep datasets to compare human and automated sleep staging</article-title><source>IEEE Transactions on Neural Systems and Rehabilitation Engineering</source><volume>28</volume><fpage>1955</fpage><lpage>1965</lpage><pub-id pub-id-type="doi">10.1109/TNSRE.2020.3011181</pub-id><pub-id pub-id-type="pmid">32746326</pub-id></element-citation></ref><ref id="bib18"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Harding</surname><given-names>EC</given-names></name><name><surname>Franks</surname><given-names>NP</given-names></name><name><surname>Wisden</surname><given-names>W</given-names></name></person-group><year iso-8601-date="2020">2020</year><article-title>Sleep and thermoregulation</article-title><source>Current Opinion in Physiology</source><volume>15</volume><fpage>7</fpage><lpage>13</lpage><pub-id pub-id-type="doi">10.1016/j.cophys.2019.11.008</pub-id><pub-id pub-id-type="pmid">32617439</pub-id></element-citation></ref><ref id="bib19"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Helfrich</surname><given-names>RF</given-names></name><name><surname>Mander</surname><given-names>BA</given-names></name><name><surname>Jagust</surname><given-names>WJ</given-names></name><name><surname>Knight</surname><given-names>RT</given-names></name><name><surname>Walker</surname><given-names>MP</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>Old brains come uncoupled in sleep: Slow wave-spindle synchrony, brain atrophy, and forgetting</article-title><source>Neuron</source><volume>97</volume><fpage>221</fpage><lpage>230</lpage><pub-id pub-id-type="doi">10.1016/j.neuron.2017.11.020</pub-id><pub-id pub-id-type="pmid">29249289</pub-id></element-citation></ref><ref id="bib20"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Higuchi</surname><given-names>T</given-names></name></person-group><year iso-8601-date="1988">1988</year><article-title>Approach to an irregular time series on the basis of the fractal theory</article-title><source>Physica D</source><volume>31</volume><fpage>277</fpage><lpage>283</lpage><pub-id pub-id-type="doi">10.1016/0167-2789(88)90081-4</pub-id></element-citation></ref><ref id="bib21"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hjorth</surname><given-names>B</given-names></name></person-group><year iso-8601-date="1970">1970</year><article-title>EEG analysis based on time domain properties</article-title><source>Electroencephalography and Clinical Neurophysiology</source><volume>29</volume><fpage>306</fpage><lpage>310</lpage><pub-id pub-id-type="doi">10.1016/0013-4694(70)90143-4</pub-id><pub-id pub-id-type="pmid">4195653</pub-id></element-citation></ref><ref id="bib22"><element-citation publication-type="book"><person-group person-group-type="author"><name><surname>Iber</surname><given-names>C</given-names></name><name><surname>Ancoli-Israel</surname><given-names>S</given-names></name><name><surname>Chesson</surname><given-names>AL</given-names></name><name><surname>Quan</surname><given-names>SF</given-names></name></person-group><year iso-8601-date="2007">2007</year><source>The AASM Manual for the Scoring of Sleep and Associated Events: Rules, Terminology and Technical Specifications</source><publisher-loc>Westchester, IL</publisher-loc><publisher-name>American Academy of Sleep Medicine</publisher-name></element-citation></ref><ref id="bib23"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ju</surname><given-names>Y-ES</given-names></name><name><surname>Lucey</surname><given-names>BP</given-names></name><name><surname>Holtzman</surname><given-names>DM</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Sleep and Alzheimer disease pathology--a bidirectional relationship</article-title><source>Nature Reviews. Neurology</source><volume>10</volume><fpage>115</fpage><lpage>119</lpage><pub-id pub-id-type="doi">10.1038/nrneurol.2013.269</pub-id><pub-id pub-id-type="pmid">24366271</pub-id></element-citation></ref><ref id="bib24"><element-citation publication-type="book"><person-group person-group-type="author"><name><surname>Ke</surname><given-names>G</given-names></name><name><surname>Meng</surname><given-names>Q</given-names></name><name><surname>Finley</surname><given-names>T</given-names></name><name><surname>Wang</surname><given-names>T</given-names></name><name><surname>Chen</surname><given-names>W</given-names></name><name><surname>Ma</surname><given-names>W</given-names></name><name><surname>Ye</surname><given-names>Q</given-names></name><name><surname>Liu</surname><given-names>TY</given-names></name></person-group><year iso-8601-date="2017">2017</year><chapter-title>Lightgbm: A highly efficient gradient boosting decision tree in</chapter-title><person-group person-group-type="editor"><name><surname>Guyon</surname><given-names>I</given-names></name><name><surname>Luxburg</surname><given-names>UV</given-names></name><name><surname>Bengio</surname><given-names>S</given-names></name><name><surname>Wallach</surname><given-names>H</given-names></name><name><surname>Fergus</surname><given-names>R</given-names></name><name><surname>Vishwanathan</surname><given-names>S</given-names></name><name><surname>Garnett</surname><given-names>R</given-names></name></person-group><source>Advances in Neural Information Processing Systems 30</source><publisher-name>Curran Associates, Inc</publisher-name><fpage>3146</fpage><lpage>3154</lpage></element-citation></ref><ref id="bib25"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Koley</surname><given-names>BL</given-names></name><name><surname>Dey</surname><given-names>D</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>Automatic detection of sleep apnea and hypopnea events from single channel measurement of respiration signal employing ensemble binary SVM classifiers</article-title><source>Measurement</source><volume>46</volume><fpage>2082</fpage><lpage>2092</lpage><pub-id pub-id-type="doi">10.1016/j.measurement.2013.03.016</pub-id></element-citation></ref><ref id="bib26"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Krakovská</surname><given-names>A</given-names></name><name><surname>Mezeiová</surname><given-names>K</given-names></name></person-group><year iso-8601-date="2011">2011</year><article-title>Automatic sleep scoring: A search for an optimal combination of measures</article-title><source>Artificial Intelligence in Medicine</source><volume>53</volume><fpage>25</fpage><lpage>33</lpage><pub-id pub-id-type="doi">10.1016/j.artmed.2011.06.004</pub-id><pub-id pub-id-type="pmid">21742473</pub-id></element-citation></ref><ref id="bib27"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lajnef</surname><given-names>T</given-names></name><name><surname>Chaibi</surname><given-names>S</given-names></name><name><surname>Ruby</surname><given-names>P</given-names></name><name><surname>Aguera</surname><given-names>PE</given-names></name><name><surname>Eichenlaub</surname><given-names>JB</given-names></name><name><surname>Samet</surname><given-names>M</given-names></name><name><surname>Kachouri</surname><given-names>A</given-names></name><name><surname>Jerbi</surname><given-names>K</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Learning machines and sleeping brains: Automatic sleep stage classification using decision-tree multi-class support vector machines</article-title><source>Journal of Neuroscience Methods</source><volume>250</volume><fpage>94</fpage><lpage>105</lpage><pub-id pub-id-type="doi">10.1016/j.jneumeth.2015.01.022</pub-id><pub-id pub-id-type="pmid">25629798</pub-id></element-citation></ref><ref id="bib28"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Leary</surname><given-names>EB</given-names></name><name><surname>Watson</surname><given-names>KT</given-names></name><name><surname>Ancoli-Israel</surname><given-names>S</given-names></name><name><surname>Redline</surname><given-names>S</given-names></name><name><surname>Yaffe</surname><given-names>K</given-names></name><name><surname>Ravelo</surname><given-names>LA</given-names></name><name><surname>Peppard</surname><given-names>PE</given-names></name><name><surname>Zou</surname><given-names>J</given-names></name><name><surname>Goodman</surname><given-names>SN</given-names></name><name><surname>Mignot</surname><given-names>E</given-names></name><name><surname>Stone</surname><given-names>KL</given-names></name></person-group><year iso-8601-date="2020">2020</year><article-title>Association of rapid eye movement sleep with mortality in middle-aged and older adults</article-title><source>JAMA Neurology</source><volume>77</volume><fpage>1241</fpage><lpage>1251</lpage><pub-id pub-id-type="doi">10.1001/jamaneurol.2020.2108</pub-id><pub-id pub-id-type="pmid">32628261</pub-id></element-citation></ref><ref id="bib29"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lendner</surname><given-names>JD</given-names></name><name><surname>Helfrich</surname><given-names>RF</given-names></name><name><surname>Mander</surname><given-names>BA</given-names></name><name><surname>Romundstad</surname><given-names>L</given-names></name><name><surname>Lin</surname><given-names>JJ</given-names></name><name><surname>Walker</surname><given-names>MP</given-names></name><name><surname>Larsson</surname><given-names>PG</given-names></name><name><surname>Knight</surname><given-names>RT</given-names></name></person-group><year iso-8601-date="2020">2020</year><article-title>An electrophysiological marker of arousal level in humans</article-title><source>eLife</source><volume>9</volume><elocation-id>e55092</elocation-id><pub-id pub-id-type="doi">10.7554/eLife.55092</pub-id><pub-id pub-id-type="pmid">32720644</pub-id></element-citation></ref><ref id="bib30"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lundberg</surname><given-names>SM</given-names></name><name><surname>Erion</surname><given-names>G</given-names></name><name><surname>Chen</surname><given-names>H</given-names></name><name><surname>DeGrave</surname><given-names>A</given-names></name><name><surname>Prutkin</surname><given-names>JM</given-names></name><name><surname>Nair</surname><given-names>B</given-names></name><name><surname>Katz</surname><given-names>R</given-names></name><name><surname>Himmelfarb</surname><given-names>J</given-names></name><name><surname>Bansal</surname><given-names>N</given-names></name><name><surname>Lee</surname><given-names>SI</given-names></name></person-group><year iso-8601-date="2020">2020</year><article-title>From local explanations to global understanding with explainable ai for trees</article-title><source>Nature Machine Intelligence</source><volume>2</volume><fpage>56</fpage><lpage>67</lpage><pub-id pub-id-type="doi">10.1038/s42256-019-0138-9</pub-id><pub-id pub-id-type="pmid">32607472</pub-id></element-citation></ref><ref id="bib31"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Malhotra</surname><given-names>A</given-names></name><name><surname>Younes</surname><given-names>M</given-names></name><name><surname>Kuna</surname><given-names>ST</given-names></name><name><surname>Benca</surname><given-names>R</given-names></name><name><surname>Kushida</surname><given-names>CA</given-names></name><name><surname>Walsh</surname><given-names>J</given-names></name><name><surname>Hanlon</surname><given-names>A</given-names></name><name><surname>Staley</surname><given-names>B</given-names></name><name><surname>Pack</surname><given-names>AI</given-names></name><name><surname>Pien</surname><given-names>GW</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>Performance of an automated polysomnography scoring system versus computer-assisted manual scoring</article-title><source>Sleep</source><volume>36</volume><fpage>573</fpage><lpage>582</lpage><pub-id pub-id-type="doi">10.5665/sleep.2548</pub-id><pub-id pub-id-type="pmid">23565003</pub-id></element-citation></ref><ref id="bib32"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Menghini</surname><given-names>L</given-names></name><name><surname>Cellini</surname><given-names>N</given-names></name><name><surname>Goldstone</surname><given-names>A</given-names></name><name><surname>Baker</surname><given-names>FC</given-names></name><name><surname>de Zambotti</surname><given-names>M</given-names></name></person-group><year iso-8601-date="2021">2021</year><article-title>A standardized framework for testing the performance of sleep-tracking technology: Step-by-step guidelines and open-source code</article-title><source>Sleep</source><volume>44</volume><elocation-id>zsaa170</elocation-id><pub-id pub-id-type="doi">10.1093/sleep/zsaa170</pub-id><pub-id pub-id-type="pmid">32882005</pub-id></element-citation></ref><ref id="bib33"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Muehlroth</surname><given-names>BE</given-names></name><name><surname>Werkle-Bergner</surname><given-names>M</given-names></name></person-group><year iso-8601-date="2020">2020</year><article-title>Understanding the interplay of sleep and aging: Methodological challenges</article-title><source>Psychophysiology</source><volume>10</volume><elocation-id>e13523</elocation-id><pub-id pub-id-type="doi">10.1111/psyp.13523</pub-id></element-citation></ref><ref id="bib34"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Norman</surname><given-names>RG</given-names></name><name><surname>Pal</surname><given-names>I</given-names></name><name><surname>Stewart</surname><given-names>C</given-names></name><name><surname>Walsleben</surname><given-names>JA</given-names></name><name><surname>Rapoport</surname><given-names>DM</given-names></name></person-group><year iso-8601-date="2000">2000</year><article-title>Interobserver agreement among sleep scorers from different centers in a large dataset</article-title><source>Sleep</source><volume>23</volume><fpage>901</fpage><lpage>908</lpage><pub-id pub-id-type="doi">10.1093/sleep/23.7.1e</pub-id><pub-id pub-id-type="pmid">11083599</pub-id></element-citation></ref><ref id="bib35"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ohayon</surname><given-names>MM</given-names></name><name><surname>Carskadon</surname><given-names>MA</given-names></name><name><surname>Guilleminault</surname><given-names>C</given-names></name><name><surname>Vitiello</surname><given-names>MV</given-names></name></person-group><year iso-8601-date="2004">2004</year><article-title>Meta-analysis of quantitative sleep parameters from childhood to old age in healthy individuals: Developing normative sleep values across the human lifespan</article-title><source>Sleep</source><volume>27</volume><fpage>1255</fpage><lpage>1273</lpage><pub-id pub-id-type="doi">10.1093/sleep/27.7.1255</pub-id><pub-id pub-id-type="pmid">15586779</pub-id></element-citation></ref><ref id="bib36"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Patanaik</surname><given-names>A</given-names></name><name><surname>Ong</surname><given-names>JL</given-names></name><name><surname>Gooley</surname><given-names>JJ</given-names></name><name><surname>Ancoli-Israel</surname><given-names>S</given-names></name><name><surname>Chee</surname><given-names>MWL</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>An end-to-end framework for real-time automatic sleep stage classification</article-title><source>Sleep</source><volume>41</volume><elocation-id>zsy041</elocation-id><pub-id pub-id-type="doi">10.1093/sleep/zsy041</pub-id><pub-id pub-id-type="pmid">29590492</pub-id></element-citation></ref><ref id="bib37"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Pedregosa</surname><given-names>F</given-names></name><name><surname>Varoquaux</surname><given-names>G</given-names></name><name><surname>Gramfort</surname><given-names>A</given-names></name><name><surname>Michel</surname><given-names>V</given-names></name><name><surname>Thirion B</surname><given-names>B</given-names></name><name><surname>Grisel O</surname><given-names>O</given-names></name><name><surname>Blondel M</surname><given-names>M</given-names></name><name><surname>Prettenhofer</surname><given-names>P</given-names></name><name><surname>Weiss</surname><given-names>R</given-names></name><name><surname>Dubourg</surname><given-names>V</given-names></name></person-group><year iso-8601-date="2011">2011</year><article-title>Scikit-learn: Machine learning in Python</article-title><source>The Journal of Machine Learning Research</source><volume>12</volume><fpage>2825</fpage><lpage>2830</lpage></element-citation></ref><ref id="bib38"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Perslev</surname><given-names>M</given-names></name><name><surname>Darkner</surname><given-names>S</given-names></name><name><surname>Kempfner</surname><given-names>L</given-names></name><name><surname>Nikolic</surname><given-names>M</given-names></name><name><surname>Jennum</surname><given-names>PJ</given-names></name><name><surname>Igel</surname><given-names>C</given-names></name></person-group><year iso-8601-date="2021">2021</year><article-title>U-sleep: Resilient high-frequency sleep staging</article-title><source>NPJ Digital Medicine</source><volume>4</volume><elocation-id>72</elocation-id><pub-id pub-id-type="doi">10.1038/s41746-021-00440-5</pub-id><pub-id pub-id-type="pmid">33859353</pub-id></element-citation></ref><ref id="bib39"><element-citation publication-type="confproc"><person-group person-group-type="author"><name><surname>Petrosian</surname><given-names>A</given-names></name></person-group><year iso-8601-date="1995">1995</year><conf-name>Kolmogorov complexity of finite sequences and recognition of different preictal eeg patternsproceedings eighth</conf-name><article-title>IEEE symposium on computer-based medical systems</article-title><fpage>212</fpage><lpage>217</lpage><pub-id pub-id-type="doi">10.1109/CBMS.1995.465426</pub-id></element-citation></ref><ref id="bib40"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Phan</surname><given-names>H</given-names></name><name><surname>Andreotti</surname><given-names>F</given-names></name><name><surname>Cooray</surname><given-names>N</given-names></name><name><surname>Chen</surname><given-names>OY</given-names></name><name><surname>De Vos</surname><given-names>M</given-names></name></person-group><year iso-8601-date="2019">2019</year><article-title>SEQSLEEPNET: End-to-end hierarchical recurrent Neural network for sequence-to-sequence automatic sleep staging</article-title><source>IEEE Transactions on Neural Systems and Rehabilitation Engineering</source><volume>27</volume><fpage>400</fpage><lpage>410</lpage><pub-id pub-id-type="doi">10.1109/TNSRE.2019.2896659</pub-id><pub-id pub-id-type="pmid">30716040</pub-id></element-citation></ref><ref id="bib41"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rosenberg</surname><given-names>RS</given-names></name><name><surname>Van Hout</surname><given-names>S</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>The American Academy of Sleep medicine inter-scorer reliability program: Sleep stage scoring</article-title><source>Journal of Clinical Sleep Medicine</source><volume>9</volume><fpage>81</fpage><lpage>87</lpage><pub-id pub-id-type="doi">10.5664/jcsm.2350</pub-id><pub-id pub-id-type="pmid">23319910</pub-id></element-citation></ref><ref id="bib42"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Shelgikar</surname><given-names>AV</given-names></name><name><surname>Anderson</surname><given-names>PF</given-names></name><name><surname>Stephens</surname><given-names>MR</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Sleep Tracking, Wearable Technology, and Opportunities for Research and Clinical Care</article-title><source>Chest</source><volume>150</volume><fpage>732</fpage><lpage>743</lpage><pub-id pub-id-type="doi">10.1016/j.chest.2016.04.016</pub-id><pub-id pub-id-type="pmid">27132701</pub-id></element-citation></ref><ref id="bib43"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Silber</surname><given-names>MH</given-names></name><name><surname>Ancoli-Israel</surname><given-names>S</given-names></name><name><surname>Bonnet</surname><given-names>MH</given-names></name><name><surname>Chokroverty</surname><given-names>S</given-names></name><name><surname>Grigg-Damberger</surname><given-names>MM</given-names></name><name><surname>Hirshkowitz</surname><given-names>M</given-names></name><name><surname>Kapen</surname><given-names>S</given-names></name><name><surname>Keenan</surname><given-names>SA</given-names></name><name><surname>Kryger</surname><given-names>MH</given-names></name><name><surname>Penzel</surname><given-names>T</given-names></name><name><surname>Pressman</surname><given-names>MR</given-names></name><name><surname>Iber</surname><given-names>C</given-names></name></person-group><year iso-8601-date="2007">2007</year><article-title>The visual scoring of sleep in adults</article-title><source>Journal of Clinical Sleep Medicine</source><volume>3</volume><fpage>121</fpage><lpage>131</lpage><pub-id pub-id-type="doi">10.5664/jcsm.26814</pub-id><pub-id pub-id-type="pmid">17557422</pub-id></element-citation></ref><ref id="bib44"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Staresina</surname><given-names>BP</given-names></name><name><surname>Bergmann</surname><given-names>TO</given-names></name><name><surname>Bonnefond</surname><given-names>M</given-names></name><name><surname>van der Meij</surname><given-names>R</given-names></name><name><surname>Jensen</surname><given-names>O</given-names></name><name><surname>Deuker</surname><given-names>L</given-names></name><name><surname>Elger</surname><given-names>CE</given-names></name><name><surname>Axmacher</surname><given-names>N</given-names></name><name><surname>Fell</surname><given-names>J</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Hierarchical nesting of slow oscillations, spindles and ripples in the human hippocampus during sleep</article-title><source>Nature Neuroscience</source><volume>18</volume><fpage>1679</fpage><lpage>1686</lpage><pub-id pub-id-type="doi">10.1038/nn.4119</pub-id><pub-id pub-id-type="pmid">26389842</pub-id></element-citation></ref><ref id="bib45"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Stephansen</surname><given-names>JB</given-names></name><name><surname>Olesen</surname><given-names>AN</given-names></name><name><surname>Olsen</surname><given-names>M</given-names></name><name><surname>Ambati</surname><given-names>A</given-names></name><name><surname>Leary</surname><given-names>EB</given-names></name><name><surname>Moore</surname><given-names>HE</given-names></name><name><surname>Carrillo</surname><given-names>O</given-names></name><name><surname>Lin</surname><given-names>L</given-names></name><name><surname>Han</surname><given-names>F</given-names></name><name><surname>Yan</surname><given-names>H</given-names></name><name><surname>Sun</surname><given-names>YL</given-names></name><name><surname>Dauvilliers</surname><given-names>Y</given-names></name><name><surname>Scholz</surname><given-names>S</given-names></name><name><surname>Barateau</surname><given-names>L</given-names></name><name><surname>Hogl</surname><given-names>B</given-names></name><name><surname>Stefani</surname><given-names>A</given-names></name><name><surname>Hong</surname><given-names>SC</given-names></name><name><surname>Kim</surname><given-names>TW</given-names></name><name><surname>Pizza</surname><given-names>F</given-names></name><name><surname>Plazzi</surname><given-names>G</given-names></name><name><surname>Vandi</surname><given-names>S</given-names></name><name><surname>Antelmi</surname><given-names>E</given-names></name><name><surname>Perrin</surname><given-names>D</given-names></name><name><surname>Kuna</surname><given-names>ST</given-names></name><name><surname>Schweitzer</surname><given-names>PK</given-names></name><name><surname>Kushida</surname><given-names>C</given-names></name><name><surname>Peppard</surname><given-names>PE</given-names></name><name><surname>Sorensen</surname><given-names>HBD</given-names></name><name><surname>Jennum</surname><given-names>P</given-names></name><name><surname>Mignot</surname><given-names>E</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>Neural network analysis of sleep stages enables efficient diagnosis of narcolepsy</article-title><source>Nature Communications</source><volume>9</volume><elocation-id>5229</elocation-id><pub-id pub-id-type="doi">10.1038/s41467-018-07229-3</pub-id><pub-id pub-id-type="pmid">30523329</pub-id></element-citation></ref><ref id="bib46"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Sun</surname><given-names>H</given-names></name><name><surname>Jia</surname><given-names>J</given-names></name><name><surname>Goparaju</surname><given-names>B</given-names></name><name><surname>Huang</surname><given-names>GB</given-names></name><name><surname>Sourina</surname><given-names>O</given-names></name><name><surname>Bianchi</surname><given-names>MT</given-names></name><name><surname>Westover</surname><given-names>MB</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Large-scale automated sleep staging</article-title><source>Sleep</source><volume>40</volume><elocation-id>139</elocation-id><pub-id pub-id-type="doi">10.1093/sleep/zsx139</pub-id><pub-id pub-id-type="pmid">29029305</pub-id></element-citation></ref><ref id="bib47"><element-citation publication-type="software"><person-group person-group-type="author"><name><surname>Vallet</surname><given-names>R</given-names></name></person-group><year iso-8601-date="2018">2018</year><data-title>Yet Another Spindles Algorithm (YASA), open-source package released on GitHub under a BSD-3 Clause License</data-title><version designator="0.5.1">0.5.1</version><source>GitHub</source><ext-link ext-link-type="uri" xlink:href="https://github.com/raphaelvallat/yasa">https://github.com/raphaelvallat/yasa</ext-link></element-citation></ref><ref id="bib48"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Varon</surname><given-names>C</given-names></name><name><surname>Caicedo</surname><given-names>A</given-names></name><name><surname>Testelmans</surname><given-names>D</given-names></name><name><surname>Buyse</surname><given-names>B</given-names></name><name><surname>Van Huffel</surname><given-names>S</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>A novel algorithm for the automatic detection of sleep apnea from single-lead ECG</article-title><source>IEEE Transactions on Bio-Medical Engineering</source><volume>62</volume><fpage>2269</fpage><lpage>2278</lpage><pub-id pub-id-type="doi">10.1109/TBME.2015.2422378</pub-id><pub-id pub-id-type="pmid">25879836</pub-id></element-citation></ref><ref id="bib49"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Walker</surname><given-names>MP</given-names></name></person-group><year iso-8601-date="2009">2009</year><article-title>The role of sleep in cognition and emotion</article-title><source>Annals of the New York Academy of Sciences</source><volume>1156</volume><fpage>168</fpage><lpage>197</lpage><pub-id pub-id-type="doi">10.1111/j.1749-6632.2009.04416.x</pub-id><pub-id pub-id-type="pmid">19338508</pub-id></element-citation></ref><ref id="bib50"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Welch</surname><given-names>P</given-names></name></person-group><year iso-8601-date="1967">1967</year><article-title>The use of fast fourier transform for the estimation of power spectra: A method based on time averaging over short, modified periodograms</article-title><source>IEEE Transactions on Audio and Electroacoustics</source><volume>15</volume><fpage>70</fpage><lpage>73</lpage><pub-id pub-id-type="doi">10.1109/TAU.1967.1161901</pub-id></element-citation></ref><ref id="bib51"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wen</surname><given-names>H</given-names></name><name><surname>Liu</surname><given-names>Z</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Separating fractal and oscillatory components in the power spectrum of neurophysiological signal</article-title><source>Brain Topography</source><volume>29</volume><fpage>13</fpage><lpage>26</lpage><pub-id pub-id-type="doi">10.1007/s10548-015-0448-0</pub-id><pub-id pub-id-type="pmid">26318848</pub-id></element-citation></ref><ref id="bib52"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Winer</surname><given-names>JR</given-names></name><name><surname>Mander</surname><given-names>BA</given-names></name><name><surname>Kumar</surname><given-names>S</given-names></name><name><surname>Reed</surname><given-names>M</given-names></name><name><surname>Baker</surname><given-names>SL</given-names></name><name><surname>Jagust</surname><given-names>WJ</given-names></name><name><surname>Walker</surname><given-names>MP</given-names></name></person-group><year iso-8601-date="2020">2020</year><article-title>Sleep disturbance forecasts β-amyloid accumulation across subsequent years</article-title><source>Current Biology</source><volume>30</volume><fpage>4291</fpage><lpage>4298</lpage><pub-id pub-id-type="doi">10.1016/j.cub.2020.08.017</pub-id><pub-id pub-id-type="pmid">32888482</pub-id></element-citation></ref><ref id="bib53"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zhang</surname><given-names>GQ</given-names></name><name><surname>Cui</surname><given-names>L</given-names></name><name><surname>Mueller</surname><given-names>R</given-names></name><name><surname>Tao</surname><given-names>S</given-names></name><name><surname>Kim</surname><given-names>M</given-names></name><name><surname>Rueschman</surname><given-names>M</given-names></name><name><surname>Mariani</surname><given-names>S</given-names></name><name><surname>Mobley</surname><given-names>D</given-names></name><name><surname>Redline</surname><given-names>S</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>The National Sleep Research Resource: towards a sleep data commons</article-title><source>Journal of the American Medical Informatics Association</source><volume>25</volume><fpage>1351</fpage><lpage>1358</lpage><pub-id pub-id-type="doi">10.1093/jamia/ocy064</pub-id><pub-id pub-id-type="pmid">29860441</pub-id></element-citation></ref></ref-list></back><sub-article article-type="decision-letter" id="sa1"><front-stub><article-id pub-id-type="doi">10.7554/eLife.70092.sa1</article-id><title-group><article-title>Decision letter</article-title></title-group><contrib-group content-type="section"><contrib contrib-type="editor"><name><surname>Peyrache</surname><given-names>Adrien</given-names></name><role>Reviewing Editor</role><aff><institution>McGill University</institution><country>Canada</country></aff></contrib></contrib-group><contrib-group><contrib contrib-type="reviewer"><name><surname>Bagur</surname><given-names>Sophie</given-names></name><role>Reviewer</role><aff><institution>Institut Pasteur</institution><country>France</country></aff></contrib></contrib-group></front-stub><body><boxed-text id="box1"><p>Our editorial process produces two outputs: i) <ext-link ext-link-type="uri" xlink:href="https://sciety.org/articles/activity/10.1101/2021.05.28.446165">public reviews</ext-link> designed to be posted alongside <ext-link ext-link-type="uri" xlink:href="https://www.biorxiv.org/content/10.1101/2021.05.28.446165v1">the preprint</ext-link> for the benefit of readers; ii) feedback on the manuscript for the authors, including requests for revisions, shown below. We also include an acceptance summary that explains what the editors found interesting or important about the work.</p></boxed-text><p><bold>Acceptance summary:</bold></p><p>This paper describes an open-source, high accuracy, and easy-to-use toolbox for automatic sleep scoring. The toolbox also includes a set of graphic tools to visualize raw and processed data as well as scoring performance, which will be of great help for the community.</p><p><bold>Decision letter after peer review:</bold></p><p>Thank you for submitting your article &quot;A universal, open-source, high-performance tool for automated sleep staging&quot; for consideration by <italic>eLife</italic>. Your article has been reviewed by 3 peer reviewers, and the evaluation has been overseen by a Reviewing Editor and Christian Büchel as the Senior Editor. The following individual involved in review of your submission has agreed to reveal their identity: Sophie Bagur (Reviewer #1).</p><p>The reviewers have discussed their reviews with one another, and the Reviewing Editor has drafted this to help you prepare a revised submission.</p><p>Essential revisions:</p><p>This study describes an automatic sleep scoring tool, which classifies features extracted from the EEG signal using state-of-the-art machine learning techniques. The algorithm (YASA) was trained and validated on a large dataset including healthy subjects and patients, from various ethnicities and at different age. The algorithm offers a high level of sensitivity, specificity and accuracy matching or sometimes even exceeding that of typical interscorer agreement. While this open-source tool will certainly benefit the field, the three reviewers have raised major concerns that need to be addressed. The essential revision requirements are listed below, please refer to the reviewer's comments for further details.</p><p>1) The study does not cite the work of Stephansen et al., (Stephansen et al., Nature Communications 2018, doi: 10.1038/s41467-018-07229-3) in which several interesting approaches were proposed. As the same public data were used, YASA could (and certainly should) be benchmarked against this work. More generally, a short review of the existing tools, their performance and accessibility would be a welcomed addition to the introduction.</p><p>2) The performance of the algorithm (YASA) seems to be reduced when inter-human scorer confidence is low. It would be interesting to the reader to understand the underlying reasons: does it happen when states are stable or during transitions? Is there a relationship between YASA and human confusion matrices? How does the performance vary with human confidence during sleep apnea? For misclassified epochs, is the confidence lower in all stages? In the case of an error, is the second-highest probability typically the correct one?</p><p>3) The algorithm performs worse on N1 stage, older individuals and patients presenting sleep disorders (sleep fragmentation). It would be helpful to add a section to the manuscript with some considerations on how accuracy could be improved for these different issues. Finally, would it be possible to determine the origin of the accuracy variability? Do low and high accuracy sessions differ in some aspects?</p><p>4) As YASA usually performs poorly on fragmented sleep data (as acknowledged by the authors), it would be interesting to present the results of the validation test separately for the healthy volunteers (N-25) and the patients (N=55).</p><p>5) Nights were cropped to 15 minutes before and after sleep to remove irrelevant extra periods of wakefulness or artefacts on both ends of the recording. This represents an issue for the computation of important sleep measures such as sleep efficiency and latency as the onset/offset of sleep might be missed.</p><p>6) Using 30s epochs seems unnecessary with current computing resource, and this could potentially affect the resolution of the scoring. Along the same lines, using a 5min long smoothing window is not justified and may affect the resolution of transition times, especially during N1. Finally, smoothing should perhaps be assymetrical and restricted to the preceding period, not the following.</p><p>7) The study should provide more detailed regarding how the algorithm was prevented from overfitting. Furthermore, it is unclear which features were used exactly whether the features used by the algorithm can be changed by future users, this would be an interesting addition.</p><p>8) The algorithm was trained on nighttime sleep data thus cannot be immediately compared to daytime (nap) sleep scoring. It is therefore unjustified to use the word &quot;universal&quot; in the title.</p><p><italic>Reviewer #1 (Recommendations for the authors):</italic></p><p>Details of algorithm predictions:</p><p>The authors provide some evidence that the YASA algorithm tends to be mistaken and have low confidence when human inter-scorer variability is high but they only focus on transition periods. The readout of the algorithm's confidence is an interesting tool to assess this. It would therefore be useful for the authors to more systematically explore whether it is related to human scored agreement:</p><p>– Correlate epoch by epoch confidence with inter-scorer agreement both for transition and stable periods.</p><p>– YASA underperforms on sleep apnea patients, is the confidence also lower and human inter-scorer reliability lower?</p><p>– How well do YASA confusion matrices match inter-scorer confusion matrices?</p><p>The overall performance of the algorithm is well within the range of the state of the art. It would however be useful to provide some insight into why and how the algorithm fails for those data points with lower accuracy (&lt;70%):</p><p>– Does the overall confidence of the algorithm predict the overall accuracy of a given night of sleep? If so this could allow users to exclude untrustworthy nights from further analysis.</p><p>– Since accuracy varies between 90 and 65% could the authors show where this variability occurs? (ie general change in accuracy or specific sleep stages more impacted than others).</p><p>– It would be useful if the authors could provide as a supplement example predicted and ground truth hypnograms for high, low and median accuracy levels.</p><p>Possible algorithm extensions:</p><p>The use of 30s epoch is a historical quirk and a way of lightening the load on human scorers but ceases to be relevant for automated scoring, particularly given the problem arising from epochs at transition periods (ex: sleep apnea patients). The possibility of smaller windows ore sliding 30s epochs could potentially refine sleep analysis. Implementation and investigation of this may be beyond the scope of the manuscript but I feel this advantage should be at least discussed.</p><p>Methodological details:</p><p>The smoothing window used by the authors (5min) seems quite large. Such a long window could be detrimental in cases of fragmented sleep (ex: sleep apnea patients). The authors claim this allows for an optimal compromise between short and long term dynamics. Could the authors back up this claim from the literature or their own model fitting?</p><p>The parameters used for the GBM classifier are said to be chose to prevent overfitting. How was this assessed? Did the authors perform a hyperparameter search by splitting the training data set?</p><p>The YASA framework allows for artefact removal, was this step performed on the data before running the sleep staging algorithm?</p><p>Please provide a definition of the Shapley value in the methods section.</p><p><italic>Reviewer #2 (Recommendations for the authors):</italic></p><p>1. As mentioned in the previous section, I am very surprised that the work of Stephansen et al., (Stephansen et al., Nature Communications 2018, doi: 10.1038/s41467-018-07229-3) is not cited. It is extremely relevant as Stephansen et al., also used a large amount of public data to train and test an automated sleep scoring algorithm (based on neural networks). They are very similar ideas developed in this article (for example they also introduced the use of probabilistic scoring with hypnodensities). Some ideas could also be worth implementing with the proposed algorithm such as testing the impact of common sleep disturbances or shortening the epoch window. Finally, most if not all the data used in Stephansen et al., are available on the SleepData.org platform (used by the authors) so the authors could directly benchmark the performance of the two approaches. From my personal experience, Stephansen algorithm has three disadvantages compared to the present algorithm: (i) it is slower and heavier, (ii) it requires python machine-learning packages such as TensorFlow, which are frequently updated, (iii) it is very difficult to modify and understand how it works (black box). I think it would be interesting for the authors to show how their approach could mitigate these issues.</p><p>2. The tool would greatly benefit from a graphical interface to install and use the software. Another interesting function could be to process a list of EDF files (for example, all the EDF files in a given folder). From personal experience again, an automated sleep scoring algorithm will not be used in clinical settings at a large scale without a GUI.</p><p>3. I think the algorithm will be closer to the current consensus if the smoothing was restricted to preceding and not following epochs. Also, could the authors examine the impact of the duration of the smoothing period on performance? A too large smoothing might decrease the performance for transitory stages such as N1.</p><p>4. Since the proposed algorithms can provide a probabilistic score, it would be interesting to explore further the differences between the human gold-standard scores and the algorithm. For example, for misclassified epochs, is the confidence lower in all stages? In the case of an error, is the second-highest probability typically the correct one? Related to the same point, when writing &quot;for epochs ﬂagged by the algorithm as high-conﬁdence ({greater than or equal to}80% conﬁdence) than in epochs with a conﬁdence below 80%&quot;, can the authors indicate the % of epochs {greater than or equal to} and &lt; to 80% confidence? Could the authors show the distribution of these confidences per sleep stage?</p><p>5. In the &quot;Descriptive Statistics&quot; section, could the authors add a table assessing the difference between the training and test sets for the variables mentioned in the text?</p><p>6. How was the AHI obtained? Was it provided for each dataset and individual or computed by the authors?</p><p>7. &quot;These results match recently developed deep-learning-based algorithms for automatic sleep staging (Guillot et al., 2020; Perslev et al., 2021).&quot; Citing the Stephansen paper is important here, especially since the authors could apply their algorithms to the same data. Also, the Stephansen studies should be cited when discussing the advantage of a probabilistic scoring (they coined the term hypnodensity).</p><p>8. Out of curiosity, could the list of features used by the algorithms be changed by future users? This could be an interesting feature for future developments.</p><p><italic>Reviewer #3 (Recommendations for the authors):</italic></p><p>In this study, Vallat and Walker describe a new sleep scoring tool that is based on a classification algorithm using machine-learning approaches in which a set of features is extracted from the EEG signal. The algorithm was trained and validated on a very large number of nocturnal sleep datasets including participants with various ethnicities, age and health status. Results show that the algorithm offers a high level of sensitivity, specificity and accuracy matching or sometimes even exceeding that of typical interscorer agreement. Importantly, a measure of the algorithm's confidence is provided for each scored epoch in order to guide users during their review of the output. The software is described as easy to use, computationally low-demanding, open source and free.</p><p>This paper addresses an important need in the field of sleep research. There is indeed a lack of accurate, flexible and open source sleep scoring tools. I would like to commend the authors for their efforts in providing such a tool for the community and for their adherence to the open science framework as the data and codes related to the current manuscript are made available. I predict that this automated tool will be of use for a large number of researchers in the field. I also enjoyed reading the paper that is nicely written. However, I have some concerns listed below that need to be addressed and I also provided comments that might help improving the overall quality of the paper.</p><p>– There are some overstatements that need to be toned down.</p><p>– In the title, the word &quot;universal&quot; should be removed. The tool was trained and validated on nocturnal sleep data. Sleep characteristics (eg duration and distribution of sleep stages etc.) are different, for example, during diurnal sleep (nap) and the algorithm might not perform as well on nap data. Note that there is a large number of scientific studies in which diurnal, instead of nocturnal, sleep paradigms are used as these paradigms are easier to implement in lab settings. The algorithm being optimized for nocturnal sleep (with eg the definition of specific sleep stage weights that are specific to nocturnal recordings), it is unknown how it would perform on nap data for example.</p><p>– In the abstract, the following sentence needs to be altered: &quot;This tool offers high sleep-staging accuracy matching or exceeding human accuracy&quot;. Exceeding human accuracy might be misleading as human scores are used as the ground-truth in the validation process. The algorithm exceeds the accuracy of some human scorers and matches the scores of the best scorer.</p><p>– Acknowledgement of – and comparisons to – already available tools in the field</p><p>There are plenty of automated sleep scoring tools available in the field (most of them are not open source and rather expensive though – as noted by the authors). A short review of the existing tools, their performance and accessibility would be a welcomed addition to the introduction. In line with this comment, other published algorithms were tested on the same set of data used to train and validate the present algorithm. The authors refer to their work for comparison between algorithms but it would be a very nice addition to the paper to provide (and test for) such comparisons. It is currently unclear whether the present algorithm performs any better than algorithms already available in the field.</p><p>– Further improvements</p><p>The algorithm performs worse on N1 stage, older individuals and patients presenting sleep disorders (sleep fragmentation). It would be helpful to add a section to the manuscript with some considerations on how accuracy could be improved for these different issues. Eg, should one consider training the algorithm on older datasets in order to improve accuracy of scoring when studying aging? Same applies to sleep disorders. It is currently unclear whether the variety of datasets used to train the algorithm is beneficial in these cases.</p><p>In the same vein, as algorithms usually perform poorly on fragmented sleep data (as acknowledged by the authors), it would be interesting to present the results of the validation test separately for the healthy volunteers (N-25) and the patients (N=55).</p><p>– Justification for some methodological choices</p><p>– Nights were cropped to 15 minutes before and after sleep to remove irrelevant extra periods of wakefulness or artefacts on both ends of the recording. This represents an issue for the computation of important sleep measures such as sleep efficiency and latency as the onset/offset of sleep might be missed.</p><p>– How were features selected? A description of the features needs to be provided. Which features were Z scored exactly and why not all?</p><p>– The custom sleep stage weights procedure is unclear. Why was only a sub-sample used to determine best weights?</p><p>– Was the smoothing done with 5min or 15min rolling average? While it is critical to include this temporal window, it looks rather wide. Human scorers usually don't go that far back when scoring but usually just a few epochs (ie 2-3 which is 1min30). What was the rational for choosing such a wide temporal window?</p><p>– It is currently unclear when / how the EEG and EMG data were analyzed.</p></body></sub-article><sub-article article-type="reply" id="sa2"><front-stub><article-id pub-id-type="doi">10.7554/eLife.70092.sa2</article-id><title-group><article-title>Author response</article-title></title-group></front-stub><body><disp-quote content-type="editor-comment"><p>Essential revisions:</p><p>This study describes an automatic sleep scoring tool, which classifies features extracted from the EEG signal using state-of-the-art machine learning techniques. The algorithm (YASA) was trained and validated on a large dataset including healthy subjects and patients, from various ethnicities and at different age. The algorithm offers a high level of sensitivity, specificity and accuracy matching or sometimes even exceeding that of typical interscorer agreement. While this open-source tool will certainly benefit the field, the three reviewers have raised major concerns that need to be addressed. The essential revision requirements are listed below, please refer to the reviewer's comments for further details.</p><p>1) The study does not cite the work of Stephansen et al., (Stephansen et al., Nature Communications 2018, doi: 10.1038/s41467-018-07229-3) in which several interesting approaches were proposed. As the same public data were used, YASA could (and certainly should) be benchmarked against this work. More generally, a short review of the existing tools, their performance and accessibility would be a welcomed addition to the introduction.</p></disp-quote><p>Thanks so much for pointing this out. We have now added this relevant reference throughout the manuscript. To build on the reviewer’s point, the current algorithm and Stephansen’s algorithm did not use the same public data. The Stephansen 2018 algorithm was trained and validated on “10 different cohorts recorded at 12 sleep centers across 3 continents: SSC, WSC, IS-RC, JCTS, KHC1, AHC, IHC, DHC, FHC and CNC”, none of which are included in the training/testing sets of the current algorithm. Nevertheless, we certainly agree that the manuscript will benefit from a more extensive comparison against existing tools. To this end, we have made several major modifications to the manuscript.</p><p>First, we have added a dedicated paragraph in the Introduction to review existing sleep staging algorithms:</p><p>“Advances in machine-learning have led efforts to classify sleep with automated systems. Indeed, recent years have seen the emergence of several automatic sleep staging algorithms. While an exhaustive review of the existing sleep staging algorithms is out of the scope of this article, we review below — in chronological order — some of the most significant algorithms of the last five years. For a more in-depth review, we refer the reader to Fiorillo et al., 2019. The Sun et al., 2017 algorithm was trained on 2,000 PSG recordings from a single sleep clinic. The overall Cohen's kappa on the testing set was 0.68 (n=1,000 PSG nights). The “Z3Score” algorithm (Patanaik et al., 2018) was trained and evaluated on ~1,700 PSG recordings from four datasets, with an overall accuracy ranging from 89.8% in healthy adults/adolescents to 72.1% in patients with Parkinson’s disease. The freely available “Stanford-stage” algorithm (Stephansen et al., 2018) was trained and evaluated on 10 clinical cohorts (~3,000 recordings). The overall accuracy was 87% against the consensus scoring of several human experts in an independent testing set. The “SeqSleepNet” algorithm (Phan et al., 2019) was trained and tested using a 20-fold cross-validation on 200 nights (overall accuracy = 87.1%). Finally, the recent U-Sleep algorithm (Perslev et al., 2021) was trained and evaluated on PSG recordings from 15,660 participants of 16 clinical studies. While the overall accuracy was not reported, the mean F1-score against the consensus scoring of five human experts was 0.79 for healthy adults and 0.76 for patients with sleep apnea.”</p><p>Second, and importantly, we now perform an in-depth comparison of YASA’s performance against the Stephansen 2018 algorithm and the Perslev 2021 algorithm using the same data for all three datasets. Specifically, we have applied the three algorithms to each night of the Dreem Open Datasets (DOD) and compared their performance in dedicated tables in the Results section (Table 2 and Table 3). This procedure is fully described in a new “Comparison against existing algorithms” subsection of the Methods. None of these algorithms included nights from the DOD in their training set, thus ensuring a fair comparison of the three algorithms. Related to point 4 of the Essential Revisions, performance of the three algorithms are reported separately for healthy individuals (DOD-Healthy, n=25) and patients with sleep apnea (DOD-Obstructive, n=50). To facilitate future validation of our algorithm, we also provide the predicted hypnograms of each night in Supplementary File 1 (healthy) and Supplementary File 2 (patients).</p><p>Overall, the comparison results show that YASA’s accuracy is not significantly different from the Stephansen 2018 algorithm for both healthy adults and patients with obstructive sleep apnea. The accuracy of the Perslev 2021 algorithm is not significantly different from YASA in healthy adults, but is higher in patients with sleep apnea. However, it should be noted that while the YASA algorithm only uses one central EEG, one EOG and one EMG, the Perslev 2021 algorithm uses all available EEGs as well as two EOGs. This suggests that adding more EEG channels and/or using the two EOGs may improve the performance of YASA in patients with sleep apnea. Though an important counterpoint is that YASA requires a far less extensive array of data (channels) to accomplish very similar levels of accuracy, which has the favorable benefit of reducing analysis computational and processing demands, improves speed of analysis (i.e. a few seconds per recording versus ~10 min for the Stephansen 2018 algorithm), and is amenable to more data recordings since many may not have sufficient EEG channels. All these points are now discussed in detail in the new “Limitations and future directions” subsection of the Discussion (see point 3 of the Essential Revisions).</p><p>As an example of these incorporated changes include new Table 2, which shows the comparison of YASA against the consensus scoring, each of the individual human scorers as well as the Stephansen 2018 and Perslev 2018 algorithms.</p><disp-quote content-type="editor-comment"><p>2) The performance of the algorithm (YASA) seems to be reduced when inter-human scorer confidence is low. It would be interesting to the reader to understand the underlying reasons: does it happen when states are stable or during transitions? Is there a relationship between YASA and human confusion matrices? How does the performance vary with human confidence during sleep apnea? For misclassified epochs, is the confidence lower in all stages? In the case of an error, is the second-highest probability typically the correct one?</p></disp-quote><p>We have now conducted additional analyses to examine the relationship between YASA and the human inter-rater agreement, as advised by the reviewer. Building on that analysis, we have revised the Results sections in several ways. First, for the “Testing set 2” subsection of the Results, we now state:</p><p>“Additional analyses on the combined dataset (n=75 nights, healthy and patients combined) revealed three key findings. First, the accuracy of YASA against the consensus scoring was significantly higher during stable epochs compared to transition epochs (mean ± STD: 91.2 ± 7.8 vs 68.95 ± 7.7, p&lt;0.001), or in epochs that were marked as high confidence by the algorithm (93.9 ± 6.0 vs 64.1 ± 7.0 for low confidence epochs, p&lt;0.001). Second, epochs with unanimous consensus from the five human experts were four times more likely to occur during stable epochs than transition epochs (46.2 ± 12.1 percent of all epochs vs 11.5 ± 4.9%, p&lt;0.001) and also four times more likely to occur during epochs marked as high confidence (≥80%) by the algorithm (46.4 ± 12.9 percent of all epochs vs 11.3 ± 5.7%, p&lt;0.001). Third, there was a significant correlation between the percentage of epochs marked as high confidence by YASA and the percent of epochs with unanimous consensus (r=0.561, p&lt;0.001), meaning that YASA was overall more confident in recordings with higher human inter-rater agreement.”</p><p>For the “Testing set 1” subsection of the Results, we have further added the following:</p><p>“The median confidence of the algorithm across all the testing nights was 85.79%. Nights with a higher average confidence had significantly higher accuracy (Figure 1B, r=0.76, p&lt;0.001). […] In addition, when the algorithm misclassified an epoch, the second highest-probability stage predicted by the algorithm was the correct one in 76.3 ± 12.6 percent of the time.”</p><p>In addition, we have revised the “Moderator analyses” subsection:</p><p>“Fourth, sleep apnea, and specifically the apnea-hypopnea index (AHI) was negatively correlated with accuracy (r=-0.29, p&lt;0.001, Figure 2E), as well as the overall confidence level of the algorithm (calculated by averaging the epoch-by-epoch confidence across the entire night, r=-0.339, p&lt;0.001). This would indicate that, to a modest degree, the performance and confidence of the algorithm can lessen in those with severe sleep apnea indices, possibly mediated by an increased number of stage transitions in patients with sleep apnea (see above stage transition findings). Consistent with the latter, the percentage of (human-defined) stage transitions was significantly correlated with the AHI (r=0.427, p&lt;0.001).”</p><p>Finally, the confusion matrices of each individual human scorer and each algorithm can now be found in Supplementary Materials (Figure 1—figure supplement 3-6).</p><p>Confusion matrices are reported separately for healthy adults and patients with sleep apnea.</p><disp-quote content-type="editor-comment"><p>3) The algorithm performs worse on N1 stage, older individuals and patients presenting sleep disorders (sleep fragmentation). It would be helpful to add a section to the manuscript with some considerations on how accuracy could be improved for these different issues. Finally, would it be possible to determine the origin of the accuracy variability? Do low and high accuracy sessions differ in some aspects?</p></disp-quote><p>We have addressed these helpful questions with two key revisions to the manuscript. First, we have now added a “Limitations and Future Directions” subsection in the Discussion to present ideas for improving the algorithm, with a particular focus on fragmented nights and/or nights from patients with sleep disorders:</p><p>“Despite its numerous advantages, there are limitations to the algorithm that must be considered. These are discussed below, together with ideas for future improvements of the algorithm. First, while the accuracy of YASA against consensus scoring was not significantly different from the Stephansen 2018 and Perslev 2021 algorithms on healthy adults, it was significantly lower than the latter algorithm on patients with obstructive sleep apnea. The Perslev 2021 algorithm used all available EEGs and two (bilateral) EOGs, whereas YASA’s scoring was based on one central EEG, one EOG and one EMG. This suggests that one way to improve performance in this population could be the inclusion of more EEG channels and/or bilateral EOGs. For instance, using the negative product of bilateral EOGs may increase sensitivity to rapid eye movements in REM sleep or slow eye movements in N1 sleep (Stephansen et al., 2018; Agarwal et al., 2005). Interestingly, the Perslev 2021 algorithm does not use an EMG channel, which is consistent with our observation of a negligible benefit on accuracy when adding EMG to the model. This may also indicate that while the current set of features implemented in the algorithm performs well for EEG and EOG channels, it does not fully capture the meaningful dynamic information nested within muscle activity during sleep.”</p><p>Second, we have now conducted a random forest analysis to identify the main contributors of accuracy variability. The analysis is described in detail in the “Moderator Analyses” subsection of the Results as well as Supplementary File 3b, the revision now states:</p><p>“To better understand how these moderators influence variability in accuracy, we quantified the relative contribution of the moderators using a random forest analysis. Specifically, we included all aforementioned demographics variables in the model, together with medical diagnosis of depression, diabetes, hypertension and insomnia, and features extracted from the ground-truth sleep scoring such as the percentage of each sleep stage, the duration of the recording and the percentage of stage transitions in the hypnograms. The outcome variable of the model was the accuracy score of YASA against ground-truth sleep staging, calculated separately for each night. All the nights in the testing set 1 were included, leading to a sample size of 585 unique nights. Results are presented in Supplementary File 3b. The percentage of N1 sleep and percentage of stage transitions — both markers of sleep fragmentation — were the two top predictors of accuracy, accounting for 40% of the total relative importance. By contrast, the combined contribution of age, sex, race and medical diagnosis of insomnia, hypertension, diabete and depression accounted for roughly 10% of the total importance.”</p><disp-quote content-type="editor-comment"><p>4) As YASA usually performs poorly on fragmented sleep data (as acknowledged by the authors), it would be interesting to present the results of the validation test separately for the healthy volunteers (N-25) and the patients (N=55).</p></disp-quote><p>As requested by the reviewer, we now analyze and report the performance of YASA on the DOD testing set separately for healthy individuals (DOD-healthy) and patients with obstructive sleep apnea (DOD-Obstructive), which can be found in section “Testing set 2”</p><disp-quote content-type="editor-comment"><p>5) Nights were cropped to 15 minutes before and after sleep to remove irrelevant extra periods of wakefulness or artefacts on both ends of the recording. This represents an issue for the computation of important sleep measures such as sleep efficiency and latency as the onset/offset of sleep might be missed.</p></disp-quote><p>This truncation step has now been removed from the pipeline and all the results have been updated accordingly. In addition, we have also removed all other exclusion criteria (e.g. PSG data quality, recording duration, etc) to improve the generalization power of the algorithm, thanks to the suggestions of the reviewer.</p><disp-quote content-type="editor-comment"><p>6) Using 30s epochs seems unnecessary with current computing resource, and this could potentially affect the resolution of the scoring. Along the same lines, using a 5min long smoothing window is not justified and may affect the resolution of transition times, especially during N1. Finally, smoothing should perhaps be assymetrical and restricted to the preceding period, not the following.</p></disp-quote><p>Scoring resolution</p><p>We have now added the following paragraph in the “Limitations and Future Directions” subsection of the Discussion:</p><p>“Unlike other deep-learning based algorithms (e.g. Stephansen et al., 2018; Perslev et al., 2021), the algorithm does not currently have the ability to score in shorter resolution. We think however that this is not a significant limitation of our work. First, without exception, all of the datasets used either in the training or testing the current algorithm were visually scored by experts using a 30-seconds resolution. Therefore, even if our algorithm was able to generate sleep scores in a shorter resolution, comparison against the ground-truth would require downsampling the predictions to a 30-sec resolution and thus losing the benefit of the shorter resolution. A proper implementation of a shorter resolution scoring requires to train and validate the model on ground-truth sleep scores of the same temporal resolution. Second, the use of 30-sec epochs remains the gold-standard (as defined in the most recent version of the AASM manual) and as such, the vast majority of sleep centers across the world still rely on 30-sec staging. Provided that datasets with sleep scoring at shorter resolution (e.g. 5, 10, 15 seconds) becomes common, the current algorithm could be re-trained to yield such higher-resolution predictions. In that case, the minimum viable resolution would be 5-seconds, which is the length of the Fast Fourier Transform used to calculate the spectral powers.”</p><p>Temporal smoothing</p><p>We have also conducted a new analysis of the influence of the temporal smoothing on the performance. The results are described in Supplementary File 3a. Briefly, using a cross-validation approach, we have tested a total of 49 combinations of time lengths for the past and centered smoothing windows. Results demonstrated that the best performance is obtained when using a 2 min past rolling average in combination with a 7.5 minutes centered, triangular-weighted rolling average. Removing the centered rolling average resulted in poorer performance, suggesting that there is an added benefit of incorporating data from both before and after the current epoch. Removing both the past and centered rolling averages resulted in the worst performance (-3.6% decrease in F1-macro). Therefore, the new version of the manuscript and algorithm now uses a 2 min past and 7.5 min centered rolling averages. All the results in the manuscript have been updated accordingly. We have now edited the “Smoothing and normalization” subsection of the Methods section as follow:</p><p>“In particular, the features were first duplicated and then smoothed using two different rolling windows: (1) a 7.5 minutes centered, and triangular-weighted rolling average (i.e. 15 epochs centered around the current epoch with the following weights: [0.125, 0.25, 0.375, 0.5, 0.625, 0.75, 0.875, 1., 0.875, 0.75, 0.625, 0.5, 0.375, 0.25, 0.125]), and (2) a rolling average of the last 2 minutes prior to the current epoch. The optimal time length of these two rolling windows was found using a parameter search with cross-validation (Supplementary File 3a). […] The final model includes the 30-sec based features in original units (no smoothing or scaling), as well as the smoothed and normalized version of these raw features.”</p><disp-quote content-type="editor-comment"><p>7) The study should provide more detailed regarding how the algorithm was prevented from overfitting.</p></disp-quote><p>We have now edited the “Machine-learning classification” subsection of the Methods as follow:</p><p>“The full training dataset was then fitted with a LightGBM classifier (Ke et al., 2017) — a tree-based gradient-boosting classifier using the following hyper-parameters: 500 estimators, maximum tree depth of 5, maximum number of leaves per tree of 90 and a fraction of 60% of all features selected at random when building each tree. These parameters were chosen to prevent overfitting of the classifier while still maximizing accuracy. Specifically, we performed an automated search of the best hyper-parameters using a 3-fold cross-validation on the entire training set. A total of 96 possible combinations of hyper-parameters were tested on the following hyper-parameters: number of estimators, number of leaves, maximum tree depth and feature fraction (which are the most important parameters for controlling overfitting, see the documentation of LightGBM). Importantly, the loss function was defined as:</p><p><inline-formula><mml:math id="sa2m1"><mml:mrow><mml:mrow><mml:mo form="prefix" stretchy="true">|</mml:mo><mml:msub><mml:mtext mathvariant="normal">acc</mml:mtext><mml:mtext mathvariant="normal">train</mml:mtext></mml:msub><mml:mo>−</mml:mo><mml:msub><mml:mtext mathvariant="normal">acc</mml:mtext><mml:mtext mathvariant="normal">test</mml:mtext></mml:msub><mml:mo form="postfix" stretchy="true">|</mml:mo></mml:mrow><mml:mo>+</mml:mo><mml:mn>4</mml:mn><mml:mo>*</mml:mo><mml:mo form="prefix" stretchy="false">(</mml:mo><mml:mn>1</mml:mn><mml:mo>−</mml:mo><mml:msub><mml:mtext mathvariant="normal">acc</mml:mtext><mml:mtext mathvariant="normal">test</mml:mtext></mml:msub><mml:mo form="postfix" stretchy="false">)</mml:mo></mml:mrow></mml:math></inline-formula>where <inline-formula><mml:math id="sa2m2"><mml:msub><mml:mtext mathvariant="normal">acc</mml:mtext><mml:mtext mathvariant="normal">test</mml:mtext></mml:msub></mml:math></inline-formula> and <inline-formula><mml:math id="sa2m3"><mml:msub><mml:mtext mathvariant="normal">acc</mml:mtext><mml:mtext mathvariant="normal">train</mml:mtext></mml:msub></mml:math></inline-formula> are the average cross-validated test / train accuracy, respectively. In other words, the best set of hyper-parameters must maximize the cross-validated accuracy but also minimize the difference in accuracy between the train and test set. To retain optimal performance, the latter was, however, down-weighted by a factor of 4 relative to the former.”</p><disp-quote content-type="editor-comment"><p>Furthermore, it is unclear which features were used exactly whether the features used by the algorithm can be changed by future users, this would be an interesting addition.</p></disp-quote><p>We have edited the “Preprocessing and features extraction” subsection of the Methods to clarify which features were used, and also make clear the fact that the algorithm includes <italic>both</italic> the raw features (no smoothing, no scaling) and the smoothed-normalized version of these features:</p><p>“All code used to compute these features is made open-source and freely available to all (see Data and code availability). The complete list of features included in the final model can be found <ext-link ext-link-type="uri" xlink:href="https://github.com/raphaelvallat/yasa/blob/master/yasa/staging.py">here</ext-link>. […] The final model includes the 30-sec based features in original units (no smoothing or scaling), as well as the smoothed and normalized version of these raw features.”</p><p>Furthermore, we have added a dedicated paragraph in the “Limitations and future directions” subsection of the Discussion to explain how and when the features should be changed by future users:</p><p>“A final limitation is that the algorithm is tailored to human scalp data. As such, individuals that may want to use YASA to score intracranial human data, animal data or even human data from a very specific population will need to adjust the algorithm for their own needs. There are two levels at which the algorithm can be modified. First, an individual may want to re-train the classifier on a specific population without modifying the underlying features. Such flexibility is natively supported by the algorithm and no modifications to the original source code of YASA will be required. Second, in some cases (e.g. rodents data), the features may need to be modified as well to capture different aspects and dynamics of the input data (e.g. rodents or human intracranial data). In that case, the users will need to make modifications to the source code of the algorithm, and thus have some knowledge of Python and Git — both of which are now extensively teached in high schools and universities<sup>8,9</sup>. Of note, the entire feature extraction pipeline takes only ~100 lines of code and is based on standard scientific Python libraries such as NumPy, SciPy and Pandas.”</p><p><sup>8</sup> https://wiki.python.org/moin/SchoolsUsingPython</p><p><sup>9</sup> https://education.github.com/schools</p><disp-quote content-type="editor-comment"><p>8) The algorithm was trained on nighttime sleep data thus cannot be immediately compared to daytime (nap) sleep scoring. It is therefore unjustified to use the word &quot;universal&quot; in the title.</p></disp-quote><p>Thanks for this thoughtful point. We have now removed the word “universal” from the title. Furthermore, we now discuss the fact that the algorithm has not been validated on naps data in the “Limitations and Future Directions” of the Discussion:</p><p>“Third, the algorithm was exclusively tested and evaluated on full nights PSG recordings, and as such its performance on shorter recordings such as daytime naps is unknown. Further testing of the algorithm is therefore required to validate the algorithm on naps. While YASA can process input data of arbitrary length, performance may be reduced on data that are shorter than the longest smoothing windows used by the algorithm (i.e. 7.5 minutes).”</p><disp-quote content-type="editor-comment"><p>Reviewer #1 (Recommendations for the authors):</p><p>Details of algorithm predictions:</p><p>The authors provide some evidence that the YASA algorithm tends to be mistaken and have low confidence when human inter-scorer variability is high but they only focus on transition periods. The readout of the algorithm's confidence is an interesting tool to assess this. It would therefore be useful for the authors to more systematically explore whether it is related to human scored agreement:</p><p>– Correlate epoch by epoch confidence with inter-scorer agreement both for transition and stable periods.</p><p>– YASA underperforms on sleep apnea patients, is the confidence also lower and human inter-scorer reliability lower?</p><p>– How well do YASA confusion matrices match inter-scorer confusion matrices?</p></disp-quote><p>We have now conducted several additional analyses to examine the relationship between human inter-rater agreement and YASA’s confidence levels. These are described in full in point 2 of the Essential Revisions. Briefly, our results show that:</p><p>1. On the DOD testing set, epochs with unanimous human consensus are four times more likely to occur during stable periods and/or during epochs flagged as high-confidence by the algorithm.</p><p>2. On the DOD testing set, YASA is more confident in nights with a higher average human inter-rater agreement (correlation r = 0.56, p&lt;0.001).</p><p>3. On the NSRR testing set (which includes the AHI score for each night), the overall confidence level of the algorithm declines with increasing AHI (r=-0.339, p&lt;0.001).</p><p>Furthermore, as discussed in point 1 of the Essential Revisions, we now report pairwise comparisons of YASA’s performance against each individual human scorer, for both overall accuracy and stage-specific F1-scores. In addition, we have added the confusion matrices of YASA and each individual human scorer to the Supplementary Materials, separately for healthy individuals and patients with obstructive sleep apnea (Figure 1—figure supplement 3-6).</p><disp-quote content-type="editor-comment"><p>The overall performance of the algorithm is well within the range of the state of the art. It would however be useful to provide some insight into why and how the algorithm fails for those data points with lower accuracy (&lt;70%):</p><p>– Does the overall confidence of the algorithm predict the overall accuracy of a given night of sleep? If so this could allow users to exclude untrustworthy nights from further analysis.</p></disp-quote><p>The overall confidence of the algorithm for a given night does indeed predict the accuracy for that same night. As described in the Results section:</p><p>“The median confidence of the algorithm across all the testing nights was 85.79%. Nights with a higher average confidence had significantly higher accuracy (Figure 1B, r=0.76, p&lt;0.001).”</p><disp-quote content-type="editor-comment"><p>– Since accuracy varies between 90 and 65% could the authors show where this variability occurs? (ie general change in accuracy or specific sleep stages more impacted than others).</p></disp-quote><p>This has been addressed in point 3 of the Essentials Revisions (random forest analysis of the contributors of accuracy variability).</p><disp-quote content-type="editor-comment"><p>– It would be useful if the authors could provide as a supplement example predicted and ground truth hypnograms for high, low and median accuracy levels.</p></disp-quote><p>We have now added two supplementary files with the predicted hypnograms for each night of the DOD-Healthy and DOD-Obstructive datasets. In addition with YASA’s predicted hypnograms, the supplementary files also include the ground-truth hypnogram (consensus scoring) as well as the Stephansen 2018 and Perslev 2021 hypnograms. Nights in the PDF files are ranked in descending order of agreement between YASA and the consensus scoring. <xref ref-type="fig" rid="sa2fig1">Author response image 1</xref> shows an example of a single night in the PDF files.</p><fig id="sa2fig1" position="float"><label>Author response image 1.</label><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-70092-sa2-fig1-v1.tif"/></fig><disp-quote content-type="editor-comment"><p>Possible algorithm extensions:</p><p>The use of 30s epoch is a historical quirk and a way of lightening the load on human scorers but ceases to be relevant for automated scoring, particularly given the problem arising from epochs at transition periods (ex: sleep apnea patients). The possibility of smaller windows ore sliding 30s epochs could potentially refine sleep analysis. Implementation and investigation of this may be beyond the scope of the manuscript but I feel this advantage should be at least discussed.</p></disp-quote><p>Please refer to point 6 of the Essential Revisions (“Scoring Resolution” subsection).</p><disp-quote content-type="editor-comment"><p>Methodological details:</p><p>The smoothing window used by the authors (5min) seems quite large. Such a long window could be detrimental in cases of fragmented sleep (ex: sleep apnea patients). The authors claim this allows for an optimal compromise between short and long term dynamics. Could the authors back up this claim from the literature or their own model fitting?</p></disp-quote><p>This has been addressed in point 6 of the Essential Revisions (“Temporal Smoothing” subsection).</p><disp-quote content-type="editor-comment"><p>The parameters used for the GBM classifier are said to be chose to prevent overfitting. How was this assessed? Did the authors perform a hyperparameter search by splitting the training data set?</p></disp-quote><p>Thanks for this. We refer the reviewer to point 7 of the Essential Revisions where we address just this important issue.</p><disp-quote content-type="editor-comment"><p>The YASA framework allows for artefact removal, was this step performed on the data before running the sleep staging algorithm?</p></disp-quote><p>We did not apply artefact removal prior to running the algorithm. This has been clarified in the Methods section:</p><p>“No artefact removal was applied to the PSG data before running the sleep staging algorithm.”</p><disp-quote content-type="editor-comment"><p>Please provide a definition of the Shapley value in the methods section.</p></disp-quote><p>We have now added a dedicated “Features Importance” section in the Methods:</p><p>“Feature importance was measured on the full training set using the Shapley Additive Explanation algorithm (SHAP; Lundberg et al., 2020). Shapley values, which originate from game theory, have several desirable properties which make them optimal for evaluating features contribution in machine-learning. Formally, a Shapley value is the average marginal contribution of a feature value across all possible combinations of features. The SHAP contribution of a given feature was computed by first summing the absolute Shapley values on all epochs and then averaging across all sleep stages, thus leading to a single importance score for each feature.”</p><disp-quote content-type="editor-comment"><p>Reviewer #2 (Recommendations for the authors):</p><p>1. As mentioned in the previous section, I am very surprised that the work of Stephansen et al., (Stephansen et al., Nature Communications 2018, doi: 10.1038/s41467-018-07229-3) is not cited. It is extremely relevant as Stephansen et al., also used a large amount of public data to train and test an automated sleep scoring algorithm (based on neural networks). They are very similar ideas developed in this article (for example they also introduced the use of probabilistic scoring with hypnodensities). Some ideas could also be worth implementing with the proposed algorithm such as testing the impact of common sleep disturbances or shortening the epoch window. Finally, most if not all the data used in Stephansen et al., are available on the SleepData.org platform (used by the authors) so the authors could directly benchmark the performance of the two approaches. From my personal experience, Stephansen algorithm has three disadvantages compared to the present algorithm: (i) it is slower and heavier, (ii) it requires python machine-learning packages such as TensorFlow, which are frequently updated, (iii) it is very difficult to modify and understand how it works (black box). I think it would be interesting for the authors to show how their approach could mitigate these issues.</p></disp-quote><p>This was a great idea. Towards that end, we have now done so, and describe the details of this extensive revision in point 1 of the Essential Revisions.</p><disp-quote content-type="editor-comment"><p>2. The tool would greatly benefit from a graphical interface to install and use the software. Another interesting function could be to process a list of EDF files (for example, all the EDF files in a given folder). From personal experience again, an automated sleep scoring algorithm will not be used in clinical settings at a large scale without a GUI.</p></disp-quote><p>We indeed agree that the absence of graphical user interface (GUI) may prevent wide adoption of our software, especially in clinical settings. We note, however, that designing and maintaining a cross-platform GUI is virtually impossible without dedicated funding and/or a full-time software engineer. While it is therefore unlikely that YASA will have a GUI in the near future, we have made efforts to integrate the outputs of the algorithm with existing sleep GUIs. For instance, the sleep scores can be loaded and edited in several free GUIs, such as EDFBrowser, Visbrain (Python) or SleepTrip (Matlab). We have now added this point in the “Limitations and future directions” subsection of the Discussion:</p><p>“Second, an obstacle to the wide adoption of the current algorithm is the absence of a graphical user interface (GUI). Designing and maintaining an open-source cross-platform GUI is in itself a herculean task that requires dedicated funding and software engineers. Rather, significant efforts have been made to facilitate the integration of YASA’s outputs to existing sleep GUIs. Specifically, the online documentation of the algorithm includes examples on how to load and edit the sleep scores in several free GUIs, such as EDFBrowser, Visbrain and SleepTrip.”</p><p>Please see <xref ref-type="fig" rid="sa2fig2">Author response image 2</xref> for a screenshot of the online documentation.</p><fig id="sa2fig2" position="float"><label>Author response image 2.</label><graphic mime-subtype="tiff" mimetype="image" xlink:href="elife-70092-sa2-fig2-v1.tif"/></fig><p>Furthermore, we have now added a code snippet illustrating how to run the sleep scoring on all the EDF files present in a folder at once. This is now mentioned in the “Software implementation” subsection of the Results:“The general workflow to perform the automatic sleep staging is described below. In addition, we provide code snippets showing the simplest usage of the algorithm on a single EDF file (Figure S8) or on a folder with multiple EDF files (Figure S9).”</p><disp-quote content-type="editor-comment"><p>3. I think the algorithm will be closer to the current consensus if the smoothing was restricted to preceding and not following epochs. Also, could the authors examine the impact of the duration of the smoothing period on performance? A too large smoothing might decrease the performance for transitory stages such as N1.</p></disp-quote><p>This has been addressed in point 6 of the Essential Revisions (“Temporal Smoothing” subsection).</p><disp-quote content-type="editor-comment"><p>4. Since the proposed algorithms can provide a probabilistic score, it would be interesting to explore further the differences between the human gold-standard scores and the algorithm. For example, for misclassified epochs, is the confidence lower in all stages? In the case of an error, is the second-highest probability typically the correct one?</p></disp-quote><p>Great questions. We refer the reviewer to point 2 of the Essential Revisions where we address both.</p><disp-quote content-type="editor-comment"><p>Related to the same point, when writing &quot;for epochs ﬂagged by the algorithm as high-conﬁdence ({greater than or equal to}80% conﬁdence) than in epochs with a conﬁdence below 80%&quot;, can the authors indicate the % of epochs {greater than or equal to} and &lt; to 80% confidence? Could the authors show the distribution of these confidences per sleep stage?</p></disp-quote><p>We have now added a supplementary figure showing the distribution of confidence levels for each stage:</p><p>“Similarly, and as expected, accuracy was significantly greater for epochs flagged by the algorithm as high-confidence (≥80% confidence) than in epochs with a confidence below 80% (95.90 ± 3.70% and 62.91 ± 6.61% respectively, p&lt;0.001). The distribution of confidence levels across sleep stages is shown in Figure 1—figure supplement 2. The algorithm was most confident in epochs scored as wakefulness by the human scorer (mean confidence across all epochs = 92.7%) and least confident in epochs scored as N1 sleep (mean = 63.2%).”</p><disp-quote content-type="editor-comment"><p>5. In the &quot;Descriptive Statistics&quot; section, could the authors add a table assessing the difference between the training and test sets for the variables mentioned in the text?</p></disp-quote><p>In the revision, we now provide a new table (Table 1) that includes demographics/health data of the training and testing sets as well as statistical comparison between the two.</p><p>Furthermore, we have now added the following paragraph in the Results section:</p><p>“Demographics and health data of the testing set 1 are shown in Table 1. Importantly, although participants were randomly assigned in the training/testing sets, there were some significant differences between these two sets. Specifically, age and BMI were lower in the testing set compared to the original training set (p’s &lt; 0.05), although the effect sizes of these differences were all below 0.17 (considered small or negligible). Importantly, there was no significant difference in the sex ratio, race distribution, or in the proportion of individuals diagnosed with insomnia, depression or diabetes. Furthermore, there was no difference in AHI and the proportion of individuals with minimal, mild, moderate or severe sleep apnea.”</p><disp-quote content-type="editor-comment"><p>6. How was the AHI obtained? Was it provided for each dataset and individual or computed by the authors?</p></disp-quote><p>The AHI was pre-calculated and provided with each dataset on the <ext-link ext-link-type="uri" xlink:href="http://sleepdata.org">NSRR website</ext-link>. Specifically, we used the “ahi_a0h3” variable, which is the Apnea-Hypopnea Index (AHI) &gt;= 3% – number of [all apneas] and [hypopneas with &gt;= 3% oxygen desaturation] per hour of sleep. This has now been clarified in the Methods section of the manuscript:</p><p>“Demographics and health data such as the age, sex, race/ethnicity, body mass index (BMI), apnea-hypopnea index (AHI, 3% desaturation), as well as medical diagnosis of insomnia, depression, diabete, hypertension were also provided for each dataset.”</p><disp-quote content-type="editor-comment"><p>7. &quot;These results match recently developed deep-learning-based algorithms for automatic sleep staging (Guillot et al., 2020; Perslev et al., 2021).&quot; Citing the Stephansen paper is important here, especially since the authors could apply their algorithms to the same data. Also, the Stephansen studies should be cited when discussing the advantage of a probabilistic scoring (they coined the term hypnodensity).</p></disp-quote><p>We have now added the Stephansen 2018 citation throughout the manuscript (see also point 1 of the Essential Revisions).</p><disp-quote content-type="editor-comment"><p>8. Out of curiosity, could the list of features used by the algorithms be changed by future users? This could be an interesting feature for future developments.</p></disp-quote><p>We refer the reviewer to point 8 of the Essential Revisions.</p><disp-quote content-type="editor-comment"><p>Reviewer #3 (Recommendations for the authors):</p><p>In this study, Vallat and Walker describe a new sleep scoring tool that is based on a classification algorithm using machine-learning approaches in which a set of features is extracted from the EEG signal. The algorithm was trained and validated on a very large number of nocturnal sleep datasets including participants with various ethnicities, age and health status. Results show that the algorithm offers a high level of sensitivity, specificity and accuracy matching or sometimes even exceeding that of typical interscorer agreement. Importantly, a measure of the algorithm's confidence is provided for each scored epoch in order to guide users during their review of the output. The software is described as easy to use, computationally low-demanding, open source and free.</p><p>This paper addresses an important need in the field of sleep research. There is indeed a lack of accurate, flexible and open source sleep scoring tools. I would like to commend the authors for their efforts in providing such a tool for the community and for their adherence to the open science framework as the data and codes related to the current manuscript are made available. I predict that this automated tool will be of use for a large number of researchers in the field. I also enjoyed reading the paper that is nicely written. However, I have some concerns listed below that need to be addressed and comments that might help improving the overall quality of the paper.</p></disp-quote><p>– There are some overstatements that need to be toned down.</p><disp-quote content-type="editor-comment"><p>– In the title, the word &quot;universal&quot; should be removed. The tool was trained and validated on nocturnal sleep data. Sleep characteristics (eg duration and distribution of sleep stages etc.) are different, for example, during diurnal sleep (nap) and the algorithm might not perform as well on nap data. Note that there is a large number of scientific studies in which diurnal, instead of nocturnal, sleep paradigms are used as these paradigms are easier to implement in lab settings. The algorithm being optimized for nocturnal sleep (with eg the definition of specific sleep stage weights that are specific to nocturnal recordings), it is unknown how it would perform on nap data for example.</p></disp-quote><p>The word “universal” has now been removed from the title. Thanks for that point. Furthermore, we have added a “Limitations and future directions” subsection in the Discussion, which includes among others the fact that the algorithm was trained and validated only on nocturnal data, and as such may not be as accurate for daytime naps data:</p><p>“Third, the algorithm was exclusively tested and evaluated on full nights PSG recordings, and as such its performance on shorter recordings such as daytime naps is unknown. Further testing of the algorithm is therefore required to validate the algorithm on naps. While YASA can process input data of arbitrary length, performance may be reduced on data that are shorter than the longest smoothing windows used by the algorithm (i.e. 7.5 minutes).”</p><disp-quote content-type="editor-comment"><p>– In the abstract, the following sentence needs to be altered: &quot;This tool offers high sleep-staging accuracy matching or exceeding human accuracy&quot;. Exceeding human accuracy might be misleading as human scores are used as the ground-truth in the validation process. The algorithm exceeds the accuracy of some human scorers and matches the scores of the best scorer.</p></disp-quote><p>The abstract has been edited as follow:</p><p>“This tool offers high sleep-staging accuracy matching human accuracy and interscorer agreement no matter the population kind.”</p><disp-quote content-type="editor-comment"><p>– Acknowledgement of – and comparisons to – already available tools in the field</p><p>There are plenty of automated sleep scoring tools available in the field (most of them are not open source and rather expensive though – as noted by the authors). A short review of the existing tools, their performance and accessibility would be a welcomed addition to the introduction. In line with this comment, other published algorithms were tested on the same set of data used to train and validate the present algorithm. The authors refer to their work for comparison between algorithms but it would be a very nice addition to the paper to provide (and test for) such comparisons. It is currently unclear whether the present algorithm performs any better than algorithms already available in the field.</p></disp-quote><p>This has been addressed in point 1 of the Essential Revisions.</p><disp-quote content-type="editor-comment"><p>– Further improvements</p><p>The algorithm performs worse on N1 stage, older individuals and patients presenting sleep disorders (sleep fragmentation). It would be helpful to add a section to the manuscript with some considerations on how accuracy could be improved for these different issues. Eg, should one consider training the algorithm on older datasets in order to improve accuracy of scoring when studying aging? Same applies to sleep disorders. It is currently unclear whether the variety of datasets used to train the algorithm is beneficial in these cases.</p></disp-quote><p>As discussed in point 3 of the Essential Revisions, we have now added a “Limitations and future directions” subsection in the Discussion to present several ideas for improving the algorithm, especially in sleep-disordered patients.</p><disp-quote content-type="editor-comment"><p>In the same vein, as algorithms usually perform poorly on fragmented sleep data (as acknowledged by the authors), it would be interesting to present the results of the validation test separately for the healthy volunteers (N-25) and the patients (N=55).</p></disp-quote><p>The performance of the algorithm on the DOD testing set is now reported separately for healthy adults and patients with sleep disorders (point 4 of the Essential Revisions).</p><disp-quote content-type="editor-comment"><p>– Justification for some methodological choices</p><p>– Nights were cropped to 15 minutes before and after sleep to remove irrelevant extra periods of wakefulness or artefacts on both ends of the recording. This represents an issue for the computation of important sleep measures such as sleep efficiency and latency as the onset/offset of sleep might be missed.</p></disp-quote><p>This truncation has now been removed from the pipeline and all the results have been updated accordingly. Thanks for that.</p><disp-quote content-type="editor-comment"><p>– How were features selected? A description of the features needs to be provided.</p></disp-quote><p>We have edited the “Features extraction” subsection of the Methods as follow:</p><p>“These features were selected based on prior work in features-based classification algorithms for automatic sleep staging (Krakovská and Mezeiová 2011; Lajnef et al., 2015; Sun et al., 2017). For example, it was previously reported that the permutation entropy of the EOG/EMG and the EEG spectral powers in the traditional frequency bands are the most important features for accurate sleep staging (Lajnef et al., 2015), thus warranting their inclusion in the current algorithm. Several other features are derived from the authors’ own works with entropy/fractal dimension metrics<sup>1</sup>. Importantly, the features included in the current algorithm were chosen to be robust to different recording montages. As such, we did not include features that are dependent on the phase of the signal, and/or that require specific events detection (e.g. slow-waves, rapid eye movements). However, the time-domain features are dependent upon the amplitude of the signal, and sleep staging may fail if the input data is not expressed in standard unit (uV) or has been z-scored prior to applying the algorithm.”</p><p><sup>1</sup> https://github.com/raphaelvallat/antropy</p><disp-quote content-type="editor-comment"><p>Which features were Z scored exactly and why not all?</p></disp-quote><p>The full model includes both the original features in raw units (no smoothing or normalization), as well as the normalized-smoothed version of these features. This has now been clarified in the manuscript:</p><p>“To take this into account, all the smoothed features were then z-scored across each night, i.e. expressed as a deviation from the night’s average. The inclusion of such normalized features aids in accommodating the error-potential impact of inter-individual variability upon the algorithm, and thus improves final accuracy. The final model includes the 30-sec based features in original units (no smoothing or scaling), as well as the smoothed and normalized version of these raw features. The raw features were included to increase the temporal specificity and keep absolute values that can be compared across individuals regardless of inter-individual variability.”</p><disp-quote content-type="editor-comment"><p>– The custom sleep stage weights procedure is unclear. Why was only a sub-sample used to determine best weights?</p></disp-quote><p>Subsampling was initially performed to improve speed of the parameter search, but to address this concern, we now use the full training set to find the best class weights. In addition, we now provide more details on the procedure in the Methods section:</p><p>“The best weights were found by running a cross-validated parameter search on the full training set, with the average of the accuracy and F1-scores as the optimization metric. A total of 324 possible combinations of class weights were tested. The parameter space was defined as the cartesian product of N1: [1.6, 1.8, 2, 2.2], N2: [0.8, 0.9, 1], N3 / REM / Wake: [1, 1.2, 1.4]. The best weights were: 2.2 for N1, 1 for N2 and Wake, 1.2 for N3 and and 1.4 for REM. Python code for the grid search of the best class weights can be found <ext-link ext-link-type="uri" xlink:href="https://github.com/raphaelvallat/yasa_classifier/blob/master/gridsearch_weights.py">here</ext-link>”.</p><disp-quote content-type="editor-comment"><p>– Was the smoothing done with 5min or 15min rolling average? While it is critical to include this temporal window, it looks rather wide. Human scorers usually don't go that far back when scoring but usually just a few epochs (ie 2-3 which is 1min30). What was the rational for choosing such a wide temporal window?</p></disp-quote><p>We apologize for the confusion caused by a typographical error in the previous version of our manuscript. We did not use a 15 min rolling average. Instead, temporal smoothing was previously performed using two distinct rolling windows, i.e. 1) a 5.5-minutes centered (symmetric, 11 epochs), triangular-weighted rolling average, and 2) a rolling average of the last 5 minutes (10 epochs) prior to the current epoch. As requested by the reviewer, we have now added an extensive comparison of the impact of the length of the rolling window on the overall performance of the algorithm, which led us to update the length of the rolling windows. A full summary can be found in point 6 of the Essential Revisions (“Temporal smoothing”).</p><disp-quote content-type="editor-comment"><p>– It is currently unclear when / how the EEG and EMG data were analyzed.</p></disp-quote><p>As indicated in earlier comments, the “Features extraction” subsection of the Methods has been extensively reworked in order to clarify some details on PSG signal preprocessing and features computation.</p></body></sub-article></article>