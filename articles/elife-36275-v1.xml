<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE article PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD v1.1 20151215//EN"  "JATS-archivearticle1.dtd"><article article-type="research-article" dtd-version="1.1" xmlns:ali="http://www.niso.org/schemas/ali/1.0/" xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink"><front><journal-meta><journal-id journal-id-type="nlm-ta">elife</journal-id><journal-id journal-id-type="publisher-id">eLife</journal-id><journal-title-group><journal-title>eLife</journal-title></journal-title-group><issn pub-type="epub" publication-format="electronic">2050-084X</issn><publisher><publisher-name>eLife Sciences Publications, Ltd</publisher-name></publisher></journal-meta><article-meta><article-id pub-id-type="publisher-id">36275</article-id><article-id pub-id-type="doi">10.7554/eLife.36275</article-id><article-categories><subj-group subj-group-type="display-channel"><subject>Tools and Resources</subject></subj-group><subj-group subj-group-type="heading"><subject>Neuroscience</subject></subj-group></article-categories><title-group><article-title>Real-time classification of experience-related ensemble spiking patterns for closed-loop applications</article-title></title-group><contrib-group><contrib contrib-type="author" corresp="yes" id="author-108544"><name><surname>Ciliberti</surname><given-names>Davide</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">http://orcid.org/0000-0003-1229-642X</contrib-id><email>davide.ciliberti@nerf.be</email><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="aff" rid="aff3">3</xref><xref ref-type="fn" rid="con1"/><xref ref-type="fn" rid="conf1"/><xref ref-type="other" rid="dataset1"/></contrib><contrib contrib-type="author" id="author-108543"><name><surname>Michon</surname><given-names>Frédéric</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">http://orcid.org/0000-0003-1289-2133</contrib-id><email>frederic.michon@nerf.be</email><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="aff" rid="aff3">3</xref><xref ref-type="fn" rid="con2"/><xref ref-type="fn" rid="conf1"/><xref ref-type="other" rid="dataset1"/></contrib><contrib contrib-type="author" corresp="yes" id="author-107724"><name><surname>Kloosterman</surname><given-names>Fabian</given-names></name><contrib-id authenticated="true" contrib-id-type="orcid">http://orcid.org/0000-0001-6680-9660</contrib-id><email>fabian.kloosterman@nerf.be</email><xref ref-type="aff" rid="aff1">1</xref><xref ref-type="aff" rid="aff2">2</xref><xref ref-type="aff" rid="aff3">3</xref><xref ref-type="aff" rid="aff4">4</xref><xref ref-type="other" rid="fund1"/><xref ref-type="fn" rid="con3"/><xref ref-type="fn" rid="conf1"/><xref ref-type="other" rid="dataset1"/></contrib><aff id="aff1"><label>1</label><institution>Neuro-Electronics Research Flanders</institution><addr-line><named-content content-type="city">Leuven</named-content></addr-line><country>Belgium</country></aff><aff id="aff2"><label>2</label><institution content-type="dept">Brain and Cognition</institution><institution>KU Leuven</institution><addr-line><named-content content-type="city">Leuven</named-content></addr-line><country>Belgium</country></aff><aff id="aff3"><label>3</label><institution>VIB</institution><addr-line><named-content content-type="city">Leuven</named-content></addr-line><country>Belgium</country></aff><aff id="aff4"><label>4</label><institution>imec</institution><addr-line><named-content content-type="city">Leuven</named-content></addr-line><country>Belgium</country></aff></contrib-group><contrib-group content-type="section"><contrib contrib-type="editor"><name><surname>Colgin</surname><given-names>Laura</given-names></name><role>Reviewing Editor</role><aff><institution>The University of Texas at Austin, Center for Learning and Memory</institution><country>United States</country></aff></contrib><contrib contrib-type="senior_editor"><name><surname>Marder</surname><given-names>Eve</given-names></name><role>Senior Editor</role><aff><institution>Brandeis University</institution><country>United States</country></aff></contrib></contrib-group><pub-date date-type="publication" publication-format="electronic"><day>30</day><month>10</month><year>2018</year></pub-date><pub-date pub-type="collection"><year>2018</year></pub-date><volume>7</volume><elocation-id>e36275</elocation-id><history><date date-type="received" iso-8601-date="2018-02-27"><day>27</day><month>02</month><year>2018</year></date><date date-type="accepted" iso-8601-date="2018-09-27"><day>27</day><month>09</month><year>2018</year></date></history><permissions><copyright-statement>© 2018, Ciliberti et al</copyright-statement><copyright-year>2018</copyright-year><copyright-holder>Ciliberti et al</copyright-holder><ali:free_to_read/><license xlink:href="http://creativecommons.org/licenses/by/4.0/"><ali:license_ref>http://creativecommons.org/licenses/by/4.0/</ali:license_ref><license-p>This article is distributed under the terms of the <ext-link ext-link-type="uri" xlink:href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution License</ext-link>, which permits unrestricted use and redistribution provided that the original author and source are credited.</license-p></license></permissions><self-uri content-type="pdf" xlink:href="elife-36275-v1.pdf"/><abstract><object-id pub-id-type="doi">10.7554/eLife.36275.001</object-id><p>Communication in neural circuits across the cortex is thought to be mediated by spontaneous temporally organized patterns of population activity lasting ~50 –200 ms. Closed-loop manipulations have the unique power to reveal direct and causal links between such patterns and their contribution to cognition. Current brain–computer interfaces, however, are not designed to interpret multi-neuronal spiking patterns at the millisecond timescale. To bridge this gap, we developed a system for classifying ensemble patterns in a closed-loop setting and demonstrated its application in the online identification of hippocampal neuronal replay sequences in the rat. Our system decodes multi-neuronal patterns at 10 ms resolution, identifies within 50 ms experience-related patterns with over 70% sensitivity and specificity, and classifies their content with 95% accuracy. This technology scales to high-count electrode arrays and will help to shed new light on the contribution of internally generated neural activity to coordinated neural assembly interactions and cognition.</p></abstract><kwd-group kwd-group-type="author-keywords"><kwd>neural decoding</kwd><kwd>hippocampal replay</kwd><kwd>memory</kwd></kwd-group><kwd-group kwd-group-type="research-organism"><title>Research organism</title><kwd>Rat</kwd></kwd-group><funding-group><award-group id="fund1"><funding-source><institution-wrap><institution-id institution-id-type="FundRef">http://dx.doi.org/10.13039/501100003130</institution-id><institution>Fonds Wetenschappelijk Onderzoek</institution></institution-wrap></funding-source><award-id>G0D7516N</award-id><principal-award-recipient><name><surname>Kloosterman</surname><given-names>Fabian</given-names></name></principal-award-recipient></award-group><funding-statement>The funders had no role in study design, data collection and interpretation, or the decision to submit the work for publication.</funding-statement></funding-group><custom-meta-group><custom-meta specific-use="meta-only"><meta-name>Author impact statement</meta-name><meta-value>A brain–computer interface for real-time identification of transient neural activity patterns enables causal inference of the role of these patterns in cognition through closed-loop manipulation.</meta-value></custom-meta></custom-meta-group></article-meta></front><body><sec id="s1" sec-type="intro"><title>Introduction</title><p>Distributed and temporally organized patterns of spiking activity in cortical circuits reflect the processing of sensory information, the execution of cognitive tasks and the generation of motor commands. Large-scale recordings have revealed the presence of brief (50–200 ms) multi-neuronal spiking sequences in cortical networks. The brief sequences appear as rapid increases in the multi-unit firing rate and they are generated endogenously or in response to an external stimulus (<xref ref-type="bibr" rid="bib43">Luczak et al., 2009</xref><xref ref-type="bibr" rid="bib42">Luczak et al., 2007</xref>; <xref ref-type="bibr" rid="bib43">Luczak et al., 2009</xref>; <xref ref-type="bibr" rid="bib56">Pasquale et al., 2017</xref>; <xref ref-type="bibr" rid="bib57">Pastalkova et al., 2008</xref>; <xref ref-type="bibr" rid="bib69">Riehle et al., 1997</xref>). The omnipresence of these activity patterns in the cortical mantle suggests that they constitute the basic elements of the cortical neural code (<xref ref-type="bibr" rid="bib25">Harris, 2005</xref>; <xref ref-type="bibr" rid="bib44">Luczak, 2015</xref>).</p><p>Multi-neuronal sequential firing patterns have been extensively studied in the hippocampus, in large part because of the comprehensive characterization of a well-defined spatial code (<xref ref-type="bibr" rid="bib54">O’Keefe and Nadel, 1978</xref>). In rodents, large-scale recordings revealed the occurrence of accelerated ‘replays’ of the spatial information encoded in the population activity during an experience (e.g. traversal of an arm in a maze), both during sleeping and when in a resting state (<xref ref-type="bibr" rid="bib7">Davidson et al., 2009</xref>; <xref ref-type="bibr" rid="bib10">Diba and Buzsáki, 2007</xref>; <xref ref-type="bibr" rid="bib14">Foster and Wilson, 2006</xref>; <xref ref-type="bibr" rid="bib30">Karlsson and Frank, 2009</xref>; <xref ref-type="bibr" rid="bib39">Lee and Wilson, 2002</xref>; <xref ref-type="bibr" rid="bib84">Wilson and McNaughton, 1994</xref>). Structured firing of experience-related activity was also reported in entorhinal (<xref ref-type="bibr" rid="bib55">O’Neill et al., 2017</xref>; <xref ref-type="bibr" rid="bib51">Ólafsdóttir et al., 2016</xref>), neocortical (<xref ref-type="bibr" rid="bib26">Hoffman and McNaughton, 2002</xref>; <xref ref-type="bibr" rid="bib29">Ji and Wilson, 2007</xref>; <xref ref-type="bibr" rid="bib61">Peyrache et al., 2009</xref>; <xref ref-type="bibr" rid="bib67">Qin et al., 1997</xref>; <xref ref-type="bibr" rid="bib68">Ribeiro et al., 2004</xref>; <xref ref-type="bibr" rid="bib70">Rothschild et al., 2017</xref>) and subcortical (<xref ref-type="bibr" rid="bib18">Girardeau et al., 2017</xref>; <xref ref-type="bibr" rid="bib19">Gomperts et al., 2015</xref>; <xref ref-type="bibr" rid="bib35">Lansink et al., 2008</xref>; <xref ref-type="bibr" rid="bib59">Pennartz et al., 2004</xref>; <xref ref-type="bibr" rid="bib79">Valdés et al., 2015</xref>) circuits.</p><p>Correlative analyses of the multi-neuronal spike content of hippocampal replay suggest that distinct replay sequences might be used for sharing information with the neocortex, specifically for system-level memory consolidation (<xref ref-type="bibr" rid="bib4">Axmacher et al., 2009</xref>; <xref ref-type="bibr" rid="bib11">Dupret et al., 2010</xref>; <xref ref-type="bibr" rid="bib40">Lewis and Durrant, 2011</xref>) and for the creation and update of an internal model for covert evaluation of possible outcomes during memory-guided decision-making (<xref ref-type="bibr" rid="bib53">Ólafsdóttir et al., 2018</xref>; <xref ref-type="bibr" rid="bib52">Ólafsdóttir et al., 2017</xref>; <xref ref-type="bibr" rid="bib60">Penny et al., 2013</xref>; <xref ref-type="bibr" rid="bib62">Pezzulo et al., 2014</xref>; <xref ref-type="bibr" rid="bib63">Pezzulo et al., 2017</xref>;<xref ref-type="bibr" rid="bib62">Pezzulo et al., 2014</xref>; <xref ref-type="bibr" rid="bib64">Pfeiffer and Foster, 2013</xref>;<xref ref-type="bibr" rid="bib85">Wu et al., 2017</xref>). Closed-loop manipulations of replay-related activity are to date limited to the use of real-time detection of fast sharp-wave ripple (SWR) oscillations (120 – 250 Hz) (<xref ref-type="bibr" rid="bib12">Ego-Stengel and Wilson, 2010</xref>; <xref ref-type="bibr" rid="bib16">Girardeau et al., 2009</xref>; <xref ref-type="bibr" rid="bib17">Girardeau et al., 2014</xref>; <xref ref-type="bibr" rid="bib28">Jadhav et al., 2012</xref>; <xref ref-type="bibr" rid="bib34">Kovács et al., 2016</xref>; <xref ref-type="bibr" rid="bib46">Maingret et al., 2016</xref>;<xref ref-type="bibr" rid="bib48">Nokia et al., 2010</xref>; <xref ref-type="bibr" rid="bib49">Nokia et al., 2012</xref>; <xref ref-type="bibr" rid="bib50">Novitskaya et al., 2016</xref>; <xref ref-type="bibr" rid="bib72">Roux et al., 2017</xref>; <xref ref-type="bibr" rid="bib77">Talakoub et al., 2016</xref>; <xref ref-type="bibr" rid="bib80">van de Ven et al., 2016</xref>) that reflect merely the bursting state of the neuronal population but not the actual replay content. Any causal link between replay content and behavior or physiology thus remains untested.</p><p>To provide a direct causal link between a specific transient neural activity pattern and its hypothesized contribution to cognition, correlational and computational studies are not sufficient and a closed-loop manipulation is necessary (<xref ref-type="bibr" rid="bib23">Hady, 2016</xref>; <xref ref-type="bibr" rid="bib65">Potter et al., 2014</xref>; <xref ref-type="bibr" rid="bib90">Zrenner et al., 2016</xref>). A critical element for ‘closing the loop’ around a neural pattern of interest is the ability to detect such pattern in real-time (<xref ref-type="bibr" rid="bib20">Grosenick et al., 2015</xref>), but a complete methodology for detecting (re)expressed spike patterns within tens of milliseconds has not yet been demonstrated.</p><p>The rapid detection of multi-neuronal patterns in a closed-loop setting is challenging because offline identification algorithms generally require all data to be available or are otherwise not suitable for an online scenario. Moreover, the algorithms often have intensive computational demands that pose challenges for real-time execution at tens of millisecond latency. Such requirements are not present in brain–computer interfaces (BCIs) and other neuroprostheses for motor control as they generally operate sufficiently with latencies of 120 – 200 ms (<xref ref-type="bibr" rid="bib27">Ibáñez et al., 2014</xref>; <xref ref-type="bibr" rid="bib82">Velliste et al., 2008</xref>; <xref ref-type="bibr" rid="bib87">Xu et al., 2014</xref>), one order of magnitude greater than is required for the rapid detection of transient cortical multi-neuronal sequences.</p><p>To bridge this gap, we devised a system for online spike pattern detection with minimal computational time delays. The system builds on our previous work describing an efficient offline implementation of spike-sorting-less neural decoding (<xref ref-type="bibr" rid="bib33">Kloosterman et al., 2014</xref>; <xref ref-type="bibr" rid="bib75">Sodkomkham et al., 2016</xref>) and a general software framework (Falcon) for complex online neural processing in closed-loop settings (<xref ref-type="bibr" rid="bib6">Ciliberti and Kloosterman, 2017</xref>). Here, we added parallelized neural decoding to Falcon and built on top a concrete implementation of a full real-time spike pattern identification and classification system.</p><p>Using this novel closed-loop system, we performed real-time population decoding of spatial information from CA1 assemblies at the stringent 10 ms temporal resolution and detected distinct classes of replay at a low 50 ms average latency. Real-time identification of population bursts with replay had more than 70% average sensitivity and specificity, whereas content classification accuracy was on average over 95%. We demonstrated this technology in a freely behaving rat during both resting and awake states using in vivo large-scale recordings. We also illustrated that detection algorithm parameters can be adjusted, depending on the requirements of the experiment, to trade off sensitivity and specificity or latency and accuracy. We further showed how detection performance is affected by the number of recording channels.</p><p>Our ready-to-use brain–computer interface will enable, for the first time, selective manipulation of specific hippocampal and extra-hippocampal ensemble firing sequences at a millisecond timescale and will thus pave the way towards a deeper understanding of their contribution to cognitive processes.</p></sec><sec id="s2" sec-type="results"><title>Results</title><p>We built a fully functional closed-loop system for real-time detection and identification of replay patterns. Our system addressed three general major technical challenges. The first challenge derives from the desire to respond to an identified replay as soon as possible after the event has started (and well before it is over). Thus, the determination of replay content should be completed with minimal data, which inevitably introduces a trade-off between algorithmic detection latency and detection accuracy. Second, any approach for online detection of hippocampal replay content must be suitable for data arriving as a continuous live stream; in such a scenario, the exact start (and end) times of replay events are unknown and cannot be predicted. The constraints of the online scenario require the implementation to make use of past-observed information only. As a third challenge, the real-time computations needed to identify replay content in the continuous high-volume and high-rate stream should only minimally increase the overall detection latency, which should be dominated by its algorithmic contribution. The need for fast computations introduces another possible latency–accuracy trade-off, in which approximate algorithms may be required to meet real-time deadlines.</p><p>Built on top of the Falcon open source framework for closed-loop neuroscience (<xref ref-type="bibr" rid="bib6">Ciliberti and Kloosterman, 2017</xref>), the system reads and processes a continuous stream of multi-channel neural signals, analyzes the signals to search for potential replay events and emits a digital output pulse upon the detection of a replay event containing target content (<xref ref-type="fig" rid="fig1">Figure 1a</xref>, <xref ref-type="fig" rid="fig1s1">Figure 1—figure supplement 1a</xref>). We defined the target as a replay trajectory of one of the tracks in a multi-arm maze (e.g. a Y-maze). To detect replay content, we applied neural population decoding followed by the characterization of the spatial-temporal structure in the decoded locations (<xref ref-type="fig" rid="fig1">Figure 1b</xref>), similar to the approach that is often used for offline replay analysis (<xref ref-type="bibr" rid="bib7">Davidson et al., 2009</xref>; <xref ref-type="bibr" rid="bib32">Kloosterman, 2011</xref>). The incoming data stream is continuously decoded in 10 ms bins and, on the basis of the most recent 30 ms of decoded spiking activity, an assessment is made of whether or not a population burst with replay of one of the maze arms is present.</p><fig-group><fig id="fig1" position="float"><object-id pub-id-type="doi">10.7554/eLife.36275.002</object-id><label>Figure 1.</label><caption><title>Online decoding and detection of hippocampal replay content for closed-loop scenarios.</title><p>(<bold>a</bold>) Schematic overview of a system for online identification and classification of hippocampal replay content. Top: during the initial active exploration of a 3-arm maze, the relation between the animal’s location and hippocampal population spiking activity is captured in an encoding model for subsequent online neural decoding. Bottom: streaming neural data are processed and analyzed in real-time to detect replay events with user-defined target content. Upon positive detection of a target, closed-loop feedback is provided to the animal within the lifetime of the replay event. (<bold>b</bold>) Algorithm for online classification of replay content. The top two plots show a raster of all spikes detected on a 14-tetrode array and the corresponding posterior probability distributions for location in the maze generated for non-overlapping 10-ms bins (gray scale maps to 0–0.1 probability). The lower three plots show the internal variables used by the online algorithm to identify and classify replay content. In the bottom plot, gray/black ticks indicate the lack/presence of content consistency across three consecutive bins. Red line: detection triggered when all variables reach preset thresholds (dashed lines for multi-unit activity (MUA) and sharpness, black tick for content consistency). (<bold>c</bold>) Effect of varying levels of compression on decoding performance and computing time. For the test dataset, compression thresholds in the range [1, 2.5] reduce the decode time to less than 1 ms per spike without affecting the accuracy of decoding the animal’s location in 200 ms time bins during active exploration of a 3-arm maze. Decoding performance was assessed using a 2-fold cross-validation procedure. Inset: full cumulative distributions of decoding error for varying compression thresholds. (<bold>d</bold>) Effect of compression on posterior probability distributions computed for 10-ms bins in candidate replay bursts. For each level of compression, the plot shows the fraction of posteriors for which the maximum-a-posteriori (MAP) estimate changes to a maze arm different from the no-compression reference condition. Modest compression levels (<inline-formula><mml:math id="inf1"><mml:mo>≤</mml:mo></mml:math></inline-formula>2) have only a small effect on the MAP estimate, in particular for the most informative posterior distributions with MAP probability &gt; 0.05. (<bold>e</bold>) Distribution of added latency, that is the time between the acquisition of the most recent 10 ms of raw data and the availability of the posterior probability distribution computed on the same data. Black vertical line represents median latency. Note that online spike extraction, neural decoding and online replay classification add a lag of less than 2 ms.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-36275-fig1-v1"/></fig><fig id="fig1s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.36275.003</object-id><label>Figure 1—figure supplement 1.</label><caption><title>Neural decoding and replay identification over streaming data.</title><p>(<bold>a</bold>) Falcon graph that implemented the real-time processing pipeline of online neural decoding and replay identification and classification. Each box represents a processor node that ran in a separate thread of execution in the central processing unit (CPU). Black arrows indicate ring buffers for data sharing between two connected processors. The first three serially connected processor nodes are responsible respectively for reading the incoming User Datagram Protocol (UDP) packets from the data acquisition system, parsing from the packets the relevant information about the multi-channel signals and dispatching the signals to the downstream processors. The dispatcher processor node streams data to a set of parallel pipelines, each processing data recorded from a different tetrode. Each parallel pipeline has three serially connected processor nodes that are used for digital filtering, spike detection and on-the-fly kernel density estimation of the joint amplitude-position probability density of the spike-sorting-free decoder, which uses the pre-loaded offline-generated encoding models. The likelihoods generated by decoder nodes, each for a different tetrode, are fed into the 'population decoder' node, which produces the final posterior probability distribution of the animal’s real or replayed position. Posterior probability data is streamed to a 'run decoder' node for estimating the animal’s real position and to a 'replay content classifier' node for online detection of a replay content. The output of these nodes are fed to 'file serializer' nodes for data dump (used in post-hoc analysis) and to a 'digital output' node for triggering a closed-loop transistor–transistor logic (TTL) pulse via the dedicated hardware. (<bold>b</bold>) Flow diagram of the algorithm for replay content identification and classification in streaming data. In the implementation of the 'replay classifier node', an additional check for the sharpness of the most recent 10 ms time bin is performed (threshold was set to<inline-formula><mml:math id="inf2"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>h</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>p</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>). In the software implementation, all criteria are evaluated with an AND condition.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-36275-fig1-figsupp1-v1"/></fig><fig id="fig1s2" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.36275.004</object-id><label>Figure 1—figure supplement 2.</label><caption><title>Added latency remains low with higher channel counts and spike rates.</title><p>Stress tests used a full decoding pipeline with injected spikes at a predetermined rate. (<bold>a</bold>) Left: tests performed on a workstation with four physical cores. Thick lines: median. Shaded region: 95% confidence interval (CI). Right: tests performed on workstation with 32 cores. (<bold>b</bold>) Distribution of actual per-tetrode spike rate in rest (left) and in run (right). Vertical black lines represent median values.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-36275-fig1-figsupp2-v1"/></fig><fig id="fig1s3" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.36275.005</object-id><label>Figure 1—figure supplement 3.</label><caption><title>Run decoding performance.</title><p>(<bold>a</bold>) Cross-validated decoding performance in RUN1 for all maze arms combined and separately for each arm. Boxes indicate median in-arm error and inter-quartile range. Whiskers indicate most extreme point within 1.5x the inter-quartile range. Horizontal gray line indicates median in-arm error for all arms. Percentages at the top represent the fraction of position estimates that were located in the correct arm. (<bold>b</bold>) Decoding performance in RUN2 using an encoding model built from spiking data in RUN1.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-36275-fig1-figsupp3-v1"/></fig><fig id="fig1s4" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.36275.006</object-id><label>Figure 1—figure supplement 4.</label><caption><title>Decoding performance during exploration in all three datasets as a function of the training time and corresponding number of laps used to build the encoding model.</title><p>(<bold>a</bold>) Median in-arm decoding error. Top, REST; bottom, RUN2. (<bold>b</bold>) Fraction of position estimates that were located in the correct arm. Top, REST; bottom, RUN2.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-36275-fig1-figsupp4-v1"/></fig></fig-group><p>In the online replay classification algorithm, burst and content detections are combined (<xref ref-type="fig" rid="fig1">Figure 1c</xref>, <xref ref-type="fig" rid="fig1s1">Figure 1—figure supplement 1b</xref>, see 'Materials and methods'). The burst detection component responds to the crossing of a user-defined threshold (<inline-formula><mml:math id="inf3"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>u</mml:mi><mml:mi>a</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>) in the causal moving average of multi-unit activity (MUA). The content detection component searches for sharp high-fidelity position estimates that are consistently located in the same maze arm in the last three 10-ms time bins. The sharpness of the estimates is computed as the causal moving average of the locally integrated probability around the maximum-a-posteriori (MAP) estimate and needs to cross a user-defined threshold (<inline-formula><mml:math id="inf4"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>h</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>p</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>). A replay event is identified if the burst, sharpness and consistency conditions are all met simultaneously.</p><p>The algorithms for neural decoding and replay content detection were adapted to fit the specific constraints of the online use case. In our approach, the most demanding computation is the online evaluation of the encoding model that directly relates spike waveform features to the animal’s position without the need for prior spike sorting (<xref ref-type="bibr" rid="bib33">Kloosterman et al., 2014</xref>). Modest compression of the encoding model reduced the computational costs, resulting in an online decode time below 1 ms per spike, without affecting the system's ability to decode the animal’s position during run epochs (<xref ref-type="fig" rid="fig1">Figure 1c</xref>). The effect of compression on the integrity of posterior probability distributions in candidate replay population bursts is small for low to moderate compression levels, in particular for posteriors that have a MAP estimate with high probability (<xref ref-type="fig" rid="fig1">Figure 1d</xref>).</p><p>Overall, the implementation of the algorithms, including the spike-by-spike construction of posterior probability distributions and parallel processing (see 'Materials and methods'), made sure that the determination of replay content and the triggering of a corresponding digital output pulse occurred within 2.2 ms of the time at which the neural data were acquired in over 95% of the cases (<xref ref-type="fig" rid="fig1">Figure 1e</xref>; median added latency: 1.1 ms). Stress tests of the system with artificially generated spikes showed that the added latency remains low for high per-tetrode spike rates and for a large number of tetrodes (up to 32) on a 32-core workstation (<xref ref-type="fig" rid="fig1s2">Figure 1—figure supplement 2a</xref>), thus demonstrating the scalability of our solution. Additional tests on a 4-core workstation revealed that added latency has higher variability, especially in the case of 32 tetrodes and high spike rates (<xref ref-type="fig" rid="fig1s2">Figure 1—figure supplement 2a</xref>), but that performance is similar to that of the 32-core workstation for up to 24 tetrodes and per-tetrode spike rates that match our datasets (<xref ref-type="fig" rid="fig1s2">Figure 1—figure supplement 2b</xref>).</p><sec id="s2-1"><title>Real-time detection of replay content during resting and awake states</title><p>To test our closed-loop framework of online detection of replay content, we recorded hippocampal ensemble activity using tetrodes in a rat that repeatedly explored the arms of a 3-arm radial maze. In each of the three separate recording sessions, a first exposure to the maze (RUN1) was used to prepare the encoding model for online neural decoding. Cross-validation showed good decoding performance in RUN1 with a median error below 10 cm (<xref ref-type="fig" rid="fig1s3">Figure 1—figure supplement 3a</xref>), which required only a few traversals of the maze (<xref ref-type="fig" rid="fig1s4">Figure 1—figure supplement 4</xref>). Real-time closed-loop replay content detection was activated in a subsequent rest epoch (REST) and in a second exposure to the radial maze (RUN2). The encoding model built using data from RUN1 was also valid for decoding the animal’s position in RUN2 (<xref ref-type="fig" rid="fig1s3">Figure 1—figure supplement 3b</xref>), indicating that recordings were stable and spatial representations had not remapped (<xref ref-type="bibr" rid="bib3">Anderson and Jeffery, 2003</xref>; <xref ref-type="bibr" rid="bib37">Latuske et al., 2017</xref>). To evaluate the online detection performance without distortions of the signal, no actual feedback perturbation of brain activity was applied to the brain.</p><p>Reference hippocampal population bursts were defined offline on the basis of the detrended MUA signal and classified as either associated or not associated with replay (<xref ref-type="table" rid="table1">Table 1</xref>). The offline reference data set contained a total of 3506 population bursts that were recorded in REST (n = 1321) and RUN2 (n = 2185) across all three sessions. The median duration of reference bursts was 83.0 ms (inter-quartile range (iqr) [65.3, 119.8]; REST: median 89.0 ms, iqr [70.0, 126.0]; RUN2: median 79.0 ms, iqr [63.0, 116.0]). In RUN2, the majority of reference bursts occurred when the animal paused at the distal reward platforms.</p><table-wrap id="table1" position="float"><object-id pub-id-type="doi">10.7554/eLife.36275.007</object-id><label>Table 1.</label><caption><title>Overview of datasets.</title></caption><table frame="hsides" rules="groups"><thead><tr><th valign="bottom">Dataset</th><th valign="bottom">Epoch</th><th valign="bottom"># bursts</th><th valign="bottom">Burst <break/>rate [Hz]</th><th valign="bottom"># replay <break/>bursts</th><th valign="bottom"># bursts <break/>w/joint content</th><th valign="bottom">Mean burst duration <break/>[ms]</th></tr></thead><tbody><tr><td valign="top">1</td><td valign="top">REST</td><td valign="top">297</td><td valign="top">0.40</td><td valign="top">42</td><td valign="top">15</td><td valign="top">107.2</td></tr><tr><td valign="top">1</td><td valign="top">RUN2</td><td valign="top">663</td><td valign="top">0.56</td><td valign="top">345</td><td valign="top">85</td><td valign="top">94.4</td></tr><tr><td valign="top">2</td><td valign="top">REST</td><td valign="top">537</td><td valign="top">0.43</td><td valign="top">68b) F</td><td valign="top">34</td><td valign="top">101.2</td></tr><tr><td valign="top">2</td><td valign="top">RUN2</td><td valign="top">808</td><td valign="top">0.64</td><td valign="top">315</td><td valign="top">77</td><td valign="top">93.6</td></tr><tr><td valign="top">3</td><td valign="top">REST</td><td valign="top">487</td><td valign="top">0.38</td><td valign="top">134</td><td valign="top">46</td><td valign="top">102.5</td></tr><tr><td valign="top">3</td><td valign="top">RUN2</td><td valign="top">714</td><td valign="top">0.59</td><td valign="top">334</td><td valign="top">62</td><td valign="top">95.6</td></tr></tbody></table></table-wrap><p>Online, closed-loop replay identification resulted in a total of 2123 positive hits, a large majority of which (87.3%, 1854/2123) were associated with reference bursts. Very few online detections occurred immediately before and within 20 ms after reference burst onset, or after burst offset (<xref ref-type="fig" rid="fig2">Figure 2a</xref>). A small fraction of hits were non-burst false positives (FP<sub>non_burst</sub>), predominantly in the third test session (<xref ref-type="table" rid="table2">Table 2</xref>). There was a slightly higher fraction of positive hits inside reference bursts in REST (91.9%, 694/755) as compared to RUN2 (84.8%, 1160/1368). The higher rate of FP<sub>non_burst</sub> in RUN2 is possibly due to the more prominent spatially modulated firing present during active exploration behavior, which led to spurious crossings of the <inline-formula><mml:math id="inf5"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>u</mml:mi><mml:mi>a</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> threshold with posterior densities representing the actual, rather than a replayed, position of the animal. Indeed, 80.6% of FP<sub>non_burst</sub> in RUN2 occurred when the rat was moving (speed &gt; 5 cm/s), whereas the majority of online detections inside reference bursts (73.8%) occurred when the rat was immobile (speed &lt; 5 cm/s). Overall, the majority of online detections corresponded to population bursts.</p><p>If positive online hits that were associated with reference bursts correctly indicated replay content, then it is expected that, as compared to the ignored bursts, the detected bursts scored higher on metrics used for offline replay identification. Indeed, reference population bursts that were identified online as replay events had higher posterior bias (bias<sub>max</sub> and bias<sub>max</sub> score) for one of the maze arms than did reference bursts that were ignored by the closed-loop system (<xref ref-type="fig" rid="fig2">Figure 2b</xref>). Likewise, online detected events scored higher on metrics for linear spatial-temporal structure (line fit score, Pearson correlation and sequence score; <xref ref-type="fig" rid="fig2">Figure 2c,d</xref>). These results are consistent with the closed-loop system preferentially detecting replay-containing reference bursts.</p><fig id="fig2" position="float"><object-id pub-id-type="doi">10.7554/eLife.36275.008</object-id><label>Figure 2.</label><caption><title>Closed-loop detections correlate with replay content.</title><p>(<bold>a</bold>) Peri-event time histogram of online detections relative to onset (top) and offset (bottom) of reference population bursts. (<bold>b–d</bold>) Cumulative distributions of different replay content measures for reference bursts that were either flagged online as containing replay (thick line) or that did not trigger an online detection (thin line). Gray shaded area shows the 99% confidence interval (CI) of the cumulative distribution for randomized detections of reference bursts (matched to the average online detection rate). Note that reference bursts that were identified online as replay events are associated with higher values for all of the offline replay content measures.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-36275-fig2-v1"/></fig><p>For quantification purposes, and absent ground-truth replay labels, we labeled offline reference bursts with arm-biased posteriors (bias<sub>max</sub> score &gt;3) and trajectory structure (line fit score &gt;0.1) as containing replay content for one of the maze arms (<xref ref-type="table" rid="table1">Table 1</xref>). Across the three sessions, 35.3% of reference bursts were associated with replay (1238/3506; REST — 18.5%, 244/1321; RUN2 ﻿— 45.5%, 994/2185), of which 25.8% were classified as putative joint replay events that span more than one maze arm (<xref ref-type="bibr" rid="bib86">Wu and Foster, 2014</xref>).</p><p>In both REST and RUN2, single and joint replay events were correctly detected and classified in real-time (<xref ref-type="fig" rid="fig3">Figure 3a,b</xref>). The system also correctly ignored bursts that did not contain consistent representations of any of the three maze arms (<xref ref-type="fig" rid="fig3">Figure 3c</xref>). False-positive detections were mainly caused by local matches to the identification criteria in the 30 ms window without significant reference replay present across the whole population burst (see examples in <xref ref-type="fig" rid="fig3s1">Figure 3—figure supplement 1a</xref>). False-negative detections were mainly caused by failure of noisy MUA, sharpness and consistency signals to cross threshold values concurrently (see examples in <xref ref-type="fig" rid="fig3s1">Figure 3—figure supplement 1b</xref>). Occasionally, false-positive/-negative detections were the result of a mismatch between the offline and online decoded position estimates, possibly resulting from compression of the encoding model or differences in spike detection.</p><fig-group><fig id="fig3" position="float"><object-id pub-id-type="doi">10.7554/eLife.36275.009</object-id><label>Figure 3.</label><caption><title>Real-time detection of replay content.</title><p>(<bold>a</bold>) Examples of reference single content replay events that were successfully detected online with correct identification of replay content (vertical red line). The gray bar below each plot represents the total event with duration (in ms) indicated inside the bar. The absolute detection latency from event onset is indicated in red above the bar and the detection latency relative to the duration of the event is indicated below the bar. (<bold>b</bold>) Similar to (<bold>a</bold>) but for joint replay events. All examples except the second show online detections triggered by the first replayed arm; the second example shows an online detection that was triggered by a replay of the second arm. (<bold>c</bold>) Similar to (<bold>a</bold>) but for reference bursts without replay content that were correctly ignored online.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-36275-fig3-v1"/></fig><fig id="fig3s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.36275.010</object-id><label>Figure 3—figure supplement 1.</label><caption><title>Examples of incorrect online identification of replay.</title><p>(<bold>a</bold>) Examples of false-positive detections. Most incorrect detections were due to spurious matching of the identification criteria in the 30 ms preceding window, without significant reference replay detected offline across the whole population burst. A smaller subset of false-positive detections were due to erroneous decoding of spiking activity (e.g. in the first two examples). (<bold>b</bold>) Examples of false-negative detections. In the first five events, individual identification criteria were met throughout the population burst but never concurrently. Other false-negative detections were caused by decoding errors (sixth example) or by an online detection that occurred just outside the event (last example).</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-36275-fig3-figsupp1-v1"/></fig></fig-group><p>To quantify the performance, we treated the online detection of replay content in reference bursts as a binary classification problem and determined the number of true/false positives/negatives in the corresponding confusion matrix (<xref ref-type="fig" rid="fig4">Figure 4a</xref>). Overall, a high fraction of reference bursts with replay content were correctly flagged as such online (median sensitivity 0.78, range: [0.60, 0.95]) and a high fraction of non-replay reference bursts were correctly ignored by the online system (median specificity 0.71, range: [0.44, 0.80]) (<xref ref-type="fig" rid="fig4">Figure 4b</xref>, top; <xref ref-type="table" rid="table3">Table 3</xref>). The online detection favored a low number of false negatives at the expense of a higher number of false positives (median false omission rate (FOR) 0.11, false discovery rate (FDR) 0.54), in particular during REST (FOR 0.02, FDR 0.68) as compared to RUN2 (FOR 0.28, FDR 0.36) (<xref ref-type="fig" rid="fig4">Figure 4b</xref>, middle; <xref ref-type="table" rid="table3">Table 3</xref>).</p><fig id="fig4" position="float"><object-id pub-id-type="doi">10.7554/eLife.36275.011</object-id><label>Figure 4.</label><caption><title>Accurate and rapid online identification of replay bursts.</title><p>(<bold>a</bold>) Schematic overview of the true/false positive/negative classification of online replay detections (top), associated latencies (bottom left) and the confusion matrix used for measuring performance (bottom right). (<bold>b</bold>) Classification performance measures for all REST (black) and RUN2 (gray) test epochs. Diagonal gray lines in the top and middle plots represent isolines for informedness and markedness measures, respectively. Gray lines in the bottom plot represent isolines for Matthews correlation coefficient. In the bottom graph, two RUN2 epoch values overlap in the lowest gray dot. (<bold>c–d</bold>) Distribution of absolute (<bold>c</bold>) and relative (<bold>d</bold>) online detection latency in REST (top) and RUN2 (bottom) epochs. Light gray: all online detected reference bursts. Dark gray: reference bursts with duration longer than 100 ms.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-36275-fig4-v1"/></fig><table-wrap id="table3" position="float"><object-id pub-id-type="doi">10.7554/eLife.36275.012</object-id><label>Table 3.</label><caption><title>Replay detection performance II.</title></caption><table frame="hsides" rules="groups"><thead><tr><th valign="bottom">Dataset</th><th valign="bottom">Epoch</th><th valign="bottom">Sensitivity</th><th valign="bottom">Specificity</th><th valign="bottom">False omission rate</th><th valign="bottom">False discovery rate</th><th valign="bottom">Informedness</th><th valign="bottom">Markedness</th><th valign="bottom">Correlation</th></tr></thead><tbody><tr><td valign="top">1</td><td valign="top">REST</td><td valign="top">0.95</td><td valign="top">0.74</td><td valign="top">0.01</td><td valign="top">0.65</td><td valign="top">0.69</td><td valign="top">0.34</td><td valign="top">0.49</td></tr><tr><td valign="top">1</td><td valign="top">RUN2</td><td valign="top">0.60</td><td valign="top">0.68</td><td valign="top">0.35</td><td valign="top">0.36</td><td valign="top">0.29</td><td valign="top">0.29</td><td valign="top">0.29</td></tr><tr><td valign="top">2</td><td valign="top">REST</td><td valign="top">0.86</td><td valign="top">0.75</td><td valign="top">0.02</td><td valign="top">0.72</td><td valign="top">0.61</td><td valign="top">0.26</td><td valign="top">0.40</td></tr><tr><td valign="top">2</td><td valign="top">RUN2</td><td valign="top">0.69</td><td valign="top">0.80</td><td valign="top">0.18</td><td valign="top">0.34</td><td valign="top">0.49</td><td valign="top">0.48</td><td valign="top">0.48</td></tr><tr><td valign="top">3</td><td valign="top">REST</td><td valign="top">0.95</td><td valign="top">0.44</td><td valign="top">0.03</td><td valign="top">0.68</td><td valign="top">0.40</td><td valign="top">0.30</td><td valign="top">0.34</td></tr><tr><td valign="top">3</td><td valign="top">RUN2</td><td valign="top">0.71</td><td valign="top">0.57</td><td valign="top">0.28</td><td valign="top">0.44</td><td valign="top">0.28</td><td valign="top">0.28</td><td valign="top">0.28</td></tr></tbody></table></table-wrap><p>To further characterize the online detection of reference bursts with replay content, we computed unbiased performance measures informedness, markedness and Matthews correlation coefficient (<xref ref-type="table" rid="table3">Table 3</xref>), which are not sensitive to population prevalence and label bias (<xref ref-type="bibr" rid="bib66">Powers, 2011</xref>). All three measures were well above zero, the performance score of a random classifier (<xref ref-type="fig" rid="fig4">Figure 4b</xref> bottom; <xref ref-type="table" rid="table3">Table 3</xref>), indicating good online identification of population bursts with replay content. For all datasets, the correlation between online hits and offline replay content was highly significant (<inline-formula><mml:math id="inf6"><mml:msup><mml:mrow><mml:mi>χ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:math></inline-formula>&gt;50, p&lt;<inline-formula><mml:math id="inf7"><mml:mn>2</mml:mn><mml:mo>×</mml:mo><mml:msup><mml:mrow><mml:mn>10</mml:mn></mml:mrow><mml:mrow><mml:mo>-</mml:mo><mml:mn>12</mml:mn></mml:mrow></mml:msup></mml:math></inline-formula>).</p><p>For the reference bursts that were correctly flagged by the online system as events with replay, the actual replay content (i.e. which of the three maze arms was represented in the replay event) was classified with high accuracy (<xref ref-type="table" rid="table2">Table 2</xref>; median content accuracy 0.95, range [0.83, 1.00]; REST 0.95, RUN2 0.95).</p><table-wrap id="table2" position="float"><object-id pub-id-type="doi">10.7554/eLife.36275.013</object-id><label>Table 2.</label><caption><title>Replay detection performance I.</title></caption><table frame="hsides" rules="groups"><thead><tr><th valign="bottom">Dataset</th><th valign="bottom">Epoch</th><th valign="bottom">Out of <break/>burst rate <break/>[min<sup>−1</sup>]</th><th valign="bottom">Content <break/>accuracy</th><th valign="bottom">Median <break/>absolute latency <break/>[ms]</th><th valign="bottom">Median relative latency <break/>[%]</th></tr></thead><tbody><tr><td valign="top">1</td><td valign="top">REST</td><td valign="top">0.24</td><td valign="top">0.95</td><td valign="top">51.77</td><td valign="top">50.85</td></tr><tr><td valign="top">1</td><td valign="top">RUN2</td><td valign="top">1.83</td><td valign="top">0.99</td><td valign="top">53.77</td><td valign="top">67.54</td></tr><tr><td valign="top">2</td><td valign="top">REST</td><td valign="top">0.33</td><td valign="top">0.96</td><td valign="top">49.77</td><td valign="top">54.10</td></tr><tr><td valign="top">2</td><td valign="top">RUN2</td><td valign="top">1.05</td><td valign="top">1.00</td><td valign="top">57.39</td><td valign="top">63.81</td></tr><tr><td valign="top">3</td><td valign="top">REST</td><td valign="top">2.37</td><td valign="top">0.83</td><td valign="top">44.62</td><td valign="top">50.49</td></tr><tr><td valign="top">3</td><td valign="top">RUN2</td><td valign="top">7.46</td><td valign="top">0.87</td><td valign="top">49.95</td><td valign="top">62.53</td></tr></tbody></table></table-wrap><p>Taken together, these results demonstrate the capability of our closed-loop system to identify and classify hippocampal replay content with high accuracy under realistic experimental conditions during both resting and active animal behavior.</p><p>Next, we analyzed the latency of online detection, which is a critical metric for experiments that require on-time closed-loop feedback. Across all reference bursts that were detected online, the median closed-loop detection latency (<xref ref-type="fig" rid="fig4">Figure 4a</xref>; <xref ref-type="table" rid="table2">Table 2</xref>) relative to the offline-defined burst onset was 50.7 ms (90% CI [31.4, 116.2]) and the median relative detection latency, as percentage of the reference burst duration, was 59.5% (90% CI: [21.9, 89.0]) (<xref ref-type="fig" rid="fig4">Figure 4c,d</xref>; <xref ref-type="table" rid="table2">Table 2</xref>). The latency for online detection of reference bursts that contain replay content was similar (median detection latency 51.0 ms, 90% CI [30.3, 119.6]; median relative latency 53.6%, 90% CI [19.5, 87.4]). For long reference replay bursts (duration &gt;100 ms), the median detection latency was slightly higher at 58.3 ms (90% CI [30.0, 127.2]), but the median relative latency of 41.9% (90% CI [18.1, 84.7]) was lower (<xref ref-type="fig" rid="fig4">Figure 4c,d</xref>). These results demonstrate that online replay detection occurred well before burst offset time, thus making our hardware–software system suitable for experiments requiring replay content-specific closed-loop manipulation.</p></sec><sec id="s2-2"><title>Effect of parameters on replay content detection</title><p>In the experimental tests, the parameters for online replay content identification and classification were chosen on the basis of pilot experiments and offline simulations carried out beforehand. However, such parameters may be tuned to meet the specific requirements of an experiment. For example, it may be desirable to detect the target replay content as completely as possible (i.e. high sensitivity) at the expense of a higher number of false positives (reduced specificity). Conversely, experimenters may want to favor high specificity at the expense of a higher number of missed target replay events.</p><p>To characterize the influence of parameters on online detection performance, experimental data were played back offline while applying the online detection algorithm, using a range of values for the MUA and posterior sharpness thresholds <inline-formula><mml:math id="inf8"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>u</mml:mi><mml:mi>a</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and<inline-formula><mml:math id="inf9"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>h</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>p</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>. As expected, increasing values of <inline-formula><mml:math id="inf10"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>u</mml:mi><mml:mi>a</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and <inline-formula><mml:math id="inf11"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>h</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>p</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> parameters reduced the false-positive and false-discovery rates, at the expense of a decrease in sensitivity and an increase in false-omission rate during both REST (<xref ref-type="fig" rid="fig5s1">Figure 5—figure supplement 1</xref>) and RUN2 (<xref ref-type="fig" rid="fig5s2">Figure 5—figure supplement 2</xref>).</p><p>We next asked how close the chosen parameters in the live test were to the pair of optimal parameters that maximize the Matthews correlation coefficient (<xref ref-type="fig" rid="fig5">Figure 5a</xref>), which balances all four elements of the confusion matrix (true positives (TP), true negatives (TN), in-burst false positives (FP<sub>burst</sub>), and false negatives (FN)). For each optimal pair of parameters, we separately assessed the corresponding rate of non-burst detections (FP<sub>non_burst</sub>) (<xref ref-type="fig" rid="fig5">Figure 5b</xref>), which is not accounted for in the maximization of the Matthews correlation coefficient.</p><fig-group><fig id="fig5" position="float"><object-id pub-id-type="doi">10.7554/eLife.36275.014</object-id><label>Figure 5.</label><caption><title>Parameter tuning of online replay detection for optimal detection performance.</title><p>(<bold>a</bold>) Map of the Matthews correlation coefficient for different combinations of values for <inline-formula><mml:math id="inf12"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>u</mml:mi><mml:mi>a</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and <inline-formula><mml:math id="inf13"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>h</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>p</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> of a REST (top) and RUN2 (bottom) epoch; the map was computed using offline playback simulations (dataset 2). Circles indicate the value corresponding to the actual parameters used in the online tests (open circle) and the value corresponding to the set of parameters that maximizes the Matthews correlation coefficient (filled circle). (<bold>b</bold>) Same as (<bold>a</bold>) for the non-burst detection rate for different combination of thresholds. Circles indicate the value corresponding to the actual parameters used in the online tests (open circle) and the value corresponding to the set of parameters that maximizes the Matthews correlation coefficient (filled circle).</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-36275-fig5-v1"/></fig><fig id="fig5s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.36275.015</object-id><label>Figure 5—figure supplement 1.</label><caption><title>Parameter tuning of the replay content identification algorithm for customized detection performance of a REST epoch.</title><p>(<bold>a–f</bold>) Dependence of online replay detection performance indices on algorithm parameters tested using offline playback simulations with varying combinations of values for <inline-formula><mml:math id="inf14"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>u</mml:mi><mml:mi>a</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and <inline-formula><mml:math id="inf15"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>h</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>p</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>. Circles indicate the value corresponding to the actual parameters used in the online tests (open circle) and the value corresponding to the set of parameters that maximizes the Matthews correlation coefficient (filled circle). Note how lower values of both <inline-formula><mml:math id="inf16"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>u</mml:mi><mml:mi>a</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and <inline-formula><mml:math id="inf17"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>h</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>p</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> improve sensitivity, but negatively affect sspecificity and false discovery rate. On the other hand, median relative latency and content accuracy are not affected by parameter tuning as they depend on other elements of the replay content identification framework.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-36275-fig5-figsupp1-v1"/></fig><fig id="fig5s2" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.36275.016</object-id><label>Figure 5—figure supplement 2.</label><caption><title>Parameter tuning of the replay content identification algorithm for customized detection performance of a RUN2 epoch.</title><p>(<bold>a–f</bold>) Dependence of online replay detection performance indices on algorithm parameters tested using offline playback simulations with varying combinations of values for <inline-formula><mml:math id="inf18"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>u</mml:mi><mml:mi>a</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and <inline-formula><mml:math id="inf19"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>h</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>p</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>. Circles indicate the value corresponding to the actual parameters used in the online tests (open circle) and the value corresponding to the set of parameters that maximizes the Matthews correlation coefficient (filled circle). Note how lower values of both <inline-formula><mml:math id="inf20"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>u</mml:mi><mml:mi>a</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and <inline-formula><mml:math id="inf21"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>h</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>p</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> improve sensitivity, but negatively affect specificity and false discovery rate. On the other hand, median relative latency and content accuracy are not affected by parameter tuning as they depend on other elements of the replay content identification framework.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-36275-fig5-figsupp2-v1"/></fig><fig id="fig5s3" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.36275.017</object-id><label>Figure 5—figure supplement 3.</label><caption><title>Replay identification performance as a function of time bin size and number of bins (N<sub>bins</sub>) for both a REST (<bold>a</bold>) and RUN2 (<bold>b</bold>) epoch.</title><p>Note that larger N<sub>bins</sub> and/or bin size result in both an improved detection performance (i.e. higher Matthews correlation coefficient; top left) and worse detection latency (bottom left). The white dot indicates the combination of bin size and N<sub>bins</sub> used for online detections and most offline analyses.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-36275-fig5-figsupp3-v1"/></fig></fig-group><p>We found that we used sub-optimal parameters in REST epochs, suggesting that a better detection could have been achieved by increasing <inline-formula><mml:math id="inf22"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>u</mml:mi><mml:mi>a</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and <inline-formula><mml:math id="inf23"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>h</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>p</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> thresholds (<xref ref-type="fig" rid="fig5">Figure 5 a,b</xref> <xref ref-type="table" rid="table4">Table 4</xref>). On the other hand, in the RUN2 epochs, the maximum attainable correlations were only marginally and not significantly higher than those obtained in the live tests (<xref ref-type="table" rid="table4">Table 4</xref>; <xref ref-type="fig" rid="fig5">Figure 5a</xref>, bottom). Moreover, the highest correlation for RUN2 was obtained at the same <inline-formula><mml:math id="inf24"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>h</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>p</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> used in the live tests, but with lower <inline-formula><mml:math id="inf25"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>u</mml:mi><mml:mi>a</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> thresholds (<xref ref-type="fig" rid="fig5">Figure 5a</xref>, bottom; <xref ref-type="table" rid="table4">Table 4</xref>), thus allowing for a dramatically lower FP<sub>non_burst</sub> rate than the parameters that maximize the Matthews correlation coefficient (<xref ref-type="fig" rid="fig5">Figure 5b</xref>, bottom; <xref ref-type="table" rid="table4">Table 4</xref>).</p><p>Both content accuracy and detection latency were largely unaffected by changes in <inline-formula><mml:math id="inf26"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>u</mml:mi><mml:mi>a</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> or <inline-formula><mml:math id="inf27"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>h</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>p</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> thresholds (<xref ref-type="fig" rid="fig5s1">Figure 5—figure supplement 1e, f</xref> and <xref ref-type="fig" rid="fig5s2">Figure 5—figure supplement 2e,f</xref>). Content accuracy is mainly dependent on the online decoding performance and is influenced by compression threshold (see <xref ref-type="fig" rid="fig1">Figure 1d</xref>) and the number of recorded neurons (or proxies thereof, such as the number of tetrodes). Detection latency is mainly dependent on the size of the integration window used to determine replay content, which was fixed to 30 ms (three 10 ms bins) in the live tests. The simulations show that detection latency varied with the size of the integration window (<xref ref-type="fig" rid="fig5s3">Figure 5—figure supplement 3</xref>). As expected, the use of smaller bin size and/or a lower number of N<sub>bins</sub> decreases relative detection latency, at the expense of reduced detection accuracy (i.e. lower Matthews correlation coefficient). Thus, experimenters may also tune the integration window size to accommodate faster or more accurate online detections.</p></sec><sec id="s2-3"><title>Online detection of replay content requires sufficiently high sampling of ensemble activity</title><p>Accurate real-time replay detection requires replay content to be predictable from the initial portion of the bursting event. Therefore, higher signal-to-noise and neatly structured decoded replay trajectories are easier to detect online as they are less susceptible to short timescale signal variability. Since the signal-to-noise ratio of replay is strongly influenced by the level of sampling of the spiking neuronal population (although biological factors might play a role too [<xref ref-type="bibr" rid="bib71">Roumis and Frank, 2015</xref>; <xref ref-type="bibr" rid="bib78">Tang et al., 2017</xref>]), spiking data recorded from poorly sampled neuronal populations are likely to lead to an increase in online replay detection errors.</p><p>To determine how spike data availability affects online replay identification, we progressively excluded tetrodes in one dataset and performed offline simulations of online replay detection in REST and RUN2 (<xref ref-type="fig" rid="fig6">Figure 6</xref> and <xref ref-type="fig" rid="fig6s1">Figure 6—figure supplement 1</xref>). Consistent with a higher signal-to-noise ratio, a higher tetrode number decreased the variability of the MUA rate estimate within 10 ms bins and increased the separability of the MUA rate distributions for non-burst periods, bursts without replay and bursts with replay (<xref ref-type="fig" rid="fig6s2">Figure 6—figure supplement 2a,c</xref>). The sharpness of the posterior probability distributions increased with higher tetrode numbers, whereas the sharpness distributions for non-burst periods and bursts with replay showed a clear separation (<xref ref-type="fig" rid="fig6s2">Figure 6—figure supplement 2b,d</xref>).</p><fig-group><fig id="fig6" position="float"><object-id pub-id-type="doi">10.7554/eLife.36275.018</object-id><label>Figure 6.</label><caption><title>Matthews correlation as a measure of replay identification performance as a function of the number of tetrodes included (up to 50 random selections per tetrode number).</title><p>(<bold>a</bold>) Matthews correlation coefficient, content accuracy, relative detection latency and non-burst detection rate for REST (left) and RUN2 (right). Dots represent individual tests, lines represent the median. (<bold>b</bold>) Cross-validated RUN1 decoding performance as a function of the number of tetrodes. Top: median in-arm decoding errors. Bottom: fraction arm-correct position estimates. (<bold>c</bold>) Scatter plot of the relation between median in-arm decoding error and replay detection performance during REST (top) and RUN2 (bottom). Black lines represent the centroid for each color-coded number of tetrodes in vivo.</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-36275-fig6-v1"/></fig><fig id="fig6s1" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.36275.019</object-id><label>Figure 6—figure supplement 1.</label><caption><title>Extended characterization of replay detection performance as a function of number of tetrodes for REST.</title><p>(<bold>a,b</bold>) and RUN2 (<bold>c,d</bold>). (<bold>a,c</bold>) Top: sensitivity and false-positive rate. Bottom: false discovery and false omission rates. Diagonal gray lines in scatter plots represent isolines for informedness (top) and markedness (bottom) measures. (<bold>b,d</bold>) Optimal thresholds with <inline-formula><mml:math id="inf28"><mml:mi>t</mml:mi><mml:mi>h</mml:mi><mml:mi>e</mml:mi><mml:mi>t</mml:mi><mml:msub><mml:mrow><mml:mi>a</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>u</mml:mi><mml:mi>a</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>expressed in S.D. (top) or per-tetrode spiking rate (bottom).</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-36275-fig6-figsupp1-v1"/></fig><fig id="fig6s2" position="float" specific-use="child-fig"><object-id pub-id-type="doi">10.7554/eLife.36275.020</object-id><label>Figure 6—figure supplement 2.</label><caption><title>Dependence of MUA and sharpness metrics on the number of tetrodes.</title><p>(<bold>a</bold>) MUA rate per tetrode in REST. Top: example distributions of MUA rate for time bins outside and inside candidate replay bursts (with or without identified replay content) for a subset of 4, 9 and 14 tetrodes. Bottom, left: mean MUA rate as a function of the number of tetrodes. Note that the mean rate remains constant, but the variance increases with fewer tetrodes. Bottom, right: Hellinger distance between MUA rate distributions as a function of the number of tetrodes. (<bold>b</bold>) Sharpness of posterior probability distributions in REST. Top: example distributions of sharpness values for time bins outside and inside candidate replay bursts (with or without identified replay content) for a subset of 4, 9 and 14 tetrodes. Note shift towards higher sharpness values when more tetrodes are included. Bottom, left: mean sharpness value as a function of the number of tetrodes. Bottom, right: Hellinger distance between sharpness distributions as a function of the number of tetrodes. (<bold>c</bold>) MUA rate per tetrode in RUN2. Panels as in (<bold>a</bold>). (<bold>d</bold>) Sharpness of posterior probability distributions in RUN2. Panels as in (<bold>b</bold>).</p></caption><graphic mime-subtype="postscript" mimetype="application" xlink:href="elife-36275-fig6-figsupp2-v1"/></fig></fig-group><p>To quantify the replay detection performance, a fixed replay reference was used (computed on the original dataset), so that the results were not affected by degradation of the reference. For each simulation, optimal <inline-formula><mml:math id="inf29"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>u</mml:mi><mml:mi>a</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and <inline-formula><mml:math id="inf30"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>h</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>p</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> thresholds were computed separately (<xref ref-type="fig" rid="fig6s1">Figure 6—figure supplement 1b, d</xref>). As expected, replay identification and classification performance improved when more tetrodes were included, as evidenced by higher correlation and content accuracy measures (<xref ref-type="fig" rid="fig6">Figure 6a</xref>). Relative detection latency decreased marginally with the number of tetrodes; whereas FP<sub>non_burst</sub> rate remained low for REST and was variable for RUN2 (probably because <inline-formula><mml:math id="inf31"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>u</mml:mi><mml:mi>a</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and <inline-formula><mml:math id="inf32"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>h</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>p</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> thresholds were not optimized for low out-of-burst detections).</p><p>Matthews correlation coefficient does not appear to saturate at the maximum number of tetrodes in the test dataset (14), suggesting that further improvement is possible by increasing the number of sampled cells. Interestingly, Matthews correlation shows little variation for low number of tetrodes and improves most strongly from 10 tetrodes and up. This non-linear dependency is even more clearly present for content accuracy. It is conceivable that, given heterogeneity in spiking data across tetrodes, there is a critical subset of tetrodes that provide most of the information for accurate determination of replay content. The higher Matthews correlation was mainly due to an increased sensitivity and a reduction in false discovery and omission rates (<xref ref-type="fig" rid="fig6s1">Figure 6—figure supplement 1a,c</xref>).</p><p>Next, we asked to what extent run decoding performance, evaluated through cross-validation prior to closed-loop manipulation, is predictive of good performance of subsequent (online) replay content identification (<xref ref-type="bibr" rid="bib45">Maboudi et al., 2018</xref>; <xref ref-type="bibr" rid="bib81">van der Meer et al., 2017</xref>). As expected, cross-validated run decoding improved with increasing number of tetrodes, as in-arm decoding error decreased and the fraction of arm-correct position estimates increased (<xref ref-type="fig" rid="fig6">Figure 6b</xref>). Run-decoding performance improved rapidly up to four tetrodes and more gradually for higher tetrode counts. As a result, replay detection performance and run decoding performance show a low and highly non-linear correlation (<xref ref-type="fig" rid="fig6">Figure 6c</xref>), which suggests that a low run-decoding error (e.g. median error below 10 cm) is a necessary although not sufficient condition for accurate online replay detection.</p></sec></sec><sec id="s3" sec-type="discussion"><title>Discussion</title><p>We demonstrated a solution for real-time detection of hippocampal replay content in freely moving rodents that perform navigation tasks. Our solution provides rapid closed-loop feedback that is specifically triggered by replay of an experimenter-defined content, such as replay of a trajectory through one segment of a maze explored by the animal. This technical advance makes it possible to perform replay content-specific perturbations to address directly the causal link between specific replay events and memory consolidation/retrieval processes.</p><p>Our system goes beyond recent efforts to decode or respond to hippocampal activity online. Previous work described systems that provide real-time feedback stimulation in response to spiking activity (<xref ref-type="bibr" rid="bib47">Nguyen et al., 2014</xref>; <xref ref-type="bibr" rid="bib58">Patel et al., 2017</xref>). These systems perform online decoding of a rat’s physical location from a limited number of hippocampal place cells (<xref ref-type="bibr" rid="bib22">Guger et al., 2011</xref>) or implement online spike-sorting with simultaneous detection of ripple oscillations (<xref ref-type="bibr" rid="bib73">Sethi and Kemere, 2015</xref>). However, none of these prior studies addressed the combination of short timescale neural decoding and low-latency detection of replayed spike sequences. <xref ref-type="bibr" rid="bib8">de Lavilléon et al. (2015)</xref> showed that coupling spikes of a single hippocampal place cell during rest to electrical stimulation of the medial forebrain bundle induced a subsequent preference of the animal for the cell’s place field. Still, the association with replay was only speculative as no multi-neuronal pattern was being detected. Finally, <xref ref-type="bibr" rid="bib9">Deng et al. (2016)</xref> developed an algorithm for rapid hippocampal replay content classification in the awake state using state-space models. Despite the low algorithmic latency and the solid mathematical framework of their strategy, the computational latency was still prohibitive and the algorithm's application to live data streams in an experiment was neither demonstrated nor fully conceptualized.</p><p>Our replay detection technology has similarities and differences with the large body of research in brain–computer interfaces (BCIs) and neuroprosthetics (<xref ref-type="bibr" rid="bib38">Lebedev and Nicolelis, 2006</xref>). In common with some prototypes of invasive BCIs used for controlling external devices (<xref ref-type="bibr" rid="bib15">Fraser et al., 2009</xref>; <xref ref-type="bibr" rid="bib41">Li and Li, 2017</xref>), we applied online population decoding to unsorted large-scale single-unit recordings. The use of high-level signals that relate to cognitive processes such action planning or memory rather than to pure motor function is not new in neuroprosthetics (see cognitive neural prosthetics (<xref ref-type="bibr" rid="bib2">Andersen et al., 2010</xref>; <xref ref-type="bibr" rid="bib24">Hampson et al., 2018</xref>). In contrast to other BCI and neuroprosthetics applications, the development of a ‘replay BCI’ faced two unique challenges. First, while it is possible to test the accuracy of BCIs by measuring the difference between desired and actual output, the content of hippocampal replay does not have a ‘ground truth’ and requires assumptions and statistical analyses to quantify the goodness of the output. The second and most difficult challenge relates to the strict latency specifications in generating an online feedback. BCIs can operate with a processing latency of less than 50 ms when using slowly sampled (below 4800 Hz) EEG signals on few (8–32) channels (<xref ref-type="bibr" rid="bib13">Fischer et al., 2014</xref>; <xref ref-type="bibr" rid="bib83">Wilson et al., 2010</xref>). BCIs using rapidly sampled signals for spike detection on larger electrode arrays can reach latencies as low as 120 ms (<xref ref-type="bibr" rid="bib82">Velliste et al., 2008</xref>); lower latencies are however not necessary as the natural control of motor output has a natural delay of 150 – 200 ms (<xref ref-type="bibr" rid="bib82">Velliste et al., 2008</xref>; <xref ref-type="bibr" rid="bib87">Xu et al., 2014</xref>). Here, we surpassed these limits by using more than 50 channels sampled at 32 kHz to generate estimates of brain state (animals’ position) every 10 ms and to classify hippocampal replay patterns with ~50 ms average latency.</p><p>As with any system that aims to provide on-time feedback, a trade-off was made between the earliest possible prediction of replay content in a population burst and the most accurate possible prediction. This trade-off is reflected in the numbers of incorrect detections and omissions, when compared to a reference replay content classification. Ultimately, the experimental goals determine how the best trade-off is made. For a balanced trade-off between true and false positives/negatives, we opted for the Matthews correlation coefficient as a measure of performance. For some experiments, however, it may be desirable to be more content-specific and a corresponding increase in false negatives (lower sensitivity) is deemed acceptable. On the other hand, it may be more important to detect as many events with target replay content as possible and an increased rate of false positives (lower specificity) is taken for granted. The two main parameters in our replay content detection algorithm, <inline-formula><mml:math id="inf33"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>u</mml:mi><mml:mi>a</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and <inline-formula><mml:math id="inf34"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>h</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>p</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>, provide an intuitive means to tune the detection performance and to obtain the desired trade-off. While the exact parameter values depend on the data and optimal values are not known prior to the experiment, similar datasets collected beforehand (without disruptive closed-loop manipulations) are a guide to the actual parameter selection.</p><p>The trade-off between accuracy and latency is affected by the performance of neural decoding. A high cell yield in the recordings will improve decoding performance and hence is expected to lead to better online replay detection. The no-spike-sort decoding approach (<xref ref-type="bibr" rid="bib33">Kloosterman et al., 2014</xref>), which is at the core of our solution, helps by utilizing the information from all available spikes, whether or not they are part of well-isolated cell clusters. Compression of the encoding model and software parallelization in Falcon provided the necessary computational speed-up, which in our system results in the availability of the animal’s replayed position within 2 ms of data arrival, with acceptable decoding accuracy loss.</p><p>A second factor that contributes to the latency-accuracy trade-off is the amount of recent data considered for classifying replay content online. In the content classification algorithm, a shorter window of integration (i.e. fewer bins and/or smaller bin sizes) results in lower detection latencies, and also in an increased focus on local, noisy features of the data that may not be consistent with replay content across the complete event. We settled on a window of 30 ms, which resulted in good replay content detection within short latencies. In future work, further decrease of false-positive and negative detection could be achieved by an extension of our algorithm that adaptively increases the time window to accumulate additional evidence until a certain level of confidence that the event under consideration does or does not represent the target replay content has been reached.</p><p>Further improvement of online replay detection is possible by increasing the sampling of spiking data (e.g. by increasing number of recording channels), as the performance in our tests with up to 14 tetrodes did not yet reach a plateau. The increased spiking data will improve both the MUA burst detection and replay content determination components of the online algorithm. This may also allow a further reduction of the integration window, as this is the main determinant of the detection latency. The system as presented will be able to handle the additional computational burden without increasing the computational latency significantly, as it scales to at least 128 recording channels (32 tetrodes) and probably more when run on a 32-core workstation. Scaling to several hundreds or thousands of recording channels in future implementations may require offloading the computationally intensive neural decoding steps to the graphics processing unit (GPU).</p><p>The detection of hippocampal replay events has to take into account that ground truth replay labels are unavailable. To evaluate the performance of online replay detection, we showed that detected events score higher on measures that correlate with replay content and that detections largely agree with an offline-defined reference. The quality of the offline reference – that is, how well it captures the desired target replay content – depends on the parameters of the offline detector and on sufficient sampling of spiking data. The offline detector has the advantage of access to all data and of not being bound by limited compute time, whereas the the online detector includes compromises to perform fast and early real-time detection. Hence, one would generally have a higher confidence in the offline reference and would accordingly tune the parameters of the online detector using either prior knowledge or training data. Still, depending on parameters, the offline reference may vary from being too inclusive (e.g. all population bursts are marked as replay) to overly exclusive (e.g. no population bursts are marked as replay) and reliance on an inappropriate reference without careful verification will make experiments that manipulate online detected replay events difficult to interpret. Another cautionary note should be made about using decoding performance during run to predict subsequent online replay detection performance: in our tests, run decoding was less sensitive to data degradation and although low run decoding error may be required for good decoding of replay content, it is not a sufficient condition.</p><p>Detection latency of online replay detection was on average ~50 ms. In our previous work, using the same hardware–software system, we demonstrated online burst detection (without replay content identification) at ~40 ms latency (<xref ref-type="bibr" rid="bib6">Ciliberti and Kloosterman, 2017</xref>). Here, by combining burst and replay content detection in the algorithm, on average we added only 10 ms to the time that is needed for a basic population burst detection in the same closed-loop system.</p><p>The rate of false-positive detections outside candidate replay population bursts were generally low in rest, but more prevalent when the rat was actively exploring the maze, probably due to a higher mean population firing rate during motion than during rest. In offline analyses, information about the animal’s behavior (e.g. running speed) or replay-associated electrophysiological markers (e.g. high-frequency ripple oscillation power) are often used to reduce this category of false positives (<xref ref-type="bibr" rid="bib7">Davidson et al., 2009</xref>). The integration of this additional information in a Falcon processing pipeline would be relative straightforward, but this strategy may increase detection latency and introduce new sources of errors.</p><p>The incorporation of our real-time replay detection solution in an experiment requires that an encoding model is built from spiking data recorded during an initial exploration of the maze. At present, the encoding model is constructed manually offline and uploaded into the Falcon software during a brief pause of 5 – 15 min between the end of the initial maze exploration and the start of the real-time replay detection. Future enhancements will enable the construction and validation of the encoding model online rather than offline: besides reducing experimental down-time, this will provide immediate feedback on the decoding performance and will enable content-specific closed-loop manipulation of awake replay events as soon as the quality of the encoding model is sufficient.</p><p>In our demonstration, the target replay content for online detection was the representation of one of three maze arms. The system can be trivially extended to environments that are composed of more than three arms (e.g. 8-arm radial mazes or set of linear tracks) and to target joint replay content that covers multiple maze arms in succession. For more strict detection of replay trajectories, a local spatial derivative criterion may be added to the replay classification algorithm. Together with an extension of the encoding model with running direction (<xref ref-type="bibr" rid="bib7">Davidson et al., 2009</xref>), such a trajectory criterion would form the basis of a detector for forward and reverse replay events (<xref ref-type="bibr" rid="bib10">Diba and Buzsáki, 2007</xref>; <xref ref-type="bibr" rid="bib14">Foster and Wilson, 2006</xref>). By altering the encoding model, the system could also be used to target other types of replay content, including reactivation of immobility-associated place cells (<xref ref-type="bibr" rid="bib88">Yu et al., 2017</xref>), non-spatial task-related replay (<xref ref-type="bibr" rid="bib76">Takahashi, 2015</xref>), sequence reactivation of time cells (<xref ref-type="bibr" rid="bib57">Pastalkova et al., 2008</xref>) or spiking sequences in nested theta/gamma oscillations during active behavior (<xref ref-type="bibr" rid="bib89">Zheng et al., 2016</xref>). Our approach is not limited to hippocampal replay bursts and could be applied to cortical (<xref ref-type="bibr" rid="bib29">Ji and Wilson, 2007</xref>; <xref ref-type="bibr" rid="bib61">Peyrache et al., 2009</xref>) or subcortical (<xref ref-type="bibr" rid="bib36">Lansink et al., 2009</xref>) replay as long as it is possible to define a decodable and detectable content.</p><p>In conclusion, we successfully bridged the gap between the basic formulation of online replay identification algorithms and an actual experiment-ready system that addresses the challenges associated with the detection of replay content in live neural data streams. The approach presented here will pave the way for a new generation of closed-loop experiments aimed at elucidating the causal role of hippocampal and non-hippocampal internally generated neural activity in memory processes and cognition.</p></sec><sec id="s4" sec-type="materials|methods"><title>Materials and methods</title><sec id="s4-1"><title>Neural decoding</title><p>We employed a Bayesian neural decoding approach that computes the posterior probability over position <italic>x</italic> given the unsorted spikes on <italic>K</italic> tetrodes (<xref ref-type="bibr" rid="bib33">Kloosterman et al., 2014</xref>). For each tetrode k, <inline-formula><mml:math id="inf35"><mml:msup><mml:mrow><mml:mi>A</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:mfenced close="}" open="{" separators="|"><mml:mrow><mml:msubsup><mml:mrow><mml:mi>a</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msubsup><mml:mo>,</mml:mo><mml:mo>…</mml:mo><mml:mo>,</mml:mo><mml:msubsup><mml:mrow><mml:mi>a</mml:mi></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msubsup></mml:mrow></mml:mfenced></mml:math></inline-formula> defines the peak amplitude vectors for a set of <inline-formula><mml:math id="inf36"><mml:msub><mml:mrow><mml:mi>n</mml:mi></mml:mrow><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> spikes in the decoding time bin with duration<inline-formula><mml:math id="inf37"><mml:mi>Δ</mml:mi></mml:math></inline-formula>. Following Bayes’ rule, the posterior is then given by:<disp-formula id="equ1"><label>(1)</label><mml:math id="m1"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>P</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>x</mml:mi><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:msup><mml:mi>A</mml:mi><mml:mrow><mml:mn>1</mml:mn><mml:mo>:</mml:mo><mml:mi>K</mml:mi></mml:mrow></mml:msup></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mrow><mml:mi>P</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msup><mml:mi>A</mml:mi><mml:mrow><mml:mn>1</mml:mn><mml:mo>:</mml:mo><mml:mi>K</mml:mi></mml:mrow></mml:msup><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mi>P</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mi>x</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi>P</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:msup><mml:mi>A</mml:mi><mml:mrow><mml:mn>1</mml:mn><mml:mo>:</mml:mo><mml:mi>K</mml:mi></mml:mrow></mml:msup><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfrac></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>Here, <inline-formula><mml:math id="inf38"><mml:mi>P</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:msup><mml:mrow><mml:mi>A</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mo>:</mml:mo><mml:mi>K</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:math></inline-formula> is a normalizing constant and we use a uniform prior<inline-formula><mml:math id="inf39"><mml:mi>P</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:mi>x</mml:mi></mml:mrow></mml:mfenced></mml:math></inline-formula>. We assume conditional independence of the activity on each tetrode, and thus the joint likelihood is computed as the product of the individual likelihoods:<disp-formula id="equ2"><label>(2)</label><mml:math id="m2"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>P</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msup><mml:mi>A</mml:mi><mml:mrow><mml:mn>1</mml:mn><mml:mo>:</mml:mo><mml:mi>K</mml:mi></mml:mrow></mml:msup><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:munderover><mml:mo>∏</mml:mo><mml:mrow><mml:mi>k</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>K</mml:mi></mml:mrow></mml:munderover><mml:mi>P</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msup><mml:mi>A</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msup><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>For each tetrode, the spiking statistics are modeled as a marked temporal Poisson process (where each mark is the vector of spike peak amplitudes) and the likelihood is expressed as (dropping super- and subscripts k on the right side for clarity):<disp-formula id="equ3"><label>(3)</label><mml:math id="m3"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>P</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msup><mml:mi>A</mml:mi><mml:mrow><mml:mi>k</mml:mi></mml:mrow></mml:msup><mml:mrow><mml:mo stretchy="false">|</mml:mo></mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msup><mml:mi mathvariant="normal">Δ</mml:mi><mml:mrow><mml:mi>n</mml:mi></mml:mrow></mml:msup><mml:mrow><mml:mo>[</mml:mo><mml:mrow><mml:munder><mml:mover><mml:mo>∏</mml:mo><mml:mi>n</mml:mi></mml:mover><mml:mi>i</mml:mi></mml:munder><mml:mi>λ</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:msub><mml:mi>a</mml:mi><mml:mrow><mml:mi>i</mml:mi></mml:mrow></mml:msub><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mo>]</mml:mo></mml:mrow><mml:msup><mml:mi>e</mml:mi><mml:mrow><mml:mo>−</mml:mo><mml:mi mathvariant="normal">Δ</mml:mi><mml:mi>λ</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mi>x</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:msup></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>We refer to <xref ref-type="disp-formula" rid="equ3">Equations 3</xref> as the encoding model. The tetrode-specific joint rate function <inline-formula><mml:math id="inf40"><mml:mi>λ</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:mi>a</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow></mml:mfenced></mml:math></inline-formula> and marginal rate function <inline-formula><mml:math id="inf41"><mml:mi>λ</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:mi>x</mml:mi></mml:mrow></mml:mfenced></mml:math></inline-formula>can be further expressed as a ratio of spike count (<inline-formula><mml:math id="inf42"><mml:mi>p</mml:mi></mml:math></inline-formula>) and position occupancy (<inline-formula><mml:math id="inf43"><mml:mi>π</mml:mi></mml:math></inline-formula>) probability distributions:<disp-formula id="equ4"><label>(4)</label><mml:math id="m4"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>λ</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>a</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mi>μ</mml:mi><mml:mfrac><mml:mrow><mml:mi>p</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mrow><mml:mi>a</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi>π</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mi>x</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfrac></mml:mrow></mml:mstyle></mml:math></disp-formula><disp-formula id="equ5"><label>(5)</label><mml:math id="m5"><mml:mstyle displaystyle="true" scriptlevel="0"><mml:mrow><mml:mi>λ</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mi>x</mml:mi><mml:mo>)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mi>μ</mml:mi><mml:mfrac><mml:mrow><mml:mi>p</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mi>x</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi>π</mml:mi><mml:mrow><mml:mo>(</mml:mo><mml:mi>x</mml:mi><mml:mo>)</mml:mo></mml:mrow></mml:mrow></mml:mfrac></mml:mrow></mml:mstyle></mml:math></disp-formula></p><p>Here, <inline-formula><mml:math id="inf44"><mml:mi>μ</mml:mi></mml:math></inline-formula> represents the mean firing rate. To compute the likelihoods, the rate functions are evaluated using a compressed kernel density based estimator (<xref ref-type="bibr" rid="bib75">Sodkomkham et al., 2016</xref>) with kernel bandwidths of 8 cm and 30 µV respectively for the spatial and spike amplitude dimensions, and a compression level in the range [1, 2].</p></sec><sec id="s4-2"><title>Online replay detection and classification algorithm</title><p>To detect and classify hippocampal replay events online in a continuous stream of spiking data from an array of electrodes, we used a two-step approach. First, we decoded spatial information from the hippocampal spikes for each 10 ms of incoming data as described above. Second, we applied a simple classification strategy to the most recently received T ms of data (i.e. N<sub>bins</sub> x 10 ms) to determine the occurrence of a target replay event. The algorithm was designed to detect targets that represent replay of a specific trajectory (e.g. maze arm) in the environment. We defined a set of criteria and marked the successful detection of a target replay event when all criteria were met:</p><list list-type="order"><list-item><p>Burst of activity: the average multi-unit activity rate across all tetrodes in the last T ms is higher than the threshold <inline-formula><mml:math id="inf45"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>u</mml:mi><mml:mi>a</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>. This criterion minimizes the chance of false-positive detection outside population bursts.</p></list-item><list-item><p>Decoding fidelity: the sharpness of the posterior distribution, defined as the integrated probability within approximately 14 cm of the maximum-a-posteriori (MAP) estimate, is higher than the threshold <inline-formula><mml:math id="inf46"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>h</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>p</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>, both for the most recent decoding time bin and on average for the last N<sub>bins</sub> decoding time bins.</p></list-item><list-item><p>Replay content consistency: the MAP estimates in the last N<sub>bins</sub> decoding bins all fall on the target trajectory (e.g. arm of a maze).</p></list-item></list><p>The online detection and classification approach described above acts on fixed time windows in streaming data without knowledge of the exact start and end times of any replay event (which are only accessible offline). This means that the algorithm is expected to trigger multiple detections for the same replay event. By introducing a lock-out period after each positive detection, these multiple detections can be largely avoided. The use of a lock-out period is also consistent with closed-loop experiments that limit stimulation frequency to 4 – 5 Hz to avoid adverse side effects of over-stimulation (<xref ref-type="bibr" rid="bib16">Girardeau et al., 2009</xref>; <xref ref-type="bibr" rid="bib28">Jadhav et al., 2012</xref>).</p></sec><sec id="s4-3"><title>Implementation of online replay detection</title><p>A live network stream of sample-by-sample (32 kHz) multi-channel data from a DigiLynx acquisition system (Neuralynx, Bozeman, MT) was fed into a workstation equipped with 256 GB of RAM, 40 MB of smart cache and two 16-core CPUs (Intel Xeon(R) CPU E5-2698 V3 @ 2.30 GHz) that support hardware-based simultaneous multi-threading for a total of 64 virtual cores. The workstation ran the open source real-time processing software Falcon (<xref ref-type="bibr" rid="bib6">Ciliberti and Kloosterman, 2017</xref>), in which we defined a data processing graph that continuously performed neural decoding and replay identification algorithms on the incoming stream of data. The processing graph was composed of seven serial stages, some of which were split into parallel pipelines (one for each tetrode, indicated by * below):</p><list list-type="order"><list-item><p>Read samples: UDP packets with raw sample data are received from the network stream and parsed into time-stamped multi-channel voltage signals, using a two-sample internal buffer (62.5 µs). Signals are next dispatched to a set of parallel pipelines, according to a predefined selection of tetrodes and channel to tetrode mapping.</p></list-item><list-item><p>*Spike filter: the signal on each tetrode channel is filtered using a IIR 4th-order Bessel filter (cut-off frequencies at 600 and 6000 Hz). Digital filtering is implemented using a biquadratic structure for improved numerical stability. No additional buffering is applied at this stage.</p></list-item><list-item><p>*Spike detection: spikes are detected in the filtered signals using a threshold-crossing algorithm (threshold set to 60 µV). For each detected spike, a peak-finding algorithm extracts the spike amplitudes from the four channels. Spike detection introduced a 1.25 ms buffer.</p></list-item><list-item><p>*Decoding - likelihood: using a pre-loaded encoding model constructed ahead of time from training data, the likelihood (<xref ref-type="disp-formula" rid="equ3">Equations 3</xref>) is estimated incrementally for each detected spike in 10 ms time bins. By computing the contribution of each spike to the likelihood as soon as it arrives, the extra latency (in addition to the fixed 10 ms latency imposed by the decoding time bin) is kept to a minimum. The marginal spike count distribution <inline-formula><mml:math id="inf47"><mml:mi>p</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:mi>x</mml:mi></mml:mrow></mml:mfenced></mml:math></inline-formula> and position occupancy distribution <inline-formula><mml:math id="inf48"><mml:mi>π</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:mi>x</mml:mi></mml:mrow></mml:mfenced></mml:math></inline-formula> (<xref ref-type="disp-formula" rid="equ4 equ5">Equations 4 and 5</xref>) are fully pre-computed on a user-defined grid of maze locations to limit the number of on-the-fly computations. The joint spike count probability distribution <inline-formula><mml:math id="inf49"><mml:mi>p</mml:mi><mml:mfenced separators="|"><mml:mrow><mml:mi>a</mml:mi><mml:mo>,</mml:mo><mml:mi>x</mml:mi></mml:mrow></mml:mfenced></mml:math></inline-formula> (<xref ref-type="disp-formula" rid="equ4">Equations 4</xref>) is partially pre-computed (at the expense of using extra memory) and only the contributions of the incoming spikes and their peak amplitudes are evaluated online.</p></list-item><list-item><p>Decoding - posterior: the likelihoods computed for all tetrodes are combined to obtain the final posterior distribution in every 10 ms time bin.</p></list-item><list-item><p>Replay detection: the replay detection and identification algorithm is applied to the posterior probability distributions and the multi-unit activity in the last N<sub>bins</sub> time bins. In the case of a positive detection, an event marked with the detected content (or ‘unknown’ if only the burst criterion was met) is triggered. This stage adds a variable algorithmic latency dependent on the number of time bins N<sub>bins</sub> used to classify a replay event.</p></list-item><list-item><p>Digital output: in the last stage, internal replay detection events are translated to closed-loop TTL pulses through an isolated Digital Input/Output (DIO) module (USB-4750, Advantech Benelux, Breda, The Netherlands) that communicates with Falcon over universal serial bus (USB 2.0). A lock-out period of 75 ms is here imposed after each detection.</p></list-item></list><p>To monitor decoding performance online during active exploration on the maze, an additional processor node in the graph constructed a posterior probability distribution for 200 ms or 250 ms time bins from the output of the decoder stage and generated a stream of MAP estimates.</p><p>To characterize the time needed by the system to report a positive detection following the availability of the corresponding source data, we defined added latency as the difference between the first sample timestamp after the N<sub>bins</sub> of data that triggered an online detection (as logged in Falcon) and the time-stamp of the corresponding detection TTL event as recorded in Cheetah (these time-stamps have a common time base as they both originate in the Digilynx acquisition hardware).</p></sec><sec id="s4-4"><title>Evaluation of online replay classification</title><sec id="s4-4-1"><title>Experimental procedures</title><p>Experimental procedures were approved by the KU Leuven (Leuven, Belgium) animal ethics committee and are in accordance with the European Council Directive, 2010/63/EU. One male Long Evans rat was chronically implanted with a custom micro-drive array (<xref ref-type="bibr" rid="bib31">Kloosterman et al., 2009</xref>) carrying up to 20 tetrodes. Each tetrode was constructed from four twisted 12 µm diameter polyimide coated nickel-chrome wires (Sandvik, Sweden) and gold-plated to an impedance of 300 kOhm using a nanoZ device (White Matter, Seattle, WA). For the surgical procedure, the rat was anesthetized with 5% isoflurane in an induction chamber and mounted in a stereotaxic frame. Throughout the surgery, body temperature, heart and respiratory rates were monitored and the anesthesia was maintained with 1–2% isoflurane delivered via a respiratory mask. The skull was exposed after an incision in the scalp and a hole centered above hippocampal area CA1 (2.5 mm lateral from the midline and 4 mm posterior to Bregma) was drilled to the size of the tetrode bundle. The implant was fixed to the skull using bone screws and light curable dental cement. A screw above the cerebellum served as animal ground. As part of another experiment, twisted bipolar stainless steel stimulation electrodes (60 µm diameter) were implanted in the ventral hippocampal commissure. During a 3 day post-surgical recovery, pain relief was provided through a daily subcutaneous injection of 1 ml/kg Metacam (Boehringer Ingelheim, Germany, 2 mg/ml).</p><p>Recordings were performed relative to a reference electrode in white matter above area CA1. Signals were sampled at 32 kHz, digitized and stored using a 128-channel Digilynx SX system and Cheetah acquisition software (Neuralynx, Bozeman, MT). Spike waveforms were detected by Cheetah on digitally filtered (FIR filter, 600 – 6000 Hz) versions of the recorded signals. Simultaneously with recordings, a duplicate data stream from the Digilynx system was routed to a dedicated workstation for real-time analysis, as described above. The position of the rat was tracked using head-mounted light-emitting diodes and an overhead camera.</p><p>Prior to electrode implantation, the rat was kept on a restricted diet to reduce body weight to 85 – 90% of baseline and was trained to run back and forth on a 120 cm long linear track for food rewards at the ends. As part of an unrelated study, the rat was trained to perform a reward-place association task in a radial maze for three weeks after implantation and prior to tests of online replay identification. In three daily sessions, the rat explored a 3-arm maze for 15 – 20 min before (RUN1) and after (RUN2) a short 10 – 20 min rest period (REST). The maze was composed of three 90 cm long and 8 cm wide elevated linear tracks that were connected to a central platform (50 cm diameter) and ended in a distal 20 × 20 cm reward platform. The configuration of the maze (angles between arms and orientation in the room) were changed daily in order to enhance novelty-induced replay activity (<xref ref-type="bibr" rid="bib5">Cheng and Frank, 2008</xref>). In RUN1, the rat could retrieve choco-rice treats at each reward platform, which were replenished every time all three arms had been visited. The rat traversed each arm at least 14 times, providing sufficient data for constructing and validating the encoding model. During REST, the rat was placed in a familiar sleep box that was located in the same room. Following REST, the rat again explored the same maze in RUN2 and was awarded a variable amount of choco-rice treats at the reward platforms (again, to enhance replay activity [<xref ref-type="bibr" rid="bib1">Ambrose et al., 2016</xref>; <xref ref-type="bibr" rid="bib74">Singer and Frank, 2009</xref>]). In RUN2, the rat traversed each arm at least ten times.</p></sec><sec id="s4-4-2"><title>Construction of encoding model for online replay identification</title><p>Before the start of REST, the spiking and position data recorded in RUN1 were used to construct the encoding model that was needed for subsequent online decoding and replay identification in REST and RUN2. A dedicated processing graph in Falcon software was executed in RUN1 to extract spike times and peak amplitudes from the multi-channel data stream, as well as to collect a video tracking data stream from Cheetah software using Neuralynx’, NET-based NetCom API and a custom C++ router application. This setup ensured that the encoding model could be built with minimal delays and without interruption of data acquisition in Neuralynx’ Cheetah software.</p><p>For decoding purposes, we treated the maze arms as three separate linear tracks with position as a 1D variable that measured the distance from the central platform along the center line of the arms. Video tracked (x,y) coordinates of the animal’s location were first cleared of tracking errors (e.g. removal of positions outside the maze) and short lasting periods of missing data (e.g. due to tracking errors or occlusions of the LEDs) were interpolated, before projection of 2D coordinates to the center line of the nearest maze arm. Running velocity was computed as the Gaussian smoothed gradient of the 1D position variable (bandwidth of Gaussian kernel set to 0.2 s).</p><p>Building the encoding model entails the construction of compressed kernel density estimators (<xref ref-type="bibr" rid="bib75">Sodkomkham et al., 2016</xref>) for the spike count and occupancy probability distributions (<xref ref-type="disp-formula" rid="equ4 equ5">Equations 4 and 5)</xref>. These distributions, and hence the posterior distribution, were evaluated on a regular grid of positions in the maze arms with 2.15 cm grid spacing. The kernel bandwidths for the position and spike amplitude variables were set to 8 cm and 30 µV, respectively. We used a compression threshold in the range [1.8, 2] to speed up online computations at the expense of a small reduction in decoding accuracy. Only spike and position data at times when the rat was running at a speed &gt;8.5 cm/s were incorporated into the encoding model.</p><p>To test the decoding performance, a cross-validation procedure was used in which run epochs (speed &gt;8.5 cm/s) in RUN1 were equally split into a training and testing set. An encoding model was built using the training data set and evaluated on 200 ms time bins in the testing data set. Online replay detection and identification was only tested in recording sessions with a cross-validated median decoding error lower than 10 cm.</p></sec><sec id="s4-4-3"><title>Offline detection of reference replay events</title><p>A set of reference replay events were defined offline for comparison to the online detected events. First, a smoothed histogram (1 ms bins, Gaussian kernel with 15 ms bandwidth) of multi-unit activity (MUA) was constructed using all recorded spikes. Slow non-burst fluctuations were removed from the MUA signal by detrending with an exponentially weighted moving average filter applied forward and backwards (span = 7.5 s (750 samples); corresponding to a half-life of 2.6 s) (<xref ref-type="bibr" rid="bib6">Ciliberti and Kloosterman, 2017</xref>). Bursts were defined as periods in which the standard normalized detrended MUA exceeded 0.5 and had maximum of at least 2.5. Multiple bursts were merged if separated by less than 20 ms.</p><p>Next, we performed neural decoding on the spiking activity in 10 ms time bins for every detected population bursts, using the approach described above for online decoding. However, for a higher decoding accuracy (and at the expense of increased computation time), a lower compression level (range [1, 1.3]) was used for constructing the compressed kernel density estimators in the encoding model.</p><p>Replay content of each decoded population burst was characterized with the following measures computed from the posterior probability distributions:</p><list list-type="order"><list-item><p>Bias: we computed for each maze arm separately the bias as the time-averaged posterior probability <inline-formula><mml:math id="inf50"><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:mfrac><mml:mrow><mml:msub><mml:mo>∑</mml:mo><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:mrow><mml:msub><mml:mo>∑</mml:mo><mml:mrow><mml:mi>x</mml:mi></mml:mrow></mml:msub><mml:mrow><mml:msub><mml:mrow><mml:mi>P</mml:mi></mml:mrow><mml:mrow><mml:mi>t</mml:mi></mml:mrow></mml:msub></mml:mrow></mml:mrow></mml:mrow></mml:mrow><mml:mfenced separators="|"><mml:mrow><mml:mi>x</mml:mi><mml:mo>∈</mml:mo><mml:msub><mml:mrow><mml:mi>x</mml:mi></mml:mrow><mml:mrow><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>m</mml:mi></mml:mrow></mml:msub><mml:mo>|</mml:mo><mml:msup><mml:mrow><mml:mi>A</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn><mml:mo>:</mml:mo><mml:mi>K</mml:mi></mml:mrow></mml:msup></mml:mrow></mml:mfenced></mml:math></inline-formula>. The maximum bias is in the range [<inline-formula><mml:math id="inf51"><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:mn>3</mml:mn></mml:mrow></mml:mfrac></mml:math></inline-formula>, 1], with the lower bound representing equal posterior probability across the three maze arms. This measure was linearly transformed to a bias<sub>max</sub> measure in the range [0, 1]. A null distribution was constructed from the bias<sub>max</sub> measures of 2000 shuffles created by a random circular shift of positions across the three arms (independently for each time bin). This shuffle largely preserved the local spatial structure of the posterior distributions, but disrupted the temporal structure. The bias<sub>max</sub> score was defined as the Z-score of the bias<sub>max</sub> relative to the null distribution.</p></list-item><list-item><p>Line fit: the line fit score was computed as the time-averaged posterior probability within 15 cm of the best-fitting constant-velocity trajectory, as determined using a modified radon transform (<xref ref-type="bibr" rid="bib7">Davidson et al., 2009</xref>; <xref ref-type="bibr" rid="bib32">Kloosterman, 2011</xref>). The line fit score was only defined for the maze arm associated with bias<sub>max</sub>.</p></list-item><list-item><p>Correlation coefficient: 2000 trajectories were sampled from the partial posterior distribution corresponding to the arm associated with bias<sub>max</sub> and the absolute Pearson correlation coefficient <inline-formula><mml:math id="inf52"><mml:mo>|</mml:mo><mml:mi>r</mml:mi><mml:mo>|</mml:mo></mml:math></inline-formula> between time and location was computed.</p></list-item><list-item><p>Sequence score: the Z-score of <inline-formula><mml:math id="inf53"><mml:mo>|</mml:mo><mml:mi>r</mml:mi><mml:mo>|</mml:mo></mml:math></inline-formula> relative to the null distribution constructed by computing <inline-formula><mml:math id="inf54"><mml:mo>|</mml:mo><mml:mi>r</mml:mi><mml:mo>|</mml:mo></mml:math></inline-formula> on 2000 shuffled posterior distributions (random circular shift of positions across the three arms, independently for each time bin) (<xref ref-type="bibr" rid="bib21">Grosmark and Buzsáki, 2016</xref>).</p></list-item></list><p>Replayed trajectories may span two arms in a multi-arm maze (<xref ref-type="bibr" rid="bib86">Wu and Foster, 2014</xref>). For this reason, the replay content measures were computed both for the complete burst event and also separately for the two partial events that consist of the first and second half of the time bins in the event. When the number of time bins was odd, the central time bin contributed to both partial events. Given that the maze arms have equal lengths, the implicit assumption is that most joint replay events switch arm representation in the middle of the event. Only long duration burst events (&gt;100 ms) were considered as putative joint replay events.</p><p>Full and partial burst events were classified as containing replay content if their respective measures met the following criteria: bias<sub>max</sub> score &gt;3 and line fit score &gt;0.1. For long burst events with putative joint replay, if either of the partial events were classified as containing replay content and the full event had a bias<sub>max</sub> that was lower than that of the partial events, then the event was split in half and the two partial events were treated separately. In all, we defined three categories of burst events: short and long burst events without replay content, short and long burst events with a single replay content and long burst events that were split in two with the first, second or both partial events being classified as containing replay content.</p></sec><sec id="s4-4-4"><title>Evaluation of detection performance</title><p>Online replay content identification events were matched to offline reference population bursts if the time of detection occurred inside the burst window. For the purpose of evaluating replay detection performance, only the first online detection in each reference burst was considered. Reference bursts with confirmed replay content were counted as either true positives (TP) or false negatives (FN), depending on whether an online detection was associated with the burst or not. TP detections were further classified as accurate (TP<sub>acc</sub>) if the online identified content matched the reference replay content (i.e. the specific maze arm).</p><p>We further defined two types of false-positive online detections: those that occurred during reference bursts without replay (FP<sub>burst</sub>) and those that occurred outside any reference burst (FP<sub>non_burst</sub>). True negatives (TN) were defined as reference bursts without replay content that were also correctly ignored online.</p><p>Special consideration was given to the putative joint replay events that were split into two partial events. If the first online detection occurred in the first partial event, it was either counted as TP or FP (depending on whether the partial event contained replay content). In this case, the second partial event was not taken into account. If the first online detection occurred in the second partial event, then a TN or FN was counted for the first partial event and a TP or FP was counted for the second partial event (again depending on whether or not the partial events contained replay content). If no online detection occurred, then one FN was counted.</p><p>To characterize the online detection and identification performance, the following metrics were computed:</p><list list-type="bullet"><list-item><p>Sensitivity, which measures the fraction of reference bursts with replay content that were detected as such online and is computed as TP/(TP +FN).</p></list-item><list-item><p>Specificity, which measures the fraction of reference bursts without replay content that were correctly ignored online and is computed as: TN/(TN +FP<sub>burst</sub>). The false-positive rate is the complement of specificity and measures the fraction of reference bursts without replay content that were incorrectly marked as replay events online.</p></list-item><list-item><p>False omission rate (FOR), which measures the fraction of online ignored bursts that contain replay content after all and is computed as FN/(FN +TN).</p></list-item><list-item><p>False discovery rate (FDR), which measures the fraction of online detections that incorrectly marked a reference burst without replay content and is computed as FP<sub>burst</sub>/(FP<sub>burst</sub> +TP).</p></list-item><list-item><p>Content accuracy, which measures the fraction of the online detections that correctly indicated the presence of replay content were classified accurately (i.e. correct maze arm) and is computed as TP<sub>acc</sub>/TP.</p></list-item><list-item><p>Informedness (Youden’s index), which is an unbiased performance measure that balances sensitivity and specificity, computed as: sensitivity + specificity – 1.</p></list-item><list-item><p>Markedness, which is an unbiased performance measure that balances false omission and false discovery rates, computed as: 1 – false omission rate – false discovery rate.</p></list-item><list-item><p>Matthews correlation coefficient (MCC) computed as <inline-formula><mml:math id="inf55"><mml:msqrt><mml:mi>i</mml:mi><mml:mi>n</mml:mi><mml:mi>f</mml:mi><mml:mi>o</mml:mi><mml:mi>r</mml:mi><mml:mi>m</mml:mi><mml:mi>e</mml:mi><mml:mi>d</mml:mi><mml:mi>n</mml:mi><mml:mi>e</mml:mi><mml:mi>s</mml:mi><mml:mi>s</mml:mi><mml:mo>×</mml:mo><mml:mi>m</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>k</mml:mi><mml:mi>e</mml:mi><mml:mi>d</mml:mi><mml:mi>n</mml:mi><mml:mi>e</mml:mi><mml:mi>s</mml:mi><mml:mi>s</mml:mi></mml:msqrt></mml:math></inline-formula>.</p></list-item></list><p>For each (first) online detection that occurred inside a reference burst, the absolute detection latency was computed as the time between the start of the reference burst and the time of the TTL event triggered by the online detection. The relative detection latency was computed as the absolute latency divided by the reference burst duration.</p><p>To test the statistical significance of the Matthews correlation coefficient, we used the <inline-formula><mml:math id="inf56"><mml:msup><mml:mrow><mml:mi>χ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:math></inline-formula> test with the following relation between the correlation and <inline-formula><mml:math id="inf57"><mml:msup><mml:mrow><mml:mi>χ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:math></inline-formula> statistic: <inline-formula><mml:math id="inf58"><mml:msup><mml:mrow><mml:mi>χ</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mo>=</mml:mo><mml:mi>N</mml:mi><mml:mo>×</mml:mo><mml:mi>M</mml:mi><mml:mi>C</mml:mi><mml:msup><mml:mrow><mml:mi>C</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msup></mml:math></inline-formula>, where <italic>N</italic> is the number of samples used to compute the correlation coefficient. To assess the difference between two Matthews correlation coefficients, we applied the Fisher z-transform and compared the difference of the z-scored correlation coefficients to a normal distribution with standard error<inline-formula><mml:math id="inf59"><mml:mi>σ</mml:mi><mml:mo>=</mml:mo><mml:msqrt><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mn>1</mml:mn></mml:mrow></mml:msub><mml:mo>-</mml:mo><mml:mn>3</mml:mn></mml:mrow></mml:mfrac><mml:mo>+</mml:mo><mml:mfrac><mml:mrow><mml:mn>1</mml:mn></mml:mrow><mml:mrow><mml:msub><mml:mrow><mml:mi>N</mml:mi></mml:mrow><mml:mrow><mml:mn>2</mml:mn></mml:mrow></mml:msub><mml:mo>-</mml:mo><mml:mn>3</mml:mn></mml:mrow></mml:mfrac></mml:msqrt></mml:math></inline-formula>.</p></sec></sec><sec id="s4-5"><title>Parameter characterization</title><p>During live tests of replay detection, the parameters of the algorithm were fixed to <inline-formula><mml:math id="inf60"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>u</mml:mi><mml:mi>a</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>= 2.5, <inline-formula><mml:math id="inf61"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>h</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>p</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> = 0.5 and N<sub>bins</sub>= 3 for online detection in REST and to <inline-formula><mml:math id="inf62"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>u</mml:mi><mml:mi>a</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula>= 3, <inline-formula><mml:math id="inf63"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>h</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>p</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> = 0.65 and N<sub>bins</sub>= 3 for online detections in RUN2. Offline, the effect of varying the threshold parameters <inline-formula><mml:math id="inf64"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>u</mml:mi><mml:mi>a</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and <inline-formula><mml:math id="inf65"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>h</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>p</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> on replay detection and identification performance was evaluated for all datasets. A simulator program, written in the Python language, applied the online algorithm (including 75 ms lock-out) to the saved posterior distributions that were produced by the decoder stage in Falcon’s processing graph. For the offline simulations, the closed-loop detection latency is unavailable and the identification latency, defined as the difference between the start of the reference burst and the end of the N<sub>bins</sub> x 10 ms time window that triggered a positive detection, is reported instead.</p></sec><sec id="s4-6"><title>Testing the effect of data availability</title><p>To explore the effect of data availability on online replay content detection, subsets of tetrodes were repeatedly sampled from one dataset (dataset #2). For each sample, online detection was simulated offline with playback of spiking data (previously recorded with Cheetah software). For each size of the tetrode subset (minimum 1 and maximum 14), we sampled either all possible combinations or 50 randomly selected combinations (whichever was smaller). For all subsampled tetrode sets, replay detection performance was assessed as before with <inline-formula><mml:math id="inf66"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>u</mml:mi><mml:mi>a</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> and <inline-formula><mml:math id="inf67"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>h</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>p</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula> parameters optimized separately each time. In all simulations, we used the reference content for performance evaluation that was computed on the original full dataset as described above. Reported detection latencies exclude the contribution of the online added computational latency.</p></sec><sec id="s4-7"><title>Stress tests of closed-loop system</title><p>Stress tests were aimed at determining the added latency of the online decoding system in conditions with high spike rates (from 0 to 1000 spikes/s per tetrode) and high tetrode/channel counts (16-tetrode/64-channel, 24-tetrode/96-channel and 32-tetrode/128-channel).</p><p>An analog square wave signal was used as artificial spike generator and fed into four 32-channel Signal Mouse testing boards (Neuralynx, Bozeman, MT, USA) that were connected to the analog preamplifiers and DigiLynx acquisition system. After attenuation by the testing boards, the amplitude of the square wave was 5 mV and the frequency was varied from 0 to 1000 Hz.</p><p>Falcon software ran a processing graph that was very similar to that used for live experiments (<xref ref-type="fig" rid="fig1s1">Figure 1—figure supplement 1a</xref>), with a few modifications. First, file serializer nodes were removed and a separate dispatcher node for each group of 32 channels was used (to minimize chances of missed packets). Second, to simulate high tetrode numbers, the parallel per-tetrode processing pipelines (including encoding models built from the original data) were duplicated to test up to 32 tetrodes. Third, to replicate the computations performed during live tests, the neural decoding nodes used pre-recorded spike amplitudes instead of the amplitudes of the incoming artificial spikes. Finally, the replay content classifier node was programmed to generate a closed-loop feedback event every 100 ms (10 bins) for 5 min (for a total of 3000 test latencies). Added latency was computed as the difference between the recorded time-stamp of the closed-loop feedback event and the time-stamp that marked the end of a 100 ms test period.</p><p>Stress tests were performed on the same 32-core workstation used for live tests (see 'Implementation of online replay detection') and also on a 4-core machine (single CPU, Intel Core i7-4790 @ 3.60 GHz, 16 GB of RAM and 8 MB of smart cache). Both machines used Hyper-Threading and ran a 64-bit Linux Mint 18 (kernel version: 4.4.0_2.1 generic) operating system.</p><table-wrap id="table4" position="float"><object-id pub-id-type="doi">10.7554/eLife.36275.021</object-id><label>Table 4.</label><caption><title>Optimal parameters.</title></caption><table frame="hsides" rules="groups"><thead><tr><th valign="bottom">Dataset</th><th valign="bottom">Epoch</th><th valign="bottom">Live <inline-formula><mml:math id="inf68"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>u</mml:mi><mml:mi>a</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula></th><th valign="bottom">Live <inline-formula><mml:math id="inf69"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>h</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>p</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula></th><th valign="bottom">Optimal <inline-formula><mml:math id="inf70"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>m</mml:mi><mml:mi>u</mml:mi><mml:mi>a</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula></th><th valign="bottom">Optimal <inline-formula><mml:math id="inf71"><mml:msub><mml:mrow><mml:mi>θ</mml:mi></mml:mrow><mml:mrow><mml:mi>s</mml:mi><mml:mi>h</mml:mi><mml:mi>a</mml:mi><mml:mi>r</mml:mi><mml:mi>p</mml:mi></mml:mrow></mml:msub></mml:math></inline-formula></th><th valign="bottom">Optimal <break/>correlation</th><th valign="bottom"><inline-formula><mml:math id="inf72"><mml:mi>Δ</mml:mi></mml:math></inline-formula>Correlation <break/>live test<sup>*</sup></th><th valign="bottom">Out of burst rate[min<sup>−1</sup>]</th></tr></thead><tbody><tr><td valign="top">1</td><td valign="top">REST</td><td valign="top">2.50</td><td valign="top">0.50</td><td valign="top">4.00</td><td valign="top">0.80</td><td valign="top">0.76</td><td valign="top">+0.27<sup>***</sup></td><td valign="top">0.08</td></tr><tr><td valign="top">1</td><td valign="top">RUN2</td><td valign="top">3.00</td><td valign="top">0.65</td><td valign="top">0.00</td><td valign="top">0.65</td><td valign="top">0.31</td><td valign="top">+0.03</td><td valign="top">28.57</td></tr><tr><td valign="top">2</td><td valign="top">REST</td><td valign="top">2.50</td><td valign="top">0.50</td><td valign="top">4.75</td><td valign="top">0.65</td><td valign="top">0.52</td><td valign="top">+0.12<sup>**</sup></td><td valign="top">0.00</td></tr><tr><td valign="top">2</td><td valign="top">RUN2</td><td valign="top">3.00</td><td valign="top">0.65</td><td valign="top">1.75</td><td valign="top">0.65</td><td valign="top">0.53</td><td valign="top">+0.05</td><td valign="top">5.68</td></tr><tr><td valign="top">3</td><td valign="top">REST</td><td valign="top">2.50</td><td valign="top">0.50</td><td valign="top">5.75</td><td valign="top">0.60</td><td valign="top">0.47</td><td valign="top">+0.13<sup>**</sup></td><td valign="top">0.05</td></tr><tr><td valign="top">3</td><td valign="top">RUN2</td><td valign="top">3.00</td><td valign="top">0.65</td><td valign="top">1.00</td><td valign="top">0.65</td><td valign="top">0.33</td><td valign="top">+0.05</td><td valign="top">30.81</td></tr></tbody></table><table-wrap-foot><fn><p><sup>*</sup>Significance: *=p &lt; 0.05, **=p &lt; 0.01, ***=p &lt; 0.001</p></fn></table-wrap-foot></table-wrap></sec></sec></body><back><sec id="s6" sec-type="additional-information"><title>Additional information</title><fn-group content-type="competing-interest"><title>Competing interests</title><fn fn-type="COI-statement" id="conf1"><p>No competing interests declared</p></fn></fn-group><fn-group content-type="author-contribution"><title>Author contributions</title><fn fn-type="con" id="con1"><p>Conceptualization, Data curation, Software, Formal analysis, Validation, Visualization, Methodology, Writing—original draft, Writing—review and editing</p></fn><fn fn-type="con" id="con2"><p>Investigation, Visualization, Writing—review and editing</p></fn><fn fn-type="con" id="con3"><p>Conceptualization, Software, Supervision, Funding acquisition, Visualization, Project administration, Writing—review and editing</p></fn></fn-group><fn-group content-type="ethics-information"><title>Ethics</title><fn fn-type="other"><p>Animal experimentation: This study was performed in accordance with the European Council Directive 2010/63/EU on the protection of animals used for scientific purposes. All animals were handled according to protocols approved by the KU Leuven animal ethics committee (project license number: 119/2015).</p></fn></fn-group></sec><sec id="s5" sec-type="supplementary-material"><title>Additional files</title><supplementary-material id="transrepform"><object-id pub-id-type="doi">10.7554/eLife.36275.022</object-id><label>Transparent reporting form</label><media mime-subtype="pdf" mimetype="application" xlink:href="elife-36275-transrepform-v1.pdf"/></supplementary-material><sec id="s7" sec-type="data-availability"><title>Data availability</title><p>Datasets are available on the Collaborative Research in Computational Neuroscience website (<ext-link ext-link-type="uri" xlink:href="http://crcns.org">http://crcns.org</ext-link>). The code for online decoding is integrated into the Falcon software platform and the latest version can be retrieved from <ext-link ext-link-type="uri" xlink:href="https://bitbucket.org/kloostermannerflab/falcon-server">https://bitbucket.org/kloostermannerflab/falcon-server</ext-link> (copy archived at <ext-link ext-link-type="uri" xlink:href="https://github.com/elifesciences-publications/falcon-server">https://github.com/elifesciences-publications/falcon-server</ext-link>). The code for offline analysis can be obtained from <ext-link ext-link-type="uri" xlink:href="https://bitbucket.org/kloostermannerflab/ciliberti_elife2018_realtimereplay">https://bitbucket.org/kloostermannerflab/ciliberti_elife2018_realtimereplay</ext-link> (copy archived at <ext-link ext-link-type="uri" xlink:href="https://github.com/elifesciences-publications/Ciliberti_Elife2018_RealTimeReplay">https://github.com/elifesciences-publications/Ciliberti_Elife2018_RealTimeReplay</ext-link>).</p><p>The following dataset was generated:</p><p><related-object content-type="generated-dataset" id="dataset1" source-id="http://dx.doi.org/10.6080/K0PN93T4" source-id-type="uri"><collab collab-type="author">Davide Ciliberti</collab><collab collab-type="author">Frédéric Michon</collab><collab collab-type="author">Fabian Kloosterman</collab><year>2018</year><source>Extracellular recordings from rat hippocampal area CA1 during rest and exploration of a 3-arm maze along with results of real-time and offline detection of hippocampal replay content</source><ext-link ext-link-type="uri" xlink:href="http://dx.doi.org/10.6080/K0PN93T4">http://dx.doi.org/10.6080/K0PN93T4</ext-link><comment>Publicly available at Collaborative Research in Computational Neuroscience - Data sharing.</comment></related-object></p></sec></sec><ref-list><title>References</title><ref id="bib1"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ambrose</surname> <given-names>RE</given-names></name><name><surname>Pfeiffer</surname> <given-names>BE</given-names></name><name><surname>Foster</surname> <given-names>DJ</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Reverse replay of hippocampal place cells is uniquely modulated by changing reward</article-title><source>Neuron</source><volume>91</volume><fpage>1124</fpage><lpage>1136</lpage><pub-id pub-id-type="doi">10.1016/j.neuron.2016.07.047</pub-id><pub-id pub-id-type="pmid">27568518</pub-id></element-citation></ref><ref id="bib2"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Andersen</surname> <given-names>RA</given-names></name><name><surname>Hwang</surname> <given-names>EJ</given-names></name><name><surname>Mulliken</surname> <given-names>GH</given-names></name></person-group><year iso-8601-date="2010">2010</year><article-title>Cognitive neural prosthetics</article-title><source>Annual Review of Psychology</source><volume>61</volume><fpage>169</fpage><lpage>190</lpage><pub-id pub-id-type="doi">10.1146/annurev.psych.093008.100503</pub-id><pub-id pub-id-type="pmid">19575625</pub-id></element-citation></ref><ref id="bib3"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Anderson</surname> <given-names>MI</given-names></name><name><surname>Jeffery</surname> <given-names>KJ</given-names></name></person-group><year iso-8601-date="2003">2003</year><article-title>Heterogeneous modulation of place cell firing by changes in context</article-title><source>The Journal of Neuroscience</source><volume>23</volume><fpage>8827</fpage><lpage>8835</lpage><pub-id pub-id-type="doi">10.1523/JNEUROSCI.23-26-08827.2003</pub-id></element-citation></ref><ref id="bib4"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Axmacher</surname> <given-names>N</given-names></name><name><surname>Draguhn</surname> <given-names>A</given-names></name><name><surname>Elger</surname> <given-names>CE</given-names></name><name><surname>Fell</surname> <given-names>J</given-names></name></person-group><year iso-8601-date="2009">2009</year><article-title>Memory processes during sleep: beyond the standard consolidation theory</article-title><source>Cellular and Molecular Life Sciences</source><volume>66</volume><fpage>2285</fpage><lpage>2297</lpage><pub-id pub-id-type="doi">10.1007/s00018-009-0019-1</pub-id><pub-id pub-id-type="pmid">19322518</pub-id></element-citation></ref><ref id="bib5"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Cheng</surname> <given-names>S</given-names></name><name><surname>Frank</surname> <given-names>LM</given-names></name></person-group><year iso-8601-date="2008">2008</year><article-title>New experiences enhance coordinated neural activity in the Hippocampus</article-title><source>Neuron</source><volume>57</volume><fpage>303</fpage><lpage>313</lpage><pub-id pub-id-type="doi">10.1016/j.neuron.2007.11.035</pub-id><pub-id pub-id-type="pmid">18215626</pub-id></element-citation></ref><ref id="bib6"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ciliberti</surname> <given-names>D</given-names></name><name><surname>Kloosterman</surname> <given-names>F</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Falcon: a highly flexible open-source software for closed-loop neuroscience</article-title><source>Journal of Neural Engineering</source><volume>14</volume><elocation-id>045004</elocation-id><pub-id pub-id-type="doi">10.1088/1741-2552/aa7526</pub-id><pub-id pub-id-type="pmid">28548044</pub-id></element-citation></ref><ref id="bib7"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Davidson</surname> <given-names>TJ</given-names></name><name><surname>Kloosterman</surname> <given-names>F</given-names></name><name><surname>Wilson</surname> <given-names>MA</given-names></name></person-group><year iso-8601-date="2009">2009</year><article-title>Hippocampal replay of extended experience</article-title><source>Neuron</source><volume>63</volume><fpage>497</fpage><lpage>507</lpage><pub-id pub-id-type="doi">10.1016/j.neuron.2009.07.027</pub-id><pub-id pub-id-type="pmid">19709631</pub-id></element-citation></ref><ref id="bib8"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>de Lavilléon</surname> <given-names>G</given-names></name><name><surname>Lacroix</surname> <given-names>MM</given-names></name><name><surname>Rondi-Reig</surname> <given-names>L</given-names></name><name><surname>Benchenane</surname> <given-names>K</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Explicit memory creation during sleep demonstrates a causal role of place cells in navigation</article-title><source>Nature Neuroscience</source><volume>18</volume><fpage>493</fpage><lpage>495</lpage><pub-id pub-id-type="doi">10.1038/nn.3970</pub-id><pub-id pub-id-type="pmid">25751533</pub-id></element-citation></ref><ref id="bib9"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Deng</surname> <given-names>X</given-names></name><name><surname>Liu</surname> <given-names>DF</given-names></name><name><surname>Karlsson</surname> <given-names>MP</given-names></name><name><surname>Frank</surname> <given-names>LM</given-names></name><name><surname>Eden</surname> <given-names>UT</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Rapid classification of hippocampal replay content for real-time applications</article-title><source>Journal of Neurophysiology</source><volume>116</volume><fpage>2221</fpage><lpage>2235</lpage><pub-id pub-id-type="doi">10.1152/jn.00151.2016</pub-id><pub-id pub-id-type="pmid">27535369</pub-id></element-citation></ref><ref id="bib10"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Diba</surname> <given-names>K</given-names></name><name><surname>Buzsáki</surname> <given-names>G</given-names></name></person-group><year iso-8601-date="2007">2007</year><article-title>Forward and reverse hippocampal place-cell sequences during ripples</article-title><source>Nature Neuroscience</source><volume>10</volume><fpage>1241</fpage><lpage>1242</lpage><pub-id pub-id-type="doi">10.1038/nn1961</pub-id><pub-id pub-id-type="pmid">17828259</pub-id></element-citation></ref><ref id="bib11"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Dupret</surname> <given-names>D</given-names></name><name><surname>O'Neill</surname> <given-names>J</given-names></name><name><surname>Pleydell-Bouverie</surname> <given-names>B</given-names></name><name><surname>Csicsvari</surname> <given-names>J</given-names></name></person-group><year iso-8601-date="2010">2010</year><article-title>The reorganization and reactivation of hippocampal maps predict spatial memory performance</article-title><source>Nature Neuroscience</source><volume>13</volume><fpage>995</fpage><lpage>1002</lpage><pub-id pub-id-type="doi">10.1038/nn.2599</pub-id><pub-id pub-id-type="pmid">20639874</pub-id></element-citation></ref><ref id="bib12"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ego-Stengel</surname> <given-names>V</given-names></name><name><surname>Wilson</surname> <given-names>MA</given-names></name></person-group><year iso-8601-date="2010">2010</year><article-title>Disruption of ripple-associated hippocampal activity during rest impairs spatial learning in the rat</article-title><source>Hippocampus</source><volume>20</volume><fpage>1</fpage><lpage>10</lpage><pub-id pub-id-type="doi">10.1002/hipo.20707</pub-id><pub-id pub-id-type="pmid">19816984</pub-id></element-citation></ref><ref id="bib13"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Fischer</surname> <given-names>J</given-names></name><name><surname>Milekovic</surname> <given-names>T</given-names></name><name><surname>Schneider</surname> <given-names>G</given-names></name><name><surname>Mehring</surname> <given-names>C</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Low-latency multi-threaded processing of neuronal signals for brain-computer interfaces</article-title><source>Frontiers in Neuroengineering</source><volume>7</volume><elocation-id>1</elocation-id><pub-id pub-id-type="doi">10.3389/fneng.2014.00001</pub-id><pub-id pub-id-type="pmid">24478695</pub-id></element-citation></ref><ref id="bib14"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Foster</surname> <given-names>DJ</given-names></name><name><surname>Wilson</surname> <given-names>MA</given-names></name></person-group><year iso-8601-date="2006">2006</year><article-title>Reverse replay of behavioural sequences in hippocampal place cells during the awake state</article-title><source>Nature</source><volume>440</volume><fpage>680</fpage><lpage>683</lpage><pub-id pub-id-type="doi">10.1038/nature04587</pub-id><pub-id pub-id-type="pmid">16474382</pub-id></element-citation></ref><ref id="bib15"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Fraser</surname> <given-names>GW</given-names></name><name><surname>Chase</surname> <given-names>SM</given-names></name><name><surname>Whitford</surname> <given-names>A</given-names></name><name><surname>Schwartz</surname> <given-names>AB</given-names></name></person-group><year iso-8601-date="2009">2009</year><article-title>Control of a brain-computer interface without spike sorting</article-title><source>Journal of Neural Engineering</source><volume>6</volume><elocation-id>055004</elocation-id><pub-id pub-id-type="doi">10.1088/1741-2560/6/5/055004</pub-id><pub-id pub-id-type="pmid">19721186</pub-id></element-citation></ref><ref id="bib16"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Girardeau</surname> <given-names>G</given-names></name><name><surname>Benchenane</surname> <given-names>K</given-names></name><name><surname>Wiener</surname> <given-names>SI</given-names></name><name><surname>Buzsáki</surname> <given-names>G</given-names></name><name><surname>Zugaro</surname> <given-names>MB</given-names></name></person-group><year iso-8601-date="2009">2009</year><article-title>Selective suppression of hippocampal ripples impairs spatial memory</article-title><source>Nature Neuroscience</source><volume>12</volume><fpage>1222</fpage><lpage>1223</lpage><pub-id pub-id-type="doi">10.1038/nn.2384</pub-id><pub-id pub-id-type="pmid">19749750</pub-id></element-citation></ref><ref id="bib17"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Girardeau</surname> <given-names>G</given-names></name><name><surname>Cei</surname> <given-names>A</given-names></name><name><surname>Zugaro</surname> <given-names>M</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Learning-induced plasticity regulates hippocampal sharp wave-ripple drive</article-title><source>Journal of Neuroscience</source><volume>34</volume><fpage>5176</fpage><lpage>5183</lpage><pub-id pub-id-type="doi">10.1523/JNEUROSCI.4288-13.2014</pub-id><pub-id pub-id-type="pmid">24719097</pub-id></element-citation></ref><ref id="bib18"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Girardeau</surname> <given-names>G</given-names></name><name><surname>Inema</surname> <given-names>I</given-names></name><name><surname>Buzsáki</surname> <given-names>G</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Reactivations of emotional memory in the hippocampus-amygdala system during sleep</article-title><source>Nature Neuroscience</source><volume>20</volume><fpage>1634</fpage><lpage>1642</lpage><pub-id pub-id-type="doi">10.1038/nn.4637</pub-id><pub-id pub-id-type="pmid">28892057</pub-id></element-citation></ref><ref id="bib19"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Gomperts</surname> <given-names>SN</given-names></name><name><surname>Kloosterman</surname> <given-names>F</given-names></name><name><surname>Wilson</surname> <given-names>MA</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>VTA neurons coordinate with the hippocampal reactivation of spatial experience</article-title><source>eLife</source><volume>4</volume><elocation-id>e05360</elocation-id><pub-id pub-id-type="doi">10.7554/eLife.05360</pub-id><pub-id pub-id-type="pmid">26465113</pub-id></element-citation></ref><ref id="bib20"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Grosenick</surname> <given-names>L</given-names></name><name><surname>Marshel</surname> <given-names>JH</given-names></name><name><surname>Deisseroth</surname> <given-names>K</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Closed-loop and activity-guided optogenetic control</article-title><source>Neuron</source><volume>86</volume><fpage>106</fpage><lpage>139</lpage><pub-id pub-id-type="doi">10.1016/j.neuron.2015.03.034</pub-id><pub-id pub-id-type="pmid">25856490</pub-id></element-citation></ref><ref id="bib21"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Grosmark</surname> <given-names>AD</given-names></name><name><surname>Buzsáki</surname> <given-names>G</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Diversity in neural firing dynamics supports both rigid and learned hippocampal sequences</article-title><source>Science</source><volume>351</volume><fpage>1440</fpage><lpage>1443</lpage><pub-id pub-id-type="doi">10.1126/science.aad1935</pub-id><pub-id pub-id-type="pmid">27013730</pub-id></element-citation></ref><ref id="bib22"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Guger</surname> <given-names>C</given-names></name><name><surname>Gener</surname> <given-names>T</given-names></name><name><surname>Pennartz</surname> <given-names>CM</given-names></name><name><surname>Brotons-Mas</surname> <given-names>JR</given-names></name><name><surname>Edlinger</surname> <given-names>G</given-names></name><name><surname>Bermúdez I Badia</surname> <given-names>S</given-names></name><name><surname>Verschure</surname> <given-names>P</given-names></name><name><surname>Schaffelhofer</surname> <given-names>S</given-names></name><name><surname>Sanchez-Vives</surname> <given-names>MV</given-names></name></person-group><year iso-8601-date="2011">2011</year><article-title>Real-time position reconstruction with hippocampal place cells</article-title><source>Frontiers in Neuroscience</source><volume>5</volume><elocation-id>85</elocation-id><pub-id pub-id-type="doi">10.3389/fnins.2011.00085</pub-id><pub-id pub-id-type="pmid">21808603</pub-id></element-citation></ref><ref id="bib23"><element-citation publication-type="book"><person-group person-group-type="author"><name><surname>Hady</surname> <given-names>AE</given-names></name></person-group><year iso-8601-date="2016">2016</year><source>Closed loop neuroscience</source><publisher-name>Elsevier</publisher-name></element-citation></ref><ref id="bib24"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hampson</surname> <given-names>RE</given-names></name><name><surname>Song</surname> <given-names>D</given-names></name><name><surname>Robinson</surname> <given-names>BS</given-names></name><name><surname>Fetterhoff</surname> <given-names>D</given-names></name><name><surname>Dakos</surname> <given-names>AS</given-names></name><name><surname>Roeder</surname> <given-names>BM</given-names></name><name><surname>She</surname> <given-names>X</given-names></name><name><surname>Wicks</surname> <given-names>RT</given-names></name><name><surname>Witcher</surname> <given-names>MR</given-names></name><name><surname>Couture</surname> <given-names>DE</given-names></name><name><surname>Laxton</surname> <given-names>AW</given-names></name><name><surname>Munger-Clary</surname> <given-names>H</given-names></name><name><surname>Popli</surname> <given-names>G</given-names></name><name><surname>Sollman</surname> <given-names>MJ</given-names></name><name><surname>Whitlow</surname> <given-names>CT</given-names></name><name><surname>Marmarelis</surname> <given-names>VZ</given-names></name><name><surname>Berger</surname> <given-names>TW</given-names></name><name><surname>Deadwyler</surname> <given-names>SA</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>Developing a hippocampal neural prosthetic to facilitate human memory encoding and recall</article-title><source>Journal of Neural Engineering</source><volume>15</volume><elocation-id>036014</elocation-id><pub-id pub-id-type="doi">10.1088/1741-2552/aaaed7</pub-id></element-citation></ref><ref id="bib25"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Harris</surname> <given-names>KD</given-names></name></person-group><year iso-8601-date="2005">2005</year><article-title>Neural signatures of cell assembly organization</article-title><source>Nature Reviews Neuroscience</source><volume>6</volume><fpage>399</fpage><lpage>407</lpage><pub-id pub-id-type="doi">10.1038/nrn1669</pub-id><pub-id pub-id-type="pmid">15861182</pub-id></element-citation></ref><ref id="bib26"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Hoffman</surname> <given-names>KL</given-names></name><name><surname>McNaughton</surname> <given-names>BL</given-names></name></person-group><year iso-8601-date="2002">2002</year><article-title>Coordinated reactivation of distributed memory traces in primate neocortex</article-title><source>Science</source><volume>297</volume><fpage>2070</fpage><lpage>2073</lpage><pub-id pub-id-type="doi">10.1126/science.1073538</pub-id><pub-id pub-id-type="pmid">12242447</pub-id></element-citation></ref><ref id="bib27"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ibáñez</surname> <given-names>J</given-names></name><name><surname>Serrano</surname> <given-names>JI</given-names></name><name><surname>del Castillo</surname> <given-names>MD</given-names></name><name><surname>Monge-Pereira</surname> <given-names>E</given-names></name><name><surname>Molina-Rueda</surname> <given-names>F</given-names></name><name><surname>Alguacil-Diego</surname> <given-names>I</given-names></name><name><surname>Pons</surname> <given-names>JL</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Detection of the onset of upper-limb movements based on the combined analysis of changes in the sensorimotor rhythms and slow cortical potentials</article-title><source>Journal of Neural Engineering</source><volume>11</volume><elocation-id>056009</elocation-id><pub-id pub-id-type="doi">10.1088/1741-2560/11/5/056009</pub-id><pub-id pub-id-type="pmid">25082789</pub-id></element-citation></ref><ref id="bib28"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Jadhav</surname> <given-names>SP</given-names></name><name><surname>Kemere</surname> <given-names>C</given-names></name><name><surname>German</surname> <given-names>PW</given-names></name><name><surname>Frank</surname> <given-names>LM</given-names></name></person-group><year iso-8601-date="2012">2012</year><article-title>Awake hippocampal sharp-wave ripples support spatial memory</article-title><source>Science</source><volume>336</volume><fpage>1454</fpage><lpage>1458</lpage><pub-id pub-id-type="doi">10.1126/science.1217230</pub-id><pub-id pub-id-type="pmid">22555434</pub-id></element-citation></ref><ref id="bib29"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ji</surname> <given-names>D</given-names></name><name><surname>Wilson</surname> <given-names>MA</given-names></name></person-group><year iso-8601-date="2007">2007</year><article-title>Coordinated memory replay in the visual cortex and Hippocampus during sleep</article-title><source>Nature Neuroscience</source><volume>10</volume><fpage>100</fpage><lpage>107</lpage><pub-id pub-id-type="doi">10.1038/nn1825</pub-id><pub-id pub-id-type="pmid">17173043</pub-id></element-citation></ref><ref id="bib30"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Karlsson</surname> <given-names>MP</given-names></name><name><surname>Frank</surname> <given-names>LM</given-names></name></person-group><year iso-8601-date="2009">2009</year><article-title>Awake replay of remote experiences in the Hippocampus</article-title><source>Nature Neuroscience</source><volume>12</volume><fpage>913</fpage><lpage>918</lpage><pub-id pub-id-type="doi">10.1038/nn.2344</pub-id><pub-id pub-id-type="pmid">19525943</pub-id></element-citation></ref><ref id="bib31"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kloosterman</surname> <given-names>F</given-names></name><name><surname>Davidson</surname> <given-names>TJ</given-names></name><name><surname>Gomperts</surname> <given-names>SN</given-names></name><name><surname>Layton</surname> <given-names>SP</given-names></name><name><surname>Hale</surname> <given-names>G</given-names></name><name><surname>Nguyen</surname> <given-names>DP</given-names></name><name><surname>Wilson</surname> <given-names>MA</given-names></name></person-group><year iso-8601-date="2009">2009</year><article-title>Micro-drive array for chronic &lt;em&gt;in vivo&lt;/em&gt; recording: drive fabrication</article-title><source>Journal of Visualized Experiments</source><volume>26</volume><pub-id pub-id-type="doi">10.3791/1094</pub-id></element-citation></ref><ref id="bib32"><element-citation publication-type="book"><person-group person-group-type="author"><name><surname>Kloosterman</surname> <given-names>F</given-names></name></person-group><year iso-8601-date="2011">2011</year><chapter-title>Analysis of hippocampal memory replay using neural population decoding</chapter-title><person-group person-group-type="editor"><name><surname>Fellin</surname> <given-names>T</given-names></name><name><surname>Halassa</surname> <given-names>M</given-names></name></person-group><source>Neuronal Network Analysis</source><publisher-name>Springer</publisher-name><fpage>259</fpage><lpage>282</lpage><pub-id pub-id-type="doi">10.1007/7657_2011_8</pub-id></element-citation></ref><ref id="bib33"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kloosterman</surname> <given-names>F</given-names></name><name><surname>Layton</surname> <given-names>SP</given-names></name><name><surname>Chen</surname> <given-names>Z</given-names></name><name><surname>Wilson</surname> <given-names>MA</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Bayesian decoding using unsorted spikes in the rat Hippocampus</article-title><source>Journal of Neurophysiology</source><volume>111</volume><fpage>217</fpage><lpage>227</lpage><pub-id pub-id-type="doi">10.1152/jn.01046.2012</pub-id><pub-id pub-id-type="pmid">24089403</pub-id></element-citation></ref><ref id="bib34"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Kovács</surname> <given-names>KA</given-names></name><name><surname>O'Neill</surname> <given-names>J</given-names></name><name><surname>Schoenenberger</surname> <given-names>P</given-names></name><name><surname>Penttonen</surname> <given-names>M</given-names></name><name><surname>Ranguel Guerrero</surname> <given-names>DK</given-names></name><name><surname>Csicsvari</surname> <given-names>J</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Optogenetically blocking sharp wave ripple events in sleep does not interfere with the formation of stable spatial representation in the CA1 area of the Hippocampus</article-title><source>PLOS ONE</source><volume>11</volume><elocation-id>e0164675</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pone.0164675</pub-id><pub-id pub-id-type="pmid">27760158</pub-id></element-citation></ref><ref id="bib35"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lansink</surname> <given-names>CS</given-names></name><name><surname>Goltstein</surname> <given-names>PM</given-names></name><name><surname>Lankelma</surname> <given-names>JV</given-names></name><name><surname>Joosten</surname> <given-names>RN</given-names></name><name><surname>McNaughton</surname> <given-names>BL</given-names></name><name><surname>Pennartz</surname> <given-names>CM</given-names></name></person-group><year iso-8601-date="2008">2008</year><article-title>Preferential reactivation of motivationally relevant information in the ventral striatum</article-title><source>Journal of Neuroscience</source><volume>28</volume><fpage>6372</fpage><lpage>6382</lpage><pub-id pub-id-type="doi">10.1523/JNEUROSCI.1054-08.2008</pub-id><pub-id pub-id-type="pmid">18562607</pub-id></element-citation></ref><ref id="bib36"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lansink</surname> <given-names>CS</given-names></name><name><surname>Goltstein</surname> <given-names>PM</given-names></name><name><surname>Lankelma</surname> <given-names>JV</given-names></name><name><surname>McNaughton</surname> <given-names>BL</given-names></name><name><surname>Pennartz</surname> <given-names>CM</given-names></name></person-group><year iso-8601-date="2009">2009</year><article-title>Hippocampus leads ventral striatum in replay of place-reward information</article-title><source>PLOS Biology</source><volume>7</volume><elocation-id>e1000173</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pbio.1000173</pub-id><pub-id pub-id-type="pmid">19688032</pub-id></element-citation></ref><ref id="bib37"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Latuske</surname> <given-names>P</given-names></name><name><surname>Kornienko</surname> <given-names>O</given-names></name><name><surname>Kohler</surname> <given-names>L</given-names></name><name><surname>Allen</surname> <given-names>K</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Hippocampal remapping and its entorhinal origin</article-title><source>Frontiers in Behavioral Neuroscience</source><volume>11</volume><elocation-id>253</elocation-id><pub-id pub-id-type="doi">10.3389/fnbeh.2017.00253</pub-id><pub-id pub-id-type="pmid">29354038</pub-id></element-citation></ref><ref id="bib38"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lebedev</surname> <given-names>MA</given-names></name><name><surname>Nicolelis</surname> <given-names>MA</given-names></name></person-group><year iso-8601-date="2006">2006</year><article-title>Brain-machine interfaces: past, present and future</article-title><source>Trends in Neurosciences</source><volume>29</volume><fpage>536</fpage><lpage>546</lpage><pub-id pub-id-type="doi">10.1016/j.tins.2006.07.004</pub-id><pub-id pub-id-type="pmid">16859758</pub-id></element-citation></ref><ref id="bib39"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lee</surname> <given-names>AK</given-names></name><name><surname>Wilson</surname> <given-names>MA</given-names></name></person-group><year iso-8601-date="2002">2002</year><article-title>Memory of sequential experience in the Hippocampus during slow wave sleep</article-title><source>Neuron</source><volume>36</volume><fpage>1183</fpage><lpage>1194</lpage><pub-id pub-id-type="doi">10.1016/S0896-6273(02)01096-6</pub-id><pub-id pub-id-type="pmid">12495631</pub-id></element-citation></ref><ref id="bib40"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Lewis</surname> <given-names>PA</given-names></name><name><surname>Durrant</surname> <given-names>SJ</given-names></name></person-group><year iso-8601-date="2011">2011</year><article-title>Overlapping memory replay during sleep builds cognitive schemata</article-title><source>Trends in Cognitive Sciences</source><volume>15</volume><fpage>343</fpage><lpage>351</lpage><pub-id pub-id-type="doi">10.1016/j.tics.2011.06.004</pub-id><pub-id pub-id-type="pmid">21764357</pub-id></element-citation></ref><ref id="bib41"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Li</surname> <given-names>J</given-names></name><name><surname>Li</surname> <given-names>Z</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Sums of spike waveform features for motor decoding</article-title><source>Frontiers in Neuroscience</source><volume>11</volume><elocation-id>406</elocation-id><pub-id pub-id-type="doi">10.3389/fnins.2017.00406</pub-id><pub-id pub-id-type="pmid">28769745</pub-id></element-citation></ref><ref id="bib42"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Luczak</surname> <given-names>A</given-names></name><name><surname>Bartho</surname> <given-names>P</given-names></name><name><surname>Marguet</surname> <given-names>SL</given-names></name><name><surname>Buzsaki</surname> <given-names>G</given-names></name><name><surname>Harris</surname> <given-names>KD</given-names></name></person-group><year iso-8601-date="2007">2007</year><article-title>Sequential structure of neocortical spontaneous activity in vivo</article-title><source>Proceedings of the National Academy of Sciences</source><volume>104</volume><fpage>347</fpage><lpage>352</lpage><pub-id pub-id-type="doi">10.1073/pnas.0605643104</pub-id></element-citation></ref><ref id="bib43"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Luczak</surname> <given-names>A</given-names></name><name><surname>Barthó</surname> <given-names>P</given-names></name><name><surname>Harris</surname> <given-names>KD</given-names></name></person-group><year iso-8601-date="2009">2009</year><article-title>Spontaneous events outline the realm of possible sensory responses in neocortical populations</article-title><source>Neuron</source><volume>62</volume><fpage>413</fpage><lpage>425</lpage><pub-id pub-id-type="doi">10.1016/j.neuron.2009.03.014</pub-id><pub-id pub-id-type="pmid">19447096</pub-id></element-citation></ref><ref id="bib44"><element-citation publication-type="book"><person-group person-group-type="author"><name><surname>Luczak</surname> <given-names>A</given-names></name></person-group><year iso-8601-date="2015">2015</year><chapter-title>Packets of sequential seural activity in sensory cortex</chapter-title><person-group person-group-type="editor"><name><surname>Tatsuno</surname> <given-names>M</given-names></name></person-group><source>Analysis and Modeling of Coordinated Multi-Neuronal Activity</source><publisher-loc>New York</publisher-loc><publisher-name>Springer</publisher-name><fpage>163</fpage><lpage>182</lpage></element-citation></ref><ref id="bib45"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Maboudi</surname> <given-names>K</given-names></name><name><surname>Ackermann</surname> <given-names>E</given-names></name><name><surname>de Jong</surname> <given-names>LW</given-names></name><name><surname>Pfeiffer</surname> <given-names>BE</given-names></name><name><surname>Foster</surname> <given-names>D</given-names></name><name><surname>Diba</surname> <given-names>K</given-names></name><name><surname>Kemere</surname> <given-names>C</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>Uncovering temporal structure in hippocampal output patterns</article-title><source>eLife</source><volume>7</volume><elocation-id>e34467</elocation-id><pub-id pub-id-type="doi">10.7554/eLife.34467</pub-id><pub-id pub-id-type="pmid">29869611</pub-id></element-citation></ref><ref id="bib46"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Maingret</surname> <given-names>N</given-names></name><name><surname>Girardeau</surname> <given-names>G</given-names></name><name><surname>Todorova</surname> <given-names>R</given-names></name><name><surname>Goutierre</surname> <given-names>M</given-names></name><name><surname>Zugaro</surname> <given-names>M</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Hippocampo-cortical coupling mediates memory consolidation during sleep</article-title><source>Nature Neuroscience</source><volume>19</volume><fpage>959</fpage><lpage>964</lpage><pub-id pub-id-type="doi">10.1038/nn.4304</pub-id><pub-id pub-id-type="pmid">27182818</pub-id></element-citation></ref><ref id="bib47"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Nguyen</surname> <given-names>TKT</given-names></name><name><surname>Navratilova</surname> <given-names>Z</given-names></name><name><surname>Cabral</surname> <given-names>H</given-names></name><name><surname>Wang</surname> <given-names>L</given-names></name><name><surname>Gielen</surname> <given-names>G</given-names></name><name><surname>Battaglia</surname> <given-names>FP</given-names></name><name><surname>Bartic</surname> <given-names>C</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Closed-loop optical neural stimulation based on a 32-channel low-noise recording system with online spike sorting</article-title><source>Journal of Neural Engineering</source><volume>11</volume><elocation-id>046005</elocation-id><pub-id pub-id-type="doi">10.1088/1741-2560/11/4/046005</pub-id></element-citation></ref><ref id="bib48"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Nokia</surname> <given-names>MS</given-names></name><name><surname>Penttonen</surname> <given-names>M</given-names></name><name><surname>Wikgren</surname> <given-names>J</given-names></name></person-group><year iso-8601-date="2010">2010</year><article-title>Hippocampal ripple-contingent training accelerates trace eyeblink conditioning and retards extinction in rabbits</article-title><source>Journal of Neuroscience</source><volume>30</volume><fpage>11486</fpage><lpage>11492</lpage><pub-id pub-id-type="doi">10.1523/JNEUROSCI.2165-10.2010</pub-id><pub-id pub-id-type="pmid">20739570</pub-id></element-citation></ref><ref id="bib49"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Nokia</surname> <given-names>MS</given-names></name><name><surname>Mikkonen</surname> <given-names>JE</given-names></name><name><surname>Penttonen</surname> <given-names>M</given-names></name><name><surname>Wikgren</surname> <given-names>J</given-names></name></person-group><year iso-8601-date="2012">2012</year><article-title>Disrupting neural activity related to awake-state sharp wave-ripple complexes prevents hippocampal learning</article-title><source>Frontiers in Behavioral Neuroscience</source><volume>6</volume><elocation-id>84</elocation-id><pub-id pub-id-type="doi">10.3389/fnbeh.2012.00084</pub-id><pub-id pub-id-type="pmid">23316148</pub-id></element-citation></ref><ref id="bib50"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Novitskaya</surname> <given-names>Y</given-names></name><name><surname>Sara</surname> <given-names>SJ</given-names></name><name><surname>Logothetis</surname> <given-names>NK</given-names></name><name><surname>Eschenko</surname> <given-names>O</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Ripple-triggered stimulation of the locus coeruleus during post-learning sleep disrupts ripple/spindle coupling and impairs memory consolidation</article-title><source>Learning &amp; Memory</source><volume>23</volume><fpage>238</fpage><lpage>248</lpage><pub-id pub-id-type="doi">10.1101/lm.040923.115</pub-id><pub-id pub-id-type="pmid">27084931</pub-id></element-citation></ref><ref id="bib51"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ólafsdóttir</surname> <given-names>HF</given-names></name><name><surname>Carpenter</surname> <given-names>F</given-names></name><name><surname>Barry</surname> <given-names>C</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Coordinated grid and place cell replay during rest</article-title><source>Nature Neuroscience</source><volume>19</volume><fpage>792</fpage><lpage>794</lpage><pub-id pub-id-type="doi">10.1038/nn.4291</pub-id><pub-id pub-id-type="pmid">27089021</pub-id></element-citation></ref><ref id="bib52"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ólafsdóttir</surname> <given-names>HF</given-names></name><name><surname>Carpenter</surname> <given-names>F</given-names></name><name><surname>Barry</surname> <given-names>C</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Task demands predict a dynamic switch in the content of awake hippocampal replay</article-title><source>Neuron</source><volume>96</volume><fpage>925</fpage><lpage>935</lpage><pub-id pub-id-type="doi">10.1016/j.neuron.2017.09.035</pub-id><pub-id pub-id-type="pmid">29056296</pub-id></element-citation></ref><ref id="bib53"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ólafsdóttir</surname> <given-names>HF</given-names></name><name><surname>Bush</surname> <given-names>D</given-names></name><name><surname>Barry</surname> <given-names>C</given-names></name></person-group><year iso-8601-date="2018">2018</year><article-title>The role of hippocampal replay in memory and Planning</article-title><source>Current Biology</source><volume>28</volume><fpage>R37</fpage><lpage>R50</lpage><pub-id pub-id-type="doi">10.1016/j.cub.2017.10.073</pub-id><pub-id pub-id-type="pmid">29316421</pub-id></element-citation></ref><ref id="bib54"><element-citation publication-type="book"><person-group person-group-type="author"><name><surname>O’Keefe</surname> <given-names>J</given-names></name><name><surname>Nadel</surname> <given-names>L</given-names></name></person-group><year iso-8601-date="1978">1978</year><source>The Hippocampus as a Cognitive Map</source><publisher-loc>Oxford</publisher-loc><publisher-name>Clarendon Press</publisher-name></element-citation></ref><ref id="bib55"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>O’Neill</surname> <given-names>J</given-names></name><name><surname>Boccara</surname> <given-names>CN</given-names></name><name><surname>Stella</surname> <given-names>F</given-names></name><name><surname>Schoenenberger</surname> <given-names>P</given-names></name><name><surname>Csicsvari</surname> <given-names>J</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Superficial layers of the medial entorhinal cortex replay independently of the Hippocampus</article-title><source>Science</source><volume>355</volume><fpage>184</fpage><lpage>188</lpage><pub-id pub-id-type="doi">10.1126/science.aag2787</pub-id><pub-id pub-id-type="pmid">28082591</pub-id></element-citation></ref><ref id="bib56"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Pasquale</surname> <given-names>V</given-names></name><name><surname>Martinoia</surname> <given-names>S</given-names></name><name><surname>Chiappalone</surname> <given-names>M</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Stimulation triggers endogenous activity patterns in cultured cortical networks</article-title><source>Scientific Reports</source><volume>7</volume><elocation-id>9080</elocation-id><pub-id pub-id-type="doi">10.1038/s41598-017-08369-0</pub-id><pub-id pub-id-type="pmid">28831071</pub-id></element-citation></ref><ref id="bib57"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Pastalkova</surname> <given-names>E</given-names></name><name><surname>Itskov</surname> <given-names>V</given-names></name><name><surname>Amarasingham</surname> <given-names>A</given-names></name><name><surname>Buzsáki</surname> <given-names>G</given-names></name></person-group><year iso-8601-date="2008">2008</year><article-title>Internally generated cell assembly sequences in the rat Hippocampus</article-title><source>Science</source><volume>321</volume><fpage>1322</fpage><lpage>1327</lpage><pub-id pub-id-type="doi">10.1126/science.1159775</pub-id><pub-id pub-id-type="pmid">18772431</pub-id></element-citation></ref><ref id="bib58"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Patel</surname> <given-names>YA</given-names></name><name><surname>George</surname> <given-names>A</given-names></name><name><surname>Dorval</surname> <given-names>AD</given-names></name><name><surname>White</surname> <given-names>JA</given-names></name><name><surname>Christini</surname> <given-names>DJ</given-names></name><name><surname>Butera</surname> <given-names>RJ</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Hard real-time closed-loop electrophysiology with the Real-Time eXperiment interface (RTXI)</article-title><source>PLOS Computational Biology</source><volume>13</volume><elocation-id>e1005430</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pcbi.1005430</pub-id><pub-id pub-id-type="pmid">28557998</pub-id></element-citation></ref><ref id="bib59"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Pennartz</surname> <given-names>CM</given-names></name><name><surname>Lee</surname> <given-names>E</given-names></name><name><surname>Verheul</surname> <given-names>J</given-names></name><name><surname>Lipa</surname> <given-names>P</given-names></name><name><surname>Barnes</surname> <given-names>CA</given-names></name><name><surname>McNaughton</surname> <given-names>BL</given-names></name></person-group><year iso-8601-date="2004">2004</year><article-title>The ventral striatum in off-line processing: ensemble reactivation during sleep and modulation by hippocampal ripples</article-title><source>Journal of Neuroscience</source><volume>24</volume><fpage>6446</fpage><lpage>6456</lpage><pub-id pub-id-type="doi">10.1523/JNEUROSCI.0575-04.2004</pub-id><pub-id pub-id-type="pmid">15269254</pub-id></element-citation></ref><ref id="bib60"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Penny</surname> <given-names>WD</given-names></name><name><surname>Zeidman</surname> <given-names>P</given-names></name><name><surname>Burgess</surname> <given-names>N</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>Forward and backward inference in spatial cognition</article-title><source>PLOS Computational Biology</source><volume>9</volume><elocation-id>e1003383</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pcbi.1003383</pub-id><pub-id pub-id-type="pmid">24348230</pub-id></element-citation></ref><ref id="bib61"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Peyrache</surname> <given-names>A</given-names></name><name><surname>Khamassi</surname> <given-names>M</given-names></name><name><surname>Benchenane</surname> <given-names>K</given-names></name><name><surname>Wiener</surname> <given-names>SI</given-names></name><name><surname>Battaglia</surname> <given-names>FP</given-names></name></person-group><year iso-8601-date="2009">2009</year><article-title>Replay of rule-learning related neural patterns in the prefrontal cortex during sleep</article-title><source>Nature Neuroscience</source><volume>12</volume><fpage>919</fpage><lpage>926</lpage><pub-id pub-id-type="doi">10.1038/nn.2337</pub-id><pub-id pub-id-type="pmid">19483687</pub-id></element-citation></ref><ref id="bib62"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Pezzulo</surname> <given-names>G</given-names></name><name><surname>van der Meer</surname> <given-names>MA</given-names></name><name><surname>Lansink</surname> <given-names>CS</given-names></name><name><surname>Pennartz</surname> <given-names>CM</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Internally generated sequences in learning and executing goal-directed behavior</article-title><source>Trends in Cognitive Sciences</source><volume>18</volume><fpage>647</fpage><lpage>657</lpage><pub-id pub-id-type="doi">10.1016/j.tics.2014.06.011</pub-id><pub-id pub-id-type="pmid">25156191</pub-id></element-citation></ref><ref id="bib63"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Pezzulo</surname> <given-names>G</given-names></name><name><surname>Kemere</surname> <given-names>C</given-names></name><name><surname>van der Meer</surname> <given-names>MAA</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Internally generated hippocampal sequences as a vantage point to probe future-oriented cognition</article-title><source>Annals of the New York Academy of Sciences</source><volume>1396</volume><fpage>144</fpage><lpage>165</lpage><pub-id pub-id-type="doi">10.1111/nyas.13329</pub-id><pub-id pub-id-type="pmid">28548460</pub-id></element-citation></ref><ref id="bib64"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Pfeiffer</surname> <given-names>BE</given-names></name><name><surname>Foster</surname> <given-names>DJ</given-names></name></person-group><year iso-8601-date="2013">2013</year><article-title>Hippocampal place-cell sequences depict future paths to remembered goals</article-title><source>Nature</source><volume>497</volume><fpage>74</fpage><lpage>79</lpage><pub-id pub-id-type="doi">10.1038/nature12112</pub-id><pub-id pub-id-type="pmid">23594744</pub-id></element-citation></ref><ref id="bib65"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Potter</surname> <given-names>SM</given-names></name><name><surname>El Hady</surname> <given-names>A</given-names></name><name><surname>Fetz</surname> <given-names>EE</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Closed-loop neuroscience and neuroengineering</article-title><source>Frontiers in Neural Circuits</source><volume>8</volume><elocation-id>115</elocation-id><pub-id pub-id-type="doi">10.3389/fncir.2014.00115</pub-id><pub-id pub-id-type="pmid">25294988</pub-id></element-citation></ref><ref id="bib66"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Powers</surname> <given-names>D</given-names></name></person-group><year iso-8601-date="2011">2011</year><article-title>Evaluation: from precision, recall and F-Measure to Roc, informedness, markedness &amp; correlation</article-title><source>Journal of Machine Learning Technologies</source><volume>2</volume><fpage>37</fpage><lpage>63</lpage></element-citation></ref><ref id="bib67"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Qin</surname> <given-names>YL</given-names></name><name><surname>McNaughton</surname> <given-names>BL</given-names></name><name><surname>Skaggs</surname> <given-names>WE</given-names></name><name><surname>Barnes</surname> <given-names>CA</given-names></name></person-group><year iso-8601-date="1997">1997</year><article-title>Memory reprocessing in corticocortical and hippocampocortical neuronal ensembles. philosophical transactions of the royal society of London</article-title><source>Series B, Biological Sciences</source><volume>352</volume><fpage>1525</fpage><lpage>1533</lpage><pub-id pub-id-type="doi">10.1098/rstb.1997.0139</pub-id></element-citation></ref><ref id="bib68"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Ribeiro</surname> <given-names>S</given-names></name><name><surname>Gervasoni</surname> <given-names>D</given-names></name><name><surname>Soares</surname> <given-names>ES</given-names></name><name><surname>Zhou</surname> <given-names>Y</given-names></name><name><surname>Lin</surname> <given-names>SC</given-names></name><name><surname>Pantoja</surname> <given-names>J</given-names></name><name><surname>Lavine</surname> <given-names>M</given-names></name><name><surname>Nicolelis</surname> <given-names>MA</given-names></name></person-group><year iso-8601-date="2004">2004</year><article-title>Long-lasting novelty-induced neuronal reverberation during slow-wave sleep in multiple forebrain Areas</article-title><source>PLOS Biology</source><volume>2</volume><elocation-id>e24</elocation-id><pub-id pub-id-type="doi">10.1371/journal.pbio.0020024</pub-id><pub-id pub-id-type="pmid">14737198</pub-id></element-citation></ref><ref id="bib69"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Riehle</surname> <given-names>A</given-names></name><name><surname>Grün</surname> <given-names>S</given-names></name><name><surname>Diesmann</surname> <given-names>M</given-names></name><name><surname>Aertsen</surname> <given-names>A</given-names></name></person-group><year iso-8601-date="1997">1997</year><article-title>Spike synchronization and rate modulation differentially involved in motor cortical function</article-title><source>Science</source><volume>278</volume><fpage>1950</fpage><lpage>1953</lpage><pub-id pub-id-type="doi">10.1126/science.278.5345.1950</pub-id><pub-id pub-id-type="pmid">9395398</pub-id></element-citation></ref><ref id="bib70"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Rothschild</surname> <given-names>G</given-names></name><name><surname>Eban</surname> <given-names>E</given-names></name><name><surname>Frank</surname> <given-names>LM</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>A cortical-hippocampal-cortical loop of information processing during memory consolidation</article-title><source>Nature Neuroscience</source><volume>20</volume><fpage>251</fpage><lpage>259</lpage><pub-id pub-id-type="doi">10.1038/nn.4457</pub-id><pub-id pub-id-type="pmid">27941790</pub-id></element-citation></ref><ref id="bib71"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Roumis</surname> <given-names>DK</given-names></name><name><surname>Frank</surname> <given-names>LM</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Hippocampal sharp-wave ripples in waking and sleeping states</article-title><source>Current Opinion in Neurobiology</source><volume>35</volume><fpage>6</fpage><lpage>12</lpage><pub-id pub-id-type="doi">10.1016/j.conb.2015.05.001</pub-id></element-citation></ref><ref id="bib72"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Roux</surname> <given-names>L</given-names></name><name><surname>Hu</surname> <given-names>B</given-names></name><name><surname>Eichler</surname> <given-names>R</given-names></name><name><surname>Stark</surname> <given-names>E</given-names></name><name><surname>Buzsáki</surname> <given-names>G</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Sharp wave ripples during learning stabilize the hippocampal spatial map</article-title><source>Nature Neuroscience</source><volume>20</volume><fpage>845</fpage><lpage>853</lpage><pub-id pub-id-type="doi">10.1038/nn.4543</pub-id><pub-id pub-id-type="pmid">28394323</pub-id></element-citation></ref><ref id="bib73"><element-citation publication-type="confproc"><person-group person-group-type="author"><name><surname>Sethi</surname> <given-names>A</given-names></name><name><surname>Kemere</surname> <given-names>CT</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Mulitchannel real time spike sorting for decoding ripple sequences</article-title><conf-name>7th Annual International IEEE/EMBS Conference on Neural Engineering </conf-name><conf-loc>Montpellier, France</conf-loc><fpage>956</fpage><lpage>959</lpage><pub-id pub-id-type="doi">10.1109/NER.2015.7146784</pub-id></element-citation></ref><ref id="bib74"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Singer</surname> <given-names>AC</given-names></name><name><surname>Frank</surname> <given-names>LM</given-names></name></person-group><year iso-8601-date="2009">2009</year><article-title>Rewarded outcomes enhance reactivation of experience in the Hippocampus</article-title><source>Neuron</source><volume>64</volume><fpage>910</fpage><lpage>921</lpage><pub-id pub-id-type="doi">10.1016/j.neuron.2009.11.016</pub-id><pub-id pub-id-type="pmid">20064396</pub-id></element-citation></ref><ref id="bib75"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Sodkomkham</surname> <given-names>D</given-names></name><name><surname>Ciliberti</surname> <given-names>D</given-names></name><name><surname>Wilson</surname> <given-names>MA</given-names></name><name><surname>Fukui</surname> <given-names>K-ichi</given-names></name><name><surname>Moriyama</surname> <given-names>K</given-names></name><name><surname>Numao</surname> <given-names>M</given-names></name><name><surname>Kloosterman</surname> <given-names>F</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Kernel density compression for real-time bayesian encoding/decoding of unsorted hippocampal spikes</article-title><source>Knowledge-Based Systems</source><volume>94</volume><fpage>1</fpage><lpage>12</lpage><pub-id pub-id-type="doi">10.1016/j.knosys.2015.09.013</pub-id></element-citation></ref><ref id="bib76"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Takahashi</surname> <given-names>S</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Episodic-like memory trace in awake replay of hippocampal place cell activity sequences</article-title><source>eLife</source><volume>4</volume><elocation-id>e08105</elocation-id><pub-id pub-id-type="doi">10.7554/eLife.08105</pub-id></element-citation></ref><ref id="bib77"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Talakoub</surname> <given-names>O</given-names></name><name><surname>Gomez Palacio Schjetnan</surname> <given-names>A</given-names></name><name><surname>Valiante</surname> <given-names>TA</given-names></name><name><surname>Popovic</surname> <given-names>MR</given-names></name><name><surname>Hoffman</surname> <given-names>KL</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Closed-Loop interruption of hippocampal ripples through fornix stimulation in the Non-Human primate</article-title><source>Brain Stimulation</source><volume>9</volume><fpage>911</fpage><lpage>918</lpage><pub-id pub-id-type="doi">10.1016/j.brs.2016.07.010</pub-id><pub-id pub-id-type="pmid">27576185</pub-id></element-citation></ref><ref id="bib78"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Tang</surname> <given-names>W</given-names></name><name><surname>Shin</surname> <given-names>JD</given-names></name><name><surname>Frank</surname> <given-names>LM</given-names></name><name><surname>Jadhav</surname> <given-names>SP</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Hippocampal-Prefrontal reactivation during learning is stronger in awake compared with sleep states</article-title><source>The Journal of Neuroscience</source><volume>37</volume><fpage>11789</fpage><lpage>11805</lpage><pub-id pub-id-type="doi">10.1523/JNEUROSCI.2291-17.2017</pub-id><pub-id pub-id-type="pmid">29089440</pub-id></element-citation></ref><ref id="bib79"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Valdés</surname> <given-names>JL</given-names></name><name><surname>McNaughton</surname> <given-names>BL</given-names></name><name><surname>Fellous</surname> <given-names>JM</given-names></name></person-group><year iso-8601-date="2015">2015</year><article-title>Offline reactivation of experience-dependent neuronal firing patterns in the rat ventral tegmental area</article-title><source>Journal of Neurophysiology</source><volume>114</volume><fpage>1183</fpage><lpage>1195</lpage><pub-id pub-id-type="doi">10.1152/jn.00758.2014</pub-id><pub-id pub-id-type="pmid">26108957</pub-id></element-citation></ref><ref id="bib80"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>van de Ven</surname> <given-names>GM</given-names></name><name><surname>Trouche</surname> <given-names>S</given-names></name><name><surname>McNamara</surname> <given-names>CG</given-names></name><name><surname>Allen</surname> <given-names>K</given-names></name><name><surname>Dupret</surname> <given-names>D</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Hippocampal offline reactivation consolidates recently formed cell assembly patterns during sharp Wave-Ripples</article-title><source>Neuron</source><volume>92</volume><fpage>968</fpage><lpage>974</lpage><pub-id pub-id-type="doi">10.1016/j.neuron.2016.10.020</pub-id><pub-id pub-id-type="pmid">27840002</pub-id></element-citation></ref><ref id="bib81"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>van der Meer</surname> <given-names>MAA</given-names></name><name><surname>Carey</surname> <given-names>AA</given-names></name><name><surname>Tanaka</surname> <given-names>Y</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Optimizing for generalization in the decoding of internally generated activity in the Hippocampus</article-title><source>Hippocampus</source><volume>27</volume><fpage>580</fpage><lpage>595</lpage><pub-id pub-id-type="doi">10.1002/hipo.22714</pub-id><pub-id pub-id-type="pmid">28177571</pub-id></element-citation></ref><ref id="bib82"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Velliste</surname> <given-names>M</given-names></name><name><surname>Perel</surname> <given-names>S</given-names></name><name><surname>Spalding</surname> <given-names>MC</given-names></name><name><surname>Whitford</surname> <given-names>AS</given-names></name><name><surname>Schwartz</surname> <given-names>AB</given-names></name></person-group><year iso-8601-date="2008">2008</year><article-title>Cortical control of a prosthetic arm for self-feeding</article-title><source>Nature</source><volume>453</volume><fpage>1098</fpage><lpage>1101</lpage><pub-id pub-id-type="doi">10.1038/nature06996</pub-id><pub-id pub-id-type="pmid">18509337</pub-id></element-citation></ref><ref id="bib83"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wilson</surname> <given-names>JA</given-names></name><name><surname>Mellinger</surname> <given-names>J</given-names></name><name><surname>Schalk</surname> <given-names>G</given-names></name><name><surname>Williams</surname> <given-names>J</given-names></name></person-group><year iso-8601-date="2010">2010</year><article-title>A procedure for measuring latencies in brain-computer interfaces</article-title><source>IEEE Transactions on Biomedical Engineering</source><volume>57</volume><fpage>1785</fpage><lpage>1797</lpage><pub-id pub-id-type="doi">10.1109/TBME.2010.2047259</pub-id><pub-id pub-id-type="pmid">20403781</pub-id></element-citation></ref><ref id="bib84"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wilson</surname> <given-names>MA</given-names></name><name><surname>McNaughton</surname> <given-names>BL</given-names></name></person-group><year iso-8601-date="1994">1994</year><article-title>Reactivation of hippocampal ensemble memories during sleep</article-title><source>Science</source><volume>265</volume><fpage>676</fpage><lpage>679</lpage><pub-id pub-id-type="doi">10.1126/science.8036517</pub-id><pub-id pub-id-type="pmid">8036517</pub-id></element-citation></ref><ref id="bib85"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wu</surname> <given-names>CT</given-names></name><name><surname>Haggerty</surname> <given-names>D</given-names></name><name><surname>Kemere</surname> <given-names>C</given-names></name><name><surname>Ji</surname> <given-names>D</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Hippocampal awake replay in fear memory retrieval</article-title><source>Nature Neuroscience</source><volume>20</volume><fpage>571</fpage><lpage>580</lpage><pub-id pub-id-type="doi">10.1038/nn.4507</pub-id><pub-id pub-id-type="pmid">28218916</pub-id></element-citation></ref><ref id="bib86"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Wu</surname> <given-names>X</given-names></name><name><surname>Foster</surname> <given-names>DJ</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Hippocampal replay captures the unique topological structure of a novel environment</article-title><source>Journal of Neuroscience</source><volume>34</volume><fpage>6459</fpage><lpage>6469</lpage><pub-id pub-id-type="doi">10.1523/JNEUROSCI.3414-13.2014</pub-id><pub-id pub-id-type="pmid">24806672</pub-id></element-citation></ref><ref id="bib87"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Xu</surname> <given-names>R</given-names></name><name><surname>Jiang</surname> <given-names>N</given-names></name><name><surname>Lin</surname> <given-names>C</given-names></name><name><surname>Mrachacz-Kersting</surname> <given-names>N</given-names></name><name><surname>Dremstrup</surname> <given-names>K</given-names></name><name><surname>Farina</surname> <given-names>D</given-names></name></person-group><year iso-8601-date="2014">2014</year><article-title>Enhanced low-latency detection of motor intention from eeg for closed-loop brain-computer interface applications</article-title><source>IEEE Transactions on Bio-Medical Engineering</source><volume>61</volume><fpage>288</fpage><lpage>296</lpage><pub-id pub-id-type="doi">10.1109/TBME.2013.2294203</pub-id><pub-id pub-id-type="pmid">24448593</pub-id></element-citation></ref><ref id="bib88"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Yu</surname> <given-names>JY</given-names></name><name><surname>Kay</surname> <given-names>K</given-names></name><name><surname>Liu</surname> <given-names>DF</given-names></name><name><surname>Grossrubatscher</surname> <given-names>I</given-names></name><name><surname>Loback</surname> <given-names>A</given-names></name><name><surname>Sosa</surname> <given-names>M</given-names></name><name><surname>Chung</surname> <given-names>JE</given-names></name><name><surname>Karlsson</surname> <given-names>MP</given-names></name><name><surname>Larkin</surname> <given-names>MC</given-names></name><name><surname>Frank</surname> <given-names>LM</given-names></name></person-group><year iso-8601-date="2017">2017</year><article-title>Distinct hippocampal-cortical memory representations for experiences associated with movement versus immobility</article-title><source>eLife</source><volume>6</volume><elocation-id>e27621</elocation-id><pub-id pub-id-type="doi">10.7554/eLife.27621</pub-id><pub-id pub-id-type="pmid">28826483</pub-id></element-citation></ref><ref id="bib89"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zheng</surname> <given-names>C</given-names></name><name><surname>Bieri</surname> <given-names>KW</given-names></name><name><surname>Hsiao</surname> <given-names>YT</given-names></name><name><surname>Colgin</surname> <given-names>LL</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Spatial sequence coding differs during slow and fast gamma rhythms in the Hippocampus</article-title><source>Neuron</source><volume>89</volume><fpage>398</fpage><lpage>408</lpage><pub-id pub-id-type="doi">10.1016/j.neuron.2015.12.005</pub-id><pub-id pub-id-type="pmid">26774162</pub-id></element-citation></ref><ref id="bib90"><element-citation publication-type="journal"><person-group person-group-type="author"><name><surname>Zrenner</surname> <given-names>C</given-names></name><name><surname>Belardinelli</surname> <given-names>P</given-names></name><name><surname>Müller-Dahlhaus</surname> <given-names>F</given-names></name><name><surname>Ziemann</surname> <given-names>U</given-names></name></person-group><year iso-8601-date="2016">2016</year><article-title>Closed-Loop neuroscience and Non-Invasive brain stimulation: a tale of two loops</article-title><source>Frontiers in Cellular Neuroscience</source><volume>10</volume><elocation-id>92</elocation-id><pub-id pub-id-type="doi">10.3389/fncel.2016.00092</pub-id><pub-id pub-id-type="pmid">27092055</pub-id></element-citation></ref></ref-list></back><sub-article article-type="decision-letter" id="SA1"><front-stub><article-id pub-id-type="doi">10.7554/eLife.36275.028</article-id><title-group><article-title>Decision letter</article-title></title-group><contrib-group><contrib contrib-type="editor"><name><surname>Colgin</surname><given-names>Laura</given-names></name><role>Reviewing Editor</role><aff><institution>The University of Texas at Austin, Center for Learning and Memory</institution><country>United States</country></aff></contrib></contrib-group></front-stub><body><boxed-text><p>In the interests of transparency, eLife includes the editorial decision letter and accompanying author responses. A lightly edited version of the letter sent to the authors after peer review is shown, indicating the most substantive concerns; minor comments are not usually included.</p></boxed-text><p>Thank you for sending your article entitled &quot;Real-time classification of experience-related ensemble spiking patterns for closed-loop applications&quot; for peer review at <italic>eLife</italic>. Your article is being reviewed by Sabine Kastner as the Senior Editor, a Reviewing Editor, and three reviewers.</p><p>Given the list of essential revisions, the editors and reviewers invite you to respond with an action plan for the completion of the additional work. We plan to share your responses with the reviewers and then issue a binding recommendation.</p><p>All reviewers were generally positive about your manuscript and saw the potential for the real-time decoding methods to permit experiments that are not currently possible. However, the reviewers engaged in a thoughtful discussion and agreed that there are five key issues that should be addressed to ensure that the study makes a substantial impact on the field. These five specific issues are listed below (and followed by the reviews in their entirety, which include other minor comments that should also be addressed prior to resubmission):</p><p>1) The authors should better define their parameter space in which their algorithm is effective (e.g., what are the minimum number of tetrodes and spikes per time bin required for effective online replay detection?). To assess this, the authors could subsample their data (or perhaps use others' datasets that are available online) and focus on how these parameters affect detection of false positives and false negatives.</p><p>2) The authors should make their dataset available for comparison with other datasets or future datasets. The authors should also make their code for online and offline detection available for comparison with others.</p><p>3) The authors should be sure to more clearly explain how the present paper provides valuable insights that were not provided in their previous report (e.g., parameters necessary for effective online detection of replay).</p><p>4) The authors should provide a better explanation of the differences between the new real-time algorithm and standard offline methods.</p><p>5) The authors should clarify how examples were selected. Are the presented examples representative or are they the best examples? Perhaps a supplemental figure could be added in which the authors show multiple detected replay events selected in an unbiased/less biased way (e.g., all detected replay events from one example episode of awake rest, or all detected replay episodes from all rest epochs from an example behavioral session).</p><p><italic>Reviewer #1:</italic> </p><p>In the current manuscript, Ciliberti et al., describe a novel closed-loop method for online detection of the spatial content encoded by ripple events to allow for near-real-time feedback during specific replay events. This method addresses an important technical problem for in vivo hippocampal research, namely that current work on hippocampal sequences is necessarily correlative. To demonstrate causal relationships between ripple-based reactivation (or other sequences, such as theta sequences) and behavior/memory, one must manipulate neural activity only during expression of specific sequences. As the authors note, one prior replay detection algorithm has been published, although the method described in the current manuscript is distinct from that described by Deng et al.</p><p>I have very few concerns regarding the methodology described in the manuscript. I think the authors have done an excellent job of quantifying the accuracy of their algorithm with the dataset they collected, and the authors have convinced me that their method is generally effective at identifying specific replay trajectories in one rat. However, I do have concerns regarding the general applicability of this method beyond the single example recording described in this paper.</p><p>If the authors were using this methodology to address a specific scientific question, then it would be acceptable to demonstrate how well it works on their dataset and stop there. However, if the authors are attempting to provide this methodology as a general tool to the scientific community, it becomes much more important to establish the parameter space in which it works and in which it fails. The authors do explore some parameter tuning, but this is largely limited to adjusting <italic>θ<sub>sharp</sub></italic> and <italic>θ<sub>mua</sub></italic>. It seems to me that many additional parameters necessarily impact both the quality and the speed of this algorithm. While it is impractical for the authors to examine all possible parameters that may ever be encountered, there are two critical parameters that I feel should be examined by the authors to make this method generally useful to the broader scientific community.</p><p>The first of these parameters is the total number of spikes that are entering the algorithm per time bin. From my understanding of the Bayesian decoding algorithm, more spikes generally produces a higher maximum posterior probability, which would be expected to result in more <italic>θ<sub>sharp</sub></italic> crossings. I also presume that more spikes might generally produce a more accurate representation of the current information representation in the hippocampus and thus increase the likelihood of true replay detection. Further, a higher average spike rate would likely serve to lower bin-to-bin spike density fluctuations, thereby reducing spurious <italic>θ<sub>mua</sub></italic> crossings. Finally, based on Figure 1C, it seems that more spikes slows the decoding algorithm. Thus, I wonder if there is an optimum number of spikes/ms for this method. In other words, would too many recording electrodes actually become detrimental to implementation of this method (by slowing the decoding too much or making the posterior probabilities too high)? Alternatively, are there a critical number of electrodes or spikes/ms that are required for this method to be effective (to avoid too many spurious <italic>θ<sub>mua</sub></italic> crossings or to ensure faithful decoding)? These questions could be addressed by subsampling the authors' datasets in order to test whether there is a minimum required spike rate. In addition, there are several publicly available datasets that may contain more spikes/ms or the authors could artificially add spikes to their existing dataset to test the effect of increasing total sampling on the algorithm's performance.</p><p>The second parameter is the effective 'coverage' of the environment by the spiking activity. While the authors report that there was sufficient coverage in order to faithfully decode the animal's location during exploration (these data should be shown), it was not reported whether the decoding was more/less accurate on specific arms or whether that accuracy impacted the performance of the algorithm in detecting replays of that arm. This would be important information for researchers to have in order to allow them to know when this method can be properly utilized and when it can't. Specifically, is there a critical decoding accuracy (during active behavior using a 200-300 ms decoding window) that must be met before the replay detection algorithm is effective? This could be examined by the authors by selectively subsampling the spikes detected on specific arms to reduce the effectiveness of the encoding model in order to correlate decoding accuracy with replay detection. This additionally addresses how long RUN1 needs to be for the algorithm to work (i.e., are five laps sufficient to build the encoding model or does it require 20 laps?).</p><p>These two parameters could also be tested, perhaps more convincingly, by obtaining data from additional rats, although I do not believe that this is strictly necessary.</p><p><italic>Reviewer #2:</italic> </p><p>This Tools and Resources article is the first to demonstrate classification of hippocampal replay using real-time ensemble decoding. This is an achievement that anyone with an interest in replay has likely dreamed of for many years, and to see it finally done is cause for celebration. The ability to detect specific replay content with sufficiently short latency to apply closed-loop (Kloost-loop?) interventions such as medial forebrain stimulation, or optogenetic inhibition of a downstream target, is a major step forward that heralds a potentially transformative wave of experiments.</p><p>Of course, this report stops short of actually implementing a closed-loop manipulation, but I do not think that diminishes the magnitude and importance of what the authors have accomplished. The key result is that the required computations, notably clusterless ensemble decoding and subsequent classification, can be performed with impressively short latency (&lt;2 ms, Figure 1D) in a fully working system that is streaming data from a single &quot;proof-of-principle&quot; subject.</p><p>In combining ensemble decoding and application to replay, this demonstration is a clear advance compared to previous work, although the authors could be more comprehensive in referencing not only the de Lavilleon et al., (2015) paper in the introduction, but also the work by Guger et al., (2011) and that of Bartic, Battaglia and colleagues (Nguyen et al., 2014; Bartic et al., 2016). Similarly, there is an extensive literature on brain-machine interfaces for control of prosthetic limbs and computer cursors, including real-time decoding systems by Nicolelis, Donohue, Schwartz, Andersen and others. The manuscript would benefit from a paragraph clarifying the similarities and differences with that body of work.</p><p>The hardware and software components of the system are clearly described and visualized (Figure 1—figure supplement 1 is particularly helpful). The extensive set of offline data analyses are well justified and appropriate, and the authors provide a fair and balanced discussion highlighting areas where the system can be improved.</p><p>I have only one major comment, and several minor suggestions, which I expect the authors to be able to address in short order.</p><p>I strongly suggest that the authors make the data sets used publicly available. Doing so would greatly facilitate comparison of potential future improvements built by others to the original results and therefore enhance the impact of the work. Relatedly, it was unclear to me from the manuscript whether the described system is currently implemented in the current version of the open-source Falcon software, please clarify.</p><p><italic>Reviewer #3:</italic> </p><p>Hippocampal replay is one of the more interesting information-carrying phenomena identified in the brain. Despite more than a decade of study, however, we know less. The authors present a characterization of a real-time replay detection algorithm. Their tool would be broadly useful in experiments in which one wished to understand how the information represented in hippocampal activity during sharp wave ripples impacts learning and memory. The need for these experiments was further brought home to me as I tried to summarize my concerns about how true-positive and false-positive events were selected. Consequently, I am very excited about this work.</p><p>The main innovation I find in the paper is developing and characterizing a real-time replay detection algorithm. It builds on the authors' development of a real-time processing architecture (Ciliberti and Kloosterman, 2017). As much as I am sympathetic with the need to elevating the profile of innovation in neuroengineering, it is unclear to me whether this work is appropriate for <italic>eLife</italic>. In particular, there did not appear to be a scientific discovery. I believe that there are hints that there may be something interesting revealed about the hippocampus in the performance of the real-time algorithm, insofar as the presence of a complete replay event and its spatial content may be predictable from some fraction of the initial portion. Clearly if this was a focus of the paper that would meet the standard. Absent such a scientific result, the work might be more appropriate for a more engineering-focused journal.</p><p>An alternative scientific result would have been some behavioral effect of disruption of replay. The lack of such an effect, which the presence in the methods of a description of implantation of stimulation electrodes into the ventral hippocampal commissure suggests was the subject of experimental exploration, is striking. Specifically, the authors explore how the parameters of their real-time system affect the detection performance relative to an offline standard. The performance is quite good, but what if this reflects the fact that the offline standard is in appropriate? How the choice of offline-standard parameters affects the relative real-time detection is not explored.</p><p>[Editors' note: further revisions were requested prior to acceptance, as described below.]</p><p>Thank you for resubmitting your work entitled &quot;Real-time classification of experience-related ensemble spiking patterns for closed-loop applications&quot; for further consideration at <italic>eLife</italic>. Your revised article has been favorably evaluated by Eve Marder (Senior Editor), a Reviewing Editor, and three reviewers.</p><p>We are almost ready to accept your manuscript, but there are a few remaining issues that need to be addressed before acceptance, as outlined below:</p><p>Specifically, the reviewers would like the figures included in the rebuttal letter to be included as figure supplements or elsewhere. Please follow this suggestion or provide a rebuttal explaining why you prefer not to do so.</p><p>We expect the Editors to be able to make a final decision without requiring review.</p><p><italic>Reviewer #1:</italic> </p><p>The revised manuscript is much improved, and the authors have largely addressed my concerns.</p><p>I would have much preferred for Figure 6 to have examined the effect of spike or cell number rather than tetrode number, as one can put in 100 tetrodes and get no cells or put in 12 tetrodes and get 150 cells (Wilson and McNaughton, 1993). However, I think the figure included in the response (Figure A) addresses this concern and should be included as Figure 1—figure supplement 4.</p><p>I appreciate the analyses included in <xref ref-type="fig" rid="respfig2">Author response image 2</xref> in the response, and I think it is valuable information for someone planning to use this method, but I don't consider it strictly necessary (given the relatively modest improvement in accuracy beyond 1 lap). Considering that there are no limits (as far as I know) for supplemental data, and considering that the figure is already made, I see no reason not to include it.</p><p><italic>Reviewer #2:</italic> </p><p>In this revision, the authors have added major new analyses to what was already an impressive demonstration of the first real-time ensemble decoding system for hippocampal replay content. The new analyses are important in delineating the tradeoffs involved in configuring the system, and the conditions that need to be met for adequate performance.</p><p>Among these additions is the subsampling analysis which suggests a nonlinear performance improvement around 10 tetrodes, and continued improvement as more tetrodes are added. Also useful is the analysis describing how much sampling of the environment is required to build a usable encoding model (<xref ref-type="fig" rid="respfig2">Author response image 2</xref> in the rebuttal). If the authors prefer to not include this figure as a supplement, I think a statement in the text along with some descriptive statistics would be helpful in making the point that for this data set, a few trials appear to be sufficient.</p><p>My other comments, such as the suggestion to make the data freely available, have also been satisfactorily addressed.</p><p><italic>Reviewer #3):</italic> </p><p>The authors additions have satisfied my concerns.</p></body></sub-article><sub-article article-type="reply" id="SA2"><front-stub><article-id pub-id-type="doi">10.7554/eLife.36275.029</article-id><title-group><article-title>Author response</article-title></title-group></front-stub><body><p>[Editors' note: the authors’ plan for revisions was approved and the authors made a formal revised submission.]</p><disp-quote content-type="editor-comment"><p>All reviewers were generally positive about your manuscript and saw the potential for the real-time decoding methods to permit experiments that are not currently possible. However, the reviewers engaged in a thoughtful discussion and agreed that there are five key issues that should be addressed to ensure that the study makes a substantial impact on the field. These five specific issues are listed below (and followed by the reviews in their entirety, which include other minor comments that should also be addressed prior to resubmission):</p><p>1) The authors should better define their parameter space in which their algorithm is effective (e.g., what are the minimum number of tetrodes and spikes per time bin required for effective online replay detection?). To assess this, the authors could subsample their data (or perhaps use others' datasets that are available online) and focus on how these parameters affect detection of false positives and false negatives.</p></disp-quote><p>As the reviewers requested and as detailed below in the replies, we have added analyses in which we subsampled the number of tetrodes and assessed the effect on replay detection performance. We further performed stress-tests of our system to evaluate how many spikes/bin and how many tetrodes can still be processed in real-time without increasing detection latency. Finally, we analyzed how two additional parameters (time bin size and number of bins) influence the trade-off between replay detection latency and accuracy.</p><disp-quote content-type="editor-comment"><p>2) The authors should make their dataset available for comparison with other datasets or future datasets. The authors should also make their code for online and offline detection available for comparison with others.</p></disp-quote><p>We are preparing the three the datasets that we collected for the manuscript for uploading to the “Collaborative Research in Computational Neuroscience” website (http://crcns.org). The code for online decoding is integrated into our Falcon software platform and the latest version will be made available on https://bitbucket.org/kloostermannerflab/falcon-server. The code for offline replay detection (and other analysis) will also be made available in a repository on our bitbucket website (https://bitbucket.org/kloostermannerflab). We are currently in the process of checking and cleaning the repositories and will make them public within the next weeks.</p><disp-quote content-type="editor-comment"><p>3) The authors should be sure to more clearly explain how the present paper provides valuable insights that were not provided in their previous report (e.g., parameters necessary for effective online detection of replay).</p></disp-quote><p>In our previously published work, we described an efficient offline implementation of spike-sorting-less neural decoding (Sodkomkham et al., 2016) and a general software framework for complex online neural processing in closed-loop settings (Ciliberti and Kloosterman, 2017). However, we did not previously address the full real-time replay identification problem with a concrete implementation that could be applied to streaming data. In the current work, we demonstrate that replay events can be identified in-time with a relatively straightforward algorithm and we show how the value of a number of critical parameters influence online replay detection performance. We have more clearly highlighted the novel contributions of the current manuscript in the Introduction.</p><disp-quote content-type="editor-comment"><p>4) The authors should provide a better explanation of the differences between the new real-time algorithm and standard offline methods.</p></disp-quote><p>The main difference is that the online algorithm is designed with real-time streaming data in mind and the complexity is low on purpose such that parameter values are intuitive, which facilitates incorporation into experiments for which parameters need to be set ahead of time and cannot be optimized afterwards. Offline methods have an advantage in that all data is available and there is little computational constraint. We have added a more detailed explanation of the differences between the online and offline methods in the Discussion section.</p><disp-quote content-type="editor-comment"><p>5) The authors should clarify how examples were selected. Are the presented examples representative or are they the best examples? Perhaps a supplemental figure could be added in which the authors show multiple detected replay events selected in an unbiased/less biased way (e.g., all detected replay events from one example episode of awake rest, or all detected replay episodes from all rest epochs from an example behavioral session).</p></disp-quote><p>The examples were picked manually from the first 300 candidate replay events among all RUN2 and SLEEP sessions. The selected examples are not “the best” according to some metric, but certainly there is a bias because of the visual inspection. Selected examples were focused on showing relatively clear replay events with correct online detections. True negative events were selected randomly. We have added a description of how example selection was performed to the figure legend. Given the large number of events (see Table 1), it will be difficult to show all events in a dataset as suggested. However, as was suggested in a follow-up to this reviewer report, we have added a supplemental figure with examples of false positive/negative detections and describe in the legend the main causes of the incorrect detections.</p><disp-quote content-type="editor-comment"><p>Reviewer #1:</p></disp-quote><p> <italic>In the current manuscript, Ciliberti et al., describe a novel closed-loop method for online detection of the spatial content encoded by ripple events to allow for near-real-time feedback during specific replay events. This method addresses an important technical problem for</italic> in vivo <italic>hippocampal research, namely that current work on hippocampal sequences is necessarily correlative. To demonstrate causal relationships between ripple-based reactivation (or other sequences, such as theta sequences) and behavior/memory, one must manipulate neural activity only during expression of specific sequences. As the authors note, one prior replay detection algorithm has been published, although the method described in the current manuscript is distinct from that described by Deng et al.</italic></p><p>Before discussing the points below, we want to highlight that our algorithm is more complete than the on presented in Deng et al., 2016, as it is suitable for an online scenario with streaming data rather than on offline scenario in which the onset and offset of replay events are known. In addition – and in contrast to Deng et al., – we have demonstrated and characterized a real-time implementation.</p><disp-quote content-type="editor-comment"><p>I have very few concerns regarding the methodology described in the manuscript. I think the authors have done an excellent job of quantifying the accuracy of their algorithm with the dataset they collected, and the authors have convinced me that their method is generally effective at identifying specific replay trajectories in one rat. However, I do have concerns regarding the general applicability of this method beyond the single example recording described in this paper.</p><p>If the authors were using this methodology to address a specific scientific question, then it would be acceptable to demonstrate how well it works on their dataset and stop there. However, if the authors are attempting to provide this methodology as a general tool to the scientific community, it becomes much more important to establish the parameter space in which it works and in which it fails. The authors do explore some parameter tuning, but this is largely limited to adjusting θsharp and θmua. It seems to me that many additional parameters necessarily impact both the quality and the speed of this algorithm. While it is impractical for the authors to examine all possible parameters that may ever be encountered, there are two critical parameters that I feel should be examined by the authors to make this method generally useful to the broader scientific community. The first of these parameters is the total number of spikes that are entering the algorithm per time bin. From my understanding of the Bayesian decoding algorithm, more spikes generally produces a higher maximum posterior probability, which would be expected to result in more θsharp crossings. I also presume that more spikes might generally produce a more accurate representation of the current information representation in the hippocampus and thus increase the likelihood of true replay detection. Further, a higher average spike rate would likely serve to lower bin-to-bin spike density fluctuations, thereby reducing spurious θmua crossings. Finally, based on Figure 1C, it seems that more spikes slows the decoding algorithm. Thus, I wonder if there is an optimum number of spikes/ms for this method. In other words, would too many recording electrodes actually become detrimental to implementation of this method (by slowing the decoding too much or making the posterior probabilities too high)? Alternatively, are there a critical number of electrodes or spikes/ms that are required for this method to be effective (to avoid too many spurious θmua crossings or to ensure faithful decoding)? These questions could be addressed by subsampling the authors' datasets in order to test whether there is a minimum required spike rate. In addition, there are several publicly available datasets that may contain more spikes/ms or the authors could artificially add spikes to their existing dataset to test the effect of increasing total sampling on the algorithm's performance.</p></disp-quote><p>The reviewer is correct that a higher number of spikes (or more accurately, a higher number of informative spikes) improves decoding accuracy with a higher maximum posterior probability. At the same time, more spikes give a better estimate of instantaneous MUA rate. The downside of more spikes is an increase of the computational burden that may affect latency.</p><p>To address the reviewer's comment, we first performed a stress test to show what spike rate can be handled in our system with varying number of tetrodes. We performed the test on both a 32-core workstation and a more standard quad-core machine. The results (Figure 1—figure supplement 2) indicate that the added latency remains low even for high spike rates. The quad-core computer generally performs well but has increased median and worst case added latency for high tetrode counts and high spike rates.</p><p>Second, we followed the reviewer's suggestion and characterized the replay detection algorithm and its performance when less data is available (by subsampling the tetrodes). As shown in <xref ref-type="fig" rid="respfig1">Author response image 1</xref>, the reviewer predicted correctly that higher tetrode number decreases the variability and hence increase the separability of the MUA rate distributions for non-burst periods, bursts without replay and bursts with replay. The reviewer was also correct that the maximum posterior probability (as measured by our sharpness measure) shifts to higher values with increasing number of tetrodes, without reaching a plateau in our dataset (panels b and d in <xref ref-type="fig" rid="respfig1">Author response image 1</xref>). Still, sharpness distributions for non-burst periods and bursts with replay remain separable.</p><p>The quantification of the online replay detection performance after tetrode subsampling are described in a new section in the main text and shown in Figure 6 and its supplements. In brief, online replay detection performance increases with higher number of tetrodes, but the increase is strongest when the number of tetrodes is ten or more in our dataset. This suggests that a critical number of tetrodes (and a critical number of informative spikes on these tetrodes) are required for accurate replay detection. In contrast, run decoding error (in 200 ms time bins) during exploration appeared to be less sensitive to reduction of the number of tetrodes. As a consequence, although there is a (highly non-linear) correlation between the variables, a low run decoding error is not a sufficient condition for subsequent good online replay detection.</p><p>(We can include the <xref ref-type="fig" rid="respfig1">Author response image 1</xref> in the manuscript if the reviewer considers this desirable).</p><fig id="respfig1"><object-id pub-id-type="doi">10.7554/eLife.36275.024</object-id><label>Author response image 1.</label><caption><p>(<bold>a</bold>) Example distributions of MUA rate for time bins outside and inside (with or without identified replay content) candidate replay bursts. Rest epoch. (<bold>b</bold>) Mean MUA rate as a function of the number of tetrodes included. Note that mean rate remains constant, but the variance increases with fewer tetrodes. (<bold>c</bold>) Hellinger distance between MUA rate distributions as a function of the number of tetrodes included. (<bold>d</bold>) Optimal <italic>θ<sub>mua</sub></italic> threshold as a function of the number of tetrodes included. (<bold>a</bold>) Example distributions of sharpness values for time bins outside and inside (with or without identified replay content) candidate replay bursts. Rest epoch. Note shift towards higher sharpness values when more tetrodes are included. (<bold>b</bold>) Mean sharpness value as a function of the number of tetrodes included. (<bold>c</bold>) Hellinger distance between sharpness distributions as a function of the number of tetrodes included. (<bold>d</bold>) Optimal <italic>θ<sub>sharp</sub></italic> threshold as a function of the number of tetrodes included.</p></caption><graphic mime-subtype="jpeg" mimetype="image" xlink:href="elife-36275-resp-fig1-v1"/></fig><disp-quote content-type="editor-comment"><p>The second parameter is the effective 'coverage' of the environment by the spiking activity. While the authors report that there was sufficient coverage in order to faithfully decode the animal's location during exploration (these data should be shown), it was not reported whether the decoding was more/less accurate on specific arms or whether that accuracy impacted the performance of the algorithm in detecting replays of that arm. This would be important information for researchers to have in order to allow them to know when this method can be properly utilized and when it can't. Specifically, is there a critical decoding accuracy (during active behavior using a 200-300 ms decoding window) that must be met before the replay detection algorithm is effective? This could be examined by the authors by selectively subsampling the spikes detected on specific arms to reduce the effectiveness of the encoding model in order to correlate decoding accuracy with replay detection. This additionally addresses how long RUN1 needs to be for the algorithm to work (i.e., are five laps sufficient to build the encoding model or does it require 20 laps?).</p><p>These two parameters could also be tested, perhaps more convincingly, by obtaining data from additional rats, although I do not believe that this is strictly necessary.</p></disp-quote><p>We have added quantification of the decoding performance during exploration for both RUN1 and RUN2 epochs in Figure 1—figure supplement 3.</p><p>To look at the relation between decoding accuracy (during exploration) and online replay detection performance, we subsampled tetrodes and simulated the online replay detection on the downgraded dataset. (To keep the analysis manageable, we opted to subsample tetrodes rather than subsampling of spikes detected on specific arms.) The results are shown in the new Figure 6. As also mentioned above, a low decoding error during exploration does not automatically mean a good online replay detection.</p><p>To look at how much data in RUN1 is needed to build a decent encoding model, we built the model with varying training times (<xref ref-type="fig" rid="respfig2">Author response image 2</xref>). For each training time, we also counted the number of laps that the rat completed for each maze arm. As expected, decoding performance improves with more training time, and a handful of laps are sufficient to reach a relatively stable performance. The figure could be added as a supplemental figure if the reviewer requests this.</p><fig id="respfig2"><object-id pub-id-type="doi">10.7554/eLife.36275.025</object-id><label>Author response image 2.</label><caption><title>Decoding performance during exploration in all three datasets as a function of the training time and corresponding number of laps used to build the encoding model.</title><p>(<bold>a</bold>) Median in-arm decoding error. (<bold>b</bold>) Fraction of position estimates that were located in the correct arm.</p></caption><graphic mime-subtype="jpeg" mimetype="image" xlink:href="elife-36275-resp-fig2-v1"/></fig><disp-quote content-type="editor-comment"><p>Reviewer #2:</p><p>This Tools and Resources article is the first to demonstrate classification of hippocampal replay using real-time ensemble decoding. This is an achievement that anyone with an interest in replay has likely dreamed of for many years, and to see it finally done is cause for celebration. The ability to detect specific replay content with sufficiently short latency to apply closed-loop (Kloost-loop?) interventions such as medial forebrain stimulation, or optogenetic inhibition of a downstream target, is a major step forward that heralds a potentially transformative wave of experiments.</p><p>Of course, this report stops short of actually implementing a closed-loop manipulation, but I do not think that diminishes the magnitude and importance of what the authors have accomplished. The key result is that the required computations, notably clusterless ensemble decoding and subsequent classification, can be performed with impressively short latency (&lt;2 ms, Figure 1D) in a fully working system that is streaming data from a single &quot;proof-of-principle&quot; subject.</p><p>In combining ensemble decoding and application to replay, this demonstration is a clear advance compared to previous work, although the authors could be more comprehensive in referencing not only the de Lavilleon et al., (2015) paper in the introduction, but also the work by Guger et al., (2011) and that of Bartic, Battaglia and colleagues (Nguyen et al., 2014; Bartic et al., 2016). Similarly, there is an extensive literature on brain-machine interfaces for control of prosthetic limbs and computer cursors, including real-time decoding systems by Nicolelis, Donohue, Schwartz, Andersen and others. The manuscript would benefit from a paragraph clarifying the similarities and differences with that body of work.</p></disp-quote><p>Thank you for your suggestions. We have updated the discussion to include references to the work of Guger et al., and Nguyen et al. We have also added paragraph describing similarities and differences with brain-machine interfaces and neuroprosthetics and we describe our new method in the wider context of BCIs in the Introduction. We hope these changes address the reviewer’s comments.</p><disp-quote content-type="editor-comment"><p>The hardware and software components of the system are clearly described and visualized (Figure 1—figure supplement 1 is particularly helpful). The extensive set of offline data analyses are well justified and appropriate, and the authors provide a fair and balanced discussion highlighting areas where the system can be improved.</p><p>I have only one major comment, which I expect the authors to be able to address in short order.</p><p>I strongly suggest that the authors make the data sets used publicly available. Doing so would greatly facilitate comparison of potential future improvements built by others to the original results and therefore enhance the impact of the work. Relatedly, it was unclear to me from the manuscript whether the described system is currently implemented in the current version of the open-source Falcon software, please clarify.</p></disp-quote><p>Thank you for your suggestion. As mentioned in our reply to the editor’s comments, we are preparing the three datasets for release and will upload them to the “Collaborative Research in Computational Neuroscience” website (http://crcns.org). We are also in the process of adding the processor for decoding and replay detection to the public Falcon repository, and we are preparing the repositories with Python code used to perform offline analysis for public release.</p><disp-quote content-type="editor-comment"><p>Reviewer #3:</p><p>Hippocampal replay is one of the more interesting information-carrying phenomena identified in the brain. Despite more than a decade of study, however, we know less. The authors present a characterization of a real-time replay detection algorithm. Their tool would be broadly useful in experiments in which one wished to understand how the information represented in hippocampal activity during sharp wave ripples impacts learning and memory. The need for these experiments was further brought home to me as I tried to summarize my concerns about how true-positive and false-positive events were selected. Consequently, I am very excited about this work.</p><p>The main innovation I find in the paper is developing and characterizing a real-time replay detection algorithm. It builds on the authors' development of a real-time processing architecture (Ciliberti and Kloosterman, 2017). As much as I am sympathetic with the need to elevating the profile of innovation in neuroengineering, it is unclear to me whether this work is appropriate for eLife. In particular, there did not appear to be a scientific discovery. I believe that there are hints that there may be something interesting revealed about the hippocampus in the performance of the real-time algorithm, insofar as the presence of a complete replay event and its spatial content may be predictable from some fraction of the initial portion. Clearly if this was a focus of the paper that would meet the standard. Absent such a scientific result, the work might be more appropriate for a more engineering-focused journal.</p><p>An alternative scientific result would have been some behavioral effect of disruption of replay. The lack of such an effect, which the presence in the methods of a description of implantation of stimulation electrodes into the ventral hippocampal commissure suggests was the subject of experimental exploration, is striking. Specifically, the authors explore how the parameters of their real-time system affect the detection performance relative to an offline standard. The performance is quite good, but what if this reflects the fact that the offline standard is in appropriate? How the choice of offline-standard parameters affects the relative real-time detection is not explored.</p></disp-quote><p>The reviewer is correct that the long-term goal of this work is to assess the behavioral consequences of content-specific replay disruption. Given the complexity of these experiments, we believe opening the technology to the larger experimental neuroscience community sooner (as a Tools and Resources article in <italic>eLife</italic> and by sharing the tools) provides the best way forward.</p><p>We are happy to hear that the reviewer considers the performance of our system “quite good”. The reviewer wonders if the performance level may be due to an inappropriate offline defined standard to which the online detections are compared. This comment touches on an important issue. Although the reviewer is concerned about an inflated online performance, the opposite may be true as well: an inappropriate offline standard that underestimates the online replay detection performance. Fundamentally, the problem is that no ground truth replay labels exist. For this reason, we sought to first characterize the online detection without a hard classification of events into bursts with or without replay content. As shown in Figure 2, positively detected events score higher in several measures that correlate with replay content.</p><p>For more in depth quantification of the performance, we did compare the online detections to an offline standard. In our view, an experimenter needs to first define what constitutes replay content and then constructs offline and online detectors that aim to identify the (unlabeled) replay events. The offline detector has access to all data and is not bound by limited compute time and the online detector is (generally) modeled after the offline detector but includes compromises to perform fast and early real-time detection. Hence, we have more confidence in the ability of the offline detector to correctly detect replay events and to provide the best possible reference for evaluation of the online detector performance. One would then try to adjust the parameters for the online detector (e.g. using prior knowledge or training data) to match its result to that of the offline detector.</p><p>If the offline standard is “inappropriate” with respect to the (unknown) ground truth (e.g. parameters of the offline detector are set incorrectly), then any (mis)match between the result of the online detector and the offline standard will be difficult to interpret. By changing the parameters of the offline detector, the resulting offline standard may vary all the way from being very inclusive (e.g. all population bursts are marked as replay) to very exclusive (e.g. no population bursts are marked as replay) – and the online detector will largely follow as parameters are adapted (to the extent that the offline and online algorithms are consistent). However, because ground truth is unknown, there is no direct way in which we can assess if the offline standard is appropriate. Indirect methods, such as visual inspection or independent replay assessment (e.g. separate replay measures that are not part of the offline detector), may be helpful and strengthen our belief that the offline standard is appropriate. In our manuscript, visual inspection of the offline defined replay events, as illustrated by the example (non)replay events shown in Figure 3 and the new Figure 3—figure supplement 1, give us confidence that the offline standard is appropriate and contains events with the desired replay structure. We have added some of the consideration above to the Discussion section.</p><p>[Editors' note: further revisions were requested prior to acceptance, as described below.]</p><disp-quote content-type="editor-comment"><p>Reviewer #1:</p><p>The revised manuscript is much improved, and the authors have largely addressed my concerns.</p><p>I would have much preferred for Figure 6 to have examined the effect of spike or cell number rather than tetrode number, as one can put in 100 tetrodes and get no cells or put in 12 tetrodes and get 150 cells (Wilson and McNaughton, 1993). However, I think the figure included in the response (Figure A) addresses this concern and should be included as Figure 1—figure supplement 4.</p></disp-quote><p>We have added <xref ref-type="fig" rid="respfig1">Author response image 1</xref> from the previous reply as supplementary figure to the manuscript. However, given that the data presented relates to the tetrode subsampling analysis, we have included the figure as Figure 6—figure supplement 2.</p><disp-quote content-type="editor-comment"><p>I appreciate the analyses included in <xref ref-type="fig" rid="respfig2">Author response image 2</xref> in the response, and I think it is valuable information for someone planning to use this method, but I don't consider it strictly necessary (given the relatively modest improvement in accuracy beyond 1 lap). Considering that there are no limits (as far as I know) for supplemental data, and considering that the figure is already made, I see no reason not to include it.</p></disp-quote><p>We have added the figure as Figure 1—figure supplement 4.</p><disp-quote content-type="editor-comment"><p>Reviewer #2:</p><p>In this revision, the authors have added major new analyses to what was already an impressive demonstration of the first real-time ensemble decoding system for hippocampal replay content. The new analyses are important in delineating the tradeoffs involved in configuring the system, and the conditions that need to be met for adequate performance.</p><p>Among these additions is the subsampling analysis which suggests a nonlinear performance improvement around 10 tetrodes, and continued improvement as more tetrodes are added. Also useful is the analysis describing how much sampling of the environment is required to build a usable encoding model (<xref ref-type="fig" rid="respfig2">Author response image 2</xref> in the rebuttal). If the authors prefer to not include this figure as a supplement, I think a statement in the text along with some descriptive statistics would be helpful in making the point that for this data set, a few trials appear to be sufficient.</p></disp-quote><p>We have added the figure as Figure 1—figure supplement 4.</p></body></sub-article></article>