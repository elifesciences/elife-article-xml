<?xml version="1.0" ?><!DOCTYPE article PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD v1.3 20210610//EN"  "JATS-archivearticle1-mathml3.dtd"><article xmlns:ali="http://www.niso.org/schemas/ali/1.0/" xmlns:xlink="http://www.w3.org/1999/xlink" article-type="research-article" dtd-version="1.3" xml:lang="en">
<front>
<journal-meta>
<journal-id journal-id-type="nlm-ta">elife</journal-id>
<journal-id journal-id-type="publisher-id">eLife</journal-id>
<journal-title-group>
<journal-title>eLife</journal-title>
</journal-title-group>
<issn publication-format="electronic" pub-type="epub">2050-084X</issn>
<publisher>
<publisher-name>eLife Sciences Publications, Ltd</publisher-name>
</publisher>
</journal-meta>
<article-meta>
<article-id pub-id-type="publisher-id">92495</article-id>
<article-id pub-id-type="doi">10.7554/eLife.92495</article-id>
<article-id pub-id-type="doi" specific-use="version">10.7554/eLife.92495.2</article-id>
<article-version-alternatives>
<article-version article-version-type="publication-state">reviewed preprint</article-version>
<article-version article-version-type="preprint-version">1.4</article-version>
</article-version-alternatives>
<article-categories>
<subj-group subj-group-type="heading">
<subject>Neuroscience</subject>
</subj-group>
</article-categories>
<title-group>
<article-title>Multi-day Neuron Tracking in High Density Electrophysiology Recordings using EMD</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<name>
<surname>Yuan</surname>
<given-names>Augustine(Xiaoran)</given-names>
</name>
<xref ref-type="aff" rid="a1">1</xref>
<xref ref-type="aff" rid="a2">2</xref>
</contrib>
<contrib contrib-type="author">
<name>
<surname>Colonell</surname>
<given-names>Jennifer</given-names>
</name>
<xref ref-type="aff" rid="a1">1</xref>
</contrib>
<contrib contrib-type="author">
<name>
<surname>Lebedeva</surname>
<given-names>Anna</given-names>
</name>
<xref ref-type="aff" rid="a3">3</xref>
</contrib>
<contrib contrib-type="author">
<name>
<surname>Okun</surname>
<given-names>Michael</given-names>
</name>
<xref ref-type="aff" rid="a4">4</xref>
</contrib>
<contrib contrib-type="author" corresp="yes">
<name>
<surname>Charles</surname>
<given-names>Adam S.</given-names>
</name>
<email>adamsc@jhu.edu</email>
<xref ref-type="aff" rid="a2">2</xref>
</contrib>
<contrib contrib-type="author" corresp="yes">
<contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-6289-4439</contrib-id>
<name>
<surname>Harris</surname>
<given-names>Timothy D.</given-names>
</name>
<email>harrist@janelia.hhmi.org</email>
<xref ref-type="aff" rid="a1">1</xref>
<xref ref-type="aff" rid="a2">2</xref>
</contrib>
<aff id="a1"><label>1</label><institution>Janelia Research Campus, Howard Hughes Medical Institute</institution>, <country>USA</country></aff>
<aff id="a2"><label>2</label><institution>Department of Biomedical Engineering, Center for Imaging Science Institute, Kavli Neuroscience Discovery Institute, Johns Hopkins University</institution>, <country>USA</country></aff>
<aff id="a3"><label>3</label><institution>Sainsbury Wellcome Centre, University of Sheffield</institution>, <country>UK</country></aff>
<aff id="a4"><label>4</label><institution>Department of Psychology and Neuroscience Institute, Howard Hughes Medical Institute</institution>, <country>USA</country></aff>
</contrib-group>
<contrib-group content-type="section">
<contrib contrib-type="editor">
<name>
<surname>Peyrache</surname>
<given-names>Adrien</given-names>
</name>
<role>Reviewing Editor</role>
<aff>
<institution-wrap>
<institution>McGill University</institution>
</institution-wrap>
<city>Montreal</city>
<country>Canada</country>
</aff>
</contrib>
<contrib contrib-type="senior_editor">
<name>
<surname>Poirazi</surname>
<given-names>Panayiota</given-names>
</name>
<role>Senior Editor</role>
<aff>
<institution-wrap>
<institution>FORTH Institute of Molecular Biology and Biotechnology</institution>
</institution-wrap>
<city>Heraklion</city>
<country>Greece</country>
</aff>
</contrib>
</contrib-group>
<pub-date date-type="original-publication" iso-8601-date="2023-12-12">
<day>12</day>
<month>12</month>
<year>2023</year>
</pub-date>
<pub-date date-type="update" iso-8601-date="2024-02-27">
<day>27</day>
<month>02</month>
<year>2024</year>
</pub-date>
<volume>12</volume>
<elocation-id>RP92495</elocation-id>
<history>
<date date-type="sent-for-review" iso-8601-date="2023-09-18">
<day>18</day>
<month>09</month>
<year>2023</year>
</date>
</history>
<pub-history>
<event>
<event-desc>Preprint posted</event-desc>
<date date-type="preprint" iso-8601-date="2023-09-03">
<day>03</day>
<month>09</month>
<year>2023</year>
</date>
<self-uri content-type="preprint" xlink:href="https://doi.org/10.1101/2023.08.03.551724"/>
</event>
<event>
<event-desc>Reviewed preprint v1</event-desc>
<date date-type="reviewed-preprint" iso-8601-date="2023-12-12">
<day>12</day>
<month>12</month>
<year>2023</year>
</date>
<self-uri content-type="reviewed-preprint" xlink:href="https://doi.org/10.7554/eLife.92495.1"/>
<self-uri content-type="editor-report" xlink:href="https://doi.org/10.7554/eLife.92495.1.sa2">eLife assessment</self-uri>
<self-uri content-type="referee-report" xlink:href="https://doi.org/10.7554/eLife.92495.1.sa1">Reviewer #1 (Public Review):</self-uri>
<self-uri content-type="referee-report" xlink:href="https://doi.org/10.7554/eLife.92495.1.sa0">Reviewer #2 (Public Review):</self-uri>
</event>
</pub-history>
<permissions>
<copyright-statement>© 2023, Yuan et al</copyright-statement>
<copyright-year>2023</copyright-year>
<copyright-holder>Yuan et al</copyright-holder>
<ali:free_to_read/>
<license xlink:href="https://creativecommons.org/licenses/by/4.0/">
<ali:license_ref>https://creativecommons.org/licenses/by/4.0/</ali:license_ref>
<license-p>This article is distributed under the terms of the <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution License</ext-link>, which permits unrestricted use and redistribution provided that the original author and source are credited.</license-p>
</license>
</permissions>
<self-uri content-type="pdf" xlink:href="elife-preprint-92495-v2.pdf"/>
<abstract>
<title>Abstract</title><p>Accurate tracking of the same neurons across multiple days is crucial for studying changes in neuronal activity during learning and adaptation. New advances in high density extracellular electrophysiology recording probes, such as Neuropixels, provide a promising avenue to accomplish this goal. Identifying the same neurons in multiple recordings is, however, complicated by non-rigid movement of the tissue relative to the recording sites (drift) and loss of signal from some neurons. Here we propose a neuron tracking method that can identify the same cells independent of firing statistics, which are used by most existing methods. Our method is based on between-day non-rigid alignment of spike sorted clusters. We verified the same cell identify using measured visual receptive fields. This method succeeds on datasets separated from one to 47 days, with an 84% average recovery rate.</p>
</abstract>

</article-meta>
<notes>
<notes notes-type="competing-interest-statement">
<title>Competing Interest Statement</title><p>The authors have declared no competing interest.</p></notes>
<fn-group content-type="summary-of-updates">
<title>Summary of Updates:</title>
<fn fn-type="update"><p>We have added material to discuss the applicability to other brain areas outside mouse visual cortex. sorter (Methods section 4.2, Supplement section 8.4, figure S9, paragraphs 7-10 of the Discussion section).
To address the concern of overfitting, we have also added discussion covering adjustment of the two parameters in the procedure (the relative weight of waveform distance vs. physical distance, and the threshold for accepting matches as real) to the Discussion section.
Since the posting of this manuscript, another method for tracking neurons has been introduced:
Enny H. van Beest, Celian Bimbard, Julie M. J. Fabre, Flora Takacs, Philip Coen, Anna Lebedeva, Kenneth Harris, Matteo Carandini, Tracking neurons across days with high-density probes, bioRxiv 2023.10.12.562040; doi: https://doi.org/10.1101/2023.10.12.562040
</p></fn>
</fn-group>
<fn-group content-type="external-links">
<fn fn-type="dataset"><p>
<ext-link ext-link-type="uri" xlink:href="https://github.com/AugustineY07/Neuron_Tracking">https://github.com/AugustineY07/Neuron_Tracking</ext-link>
</p></fn>
</fn-group>
</notes>
</front>
<body>
<sec id="s1">
<label>1</label><title>Introduction</title>
<p>The ability to longitudinally track neural activity is crucial to understanding central capabilities and changes of neural circuits that operate on long time-scales, such as learning and plasticity,<sup><xref ref-type="bibr" rid="c1">1</xref>–<xref ref-type="bibr" rid="c4">4</xref></sup> motor stability,<sup><xref ref-type="bibr" rid="c1">1</xref>, <xref ref-type="bibr" rid="c5">5</xref>, <xref ref-type="bibr" rid="c6">6</xref></sup> etc. We seek to develop a method capable of tracking single units regardless of changes in functional responses for the duration of an experiment spanning one to two months.</p>
<p>High-density multi-channel extracellular electrophysiology (ephys) recording devices enable chronic recordings over large areas over days-to-months.<sup><xref ref-type="bibr" rid="c7">7</xref></sup> Such chronic recordings make possible experiments targeted at improving our understanding of neural computation and underlying mechanisms. Examples include perceptual decision making, exploration and navigation.<sup><xref ref-type="bibr" rid="c8">8</xref>–<xref ref-type="bibr" rid="c13">13</xref></sup> Electrode arrays with hundreds to thousands of sites, for example Neuropixels, are now used extensively to record the neural activity of large populations stably and with high spatio-temporal resolution, capturing hundreds of neurons with single neuron resolution.<sup><xref ref-type="bibr" rid="c9">9</xref>, <xref ref-type="bibr" rid="c10">10</xref></sup> Moreover, ephys retains the higher time resolution needed for single spike identification, as compared with calcium imaging that provides more spatial cues with which to track neurons over days.</p>
<p>The first step in analyzing ephys data is is to extract single neuron signals from the recorded voltage traces, i.e., spike sorting. Spike sorting identifies individual neurons by grouping detected action potentials using waveform profiles and amplitudes. Specific algorithms include principal components based methods<sup><xref ref-type="bibr" rid="c14">14</xref></sup> and,<sup><xref ref-type="bibr" rid="c15">15</xref></sup> and template matching methods, for example, Kilosort.<sup><xref ref-type="bibr" rid="c9">9</xref>, <xref ref-type="bibr" rid="c11">11</xref>, <xref ref-type="bibr" rid="c16">16</xref>, <xref ref-type="bibr" rid="c17">17</xref></sup> Due to the high dimensional nature of the data, spike sorting is often computationally intensive on large data sets (10’s to 100’s of GB) and optimized to run on single sessions. Thus processing multiple sessions has received minimal attention, and the challenges therein remain largely unaddressed.</p>
<p>One major challenge in reliably tracking neurons is the potential for changes in the neuron population recorded (<bold><italic><xref rid="fig1" ref-type="fig">Figure 1</xref></italic></bold>a and <bold><italic><xref rid="fig1" ref-type="fig">Figure 1</xref></italic></bold>b). In particular, since the probe is attached to the skull, brain tissue can move relative to the probe, e.g. during licking, and drift can accumulate over time.<sup><xref ref-type="bibr" rid="c18">18</xref></sup> Kilosort 2.5 corrects drift within a single recording by inferring tissue motion from continuous changes in spiking activity and interpolating the data to account for that motion.<sup><xref ref-type="bibr" rid="c7">7</xref></sup> Larger between-recording drift occurs for sessions on different days, and can 1) change the size and location of spike waveforms along the probe,<sup><xref ref-type="bibr" rid="c19">19</xref></sup> 2) lose neurons that move out of range, and 3) gain new neurons that move into recording range. Thus clusters can change firing pattern characteristics or completely appear/disappear. As a result the specific firing patterns classified as unit clusters may appear and disappear in different recordings.<sup><xref ref-type="bibr" rid="c9">9</xref>, <xref ref-type="bibr" rid="c20">20</xref>–<xref ref-type="bibr" rid="c22">22</xref></sup> Another challenge is that popular template-matching-based spike sorting methods usually involve some randomness in template initialization.<sup><xref ref-type="bibr" rid="c16">16</xref>, <xref ref-type="bibr" rid="c23">23</xref>, <xref ref-type="bibr" rid="c24">24</xref></sup> As a result, action potentials can be assigned into clusters differently, and clusters can be merged or separated differently across runs.</p>
<fig id="fig1" position="float" orientation="portrait" fig-type="figure">
<label>Fig. 1:</label>
<caption><title>Schematic depiction of drift:</title>
<p>a. Mice were implanted with a 4-shank Neuropixels 2.0 probe in visual cortex area V1. b. he location of a unit recorded on the probe. In this hypothetical case, the same color indicates unit The black unit is missing on day 48, while the turquoise star is an example of a new unit. Tracking and blue units across all datasets and determine that the black unit is undetected on day 48. c. Two eforms of units recorded in two datasets that likely represent the same neuron, based on similar the average waveform on one channel across 2.7 milliseconds. The blue traces are waveforms on channels (two rows above, two rows below, and one in the same row) from the first dataset (Day ected, are from the second dataset. Waveforms are aligned at the electrodes with peak amplitude, different on the two days.</p></caption>
<graphic xlink:href="551724v4_fig1.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
<p>Previous neuron tracking methods are frequently based on waveform and firing statistics, e.g., firing rate similarity,<sup><xref ref-type="bibr" rid="c25">25</xref></sup> action potential shape correlation and inter-spike interval histogram(ISI) shape.<sup><xref ref-type="bibr" rid="c26">26</xref></sup> When neuronal representations change, e.g., during learning<sup><xref ref-type="bibr" rid="c1">1</xref>–<xref ref-type="bibr" rid="c3">3</xref></sup> or representational drift,<sup><xref ref-type="bibr" rid="c27">27</xref></sup> neural activity statistics became less reliable. In this work, we take advantage of the rich spatialtemporal information in the multi-channel recordings, matching units based on the estimated neuron locations and unit waveforms,<sup><xref ref-type="bibr" rid="c28">28</xref></sup> instead of firing patterns.</p>
<p>As an alternative method, Steinmetz et al.<sup><xref ref-type="bibr" rid="c7">7</xref></sup> concatenated pairs of datasets after low resolution alignment, awkward for more than 2 datasets. We report here a more flexible, expandable and robust tracking method that can track neurons effectively and efficiently across any number of sessions.</p>
</sec>
<sec id="s2">
<label>2</label><title>Results</title>
<sec id="s2a">
<label>2.1</label><title>Procedure</title>
<p>Our datasets consist of multiple recordings taken from three mice (<bold><italic><xref rid="fig7" ref-type="fig">Figure 7</xref></italic></bold>a) over 2 months. The time gap between two recordings ranges from two to 25 days. Each dataset is spike-sorted individually with a standard Kilosort 2.5 pipeline. The sorting results, including unit assignment, spike times, etc. are used as input for our method (post-processed using ecephys spike sorting pipeline<sup><xref ref-type="bibr" rid="c29">29</xref></sup>) (<xref rid="s4c" ref-type="sec">Sec. 4.3</xref>). To ensure the sorting results are unbiased, we performed no manual curation. As the clusters returned by Kilosort can vary in quality, we only considered the subset of units labeled as ‘good’ by Kilosort, here referred to as KSgood units (<xref rid="s4d" ref-type="sec">Sec. 4.4</xref>). KSgood units are mainly determined by the amount of inter-spike-interval violations and are believed to represent a single unit.<sup><xref ref-type="bibr" rid="c16">16</xref></sup></p>
<p>Our overall strategy is to run spike-sorting once per session, and then to generate a unit-by-unit assignment between pairs of datasets. When tracking units across more than two sessions, two strategies are possible: match all ensuing sessions to a single session (e.g., the first session) (<xref rid="s2b" ref-type="sec">Sec. 2.2</xref> and <xref rid="s4b" ref-type="sec">Sec. 4.2</xref>), or match consecutive pairs of sessions and then trace matched units through all sessions (<xref rid="s2d" ref-type="sec">Sec. 2.4</xref>).</p>
<p>We refer to the subset of KSgood units with strong and distinguishable visual responses in both datasets of a comparison as reference units (See <xref rid="s4d" ref-type="sec">Sec. 4.4</xref> for details). Similar to Steinmetz et al.<sup><xref ref-type="bibr" rid="c7">7</xref></sup> we validated our unit matching of those reference units using visual receptive field similarity. Finally, we showed that trackable units with strong visual responses are qualitatively similar to those without (<bold><italic><xref rid="figs1" ref-type="fig">Figure S1</xref></italic></bold> to <bold><italic><xref rid="figs5" ref-type="fig">Figure S5</xref></italic></bold>).</p>
<p>To provide registration between pairs of recordings, we used the Earth Mover’s Distance (EMD).<sup><xref ref-type="bibr" rid="c30">30</xref>, <xref ref-type="bibr" rid="c31">31</xref></sup> We use a feature space consisting of a geometric distance space and a waveform similarity space, to address both rigid and non-rigid neuron motion. The EMD finds matches between objects in the two distributions by minimizing the overall distances between the established matches (<xref rid="s4a" ref-type="sec">Sec. 4.1</xref>.1).</p>
<p>We use EMD in two stages: rigid drift correction and unit assignment. Importantly, the EMD distance incorporates two parameters crucial for matching units: location-based physical distance and a waveform distance metric that characterizes similarity of waveforms (<xref rid="s4a" ref-type="sec">Sec. 4.1</xref>.2). The EMD distance matrix is constructed with a weighted combination of the two (details in Sec. 4), i.e. a distance between two units <italic>d</italic><sub><italic>ik</italic></sub> is given by <italic>d</italic><sub><italic>ik</italic></sub> = <italic>d<sub>location</sub><sup>ik</sup></italic> ∗ <italic>d</italic><sub><italic>waveform</italic></sub><sub><italic>ik</italic></sub> (<bold><italic><xref rid="fig2" ref-type="fig">Figure 2</xref></italic></bold>a). The first EMD stage estimates the homogeneous vertical movement of the entire population of KSgood units (<bold><italic><xref rid="fig2" ref-type="fig">Figure 2</xref></italic></bold>b). This movement estimate is used to correct the between-session rigid drift in unit locations. The rigid drift estimation procedure is illustrated in figure 2b. Post drift correction, a unit’s true match will be close in both physical distance and waveform distance. Drift-corrected units were then matched at the second EMD stage. The EMD distance between assigned units can be thought of as the local non-rigid drift combined with the waveform distortion resulting from drift. We test the accuracy of the matching by comparing with reference unit assignments based on visual receptive fields (<xref rid="s4d" ref-type="sec">Sec. 4.4</xref>).</p>
<fig id="fig2" position="float" orientation="portrait" fig-type="figure">
<label>Fig. 2:</label>
<caption><title>The EMD can detect the displacement of single units:</title>
<p>a. Schematic of EMD unit matching. Each blue unit in day 1 is. Dashed lines indicate the matches to be found by minimizing the weighted sum of physical and nd filled circles show positions of units in days 1 and 2, respectively. Arrows indicate matching using ts the match direction; upward matches found with the EMD are in red and downward in black. Solid ce within 15μ<italic>m</italic>, while a dashed line indicates a z distance &gt; 15μ<italic>m</italic>. Expanded view shows probe area gram of z-distances of matches (black and red bars) and kernel fit (light blue solid curve). The light ode (<italic>d</italic><sub><italic>m</italic></sub> = 15.65μ<italic>m</italic>). The dark blue dashed line shows the imposed drift (<italic>d</italic><sub><italic>i</italic></sub> = 12μ<italic>m</italic>). The red region <italic>m</italic> of the mode. The EMD needs to detect the homogeneous movement against the background, i.e. re unlikely to be the real matches due to biological constraints.</p></caption>
<graphic xlink:href="551724v4_fig2.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
<p>For each unit, the location is determined by fitting the peak to peak amplitudes on the 10 sites nearest the site with peak signal, based on the triangulation method in<sup><xref ref-type="bibr" rid="c32">32</xref></sup> (<xref rid="s4a1a" ref-type="sec">Sec. 4.1.2</xref>). The waveform distance is an L2 norm between two spatial-temporal waveforms that spans 22 channels and 2.7 msec (<xref rid="s4a1a" ref-type="sec">Sec. 4.1.2</xref>). Physical unit distances provide a way to maintain the internal structure and relations between units in the EMD. Waveform similarity metrics will distinguish units in the local neighborhood and likely reduce the effect of new and missing units (<bold><italic><xref rid="figs6" ref-type="fig">Figure S6</xref></italic></bold>).</p>
<p>We analyzed the match assignment results in two ways. First, we compared all subsequent datatsets to dataset 1 using recovery rate and accuracy. We define recovery rate <italic>R</italic><sub><italic>rec</italic></sub> as the fraction of unit assignments by our method that are the same as reference unit assignments established using visual responses (<xref rid="s4d" ref-type="sec">Sec. 4.4</xref>).
<disp-formula id="eqn1">
<graphic xlink:href="551724v4_eqn1.gif" mimetype="image" mime-subtype="gif"/>
</disp-formula></p>
<p>Since the EMD forces all units from the dataset with fewer neurons to have an assigned match, we use vertical z-distance to threshold out the biologically-impossible unit assignments. We then calculated the accuracy <italic>R</italic><sub><italic>acc</italic></sub>, i.e. the fraction of EMD unit assignments within the z-distance thresh-old which agree with the reference assignments.
<disp-formula id="eqn2">
<graphic xlink:href="551724v4_eqn2.gif" mimetype="image" mime-subtype="gif"/>
</disp-formula></p>
<p>We also retrieved non-reference units, i.e. matched units without receptive field information but whose z-distance is smaller than the threshold.</p>
<p>Second, we tracked units between consecutive datasets and summarized and analyzed the waveforms, unit locations, firing rates and visual responses (see <bold><italic><xref rid="figs1" ref-type="fig">Figure S1</xref></italic></bold> to <bold><italic><xref rid="figs5" ref-type="fig">Figure S5</xref></italic></bold> for details) of all tracked chains, i.e. units which can be tracked across at least three consecutive datasets.</p>
</sec>
<sec id="s2b">
<label>2.2</label><title>Measuring rigid drift using the EMD</title>
<p>Drift happens mostly along the direction of probe insertion (vertical or z direction). We want to estimate the amount of vertical drift under the assumption that part of the drift is rigid, this is likely a good assumption given the small (≈ 720μ<italic>m</italic>) z-range of these recordings. The EMD allows us to extract the homogeneous (rigid) movement of matched units. For ideal datasets with a few units consistently detected across days, this problem is relatively simple (<bold><italic><xref rid="fig2" ref-type="fig">Figure 2</xref></italic></bold>a). In the real data analyzed here, we find that only ≈ 60% of units are detected across pairs of days, so the rigid motion of the real pairs must be detected against a background of units with no true match. These units with no real match will have z-shifts far from the consensus z-shift of the paired units (<bold><italic><xref rid="fig2" ref-type="fig">Figure 2</xref></italic></bold>c).</p>
<p>In <bold><italic><xref rid="fig2" ref-type="fig">Figure 2</xref></italic></bold> the EMD match of units from the first dataset (<bold><italic><xref rid="fig2" ref-type="fig">Figure 2</xref></italic></bold>b, open circles) to the dataset recorded the next day (<bold><italic><xref rid="fig2" ref-type="fig">Figure 2</xref></italic></bold>b, closed circles) is indicated by the arrows between them. To demonstrate detection of significant drift, we added a 12 micron upward drift to the z-coordinate of the units from the second day. The first stage of the EMD is used to find matches using the combined distance metric as described in <xref rid="s4a1a" ref-type="sec">section 4.1.2</xref>. We used a kernel fit to the distribution of z-distances of all matched units to find the mode (Mode = 15.65μ<italic>m</italic>); this most probable distance is the estimate of the drift (<bold><italic><xref rid="fig2" ref-type="fig">Figure 2</xref></italic></bold>c). It is close to the actual imposed drift (<italic>d</italic><sub><italic>i</italic></sub> = 12μ<italic>m</italic>).</p>
<p>As the EMD is an optimization algorithm with no biological constraints, it assigns matches to all units in the smaller dataset regardless of biophysical plausibility. As a result, some of the assigned matches may have unrealistically long distances. A distance threshold is therefore required to select correct pairs. For the illustration in <bold><italic><xref rid="fig2" ref-type="fig">Figure 2</xref></italic></bold>, the threshold is set to 15μ<italic>m</italic>, which is chosen to be larger than most of the z-shifts observed in our experimental data. The threshold value will be refined later by distribution fitting (<bold><italic><xref rid="figs2" ref-type="fig">Figure S2</xref></italic></bold>). In <bold><italic><xref rid="fig2" ref-type="fig">Figure 2</xref></italic></bold> all of the sub-threshold (short) distances belong to upward pairs (<bold><italic><xref rid="fig2" ref-type="fig">Figure 2</xref></italic></bold>b and <xref rid="fig2" ref-type="fig">c</xref>, red solid arrows), showing that the EMD can detect the homogeneous movement direction and the amount of imposed drift.</p>
<p>When determining matched reference units from visual response data, we require that units be spatially nearby (within 30μ<italic>m</italic>) as well as having similar visual responses. After correcting for drift, we find that we recover more reference units (<bold><italic><xref rid="figs7" ref-type="fig">Figure S7</xref></italic></bold>), indicating improved spatial match of the two ensembles. This improved recovery provides further evidence of the success of the drift correction.</p>
</sec>
<sec id="s2c">
<label>2.3</label><title>A vertical distance threshold is necessary for accurate tracking</title>
<p>To detect the homogeneous z-shift of correct matches against the background of units without true matches, it is necessary to apply a threshold on the z-shift. When tracking units after shift correction, a vertical distance threshold is again required to determine which matches are reasonable in consideration of biological plausibility. The Receiver Operator Characteristic(ROC) curve in <bold><italic><xref rid="fig3" ref-type="fig">Figure 3</xref></italic></bold> shows the fraction of reference units matched correctly and the number of reference pairs retained as a function of z-distance threshold. We want to determine the threshold that maximizes the overall accuracy in the reference units (<bold><italic><xref rid="fig3" ref-type="fig">Figure 3</xref></italic></bold>, blue curve) while including as many reference units as possible (<bold><italic><xref rid="fig3" ref-type="fig">Figure 3</xref></italic></bold>, red curve).</p>
<fig id="fig3" position="float" orientation="portrait" fig-type="figure">
<label>Fig. 3:</label>
<caption><title>The ROC curve of matching accuracy vs. distance.</title>
<p>The blue curve shows the accuracy for reference units. The red line nce units included. The solid vertical line indicates the average z distance across all reference pairs dashed vertical black line indicates a z-distance threshold at z = 10μ<italic>m</italic>.</p></caption>
<graphic xlink:href="551724v4_fig3.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
<p>Since reference units only account for 29% of KSgood units (units with few inter-spike-interval violations that are believed to represent a single unit), and the majority of KSgood units did not show a distinguishable visual response, we need to understand how representative the reference units are of all KSgood units.</p>
<p>We found the distribution of z-distances of reference pairs is different from the distribution of all KSgood units (<bold><italic><xref rid="fig4" ref-type="fig">Figure 4</xref></italic></bold>a, top and middle panel). While both distributions may be fit to an exponential decay, the best fit decay constant is significantly different (Kolmogorov-Smirnov test, reject H0, p = 5.5 × 10<sup>−31</sup>). Therefore, the accuracy predicted by the ROC of reference pairs in <xref rid="fig3" ref-type="fig">Figure 3</xref> will not apply to the set of all KSgood pairs. The difference in distribution is likely due to the reference units being a special subset of KSgood units in which units are guaranteed to be found in both datasets, whereas the remaining units may not have a real match in the second dataset. To estimate the ROC curve for the set of all KSgood units, we must estimate the z-distance distribution for a mixture of correct and incorrect pairs.</p>
<fig id="fig4" position="float" orientation="portrait" fig-type="figure">
<label>Fig. 4:</label>
<caption><title>Recovery rate, accuracy and putative pairs:</title>
<p>a. The histogram distribution fit for all KS-good units (top) and reference units alone (middle). False positives for reference units are defined as units matched by EMD but not matched when using receptive fields. The false positive fraction for the set of all KSgood units is obtained by integration. z = 10μ<italic>m</italic> threshold has a false positive rate = 27% for KSgood units. b. Light blue bars represent the number of reference units successfully recovered using only unit location and waveform. The numbers on the bars are the recovery rate of each datatset, and the red portion indicates incorrect matches. Incorrect matches are cases where units with a known match from receptive field data are paired with a different unit by EMD; these errors are false positives. The green bars show matching accuracy for the set of pairs with z-distance less than the 10μ<italic>m</italic> threshold. The orange portion indicates incorrect matches after thresholding. The false positives are mostly eliminated by adding the threshold. Purple bars are the number of putative units (unit with no reference information) inferred with z-threshold = 10μ<italic>m</italic>.</p></caption>
<graphic xlink:href="551724v4_fig4.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
<p>We assume that the distribution of z-distances <italic>P</italic> (Δ) for reference units is the conditional probability <italic>P</italic> (Δ ∣ <italic>H</italic>); that is, we assume all reference units are true hits. The distribution of z-distances for all KSgood units <italic>P</italic> (Δ) includes both hits and false positives. The distance distribution of false positives is the difference between the two (<xref rid="s7d" ref-type="sec">Sec. 8.4</xref>, <bold><italic><xref rid="eqn6" ref-type="disp-formula">Equation 6</xref></italic></bold>).</p>
<p>A Monte Carlo simulation determined that the best model for fitting the z-distance distribution of reference units <italic>P</italic> (Δ ∣ <italic>H</italic>) is a folded Gaussian distribution (<bold><italic><xref rid="fig4" ref-type="fig">Figure 4</xref></italic></bold>a, middle panel) and an exponential distribution for false positive units. The KSgood distribution is a weighted combination of the folded Gaussian and an exponential:
<disp-formula id="eqn3">
<graphic xlink:href="551724v4_eqn3.gif" mimetype="image" mime-subtype="gif"/>
</disp-formula></p>
<p>We fit the KSgood distribution to <bold><italic><xref rid="eqn3" ref-type="disp-formula">Equation 3</xref></italic></bold> to extract the individual distribution parameters and the fraction of true hits (f). The full distribution can then be integrated up to any given z-threshold value to calculate the false positive rate. (<bold><italic><xref rid="fig4" ref-type="fig">Figure 4</xref></italic></bold>a, top panel, see <xref rid="s7d" ref-type="sec">Sec. 8.4</xref> for details).</p>
<p>Based on the the estimated false positive rate (<bold><italic><xref rid="fig4" ref-type="fig">Figure 4</xref></italic></bold>a, bottom panel), we used a threshold of 10μ<italic>m</italic> (<bold><italic><xref rid="fig3" ref-type="fig">Figure 3</xref></italic></bold>, black dotted line) to obtain at least 70% accuracy in the KSgood units. We used the same threshold to calculate the number of matched reference units and the corresponding reference unit accuracy (<bold><italic><xref rid="fig4" ref-type="fig">Figure 4</xref></italic></bold>b, green bars).</p>
<p>Note that this threshold eliminates most of the known false positive matches of reference pairs (<bold><italic><xref rid="fig4" ref-type="fig">Figure 4</xref></italic></bold>b, red fraction) at the cost of recovering fewer correct pairs (<bold><italic><xref rid="fig4" ref-type="fig">Figure 4</xref></italic></bold>b, green bars). The recovery rate varies from day to day; datasets separated by longer times tend to have higher tracking uncertainty (<bold><italic><xref rid="figs10" ref-type="fig">Figure S10</xref></italic></bold>).</p>
<p>In addition to the units with visual response data, we can track units which have no significant visual response (<bold><italic><xref rid="fig4" ref-type="fig">Figure 4</xref></italic></bold>b, purple bars). All comparisons are between subsequent datasets and the day 1 dataset.</p>
</sec>
<sec id="s2d">
<label>2.4</label><title>Units can be tracked in discontinuous recordings for 48 days</title>
<p>To assess long-term tracking capabilities, we tracked neurons across all datasets for each mouse. <bold><italic><xref rid="fig5" ref-type="fig">Figure 5</xref></italic></bold> shows a survival plot of the number of unit chains successfully tracked over all durations. All units in the plot can be tracked across at least three consecutive datasets, a chain as the term is used here. We categorized all trackable unit chains into three types: reference chains, mixed chains and putative chains. Reference chains have receptive field information in all datasets. Putative chains have no reference information in any of the datasets. Mixed units have at least one dataset with no receptive field information. There are 133 reference chains, 135 mixed chains and 84 putative chains across all the subjects. Among them, 46 reference, 51 mixed, and 9 putative units can be followed across all datasets. We refer to them as fully trackable units. One example trackable unit in each group is shown in <bold><italic><xref rid="fig6" ref-type="fig">Figure 6</xref></italic></bold>, <bold><italic><xref rid="figs16" ref-type="fig">Figure S16</xref></italic></bold>, and <bold><italic><xref rid="figs17" ref-type="fig">Figure S17</xref></italic></bold>.</p>
<fig id="fig5" position="float" orientation="portrait" fig-type="figure">
<label>Fig. 5:</label>
<caption><p>Number of reference units (deep blue, dark orange and green for different subjects), putative (medium green, medium orange and blue) units, and mixed units (light green, yellow, and light blue) tracked for different durations. The loss rate is similar for different chain types in the same subject. Note that chains can start on any day in the full set of recordings, so the different sets of neurons have chains with different spans between measurements.</p></caption>
<graphic xlink:href="551724v4_fig5.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
<fig id="fig6" position="float" orientation="portrait" fig-type="figure">
<label>Fig. 6:</label>
<caption><title>Example mixed chain:</title>
<p>a. Above: Firing rates of this neuron on each day (Day 1, 2, 13, 23, 48). Below: Firing rate fractional change compared to the previous day. b. Visual response similarity (yellow line), PSTH correlation (orange line), and visual fingerprint correlation (blue line). The similarity score is the sum of vfp and PSTH. The dashed black line shows the threshold to be considered a reference unit. c. Spatial-temporal waveform of a trackable unit. Each pair of traces represents the waveform on a single channel. d. Estimated location of this unit on different days. Each colored dot represents a unit on one day. The orange squares represent the electrodes. e. The pairwise vfp and PSTH traces of this unit.</p></caption>
<graphic xlink:href="551724v4_fig6.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
<p>We hypothesize that the three groups of units are not qualitatively different from each other, that is, all units are equally trackable. In order to check for differences among the three groups, we analyzed the locations, firing rates, waveforms, and receptive fields of the fully trackable units in the three groups: reference, putative, and mixed.</p>
<p>The spatial-temporal waveform similarity is measured by the L2 distance between waveforms (<xref rid="s4a1a" ref-type="sec">Sec. 4.1.2</xref>). A Kruskal-Wallis test is performed on the magnitude of L2 change between all pairs of matched waveforms among the three groups. There is no statistical difference in the waveform similarity in reference, putative, and mixed units (H = 0.59, p = 0.75) (<bold><italic><xref rid="figs1" ref-type="fig">Figure S1</xref></italic></bold>). There is no significant difference in the physical distances of units per dataset (H = 1.31, p = 0.52) (<bold><italic><xref rid="figs2" ref-type="fig">Figure S2</xref></italic></bold>, bottom panel), nor in the location change of units (H = 0.23, p = 0.89) (<bold><italic><xref rid="figs2" ref-type="fig">Figure S2</xref></italic></bold>, top panel).</p>
<p>Firing rate is characterized as the average firing rate fold change of each unit chain, with firing rate of each unit in each dataset normalized by the average firing rate of that dataset. There is no difference in the firing rate fold change in the three groups of units (H = 1, p = 0.6) (<bold><italic><xref rid="figs3" ref-type="fig">Figure S3</xref></italic></bold>).</p>
<p>The receptive field similarity between units in different datasets is described by visual fingerprint (vfp) correlation and Peristimulus Time Histogram (PSTH) correlation between units, and the similarity score, the sum of the two correlations (<xref rid="s4d" ref-type="sec">Sec. 4.4</xref>). The change in vfp between matched units is similar among the three groups (H = 2.23, p = 0.33). Similarly, the change in PSTH is not different among the three groups (H = 1.61, p = 0.45) (<bold><italic><xref rid="figs4" ref-type="fig">Figure S4</xref></italic></bold>).</p>
</sec>
</sec>
<sec id="s3">
<label>3</label><title>Discussion</title>
<p>We present here an EMD-based neuron tracking algorithm that provides a new, automated way to track neurons over long-term experiments to enable the study of learning and adaptation with state-of-the-art high density electrophysiology probes. We demonstrate our method by tracking neurons up to 48 days without using receptive field information. Our method achieves 90% recovery rate on average for neurons separated up to one week apart and 78% on average for neurons five to seven weeks apart (<bold><italic><xref rid="fig4" ref-type="fig">Figure 4</xref></italic></bold>b, blue bars). We also achieved 99% accuracy up to one week apart and 95% five to seven weeks apart, when applying a threshold of 10 μ<italic>m</italic> (<bold><italic><xref rid="fig4" ref-type="fig">Figure 4</xref></italic></bold>b, green bars). It also retrieved a total of 552 tracked neurons with partial or no receptive field information, 12 per pair of datasets on average. All the fully trackable unit chains were evaluated by waveforms and estimated locations. Our method is simple and robust; it only requires spike sorting be performed once, independently, per dataset. In order to be more compatible and generalizable with existing sorting methods, we chose Kilosort, one of the most widely used spike sorting methods.<sup><xref ref-type="bibr" rid="c33">33</xref>, <xref ref-type="bibr" rid="c34">34</xref></sup> We show the capability of our method to track neurons with no specific tuning preference (<bold><italic><xref rid="figs16" ref-type="fig">Figure S16</xref></italic></bold>).</p>
<p>The method includes means to identify dataset pairs with very large drift. In our data, we can detect large drift because such datasets have very few reference units, and significantly different EMD cost (<xref rid="s7f" ref-type="sec">Sec. 8.6</xref>). For example, datasets 1 and 2 in animal AL036 have very few reference units compared to other datasets (see <bold><italic><xref rid="figs11" ref-type="fig">Figure S11</xref></italic></bold>, AL036). This observation is consistent with the overall relationship between the EMD cost and recovery rate (<bold><italic><xref rid="figs12" ref-type="fig">Figure S12</xref></italic></bold>). Datasets with higher cost tend to have lower unit recovery rate and higher variation in recovery rates. Therefore, these two datasets were excluded in the tracking analysis.</p>
<p>Our validation relies on identifying reference units. The reference unit definition has limitations. The similarity score is largely driven by PSTHs (<bold><italic><xref rid="fig6" ref-type="fig">Figure 6</xref></italic></bold>, <bold><italic><xref rid="figs11" ref-type="fig">Figure S11</xref></italic></bold>), the timing of stimulus triggered response, rather than vfp, the response selectivity. As a result, a single neuron can be highly correlated, i.e. similarity score greater than 1, with more than 20 other neurons. For example, in subject AL032 shank 2, one neuron on day 1 has 22 highly correlated neurons on day 2, 4 of which are also within the distance of 30μ<italic>m</italic>. Non-reference units may also have very similar visual responses: we note that 33 (5 putative neurons and 28 mixed neurons) out of 106 trackable neurons have a similarity score greater than 1 even for days with no reference unit assignment. Coincidentally similar visual responses could potentially contribute to inaccurate assignment of reference units and irregularity in trackable unit analysis. These errors would reduce the measured accuracy of the EMD matching method; since the accuracy is very high (<bold><italic><xref rid="fig4" ref-type="fig">Figure 4</xref></italic></bold>), the impact of mismatches is low.</p>
<p>We note that the ratio of reference units over KSgood units decreases as recordings are further separated in time (<bold><italic><xref rid="figs13" ref-type="fig">Figure S13</xref></italic></bold>). This reduction in fraction of reference units might be partially due to representational drift as well as the fact that the set of active neurons are slightly different in each recording. The visual fingerprint similarity of matched neurons decreased to 60% after 40 days (see reference 7 supplement).</p>
<p>We developed the new tracking algorithm based on an available visual cortex dataset, and used a prominent sorting algorithm (Kilosort 2.5) to spikesort the data. We had reference data to assess the success of the matching and tune parameters. Applying our algorithm in other brain areas and with other sorters may require parameter adjustment. Evaluation of the results in the absence of reference data requires a change to the fitting procedure.</p>
<p>The algorithm has only two parameters: the weighting factor ω that sets the relative weight of waveform distance vs. physical distance, and the z-distance threshold that selects matches that are likely correct. We found that recovery rate, and therefore accuracy, is insensitive to the value of ω for values larger than 1500, so this parameter does not require precise tuning. However, the false positive rate is strongly dependent on the choice of z-distance threshold.</p>
<p>When reference information (unit matches known from receptive fields or other data) is available, the procedure outlined in <xref rid="s7d" ref-type="sec">section 8.4</xref> can be followed. In that case, the distribution of z-distances of known pairs is fit to find the width of the distribution for correct matches. That parameter is then used in the fit of the z-distance distribution of all pairs to <bold><italic><xref rid="eqn3" ref-type="disp-formula">Equation 3</xref></italic></bold>. Integrating the distributions of correct and incorrect pairs yields the false positive rate vs. z-distance, allowing selection of a z-distance threshold for a target false positive rate.</p>
<p>In most cases, reference information is not available. However, the z-distance distributions for correct and incorrect pairs can still be estimated by fitting the distribution of all pairs. In section 8.4, <bold><italic><xref rid="figs9" ref-type="fig">Figure S9</xref></italic></bold> we show the results of fitting the z-distribution of all pairs without fixing the width of the distribution of correct matches. The result slightly underestimates this width, and the estimated false positive rate increases. This result is important because it suggests the accuracy estimate from this analysis will be conservative. We detail the procedure for fitting the z-distance distribution Methods section (Alg. 2).</p>
<p>As suggested in Dhawale et al.,<sup><xref ref-type="bibr" rid="c5">5</xref></sup> discontinuous recordings will have more false positives. Improving spike sorting and restricting the analysis to reliably sorted units will help decrease the false positive rate. Current spike sorting methods involve fitting many parameters. Due to the stochastic nature of template initialization, only around 60% to 70% units are found repeatedly in independently executed analysis passes. This leads to unpaired units which decreases EMD matching accuracy. Future users may consider limiting their analysis to the most reliably detected units for tracking; requiring consensus across analysis passes or sorters is a possible strategy. Finally, more frequent data acquisition during experiments will provide more intermediate stages for tracking and involves smaller drift between consecutive recordings.</p>
</sec>
<sec id="s4">
<label>4</label><title>Methods</title>
<p>Our neuron tracking algorithm uses the Earth Mover’s Distance (EMD) optimization algorithm. The minimized distance is a weighted combination of physical distance and ‘waveform distance’: the algorithm seeks to form pairs that are closest in space and have the most similar waveforms. We test the performance of the algorithm by comparing EMD matches to reference pairs determined from visual receptive fields (<xref rid="s4d" ref-type="sec">Sec. 4.4</xref>). We calculate two performance metrics. The ‘recovery rate’ is the percentage of reference units that are correctly matched by the EMD procedure. The ‘accuracy’ is the percentage of correctly matched reference units that pass the z-distance threshold (<bold><italic><xref rid="fig4" ref-type="fig">Figure 4</xref></italic></bold>a). ‘Putative units’ are units matched by the procedure which do not have reference receptive field information. ‘Chains’ are units that can be tracked across at least three consecutive datasets. The full procedure is summarized in <xref rid="alg1" ref-type="statement">Algorithm 1</xref>.</p>
<statement id="alg1">
<label>Algorithm 1</label>
<title>Neuron Matching Procedure</title>
<p><bold>Input</bold>: channel map, unit cluster label, cluster mean waveforms(with <italic>K</italic><sub><italic>loc</italic></sub> = 2 and <italic>K</italic><sub><italic>wf</italic></sub> = 5 rows and <italic>K</italic><sub><italic>col</italic></sub> = 2 columns of channels), and spike times</p>
<p><bold>Step 1</bold> Estimate unit locations</p>
<p>Estimate background amplitude for each unit
<table-wrap id="utbl1" orientation="portrait" position="float">
<graphic xlink:href="551724v4_utbl1.tif" mimetype="image" mime-subtype="tiff"/>
</table-wrap>
</p>
<p><bold>Step 3</bold> Between-session drift correction</p>
<p>Run the EMD with distances in physical and waveform space</p>
<p>Estimate z-distance mode of all matched pairs with Gaussian kernel fit Apply correction on physical distances of all units ε <italic>U</italic><sub>2</sub> ∶ <italic>z<sub>corr</sub></italic> = <italic>z</italic> − <italic>z</italic><sub><italic>mode</italic></sub></p>
<p><bold>Step 4</bold> Unit matching</p>
<p>Run the EMD with corrected physical distance and waveform metrics</p>
<p>Set z-distance threshold to select unit pairs likely to be the same neuron</p>
<p><bold>Output</bold>: cost <sup>∑</sup> <italic>d<sub>EMD</sub></italic>, unit assignments</p>
</statement>
<sec id="s4a">
<label>4.1</label><title>Algorithm</title>
<sec id="s4a1">
<label>4.1.1</label><title>Earth Mover’s Distance</title>
<p>The EMD is an optimization-based metric developed in the context of optimal transport and measuring distances between probability distributions. It frames the question as moving dirt, in our case, units from the first dataset, into holes, which here are the neural units in the second dataset. The distance between the “dirt” and the “holes” determines how the optimization program will prioritize a given match. Specifically, the EMD seeks to minimize the total work needed to move the dirt to the holes, i.e., neurons in day 1 to day 2, by solving for a minimum overall effort, the sum of distances.<sup><xref ref-type="bibr" rid="c30">30</xref>, <xref ref-type="bibr" rid="c31">31</xref></sup>
<disp-formula id="eqn4">
<graphic xlink:href="551724v4_eqn4.gif" mimetype="image" mime-subtype="gif"/>
</disp-formula></p>
<p>in which <italic>d</italic><sub><italic>loc</italic></sub> ∈  <italic>D</italic><sup>3</sup>  is the three-dimensional physical distance between a unit from the first dataset <italic>x</italic><sub><italic>i</italic></sub>, and a unit from the second dataset <italic>y</italic><sub><italic>k</italic></sub>. <italic>d</italic><sub><italic>wf</italic></sub> ∈ <italic>D</italic><sup>1</sup> is a scalar representing the similarity between waveforms of units <italic>x</italic><sub><italic>i</italic></sub> and <italic>y</italic><sub><italic>k</italic></sub>. ω is a weight parameter that was tuned to maximize the recovery rate of correctly matched reference units. F is the vector of matched objects between the two datasets (See <bold><italic><xref rid="figs14" ref-type="fig">Figure S14</xref></italic></bold> for details about selecting weight).</p>
<p>The EMD has three benefits:
<list list-type="bullet">
<list-item><p>It allows combining different types of information into the’distance matrix’ to characterize the features of units.</p></list-item>
<list-item><p>The EMD can detect homogeneous movement of units (<bold><italic><xref rid="fig2" ref-type="fig">Figure 2</xref></italic></bold>c), thus providing a way for rigid drift correction, as described in <xref rid="s4a2" ref-type="sec">section 4.1.3</xref>.</p></list-item>
<list-item><p>By minimizing overall distances, the EMD has tolerance for imperfect drift correction, error in the determination of unit positions, and possible non-rigid motion of the units.</p></list-item>
</list>
However, since the EMD is an optimization method with no assumptions about the biological properties of the data, it makes all possible matches. We therefore added a threshold on the permissible z-distance to select physically plausible matches. Supplement <bold><italic><xref rid="figs14" ref-type="fig">Figure S14</xref></italic></bold> shows the recovery rate change as a function of weight parameters to combine neuron location and waveform metrics into a distance matrix.</p>
</sec>
<sec id="s4a1a">
<label>4.1.2</label><title>Calculating the EMD distance metric</title>
<p>The unit locations are estimated by fitting 10 peak-to-peak (PTP) amplitudes from adjacent electrodes and the corresponding channel positions with a 1/R distance model.<sup><xref ref-type="bibr" rid="c32">32</xref></sup> Unlike Boussard, et al.,<sup><xref ref-type="bibr" rid="c32">32</xref></sup> we operate on the mean waveforms for each unit rather than individual spikes. We found using the mean waveform yields comparable results and saves significant computation time. Unit locations are three-dimensional coordinates estimated relative to the probe, where the location of the first electrode on the left column at the tip is considered the origin. The mean waveform is computed by averaging all the spike snippets assigned to the cluster by KS 2.5.</p>
<p>For 10 channels <italic>c</italic> ∈ <italic>C<sub>u</sub><sub>n</sub></italic>, find the location coordinates <italic>x</italic><sub><italic>u</italic></sub><sub><italic>n</italic></sub>, <italic>y</italic><sub><italic>u</italic></sub><sub><italic>n</italic></sub>, <italic>z</italic><sub><italic>u</italic></sub> that minimizes the difference between measured amplitudes <italic>V</italic><sub><italic>PTP</italic></sub> and amplitudes estimated with locations <inline-formula><inline-graphic xlink:href="551724v4_inline1.gif" mimetype="image" mime-subtype="gif"/></inline-formula>:
<disp-formula id="eqn5">
<graphic xlink:href="551724v4_eqn5.gif" mimetype="image" mime-subtype="gif"/>
</disp-formula></p>
<p>The locations are used to calculate the physical distance portion of the EMD distance.</p>
<p>For the waveform similarity metric, we want to describe the waveform characteristics of each unit with its spatial-temporal waveform at the channels capturing the largest signal. The waveform similarity metric between any two waveforms <italic>u</italic><sub><italic>n</italic>1</sub> and <italic>u</italic><sub><italic>n</italic>2</sub> in the two datasets is a scalar calculated as a normalized L2 metric (see Alg.1 Step 2) on the peak channels, namely the channel row with the highest amplitude and 5 rows above and below (a total of 22 channels). The resulting scalar reflects the ‘distance’ between the two units in the waveform space and is used to provide information about the waveform similarity of the units. It is used for between-session drift correction and neuron matching. <bold><italic><xref rid="fig1" ref-type="fig">Figure 1</xref></italic></bold>c shows an example waveform of a reference unit.</p>
</sec>
<sec id="s4a2">
<label>4.1.3</label><title>Between-session Drift Correction</title>
<p>Based on previous understanding of the drift in chronic implants, we assumed that the majority of drift occurs along the direction of the probe insertion, i.e. vertical z-direction. This rigid drift amount is estimated by the mode of the z-distance distribution of the EMD assigned units using a normal kernel density estimation implemented in MATLAB. We only included KSgood units.<sup><xref ref-type="bibr" rid="c16">16</xref></sup> The estimated drift is then applied back to correct both the reference units and the EMD distance matrix by adjusting the z coordinates of the units. A post-correction reference set is compared with the post-correction matching results for validation.</p>
</sec>
</sec>
<sec id="s4b">
<label>4.2</label><title>Determining Z Distance Threshold</title>
<p>Determining the z-distance threshold to achieve a target false positive rate requires estimating the widths of the z-distance distributions of correct and incorrect pairs. If reference data is available, the z-distance distribution of the known correct pairs should be fit to a folded Gaussian as described in 8.4. The width of the folded Gaussian, which is the error in determination of the z-positions of units, is then fixed in the fit of the z-distribution of all pairs found by the algorithm outlined in Algorithm <xref rid="fig4" ref-type="fig">4</xref>.<xref rid="fig1" ref-type="fig">1</xref>.<xref rid="fig1" ref-type="fig">1</xref>. If no reference data is available, the width of the distribution of correct pairs is determined by fitting the z-distance distribution of all pairs to <bold><italic><xref rid="eqn3" ref-type="disp-formula">Equation 3</xref></italic></bold> with the folded Gaussian width as one of the parameters. This procedure is detailed in <xref rid="alg2" ref-type="statement">Algorithm 2</xref>. We show two examples of model fitting without reference information in section <bold><italic><xref rid="figs9" ref-type="fig">Figure S9</xref></italic></bold>.</p>
<statement id="alg2">
<label>Algorithm 2</label>
<title>Determining an appropriate z distance threshold</title>
<p><bold>Input</bold>: Z distances of all matched units, target false positive rate, width σ of the z-distance distribution of correct pairs, if available</p>
<p><bold>Step 1</bold> Fit z distance distribution of all pairs to decompose into distributions of correct and incorrect pairs</p>
<p>Fit the z-distance distribution of all pairs to the sum of a folded Gaussian (for correct pairs) and an exponential (for incorrect pairs). If the width σ of the distribution of correct pairs is known from reference data, fix at that value. Otherwise, include in the fit parameters. (See <xref rid="s7d" ref-type="sec">section 8.4</xref> for details). The functional form is: <inline-formula><inline-graphic xlink:href="551724v4_inline2.gif" mimetype="image" mime-subtype="gif"/></inline-formula> Where: <italic>f</italic> = fraction of correct pairs; σ = width of the distribution of correct pairs; <italic>c</italic> = decay constant of distribution of incorrect pairs; <italic>d</italic> = amplitude normalization; and <inline-formula><inline-graphic xlink:href="551724v4_inline3.gif" mimetype="image" mime-subtype="gif"/></inline-formula>, the normalization factor of the folded Gaussian.</p>
<p><bold>Step 2</bold> Determine z threshold to achieve a target false positive rate</p>
<p>For Neuropixels 1.0 and 2.0 probes, the width of the z-distance distribution of correct matches (σ) should be &lt;10 μm; a larger width, or a very small value of the fraction of correct pairs suggests few or no correct matches. In this case, the EMD cost is likely to be large as well (See <bold><italic><xref rid="figs11" ref-type="fig">Figure S11</xref></italic></bold> Animal AL036 first two rows).</p>
<p>For a range of z values, integrate the z-distance distribution of incorrect pairs from 0 to z, and divide by the integral of the distribution of all pairs over that range. This generates the false positive rate vs. z-distance threshold, as shown in <bold><italic><xref rid="figs9" ref-type="fig">Figure S9</xref></italic></bold>. (Code available at: <ext-link ext-link-type="uri" xlink:href="https://github.com/AugustineY07/Neuron_Tracking/tree/main/Pipeline/Plot/Fit">https://github.com/AugustineY07/Neuron_Tracking/tree/main/Pipeline/Plot/Fit</ext-link>)</p>
<p><bold>Output</bold>: σ (uncertainty of position estimation), threshold at the target false positive rate</p>
</statement>
</sec>
<sec id="s4c">
<label>4.3</label><title>Dataset</title>
<p>The data used in this work are recordings collected from two chronically implanted NP 2.0 fourshank probes and one chronically implanted one-shank NP 2.0 probe in the visual cortex of three head fixed mice (<bold><italic><xref rid="fig7" ref-type="fig">Figure 7</xref></italic></bold>b, see Steinmetz et al.<sup><xref ref-type="bibr" rid="c7">7</xref></sup> for experiment details). The recordings were taken while 112 visual stimuli were shown from three surrounding screens (data from Steinmetz et al.<sup><xref ref-type="bibr" rid="c7">7</xref></sup> Supplement Section 1.2). The same bank of stimuli was presented five times, with order shuffled. The 4-shank probes had the 384 recording channels mapped to 96 sites on each shank.</p>
<fig id="fig7" position="float" orientation="portrait" fig-type="figure">
<label>Fig. 7:</label>
<caption><title>Summary of dataset:</title>
<p>a. The recording intervals for each animal. A black dash indicates one recording on that day. b. All tex V1 with a 720 μ<italic>m</italic> section of the probe containing 96 recording sites. The blue arrow indicates mples of visual fingerprint(vfp) and peri-stimulus time histogram(PSTH) from a high correlation (left shold (right column) correlation unit. Both vfp and PSTH values vary from [-1,1]. d. Kilosort-good and al AL032, including units from all four shanks.</p></caption>
<graphic xlink:href="551724v4_fig7.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
<p>We analyzed 65 recordings, each from one shank, collected in 17 sessions (5 sessions for animal AL031, 5 sessions for animal AL032, and 7 sessions for animal AL036). The time gap between recordings ranges from one day to 47 days (<bold><italic><xref rid="fig7" ref-type="fig">Figure 7</xref></italic></bold>a), with recording durations ranging from 1917 to 2522 seconds. The sample rate is 30kHz for all recordings. There are a total of 2958 KSgood units analyzed across all animals and shanks, with an average of 56 units per dataset (<bold><italic><xref rid="fig7" ref-type="fig">Figure 7</xref></italic></bold>d and <bold><italic><xref rid="figs15" ref-type="fig">Figure S15</xref></italic></bold>).</p>
</sec>
<sec id="s4d">
<label>4.4</label><title>Reference set</title>
<p>To track clusters across days, Steinmetz et al.<sup><xref ref-type="bibr" rid="c7">7</xref></sup> concatenated two recording sessions and took advantage of the within-recording drift correction feature of Kilosort 2.0 to extract spikes from the two days with a common set of templates. They first estimated the between session drift of each recording from the pattern of firing rate and amplitude on the probe and applied a position correction of an integer number of probe rows (15μ<italic>m</italic> for the probes used). Then two corrected recordings were concatenated and sorted as a single recording. This procedure ensured that the same templates are used to extract spikes across both recordings, so that putative matches are extracted with the same template. A unit from the first half of the recording is counted as the same neuron if its visual response is more similar to that from the same cluster in the second half of the recording than to the visual response of the physically nearest neighbor unit. Using this procedure and matching criteria, 93% of the matches were correct for recordings &lt; 16 days apart, and 85% were correct for recordings from 3-9 weeks (See Steinmetz et al.,<sup><xref ref-type="bibr" rid="c7">7</xref></sup> <xref rid="fig4" ref-type="fig">Fig. 4</xref>). In addition, although mean fingerprint similarity decreases for recordings separated by more than 16 days, this decline is only 40% for the same unit recorded from 40 days apart (see Steinmetz et al.<sup><xref ref-type="bibr" rid="c7">7</xref></sup> Supplement S3). This procedure, while successful in their setting, was limited to the use of integral row adjustments of the data for between-session drift correction and relied on a customized version of Kilosort 2.0. Although up to three recordings can be sorted together, they must come from recording sessions close in time. In addition, a separate spike sorting session needs to be performed for every pair of recordings to be matched, which is time consuming and introduces extra sorting uncertainty.</p>
<p>To find units with matched visual responses, we examine the visual response similarity across all possible pairs. The visual response similarity score follows Steinmetz et al.,<sup><xref ref-type="bibr" rid="c7">7</xref></sup> and consists of two measurements. 1) The peristimulus time histogram (PSTH), which is the histogram of the firing of a neuron across all presentations of all images, in a 1800 msec time window starting 400 msec before and ending 400 msec after the stimulus presentation. The PSTH is calculated by histrogramming spike times relative to stimulus on time for all stimuli, using 1 ms bins. This histogram is then smoothed with a Gaussian filter. 2) The visual fingerprint(vfp) is the average response of the neuron to each of the 112 images. The vfp is calculated by averaging the spike counts in response to each natural image from the stimulus onset to 1 second afterwards across 5 shuffled trials.</p>
<p>Following Steinmetz et al.,<sup><xref ref-type="bibr" rid="c7">7</xref></sup> the similarity score between two neurons is the sum of the correlation of the PSTH and the correlation of the vfp across two sessions. The two correlations have values in the range (-1,1), and the similarity score ranges from (-2, 2).</p>
<p>The pool of reference units is established with three criteria: 1) The visual response similarity score of the pair, as described above, is greater than 1 and their physical distance, both before and after drift correction, is smaller than 30μm. We impose the 30 μm threshold on both pre- and post-correction data because the drift is relatively small in our case, and we can reduce false positives by constraining the reference units to be in a smaller region without losing units. In general, one could apply the threshold only on corrected data (after drift correction). 2) A Kruskal-Wallis test is applied on all trials of the vfps to ensure the triggered response to the stimulus is significantly distinguishable from a flat line. 3) Select units from each recording that meet the good criteria in Kilosort. Kilosort assigns a label of either single-unit (good) or multi-unit (MUA) to all sorted clusters based on ISI violations.<sup><xref ref-type="bibr" rid="c16">16</xref></sup> This step aims to ensure included units are well separated. If there are multiple potential partners for a unit, the pair with the highest similarity score is selected as the reference unit. The complete pool of reference units includes comparisons of all pairs of recordings for each shank in each animal. The portion of units with qualified visual response ranges from 5% to 61%, depending on the time gap between datatets (<bold><italic><xref rid="figs13" ref-type="fig">Figure S13</xref></italic></bold>). Overall, these reference units made up 29% of all KSgood units (<bold><italic><xref rid="figs15" ref-type="fig">Figure S15</xref></italic></bold>) across all three animals in our dataset. <bold><italic><xref rid="fig7" ref-type="fig">Figure 7</xref></italic></bold>c shows examples of visual responses from a high similarity reference unit and a reference unit with similarity just above threshold.</p>
</sec>
</sec>
<sec id="s5">
<label>5</label><title>Code sharing</title>
<p>All code used can be accessed at: <ext-link ext-link-type="uri" xlink:href="https://github.com/AugustineY07/Neuron_Tracking">https://github.com/AugustineY07/Neuron_Tracking</ext-link>.</p>
</sec>
</body>
<back>
<ack>
<label>6</label><title>Acknowledgments</title>
<p>This work was supported supported in part by NIH grant U01 NS115587. We thank Claudia Böhm and Albert Lee for allowing us to use their data in <bold><italic><xref rid="figs9" ref-type="fig">Figure S9</xref></italic></bold>.</p>
</ack>
<sec id="s6">
<label>7</label><title>Declaration of interests</title>
<p>The authors declare no competing interests.</p>
</sec>
<sec id="s7">
<label>8</label><title>Supplement</title>
<sec id="s7a">
<label>8.1</label><title>Trackable units statistics</title>
<p>To show that trackable reference, putative, and mixed units are qualitatively similar, we summarized the median, maximum and minimum change of firing rate, visual receptive field, and location in the box plots in <bold><italic><xref rid="figs1" ref-type="fig">Figure S1</xref></italic></bold> to <bold><italic><xref rid="figs5" ref-type="fig">Figure S5</xref></italic></bold>. A Kruskal-Wallis test performed for each feature suggested no difference among the three groups (see <xref rid="s2d" ref-type="sec">Sec. 2.4</xref> for details).</p>
<fig id="figs1" position="float" orientation="portrait" fig-type="figure">
<label>Fig. S1:</label>
<caption><title>Distribution of waveform L2 similarity change per dataset for each neuron group and across all neurons.</title>
<p>Box plots ns, and 75% percentile. Whiskers at the ends of the box plot show maximum and minimum values. t comparisons, i.e. (number of units)×(number of datatsets - 1).</p></caption>
<graphic xlink:href="551724v4_figs1.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
<fig id="figs2" position="float" orientation="portrait" fig-type="figure">
<label>Fig. S2:</label>
<caption><p>Distributions of individual unit location changes over whole chains (top) and unit location changes between pairs of datasets (bottom), for each neuron group and across all neurons. Box plots indicate 25% percentile, medians, and 75% percentile. Whiskers at the ends of the box plot show maximum and minimum values. In the top plot, n and N are the number of units. In the bottom plot, n and N are the number of unit comparisons, i.e. (number of units)×(number of datatsets - 1).</p></caption>
<graphic xlink:href="551724v4_figs2.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
<fig id="figs3" position="float" orientation="portrait" fig-type="figure">
<label>Fig. S3:</label>
<caption><p>Distribution of firing rate fold change per dataset for each neuron group and across all neurons. Box plots indicate 25% percentile, medians, and 75% percentile. Whiskers at the ends of the box plot show maximum and minimum values. n and N represent the number of units.</p></caption>
<graphic xlink:href="551724v4_figs3.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
<fig id="figs4" position="float" orientation="portrait" fig-type="figure">
<label>Fig. S4:</label>
<caption><p>The visual fingerprint and PSTH change distributions per dataset for each neuron group and across all neurons. Box plots indicate 25% percentile, medians, and 75% percentile. Whiskers at the ends of the box plot show maximum and minimum values. n and N are the number of unit comparisons, i.e.(number of units)×(number of datatsets - 1).</p></caption>
<graphic xlink:href="551724v4_figs4.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
<fig id="figs5" position="float" orientation="portrait" fig-type="figure">
<label>Fig. S5:</label>
<caption><title>The similarity score distribution per dataset for each neuron group and across all neurons.</title>
<p>Box plots indicate 25% percentile, medians, and 75% percentile. Whiskers at the ends of the box plot show maximum and minimum values. n and N are the number of observations of the units, i.e. Σ<italic><sub>units</sub></italic> (observations of this unit)</p></caption>
<graphic xlink:href="551724v4_figs5.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
</sec>
<sec id="s7b">
<label>8.2</label><title>Similarity score heatmap</title>
<p>We identify reference pairs as units that are close in space (peak channels separated by &lt; 30μ<italic>m</italic>) and high similarity score (&gt;1). Multiple partners can meet these criteria due to oversplitting – these correspond to blocks of high scores in the heatmap. We only include a unit as a reference if its highest similarity score counterpart in the other dataset is within the 30μ<italic>m</italic> distance threshold.</p>
<fig id="figs6" position="float" orientation="portrait" fig-type="figure">
<label>Fig. S6:</label>
<caption><title>An example similarity score (vfp + PSTH) heatmap from animal AL032 shank 2 Kilosort-good units between day 1 and 2.</title>
<p>Each small square represents the similarity score (value range from [-2,2]) between one unit from day 1 and one unit from day 2. A warm colored square indicates a higher score. The clusters are ordered by their physical locations on the probe. There is a diagonal line with brighter color blocks, indicating that units with more similar visual responses across days tend to be physically close. This confirms our assumption that neurons are physically stable over time. Also notice that, on each column, there might be more than one bright block in the more distant clusters. We minimize the effect of distant units by constraining the feasible region during selection of reference units. There are also columns without bright yellow blocks; these units do not respond to the stimulus and are not included in the reference set.</p></caption>
<graphic xlink:href="551724v4_figs6.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
</sec>
<sec id="s7c">
<label>8.3</label><title>Pre- and post-drift correction reference unit counts</title>
<p>We showed that between-session drift correction improved yield of reference units.</p>
<fig id="figs7" position="float" orientation="portrait" fig-type="figure">
<label>Fig. S7:</label>
<caption><title>The effect of drift correction on reference unit yield for all three animals.</title>
<p>Note that drift correction improves the recovery rate for most cases; the degree of improvement is a function of the magnitude of the drift.</p></caption>
<graphic xlink:href="551724v4_figs7.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
</sec>
<sec id="s7d">
<label>8.4</label><title>Modeling the z-distance distribution for all units</title>
<p>As shown in <bold><italic><xref rid="fig4" ref-type="fig">Figure 4</xref></italic></bold>a, the z-distance distribution of reference pairs differs significantly from that of all pairs. To estimate the false positive rate for all pairs, we need to account for this difference. We cannot simply extrapolate from the measured false positive rate of the reference units. The difference arises from a bias in the selection of reference units: Because reference units must be detected in two datasets, they must be easily isolated. We created a simple model to determine an appropriate functional form to fit the z-distance distribution of all pairs and estimate the false positive rate.</p>
<p>Assume the following distributions:</p>
<list list-type="order">
<list-item><p>The z-distance distribution of all matched neurons, i.e. KSgood unit distribution, (Δ &gt; 0) is
<disp-formula id="ueqn1">
<graphic xlink:href="551724v4_ueqn1.gif" mimetype="image" mime-subtype="gif"/>
</disp-formula></p>
</list-item>
<list-item><p>The z-distance distribution of matched neurons that are true hits (<italic>H</italic>: correct match/hits) is
<disp-formula id="ueqn2">
<graphic xlink:href="551724v4_ueqn2.gif" mimetype="image" mime-subtype="gif"/>
</disp-formula></p>
</list-item>
<list-item><p>The z-distance distribution of false positive matched neurons is
<disp-formula id="ueqn3">
<graphic xlink:href="551724v4_ueqn3.gif" mimetype="image" mime-subtype="gif"/>
</disp-formula></p>
<p>Let f be the fraction of units with true hits, then the z-distance distribution for all units is:
<disp-formula id="eqn6">
<graphic xlink:href="551724v4_eqn6.gif" mimetype="image" mime-subtype="gif"/>
</disp-formula></p>
</list-item>
</list>
<p>To estimate the distribution of <italic>P</italic> (Δ ∣ <italic>H</italic>), we assume that drift correction works properly. In this case, the z shift between the two units of a reference pair, or any true hit, is due to the error in measuring the position of the unit. The distribution of Δ<italic>z</italic>, which is the absolute value of the z shift, is expected to be a folded Gaussian with μ = 0, and σ = 2*(error in measured z position).</p>
<p>To estimate the distribution of <italic>P</italic> (Δ ∣∼ <italic>H</italic>), we performed a Monte Carlo simulation. In the simulation, the number of units is 150, the average density of subject AL036. A fraction f will have real partners in the second dataset. The unit positions in each dataset have normally distributed errors with σ = 5μ<italic>m</italic>, matching the observed distribution of z-distance in the reference units.</p>
<p>To determine a range of values of f (fraction of true hits) that matches the real data, we can estimate probability of a hit in terms of probability of being a reference neuron <italic>P</italic> (<italic>R</italic>) using Bayes rule
<disp-formula id="ueqn4">
<graphic xlink:href="551724v4_ueqn4.gif" mimetype="image" mime-subtype="gif"/>
</disp-formula></p>
<p><italic>P</italic> (<italic>H</italic> ∣ <italic>R</italic>) can be estimated from the reference units recovery rate 0.86, and <italic>P</italic> (<italic>R</italic>) can be estimated from the ratio of reference units, which is 0.29. <italic>P</italic> (∼ <italic>R</italic>) = 1 − <italic>P</italic> (<italic>R</italic>) = 0.73. Then
<disp-formula id="eqn7">
<graphic xlink:href="551724v4_eqn7.gif" mimetype="image" mime-subtype="gif"/>
</disp-formula>
<disp-formula id="eqn8">
<graphic xlink:href="551724v4_eqn8.gif" mimetype="image" mime-subtype="gif"/>
</disp-formula></p>
<p>We modeled the distribution at values of f = 0.23, 0.5, 0.6, 0.7 and 0.96. For each value of f, we generate 500 datasets, and compile the z-distance distributions for H and ∼ <italic>H</italic>, from the EMD solution. From these simulations, we learned that the false positive distribution is well fit by an exponential decay. Therefore, the z-distance distribution for all units is the sum of the two, as shown in <bold><italic><xref rid="eqn3" ref-type="disp-formula">Equation 3</xref></italic></bold> and Alg. 2.</p>
<fig id="figs8" position="float" orientation="portrait" fig-type="figure">
<label>Fig. S8:</label>
<caption><p>Fits of z-distance distributions from the Monte Carlo simulations. The five panels correspond to: f = 0.23, 0.5, 0.6, 0.7 and 0.96.</p></caption>
<graphic xlink:href="551724v4_figs8.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
<p>To fit experimental data, we first fit the z-distance distribution of the reference units to obtain the width σ of the folded Gaussian in the first term of <bold><italic><xref rid="eqn3" ref-type="disp-formula">Equation 3</xref></italic></bold>. With σ fixed, we then fit the z-distance distribution of all KSGood units to <bold><italic><xref rid="eqn3" ref-type="disp-formula">Equation 3</xref></italic></bold> to obtain the width of the exponential and f. Then we can estimate the false positive rate by integrating <italic>P</italic> (Δ ∣ <italic>H</italic>) and <italic>P</italic> (Δ ∣∼ <italic>H</italic>) up to the z-distance threshold. The fraction of false positives as a function of z-distance threshold is shown in <bold><italic><xref rid="fig4" ref-type="fig">Figure 4</xref></italic></bold>a, in the bottom panel.</p>
<p>Finally, to test model fitting using no information from the reference units, we fit the same z-distance data allowing the width of the folded Gaussian to vary. <bold><italic><xref rid="figs9" ref-type="fig">Figure S9</xref></italic></bold>. Panels a and b show the distribution on the same dataset fit with and without fixing the folded Gaussian distribution width. The resulting false positive rate from the no-reference fit at threshold <italic>z</italic> = 10μ<italic>m</italic> is larger than than that from the fit using reference data, so the procedure gives a conservative estimate of the accuracy.</p>
<p>Panel c of <bold><italic><xref rid="figs9" ref-type="fig">Figure S9</xref></italic></bold> shows the model fit to data from an unrelated dataset acquired from mouse prefrontal cortex using a Neuropixels 1.0 probe.<sub>35</sub> The similar shape of the distribution and a 29% false positive rate suggest that this method can be generalized.</p>
<fig id="figs9" position="float" orientation="portrait" fig-type="figure">
<label>Fig. S9:</label>
<caption><p>z-distance distribution fit comparison: a. Distribution fit with 3 parameters, where the z-distribution for true hits is estimated from the reference units. The same as <xref rid="fig4" ref-type="fig">figure 4a</xref>. b. Distribution fit with 4 parameters, using no reference information. c. Distribution fit of a dataset in prefrontal cortex using Neuropixels 1.0, using no reference information.35</p></caption>
<graphic xlink:href="551724v4_figs9.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
</sec>
<sec id="s7e">
<label>8.5</label><title>Recovery rate vs. time between recordings</title>
<fig id="figs10" position="float" orientation="portrait" fig-type="figure">
<label>Fig. S10:</label>
<caption><title>The reference unit recovery rate for recordings spanning durations.</title>
<p>Each triangle represents the matching results of two datasets. Animal AL031 has 6 sets of matched units, with one outlier removed. Animal AL032 has 24 sets of matched units. Animal AL036 has 60 sets of matching. The recovery rate is lower for longer durations.</p></caption>
<graphic xlink:href="551724v4_figs10.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
</sec>
<sec id="s7f">
<label>8.6</label><title>Reference unit count and the EMD cost matrix</title>
<p>In animal AL036, there is a large decrease in the number of reference units after the second dataset, likely due to a large physical shift of the probe relative to the tissue. It is important to be able to detect such discontinuities to eliminate datasets from consideration. We find that the discontinuity can be detected in the EMD mean cost, location mean cost and waveform mean cost. The pairwise values for the costs are shown in <bold><italic><xref rid="figs11" ref-type="fig">Figure S11</xref></italic></bold>.</p>
<p>To show that days 1-2 (first two rows) are significantly different from days 3-9, we use the Mann-Whitney U Test. All three cost values show significant differences between the groups (EMD mean cost, reject H0, p = 6 × 10<sup>−7</sup>; location mean cost, reject H0, p = 6 × 10<sup>−5</sup>; waveform mean cost, reject H0, p = 5 × 10<sup>−7</sup>)). To show that days 3-9 come from the same distribution, we compare odd and and even rows using the same test. All three cost values show no significant difference between odd and even days (accept H0, p = 0.92).</p>
<fig id="figs11" position="float" orientation="portrait" fig-type="figure">
<label>Fig. S11:</label>
<caption><title>Reference unit counts and normalized EMD cost for each pair of datasets recorded by the same shank.</title>
<p>For animal AL036 (left), we excluded the first two datasets and all of their matching results (first two rows of each matrix on the left) based on the low reference unit counts. Following analysis on their matching EMD cost, location-only cost and waveform-only cost suggest a significant difference compared to the following days (datasets in the red rectangles). We infer that the first two datatsets were recorded from a different population than later days. The other matrices show similar information for animal AL032 for reference. To show the relative magnitude of EMD cost in related datasets versus unrelated datasets, we calculated the cost between unrelated datasets with similar unit count (AL032 shank 1 and AL036 shank 1: EMD cost = 78, location cost = 67, and waveform cost = 32). The EMD cost is between 70-80, much larger than those between related datasets (between 20-30).</p></caption>
<graphic xlink:href="551724v4_figs11.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
<p>Because days 1-2 are significantly different from 3-9, we eliminated them from our analysis.</p>
</sec>
<sec id="s7g">
<label>8.7</label><title>Recovery rate vs. the EMD cost</title>
<fig id="figs12" position="float" orientation="portrait" fig-type="figure">
<label>Fig. S12:</label>
<caption><p>The normalized EMD cost (unitless), z distance (<italic>μ<italic>m</italic></italic>), physical distance (<italic>μ<italic>m</italic></italic>), and waveform distance (unitless) and the corresponding recovery rate in pairwise matches of all to all pairs of recordings, on each shank. Each triangle represents the recovery rate in a pair of datasets. Animal AL031 has 6 sets of matching, with one outlier removed. Animal AL032 has 24 sets of matching. Animal AL036 has 60 sets of matched units. Overall, most of the datatsets with high recovery rates have per-unit EMD cost in the range 20-30. Note that the EMD cost is not predictive of recovery rate.</p></caption>
<graphic xlink:href="551724v4_figs12.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
</sec>
<sec id="s7h">
<label>8.8</label><title>Reference unit ratio</title>
<fig id="figs13" position="float" orientation="portrait" fig-type="figure">
<label>Fig. S13:</label>
<caption><p>The ratio of number of reference units to number of KSgood units decreases for pairs of datasets with larger time intervals. However, the variability of the number of reference units is generally large for all time intervals.</p></caption>
<graphic xlink:href="551724v4_figs13.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
</sec>
<sec id="s7i">
<label>8.9</label><title>Parameter tuning: L2-weight vs. Recovery rate</title>
<fig id="figs14" position="float" orientation="portrait" fig-type="figure">
<label>Fig. S14:</label>
<caption><p>We varied the weight <italic>ω</italic> in <bold><italic><xref rid="eqn4" ref-type="disp-formula">Equation 4</xref></italic></bold> used to combine the physical and waveform distances in increments of 500. The vertical line indicates weight = 1500, where the overall recovery rate = 86.29%. The maximum recovery rate = 87.68% occurs at weight = 3000. We chose weight = 1500 for all subsequent analysis.</p></caption>
<graphic xlink:href="551724v4_figs14.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
</sec>
<sec id="s7j">
<label>8.10</label><title>Reference unit counts</title>
<p>The number of KSgood units in each datatset and number of reference units between a later dataset and the first dataset in animals AL031 and AL032 are shown here.</p>
<fig id="figs15" position="float" orientation="portrait" fig-type="figure">
<label>Fig. S15:</label>
<caption><p>The Kilosort-good and reference unit counts for the animals AL031 and AL036, as shown for animal AL032 in <xref rid="fig5" ref-type="fig">Figure 5</xref>.</p></caption>
<graphic xlink:href="551724v4_figs15.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
</sec>
<sec id="s7k">
<label>8.11</label><title>Example reference and putative chains</title>
<fig id="figs16" position="float" orientation="portrait" fig-type="figure">
<label>Fig. S16:</label>
<caption><title>An example of reference chain.</title>
<p>a. Above: Firing rates of this neuron on each day. Below: Firing rate fractional change compared to the previous day. b. Visual response similarity (yellow line), PSTH correlation (orange line), and visual fingerprint correlation (blue line). The similarity score is the sum of vfp and PSTH. The dashed black line shows the threshold to be considered a reference unit. c. Spatial-temporal waveform of a trackable unit. Each pair of traces represent the waveform on a single channel. d. Estimated location of this unit on different days. Each colored dot represents a unit on one day. The orange squares represent the electrodes. e. The pairwise vfp and PSTH traces of this unit.</p></caption>
<graphic xlink:href="551724v4_figs16.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
<fig id="figs17" position="float" orientation="portrait" fig-type="figure">
<label>Fig. S17:</label>
<caption><title>An example of putative chain.</title>
<p>Order is the same as above.</p></caption>
<graphic xlink:href="551724v4_figs17.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
</sec>
</sec>
<ref-list>
<title>References</title>
<ref id="c1"><label>[1]</label><mixed-citation publication-type="journal"><string-name><surname>Carmena</surname> <given-names>JM</given-names></string-name>, <string-name><surname>Lebedev</surname> <given-names>MA</given-names></string-name>, <string-name><surname>Henriquez</surname> <given-names>CS</given-names></string-name>, <string-name><surname>Nicolelis</surname> <given-names>MAL.</given-names></string-name> <article-title>Stable Ensemble Performance with Single-Neuron Variability during Reaching Movements in Primates</article-title>. <source>J Neurosci</source>. <year>2005</year>;<volume>25</volume>:<fpage>10712</fpage>–<lpage>10716</lpage>. <pub-id pub-id-type="doi">10.1523/JNEUROSCI.2772-05.2005</pub-id>.</mixed-citation></ref>
<ref id="c2"><label>[2]</label><mixed-citation publication-type="journal"><string-name><surname>Huber</surname> <given-names>D</given-names></string-name>, <string-name><surname>Gutnisky</surname> <given-names>DA</given-names></string-name>, <string-name><surname>Peron</surname> <given-names>S</given-names></string-name>, <string-name><surname>O’Connor</surname> <given-names>DH</given-names></string-name>, <string-name><surname>Wiegert</surname> <given-names>JS</given-names></string-name>, <string-name><surname>Tian</surname> <given-names>L</given-names></string-name>, <etal>et al.</etal> <article-title>Multiple dynamic representations in the motor cortex during sensorimotor learning</article-title>. <source>Nature</source>. <year>2012</year>;<volume>484</volume>:<fpage>473</fpage>–<lpage>478</lpage>. <pub-id pub-id-type="doi">10.1038/nature11039</pub-id>.</mixed-citation></ref>
<ref id="c3"><label>[3]</label><mixed-citation publication-type="journal"><string-name><surname>Liberti</surname> <given-names>WA</given-names></string-name>, <string-name><surname>Markowitz</surname> <given-names>JE</given-names></string-name>, <string-name><surname>Perkins</surname> <given-names>LN</given-names></string-name>, <string-name><surname>Liberti</surname> <given-names>DC</given-names></string-name>, <string-name><surname>Leman</surname> <given-names>DP</given-names></string-name>, <string-name><surname>Guitchounts</surname> <given-names>G</given-names></string-name>, <etal>et al.</etal> <article-title>Unstable neurons underlie a stable learned behavior</article-title>. <source>Nat Neurosci</source>. <year>2016</year>;<volume>19</volume>:<fpage>1665</fpage>–<lpage>1671</lpage>. <pub-id pub-id-type="doi">10.1038/nn.4405</pub-id>.</mixed-citation></ref>
<ref id="c4"><label>[4]</label><mixed-citation publication-type="journal"><string-name><surname>Clopath</surname> <given-names>C</given-names></string-name>, <string-name><surname>Bonhoeffer</surname> <given-names>T</given-names></string-name>, <string-name><surname>Hübener</surname> <given-names>M</given-names></string-name>, <string-name><surname>Rose</surname> <given-names>T.</given-names></string-name> <article-title>Variance and invariance of neuronal long-term representations</article-title>. <source>Phil Trans R Soc</source>. <year>2017</year>;<volume>372</volume>. <pub-id pub-id-type="doi">10.1098/rstb.2016.0161</pub-id>.</mixed-citation></ref>
<ref id="c5"><label>[5]</label><mixed-citation publication-type="journal"><string-name><surname>Dhawale</surname> <given-names>AK</given-names></string-name>, <string-name><surname>Poddar</surname> <given-names>R</given-names></string-name>, <string-name><surname>Wolff</surname> <given-names>SB</given-names></string-name>, <string-name><surname>Normand</surname> <given-names>VA</given-names></string-name>, <string-name><surname>Kopelowitz</surname> <given-names>E</given-names></string-name>, <string-name><surname>Ölveczky</surname> <given-names>BP.</given-names></string-name> <article-title>Automated long-term recording and analysis of neural activity in behaving animals</article-title>. <source>eLife</source>. <year>2017</year>;<volume>6</volume>:<fpage>e27702</fpage>. <pub-id pub-id-type="doi">10.7554/eLife.27702</pub-id>.</mixed-citation></ref>
<ref id="c6"><label>[6]</label><mixed-citation publication-type="journal"><string-name><surname>Jensen</surname> <given-names>KT</given-names></string-name>, <string-name><surname>Harpaz</surname> <given-names>NK</given-names></string-name>, <string-name><surname>Dhawale</surname> <given-names>AK</given-names></string-name>, <string-name><surname>Wolff</surname> <given-names>SBE</given-names></string-name>, <string-name><surname>Ölveczky</surname> <given-names>BP.</given-names></string-name> <article-title>Long-term stability of single neuron activity in the motor system</article-title>. <source>Nat Neurosci</source>. <year>2022</year>;<volume>25</volume>:<fpage>1664</fpage>–<lpage>1674</lpage>. <pub-id pub-id-type="doi">10.1038/s41593-022-01194-3</pub-id>.</mixed-citation></ref>
<ref id="c7"><label>[7]</label><mixed-citation publication-type="journal"><string-name><surname>Steinmetz</surname> <given-names>NA</given-names></string-name>, <string-name><surname>Aydin</surname> <given-names>C</given-names></string-name>, <string-name><surname>Lebedeva</surname> <given-names>A</given-names></string-name>, <string-name><surname>Okun</surname> <given-names>M</given-names></string-name>, <string-name><surname>Pachitariu</surname> <given-names>M</given-names></string-name>, <string-name><surname>Bauza</surname> <given-names>M</given-names></string-name>, <etal>et al.</etal> <article-title>Neuropixels 2.0: A miniaturized high-density probe for stable, long-term brain recordings</article-title>. <source>Science</source>. <year>2021</year>;<volume>372</volume>:<fpage>eabf4588</fpage>. <pub-id pub-id-type="doi">10.1126/science.abf4588</pub-id>.</mixed-citation></ref>
<ref id="c8"><label>[8]</label><mixed-citation publication-type="journal"><string-name><surname>Luo</surname> <given-names>TZ</given-names></string-name>, <string-name><surname>Bondy</surname> <given-names>AG</given-names></string-name>, <string-name><surname>Gupta</surname> <given-names>D</given-names></string-name>, <string-name><surname>Elliott</surname> <given-names>VA</given-names></string-name>, <string-name><surname>Kopec</surname> <given-names>CD</given-names></string-name>, <string-name><surname>Brody</surname> <given-names>CD.</given-names></string-name> <article-title>An approach for long-term, multi-probe Neuropixels recordings in unrestrained rats</article-title>. <source>eLife</source>. <year>2020</year>;<volume>9</volume>. <pub-id pub-id-type="doi">10.7554/eLife.59716</pub-id>.</mixed-citation></ref>
<ref id="c9"><label>[9]</label><mixed-citation publication-type="journal"><string-name><surname>Harris</surname> <given-names>KD</given-names></string-name>, <string-name><surname>Quiroga</surname> <given-names>RQ</given-names></string-name>, <string-name><surname>Freeman</surname> <given-names>J</given-names></string-name>, <string-name><surname>Smith</surname> <given-names>SL.</given-names></string-name> <article-title>Improving data quality in neuronal population recordings</article-title>. <source>Nature Neuroscience</source>. <year>2016</year>;<volume>19</volume>:<fpage>1165</fpage>–<lpage>1174</lpage>. <pub-id pub-id-type="doi">10.1038/nn.4365</pub-id>.</mixed-citation></ref>
<ref id="c10"><label>[10]</label><mixed-citation publication-type="journal"><string-name><surname>Buzsáki</surname> <given-names>G.</given-names></string-name> <article-title>Large-scale recording of neuronal ensembles</article-title>. <source>Nature Neuroscience</source>. <year>2004</year>;<volume>7</volume>:<fpage>446</fpage>–<lpage>451</lpage>. <pub-id pub-id-type="doi">10.1038/nn1233</pub-id>.</mixed-citation></ref>
<ref id="c11"><label>[11]</label><mixed-citation publication-type="journal"><string-name><surname>Brown</surname> <given-names>EN</given-names></string-name>, <string-name><surname>Kass</surname> <given-names>RE</given-names></string-name>, <string-name><surname>Mitra</surname> <given-names>PP.</given-names></string-name> <article-title>Multiple neural spike train data analysis: state-of-the-art and future challenges</article-title>. <source>Nature Neuroscience</source>. <year>2004</year>;<volume>7</volume>:<fpage>456</fpage>–<lpage>461</lpage>. <pub-id pub-id-type="doi">10.1038/nn1228</pub-id>.</mixed-citation></ref>
<ref id="c12"><label>[12]</label><mixed-citation publication-type="journal"><string-name><surname>Quiroga</surname> <given-names>RQ</given-names></string-name>, <string-name><surname>Panzeri</surname> <given-names>S.</given-names></string-name> <article-title>Extracting information from neuronal populations: information theory and decoding approaches</article-title>. <source>Nature Reviews Neuroscience</source>. <year>2009</year>;<volume>10</volume>:<fpage>173</fpage>–<lpage>185</lpage>. <pub-id pub-id-type="doi">10.1038/nrn2578</pub-id>.</mixed-citation></ref>
<ref id="c13"><label>[13]</label><mixed-citation publication-type="journal"><string-name><surname>Harris</surname> <given-names>KD.</given-names></string-name> <article-title>Neural signatures of cell assembly organization</article-title>. <source>Nature Reviews Neuroscience</source>. <year>2005</year>;<volume>6</volume>:<fpage>399</fpage>–<lpage>407</lpage>. <pub-id pub-id-type="doi">10.1038/nrn1669</pub-id>.</mixed-citation></ref>
<ref id="c14"><label>[14]</label><mixed-citation publication-type="journal"><string-name><surname>Quiroga</surname> <given-names>RQ</given-names></string-name>, <string-name><surname>Nadasdy</surname> <given-names>Z</given-names></string-name>, <string-name><surname>Ben-Shaul</surname> <given-names>Y.</given-names></string-name> <article-title>Unsupervised Spike Detection and Sorting with Wavelets and Superparamagnetic Clustering</article-title>. <source>Neural Computation</source>. <year>2004</year>;<volume>16</volume>:<fpage>1661</fpage>–<lpage>1687</lpage>. <pub-id pub-id-type="doi">10.1162/089976604774201631</pub-id>.</mixed-citation></ref>
<ref id="c15"><label>[15]</label><mixed-citation publication-type="journal"><string-name><surname>Chah</surname> <given-names>E</given-names></string-name>, <string-name><surname>Hok</surname> <given-names>V</given-names></string-name>, <string-name><surname>Della-Chiesa</surname> <given-names>A</given-names></string-name>, <string-name><surname>Miller</surname> <given-names>JJH</given-names></string-name>, <string-name><surname>O’Mara</surname> <given-names>SM</given-names></string-name>, <etal>et al</etal>,. <article-title>Automated spike sorting algo-rithmbased on Laplacian eigenmaps and k -means clustering</article-title>. <source>J Neural Eng</source>. <year>2011</year>;<volume>8</volume>:<fpage>016006</fpage>. <pub-id pub-id-type="doi">10.1088/1741-2560/8/1/016006</pub-id>.</mixed-citation></ref>
<ref id="c16"><label>[16]</label><mixed-citation publication-type="web"><string-name><surname>Pachitariu</surname> <given-names>M</given-names></string-name>, <string-name><surname>Steinmetz</surname> <given-names>N</given-names></string-name>, <string-name><surname>Kadir</surname> <given-names>S</given-names></string-name>, <string-name><surname>Carandini</surname> <given-names>M</given-names></string-name>, <string-name><surname>Harris</surname> <given-names>KD.</given-names></string-name>: <article-title>Kilosort: realtime spike-sorting for extracellular electrophysiology with hundreds of channels</article-title>. Preprint at <ext-link ext-link-type="uri" xlink:href="https://www.biorxiv.org/content/10.1101/061481v1">https://www.biorxiv.org/content/10.1101/061481v1</ext-link>.</mixed-citation></ref>
<ref id="c17"><label>[17]</label><mixed-citation publication-type="journal"><string-name><surname>Carlson</surname> <given-names>D</given-names></string-name>, <string-name><surname>Carin</surname> <given-names>L.</given-names></string-name> <article-title>Continuing progress of spike sorting in the era of big data</article-title>. <source>Current Opinion in Neurobiology</source>. <year>2019</year>;<volume>55</volume>:<fpage>90</fpage>–<lpage>96</lpage>. <pub-id pub-id-type="doi">10.1016/j.conb.2019.02.007</pub-id>.</mixed-citation></ref>
<ref id="c18"><label>[18]</label><mixed-citation publication-type="journal"><string-name><surname>Jun</surname> <given-names>JJ</given-names></string-name>, <string-name><surname>Steinmetz</surname> <given-names>NA</given-names></string-name>, <string-name><surname>Siegle</surname> <given-names>JH</given-names></string-name>, <string-name><surname>Denman</surname> <given-names>DJ</given-names></string-name>, <string-name><surname>Bauza</surname> <given-names>M</given-names></string-name>, <string-name><surname>Barbarits</surname> <given-names>B</given-names></string-name>, <etal>et al.</etal> <article-title>Fully integrated silicon probes for high-density recording of neural activity</article-title>. <source>Nature</source>. <year>2017</year>;<volume>551</volume>:<fpage>232</fpage>–<lpage>236</lpage>. <pub-id pub-id-type="doi">10.1038/nature24636</pub-id>.</mixed-citation></ref>
<ref id="c19"><label>[19]</label><mixed-citation publication-type="journal"><string-name><surname>Hall</surname> <given-names>NJ</given-names></string-name>, <string-name><surname>Herzfeld</surname> <given-names>DJ</given-names></string-name>, <string-name><surname>Lisberger</surname> <given-names>SG.</given-names></string-name> <article-title>Evaluation and resolution of many challenges of neural spike sorting: a new sorter</article-title>. <source>Journal of Neurophysiology</source>. <year>2021</year>;<volume>126</volume>:<fpage>2065</fpage>–<lpage>2090</lpage>. <pub-id pub-id-type="doi">10.1152/jn.00047.2021</pub-id>.</mixed-citation></ref>
<ref id="c20"><label>[20]</label><mixed-citation publication-type="journal"><string-name><surname>Tolias</surname> <given-names>AS</given-names></string-name>, <string-name><surname>Ecker</surname> <given-names>AS</given-names></string-name>, <string-name><surname>Siapas</surname> <given-names>AG</given-names></string-name>, <string-name><surname>Hoenselaar</surname> <given-names>A</given-names></string-name>, <string-name><surname>Keliris</surname> <given-names>GA</given-names></string-name>, <string-name><surname>Logothetis</surname> <given-names>NK.</given-names></string-name> <article-title>Recording Chronically From the Same Neurons in Awake, Behaving Primates</article-title>. <source>Journal of Neurophysiology</source>. <year>2007</year>;<volume>98</volume>:<fpage>3780</fpage>–<lpage>3790</lpage>. <pub-id pub-id-type="doi">10.1152/jn.00260.2007</pub-id>.</mixed-citation></ref>
<ref id="c21"><label>[21]</label><mixed-citation publication-type="journal"><string-name><surname>Swindale</surname> <given-names>NV</given-names></string-name>, <string-name><surname>Spacek</surname> <given-names>MA.</given-names></string-name> <article-title>Spike sorting for polytrodes: a divide and conquer approach</article-title>. <source>Frontiers in Systems Neuroscience</source>. <year>2014</year>;<volume>8</volume>. <pub-id pub-id-type="doi">10.3389/fnsys.2014.00006</pub-id>.</mixed-citation></ref>
<ref id="c22"><label>[22]</label><mixed-citation publication-type="journal"><string-name><surname>Bar-Hillel</surname> <given-names>A</given-names></string-name>, <string-name><surname>Spiro</surname> <given-names>A</given-names></string-name>, <string-name><surname>Stark</surname> <given-names>E.</given-names></string-name> <article-title>Spike sorting: Bayesian clustering of non-stationary data</article-title>. <source>Journal of Neuroscience Methods</source>. <year>2006</year>;<volume>157</volume>:<fpage>303</fpage>–<lpage>316</lpage>. <pub-id pub-id-type="doi">10.1016/j.jneumeth.2006.04.023</pub-id>.</mixed-citation></ref>
<ref id="c23"><label>[23]</label><mixed-citation publication-type="web"><string-name><surname>Lee</surname> <given-names>J</given-names></string-name>, <string-name><surname>Mitelut</surname> <given-names>C</given-names></string-name>, <string-name><surname>Shokri</surname> <given-names>H</given-names></string-name>, <string-name><surname>Kinsella</surname> <given-names>I</given-names></string-name>, <string-name><surname>Dethe</surname> <given-names>N</given-names></string-name>, <string-name><surname>Wu</surname> <given-names>S</given-names></string-name>, <etal>et al.</etal> <article-title>YASS: Yet Another Spike Sorter applied to large-scale multi-electrode array recordings in primate retina</article-title>. <year>2020</year>;p <fpage>10712</fpage>–<lpage>10716</lpage>. Preprint at <ext-link ext-link-type="uri" xlink:href="https://www.biorxiv.org/content/10.1101/2020.03.18.997924v1">https://www.biorxiv.org/content/10.1101/2020.03.18.997924v1</ext-link>. <pub-id pub-id-type="doi">10.1101/2020.03.18.997924</pub-id>.</mixed-citation></ref>
<ref id="c24"><label>[24]</label><mixed-citation publication-type="journal"><string-name><surname>Chung</surname> <given-names>JE</given-names></string-name>, <string-name><surname>Magland</surname> <given-names>JF</given-names></string-name>, <string-name><surname>Barnett</surname> <given-names>AH</given-names></string-name>, <string-name><surname>Tolosa</surname> <given-names>VM</given-names></string-name>, <string-name><surname>Tooker</surname> <given-names>AC</given-names></string-name>, <string-name><surname>Lee</surname> <given-names>KY</given-names></string-name>, <etal>et al.</etal> <article-title>A Fully Automated Approach to Spike Sorting</article-title>. <source>Neuron</source>. <year>2017</year>;<volume>95</volume>:<fpage>1381</fpage>–<lpage>1394.e6</lpage>. <pub-id pub-id-type="doi">10.1016/j.neuron.2017.08.030</pub-id>.</mixed-citation></ref>
<ref id="c25"><label>[25]</label><mixed-citation publication-type="journal"><string-name><surname>Chung</surname> <given-names>JE</given-names></string-name>, <string-name><surname>Joo</surname> <given-names>HR</given-names></string-name>, <string-name><surname>Fan</surname> <given-names>JL</given-names></string-name>, <string-name><surname>Liu</surname> <given-names>DF</given-names></string-name>, <string-name><surname>Barnett</surname> <given-names>AH</given-names></string-name>, <string-name><surname>Chen</surname> <given-names>S</given-names></string-name>, <etal>et al.</etal> <article-title>High-Density, Long-Lasting, and Multiregion Electrophysiological Recordings Using Polymer Electrode Arrays</article-title>. <source>Neuron</source>. <year>2019</year>;<volume>101</volume>:<fpage>21</fpage>–<lpage>31.e5</lpage>. <pub-id pub-id-type="doi">10.1016/j.neuron.2018.11.002</pub-id>.</mixed-citation></ref>
<ref id="c26"><label>[26]</label><mixed-citation publication-type="journal"><string-name><surname>Vasil’eva</surname> <given-names>LN</given-names></string-name>, <string-name><surname>Badakva</surname> <given-names>AM</given-names></string-name>, <string-name><surname>Miller</surname> <given-names>NV</given-names></string-name>, <string-name><surname>Zobova</surname> <given-names>LN</given-names></string-name>, <string-name><surname>Roshchin</surname> <given-names>VY</given-names></string-name>, <string-name><surname>Bondar</surname> <given-names>IV.</given-names></string-name> <article-title>Long-Term Recording of Single Neurons and Criteria for Assessment</article-title>. <source>Neuroscience and Behavioral Physiology</source>. <year>2016</year>;<volume>46</volume>:<fpage>264</fpage>–<lpage>269</lpage>. <pub-id pub-id-type="doi">10.1007/s11055-016-0227-8</pub-id>.</mixed-citation></ref>
<ref id="c27"><label>[27]</label><mixed-citation publication-type="journal"><string-name><surname>Rokni</surname> <given-names>U</given-names></string-name>, <string-name><surname>Richardson</surname> <given-names>AG</given-names></string-name>, <string-name><surname>Bizzi</surname> <given-names>E</given-names></string-name>, <string-name><surname>Seung</surname> <given-names>HS.</given-names></string-name> <article-title>Motor Learning with Unstable Neural Representations</article-title>. <source>Neuron</source>. <year>2007</year>;<volume>54</volume>:<fpage>653</fpage>–<lpage>666</lpage>. <pub-id pub-id-type="doi">10.1016/j.neuron.2007.04.030</pub-id>.</mixed-citation></ref>
<ref id="c28"><label>[28]</label><mixed-citation publication-type="journal"><string-name><surname>Lewicki</surname> <given-names>MS.</given-names></string-name> <article-title>A review of methods for spike sorting: the detection and classification of neural action potentials Michael S Lewicki</article-title>. <source>Network</source>. <year>1998</year>;<volume>9</volume>:<fpage>R53</fpage>–<lpage>78</lpage>. <pub-id pub-id-type="doi">10.1088/0954-898X/9/4/001</pub-id>.</mixed-citation></ref>
<ref id="c29"><label>[29]</label><mixed-citation publication-type="web"><string-name><surname>Colonell</surname> <given-names>J.</given-names></string-name>: <article-title>ecephys spike sorting</article-title>. <source>GitHub</source>. <ext-link ext-link-type="uri" xlink:href="https://github.com/jenniferColonell/ecephys_spike_sorting">https://github.com/jenniferColonell/ecephys_spike_sorting</ext-link>.</mixed-citation></ref>
<ref id="c30"><label>[30]</label><mixed-citation publication-type="other"><string-name><surname>Cohen</surname> <given-names>S.</given-names></string-name> <article-title>FINDING COLOR AND SHAPE PATTERNS IN IMAGES</article-title> (<publisher-name>Stanford University, Palo Alto</publisher-name>, <year>1999</year>). <source>1999</source>;.</mixed-citation></ref>
<ref id="c31"><label>[31]</label><mixed-citation publication-type="journal"><string-name><surname>Bertrand</surname> <given-names>NP</given-names></string-name>, <string-name><surname>Charles</surname> <given-names>AS</given-names></string-name>, <string-name><surname>Lee</surname> <given-names>J</given-names></string-name>, <string-name><surname>Dunn</surname> <given-names>PB</given-names></string-name>, <string-name><surname>Rozell</surname> <given-names>CJ.</given-names></string-name> <article-title>Efficient Tracking of Sparse Signals via an Earth Mover’s Distance Dynamics Regularizer</article-title>. <source>IEEE</source>. <year>2020</year>;<volume>27</volume>:<fpage>1120</fpage>–<lpage>1124</lpage>. <pub-id pub-id-type="doi">10.1109/LSP.2020.3001760</pub-id>.</mixed-citation></ref>
<ref id="c32"><label>[32]</label><mixed-citation publication-type="journal"><string-name><surname>Boussard</surname> <given-names>J</given-names></string-name>, <string-name><surname>Varol</surname> <given-names>E</given-names></string-name>, <string-name><surname>Lee</surname> <given-names>HD</given-names></string-name>, <string-name><surname>Dethe</surname> <given-names>N</given-names></string-name>, <string-name><surname>Paninski</surname> <given-names>L.</given-names></string-name> <article-title>Three-dimensional spike localization and improved motion correction for Neuropixels recordings</article-title>. <source>NeurIPS Proceedings</source>. <year>2021</year>;<pub-id pub-id-type="doi">10.1101/2021.11.05.467503</pub-id>.</mixed-citation></ref>
<ref id="c33"><label>[33]</label><mixed-citation publication-type="journal"><string-name><surname>Sauerbrei</surname> <given-names>BA</given-names></string-name>, <string-name><surname>Guo</surname> <given-names>JZ</given-names></string-name>, <string-name><surname>Cohen</surname> <given-names>JD</given-names></string-name>, <string-name><surname>Mischiati</surname> <given-names>M</given-names></string-name>, <string-name><surname>Guo</surname> <given-names>W</given-names></string-name>, <string-name><surname>Kabra</surname> <given-names>M</given-names></string-name>, <etal>et al.</etal> <article-title>Cortical pattern generation during dexterous movement is input-driven</article-title>. <source>Nature</source>. <year>2020</year>;<volume>577</volume>:<fpage>386</fpage>–<lpage>391</lpage>. <pub-id pub-id-type="doi">10.1038/s41586-019-1869-9</pub-id>.</mixed-citation></ref>
<ref id="c34"><label>[34]</label><mixed-citation publication-type="journal"><string-name><surname>Stringer</surname> <given-names>C</given-names></string-name>, <string-name><surname>Pachitariu</surname> <given-names>M</given-names></string-name>, <string-name><surname>Steinmetz</surname> <given-names>N</given-names></string-name>, <string-name><surname>Carandini</surname> <given-names>M</given-names></string-name>, <string-name><surname>Harris</surname> <given-names>KD.</given-names></string-name> <article-title>High-dimensional geometry of population responses in visual cortex</article-title>. <source>Nature</source>. <year>2019</year>;<volume>571</volume>:<fpage>361</fpage>–<lpage>365</lpage>. <pub-id pub-id-type="doi">10.1038/s41586-019-1346-5</pub-id>.</mixed-citation></ref>
<ref id="c35"><label>[35]</label><mixed-citation publication-type="web"><string-name><surname>Böhm</surname> <given-names>C</given-names></string-name>, <string-name><surname>Lee</surname> <given-names>AK.</given-names></string-name>: <article-title>Functional specialization and structured representations for space and time in prefrontal cortex</article-title>. Preprint at <ext-link ext-link-type="uri" xlink:href="https://www.biorxiv.org/content/10.1101/2023.01.16.524214v1">https://www.biorxiv.org/content/10.1101/2023.01.16.524214v1</ext-link>.</mixed-citation></ref>
</ref-list>
</back>
<sub-article id="sa0" article-type="editor-report">
<front-stub>
<article-id pub-id-type="doi">10.7554/eLife.92495.2.sa2</article-id>
<title-group>
<article-title>eLife Assessment</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<name>
<surname>Peyrache</surname>
<given-names>Adrien</given-names>
</name>
<role specific-use="editor">Reviewing Editor</role>
<aff>
<institution-wrap>
<institution>McGill University</institution>
</institution-wrap>
<city>Montreal</city>
<country>Canada</country>
</aff>
</contrib>
</contrib-group>
<kwd-group kwd-group-type="evidence-strength">
<kwd>Convincing</kwd>
</kwd-group>
<kwd-group kwd-group-type="claim-importance">
<kwd>Important</kwd>
</kwd-group>
</front-stub>
<body>
<p>This <bold>important</bold> study proposes a new method for tracking neurons recorded with Neuropixel electrodes across days. The methods and the strength of the evidence are <bold>convincing</bold>, but the authors do not address whether their approach can be generalized to other brain areas, species, behaviors, or tools. Overall, this method will be potentially of interest to many neuroscientists who want to study long-term activity changes of individual neurons in the brain.</p>
</body>
</sub-article>
<sub-article id="sa1" article-type="referee-report">
<front-stub>
<article-id pub-id-type="doi">10.7554/eLife.92495.2.sa1</article-id>
<title-group>
<article-title>Reviewer #1 (Public Review):</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<anonymous/>
<role specific-use="referee">Reviewer</role>
</contrib>
</contrib-group>
</front-stub>
<body>
<p>Neurons are not static-their activity patterns change as the result of learning, aging, and disease. Reliable tracking of activity from individual neurons across long time periods would enable studies of these important dynamics. For this reason, the authors' efforts to track electrophysiological activity across days without relying on matching neural receptive fields (which can change due to learning, aging, and disease) is very important.</p>
<p>By utilizing the tightly-spaced electrodes on Neuropixels probes, they are able to measure the physical distance and the waveform shape 'distance' between sorted units recorded on different days. To tune the matching algorithm and to validate the results, they used the visual receptive fields of neurons in the mouse visual cortex (which tend to change little over time) as ground truth. Their approach performs quite well, with a high proportion of neurons accurately matched across multiple weeks.</p>
<p>This suggests that the method may be useable in other cases where the receptive fields can't be used as ground truth to validate the tracking. This potential extendibility to tougher applications is where this approach holds the most promise. However, the study only looks at one brain area (visual cortex), in one species (mouse), using one type of spike sorter (Kilosort), and one type of behavioral prep (head-fixed). While the authors suggest methods to generalize their technique to other experimental conditions, no validation of those generalizations was done using data from different experimental conditions. Anyone using this method under different conditions would therefore need to perform such validation themselves.</p>
</body>
</sub-article>
<sub-article id="sa2" article-type="referee-report">
<front-stub>
<article-id pub-id-type="doi">10.7554/eLife.92495.2.sa0</article-id>
<title-group>
<article-title>Reviewer #2 (Public Review):</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<anonymous/>
<role specific-use="referee">Reviewer</role>
</contrib>
</contrib-group>
</front-stub>
<body>
<p>The manuscript presents a method for tracking neurons recorded with neuropixels across days, based on the matching of cells' spatial layouts and spike waveforms at the population level. The method is tested on neuropixel recordings of the visual cortex carried over 47 days, with the similarity in visual receptive fields used to verify the matches in cell identity.</p>
<p>This is an important tool as electrophysiological recordings have been notoriously limited in terms of tracking individual neuron's fate over time, unlike imaging approaches. The method is generally sound and properly tested but I think some clarifications would be helpful regarding the implementation of the method and some of the results.</p>
<p>(1) Page 6: I am not sure I understand the point of the imposed drift and how the value of 12µm is chosen.</p>
<p>
Is it that various values of imposed drift are tried, the EMDs computed to produce histograms as in Fig2c, values of rigid drifts estimated based on the histogram modes, and then the value associated with minimum cost selected? The corresponding manuscript section would need some clarification regarding this aspect.</p>
<p>(2) The EMD is based on the linear sum, with identical weight, of cell distance and waveform similarity measures. How performance is affected from using a different weighting of the 2 measures (for instance, using only cell distance and no waveform similarity)? It is common that spike waveforms associated to a given neuron appear different on different channels of silicon probes (i.e. the spike waveform changes depending the position of recording sites relative to the neuron), so I wonder if that feature is helping or potentially impeding the tracking.</p>
<p>(3) Fig.5: I assume the dots are representing time gaps for which cell tracking is estimated. The 3 different groups of colors correspond to the 3 mice used. For a given mouse, I would expect to always see 3 dots (for ref, putative and mixed) for a given tracking gap. However, for mouse AL036 for instance, at tracking duration of 8 days, a dot is visible for mixed but not for ref and putative. How come this is happening?</p>
<p>(4) Matched visual responses are measured by the sum of correlation of visual fingerprints, which are vectors of cells' average firing rate across visual stimuli, and correlation of PSTHs, which are implemented over all visual stimuli combined. I believe that some information is lost from combining all stimuli in the implementation of PSTHs (assuming that PSTHs show specificity to individual visual stimuli). The authors might consider, as alternative measure of matched visual responses, a correlation of the vector concatenations of all stimulus PSTHs. Such simpler measure would contain both visual fingerprint and PSTH information, and would not lose the information of PSTH specificity across visual stimuli.</p>
<p>2nd revision</p>
<p>(1) From reading the authors' response, I could understand several of the points I had previously missed. I still think that some part of the results are not straightforward to understand, the way it is written. Adding a few introductory sentences to the paragraphs (for instance the one related to my previous point #1) would really help the reader comprehend this important work.</p>
<p>(2) Following on my point #2, the w value used is 1500 and the recovery rate doesn't seems to reach a peak but rather a plateau for larger w values. From such large w value and the absence of a downward trend for increasing values, it would seem that only the 'waveform distance' matter and that the 'location distance' doesn't contribute much to the EMD distance. Is this correct?</p>
</body>
</sub-article>
<sub-article id="sa3" article-type="author-comment">
<front-stub>
<article-id pub-id-type="doi">10.7554/eLife.92495.2.sa3</article-id>
<title-group>
<article-title>Author Response</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<name>
<surname>Yuan</surname>
<given-names>Augustine(Xiaoran)</given-names>
</name>
<role specific-use="author">Author</role>
</contrib>
<contrib contrib-type="author">
<name>
<surname>Colonell</surname>
<given-names>Jennifer</given-names>
</name>
<role specific-use="author">Author</role>
</contrib>
<contrib contrib-type="author">
<name>
<surname>Lebedeva</surname>
<given-names>Anna</given-names>
</name>
<role specific-use="author">Author</role>
</contrib>
<contrib contrib-type="author">
<name>
<surname>Okun</surname>
<given-names>Michael</given-names>
</name>
<role specific-use="author">Author</role>
</contrib>
<contrib contrib-type="author">
<name>
<surname>Charles</surname>
<given-names>Adam S.</given-names>
</name>
<role specific-use="author">Author</role>
</contrib>
<contrib contrib-type="author">
<name>
<surname>Harris</surname>
<given-names>Timothy D.</given-names>
</name>
<role specific-use="author">Author</role>
<contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-6289-4439</contrib-id></contrib>
</contrib-group>
</front-stub>
<body>
<p>The following is the authors’ response to the original reviews.</p>
<p>Reviewer #1, in both the public review and recommendations to authors, raises the important question of generalizability of the new technique to other brain areas, to analysis with sorters other than Kilosort, and in the absence of reference data. Specifically, how can experimenters working in brain areas other than visual cortex understand if the tracking is functioning, and set the parameters in the tracking pipeline.</p>
<p>We agree that generalizability of the tracking procedure is a serious issue, especially with respect to other brain areas with varying degrees of measured waveform preservation over time. As the number of potential recording conditions is combinatorial to experimentally test, we instead address these issues in the manuscript by providing a general prescription for interpreting the distribution of vertical distances of matched pairs that can be used for data from any recording using any spike-sorter (Methods section 4.2, Supplement section 8.4, figure S9, paragraphs 7-10 of the Discussion section). This extension of the method allows users to estimate the matching success in the context of their own data, even in the absence of reference data. To address the concern of overfitting, we have also added discussion covering adjustment of the two parameters in the procedure (the relative weight of waveform distance vs. physical distance, and the threshold for accepting matches as real) to the Discussion section.</p>
<p>Reviewer #2 suggested clarification of the following points in the public review. We answer those here and have also clarified these points in the main text where appropriate.</p>
<disp-quote content-type="editor-comment">
<p>(1) What is the purpose of testing the drift correction with imposed drift (Figure 2, page 6 in the original manuscript), and how the value was chosen?</p>
</disp-quote>
<p>To test the ability of EMD to detect substantial drift, we need examples that resemble experimental data, including error in fit unit positions and units with no correct matches. We chose to create these examples by taking waveform and position sets from real data with modest drift, and adding a fixed shift to one dataset. The value of 12 um in the figure is arbitrary, simply an example in the range of real drift. These tests allow us to demonstrate the success of EMD for detection of drift in real data.</p>
<disp-quote content-type="editor-comment">
<p>(2) How is performance affected by using a different weighting of the 2 measures (physical distance and waveform distance) in the EMD?</p>
</disp-quote>
<p>Recovery rate (number of reference units successfully matched in EMD) vs weighting of the waveform distance is shown in Supplement section 8.10. Recovery rate increases with low values of waveform weighting, leveling off at a value of 1500. We selected that inflection point for the analysis in this paper, to avoid coincidental matching of physically distant units with similar waveforms.</p>
<disp-quote content-type="editor-comment">
<p>(3) Should the intervals measured in the survival plot in Figure 5 be identical for the three different classes of tracked neurons?</p>
</disp-quote>
<p>The plot includes all chains of tracked neurons, which can start on arbitrary days in the set of all recordings (see the definition of chains in section 2.4). As a result, the gaps between days, which determine where there is a point on the plot, can be different for the three sets of neurons (reference, putative, and mixed). We have added a comment to the Figure 5 caption to ensure this is clear.</p>
<disp-quote content-type="editor-comment">
<p>(4) Would other metrics of the similarity of visual responses work better?</p>
</disp-quote>
<p>The similarity metric we use was adopted from the original paper using this data (reference 7). We chose to use the same metric both to take advantage of the original authors’ expertise about the data and allow for reasonable comparison of the new technique to theirs. It is correct that this similarity metric alone does not allow for unique matching (see Discussion and Supplement section 8.2). However, the agreement of EMD with reference pairs determined from the combination of position and visual response similarity is very high, suggesting there are few incorrect reference pairs. Any incorrect reference pairs cause an underestimate of the tracking accuracy.</p>
<disp-quote content-type="editor-comment">
<p>(5) Add a definition of ROC.</p>
</disp-quote>
<p>Added this definition to the text.</p>
<disp-quote content-type="editor-comment">
<p><bold>Reviewer #1 Recommendation to authors:</bold></p>
<p>The main text needs proofreading.</p>
</disp-quote>
<p>We agree that the manuscript needed more thorough proofreading, and we have made corrections of typos and minor language errors throughout.</p>
<p>Additional comment from the authors:</p>
<p>Since the posting of this manuscript, another method for tracking neurons has been introduced:</p>
<p>Enny H. van Beest, Célian Bimbard, Julie M. J. Fabre, Flóra Takács, Philip Coen, Anna Lebedeva, Kenneth Harris, Matteo Carandini, Tracking neurons across days with high-density probes, bioRxiv 2023.10.12.562040; doi: <ext-link ext-link-type="uri" xlink:href="https://doi.org/10.1101/2023.10.12.562040">https://doi.org/10.1101/2023.10.12.562040</ext-link></p>
</body>
</sub-article>
</article>