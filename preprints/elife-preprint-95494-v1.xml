<?xml version="1.0" ?><!DOCTYPE article PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Archiving and Interchange DTD v1.3 20210610//EN"  "JATS-archivearticle1-mathml3.dtd"><article xmlns:ali="http://www.niso.org/schemas/ali/1.0/" xmlns:xlink="http://www.w3.org/1999/xlink" article-type="research-article" dtd-version="1.3" xml:lang="en">
<front>
<journal-meta>
<journal-id journal-id-type="nlm-ta">elife</journal-id>
<journal-id journal-id-type="publisher-id">eLife</journal-id>
<journal-title-group>
<journal-title>eLife</journal-title>
</journal-title-group>
<issn publication-format="electronic" pub-type="epub">2050-084X</issn>
<publisher>
<publisher-name>eLife Sciences Publications, Ltd</publisher-name>
</publisher>
</journal-meta>
<article-meta>
<article-id pub-id-type="publisher-id">95494</article-id>
<article-id pub-id-type="doi">10.7554/eLife.95494</article-id>
<article-id pub-id-type="doi" specific-use="version">10.7554/eLife.95494.1</article-id>
<article-version-alternatives>
<article-version article-version-type="publication-state">reviewed preprint</article-version>
<article-version article-version-type="preprint-version">1.1</article-version>
</article-version-alternatives>
<article-categories>
<subj-group subj-group-type="heading">
<subject>Immunology and Inflammation</subject>
</subj-group>
<subj-group subj-group-type="heading">
<subject>Computational and Systems Biology</subject>
</subj-group>
</article-categories>
<title-group>
<article-title>ImmCellTyper: an integrated computational pipeline for systematic mining of Mass Cytometry data to assist deep immune profiling</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author" corresp="yes" equal-contrib="yes">
<contrib-id contrib-id-type="orcid">http://orcid.org/0009-0001-7102-7556</contrib-id>
<name>
<surname>Sun</surname>
<given-names>Jing</given-names>
</name>
<xref ref-type="aff" rid="a1">1</xref>
<xref ref-type="author-notes" rid="n1">*</xref>
<xref ref-type="corresp" rid="cor1">∼</xref>
</contrib>
<contrib contrib-type="author" equal-contrib="yes">
<contrib-id contrib-id-type="orcid">http://orcid.org/0009-0001-7318-5996</contrib-id>
<name>
<surname>Choy</surname>
<given-names>Desmond</given-names>
</name>
<xref ref-type="aff" rid="a3">3</xref>
<xref ref-type="author-notes" rid="n1">*</xref>
</contrib>
<contrib contrib-type="author">
<name>
<surname>Sompairac</surname>
<given-names>Nicolas</given-names>
</name>
<xref ref-type="aff" rid="a3">3</xref>
</contrib>
<contrib contrib-type="author">
<name>
<surname>Jamshidi</surname>
<given-names>Shirin</given-names>
</name>
<xref ref-type="aff" rid="a3">3</xref>
</contrib>
<contrib contrib-type="author">
<contrib-id contrib-id-type="orcid">http://orcid.org/0000-0003-3042-2792</contrib-id>
<name>
<surname>Mishto</surname>
<given-names>Michele</given-names>
</name>
<xref ref-type="aff" rid="a1">1</xref>
<xref ref-type="aff" rid="a2">2</xref>
</contrib>
<contrib contrib-type="author" corresp="yes">
<contrib-id contrib-id-type="orcid">http://orcid.org/0000-0002-0347-4207</contrib-id>
<name>
<surname>Kordasti</surname>
<given-names>Shahram</given-names>
</name>
<xref ref-type="aff" rid="a3">3</xref>
<xref ref-type="aff" rid="a4">4</xref>
<xref ref-type="aff" rid="a5">5</xref>
<xref ref-type="corresp" rid="cor1">∼</xref>
</contrib>
<aff id="a1"><label>1</label><institution>Centre for Inflammation Biology and Cancer Immunology &amp; Peter Gorer Department of Immunobiology, King’s College London</institution>, SE1 1UL London, <country>United Kingdom</country></aff>
<aff id="a2"><label>2</label><institution>Research group of Molecular Immunology, Francis Crick Institute</institution>, NW1 1AT London, <country>United Kingdom</country></aff>
<aff id="a3"><label>3</label><institution>School of Cancer and Pharmaceutical Sciences, King’s College London</institution>, London, <country>United Kingdom</country></aff>
<aff id="a4"><label>4</label><institution>Haematology Department, Guy’s Hospital</institution>, London, <country>United Kingdom</country></aff>
<aff id="a5"><label>5</label><institution>Department of Clinical and Molecular Sciences, Università Politecnica delle Marche</institution>, Ancona, <country>Italy</country></aff>
</contrib-group>
<contrib-group content-type="section">
<contrib contrib-type="editor">
<name>
<surname>Hong</surname>
<given-names>Seunghee</given-names>
</name>
<role>Reviewing Editor</role>
<aff>
<institution-wrap>
<institution>Yonsei University</institution>
</institution-wrap>
<city>Seoul</city>
<country>Republic of Korea</country>
</aff>
</contrib>
<contrib contrib-type="senior_editor">
<name>
<surname>Rath</surname>
<given-names>Satyajit</given-names>
</name>
<role>Senior Editor</role>
<aff>
<institution-wrap>
<institution>Indian Institute of Science Education and Research (IISER)</institution>
</institution-wrap>
<city>Pune</city>
<country>India</country>
</aff>
</contrib>
</contrib-group>
<author-notes>
<corresp id="cor1"><label>∼</label>corresponding authors, Jing Sun: <email>jing.1.sun@kcl.ac.uk</email>, Shahram Kordasti: <email>shahram.kordasti@kcl.ac.uk</email></corresp>
<fn id="n1" fn-type="equal"><label>*</label><p>These authors contribute equally to this research work</p></fn>
</author-notes>
<pub-date date-type="original-publication" iso-8601-date="2024-04-05">
<day>05</day>
<month>04</month>
<year>2024</year>
</pub-date>
<volume>13</volume>
<elocation-id>RP95494</elocation-id>
<history>
<date date-type="sent-for-review" iso-8601-date="2024-01-16">
<day>16</day>
<month>01</month>
<year>2024</year>
</date>
</history>
<pub-history>
<event>
<event-desc>Preprint posted</event-desc>
<date date-type="preprint" iso-8601-date="2024-01-17">
<day>17</day>
<month>01</month>
<year>2024</year>
</date>
<self-uri content-type="preprint" xlink:href="https://doi.org/10.1101/2024.01.15.575790"/>
</event>
</pub-history>
<permissions>
<copyright-statement>© 2024, Sun et al</copyright-statement>
<copyright-year>2024</copyright-year>
<copyright-holder>Sun et al</copyright-holder>
<ali:free_to_read/>
<license xlink:href="https://creativecommons.org/licenses/by/4.0/">
<ali:license_ref>https://creativecommons.org/licenses/by/4.0/</ali:license_ref>
<license-p>This article is distributed under the terms of the <ext-link ext-link-type="uri" xlink:href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution License</ext-link>, which permits unrestricted use and redistribution provided that the original author and source are credited.</license-p>
</license>
</permissions>
<self-uri content-type="pdf" xlink:href="elife-preprint-95494-v1.pdf"/>
<abstract>
<title>Abstract</title>
<p>Mass cytometry, also known as Cytometry by time-of-flight (CyTOF), is a cutting-edge high-dimensional technology for profiling marker expression at the single-cell level. This technology significantly advances clinical research in immune monitoring and the interrogation of immune cell populations. Nevertheless, the vast amount of data generated by CyTOF poses a daunting challenge for analysis. To address this, we describe ImmCellTyper (<ext-link ext-link-type="uri" xlink:href="https://github.com/JingAnyaSun/ImmCellTyper">https://github.com/JingAnyaSun/ImmCellTyper</ext-link>), a novel and robust toolkit designed for CyTOF data analysis. The analytical framework incorporates an in-house developed semi-supervised clustering tool named BinaryClust, which first characterises main cell lineages, followed by in-depth interrogation for population of interest using unsupervised methods. BinaryClust was benchmarked with existing clustering tools and demonstrated superior accuracy and speed across two datasets comprising around 4 million cells, performing as good as manual gating by human experts. Furthermore, this computational pipeline provides a variety of visualization and analytical tools spanning from quality control to differential analysis, which can be tailored to user’s specific needs, aiming to provide a one-stop solution for CyTOF data analysis. The general workflow consists of five key steps: 1) Batch effect evaluation and correction, 2) Data quality control and pre-processing, 3) Main cell lineage characterisation and quantification, 4) Extraction and in-depth investigation of cell type of interest; 5) Differential analysis of cell abundance and functional marker expression (supporting multiple study groups). Overall, ImmCellTyper integrates expert’s biological knowledge in a semi-supervised fashion to accurately deconvolute well-defined main cell lineages, while also preserving the potential of unsupervised approaches to discover novel cell subsets and providing a user-friendly toolset to remove the analytical barrier for high-dimensional immune profiling.</p>
</abstract>

</article-meta>
<notes>
<notes notes-type="competing-interest-statement">
<title>Competing Interest Statement</title><p>The authors have declared no competing interest.</p></notes>
</notes>
</front>
<body>
<sec id="s1">
<title>Introduction</title>
<p>Mass cytometry or cytometry by time-of-flight (CyTOF) is a powerful high-throughput single-cell technology which employs stable elemental isotopes, as the same manner of fluorophores, to detect cellular proteins of interest. This approach successfully tackles the panel multiplex challenges faced by traditional flow cytometry due to spectral overlap and permits simultaneous measurement of over 40 parameters on millions of cells. To date, CyTOF has been widely applied in basic and translational medical research, such as deep immunophenotyping and characterisation of novel refined cell subsets, immune monitoring of cell-adoptive therapy, and dissecting cell subpopulations from heterogeneous tumour samples (Spitzer and Nolan). Nonetheless, the advantages of CyTOF come with the problem of handling high-dimensional dataset. Traditional gating strategy for flow cytometry, while still serving as the ‘gold standard’ for cell population identification in cytometry data, may not be an optimal option for CyTOF data due to its high-dimensional settings. The high-parametric resolution in CyTOF, aimed at revealing previously undiscovered cell subpopulations, leads to a significant increase in the complexity of gating schemas and hierarchical depth, which makes manual gating extremely labour intensive and time-consuming (Kimball et al.). Therefore, effective computational toolkits and pipelines are entailed for CyTOF data mining and analysis.</p>
<p>Efforts have been directed toward developing means of clustering algorithms to deconvolute a pool of live cell mixture into distinct cell populations, which facilitates CyTOF data analysis. For instance, unsupervised methods, which include flowSOM(Van Gassen et al.), Phenograph(Levine et al.), X-shift(Samusik et al.), spade(Qiu et al.), and DensVM(Becher et al.) etc., often combine with dimension reduction techniques like t-SNE(<xref ref-type="bibr" rid="c29">van der Maaten and Hinton, 2008</xref>), UMAP(<xref ref-type="bibr" rid="c20">McInnes and Healy, 2018</xref>), PCA etc., and require manual annotation of each cluster based on the marker expression patterns indicated by heatmaps. This approach works well to analyse populations in a data-driven manner, with all files concatenated and analysed all at once. Compared to manual gating, it has advantages in terms of convenience, efficiency, and relative unbiasedness from biological preconception, facilitating the detection of novel cell phenotypes for deep phenotyping. However, the unsupervised approaches are not always ideal and suitable for cytometry data. Mathematical clustering does not necessarily have biological meaning, leading to occasional inaccuracies. And several benchmarking studies suggested that the accuracy for these unsupervised tools may not be optimal(Liu et al.). Additionally, the technical uncertainty of results produced by different clustering approaches remains a conundrum. Even for the same unsupervised method, the discrepancy among different runs without setting a seed, reduces the reproducibility and may cause confusion, particularly for biologists with limited computational knowledge. Moreover, manual validation is also essential, as biological annotation is the inevitable step to provide biological relevant labels for the clusters. However, this process can be time-consuming and subjective, hindering the automation of pipelines. This problem is particularly pronounced for a large marker panel and samples with high heterogeneity, resulting in a higher number of clusters that need to be annotated.</p>
<p>Advances in artificial intelligence have accelerated the development of alternative clustering methods in a supervised manner for cell type inference. These methods consider the ‘ground truth’ or prior knowledge about the marker expression of each given cell types to automatically label each cell. Currently, a couple of semi-automatic methods have been developed, such as Linear Discriminant Analysis(LDA)(Abdelaal et al.), DGCyTOF(<xref ref-type="bibr" rid="c9">Cheng et al., 2022</xref>), CyAnno(<xref ref-type="bibr" rid="c11">Kaushik et al., 2021</xref>), DeepCyTOF(<xref ref-type="bibr" rid="c15">Li et al., 2017</xref>), Automated Cell-type Discovery and Classification (ACDC) (Lee et al.) and Semi-supervised Category Identification and Assignment(SCINA) (Zhang et al.) etc. ACDC(Lee <italic>et al</italic>.) and SCINA (Zhang <italic>et al</italic>.) use a matrix of pre-defined markers for each cell type to annotate the clusters showing the same signature. These methods assume that markers are either expressed or not expressed (binary), which limits their ability to distinguish cell subtypes with similar phenotypes, particularly non-canonical cell types that cannot be easily separated linearly. Alternatively, DeepCyTOF and LDA use a maker expression matrix extracted from manually gated cell types as a training dataset to build a machine learning model for cell type prediction. This approach has higher precision and accuracy compared with aforementioned methods(Liu <italic>et al</italic>.).</p>
<p>Nonetheless, it can be labour intensive for preparation of the training set manually. Also, these methods are limited in their ability to predict novel cell subsets beyond the pre-gated set of cell types and lack a systematic and comprehensive way to assign the cells which were not identifiable under any of the gated cell types. New solutions have emerged with algorithms such as DGCyTOF(<xref ref-type="bibr" rid="c9">Cheng <italic>et al</italic>., 2022</xref>) and CyAnno(<xref ref-type="bibr" rid="c11">Kaushik <italic>et al</italic>., 2021</xref>), the former adopts a deep learning classification combined with hierarchical stable-clustering methods and an iteration calibration system to identify known cell types and assign novel subsets; while CyAnno is based on a machine-learning framework which allows the integrative modelling of both ‘gated’ and ‘ungated’ cells. Both methods have demonstrated high accuracy in their test datasets, but unfortunately are not widely used by the research community, possibly due to the issue for the hassle of training data preparation, the lack of user-friendliness and implementation challenges for bench researchers.</p>
<p>To address the common drawbacks of current semi-supervised and unsupervised clustering algorithms and preserve their strengths in discovering both canonical and non-canonical cell subsets respectively, we propose a strategy implemented in ImmCellTyper for cell classification named BinaryClust. By considering biologists’ prior biological knowledge and interpretation for canonical cell clusters in a semi-supervised manner, BinaryClust first automatically characterises the main cell lineages in a fast and accurate way. Subsequently, it extracts specific cell types of interest for further clustering using unsupervised algorithms to identify cell subsets including previously unreported non-conventional population. In addition, this R-implemented pipeline takes advantage of SingleCellExperiment class for data management, providing an easy-to-use and organized systematic workflow of CyTOF data handling. The whole pipeline includes quality control and batch effect correction, which helps to effectively pool datasets from different batches, and ensures the robustness for downstream analysis. Meanwhile, modules like dimension reduction, semi-supervised and unsupervised clustering (flowSOM and Phenograph), interactive data visualisation, and statistical testing for complex study design were also incorporated in this pipeline. Compared with existing integrated computational workflow, such as CATALYST(<xref ref-type="bibr" rid="c21">Nowicka et al., 2017</xref>), CapX(Marsh-Wakefield et al.), Cytofkit(<xref ref-type="bibr" rid="c8">Chen et al., 2016</xref>) and ImmunoCluster(<xref ref-type="bibr" rid="c23">Opzoomer et al., 2021</xref>) which was developed and maintained by our team, this recently developed toolkit advanced further on coherence, functionality and user-friendliness. Overall, this approach has the potential to facilitate and smooth the investigation of CyTOF-based research.</p>
</sec>
<sec id="s2">
<title>Results</title>
<sec id="s2a">
<title>BinaryClust is comparable with manual gating in quantifying the abundances of main cell lineages</title>
<p>The core concept for BinaryClust is depicted in <xref rid="fig1" ref-type="fig">Figure1</xref>, where a simple user-designed cell type marker expression matrix is required and serves as a reference to characterise the main cell lineages, with positive markers indicated in ‘+’, negative markers in ‘-’, and irrelevant markers in ‘A’. K-means(k=2) will be applied to divide the positive and negative cell population of each marker, then align it to the reference table to infer main cell types. This is followed by the extraction of population-of-interest for downstream clustering using unsupervised methods for subpopulation discovery.</p>
<fig id="fig1" position="float" orientation="portrait" fig-type="figure">
<label>Figure 1</label>
<caption><p>Schematic diagram of BinaryClust method. Semi-supervised classification is first performed on selected markers in the user-defined marker expression matrix to classify and annotate major cell types. Population-of-interest can be further extracted and explored using unsupervised clustering methods followed by differential analysis. Figure was generated by BioRender (<ext-link ext-link-type="uri" xlink:href="https://www.biorender.com/">https://www.biorender.com/</ext-link>).</p></caption>
<graphic xlink:href="575790v1_fig1.tif" mimetype="image" mime-subtype="tiff"/>
<permissions>
<copyright-statement>© 2024, BioRender Inc</copyright-statement>
<copyright-year>2024</copyright-year>
<copyright-holder>BioRender Inc</copyright-holder>
<license><license-p>Any parts of this image created with <ext-link ext-link-type="uri" xlink:href="https://www.biorender.com/">BioRender</ext-link> are not made available under the same license as the Reviewed Preprint, and are © 2024, BioRender Inc.</license-p></license>
</permissions></fig>
<p>To assess the performance of the automated cell type classification and prediction, we generated a test CyTOF dataset using peripheral blood mononuclear cell (PBMC) samples from seven patients with myeloproliferative neoplasm (MPN) and two healthy donors, employing a 37-marker deep immunophenotyping panel (<xref rid="tbls1" ref-type="table">Supplementary Table 1</xref>). Manual gating was performed by two independent experts which identified seven main cell lineages. These results act as the reference for evaluating the computer-aided methods. The hierarchical sequential gating strategy was explicitly illustrated in <xref rid="figs1" ref-type="fig">Supplementary Figure 1</xref>. We evaluated the agreement between manual gating results and BinaryClust results regarding cell frequencies of each population. The mean value was calculated from manual gating results of two experts to compare with BinaryClust-generated results using Pearson correlation analysis. As shown in <xref rid="fig2" ref-type="fig">Figure2A</xref>, the two methods exhibit a strong correlation with coefficient(R<sup>2</sup>) equals to 1,1,0.99,0.96,0.96,0.99,0.99 for CD4 T cells, CD8 T cells, dendritic cells, NK cells, monocytes, and gamma delta T cells, respectively (all P &lt;0.0001). And most of the data points remain close to the line of equality (red line, R<sup>2</sup>=1), indicating a high degree of agreement. Meanwhile, the Bland-Altman plots in <xref rid="fig2" ref-type="fig">Figure 2B</xref> also suggest no consistent bias of manual gating versus BinaryClust across all the identified cell types. The good performance of BinaryClust was further validated in the influenza dataset published by our group (Alimam et al.), which contains FCS files from 11 individuals with 6 main immune cell types detected, the average F-measure and ARI reached 0.98 and 0.91 respectively (<xref rid="figs2" ref-type="fig">Supplementary Figure2A-B</xref>).</p>
<fig id="fig2" position="float" orientation="portrait" fig-type="figure">
<label>Figure 2</label>
<caption><p>Agreement evaluation comparing manual gating and BinaryClust in MPN cohort(n=9). Manual gating of B cells, CD4 T cells, CD8 T cells, dendritic cells, NK cells, monocytes and gamma delta T cells were performed by two independent experts using Cytobank, and mean values of the population percentages were calculated to compare with BinaryClust results. Each dot represents one patient sample. (A) Scatter plot showing the correlation between the two methods, with the red line indicating perfect agreement (correlation coefficient = 1); (B) Bland-Altman plots of the two measurement methods among all the cell populations, with the black line suggesting the mean observed difference and red dotted lines indicating limits of agreement (1.96 x standard deviations).</p></caption>
<graphic xlink:href="575790v1_fig2.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
</sec>
<sec id="s2b">
<title>BinaryClust achieves high accuracy and speed compared with flowSOM and LDA</title>
<p>To further evaluate BinaryClust’s performance, we compared it with the well-performing unsupervised algorithm flowSOM and supervised classifier Linear discriminant analysis (LDA). FlowSOM was run on the same MPN dataset with k value set as 20, followed by manual annotation and cluster merging to identify the same cell populations as in manual gating and BinaryClust. The cell frequencies derived from BinaryClust, flowSOM, and manual gating (expert1 and expert2) were compared using interaction plot (<xref rid="fig3" ref-type="fig">Figure 3</xref>). We observed that BinaryClust remains consistent with manual gating (all P&gt;0.05), whereas flowSOM identified significantly less Gamma Delta T cells and dendritic cells (P&lt;0.001 and P=0.006, respectively) compared with the other three measurements. We also increased the initial k value to 40 to improve accuracy the accuracy by over clustering then merging clusters (ref). We found that the average frequency for Gamma Delta T cells and dendritic cells increased to 1.5% and 4.65% respectively but still remained significantly different (P&lt;0.05) from the other two methods. It is also interesting to see that although the same gating strategy was applied, different experts obtained results with slight variation despite no statistical significance. The same findings were confirmed using boxplot as shown in <xref rid="figs3" ref-type="fig">Supplementary Figure 3</xref>.</p>
<fig id="fig3" position="float" orientation="portrait" fig-type="figure">
<label>Figure 3</label>
<caption><p>Comparison of manual gating (manual1 and manual2), BinaryClust and flowSOM clustering results in MPN cohort(n=9). Interaction plots showing the individual measurement (percentage) of each study participant with indicated colors by different methods across main cell lineages (B cells, CD8 T cells, Gamma Delta T cells, NK cells, Dendritic cells, monocytes and CD4 T cells).</p></caption>
<graphic xlink:href="575790v1_fig3.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
<p>Subsequently, LDA was also tested on the same dataset. Since this method requires a training dataset from manual gating to build a model, we exported the cell events and cluster assignment from Cytobank, then equally partitioned all cells into training and test dataset. Due to the difference in method implementation, we didn’t include LDA for cell abundance quantification comparison with other methods, since only half of the cells were used for prediction. To ensure an equitable comparison and further evaluate the accuracy, F-measure, and Adjusted Rand Index (ARI) were calculated using manual gating cluster IDs as reference. As indicated in <xref rid="tbl1" ref-type="table">Table 1</xref>, for the MPN dataset, BinaryClust achieved high F-measure and ARI in all 7 cell types with an average of 0.94 and 0.91 respectively. The performance remains excellent in influenza dataset as well (average F-measure = 0.98, <xref rid="figs2" ref-type="fig">Supplementary Figure 2C</xref>).</p>
<table-wrap id="tbl1" orientation="portrait" position="float">
<label>Table 1</label>
<caption><title>Precision, recall, F-measure, and ARI of indicated clustering methods.</title></caption>
<graphic xlink:href="575790v1_tbl1.tif" mimetype="image" mime-subtype="tiff"/>
</table-wrap>
<p>LDA has equivalent prediction accuracy as BinaryClust with an average F-measure of 0.93 and ARI of 0.90. Both supervised methods outperformed flowSOM (average F-measure=0.75, average ARI=0.66), which is in line with previous benchmarking study on evaluating supervised and unsupervised clustering algorithms(Liu <italic>et al</italic>.). Notably, for cell types that constitute a substantial proportion in the pool like CD4 T cells, CD8 T cells, NK cells, monocytes, and B cells, flowSOM can identify them with high precision and sensitivity, while this is not the case for dendritic cells and gamma delta T cells which account for less than 3% of the whole population (F-measure = 0.51 and 0.15, respectively). Even so, the overall F-measure and ARI for flowSOM considering cell proportion reached 0.81 and 0.80.</p>
<p>It has been demonstrated that flowSOM and LDA are among the fastest clustering algorithms without compromising their performance. Here, we compared the speed amongst the three approaches in MPN, Influenza and COVID-19 datasets(Chevrier et al.)which contain 2,231,053, 210,933 and 3,862,628 cells respectively. Since LDA requires training data to be executed, we did not run it on COVID-19 dataset due to the absence of manual gating results. As shown in <xref rid="fig4" ref-type="fig">Figure 4</xref>, BinaryClust exhibited the highest speed in both MPN and Influenza dataset but fell behind flowSOM slightly in COVID-19 dataset.</p>
<fig id="fig4" position="float" orientation="portrait" fig-type="figure">
<label>Figure 4</label>
<caption><p>Comparison of BinaryClust, flowSOM and LDA on speed. Bar chart showing runtime (in seconds) of the three methods in three different datasets.</p></caption>
<graphic xlink:href="575790v1_fig4.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
</sec>
<sec id="s2c">
<title>ImmCellTyper pipeline supports interactive data visualisation and comparison among study groups</title>
<p>BinaryClust is an important component of ImmCellTyper, a comprehensive integrated pipeline designed for systematic CyTOF data mining. Hence, we utilised the visualisation functions to further prove the reliability and robustness of BinaryClust.</p>
<p>BinaryClust inherently considers CyTOF makers as binary distributed which is in most of the case, but not always. Therefore, it is crucial to check the marker behaviour before running the pipeline. As shown in <xref rid="fig5" ref-type="fig">Figure 5A</xref>, all markers selected for the classification matrix (<xref rid="fig5" ref-type="fig">Figure 5B</xref>) displayed a binary distribution implying the suitability for this pipeline. After clustering (<xref rid="fig5" ref-type="fig">Figure 5C</xref>), median marker expression heatmap (<xref rid="fig5" ref-type="fig">Figure 5D</xref>) can check the reliability of the results before proceeding for downstream analysis. In MPN dataset, we projected the cluster assignment resulted from BinaryClust and manual gating to UMAP (<xref rid="fig5" ref-type="fig">Figure 5E</xref>), along with the expression of the phenotypic markers (<xref rid="fig5" ref-type="fig">Figure 5F</xref> and <xref rid="figs4" ref-type="fig">supplementary Figure 4A</xref>). High similarity was observed between BinaryClust and manual gating, whereas slight difference was found on flowSOM results coloured UMAP on islands of CD8 T cells and CD4 T cells (<xref rid="figs4" ref-type="fig">Supplementary Figure 4A</xref>). FlowSOM appeared to classify cells that were close on spatial distance into the same cluster, in contrast to prior knowledge-based methods: BinaryClust and manual gating.</p>
<fig id="fig5" position="float" orientation="portrait" fig-type="figure">
<label>Figure 5</label>
<caption><p>Cell type characterization and visualisation using ImmCellTyper pipeline in MPN dataset(n=9). (A)Intensity distribution of selected phenotypic markers used for BinaryClust classification, coloured by sample_id;(B) Pre-defined expression classification matrix for the MPN dataset, ‘+’ indicates positive, ‘-’ indicates negative and ‘A ‘suggests ‘any’;(C) Proportion of the main cell lineages of all cells in the concatenated FCS files after classification; (D) Median marker expression heatmap of BinaryClust classification results; (E)UMAP plot of random downsample of 2000 cells per patient coloured by main cell types based on BinaryClust classification(left) and manual gating results(right). (F) UMAP plots coloured by normalized expression of indicated markers (CD3, CD4, CD8a, CD20, CD19, CD14, and CD56) across 2000 cells per sample.</p></caption>
<graphic xlink:href="575790v1_fig5.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
</sec>
<sec id="s2d">
<title>Application of ImmCellTyper pipeline to the COVID-19 dataset demonstrates its versatile functionalities for comprehensive data analysis</title>
<p>To showcase the analytical and visualisation functions of ImmCellTyper pipeline, we used the dataset published by Chevrier et al. (Chevrier <italic>et al</italic>.), which described the immune signature of mild and severe COVID-19 patients in comparison with healthy individuals. There are a total of 82 FCS files with a 40-plex marker panel focusing on innate immunity in this dataset. An initial marker expression check was carried out based on the user-defined matrix (<xref rid="fig6" ref-type="fig">Figure 6B</xref>) and displayed in <xref rid="fig6" ref-type="fig">Figure 6A</xref>. BinaryClust was then performed and identified 12 cell populations as expected. We used t-distributed stochastic neighbour embedding(t-SNE) in this dataset for dimension reduction, coloured by cell types and faceted by disease conditions, which exhibited substantial immune alteration among healthy control, mild and severe COVID-19 patients (<xref rid="fig6" ref-type="fig">Figure 6C</xref>). From the heatmap in <xref rid="fig6" ref-type="fig">Figure 6D</xref>, we can have an overview of the marker expression of each population, which remains consistent with our initial definition indicated in the expression matrix.</p>
<fig id="fig6" position="float" orientation="portrait" fig-type="figure">
<label>Figure 6</label>
<caption><p>Applying ImmCellTyper pipeline on COVID-19 patient dataset(n=82) published by Chevrier et.al. (A) Marker intensity distribution of selected phenotypic markers used for BinaryClust classification, coloured by disease severity(n=22 healthy individuals, 28 mild COVID-19 patients and 38 severe COVID-19 patients);(B)Pre-defined marker expression classification matrix used for BinaryClust; (C) T-SNE plots, with 1000 cells per sample, were coloured by the main cell types generated by BinaryClust and faceted by different study groups;(D)The corresponding median marker expression heatmap of BinaryClust results for the COVID-19 dataset.</p></caption>
<graphic xlink:href="575790v1_fig6.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
<p>The abundances of the identified cell types were quantified for each individual study participant in the format of stacked histogram (<xref rid="fig7" ref-type="fig">Figure 7A</xref>) and summarized in boxplot (<xref rid="fig7" ref-type="fig">Figure 7B</xref>). Compared with healthy volunteers, there are significant immune alterations in COVID-19 patients in B cells, Basophils, cDCs, Monocytes, NK cells, CD8 T cells, Neutrophils and pDCs (all P&lt;0.05), which depicts a similar trend to the original paper, despite slight discrepancies caused by different statistical methods used. Kruskal Wallis test was conducted for this dataset followed by multiple testing correction (Benjamini-Hochberg procedure) and Dunn’s test for post hoc analysis, while Chevirer et al. used Mann-Whitney Wilcoxon test corrected by Holm method. We then selected 9 markers (IL-6, PD-L1, VISTA, IDO, TIM-3, TMEM173, GranzymeB, PPARg, Ki-67) as the state markers which can reflect the functional or proliferative status of the immune cell types. Notably, Granzyme B was observed to be significantly highly expressed in COVID-19 patients versus healthy control across all identified immune cell types(all P&lt;0.05), TMEM173 was substantially up-regulated in COVID-19 patients particularly in monocytes, neutrophils, and CD4 T cells; and PD-L1 expression remained low for all cells, indicating the immune system of COVID-19 patients were highly activated without exhaustion regardless of disease severity, which was not explored previously. Since monocytes and neutrophils were of particular interest in the original paper, and the panel also included specific markers for in-depth interrogation, we then extracted the two population and carried out Phenograph(k=60) to investigate the subclusters. As shown in <xref rid="fig7" ref-type="fig">Figure 7D</xref>, Phenograph returned 16 and 14 subclusters respectively for monocytes and neutrophils, with heatmap provided in <xref rid="figs5" ref-type="fig">Supplementary Figure 5</xref>.</p>
<fig id="fig7" position="float" orientation="portrait" fig-type="figure">
<label>Figure 7</label>
<caption><p>Quantification and statistical analysis comparing the study conditions in COVID-19 dataset(n=82). (A)Stacked histogram of main cell type composition per individual generated by BinaryClust, and grouped by study conditions (healthy, mild and severe); (B)Boxplots representing cell abundance frequencies among the study conditions, faceted by different main cell types;(C) State marker expression intensities with comparison of the study groups across the main cell types; (D)Clusters of monocytes and neutrophils were extracted from the whole cells for downstream interrogation. T-SNE plots with random downsample of 1000 monocyte cells and (E) neutrophils per sample were coloured by study conditions and Phenograph clustering results(k=60), respectively. Statistical significance was marked by asterisk. * P&lt;0.05, **P&lt;0.01, ***P&lt;0.001, ****P&lt;0.0001</p></caption>
<graphic xlink:href="575790v1_fig7.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
<p>Reanalysis of the COVID-19 dataset demonstrated the concordance of ImmCellTyper pipeline with original reports with additional findings, as well as its versatile interactive data visualisation functionalities.</p>
</sec>
</sec>
<sec id="s3">
<title>Discussion</title>
<p>In this study, we present an analytical pipeline named ImmCellTyper for systematic exploration of CyTOF data. This pipeline addresses a comprehensive range of analytical needs encompassing data quality check, batch effects examination/correction, cell type identification, and downstream differential analysis accompanied by high-quality, publishable data visualisations. Furthermore, ImmCellTyper includes an in-house developed, knowledge-based, semi-supervised classifier BinaryClust with high accuracy and speed, and also integrates the well-performing and state-of-the-art unsupervised algorithms (Phenograph and flowSOM). By adopting the strategy of first obtaining the main cell types and then select specific cell types for in-depth interrogation with higher clustering resolution, ImmCellTyper combines the advantages of both supervised and unsupervised clustering algorithms for discovery of both major populations and refined subpopulations. Designed for ease of use, this pipeline features a clear and user-friendly workflow, and is compatible to the widely used pipeline CATALYST, aiming to provide a one-stop solution for CyTOF users.</p>
<p>For validating the robustness of the automated cell characterization function of ImmCellTyper: BinaryClust, we involved two independent datasets (MPN dataset and Influenza dataset) and compared with existing clustering tools flowSOM and LDA. Previous Benchmarking studies indicated that flowSOM was one of the best-performing unsupervised tools in precision, speed and stability, with F-measure ranges from 0.58∼0.90 in various datasets(Liu <italic>et al</italic>.), and was widely used in high-impact research publications(Liu et al.; Liu <italic>et al</italic>.). However, the results of flowSOM vary upon the k values set by the users which causes some uncertainty and impairs reproducibility of the results. In contrast, semi-supervised clustering methods like ACDC, DeepCyTOF(<xref ref-type="bibr" rid="c15">Li <italic>et al</italic>., 2017</xref>) and LDA outperformed the unsupervised methods in the same benchmarking study. The F-measure obtained by ACDC and LDA ranged from 0.78∼0.99, which was significantly higher than unsupervised approaches including Accense, PhenoGraph, Xshift, k-means, flowMeans(Aghaeepour et al.), FlowSOM and DEPECHE(Theorell et al.)(F-measure: 0.28∼0.93)(Liu <italic>et al</italic>.). In this study, we chose LDA because it has proven to be superior to ACDC and DeepCyTOF in terms of precision and speed(Abdelaal <italic>et al</italic>.; Liu <italic>et al</italic>.). The excellent performance of LDA was demonstrated in MPN dataset of this study with F-measure reached 0.93 for around 4 million cells. BinaryClust was comparable in accuracy(F-measure=0.94) but much faster in speed. Both semi-supervised approaches outperformed flowSOM as expected. Although semi-supervised methods seem to perform better, the mainstream for CyTOF data analysis still relies on unsupervised methods. The reason for this might be that most of the semi-supervised methods rely on manual gating as reference and requires either the manually gated expression matrix or user-defined binary matrix as training data. This process takes extra time and efforts especially for defining subpopulations, and may introduce end-user bias. Additionally, the common restriction for all the supervised methods is that they have limited capability to reveal novel subsets as those are not predefined in the training pool, which poses a critical challenge for the pursuit of novel discoveries. Considering all these strength and limitations, as a semi-supervised method, BinaryClust possesses the advantages of incorporating prior biological knowledge, being reproducible across runs and accurate on cell type identification. Meanwhile, the input requirement is a simple matrix of cell population definition based on marker positivity, avoiding the hassle to manually gate example FCS files. With a deep understanding that certain CyTOF markers are expressed on a continuum rather than binary manner, this automated supervised approach will only be used for classification of main cell lineages. The test datasets in this study contained data from human PBMC samples which represented a heterogenous pool of immune cells, covering the major types of various immune populations, and demonstrated excellent performance of BinaryClust on classifying CD4 T cells, CD8 T cells, gamma delta T cells, NK cells, monocytes, dendritic cells, and B cells. We also recommend checking marker expression distribution before running the pipeline to ensure accurate results. After the above step, this pipeline supports cell population extraction for further dissection into subclusters using unsupervised approaches, which excel in detecting rare and refined subpopulations. Phenograph is a particularly effective tool for this purpose. By applying this strategy, our previous work with BinaryClust facilitated the evaluation of the impact of systematic anti-cancer agents on lymphocyte population in non-small cell lung cancer patients, as well as the characteristics of autologous T cell products after manufacturing (O’Brien Gore et al.).</p>
<p>Another purpose behind the development of the ImmCellTyper framework is to cater to general analysis needs, spanning from pre-processing to downstream differential analysis. There are existing well-established pipelines like CATALYST(<xref ref-type="bibr" rid="c21">Nowicka <italic>et al</italic>., 2017</xref>), diffcyt(<xref ref-type="bibr" rid="c32">Weber et al., 2019</xref>), Cytofkit(<xref ref-type="bibr" rid="c8">Chen <italic>et al</italic>., 2016</xref>), and ImmunoCluster(<xref ref-type="bibr" rid="c23">Opzoomer <italic>et al</italic>., 2021</xref>) etc., each of them has its own strength and limitations. One of the challenges existed in CyTOF data pre-processing is effectively integrating multiple batches, given the technical differences arising from experiments and instrumental acquisition, which could result in the separation of clustering across batches and potentially confounding the signal of interest. In ImmCellTyper pipeline, we provide the functionality for batch effects examination and incorporated two well-performing batch correction algorithms CytoNorm (Van Gassen et al.) and CytofRUV(Trussart et al.) into our framework prior to downstream analysis, which ensures the quality of the data and, to the best of our knowledge, makes it the first integrated pipeline with this module. For the downstream analysis, tools like diffcyt and CATALYST group markers into phenotypic and state makers, enabling the detection of differentially abundant cell clusters and differential expression of functional markers within each cell population(<xref ref-type="bibr" rid="c32">Weber <italic>et al</italic>., 2019</xref>). This well-recognised strategy has been extensively applied in various studies. But one limitation is that it directly classifies cells into high-resolution clusters, and cannot automatically merge subclusters into one major population with similar phenotypes(<xref ref-type="bibr" rid="c32">Weber <italic>et al</italic>., 2019</xref>). Our pipeline addresses this problem via a precise and convenient solution: using the semi-supervised classifier (BinaryClust) of ImmCellTyper. The two pipelines (CATALYST and ImmCellTyper) are well compatible, allowing users to leverage their functions together and providing a broader range of analytical options. On the other hand, Cytofkit has the advantages of the graphical user interface(GUI) for non-specialists, integration of a variety of clustering(DensVM(Becher <italic>et al</italic>.), ClusterX, FlowSOM, Phenograph), dimension reduction(PCA, ISOMAP, t-SNE) methods, and inference of the relatedness among cell populations, but it does not support complex study design, group comparison and statistical testing(<xref ref-type="bibr" rid="c8">Chen <italic>et al</italic>., 2016</xref>). Several methods have been developed to fit with the high-dimensional features of CyTOF data for differential analysis including diffcyt, CellCnn(Arvaniti and Claassen), cydar(Lun et al.), citrus(Bruggner et al.), cyEMD(Arend et al.) etc. Nonetheless, none of them is applicable to compare more than two study groups at once which involves multiple testing. Therefore, to accommodate study designs involving multiple groups, ImmCellTyper does statistics via first applying Kruskal Wallis test, followed by Benjamin-Hochberg (BH) procedure for multiple testing correction and post hoc analysis via Dunn’s test or pairwise-Wilcoxon test. In cases where the comparison involves only two groups, Mann-Whitney test will be applied in terms of cell frequency, as the distribution of CyTOF data generally does not fit for normal distribution.</p>
<p>One limitation of this computational pipeline is that its semi-supervised cluster identification may not be well-suited for the direct identification of specific subpopulations which are defined by continuum markers. This is due to the method’s reliance on the presumption that makers are binary distributed. In addition, for users with general interest in charactering subclusters of each main cell lineage, it can be laborious to first perform BinaryClust then extract every population for unsupervised clustering. In such scenarios, BinaryClust can be used in parallel with other clustering methods or pipelines like CATALYST. This allows users to quickly obtain additional information about main cell types with the accuracy comparable to manual gating.</p>
<p>In summary, we introduce a novel open-source R-implemented strategy and a versatile toolbox for CyTOF data analysis. The future direction is to automate the data clean-up, compensation, and bead normalisation steps. Additionally, we also aim to implement the whole pipeline into Python, a more accessible programming language for bioinformatics novices and biologists who wish to perform high-dimensional data analysis independently.</p>
</sec>
<sec id="s4">
<title>Materials and methods</title>
<sec id="s4a">
<title>BinaryClust</title>
<p>Most of the CyTOF markers exhibit log-normal or bi-modal distribution with zero inflation after arcsinh transformation. Thus, we employ binary classification using k-means to group cells into negative and positive populations(k=2) for each marker indicated in the user-defined classification matrix. Here, k-means is an unsupervised clustering algorithm to cluster the data based on the Euclidean distance among points, which is calculated by the formula below:
<disp-formula>
<graphic xlink:href="575790v1_ueqn1.gif" mimetype="image" mime-subtype="gif"/>
</disp-formula>
Then assign each data point into a cluster centroid which is denoted by c<sub>i</sub>, and dist()is the Euclidean distance:
<disp-formula>
<graphic xlink:href="575790v1_ueqn2.gif" mimetype="image" mime-subtype="gif"/>
</disp-formula>
By aligning the k-means results with the user-designed classification matrix, cell populations can be subsequently classified and annotated.</p>
</sec>
<sec id="s4b">
<title>R package ImmCellTyper</title>
<p>This computational pipeline is implemented in the R package ImmCellTyper and publicly available on Github (<ext-link ext-link-type="uri" xlink:href="https://github.com/JingAnyaSun/ImmCellTyper">https://github.com/JingAnyaSun/ImmCellTyper</ext-link>). Instructions for package installation and function usage can be found in the README file on the Github page. It is recommended to first examine the unwanted non-biological variation across batches and perform additional batch normalisation if necessary. Afterwards, import the data into the second part of the pipeline for downstream analysis. Users are required to prepare all the FCS files, sample metadata containing the details and grouping information of each sample, panel metadata with the information of the antibody panel with metal tags used in the experiments, and cell type classification matrix with phenotypic marker expression in a binary manner of each cell lineage. All files need to be in the right format to use the pipeline.</p>
</sec>
<sec id="s4c">
<title>ImmCellTyper workflow overview</title>
<p>ImmCellTyper pipeline is composed of two separate sub-pipelines, as illustrated in <xref rid="fig8" ref-type="fig">Figure 8</xref>:
<list list-type="order">
<list-item><p>Sub-pipeline1: Batch effects evaluation and correction. Batch effects occur when samples were collected and measured at different sites or time points, especially for large-scale studies. It is crucial to remove the unwanted variation which might interfere the true biological differences. Users can systematically examine batch effects on two levels including marker behaviours and clustering results based on the method introduced by Trussart et al. (Trussart <italic>et al</italic>.) If needed, CytoNorm and CytofRUV, which are well-performing correction algorithms, can be used to align the existing batch effects.</p></list-item>
<list-item><p>Sub-pipeline2: semi-supervised classification, differential analysis, and in-depth investigation. When data are cleaned and normalised, they can be imported into the second part of the pipeline, constructed into a SingleCellExperiment (sce) object, and undergo semi-supervised classification to identify the major cell types and test the differential frequencies or state marker expression among study groups. After that, if the users have certain interests of specific cell types and pre-design the panel for that, or in another circumstance, the initial statistics draw the user’s attention into a certain cell type, institutively, further clustering using unsupervised tools like flowSOM or Phenograph should be conducted with an increased cluster resolution and deeper investigation for cell subsets, after extracting the cell population of interest. ImmCellTyper pipeline has the same data storage and infrastructure as CATALYST, therefore all the functions in CATALYST can be seamlessly used in ImmCellTyper, tailored to user’s analytical needs. We do not elaborate on the basic functions of CATALYST, which can be found in the tutorial vignettes of the package(<ext-link ext-link-type="uri" xlink:href="https://github.com/HelenaLC/CATALYST">https://github.com/HelenaLC/CATALYST</ext-link>).</p></list-item>
</list>
</p>
<fig id="fig8" position="float" orientation="portrait" fig-type="figure">
<label>Figure 8</label>
<caption><p>Overall schematic outline of the ImmCellTyper workflow with description for each step.</p></caption>
<graphic xlink:href="575790v1_fig8.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
</sec>
<sec id="s4d">
<title>Batch correction algorithms</title>
<p>The batch effect correction algorithms embedded in the function of ‘batchNorm’ comprises CytoNorm, as described by Van Gassen et al.(Van Gassen <italic>et al</italic>.) and CytofRUV by Trussart et al.(Trussart <italic>et al</italic>.). Both algorithms rely on anchors (reference samples/technical replicates) across batches to perform normalisation. CytoNorm uses flowSOM clustering to first identify clusters prior to a population-specific transformation on the reference samples by computing the quantile values and aligning them with splines, whereas CytofRUV applies remove unwanted variation III (RUV-III) to CyTOF data by estimating and eliminating the non-biological variation of the pseudo-replicates.</p>
</sec>
<sec id="s4e">
<title>Agreement evaluation</title>
<p>To assess the agreement among manual gating, BinaryClust classification and flowSOM clustering, we used correlation, interaction plot and Bland-Altman analysis. Correlation evaluates the relationship between two variables which doesn’t mean concordance, but if two methods agree, surely, they should be highly correlated. We compared the results of cell population frequency generated by experts and BinaryClust using Pearson correlation, calculated the correlation coefficient and P value, with the line of equality indicating perfect agreement (red solid line, R<sup>2</sup>=1) in the plots to help gauge the degree of agreement between the two methods; Bland-Altman plot refers to a dot plot of the difference between two variables(y-axis) against the mean of them(x-axis), as described by J.Martian Bland and Douglas G. Altman in 1986, which represents a graphical magnitude of bias(average of difference) with 95% confidence interval. The math formula for the limit of agreement is as below:</p>
<p>Limits of agreement = mean difference observed ± 1.96 × standard deviation</p>
<p>We also used Interaction plot to display the interaction effects of the three methods including manual gating, BinaryClust classification and flowSOM clustering on the measurement of cell frequencies to evaluate the agreement.</p>
</sec>
<sec id="s4f">
<title>F-measure</title>
<p>F-measure is a method to assess the accuracy of the clustering method compared to gold standard, which is manual gating results in this study. It stands for the harmonic mean of the precision and recall values, which can be calculated using below formula:
<disp-formula>
<graphic xlink:href="575790v1_ueqn3.gif" mimetype="image" mime-subtype="gif"/>
</disp-formula>
Here, precision represents the positive predictive value: the proportion of true positive instances divided by the instances classified as positive by the clustering algorithm; recall evaluates the sensitivity, which is the number of true positive events correctly identified by the algorithm among all events that belong to the cluster. F-measure ranges from 0 to 1, where 1 suggests perfect performance and 0 indicates poor precision and recall.</p>
</sec>
<sec id="s4g">
<title>Adjusted Rand Index</title>
<p>Adjusted rand index is a widely used method to measure the similarity between two clustering results. We used it to assess the agreement between test clustering algorithm and the gold standard labels which is derived from manual gating. ARI is defined as the following formula based on a contingency matrix (where n<sub>ij</sub>, a<sub>i</sub>, b<sub>j</sub> are values from the contingency table):
<disp-formula>
<graphic xlink:href="575790v1_ueqn4.gif" mimetype="image" mime-subtype="gif"/>
</disp-formula>
ARI ranges from -1 to 1, with 1 indicates a perfect match, 0 means not relevant, and -1 indicates complete mismatch between two clustering results.</p>
</sec>
<sec id="s4h">
<title>Differential analysis</title>
<p>In order to perform the differential analysis of cell abundances and state marker expression amongst study groups, we consider the number of study groups into two conditions in function ’StatTest’: 1) n=2, Mann-Whitney Wilcoxon analysis will be applied as cell frequency/marker expression doesn’t fit normal distribution; 2) n=3, Kruskal-Wallis test will be first performed followed by multiple testing correction using BH procedure and post-hoc analysis(Dunn’s test or pairwise Wilcoxon test).</p>
</sec>
<sec id="s4i">
<title>Sample collection and preparation for CyTOF</title>
<p>PBMC samples from MPN patients were requested and obtained from biobank at Guy’s Hospital, under a protocol approved by the KCL Biobank Access Committee (REC18/EE/0025). Healthy volunteers were recruited at Guy’s hospital with informed consent and ethical approval by King’s College Research Ethics Committee (HR-17/18-5960 MOD-20/21-5960) in accordance with the Declaration of Helsinki. All identifiable information of study participants were securely stored in a trusted research environment managed by members of the team.</p>
<p>Venous blood samples from healthy volunteers were collected in BD vacutainer EDTA tubes, and PBMCs were isolated and purified using Ficoll-Hypaque density gradient centrifugation. In brief, blood was carefully layered onto Ficoll and spined at 460g for 20 minutes at room temperature (RT) without brake; Upon observing a clear separation of blood components, PBMCs were then carefully isolated and washed three times with RPMI 1640 medium to remove other contaminants. Subsequently, the purified PBMCs were cryopreserved in liquid nitrogen at a density of 1X10<sup>7</sup> cells per vial.</p>
</sec>
<sec id="s4j">
<title>CyTOF Antibody staining</title>
<p>Cryopreserved cells were quickly thawed at 37°C in water bath, suspended in pre-warmed RPMI 1640 medium, washed three times, and underwent Fc-blocking using human TruStain FcX (Biolegend) for 10 mins at RT. Given that the antibody panel employs indirect detection of CD95 using anti-CD95-APC and anti-APC-106Cd, cells were initially stained with anti-CD95-APC for 30 minutes in a dark place, followed by two washes with 2ml cell staining buffer (CSB).</p>
<p>After the removal of supernatant, cells were resuspended in 300µl CSB and transferred into the dip tube containing lyophilized antibody mix of Maxpar direct immune profiling assay (MDIPA, Standard BioTools). Additional antibodies used to study T cell activation, migration, and exhaustion status (anti-TIM3, anti-PD-1, anti-ICOS, anti-TIGIT, anti-OX40) were also added. Cells were incubated with the antibody mix for 30 mins at RT in compliance with manufacturer’s instructions, washed twice and fixed using a freshly prepared 1.6% paraformaldehyde (PFA, Thermo Fisher Scientific) solution for 10 mins at RT. In the end, cells were washed with CSB twice to remove residual PFA and stained with 125nM Cell-ID intercalator-Iridium in 1 ml Maxpar Fix and Perm Buffer (Standard BioTools) overnight at 4°C. The stained cells were frozen down using freezing media (fetal bovine serum containing 10% DMSO) and stored at -80°C freezer before data acquisition.</p>
<p>On the day for CyTOF acquisition, cryopreserved samples were thawed, washed twice with 1ml CSB, followed by additional two washes with 1ml cell acquisition solution (CAS, Standard BioTools), and centrifuged at 800g for 5 minutes. Cells were then filtered through a 40 μm cell strainer to avoid blockage and cell count was determined by Countess automated cell counter (Invitrogen). EQ four-element calibration beads (Standard BioTools) were added to a final concentration of 0.5×10<sup>6</sup> cells/ml to adjust signal fluctuation of the instrument. CyTOF acquisition was performed on Helios mass cytometer system. For each batch of cell staining and run, technical replicates from the same healthy donor were included to evaluate and correct batch effects.</p>
<p>The full antibody panel including the metal tag, clone, and supplier is listed in <xref rid="tbls1" ref-type="table">Supplementary Table 1</xref>.</p>
</sec>
<sec id="s4k">
<title>CyTOF data pre-processing</title>
<p>FCS files were first processed for bead normalisation using CyTOF v7.0 system control software (Standard BioTools) to correct signal drift during acquisition. Subsequently, the files were imported into Cytobank (Cytobank Inc.) for data cleaning, with a detailed procedure illustrated in <xref rid="figs6" ref-type="fig">Supplementary Figure 6</xref>. The aim is to remove non-events including debris, doublets, normalisation (EQ) beads and other undesired events like dead cells. The CD45+ cell population was pre-gated using Cytobank for down-stream analysis.</p>
</sec>
<sec id="s4l">
<title>Manual gating</title>
<p>Manual gating for major cell populations was performed using Cytobank platform, and gatingML files were exported and converted into gatingSet object to extract labels of each cell via the R packages flowWorkspace, openCyto and CytoML. These data were used as reference for benchmarking computer-aided algorithms.</p>
</sec>
</sec>
<sec id="s5">
<title>Dataset availability</title>
<p>In this study, we tested ImmCellTyper pipeline on the MPN cohort with 7 MPN patients and 2 healthy volunteers, influenza cohort with 11 patients and the COVID-19 cohort with 59 COVID-19 patients and 23 healthy volunteers. The FCS files (after clean-up and gating of CD45 population) and metadata of the MPN cohort were deposited in Zenodo (doi: 10.5281/zenodo.10076940); The influenza cohort was published by our lab(Alimam <italic>et al</italic>.), and the data were stored in Zenodo (doi: 10.5281/zenodo.7982165); The COVID-19 dataset was previously published by Chevrier et al. (Chevrier <italic>et al</italic>.), and the FCS files can be retrieved from Mendeley Data (<ext-link ext-link-type="uri" xlink:href="https://data.mendeley.com/datasets/vyy8ttw7n9/1">https://data.mendeley.com/datasets/vyy8ttw7n9/1</ext-link>).</p>
</sec>
</body>
<back>
<sec id="s6">
<title>Author contributions</title>
<p>Jing Sun, Conceptualization, Data curation, Software, Formal analysis, Supervision, Validation, Visualisation, Methodology, Writing – original draft, Writing – review and editing, Resources, Experiments; Desmond Choy, Conceptualization, Software, Supervision, Methodology, Resources, Investigation; Nicolas Sompairac, Technical supervision, Resources, Data curation, Writing – review and editing; Shirin Jamshidi, Technical supervision, Resources, Writing – review and editing; Shahram Kordasti, Conceptualization, Resources, Funding acquisition, Supervision, Writing – review and editing, Project administration; Michele Mishto: Writing – review and editing</p>
</sec>
<sec id="s7">
<title>Competing interests</title>
<p>The authors declare that there are no competing interests exist.</p>
</sec>
<ack>
<title>Acknowledgement</title>
<p>This work is supported in part by: Blood Cancer UK [Ref. 22009] and CRUK City of London Centre (CoL) Award [CTRQQR-2021/100004] to MM and SK; JS was supported by the K-CSC scholarship.</p>
<p>We thank BRC flowCore at Guy’s Hospital for technical support, Biobank at King’s College London for patient samples; We are thankful for Cynthia Bishop, Katrina Todd, Rosa Andres Ejarque, Elena Torre, Robert Page, Rita Antunes Dos Reis and Mishto lab members at King’s College London, Daniel Dancer, Thomas Adejumo at Standard Biotools for technical assistance and sample management, as well as all study participants for their kind support for this research. Special thanks to Eliezer Van Allen and Jihye Park at Dana Farber Cancer Institute to review and comment this work.</p>
</ack>
<ref-list>
<title>References</title>
<ref id="c1"><mixed-citation publication-type="other"><string-name><surname>Abdelaal</surname>, <given-names>T.</given-names></string-name>, <string-name><surname>van Unen</surname>, <given-names>V.</given-names></string-name>, <string-name><surname>Höllt</surname>, <given-names>T.</given-names></string-name>, <string-name><surname>Koning</surname>, <given-names>F.</given-names></string-name>, <string-name><surname>Reinders</surname>, <given-names>M.J.T.</given-names></string-name>, and <string-name><surname>Mahfouz</surname>, <given-names>A.</given-names></string-name> <collab>Predicting Cell Populations in Single Cell Mass Cytometry Data</collab>.</mixed-citation></ref>
<ref id="c2"><mixed-citation publication-type="other"><string-name><surname>Aghaeepour</surname>, <given-names>N.</given-names></string-name>, <string-name><surname>Nikolic R Fau - Hoos</surname>, <given-names>H.H.</given-names></string-name>, <string-name><surname>Hoos Hh Fau - Brinkman</surname>, <given-names>R.R.</given-names></string-name>, and <string-name><surname>Brinkman</surname>, <given-names>R.R.</given-names></string-name> <collab>Rapid cell population identification in flow cytometry data</collab>.</mixed-citation></ref>
<ref id="c3"><mixed-citation publication-type="other"><string-name><surname>Alimam</surname>, <given-names>S.A.-O.</given-names></string-name>, <string-name><surname>Ann Timms</surname>, <given-names>J.</given-names></string-name>, <string-name><surname>Harrison</surname>, <given-names>C.A.-O.X.</given-names></string-name>, <string-name><surname>Dillon</surname>, <given-names>R.</given-names></string-name>, <string-name><surname>Mare</surname>, <given-names>T.</given-names></string-name>, <string-name><surname>DeLavallade</surname>, <given-names>H.</given-names></string-name>, <string-name><surname>Radia</surname>, <given-names>D.A.-O.</given-names></string-name>, <string-name><surname>Woodley</surname>, <given-names>C.</given-names></string-name>, <string-name><surname>Francis</surname>, <given-names>Y.</given-names></string-name>, <string-name><surname>Sanchez</surname>, <given-names>K.</given-names></string-name>, <etal>et al.</etal> <collab>Altered immune response to the annual influenza A vaccine in patients with myeloproliferative neoplasms</collab>.</mixed-citation></ref>
<ref id="c4"><mixed-citation publication-type="journal"><string-name><surname>Arend</surname>, <given-names>L.</given-names></string-name>, <string-name><surname>Bernett</surname>, <given-names>J.</given-names></string-name>, <string-name><surname>Manz</surname>, <given-names>Q.</given-names></string-name>, <string-name><surname>Klug</surname>, <given-names>M.</given-names></string-name>, <string-name><surname>Lazareva</surname>, <given-names>O.</given-names></string-name>, <string-name><surname>Baumbach</surname>, <given-names>J.</given-names></string-name>, <string-name><surname>Bongiovanni</surname>, <given-names>D.</given-names></string-name>, and <string-name><surname>List</surname>, <given-names>M</given-names></string-name>. <article-title>A systematic comparison of novel and existing differential analysis methods for CyTOF data</article-title>. <source>LID - bbab471</source> [pii] LID - <pub-id pub-id-type="doi">10.1093/bib/bbab471</pub-id> [doi].</mixed-citation></ref>
<ref id="c5"><mixed-citation publication-type="other"><string-name><surname>Arvaniti</surname>, <given-names>E.A.-O.</given-names></string-name>, and <string-name><surname>Claassen</surname>, <given-names>M.</given-names></string-name> <collab>Sensitive detection of rare disease-associated cell subsets via representation learning</collab>.</mixed-citation></ref>
<ref id="c6"><mixed-citation publication-type="other"><string-name><surname>Becher</surname>, <given-names>B.A.-O.</given-names></string-name>, <string-name><surname>Schlitzer</surname>, <given-names>A.</given-names></string-name>, <string-name><surname>Chen</surname>, <given-names>J.</given-names></string-name>, <string-name><surname>Mair</surname>, <given-names>F.</given-names></string-name>, <string-name><surname>Sumatoh</surname>, <given-names>H.R.</given-names></string-name>, <string-name><surname>Teng</surname>, <given-names>K.W.</given-names></string-name>, <string-name><surname>Low</surname>, <given-names>D.</given-names></string-name>, <string-name><surname>Ruedl</surname>, <given-names>C.</given-names></string-name>, <string-name><surname>Riccardi-Castagnoli</surname>, <given-names>P.</given-names></string-name>, <string-name><surname>Poidinger</surname>, <given-names>M.A.-O.</given-names></string-name>, <etal>et al.</etal> <collab>High-dimensional analysis of the murine myeloid cell system</collab>.</mixed-citation></ref>
<ref id="c7"><mixed-citation publication-type="other"><string-name><surname>Bruggner</surname>, <given-names>R.V.</given-names></string-name>, <string-name><surname>Bodenmiller</surname>, <given-names>B.</given-names></string-name>, <string-name><surname>Dill</surname>, <given-names>D.L.</given-names></string-name>, <string-name><surname>Tibshirani</surname>, <given-names>R.J.</given-names></string-name>, and <string-name><surname>Nolan</surname>, <given-names>G.P.</given-names></string-name> <collab>Automated identification of stratifying signatures in cellular subpopulations</collab>.</mixed-citation></ref>
<ref id="c8"><mixed-citation publication-type="journal"><string-name><surname>Chen</surname>, <given-names>H.</given-names></string-name>, <string-name><surname>Lau</surname>, <given-names>M.C.</given-names></string-name>, <string-name><surname>Wong</surname>, <given-names>M.T.</given-names></string-name>, <string-name><surname>Newell</surname>, <given-names>E.W.</given-names></string-name>, <string-name><surname>Poidinger</surname>, <given-names>M.</given-names></string-name>, and <string-name><surname>Chen</surname>, <given-names>J</given-names></string-name>. (<year>2016</year>). <article-title>Cytofkit: A Bioconductor Package for an Integrated Mass Cytometry Data Analysis Pipeline</article-title>. <source>PLoS Comput Biol</source> <volume>12</volume>, <fpage>e1005112</fpage>. <pub-id pub-id-type="doi">10.1371/journal.pcbi.1005112</pub-id>.</mixed-citation></ref>
<ref id="c9"><mixed-citation publication-type="journal"><string-name><surname>Cheng</surname>, <given-names>L.</given-names></string-name>, <string-name><surname>Karkhanis</surname>, <given-names>P.</given-names></string-name>, <string-name><surname>Gokbag</surname>, <given-names>B.</given-names></string-name>, <string-name><surname>Liu</surname>, <given-names>Y.</given-names></string-name>, and <string-name><surname>Li</surname>, <given-names>L</given-names></string-name>. (<year>2022</year>). <article-title>DGCyTOF: Deep learning with graphic cluster visualization to predict cell types of single cell mass cytometry data</article-title>. <source>PLOS Computational Biology</source> <volume>18</volume>, <fpage>e1008885</fpage>. <pub-id pub-id-type="doi">10.1371/journal.pcbi.1008885</pub-id>.</mixed-citation></ref>
<ref id="c10"><mixed-citation publication-type="other"><string-name><surname>Chevrier</surname>, <given-names>S.</given-names></string-name>, <string-name><surname>Zurbuchen</surname>, <given-names>Y.</given-names></string-name>, <string-name><surname>Cervia</surname>, <given-names>C.</given-names></string-name>, <string-name><surname>Adamo</surname>, <given-names>S.</given-names></string-name>, <string-name><surname>Raeber</surname>, <given-names>M.E.</given-names></string-name>, <string-name><surname>de Souza</surname>, <given-names>N.</given-names></string-name>, <string-name><surname>Sivapatham</surname>, <given-names>S.</given-names></string-name>, <string-name><surname>Jacobs</surname>, <given-names>A.</given-names></string-name>, <string-name><surname>Bachli</surname>, <given-names>E.</given-names></string-name>, <string-name><surname>Rudiger</surname>, <given-names>A.</given-names></string-name>, <etal>et al.</etal> <collab>A distinct innate immune signature marks progression from mild to severe COVID-19</collab>.</mixed-citation></ref>
<ref id="c11"><mixed-citation publication-type="journal"><string-name><surname>Kaushik</surname>, <given-names>A.</given-names></string-name>, <string-name><surname>Dunham</surname>, <given-names>D.</given-names></string-name>, <string-name><surname>He</surname>, <given-names>Z.</given-names></string-name>, <string-name><surname>Manohar</surname>, <given-names>M.</given-names></string-name>, <string-name><surname>Desai</surname>, <given-names>M.</given-names></string-name>, <string-name><surname>Nadeau</surname>, <given-names>K.C.</given-names></string-name>, and <string-name><surname>Andorf</surname>, <given-names>S</given-names></string-name>. (<year>2021</year>). <article-title>CyAnno: a semi-automated approach for cell type annotation of mass cytometry datasets</article-title>. <source>Bioinformatics</source> <volume>37</volume>, <fpage>4164</fpage>–<lpage>4171</lpage>. <pub-id pub-id-type="doi">10.1093/bioinformatics/btab409</pub-id>.</mixed-citation></ref>
<ref id="c12"><mixed-citation publication-type="other"><string-name><surname>Kimball</surname>, <given-names>A.K.</given-names></string-name>, <string-name><surname>Oko</surname>, <given-names>L.M.</given-names></string-name>, <string-name><surname>Bullock</surname>, <given-names>B.A.-O.</given-names></string-name>, <string-name><surname>Nemenoff</surname>, <given-names>R.A.</given-names></string-name>, <string-name><surname>van Dyk</surname>, <given-names>L.A.-O.</given-names></string-name>, and <string-name><surname>Clambey</surname>, <given-names>E.A.-O.</given-names></string-name> <collab>A Beginner’s Guide to Analyzing and Visualizing Mass Cytometry Data</collab>.</mixed-citation></ref>
<ref id="c13"><mixed-citation publication-type="journal"><string-name><surname>Lee</surname>, <given-names>H.C.</given-names></string-name>, <string-name><surname>Kosoy</surname>, <given-names>R.</given-names></string-name>, <string-name><surname>Becker</surname>, <given-names>C.E.</given-names></string-name>, <string-name><surname>Dudley</surname>, <given-names>J.T.</given-names></string-name>, and <string-name><surname>Kidd</surname>, <given-names>B.A.</given-names></string-name> <source>Automated cell type discovery and classification through knowledge transfer</source>.</mixed-citation></ref>
<ref id="c14"><mixed-citation publication-type="journal"><string-name><surname>Levine</surname>, <given-names>J.H.</given-names></string-name>, <string-name><surname>Simonds</surname>, <given-names>E.F.</given-names></string-name>, <string-name><surname>Bendall</surname>, <given-names>S.C.</given-names></string-name>, <string-name><surname>Davis</surname>, <given-names>K.L.</given-names></string-name>, <string-name><surname>Amir el</surname>, <given-names>A.D.</given-names></string-name>, <string-name><surname>Tadmor</surname>, <given-names>M.D.</given-names></string-name>, <string-name><surname>Litvin</surname>, <given-names>O.</given-names></string-name>, <string-name><surname>Fienberg</surname>, <given-names>H.G.</given-names></string-name>, <string-name><surname>Jager</surname>, <given-names>A.</given-names></string-name>, <string-name><surname>Zunder</surname>, <given-names>E.R.</given-names></string-name>, <etal>et al.</etal> <source>Data-Driven Phenotypic Dissection of AML Reveals Progenitor-like Cells that Correlate with Prognosis</source>.</mixed-citation></ref>
<ref id="c15"><mixed-citation publication-type="journal"><string-name><surname>Li</surname>, <given-names>H.</given-names></string-name>, <string-name><surname>Shaham</surname>, <given-names>U.</given-names></string-name>, <string-name><surname>Stanton</surname>, <given-names>K.P.</given-names></string-name>, <string-name><surname>Yao</surname>, <given-names>Y.</given-names></string-name>, <string-name><surname>Montgomery</surname>, <given-names>R.R.</given-names></string-name>, and <string-name><surname>Kluger</surname>, <given-names>Y</given-names></string-name>. (<year>2017</year>). <article-title>Gating mass cytometry data by deep learning</article-title>. <source>Bioinformatics</source> <volume>33</volume>, <fpage>3423</fpage>–<lpage>3430</lpage>. <pub-id pub-id-type="doi">10.1093/bioinformatics/btx448</pub-id>.</mixed-citation></ref>
<ref id="c16"><mixed-citation publication-type="other"><string-name><surname>Liu</surname>, <given-names>P.</given-names></string-name>, <string-name><surname>Liu</surname>, <given-names>S.</given-names></string-name>, <string-name><surname>Fang</surname>, <given-names>Y.</given-names></string-name>, <string-name><surname>Xue</surname>, <given-names>X.</given-names></string-name>, <string-name><surname>Zou</surname>, <given-names>J.</given-names></string-name>, <string-name><surname>Tseng</surname>, <given-names>G.</given-names></string-name>, and <string-name><surname>Konnikova</surname>, <given-names>L.</given-names></string-name> <collab>Recent Advances in Computer-Assisted Algorithms for Cell Subtype Identification of Cytometry Data</collab>.</mixed-citation></ref>
<ref id="c17"><mixed-citation publication-type="other"><string-name><surname>Liu</surname>, <given-names>X.</given-names></string-name>, <string-name><surname>Song</surname>, <given-names>W.</given-names></string-name>, <string-name><surname>Wong</surname>, <given-names>B.Y.</given-names></string-name>, <string-name><surname>Zhang</surname>, <given-names>T.</given-names></string-name>, <string-name><surname>Yu</surname>, <given-names>S.</given-names></string-name>, <string-name><surname>Lin</surname>, <given-names>G.N.</given-names></string-name>, and <string-name><surname>Ding</surname>, <given-names>X.</given-names></string-name> <collab>A comparison framework and guideline of clustering methods for mass cytometry data</collab>.</mixed-citation></ref>
<ref id="c18"><mixed-citation publication-type="journal"><string-name><surname>Lun</surname>, <given-names>A.T.L.</given-names></string-name>, <string-name><surname>Richard</surname>, <given-names>A.C.</given-names></string-name>, and <string-name><surname>Marioni</surname>, <given-names>J.C.</given-names></string-name> <source>Testing for differential abundance in mass cytometry data</source>.</mixed-citation></ref>
<ref id="c19"><mixed-citation publication-type="other"><string-name><surname>Marsh-Wakefield</surname>, <given-names>F.</given-names></string-name>, <string-name><surname>Kruzins</surname>, <given-names>A.</given-names></string-name>, <string-name><surname>McGuire</surname>, <given-names>H.M.</given-names></string-name>, <string-name><surname>Yang</surname>, <given-names>S.</given-names></string-name>, <string-name><surname>Bryant</surname>, <given-names>C.</given-names></string-name>, <string-name><surname>Fazekas de St Groth</surname>, <given-names>B.</given-names></string-name>, <string-name><surname>Nassif</surname>, <given-names>N.</given-names></string-name>, <string-name><surname>Byrne</surname>, <given-names>S.N.</given-names></string-name>, <string-name><surname>Gibson</surname>, <given-names>J.</given-names></string-name>, <string-name><surname>Brown</surname>, <given-names>C.</given-names></string-name>, <etal>et al.</etal> <collab>Mass Cytometry Discovers Two Discrete Subsets of CD39(-)Treg Which Discriminate MGUS From Multiple Myeloma</collab>.</mixed-citation></ref>
<ref id="c20"><mixed-citation publication-type="other"><string-name><surname>McInnes</surname>, <given-names>L.</given-names></string-name>, and <string-name><surname>Healy</surname>, <given-names>J.</given-names></string-name> (<year>2018</year>). <collab>UMAP: Uniform Manifold Approximation and Projection for Dimension Reduction</collab>.</mixed-citation></ref>
<ref id="c21"><mixed-citation publication-type="journal"><string-name><surname>Nowicka</surname>, <given-names>M.</given-names></string-name>, <string-name><surname>Krieg</surname>, <given-names>C.</given-names></string-name>, <string-name><surname>Crowell</surname>, <given-names>H.L.</given-names></string-name>, <string-name><surname>Weber</surname>, <given-names>L.M.</given-names></string-name>, <string-name><surname>Hartmann</surname>, <given-names>F.J.</given-names></string-name>, <string-name><surname>Guglietta</surname>, <given-names>S.</given-names></string-name>, <string-name><surname>Becher</surname>, <given-names>B.</given-names></string-name>, <string-name><surname>Levesque</surname>, <given-names>M.P.</given-names></string-name>, and <string-name><surname>Robinson</surname>, <given-names>M.D</given-names></string-name>. (<year>2017</year>). <article-title>CyTOF workflow: differential discovery in high-throughput high-dimensional cytometry datasets</article-title>. <source>F1000Res</source> <volume>6</volume>, <fpage>748</fpage>. <pub-id pub-id-type="doi">10.12688/f1000research.11622.3</pub-id>.</mixed-citation></ref>
<ref id="c22"><mixed-citation publication-type="other"><string-name><surname>O’Brien Gore</surname>, <given-names>C.</given-names></string-name>, <string-name><surname>Billman</surname>, <given-names>A.</given-names></string-name>, <string-name><surname>Hunjan</surname>, <given-names>S.</given-names></string-name>, <string-name><surname>Colebrook</surname>, <given-names>J.</given-names></string-name>, <string-name><surname>Choy</surname>, <given-names>D.</given-names></string-name>, <string-name><surname>Li</surname>, <given-names>W.</given-names></string-name>, <string-name><surname>Haynes</surname>, <given-names>J.</given-names></string-name>, <string-name><surname>Wade</surname>, <given-names>J.</given-names></string-name>, <string-name><surname>Hobern</surname>, <given-names>E.</given-names></string-name>, <string-name><surname>McDonald</surname>, <given-names>L.</given-names></string-name>, <etal>et al.</etal> <collab>Pre-treatment with systemic agents for advanced NSCLC elicits changes in the phenotype of autologous T cell therapy products</collab>.</mixed-citation></ref>
<ref id="c23"><mixed-citation publication-type="journal"><string-name><surname>Opzoomer</surname>, <given-names>J.W.</given-names></string-name>, <string-name><surname>Timms</surname>, <given-names>J.A.</given-names></string-name>, <string-name><surname>Blighe</surname>, <given-names>K.</given-names></string-name>, <string-name><surname>Mourikis</surname>, <given-names>T.P.</given-names></string-name>, <string-name><surname>Chapuis</surname>, <given-names>N.</given-names></string-name>, <string-name><surname>Bekoe</surname>, <given-names>R.</given-names></string-name>, <string-name><surname>Kareemaghay</surname>, <given-names>S.</given-names></string-name>, <string-name><surname>Nocerino</surname>, <given-names>P.</given-names></string-name>, <string-name><surname>Apollonio</surname>, <given-names>B.</given-names></string-name>, <string-name><surname>Ramsay</surname>, <given-names>A.G.</given-names></string-name>, <etal>et al.</etal> (<year>2021</year>). <article-title>ImmunoCluster provides a computational framework for the nonspecialist to profile high-dimensional cytometry data</article-title>. <source>Elife</source> <volume>10</volume>. <pub-id pub-id-type="doi">10.7554/eLife.62915</pub-id>.</mixed-citation></ref>
<ref id="c24"><mixed-citation publication-type="other"><string-name><surname>Qiu</surname>, <given-names>P.</given-names></string-name>, <string-name><surname>Simonds Ef Fau - Bendall</surname>, <given-names>S.C.</given-names></string-name>, <string-name><surname>Bendall Sc Fau - Gibbs</surname>, <given-names>K.D.</given-names>, <suffix>Jr.</suffix></string-name>, <string-name><given-names>Gibbs</given-names> <surname>Kd</surname> <suffix>Jr</suffix></string-name> <string-name><surname>Fau - Bruggner</surname>, <given-names>R.V.</given-names></string-name>, <string-name><surname>Bruggner Rv Fau - Linderman</surname>, <given-names>M.D.</given-names></string-name>, <string-name><surname>Linderman Md Fau - Sachs</surname>, <given-names>K.</given-names></string-name>, <string-name><surname>Sachs K Fau - Nolan</surname>, <given-names>G.P.</given-names></string-name>, <string-name><surname>Nolan Gp Fau - Plevritis</surname>, <given-names>S.K.</given-names></string-name>, and <string-name><surname>Plevritis</surname>, <given-names>S.K.</given-names></string-name> <collab>Extracting a cellular hierarchy from high-dimensional cytometry data with SPADE</collab>.</mixed-citation></ref>
<ref id="c25"><mixed-citation publication-type="other"><string-name><surname>Samusik</surname>, <given-names>N.</given-names></string-name>, <string-name><surname>Good</surname>, <given-names>Z.</given-names></string-name>, <string-name><surname>Spitzer</surname>, <given-names>M.H.</given-names></string-name>, <string-name><surname>Davis</surname>, <given-names>K.L.</given-names></string-name>, and <string-name><surname>Nolan</surname>, <given-names>G.P.</given-names></string-name> <collab>Automated mapping of phenotype space with single-cell data</collab>.</mixed-citation></ref>
<ref id="c26"><mixed-citation publication-type="journal"><string-name><surname>Spitzer</surname>, <given-names>M.H.</given-names></string-name>, and <string-name><surname>Nolan</surname>, <given-names>G.P</given-names></string-name>. <source>Mass Cytometry: Single Cells, Many Features</source>.</mixed-citation></ref>
<ref id="c27"><mixed-citation publication-type="other"><string-name><surname>Theorell</surname>, <given-names>A.</given-names></string-name>, <string-name><surname>Bryceson</surname>, <given-names>Y.T.</given-names></string-name>, and <string-name><surname>Theorell</surname>, <given-names>J.A.-O.</given-names></string-name> <collab>Determination of essential phenotypic elements of clusters in high-dimensional entities-DEPECHE</collab>.</mixed-citation></ref>
<ref id="c28"><mixed-citation publication-type="other"><string-name><surname>Trussart</surname>, <given-names>M.A.-O.</given-names></string-name>, <string-name><surname>Teh</surname>, <given-names>C.A.-O.</given-names></string-name>, <string-name><surname>Tan</surname>, <given-names>T.</given-names></string-name>, <string-name><surname>Leong</surname>, <given-names>L.</given-names></string-name>, <string-name><surname>Gray</surname>, <given-names>D.A.-O.</given-names></string-name>, and <string-name><surname>Speed</surname>, <given-names>T.A.-O.</given-names></string-name> <collab>Removing unwanted variation with CytofRUV to integrate multiple CyTOF datasets</collab>. LID - <pub-id pub-id-type="doi">10.7554/eLife.59630</pub-id> [doi] <fpage>LID - e59630</fpage>.</mixed-citation></ref>
<ref id="c29"><mixed-citation publication-type="journal"><string-name><surname>van der Maaten</surname>, <given-names>L.</given-names></string-name>, and <string-name><surname>Hinton</surname>, <given-names>G.</given-names></string-name> (<year>2008</year>). <article-title>Viualizing data using t-SNE</article-title>. <source>Journal of Machine Learning Research</source> <volume>9</volume>, <fpage>2579</fpage>–<lpage>2605</lpage>.</mixed-citation></ref>
<ref id="c30"><mixed-citation publication-type="journal"><string-name><surname>Van Gassen</surname>, <given-names>S.</given-names></string-name>, <string-name><surname>Callebaut</surname>, <given-names>B.</given-names></string-name>, <string-name><surname>Van Helden</surname>, <given-names>M.J.</given-names></string-name>, <string-name><surname>Lambrecht</surname>, <given-names>B.N.</given-names></string-name>, <string-name><surname>Demeester</surname>, <given-names>P.</given-names></string-name>, <string-name><surname>Dhaene</surname>, <given-names>T.</given-names></string-name>, and <string-name><surname>Saeys</surname>, <given-names>Y.</given-names></string-name> <source>FlowSOM: Using self-organizing maps for visualization and interpretation of cytometry data</source>.</mixed-citation></ref>
<ref id="c31"><mixed-citation publication-type="other"><string-name><surname>Van Gassen</surname>, <given-names>S.A.-O.</given-names></string-name>, <string-name><surname>Gaudilliere</surname>, <given-names>B.</given-names></string-name>, <string-name><surname>Angst</surname>, <given-names>M.S.</given-names></string-name>, <string-name><surname>Saeys</surname>, <given-names>Y.</given-names></string-name>, and <string-name><surname>Aghaeepour</surname>, <given-names>N.</given-names></string-name> <collab>CytoNorm: A Normalization Algorithm for Cytometry Data</collab>.</mixed-citation></ref>
<ref id="c32"><mixed-citation publication-type="journal"><string-name><surname>Weber</surname>, <given-names>L.M.</given-names></string-name>, <string-name><surname>Nowicka</surname>, <given-names>M.</given-names></string-name>, <string-name><surname>Soneson</surname>, <given-names>C.</given-names></string-name>, and <string-name><surname>Robinson</surname>, <given-names>M.D</given-names></string-name>. (<year>2019</year>). <article-title>diffcyt: Differential discovery in high-dimensional cytometry via high-resolution clustering</article-title>. <source>Communications Biology</source> <volume>2</volume>, <fpage>183</fpage>. <pub-id pub-id-type="doi">10.1038/s42003-019-0415-5</pub-id>.</mixed-citation></ref>
<ref id="c33"><mixed-citation publication-type="other"><string-name><surname>Zhang</surname>, <given-names>Z.A.-O.</given-names></string-name>, <string-name><surname>Luo</surname>, <given-names>D.</given-names></string-name>, <string-name><surname>Zhong</surname>, <given-names>X.</given-names></string-name>, <string-name><surname>Choi</surname>, <given-names>J.H.</given-names></string-name>, <string-name><surname>Ma</surname>, <given-names>Y.</given-names></string-name>, <string-name><surname>Wang</surname>, <given-names>S.</given-names></string-name>, <string-name><surname>Mahrt</surname>, <given-names>E.</given-names></string-name>, <string-name><surname>Guo</surname>, <given-names>W.</given-names></string-name>, <string-name><surname>Stawiski</surname>, <given-names>E.W.</given-names></string-name>, <string-name><surname>Modrusan</surname>, <given-names>Z.</given-names></string-name>, <etal>et al.</etal> <collab>SCINA: A Semi-Supervised Subtyping Algorithm of Single Cells and Bulk Samples</collab>. LID - <pub-id pub-id-type="doi">10.3390/genes10070531</pub-id> [doi] <fpage>LID - 531</fpage>.</mixed-citation></ref>
</ref-list>
<sec id="d1e2260">
<title>Supplementary Figures</title>
<fig id="figs1" position="float" orientation="portrait" fig-type="figure">
<label>Supplementary Figure 1</label>
<caption><p>Manual hierarchical gating strategy for main cell linages from human PBMC samples (MPN dataset, n=9). All .FCS files were cleaned up to remove doublets, normalisation beads and debris (please refer to the methods for standard clean-up procedure), and pre-gated for CD45+ leukocytes. (A) Serial bi-axial scatter plots representing the gating diagram for T cell subsets (CD4 T cells, CD8 T cells and gamma-delta T cells), NK cells and dendritic cells based on the indicated phenotypic markers; (B) Serial bi-axial scatter plot indicating the gating strategy to isolate monocytes and B cells from leukocytes. All manual gating was done using Cytobank platform(<ext-link ext-link-type="uri" xlink:href="https://premium.cytobank.org/cytobank/">https://premium.cytobank.org/cytobank/</ext-link>).</p></caption>
<graphic xlink:href="575790v1_figs1.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
<fig id="figs2" position="float" orientation="portrait" fig-type="figure">
<label>Supplementary Figure 2</label>
<caption><p>Agreement evaluation between ImmCellTyper and manual gating in influenza dataset(n=11). Manual gating was performed using Cytobank and exported manually. (A) Correlation plots between ImmCellTyper results and manual gating results concerning percentages in CD4 T cells, Gamma Delta T cells, dendritic cells, NK cells, CD8 T cells and B cells, with red line indicating perfect agreement (correlation coefficient =1); (B)Bland-Altman plots of the two measurements in the indicated populations, with black line suggesting mean difference between measurements and dotted red line indicating limits of agreement (1.96 x standard deviations). (C) Calculation of precision, recall, F-measure for ImmCellTyper method in comparison to manual gating in the indicated cell populations.</p></caption>
<graphic xlink:href="575790v1_figs2.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
<fig id="figs3" position="float" orientation="portrait" fig-type="figure">
<label>Supplementary Figure 3</label>
<caption><p>Boxplots of the indicated cell percentages generated by different methods. Statistical significance was marked by asterisk. * P&lt;0.05, **P&lt;0.01, ***P&lt;0.001.</p></caption>
<graphic xlink:href="575790v1_figs3.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
<fig id="figs4" position="float" orientation="portrait" fig-type="figure">
<label>Supplementary Figure 4</label>
<caption><p>(A) UMAP plots of normalized expression of indicated markers (CD66b, HLADR, TCRgd, CD20, CD16, CD161) across 2000 cells per sample in MPN dataset;(B) FlowSOM clustering was performed on the same dataset to compare with BinarClust, k=20 was chosen followed by manual annotation of each cluster. UMAP plot was projected with merged flowSOM clusters with biological annotation (downsample 2000 cells per sample) ;(B) The corresponding median marker expression heatmap after flowSOM clustering and annotation.</p></caption>
<graphic xlink:href="575790v1_figs4.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
<fig id="figs5" position="float" orientation="portrait" fig-type="figure">
<label>Supplementary Figure 5</label>
<caption><p>Marker expression heatmap of (A)monocytes and (B) neutrophils generated by Phenograph clustering.</p></caption>
<graphic xlink:href="575790v1_figs5.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
<fig id="figs6" position="float" orientation="portrait" fig-type="figure">
<label>Supplementary Figure 6</label>
<caption><p>Clean-up procedure of CyTOF data using Cytobank.</p></caption>
<graphic xlink:href="575790v1_figs6.tif" mimetype="image" mime-subtype="tiff"/>
</fig>
</sec>
<sec>
<table-wrap id="tbls1" orientation="portrait" position="float">
<label>Supplementary Table 1</label>
<caption><title>CyTOF antibody panel for MPN cohort</title></caption>
<graphic xlink:href="575790v1_tbls1.tif" mimetype="image" mime-subtype="tiff"/>
<graphic xlink:href="575790v1_tbls1a.tif" mimetype="image" mime-subtype="tiff"/>
</table-wrap>
</sec>
</back>
<sub-article id="sa0" article-type="editor-report">
<front-stub>
<article-id pub-id-type="doi">10.7554/eLife.95494.1.sa3</article-id>
<title-group>
<article-title>eLife Assessment</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<name>
<surname>Hong</surname>
<given-names>Seunghee</given-names>
</name>
<role specific-use="editor">Reviewing Editor</role>
<aff>
<institution-wrap>
<institution>Yonsei University</institution>
</institution-wrap>
<city>Seoul</city>
<country>Republic of Korea</country>
</aff>
</contrib>
</contrib-group>
<kwd-group kwd-group-type="evidence-strength">
<kwd>Incomplete</kwd>
<kwd>Solid</kwd>
</kwd-group>
<kwd-group kwd-group-type="claim-importance">
<kwd>Valuable</kwd>
</kwd-group>
</front-stub>
<body>
<p>This <bold>valuable</bold> manuscript presents ImmCellTyper, a new toolkit for CyTOF data analysis. The semi-supervised clustering tool, BinaryClust, integrates prior biological knowledge and demonstrates competitive performance in various benchmarks, but there is room for strengthening the evidence base by addressing concerns about <bold>incomplete</bold> benchmarking results and the limited consideration of CyTOF markers with binary distribution. Overall, the manuscript offers <bold>solid</bold> potential for enhancing CyTOF data analysis methodologies.</p>
</body>
</sub-article>
<sub-article id="sa1" article-type="referee-report">
<front-stub>
<article-id pub-id-type="doi">10.7554/eLife.95494.1.sa2</article-id>
<title-group>
<article-title>Reviewer #1 (Public Review):</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<anonymous/>
<role specific-use="referee">Reviewer</role>
</contrib>
</contrib-group>
</front-stub>
<body>
<p>Summary:</p>
<p>This manuscript presented a useful toolkit designed for CyTOF data analysis, which integrates 5 key steps as an analytical framework. A semi-supervised clustering tool was developed, and its performance was tested in multiple independent datasets. The tool was compared to human experts as well as supervised and unsupervised methods.</p>
<p>Strengths:</p>
<p>The study employed multiple independent datasets to test the pipeline. A new semi-supervised clustering method was developed.</p>
<p>Weaknesses:</p>
<p>The examination of the whole pipeline is incomplete. Lack of descriptions or justifications for some analyses.</p>
</body>
</sub-article>
<sub-article id="sa2" article-type="referee-report">
<front-stub>
<article-id pub-id-type="doi">10.7554/eLife.95494.1.sa1</article-id>
<title-group>
<article-title>Reviewer #2 (Public Review):</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<anonymous/>
<role specific-use="referee">Reviewer</role>
</contrib>
</contrib-group>
</front-stub>
<body>
<p>Summary:</p>
<p>The authors have developed marker selection and k-means (k=2) based binary clustering algorithm for the first-level supervised clustering of the CyTOF dataset. They built a seamless pipeline that offers the multiple functionalities required for CyTOF data analysis.</p>
<p>Strengths:</p>
<p>The strength of the study is the potential use of the pipeline for the CyTOF community as a wrapper for multiple functions required for the analysis. The concept of the first line of binary clustering with known markers can be practically powerful.</p>
<p>Weaknesses:</p>
<p>The weakness of the study is that there's little conceptual novelty in the algorithms suggested from the study and the benchmarking is done in limited conditions.</p>
</body>
</sub-article>
<sub-article id="sa3" article-type="referee-report">
<front-stub>
<article-id pub-id-type="doi">10.7554/eLife.95494.1.sa0</article-id>
<title-group>
<article-title>Reviewer #3 (Public Review):</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<anonymous/>
<role specific-use="referee">Reviewer</role>
</contrib>
</contrib-group>
</front-stub>
<body>
<p>Summary:</p>
<p>ImmCellTyper is a new toolkit for Cytometry by time-of-flight data analysis. It includes BinaryClust, a semi-supervised clustering tool (which takes into account prior biological knowledge), designed for automated classification and annotation of specific cell types and subpopulations. ImmCellTyper also integrates a variety of tools to perform data quality analysis, batch effect correction, dimension reduction, unsupervised clustering, and differential analysis.</p>
<p>Strengths:</p>
<p>The proposed algorithm takes into account the prior knowledge.</p>
<p>
The results on different benchmarks indicate competitive or better performance (in terms of accuracy and speed) depending on the method.</p>
<p>Weaknesses:</p>
<p>The proposed algorithm considers only CyTOF markers with binary distribution.</p>
</body>
</sub-article>
</article>